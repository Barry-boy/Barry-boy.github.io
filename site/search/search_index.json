{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":true,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Kubernetes \u8fdb\u9636\u8bad\u7ec3\u8425 \u00b6 \u524d\u6cbf \u00b6 Hello\uff0c\u5927\u5bb6\u597d\uff01 \u6211\u53eb\u963f\u52f0\uff0c\u5c71\u897f\u4eba,\u5317\u6f02\u4e00\u65cf\u3002\u6c5f\u6e56\u4eba\u79f0\u52f0\u54e5\uff0c\u5728\u5f04\u8fd9\u4e2a\u7f51\u7ad9\u7684\u521d\u8877\u4e3a\u4e86\u8bb0\u5f55\u81ea\u5df1\u5de5\u4f5c\u548c\u751f\u6d3b\u7684\u5185\u5bb9\u3002\u4e3b\u8981\u8bb0\u5f55\u81ea\u5df1\u4ece\u4e8b\u8fd0\u7ef4\u5de5\u4f5c\u7684\u7b14\u8bb0\u5fc3\u5f97.\u5927\u5bb6\u53ef\u4ee5\u70b9\u51fb\u8fdb\u5165 \u300aKubernetes \u8fdb\u9636\u8bad\u7ec3\u8425\u300b \u4ee5\u540e\u4e5f\u5c06\u6301\u7eed\u66f4\u65b0\uff5e \u4e3b\u8981\u8bb0\u5f55\u5de5\u4f5c\u4ee5\u53ca\u751f\u6d3b\u5185\u5bb9 \u628a\u5de5\u4f5c\u548c\u751f\u6d3b\u7684\u4e8b\u60c5\u5217\u6e05\u695a\uff0c\u4e3a\u4e86\u4ee5\u540e\u505a\u590d\u76d8 \u90ae\u7bb1: lixie0215@163.com \u8054\u7cfb\u65b9\u5f0f: \u5fae\u4fe1\uff08\u52f0\u54e5\u672c\u4eba\uff09 \u516c\u4f17\u53f7 \u6709\u5174\u8da3\u53ef\u4ee5\u52a0\u6211\uff0c\u4e00\u8d77\u4ea4\u6d41\u5b66\u4e60\uff5e","title":"\u9996\u9875"},{"location":"#kubernetes","text":"","title":"Kubernetes \u8fdb\u9636\u8bad\u7ec3\u8425"},{"location":"#_1","text":"Hello\uff0c\u5927\u5bb6\u597d\uff01 \u6211\u53eb\u963f\u52f0\uff0c\u5c71\u897f\u4eba,\u5317\u6f02\u4e00\u65cf\u3002\u6c5f\u6e56\u4eba\u79f0\u52f0\u54e5\uff0c\u5728\u5f04\u8fd9\u4e2a\u7f51\u7ad9\u7684\u521d\u8877\u4e3a\u4e86\u8bb0\u5f55\u81ea\u5df1\u5de5\u4f5c\u548c\u751f\u6d3b\u7684\u5185\u5bb9\u3002\u4e3b\u8981\u8bb0\u5f55\u81ea\u5df1\u4ece\u4e8b\u8fd0\u7ef4\u5de5\u4f5c\u7684\u7b14\u8bb0\u5fc3\u5f97.\u5927\u5bb6\u53ef\u4ee5\u70b9\u51fb\u8fdb\u5165 \u300aKubernetes \u8fdb\u9636\u8bad\u7ec3\u8425\u300b \u4ee5\u540e\u4e5f\u5c06\u6301\u7eed\u66f4\u65b0\uff5e \u4e3b\u8981\u8bb0\u5f55\u5de5\u4f5c\u4ee5\u53ca\u751f\u6d3b\u5185\u5bb9 \u628a\u5de5\u4f5c\u548c\u751f\u6d3b\u7684\u4e8b\u60c5\u5217\u6e05\u695a\uff0c\u4e3a\u4e86\u4ee5\u540e\u505a\u590d\u76d8 \u90ae\u7bb1: lixie0215@163.com \u8054\u7cfb\u65b9\u5f0f: \u5fae\u4fe1\uff08\u52f0\u54e5\u672c\u4eba\uff09 \u516c\u4f17\u53f7 \u6709\u5174\u8da3\u53ef\u4ee5\u52a0\u6211\uff0c\u4e00\u8d77\u4ea4\u6d41\u5b66\u4e60\uff5e","title":"\u524d\u6cbf"},{"location":"0.Internet/3-network-docs/","text":"\u7f51\u7edc\u901a\u4fe1\u57fa\u7840\uff1a CNI \u901a\u5e38\u6709\u4e09\u79cd\u5b9e\u73b0\u6a21\u5f0f \u5b98\u7f51: https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/networking/ flannel\u4ecb\u7ecd: \u00b6 \u7f51\u7edc\u6a21\u5f0f \u00b6 github \u5730\u5740: https://github.com/flannel-io/flannel/blob/master/Documentation/backends.md flannel \u7684\u7f51\u7edc\u6a21\u578b\uff08\u540e\u7aef\uff09\uff1a\u76ee\u524d\u6709\u4e09\u79cd\u65b9\u5f0f\u5b9e\u73b0UDP/VXLAN/host-gw UDP : \u5728\u6700\u65e9\u671fflannel\u4f7f\u7528UDP\u5c01\u88c5\u6765\u5b8c\u6210\u62a5\u6587\u7684\u8de8\u4e3b\u673a\u8f6c\u53d1,\u5b89\u5168\u6027\u548c\u6027\u80fd\u7565\u6709\u4e0d\u8db3(\u5df2\u5e9f\u5f03) VXLAN: Linux\u5185\u6838\u5728\u57282012\u5e74\u5e95\u7684v3.7.0\u4e4b\u540e\u52a0\u5165\u4e86VXLAN\u534f\u8bae\u652f\u6301\uff0c\u56e0\u6b64\u65b0\u7248\u672c\u7684Flanne1\u4e5f\u6709UDP\u8f6c\u6362\u4e3aVXLAN, VXLAN\u672c\u8d28\u4e0a\u662f\u4e00\u79cd tunnel (\u96a7\u9053)\u534f\u8bae\uff0c\u7528\u6765\u57fa\u4e8e3\u5c42\u7f51\u7edc\u5b9e\u73b0\u865a\u62df\u76842\u5c42\u7f51\u7edc\uff0c\u76ee\u524dflannel\u7684\u7f51\u7edc\u6a21\u578b\u5df2\u7ecf\u662f\u57fa\u4e8eVXLAN\u7684\u53e0\u52a0(\u8986\u76d6)\u7f51\u7edc\uff0c\u76ee\u524d\u63a8\u8350\u4f7f\u7528 vxlan\u4f5c\u4e3a\u5176\u7f51\u7edc\u6a21\u578b\u3002(\u4f7f\u7528\u6700\u591a) Host-gw:\u4e5f\u5c31\u662fHost GateWay, \u901a\u8fc7\u5728node\u8282\u70b9\u4e0a\u521b\u5efa\u5230\u8fbe\u5404\u76ee\u6807\u5bb9\u5668\u5730\u5740\u7684\u8def\u7531\u8868\u800c\u5b8c\u6210\u62a5\u6587\u7684\u8f6c\u53d1\uff0c\u56e0\u6b64\u8fd9\u79cd\u65b9\u5f0f\u8981\u6c42\u5404node\u8282\u70b9\u672c\u8eab \u5fc5\u987b\u5904\u4e8e\u540c\u4e00\u4e2a\u5c40\u57df\u7f51(\u4e8c\u5c42\u7f51\u7edc)\u4e2d\uff0c\u56e0\u6b64\u4e0d\u9002\u7528\u4e8e\u7f51\u7edc\u53d8\u52a8\u9891\u7e41\u6216\u6bd4\u8f83\u5927\u578b\u7684\u7f51\u7edc\u73af\u5883\uff0c\u4f46\u662f\u5176\u6027\u80fd\u8f83\u597d\u3002 Flannel\u7ec4\u4ef6\u7684\u8bf4\u660e: \u00b6 Cni0:\u7f51\u6865\u8bbe\u5907\uff0c\u6bcf\u521b\u5efa\u4e00\u4e2apod\u90fd\u4f1a\u521b\u5efa\u5bf9veth pair, \u5176\u4e2d\u4e00\u7aef\u662fpod\u4e2d\u7684eth0,\u53e6\u4e00\u7aef\u662fCni0\u7f51\u6865\u4e2d\u7684\u7aef\u53e3(\u7f51\u5361) \uff0cPod\u4e2d\u4ece\u7f51\u5361 eth0\u53d1\u51fa\u7684\u6d41\u91cf\u90fd\u4f1a\u53d1\u9001\u5230Cni0\u7f51\u6865\u8bbe\u5907\u7684\u7aef\u53e3(\u7f51\u5361)\u4e0a\uff0cCni0\u8bbe\u5907\u83b7\u5f97\u7684ip\u5730\u5740\u662f\u8be5\u8282\u70b9\u5206\u914d\u5230\u7684\u7f51\u6bb5\u7684\u7b2c\u4e00\u4e2a\u5730\u5740\u3002 \u539f\u751f\u6a21\u5f0f: Flannel.1: overlay\u7f51\u7edc\u7684\u8bbe\u5907\uff0c\u7528\u6765\u8fdb\u884cvxlan\u62a5\u6587\u7684\u5904\u7406(\u5c01\u5305\u548c\u89e3\u5305)\uff0c \u4e0d\u540cnode\u4e4b\u95f4\u7684pod\u6570\u636e\u6d41\u91cf\u90fd\u4eceoverlay\u8bbe\u5907\u4ee5\u96a7\u9053\u7684\u5f62\u5f0f \u53d1\u9001\u5230\u5bf9\u7aef\u3002 flannel \u7684\u7cfb\u7edf\u6587\u4ef6\u53ca\u76ee\u5f55: \u00b6 root@node2:~# find / -name flannel VXLAN \u539f\u751f\u6a21\u5f0f: \u00b6 k3s \u9ed8\u8ba4\u7684 flannel \u4e5f\u9ed8\u8ba4vxlan,\u4f46\u662f\u4ecev1.26 \u5f00\u59cb\u79fb\u9664\u4e86 wireguard \u540e\u7aef\uff0c\u4ece\u800c\u652f\u6301 Flannel \u539f\u751f\u7684 wireguard-native \u540e\u7aef https://docs.k3s.io/installation/network-options sshd\u4e3b\u673a\u4e0a\u7684\u5bb9\u5668\u8bbf\u95ee\u522b\u7684\u5bb9\u5668,\u9996\u5148\u901a\u8fc7\u7f51\u6865\u5224\u65ad\u76ee\u7684\u5730\u5740\u662f\u8bbf\u95ee\u5f53\u524d\u7684\u5730\u5740\u8fd8\u662f\u5176\u4ed6\u4e3b\u673a,\u5982\u679c\u5f53\u524d\u4e3b\u673a\u7684\u5bb9\u5668\u4e0d\u8d70flannel.1\u5c31\u76f4\u63a5\u8fd4\u56de\u4e86,\u5982\u679c\u662f\u8bbf\u95ee\u5176\u4ed6 \u6709\u4e24\u79cd\u573a\u666f; \u573a\u666f\u4e00: \u8bbf\u95ee\u522b\u7684 node \u4e0a\u7684\u5bb9\u5668,\u8fd9\u65f6\u4ed6\u7684\u4e3b\u673a\u4e0a\u5c31\u4f1a\u6709\u5bf9\u5e94\u8def\u7531\u8868,\u4f8b\u5982\u4e0a\u56fe\u4e2d,\u53ef\u80fd\u4ed6\u8981\u8bbf\u95ee\u7684\u5413\u4e00\u8df3\u5c31\u662f172.16.78.0/21,\u90a3\u4e48\u5c31\u4f1a\u8d70flannel.1\u6765\u505a\u62a5\u6587\u7684\u5c01\u88c5;\u8fd9\u65f6\u5c31\u8d70\u96a7\u9053\u4e86,\u4e0d\u4f1a\u5728\u7269\u7406\u7f51\u5361\u6765\u505a\u62a5\u6587\u7684\u5c01\u88c5. \u573a\u666f\u4e8c: \u5982\u679c\u76ee\u7684\u5730\u5740\u4e0d\u662f k8s \u7684\u73af\u5883,\u800c\u662f\u5916\u7f51,\u90a3\u4e48\u5c31\u4f1a\u5339\u914d\u8def\u7531\u7684\u65f6\u5019\u5c31\u4e0d\u4f1a\u8d70\u96a7\u9053\u8bbe\u5907,\u5728\u5185\u6838\u505a\u7269\u7406\u7f51\u5361\u7684\u5c01\u88c5,\u901a\u8fc7\u5bbf\u4e3b\u673a\u51fa\u53bb. \u4e0d\u540c\u7684\u4e3b\u673a\u7684\u5bb9\u5668\u901a\u4fe1\u9700\u8981\u901a\u8fc7flannel.1 \u8fdb\u884c\u5c01\u88c5\u548c\u89e3\u5c01 \u597d\u5904: \u53ef\u4ee5\u8de8\u5b50\u7f51\u901a\u4fe1 \u7f3a\u70b9: \u6027\u80fd\u5dee\u70b9 DirectRouting\u6a21\u5f0f: \u00b6 VXLAN DirectRoutinghost-gw\uff08\u5e03\u5c14\u503c\uff09\uff1a\u5f53\u4e3b\u673a\u4f4d\u4e8e\u540c\u4e00\u5b50\u7f51\u4e0a\u65f6\u542f\u7528\u76f4\u63a5\u8def\u7531\uff08\u5982\uff09\u3002VXLAN \u5c06\u4ec5\u7528\u4e8e\u5c01\u88c5\u6570\u636e\u5305\u5230\u4e0d\u540c\u5b50\u7f51\u4e0a\u7684\u4e3b\u673a\u3002\u9ed8\u8ba4\u4e3afalse. Windows \u4e0d\u652f\u6301 DirectRouting \u5f00\u542f\u4e86\u8fd9\u4e2a\u6a21\u5f0f,\u90a3\u7f51\u7edc\u5c31\u4f1a\u63d0\u5347,\u539f\u56e0\u5c31\u662f\u5728\u540c\u7f51\u6bb5\u4e0d\u8fdb\u884c\u5c01\u88c5,\u53ea\u6709\u8de8\u5b50\u7f51\u624d\u8fdb\u884c\u5c01\u88c5. \u76d1\u542c\u7aef\u53e3: [ openbayes-enflame ] root@node1:~# ss -auntp | grep 8472 udp UNCONN 0 0 0 .0.0.0:8472 0 .0.0.0:* host-gw \u6a21\u5f0f\uff1a \u00b6 \u548cDirectRouting\u7c7b\u4f3c,\u4f46\u662f\u4e0d\u80fd\u8de8\u5b50\u7f51 Use host-gw to create IP routes to subnets via remote machine IPs. Requires direct layer2 connectivity between hosts running flannel. host-gw provides good performance, with few dependencies, and easy set up. flannel \u603b\u7ed3: \u63a8\u8350\u4f7f\u7528VXLAN DirectRouting \u76f8\u540c\u7684 node \u5b50\u7f51\u901a\u4fe1,\u4e0d\u9700\u8981overlay\u5c01\u88c5\u548c\u89e3\u5c01\u88c5,\u800c\u4e14\u8fd8\u53ef\u4ee5\u652f\u6301 node \u8de8\u5b50\u7f51 \u7f51\u7edc\u7ec4\u4ef6caclio \u00b6 \u5b98\u7f51\u5730\u5740: https://projectcalico.docs.tigera.io GitHub \u5730\u5740: https://github.com/projectcalico/calico Calico\u662f\u4e00\u4e2a\u7eaf\u4e09\u5c42\u7684\u7f51\u7edc\u89e3\u51b3\u65b9\u6848\uff0c\u4e3a\u5bb9\u5668\u63d0\u4f9b\u591anode\u95f4\u7684\u8bbf\u95ee\u901a\u4fe1\uff0ccalico\u5c06\u6bcf\u4e00\u4e2anode\u8282\u70b9\u90fd\u5f53\u505a\u4e3a\u4e00\u4e2a\u8def\u7531\u5668(router), \u5404\u8282\u70b9\u901a\u8fc7BGP(Border Gateway Protocol)\u8fb9\u754c\u7f51\u5173\u534f\u8bae\u5b66\u4e60\u5e76\u5728node\u8282\u70b9\u751f\u6210\u8def\u7531\u89c4\u5219\uff0c\u4ece\u800c\u5c06\u4e0d\u540cnode\u8282\u70b9\u4e0a\u7684pod\u8fde\u63a5\u8d77\u6765\u8fdb\u884c\u901a\u4fe1\u3002 Calico \u4ecb\u7ecd: \u7f51\u7edc\u901a\u8fc7\u7b2c3\u5c42\u8def\u7531\u6280\u672f(\u5982\u9759\u6001\u8def\u7531\u6216BGP\u8def\u7531\u5206\u914d)\u6216\u7b2c2\u5c42\u5730\u5740\u5b66\u4e60\u6765\u611f\u77e5\u5de5\u4f5c\u8d1f\u8f7dIP\u5730\u5740\u3002\u56e0\u6b64\u5b83\u4eec\u53ef\u4ee5\u5c06\u672a\u5c01\u88c5\u7684\u6d41\u91cf\u8def\u7531\u5230\u4f5c\u4e3a\u6700\u7ec8\u76ee\u7684\u5730\u7684\u7aef\u70b9\u7684\u6b63\u786e\u4e3b\u673a\u3002\u4f46\u662f\u5e76\u975e\u6240\u6709\u7f51\u7edc\u90fd\u80fd\u591f\u8def\u7531\u5de5\u4f5c\u8d1f\u8f7dIP\u5730\u5740\u3002\u4f8b\u5982\u516c\u5171\u4e91\u73af\u5883\u3001\u8de8VPC\u5b50\u7f51\u8fb9\u754c\u7684AWS,\u4ee5\u53ca\u65e0\u6cd5\u901a\u8fc7BGP \u3001Calico\u5bf9\u5e94\u5230under lay\u7f51\u7edc\u6216\u65e0\u6cd5\u8f7b\u677e\u914d\u7f6e\u9759\u6001\u8def\u7531\u7684\u5176\u4ed6\u573a\u666f\uff0c\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48Calico\u652f\u6301\u5c01\u88c5\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u5728\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u53d1\u9001\u6d41\u91cf\uff0c\u800c\u65e0\u9700\u5e95\u5c42\u7f51\u7edc\u77e5\u9053\u5de5\u4f5c\u8d1f\u8f7dIP\u5730\u5740\u3002 calico\u5c01\u88c5\u7c7b\u578b: Calico\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u5c01\u88c5: VXLAN\u548cIP-in-IP, VXLAN\u5728IP\u4e2d\u6ca1\u6709 IP\u7684\u67d0\u4e9b\u73af\u5883\u4e2d\u53d7\u652f\u6301(\u4f8b\u5982Azure)\uff0cVXLAN\u7684\u6bcf \u6570\u636e\u5305\u5f00\u9500\u7a0d\u9ad8\uff0c\u56e0\u4e3a\u62a5\u5934\u8f83\u5927\uff0c\u4f46\u9664\u975e\u60a8\u8fd0\u884c\u7684\u662f\u7f51\u7edc\u5bc6\u96c6\u578b\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5426\u5219\u60a8\u901a\u5e38\u4e0d\u4f1a\u6ce8\u610f\u5230\u8fd9\u79cd\u5dee\u5f02\u3002\u8fd9\u4e24\u79cd\u5c01\u88c5\u4e4b\u95f4\u7684\u53e6\u4e00\u4e2a\u5c0f\u5dee\u5f02\u662fCal ico\u7684VXLAN\u5b9e\u73b0\u4e0d\u4f7f\u7528BGP, Calico\u7684IP-in-IP\u662f\u5728Calico\u8282\u70b9\u4e4b\u95f4\u4f7f\u7528BGP\u534f\u8bae\u5b9e\u73b0\u8de8\u5b50\u7f51\u3002 Calico\u4e24\u79cd\u7f51\u7edc\u6a21\u5f0f Calico\u672c\u8eab\u652f\u6301\u591a\u79cd\u7f51\u7edc\u6a21\u5f0f\uff0c\u4eceoverlay\u548cunderlay\u4e0a\u533a\u5206\u3002Calico overlay \u6a21\u5f0f\uff0c\u4e00\u822c\u4e5f\u79f0Calico IPIP\u6216VXLAN\u6a21\u5f0f\uff0c\u4e0d\u540cNode\u95f4Pod\u4f7f\u7528IPIP\u6216VXLAN\u96a7\u9053\u8fdb\u884c\u901a\u4fe1\u3002Calico underlay \u6a21\u5f0f\uff0c\u4e00\u822c\u4e5f\u79f0calico BGP\u6a21\u5f0f\uff0c\u4e0d\u540cNode Pod\u4f7f\u7528\u76f4\u63a5\u8def\u7531\u8fdb\u884c\u901a\u4fe1\u3002\u5728overlay\u548cunderlay\u90fd\u6709nodetonode mesh(\u5168\u7f51\u4e92\u8054)\u548cRoute Reflector(\u8def\u7531\u53cd\u5c04\u5668)\u3002\u5982\u679c\u6709\u5b89\u5168\u7ec4\u7b56\u7565\u9700\u8981\u5f00\u653eIPIP\u534f\u8bae\uff1b\u8981\u6c42Node\u5141\u8bb8BGP\u534f\u8bae\uff0c\u5982\u679c\u6709\u5b89\u5168\u7ec4\u7b56\u7565\u9700\u8981\u5f00\u653eTCP 179\u7aef\u53e3\uff1b\u5b98\u65b9\u63a8\u8350\u4f7f\u7528\u5728Node\u5c0f\u4e8e100\u7684\u96c6\u7fa4\uff0c\u6211\u4eec\u5728\u4f7f\u7528\u7684\u8fc7\u7a0b\u4e2d\u5df2\u7ecf\u901a\u8fc7IPIP\u6a21\u5f0f\u652f\u6491\u4e86100-200\u89c4\u6a21\u7684\u96c6\u7fa4\u7a33\u5b9a\u8fd0\u884c\u3002 BGP\u662f\u4e00\u4e2a\u53bb\u4e2d\u5fc3\u5316\u7684\u534f\u8bae\uff0c\u5b83\u901a\u8fc7\u81ea\u52a8\u5b66\u4e60\u548c\u7ef4\u62a4\u8def\u7531\u8868\u5b9e\u73b0\u7f51\u7edc\u7684\u53ef\u7528\u6027\uff0c\u4f46\u662f\u5e76\u4e0d\u662f\u6240\u6709\u7684\u7f51\u7edc\u90fd\u652f\u6301BGP,\u53e6\u5916\u4e3a\u4e86\u8de8\u7f51\u7edc \u5b9e\u73b0\u66f4\u5927\u89c4\u6a21\u7684\u7f51\u7edc\u7ba1\u7406\uff0ccalico \u8fd8\u652f\u6301IP-in-IP\u7684\u53e0\u52a0\u6a21\u578b\uff0c\u7b80\u79f0IPIP, IPIP\u53ef\u4ee5\u5b9e\u73b0\u8de8\u4e0d\u540c\u7f51\u6bb5\u5efa\u7acb \u8def\u7531\u901a\u4fe1\uff0c\u4f46\u662f\u4f1a\u5b58\u5728\u5b89\u5168\u6027\u95ee\u9898\uff0c\u5176\u5728\u5185\u6838\u5185\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7Calico\u7684\u914d\u7f6e\u6587\u4ef6\u8bbe\u7f6e\u662f\u5426\u542f\u7528IPIP\uff0c \u5728\u516c\u53f8\u5185\u90e8\u5982\u679ck8s\u7684node\u8282\u70b9\u6ca1\u6709\u8de8\u8d8a\u7f51\u6bb5\u5efa\u8bae\u5173\u95edIPIP\u3002 IPIP\u662f\u4e00-\u79cd\u5c06\u5404Node\u7684\u8def\u7531\u4e4b\u95f4\u505a\u4e00\u4e2atunnel, \u518d\u628a\u4e24\u4e2a\u7f51\u7edc\u8fde\u63a5\u8d77\u6765\u7684\u6a21\u5f0f\u3002\u542f\u7528IPIP\u6a21\u5f0f\u65f6\uff0cCalico\u5c06\u5728\u5404Node\u4e0a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a\" tun10\"\u7684\u865a\u62df\u7f51\u7edc\u63a5\u53e3\u3002 BGP\u6a21\u5f0f\u5219\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u673a\u4f5c\u4e3a\u865a\u62df\u8def\u7531\u8def(vRouter) \uff0c\u4e0d\u518d\u521b\u5efa\u989d\u5916\u7684tunnel. Calio \u67b6\u6784: Calio \u7ec4\u4ef6: Felix: calico\u7684agent, \u8fd0\u884c\u5728\u6bcf\u4e00\u53f0node\u8282\u70b9\u4e0a\uff0c \u5176\u4e3b\u8981\u662f\u7ef4\u62a4\u8def\u7531\u89c4\u5219\u3001\u6c47\u62a5\u5f53\u524d\u8282\u70b9\u72b6\u6001\u4ee5\u786e\u4fddpod\u7684\u5938\u4e3b\u673a\u901a\u4fe1\u3002 BGP Client: \u6bcf\u53f0node\u90fd\u8fd0\u884c\uff0c\u5176\u4e3b\u8981\u8d1f\u8d23\u76d1\u542cnode\u8282\u70b9\u4e0a\u7531felix\u751f\u6210\u7684\u8def\u7531\u4fe1\u606f\uff0c\u7136\u540e\u901a\u8fc7BGP\u534f\u8bae\u5e7f\u64ad\u81f3\u5176\u4ed6\u5269\u4f59\u7684node\u8282\u70b9\uff0c\u4ece\u800c\u76f8\u4e92\u5b66\u4e60\u8def\u7531\u5b9e\u73b0pod\u901a\u4fe1\u3002 Route Reflector:\u96c6\u4e2d\u5f0f\u7684\u8def\u7531\u53cd\u5c04\u5668\uff0ccalico v3.3\u5f00\u59cb\u652f\u6301\uff0c\u5f53Calico BGP\u5ba2\u6237\u7aef\u5c06\u8def\u7531\u4ece\u5176FIB(Forward InformationdataBase,\u8f6c\u53d1\u4fe1\u606f\u5e93)\u901a\u544a\u5230Route Reflector\u65f6\uff0cRoute Reflector \u4f1a\u5c06\u8fd9\u4e9b\u8def\u7531\u901a\u544a\u7ed9\u90e8\u7f72\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u8282\u70b9\uff0cRoute Reflector\u4e13\u95e8\u7528\u4e8e\u7ba1\u7406BGP\u7f51\u7edc\u8def\u7531\u89c4\u5219\uff0c\u4e0d\u4f1a\u4ea7\u751fpod\u6570\u636e\u901a\u4fe1\u3002 \u6ce8: calico\u9ed8\u8ba4\u5de5\u4f5c\u6a21\u5f0f\u662fBGP\u7684node- to-node mesh,\u5982\u679c\u8981\u4f7f\u7528Route Reflector \u9700\u8981\u8fdb\u884c\u76f8\u5173\u914d\u7f6e\u3002 https://docs.projectcalico.org/v3.4/usage/routereflector https://docs.projectcalico.org/v3.2/usage/routereflector/calico-routereflector https://blog.kelu.org/category/tech.html https://blog.kelu.org/tech/2020/01/11/calico-series-3-calico-components-and-arch.html \u5f00\u542f ip-ip \u6a21\u5f0f,\u53ef\u4ee5\u770b\u5230\u540e\u9762\u6709\u4e2a\u96a7\u9053tunl0 (\u517c\u5bb9\u6027\u597d,\u53ef\u4ee5\u8de8\u5b50\u7f51) \u603b\u7ed3: \u539f\u5219\u4f7f\u7528: \u81ea\u5efa\u673a\u623f\u4f18\u5148\u4f7f\u7528 caclio caclio \u652f\u6301\u7f51\u7edc\u7b56\u7565 \u6027\u80fd\u9ad8\u4e8e flannel \u4f7f\u7528\u542f\u7528overlay \u8003\u8651\u540e\u671f\u7684\u7f51\u7edc\u6269\u5c55,node \u8282\u70b9\u662f\u5426\u5b58\u5728\u8de8\u5b50\u7f51\u7684\u95ee\u9898 \u4e0d\u542f\u7528 overlay flannel host-gw caclio bgp (\u76f4\u63a5\u8def\u7531) \u542f\u7528 overlay caclio IPIP flannel vxlan CrossSubnet: \u8868\u793a\uff08ipip-bgp\u6df7\u5408\u6a21\u5f0f\uff09\uff0c\u6307\u201c\u540c\u5b50\u7f51\u5185\u8def\u7531\u91c7\u7528bgp\uff0c\u8de8\u5b50\u7f51\u8def\u7531\u91c7\u7528ipip \u5728\u4f7f\u7528\u573a\u666f\u4e0a\u5f53\u4e3b\u673a\u8282\u70b9\u5904\u4e8e\u4e0d\u540c\u7f51\u7edc\u5206\u6bb5\uff0c\u9700\u8981\u8de8\u7f51\u6bb5\u901a\u4fe1\u65f6\uff0cBGP\u6a21\u5f0f\u5c06\u4f1a\u5931\u6548\uff0c\u6b64\u65f6\u8981\u4f7f\u7528IPIP\u6a21\u5f0f\u3002 Calico\u7684BGP Mesh\u6a21\u5f0f\u9002\u5408\u5728\u5c0f\u89c4\u6a21\u96c6\u7fa4(\u8282\u70b9\u6570\u91cf\u5c0f\u4e8e100\u4e2a)\u4e2d\u76f4\u63a5\u4e92\u8054\uff0c\u7531\u4e8e\u968f\u7740\u96c6\u7fa4\u8282\u70b9\u6570\u91cf\u7684\u589e\u52a0\uff0c\u8def\u7531\u89c4\u5219\u5c06\u6210\u6307\u6570\u7ea7\u589e\u957f\u4f1a\u7ed9\u96c6\u7fa4\u7f51\u7edc\u5e26\u6765\u5f88\u5927\u538b\u529b\u3002\u5927\u89c4\u6a21\u96c6\u7fa4\u9700\u8981\u4f7f\u7528BGP Route Reflector GitHub \u5730\u5740: https://github.com/projectcalico/calico/blob/79b442a53adb7d7f1fd62927d9322daf87dce9de/calico/reference/public-cloud/aws.md \u4e0d\u540c\u7ec4\u4ef6\u538b\u6d4b\u8c03\u7814 \u00b6 \u8c03\u7814\u4e0d\u540c\u7f51\u7edc\u7ec4\u4ef6\u5bf9\u7f51\u7edc\u7684\u5f71\u54cd:(\u540c\u7b49\u914d\u7f6e\u4e0b) docker-compose \u5c31\u4e0d\u9700\u8981\u505a overlay \u7684\u5c01\u88c5\u548c\u89e3\u5c01\u88c5,\u6027\u80fd\u662f\u6700\u597d\u7684. \u538b\u6d4b\u8c03\u7814: flannel \u7f51\u7edc\u7ec4\u4ef6 \u538b\u6d4b\u8c03\u7814: DirectRouting\u6a21\u5f0f: \u5347\u7ea7\u7cfb\u7edf calico \u7ec4\u4ef6: \u5173\u95ed IPIP \u4f7f\u7528 BGP \u4f46\u662f\u8fd9\u4e2a\u7ed3\u679c\u8fd8\u662f\u8fbe\u4e0d\u5230\u9884\u671f\u7684\u6548\u679c,\u6700\u540e\u7684\u89e3\u51b3\u65b9\u6848\u662f\u5355\u673a\u591a\u526f\u672c \u7f51\u7edc\u6027\u80fd\u6d4b\u8bd5\u5bf9\u6bd4 \u00b6 \u81ea\u5df1\u538b\u6d4b: caclio \u7684IPIP\u6a21\u5f0f: \u6587\u7ae0\u53c2\u8003: https://system51.github.io/2020/05/27/using-calico/ https://projectcalico.docs.tigera.io/ https://blog.frognew.com/2021/07/relearning-container-22.html#%E5%8F%82%E8%80%83 https://kiddie92.github.io/2019/01/23/kubernetes-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E7%AE%80%E4%BB%8B/ https://gist.github.com/baymaxium/7797f226fe03d38461f33fdd02145b11","title":"3 network docs"},{"location":"0.Internet/3-network-docs/#flannel","text":"","title":"flannel\u4ecb\u7ecd:"},{"location":"0.Internet/3-network-docs/#_1","text":"github \u5730\u5740: https://github.com/flannel-io/flannel/blob/master/Documentation/backends.md flannel \u7684\u7f51\u7edc\u6a21\u578b\uff08\u540e\u7aef\uff09\uff1a\u76ee\u524d\u6709\u4e09\u79cd\u65b9\u5f0f\u5b9e\u73b0UDP/VXLAN/host-gw UDP : \u5728\u6700\u65e9\u671fflannel\u4f7f\u7528UDP\u5c01\u88c5\u6765\u5b8c\u6210\u62a5\u6587\u7684\u8de8\u4e3b\u673a\u8f6c\u53d1,\u5b89\u5168\u6027\u548c\u6027\u80fd\u7565\u6709\u4e0d\u8db3(\u5df2\u5e9f\u5f03) VXLAN: Linux\u5185\u6838\u5728\u57282012\u5e74\u5e95\u7684v3.7.0\u4e4b\u540e\u52a0\u5165\u4e86VXLAN\u534f\u8bae\u652f\u6301\uff0c\u56e0\u6b64\u65b0\u7248\u672c\u7684Flanne1\u4e5f\u6709UDP\u8f6c\u6362\u4e3aVXLAN, VXLAN\u672c\u8d28\u4e0a\u662f\u4e00\u79cd tunnel (\u96a7\u9053)\u534f\u8bae\uff0c\u7528\u6765\u57fa\u4e8e3\u5c42\u7f51\u7edc\u5b9e\u73b0\u865a\u62df\u76842\u5c42\u7f51\u7edc\uff0c\u76ee\u524dflannel\u7684\u7f51\u7edc\u6a21\u578b\u5df2\u7ecf\u662f\u57fa\u4e8eVXLAN\u7684\u53e0\u52a0(\u8986\u76d6)\u7f51\u7edc\uff0c\u76ee\u524d\u63a8\u8350\u4f7f\u7528 vxlan\u4f5c\u4e3a\u5176\u7f51\u7edc\u6a21\u578b\u3002(\u4f7f\u7528\u6700\u591a) Host-gw:\u4e5f\u5c31\u662fHost GateWay, \u901a\u8fc7\u5728node\u8282\u70b9\u4e0a\u521b\u5efa\u5230\u8fbe\u5404\u76ee\u6807\u5bb9\u5668\u5730\u5740\u7684\u8def\u7531\u8868\u800c\u5b8c\u6210\u62a5\u6587\u7684\u8f6c\u53d1\uff0c\u56e0\u6b64\u8fd9\u79cd\u65b9\u5f0f\u8981\u6c42\u5404node\u8282\u70b9\u672c\u8eab \u5fc5\u987b\u5904\u4e8e\u540c\u4e00\u4e2a\u5c40\u57df\u7f51(\u4e8c\u5c42\u7f51\u7edc)\u4e2d\uff0c\u56e0\u6b64\u4e0d\u9002\u7528\u4e8e\u7f51\u7edc\u53d8\u52a8\u9891\u7e41\u6216\u6bd4\u8f83\u5927\u578b\u7684\u7f51\u7edc\u73af\u5883\uff0c\u4f46\u662f\u5176\u6027\u80fd\u8f83\u597d\u3002","title":"\u7f51\u7edc\u6a21\u5f0f"},{"location":"0.Internet/3-network-docs/#flannel_1","text":"Cni0:\u7f51\u6865\u8bbe\u5907\uff0c\u6bcf\u521b\u5efa\u4e00\u4e2apod\u90fd\u4f1a\u521b\u5efa\u5bf9veth pair, \u5176\u4e2d\u4e00\u7aef\u662fpod\u4e2d\u7684eth0,\u53e6\u4e00\u7aef\u662fCni0\u7f51\u6865\u4e2d\u7684\u7aef\u53e3(\u7f51\u5361) \uff0cPod\u4e2d\u4ece\u7f51\u5361 eth0\u53d1\u51fa\u7684\u6d41\u91cf\u90fd\u4f1a\u53d1\u9001\u5230Cni0\u7f51\u6865\u8bbe\u5907\u7684\u7aef\u53e3(\u7f51\u5361)\u4e0a\uff0cCni0\u8bbe\u5907\u83b7\u5f97\u7684ip\u5730\u5740\u662f\u8be5\u8282\u70b9\u5206\u914d\u5230\u7684\u7f51\u6bb5\u7684\u7b2c\u4e00\u4e2a\u5730\u5740\u3002 \u539f\u751f\u6a21\u5f0f: Flannel.1: overlay\u7f51\u7edc\u7684\u8bbe\u5907\uff0c\u7528\u6765\u8fdb\u884cvxlan\u62a5\u6587\u7684\u5904\u7406(\u5c01\u5305\u548c\u89e3\u5305)\uff0c \u4e0d\u540cnode\u4e4b\u95f4\u7684pod\u6570\u636e\u6d41\u91cf\u90fd\u4eceoverlay\u8bbe\u5907\u4ee5\u96a7\u9053\u7684\u5f62\u5f0f \u53d1\u9001\u5230\u5bf9\u7aef\u3002","title":"Flannel\u7ec4\u4ef6\u7684\u8bf4\u660e:"},{"location":"0.Internet/3-network-docs/#flannel_2","text":"root@node2:~# find / -name flannel","title":"flannel \u7684\u7cfb\u7edf\u6587\u4ef6\u53ca\u76ee\u5f55:"},{"location":"0.Internet/3-network-docs/#vxlan","text":"k3s \u9ed8\u8ba4\u7684 flannel \u4e5f\u9ed8\u8ba4vxlan,\u4f46\u662f\u4ecev1.26 \u5f00\u59cb\u79fb\u9664\u4e86 wireguard \u540e\u7aef\uff0c\u4ece\u800c\u652f\u6301 Flannel \u539f\u751f\u7684 wireguard-native \u540e\u7aef https://docs.k3s.io/installation/network-options sshd\u4e3b\u673a\u4e0a\u7684\u5bb9\u5668\u8bbf\u95ee\u522b\u7684\u5bb9\u5668,\u9996\u5148\u901a\u8fc7\u7f51\u6865\u5224\u65ad\u76ee\u7684\u5730\u5740\u662f\u8bbf\u95ee\u5f53\u524d\u7684\u5730\u5740\u8fd8\u662f\u5176\u4ed6\u4e3b\u673a,\u5982\u679c\u5f53\u524d\u4e3b\u673a\u7684\u5bb9\u5668\u4e0d\u8d70flannel.1\u5c31\u76f4\u63a5\u8fd4\u56de\u4e86,\u5982\u679c\u662f\u8bbf\u95ee\u5176\u4ed6 \u6709\u4e24\u79cd\u573a\u666f; \u573a\u666f\u4e00: \u8bbf\u95ee\u522b\u7684 node \u4e0a\u7684\u5bb9\u5668,\u8fd9\u65f6\u4ed6\u7684\u4e3b\u673a\u4e0a\u5c31\u4f1a\u6709\u5bf9\u5e94\u8def\u7531\u8868,\u4f8b\u5982\u4e0a\u56fe\u4e2d,\u53ef\u80fd\u4ed6\u8981\u8bbf\u95ee\u7684\u5413\u4e00\u8df3\u5c31\u662f172.16.78.0/21,\u90a3\u4e48\u5c31\u4f1a\u8d70flannel.1\u6765\u505a\u62a5\u6587\u7684\u5c01\u88c5;\u8fd9\u65f6\u5c31\u8d70\u96a7\u9053\u4e86,\u4e0d\u4f1a\u5728\u7269\u7406\u7f51\u5361\u6765\u505a\u62a5\u6587\u7684\u5c01\u88c5. \u573a\u666f\u4e8c: \u5982\u679c\u76ee\u7684\u5730\u5740\u4e0d\u662f k8s \u7684\u73af\u5883,\u800c\u662f\u5916\u7f51,\u90a3\u4e48\u5c31\u4f1a\u5339\u914d\u8def\u7531\u7684\u65f6\u5019\u5c31\u4e0d\u4f1a\u8d70\u96a7\u9053\u8bbe\u5907,\u5728\u5185\u6838\u505a\u7269\u7406\u7f51\u5361\u7684\u5c01\u88c5,\u901a\u8fc7\u5bbf\u4e3b\u673a\u51fa\u53bb. \u4e0d\u540c\u7684\u4e3b\u673a\u7684\u5bb9\u5668\u901a\u4fe1\u9700\u8981\u901a\u8fc7flannel.1 \u8fdb\u884c\u5c01\u88c5\u548c\u89e3\u5c01 \u597d\u5904: \u53ef\u4ee5\u8de8\u5b50\u7f51\u901a\u4fe1 \u7f3a\u70b9: \u6027\u80fd\u5dee\u70b9","title":"VXLAN \u539f\u751f\u6a21\u5f0f:"},{"location":"0.Internet/3-network-docs/#directrouting","text":"VXLAN DirectRoutinghost-gw\uff08\u5e03\u5c14\u503c\uff09\uff1a\u5f53\u4e3b\u673a\u4f4d\u4e8e\u540c\u4e00\u5b50\u7f51\u4e0a\u65f6\u542f\u7528\u76f4\u63a5\u8def\u7531\uff08\u5982\uff09\u3002VXLAN \u5c06\u4ec5\u7528\u4e8e\u5c01\u88c5\u6570\u636e\u5305\u5230\u4e0d\u540c\u5b50\u7f51\u4e0a\u7684\u4e3b\u673a\u3002\u9ed8\u8ba4\u4e3afalse. Windows \u4e0d\u652f\u6301 DirectRouting \u5f00\u542f\u4e86\u8fd9\u4e2a\u6a21\u5f0f,\u90a3\u7f51\u7edc\u5c31\u4f1a\u63d0\u5347,\u539f\u56e0\u5c31\u662f\u5728\u540c\u7f51\u6bb5\u4e0d\u8fdb\u884c\u5c01\u88c5,\u53ea\u6709\u8de8\u5b50\u7f51\u624d\u8fdb\u884c\u5c01\u88c5. \u76d1\u542c\u7aef\u53e3: [ openbayes-enflame ] root@node1:~# ss -auntp | grep 8472 udp UNCONN 0 0 0 .0.0.0:8472 0 .0.0.0:*","title":"DirectRouting\u6a21\u5f0f:"},{"location":"0.Internet/3-network-docs/#host-gw","text":"\u548cDirectRouting\u7c7b\u4f3c,\u4f46\u662f\u4e0d\u80fd\u8de8\u5b50\u7f51 Use host-gw to create IP routes to subnets via remote machine IPs. Requires direct layer2 connectivity between hosts running flannel. host-gw provides good performance, with few dependencies, and easy set up. flannel \u603b\u7ed3: \u63a8\u8350\u4f7f\u7528VXLAN DirectRouting \u76f8\u540c\u7684 node \u5b50\u7f51\u901a\u4fe1,\u4e0d\u9700\u8981overlay\u5c01\u88c5\u548c\u89e3\u5c01\u88c5,\u800c\u4e14\u8fd8\u53ef\u4ee5\u652f\u6301 node \u8de8\u5b50\u7f51","title":"host-gw \u6a21\u5f0f\uff1a"},{"location":"0.Internet/3-network-docs/#caclio","text":"\u5b98\u7f51\u5730\u5740: https://projectcalico.docs.tigera.io GitHub \u5730\u5740: https://github.com/projectcalico/calico Calico\u662f\u4e00\u4e2a\u7eaf\u4e09\u5c42\u7684\u7f51\u7edc\u89e3\u51b3\u65b9\u6848\uff0c\u4e3a\u5bb9\u5668\u63d0\u4f9b\u591anode\u95f4\u7684\u8bbf\u95ee\u901a\u4fe1\uff0ccalico\u5c06\u6bcf\u4e00\u4e2anode\u8282\u70b9\u90fd\u5f53\u505a\u4e3a\u4e00\u4e2a\u8def\u7531\u5668(router), \u5404\u8282\u70b9\u901a\u8fc7BGP(Border Gateway Protocol)\u8fb9\u754c\u7f51\u5173\u534f\u8bae\u5b66\u4e60\u5e76\u5728node\u8282\u70b9\u751f\u6210\u8def\u7531\u89c4\u5219\uff0c\u4ece\u800c\u5c06\u4e0d\u540cnode\u8282\u70b9\u4e0a\u7684pod\u8fde\u63a5\u8d77\u6765\u8fdb\u884c\u901a\u4fe1\u3002 Calico \u4ecb\u7ecd: \u7f51\u7edc\u901a\u8fc7\u7b2c3\u5c42\u8def\u7531\u6280\u672f(\u5982\u9759\u6001\u8def\u7531\u6216BGP\u8def\u7531\u5206\u914d)\u6216\u7b2c2\u5c42\u5730\u5740\u5b66\u4e60\u6765\u611f\u77e5\u5de5\u4f5c\u8d1f\u8f7dIP\u5730\u5740\u3002\u56e0\u6b64\u5b83\u4eec\u53ef\u4ee5\u5c06\u672a\u5c01\u88c5\u7684\u6d41\u91cf\u8def\u7531\u5230\u4f5c\u4e3a\u6700\u7ec8\u76ee\u7684\u5730\u7684\u7aef\u70b9\u7684\u6b63\u786e\u4e3b\u673a\u3002\u4f46\u662f\u5e76\u975e\u6240\u6709\u7f51\u7edc\u90fd\u80fd\u591f\u8def\u7531\u5de5\u4f5c\u8d1f\u8f7dIP\u5730\u5740\u3002\u4f8b\u5982\u516c\u5171\u4e91\u73af\u5883\u3001\u8de8VPC\u5b50\u7f51\u8fb9\u754c\u7684AWS,\u4ee5\u53ca\u65e0\u6cd5\u901a\u8fc7BGP \u3001Calico\u5bf9\u5e94\u5230under lay\u7f51\u7edc\u6216\u65e0\u6cd5\u8f7b\u677e\u914d\u7f6e\u9759\u6001\u8def\u7531\u7684\u5176\u4ed6\u573a\u666f\uff0c\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48Calico\u652f\u6301\u5c01\u88c5\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u5728\u5de5\u4f5c\u8d1f\u8f7d\u4e4b\u95f4\u53d1\u9001\u6d41\u91cf\uff0c\u800c\u65e0\u9700\u5e95\u5c42\u7f51\u7edc\u77e5\u9053\u5de5\u4f5c\u8d1f\u8f7dIP\u5730\u5740\u3002 calico\u5c01\u88c5\u7c7b\u578b: Calico\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u5c01\u88c5: VXLAN\u548cIP-in-IP, VXLAN\u5728IP\u4e2d\u6ca1\u6709 IP\u7684\u67d0\u4e9b\u73af\u5883\u4e2d\u53d7\u652f\u6301(\u4f8b\u5982Azure)\uff0cVXLAN\u7684\u6bcf \u6570\u636e\u5305\u5f00\u9500\u7a0d\u9ad8\uff0c\u56e0\u4e3a\u62a5\u5934\u8f83\u5927\uff0c\u4f46\u9664\u975e\u60a8\u8fd0\u884c\u7684\u662f\u7f51\u7edc\u5bc6\u96c6\u578b\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5426\u5219\u60a8\u901a\u5e38\u4e0d\u4f1a\u6ce8\u610f\u5230\u8fd9\u79cd\u5dee\u5f02\u3002\u8fd9\u4e24\u79cd\u5c01\u88c5\u4e4b\u95f4\u7684\u53e6\u4e00\u4e2a\u5c0f\u5dee\u5f02\u662fCal ico\u7684VXLAN\u5b9e\u73b0\u4e0d\u4f7f\u7528BGP, Calico\u7684IP-in-IP\u662f\u5728Calico\u8282\u70b9\u4e4b\u95f4\u4f7f\u7528BGP\u534f\u8bae\u5b9e\u73b0\u8de8\u5b50\u7f51\u3002 Calico\u4e24\u79cd\u7f51\u7edc\u6a21\u5f0f Calico\u672c\u8eab\u652f\u6301\u591a\u79cd\u7f51\u7edc\u6a21\u5f0f\uff0c\u4eceoverlay\u548cunderlay\u4e0a\u533a\u5206\u3002Calico overlay \u6a21\u5f0f\uff0c\u4e00\u822c\u4e5f\u79f0Calico IPIP\u6216VXLAN\u6a21\u5f0f\uff0c\u4e0d\u540cNode\u95f4Pod\u4f7f\u7528IPIP\u6216VXLAN\u96a7\u9053\u8fdb\u884c\u901a\u4fe1\u3002Calico underlay \u6a21\u5f0f\uff0c\u4e00\u822c\u4e5f\u79f0calico BGP\u6a21\u5f0f\uff0c\u4e0d\u540cNode Pod\u4f7f\u7528\u76f4\u63a5\u8def\u7531\u8fdb\u884c\u901a\u4fe1\u3002\u5728overlay\u548cunderlay\u90fd\u6709nodetonode mesh(\u5168\u7f51\u4e92\u8054)\u548cRoute Reflector(\u8def\u7531\u53cd\u5c04\u5668)\u3002\u5982\u679c\u6709\u5b89\u5168\u7ec4\u7b56\u7565\u9700\u8981\u5f00\u653eIPIP\u534f\u8bae\uff1b\u8981\u6c42Node\u5141\u8bb8BGP\u534f\u8bae\uff0c\u5982\u679c\u6709\u5b89\u5168\u7ec4\u7b56\u7565\u9700\u8981\u5f00\u653eTCP 179\u7aef\u53e3\uff1b\u5b98\u65b9\u63a8\u8350\u4f7f\u7528\u5728Node\u5c0f\u4e8e100\u7684\u96c6\u7fa4\uff0c\u6211\u4eec\u5728\u4f7f\u7528\u7684\u8fc7\u7a0b\u4e2d\u5df2\u7ecf\u901a\u8fc7IPIP\u6a21\u5f0f\u652f\u6491\u4e86100-200\u89c4\u6a21\u7684\u96c6\u7fa4\u7a33\u5b9a\u8fd0\u884c\u3002 BGP\u662f\u4e00\u4e2a\u53bb\u4e2d\u5fc3\u5316\u7684\u534f\u8bae\uff0c\u5b83\u901a\u8fc7\u81ea\u52a8\u5b66\u4e60\u548c\u7ef4\u62a4\u8def\u7531\u8868\u5b9e\u73b0\u7f51\u7edc\u7684\u53ef\u7528\u6027\uff0c\u4f46\u662f\u5e76\u4e0d\u662f\u6240\u6709\u7684\u7f51\u7edc\u90fd\u652f\u6301BGP,\u53e6\u5916\u4e3a\u4e86\u8de8\u7f51\u7edc \u5b9e\u73b0\u66f4\u5927\u89c4\u6a21\u7684\u7f51\u7edc\u7ba1\u7406\uff0ccalico \u8fd8\u652f\u6301IP-in-IP\u7684\u53e0\u52a0\u6a21\u578b\uff0c\u7b80\u79f0IPIP, IPIP\u53ef\u4ee5\u5b9e\u73b0\u8de8\u4e0d\u540c\u7f51\u6bb5\u5efa\u7acb \u8def\u7531\u901a\u4fe1\uff0c\u4f46\u662f\u4f1a\u5b58\u5728\u5b89\u5168\u6027\u95ee\u9898\uff0c\u5176\u5728\u5185\u6838\u5185\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7Calico\u7684\u914d\u7f6e\u6587\u4ef6\u8bbe\u7f6e\u662f\u5426\u542f\u7528IPIP\uff0c \u5728\u516c\u53f8\u5185\u90e8\u5982\u679ck8s\u7684node\u8282\u70b9\u6ca1\u6709\u8de8\u8d8a\u7f51\u6bb5\u5efa\u8bae\u5173\u95edIPIP\u3002 IPIP\u662f\u4e00-\u79cd\u5c06\u5404Node\u7684\u8def\u7531\u4e4b\u95f4\u505a\u4e00\u4e2atunnel, \u518d\u628a\u4e24\u4e2a\u7f51\u7edc\u8fde\u63a5\u8d77\u6765\u7684\u6a21\u5f0f\u3002\u542f\u7528IPIP\u6a21\u5f0f\u65f6\uff0cCalico\u5c06\u5728\u5404Node\u4e0a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a\" tun10\"\u7684\u865a\u62df\u7f51\u7edc\u63a5\u53e3\u3002 BGP\u6a21\u5f0f\u5219\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u673a\u4f5c\u4e3a\u865a\u62df\u8def\u7531\u8def(vRouter) \uff0c\u4e0d\u518d\u521b\u5efa\u989d\u5916\u7684tunnel. Calio \u67b6\u6784: Calio \u7ec4\u4ef6: Felix: calico\u7684agent, \u8fd0\u884c\u5728\u6bcf\u4e00\u53f0node\u8282\u70b9\u4e0a\uff0c \u5176\u4e3b\u8981\u662f\u7ef4\u62a4\u8def\u7531\u89c4\u5219\u3001\u6c47\u62a5\u5f53\u524d\u8282\u70b9\u72b6\u6001\u4ee5\u786e\u4fddpod\u7684\u5938\u4e3b\u673a\u901a\u4fe1\u3002 BGP Client: \u6bcf\u53f0node\u90fd\u8fd0\u884c\uff0c\u5176\u4e3b\u8981\u8d1f\u8d23\u76d1\u542cnode\u8282\u70b9\u4e0a\u7531felix\u751f\u6210\u7684\u8def\u7531\u4fe1\u606f\uff0c\u7136\u540e\u901a\u8fc7BGP\u534f\u8bae\u5e7f\u64ad\u81f3\u5176\u4ed6\u5269\u4f59\u7684node\u8282\u70b9\uff0c\u4ece\u800c\u76f8\u4e92\u5b66\u4e60\u8def\u7531\u5b9e\u73b0pod\u901a\u4fe1\u3002 Route Reflector:\u96c6\u4e2d\u5f0f\u7684\u8def\u7531\u53cd\u5c04\u5668\uff0ccalico v3.3\u5f00\u59cb\u652f\u6301\uff0c\u5f53Calico BGP\u5ba2\u6237\u7aef\u5c06\u8def\u7531\u4ece\u5176FIB(Forward InformationdataBase,\u8f6c\u53d1\u4fe1\u606f\u5e93)\u901a\u544a\u5230Route Reflector\u65f6\uff0cRoute Reflector \u4f1a\u5c06\u8fd9\u4e9b\u8def\u7531\u901a\u544a\u7ed9\u90e8\u7f72\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u8282\u70b9\uff0cRoute Reflector\u4e13\u95e8\u7528\u4e8e\u7ba1\u7406BGP\u7f51\u7edc\u8def\u7531\u89c4\u5219\uff0c\u4e0d\u4f1a\u4ea7\u751fpod\u6570\u636e\u901a\u4fe1\u3002 \u6ce8: calico\u9ed8\u8ba4\u5de5\u4f5c\u6a21\u5f0f\u662fBGP\u7684node- to-node mesh,\u5982\u679c\u8981\u4f7f\u7528Route Reflector \u9700\u8981\u8fdb\u884c\u76f8\u5173\u914d\u7f6e\u3002 https://docs.projectcalico.org/v3.4/usage/routereflector https://docs.projectcalico.org/v3.2/usage/routereflector/calico-routereflector https://blog.kelu.org/category/tech.html https://blog.kelu.org/tech/2020/01/11/calico-series-3-calico-components-and-arch.html \u5f00\u542f ip-ip \u6a21\u5f0f,\u53ef\u4ee5\u770b\u5230\u540e\u9762\u6709\u4e2a\u96a7\u9053tunl0 (\u517c\u5bb9\u6027\u597d,\u53ef\u4ee5\u8de8\u5b50\u7f51) \u603b\u7ed3: \u539f\u5219\u4f7f\u7528: \u81ea\u5efa\u673a\u623f\u4f18\u5148\u4f7f\u7528 caclio caclio \u652f\u6301\u7f51\u7edc\u7b56\u7565 \u6027\u80fd\u9ad8\u4e8e flannel \u4f7f\u7528\u542f\u7528overlay \u8003\u8651\u540e\u671f\u7684\u7f51\u7edc\u6269\u5c55,node \u8282\u70b9\u662f\u5426\u5b58\u5728\u8de8\u5b50\u7f51\u7684\u95ee\u9898 \u4e0d\u542f\u7528 overlay flannel host-gw caclio bgp (\u76f4\u63a5\u8def\u7531) \u542f\u7528 overlay caclio IPIP flannel vxlan CrossSubnet: \u8868\u793a\uff08ipip-bgp\u6df7\u5408\u6a21\u5f0f\uff09\uff0c\u6307\u201c\u540c\u5b50\u7f51\u5185\u8def\u7531\u91c7\u7528bgp\uff0c\u8de8\u5b50\u7f51\u8def\u7531\u91c7\u7528ipip \u5728\u4f7f\u7528\u573a\u666f\u4e0a\u5f53\u4e3b\u673a\u8282\u70b9\u5904\u4e8e\u4e0d\u540c\u7f51\u7edc\u5206\u6bb5\uff0c\u9700\u8981\u8de8\u7f51\u6bb5\u901a\u4fe1\u65f6\uff0cBGP\u6a21\u5f0f\u5c06\u4f1a\u5931\u6548\uff0c\u6b64\u65f6\u8981\u4f7f\u7528IPIP\u6a21\u5f0f\u3002 Calico\u7684BGP Mesh\u6a21\u5f0f\u9002\u5408\u5728\u5c0f\u89c4\u6a21\u96c6\u7fa4(\u8282\u70b9\u6570\u91cf\u5c0f\u4e8e100\u4e2a)\u4e2d\u76f4\u63a5\u4e92\u8054\uff0c\u7531\u4e8e\u968f\u7740\u96c6\u7fa4\u8282\u70b9\u6570\u91cf\u7684\u589e\u52a0\uff0c\u8def\u7531\u89c4\u5219\u5c06\u6210\u6307\u6570\u7ea7\u589e\u957f\u4f1a\u7ed9\u96c6\u7fa4\u7f51\u7edc\u5e26\u6765\u5f88\u5927\u538b\u529b\u3002\u5927\u89c4\u6a21\u96c6\u7fa4\u9700\u8981\u4f7f\u7528BGP Route Reflector GitHub \u5730\u5740: https://github.com/projectcalico/calico/blob/79b442a53adb7d7f1fd62927d9322daf87dce9de/calico/reference/public-cloud/aws.md","title":"\u7f51\u7edc\u7ec4\u4ef6caclio"},{"location":"0.Internet/3-network-docs/#_2","text":"\u8c03\u7814\u4e0d\u540c\u7f51\u7edc\u7ec4\u4ef6\u5bf9\u7f51\u7edc\u7684\u5f71\u54cd:(\u540c\u7b49\u914d\u7f6e\u4e0b) docker-compose \u5c31\u4e0d\u9700\u8981\u505a overlay \u7684\u5c01\u88c5\u548c\u89e3\u5c01\u88c5,\u6027\u80fd\u662f\u6700\u597d\u7684. \u538b\u6d4b\u8c03\u7814: flannel \u7f51\u7edc\u7ec4\u4ef6 \u538b\u6d4b\u8c03\u7814: DirectRouting\u6a21\u5f0f: \u5347\u7ea7\u7cfb\u7edf calico \u7ec4\u4ef6: \u5173\u95ed IPIP \u4f7f\u7528 BGP \u4f46\u662f\u8fd9\u4e2a\u7ed3\u679c\u8fd8\u662f\u8fbe\u4e0d\u5230\u9884\u671f\u7684\u6548\u679c,\u6700\u540e\u7684\u89e3\u51b3\u65b9\u6848\u662f\u5355\u673a\u591a\u526f\u672c","title":"\u4e0d\u540c\u7ec4\u4ef6\u538b\u6d4b\u8c03\u7814"},{"location":"0.Internet/3-network-docs/#_3","text":"\u81ea\u5df1\u538b\u6d4b: caclio \u7684IPIP\u6a21\u5f0f: \u6587\u7ae0\u53c2\u8003: https://system51.github.io/2020/05/27/using-calico/ https://projectcalico.docs.tigera.io/ https://blog.frognew.com/2021/07/relearning-container-22.html#%E5%8F%82%E8%80%83 https://kiddie92.github.io/2019/01/23/kubernetes-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E7%AE%80%E4%BB%8B/ https://gist.github.com/baymaxium/7797f226fe03d38461f33fdd02145b11","title":"\u7f51\u7edc\u6027\u80fd\u6d4b\u8bd5\u5bf9\u6bd4"},{"location":"0.Internet/4-network-docs/","text":"\u79d1\u5b66\u4e0a\u7f51 \u00b6 \u6211\u662f\u4e00\u540d\u6280\u672f\u4eba\u5458\uff0c\u5e73\u65f6\u6bcf\u5929\u9700\u8981\u5927\u91cf\u7684Google\u53bb\u770b\u4e00\u4e9b\u6587\u7ae0\uff0c\u5f53\u7136\u4e5f\u56de\u53bb\u6cb9\u7ba1\u901b\u901b\uff0c\u90a3\u4e48\u56fd\u5185\u4e0a\u7f51\u7684\u73af\u5883\u5e76\u4e0d\u662f\u5f88\u7406\u60f3\uff0c\u800c\u4e14\u8d44\u6e90\u4e5f\u6709\u9650\uff0c \u6240\u4ee5\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\uff0c\u90a3\u4e48\u6211\u63a8\u8350\u4e00\u4e2a\u6bd4\u8f83\u597d\u7528\u7684\u673a\u573a\u3002 WgetCloud \uff08\u539fGaCloud \uff09\u662f\u4e00\u5bb6\u7cbe\u54c1\u673a\u573a\uff0c\u7ebf\u8def\u6570\u91cf\u4e0d\u7b97\u591a\uff0c\u4f46\u90fd\u662f\u5341\u5206\u4f18\u8d28\u7684\u4f4e\u5ef6\u8fdfBGP\u4e2d\u8f6c\u7ebf\u8def\u3002 \u6211\u4e2a\u4eba\u4f7f\u7528\u6d4b\u8bd5\u8fc7\uff0c\u8fd8\u662f\u5f88\u7ed9\u529b,\u7ed9\u5de5\u4f5c\u548c\u751f\u6d3b\u5e26\u6765\u4e86\u5f88\u5927\u4fbf\u5229 WgetCloud\u63a8\u8350: https://invite.wgetcloud.ltd/auth/register?code=Apl0 (\u7f3a\u70b9\u5c31\u662f\u5f88\u8d35) FLYINGBIRD: https://fbinv02.fbaff.cc/auth/register?code=Ov2hXwwW (\u4fbf\u5b9c) \u5982\u4f55\u79d1\u5b66\u4e0a\u7f51 \u00b6 \u5bf9\u4e8e\u5b66\u4e60\u548c\u627e\u8d44\u6599\uff0c\u6211\u4eec\u5f88\u591a\u7684\u65f6\u5019\u90fd\u8981\u8bbf\u95ee\u5916\u56fd\u7f51\u7ad9\uff0c\u4f46\u662f\u7531\u4e8e\u9632\u706b\u5899\u9650\u5236\uff0c\u5c31\u9700\u8981\u901a\u8fc7\u79d1\u5b66\u4e0a\u7f51\u6765\u5b9e\u73b0\u8bbf\u95ee\u3002\u4ee5\u4e0a\u4e24\u79cd\u65b9\u5f0f\u90fd\u53ef\u4ee5\uff0c\u6211\u73b0\u5728\u76ee\u524d\u4f7f\u7528\u7684\u65b9\u5f0f\u4e8c\u3002 \u4e0b\u8f7d\u7ffb\u5899\u5de5\u5177\uff08\u5de5\u5177\u63a8\u8350clash\uff09 \u5de5\u5177\u5b89\u88c5: https://fbdoc.cloudnovaco.com/flyingbird-docs/macosclashx-pro-shi-yong-jiao-cheng \u8d2d\u4e70\u4e4b\u540e\u4f60\u5c31\u4f1a\u83b7\u5f97\u8ba2\u9605\u5730\u5740\uff0c\u53ef\u4ee5\u590d\u5236\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5012\u5165 \u5012\u5165\u4e4b\u540e\u5c31\u4f1a\u6709\u673a\u573a\u663e\u793a\uff0c\u4e00\u822c\u9009\u62e9Rule \u6253\u5f00\u7cfb\u7edf\u4ee3\u7406 \u9a8c\u8bc1\u7ffb\u5899\uff08youtube\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5c31\u7ffb\u5899\u6210\u529f\uff09 \uff08\uff09 \u6587\u7ae0\u53c2\u8003 \u00b6 \u6559\u7a0b\u5b89\u88c5: https://fbdoc.cloudnovaco.com/flyingbird-docs/macosclashx-pro-shi-yong-jiao-cheng windows \u8f6f\u4ef6\u5b89\u88c5\uff1ahttps://fbdoc.cloudnovaco.com/flyingbird-docs/windowsclash-shi-yong-jiao-cheng Mac \u8f6f\u4ef6\u5b89\u88c5\uff1a https://fbdoc.cloudnovaco.com/flyingbird-docs/macosclashx-pro-shi-yong-jiao-cheng","title":"\u79d1\u5b66\u4e0a\u7f51"},{"location":"0.Internet/4-network-docs/#_1","text":"\u6211\u662f\u4e00\u540d\u6280\u672f\u4eba\u5458\uff0c\u5e73\u65f6\u6bcf\u5929\u9700\u8981\u5927\u91cf\u7684Google\u53bb\u770b\u4e00\u4e9b\u6587\u7ae0\uff0c\u5f53\u7136\u4e5f\u56de\u53bb\u6cb9\u7ba1\u901b\u901b\uff0c\u90a3\u4e48\u56fd\u5185\u4e0a\u7f51\u7684\u73af\u5883\u5e76\u4e0d\u662f\u5f88\u7406\u60f3\uff0c\u800c\u4e14\u8d44\u6e90\u4e5f\u6709\u9650\uff0c \u6240\u4ee5\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\uff0c\u90a3\u4e48\u6211\u63a8\u8350\u4e00\u4e2a\u6bd4\u8f83\u597d\u7528\u7684\u673a\u573a\u3002 WgetCloud \uff08\u539fGaCloud \uff09\u662f\u4e00\u5bb6\u7cbe\u54c1\u673a\u573a\uff0c\u7ebf\u8def\u6570\u91cf\u4e0d\u7b97\u591a\uff0c\u4f46\u90fd\u662f\u5341\u5206\u4f18\u8d28\u7684\u4f4e\u5ef6\u8fdfBGP\u4e2d\u8f6c\u7ebf\u8def\u3002 \u6211\u4e2a\u4eba\u4f7f\u7528\u6d4b\u8bd5\u8fc7\uff0c\u8fd8\u662f\u5f88\u7ed9\u529b,\u7ed9\u5de5\u4f5c\u548c\u751f\u6d3b\u5e26\u6765\u4e86\u5f88\u5927\u4fbf\u5229 WgetCloud\u63a8\u8350: https://invite.wgetcloud.ltd/auth/register?code=Apl0 (\u7f3a\u70b9\u5c31\u662f\u5f88\u8d35) FLYINGBIRD: https://fbinv02.fbaff.cc/auth/register?code=Ov2hXwwW (\u4fbf\u5b9c)","title":"\u79d1\u5b66\u4e0a\u7f51"},{"location":"0.Internet/4-network-docs/#_2","text":"\u5bf9\u4e8e\u5b66\u4e60\u548c\u627e\u8d44\u6599\uff0c\u6211\u4eec\u5f88\u591a\u7684\u65f6\u5019\u90fd\u8981\u8bbf\u95ee\u5916\u56fd\u7f51\u7ad9\uff0c\u4f46\u662f\u7531\u4e8e\u9632\u706b\u5899\u9650\u5236\uff0c\u5c31\u9700\u8981\u901a\u8fc7\u79d1\u5b66\u4e0a\u7f51\u6765\u5b9e\u73b0\u8bbf\u95ee\u3002\u4ee5\u4e0a\u4e24\u79cd\u65b9\u5f0f\u90fd\u53ef\u4ee5\uff0c\u6211\u73b0\u5728\u76ee\u524d\u4f7f\u7528\u7684\u65b9\u5f0f\u4e8c\u3002 \u4e0b\u8f7d\u7ffb\u5899\u5de5\u5177\uff08\u5de5\u5177\u63a8\u8350clash\uff09 \u5de5\u5177\u5b89\u88c5: https://fbdoc.cloudnovaco.com/flyingbird-docs/macosclashx-pro-shi-yong-jiao-cheng \u8d2d\u4e70\u4e4b\u540e\u4f60\u5c31\u4f1a\u83b7\u5f97\u8ba2\u9605\u5730\u5740\uff0c\u53ef\u4ee5\u590d\u5236\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5012\u5165 \u5012\u5165\u4e4b\u540e\u5c31\u4f1a\u6709\u673a\u573a\u663e\u793a\uff0c\u4e00\u822c\u9009\u62e9Rule \u6253\u5f00\u7cfb\u7edf\u4ee3\u7406 \u9a8c\u8bc1\u7ffb\u5899\uff08youtube\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5c31\u7ffb\u5899\u6210\u529f\uff09 \uff08\uff09","title":"\u5982\u4f55\u79d1\u5b66\u4e0a\u7f51"},{"location":"0.Internet/4-network-docs/#_3","text":"\u6559\u7a0b\u5b89\u88c5: https://fbdoc.cloudnovaco.com/flyingbird-docs/macosclashx-pro-shi-yong-jiao-cheng windows \u8f6f\u4ef6\u5b89\u88c5\uff1ahttps://fbdoc.cloudnovaco.com/flyingbird-docs/windowsclash-shi-yong-jiao-cheng Mac \u8f6f\u4ef6\u5b89\u88c5\uff1a https://fbdoc.cloudnovaco.com/flyingbird-docs/macosclashx-pro-shi-yong-jiao-cheng","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"0.Internet/5g-docs/","text":"\u7f51\u7edc \u601d\u79d1\u8bbe\u5907 \u00b6 \u8def\u7531\u5668 \u00b6 cisco \u8def\u7531\u8bbe\u5907\u7684\u57fa\u672c\u914d\u7f6e en conf t no ip domain-lo line con 0 exec-t 0 0 logg syn end \u914d\u7f6eIP(\u5b9e\u73b0\u4e92\u901a) int f 0 /1 ip address ip_address subnet_mask no shutdown \u6e29\u99a8\u63d0\u793a \u4e00\u822c\u6765\u8bf4\uff0c\u8def\u7531\u5668\u7684\u7269\u7406\u63a5\u53e3\u9ed8\u8ba4\u90fd\u662f\u5173\u95ed\u7684\uff0c\u9700\u8981\u7528\u201cno shutdown\u201d \u547d\u4ee4\u5f00\u542f\uff1b\u4f46\u4ea4\u6362\u673a\u7684\u7269\u7406\u63a5\u53e3\u9ed8\u8ba4\u90fd\u662f\u5f00\u542f \u9759\u6001\u8def\u7531 \u00b6 \u9759\u6001\u8def\u7531 \u9ed8\u8ba4\u8def\u7531 \u4e24\u79cd\u914d\u7f6e\u65b9\u5f0f: # \u9759\u6001\u8def\u7531 ip route \u672a\u77e5\u7f51\u6bb5 \u5b50\u7f51\u63a9\u7801 \u4e0b\u4e00\u8df3 # \u9ed8\u8ba4\u8def\u7531 ip route 0.0.0.0 0.0.0.0 \u4e0b\u4e00\u8df3 \u4ea4\u6362\u673a \u00b6 \u7ed9\u4ea4\u6362\u673a\u914d\u7f6eIP\u5730\u5740\u5e76\u4e0d\u50cf\u8def\u7531\u5668\u90a3\u6837\u914d\u7f6e\u5728\u7269\u7406\u63a5\u53e3\u4e0a\uff0c\u800c\u662f\u914d\u7f6e\u5728\u865a\u62df\u63a5\u53e3\u4e0a\uff0c\u8fd9\u6837\uff0c\u65e0\u8bba\u4efb\u4f55\u4e00\u4e2a\u7269\u7406\u63a5\u53e3\u8fde\u63a5\u4ea4\u6362\u673a\u90fd\u53ef\u4ee5\u8bbf\u95ee\u865a\u62df\u63a5\u53e3\u7684IP\u5730\u5740\uff0c\u4ece\u800c\u5b9e\u73b0\u5bf9\u4ea4\u6362\u673a\u7684\u7ba1\u7406 int vlan 1 ip address ip_address subnet_address no shutdown \u865a\u62df\u5c40\u57df\u7f51 \u00b6 \u7b80\u4ecb: \u968f\u7740\u7f51\u7edc\u89c4\u6a21\u7684\u4e0d\u65ad\u6269\u5927\uff0c\u63a5\u5165\u7684\u4e3b\u673a\u8d8a\u6765\u8d8a\u591a\uff0c\u7f51\u7edc\u4e2d\u7684\u5e7f\u64ad\u6d41\u91cf\u4e5f\u968f\u4e4b\u52a0\u5927\u3002\u8fd9\u6837\u5c31\u4f1a\u52a0\u91cd\u4ea4\u6362\u673a\u7684\u8d1f\u62c5\uff0c\u751a\u81f3\u53ef\u80fd\u5bfc\u81f4\u4ea4\u6362\u673a\u6b7b\u673a\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u4e00\u79cd\u65b9\u6cd5\u6765\u5206\u5272\u4ea4\u6362\u673a\u4e0a\u7684\u5e7f\u64ad\u57df\u5462? \u672c\u7ae0\u5c06\u8981\u8bb2\u89e3\u7684 VLAN (Virtual Local Area Network\uff0c\u865a\u62df\u5c40\u57df\u7f51) \u6280\u672f\uff0c\u53ef\u4ee5\u4ece\u903b\u8f91\u4e0a\u5c06\u4e00\u4e2a\u5927\u7684\u7f51\u7edc\u5212\u5206\u6210\u82e5\u5e72\u5c0f\u7684\u865a\u62df\u5c40\u57df\u7f51\u3002VLAN \u6280\u672f\u4e0d\u4ec5\u80fd\u591f\u63a7\u5236\u5e7f\u64ad\uff0c\u8fd8\u53ef\u4ee5\u589e\u5f3a\u7f51\u7edc\u7684\u5b89\u5168\u6027","title":"\u7f51\u7edc \u601d\u79d1\u8bbe\u5907"},{"location":"0.Internet/5g-docs/#_1","text":"","title":"\u7f51\u7edc \u601d\u79d1\u8bbe\u5907"},{"location":"0.Internet/5g-docs/#_2","text":"cisco \u8def\u7531\u8bbe\u5907\u7684\u57fa\u672c\u914d\u7f6e en conf t no ip domain-lo line con 0 exec-t 0 0 logg syn end \u914d\u7f6eIP(\u5b9e\u73b0\u4e92\u901a) int f 0 /1 ip address ip_address subnet_mask no shutdown \u6e29\u99a8\u63d0\u793a \u4e00\u822c\u6765\u8bf4\uff0c\u8def\u7531\u5668\u7684\u7269\u7406\u63a5\u53e3\u9ed8\u8ba4\u90fd\u662f\u5173\u95ed\u7684\uff0c\u9700\u8981\u7528\u201cno shutdown\u201d \u547d\u4ee4\u5f00\u542f\uff1b\u4f46\u4ea4\u6362\u673a\u7684\u7269\u7406\u63a5\u53e3\u9ed8\u8ba4\u90fd\u662f\u5f00\u542f","title":"\u8def\u7531\u5668"},{"location":"0.Internet/5g-docs/#_3","text":"\u9759\u6001\u8def\u7531 \u9ed8\u8ba4\u8def\u7531 \u4e24\u79cd\u914d\u7f6e\u65b9\u5f0f: # \u9759\u6001\u8def\u7531 ip route \u672a\u77e5\u7f51\u6bb5 \u5b50\u7f51\u63a9\u7801 \u4e0b\u4e00\u8df3 # \u9ed8\u8ba4\u8def\u7531 ip route 0.0.0.0 0.0.0.0 \u4e0b\u4e00\u8df3","title":"\u9759\u6001\u8def\u7531"},{"location":"0.Internet/5g-docs/#_4","text":"\u7ed9\u4ea4\u6362\u673a\u914d\u7f6eIP\u5730\u5740\u5e76\u4e0d\u50cf\u8def\u7531\u5668\u90a3\u6837\u914d\u7f6e\u5728\u7269\u7406\u63a5\u53e3\u4e0a\uff0c\u800c\u662f\u914d\u7f6e\u5728\u865a\u62df\u63a5\u53e3\u4e0a\uff0c\u8fd9\u6837\uff0c\u65e0\u8bba\u4efb\u4f55\u4e00\u4e2a\u7269\u7406\u63a5\u53e3\u8fde\u63a5\u4ea4\u6362\u673a\u90fd\u53ef\u4ee5\u8bbf\u95ee\u865a\u62df\u63a5\u53e3\u7684IP\u5730\u5740\uff0c\u4ece\u800c\u5b9e\u73b0\u5bf9\u4ea4\u6362\u673a\u7684\u7ba1\u7406 int vlan 1 ip address ip_address subnet_address no shutdown","title":"\u4ea4\u6362\u673a"},{"location":"0.Internet/5g-docs/#_5","text":"\u7b80\u4ecb: \u968f\u7740\u7f51\u7edc\u89c4\u6a21\u7684\u4e0d\u65ad\u6269\u5927\uff0c\u63a5\u5165\u7684\u4e3b\u673a\u8d8a\u6765\u8d8a\u591a\uff0c\u7f51\u7edc\u4e2d\u7684\u5e7f\u64ad\u6d41\u91cf\u4e5f\u968f\u4e4b\u52a0\u5927\u3002\u8fd9\u6837\u5c31\u4f1a\u52a0\u91cd\u4ea4\u6362\u673a\u7684\u8d1f\u62c5\uff0c\u751a\u81f3\u53ef\u80fd\u5bfc\u81f4\u4ea4\u6362\u673a\u6b7b\u673a\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u4e00\u79cd\u65b9\u6cd5\u6765\u5206\u5272\u4ea4\u6362\u673a\u4e0a\u7684\u5e7f\u64ad\u57df\u5462? \u672c\u7ae0\u5c06\u8981\u8bb2\u89e3\u7684 VLAN (Virtual Local Area Network\uff0c\u865a\u62df\u5c40\u57df\u7f51) \u6280\u672f\uff0c\u53ef\u4ee5\u4ece\u903b\u8f91\u4e0a\u5c06\u4e00\u4e2a\u5927\u7684\u7f51\u7edc\u5212\u5206\u6210\u82e5\u5e72\u5c0f\u7684\u865a\u62df\u5c40\u57df\u7f51\u3002VLAN \u6280\u672f\u4e0d\u4ec5\u80fd\u591f\u63a7\u5236\u5e7f\u64ad\uff0c\u8fd8\u53ef\u4ee5\u589e\u5f3a\u7f51\u7edc\u7684\u5b89\u5168\u6027","title":"\u865a\u62df\u5c40\u57df\u7f51"},{"location":"0.Internet/IB-ET-docs/","text":"\u7f51\u7edc\u6a21\u5f0f\u8c03\u6574(IB->\u4ee5\u592a\u7f51) \u00b6 \u4e0b\u8f7d\u9a71\u52a8\u7a0b\u5e8f \u00b6 \u5b98\u7f51\u5730\u5740: https://developer.nvidia.com/networking/infiniband-software \u6839\u636e\u81ea\u5df1\u7cfb\u7edf\u7684\u7248\u672c\u8fdb\u884c\u9009\u62e9 \u8fde\u63a5\u5730\u5740: https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/ \u5b89\u88c5: \u00b6 \u5c06\u6211\u4eec\u4e0b\u8f7d\u597d\u7684\u9a71\u52a8\u7a0b\u5e8f\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u4e0a\uff0c\u5e76\u89e3\u538b\u3002 1.\u8bbe\u7f6e MLNX_OFED apt-get \u5b58\u50a8\u5e93 \u4f7f\u7528\u4ee5\u4e0b\u5185\u5bb9\u521b\u5efa\u540d\u4e3a\u201c/etc/apt/sources.list.d/mlnx_ofed.list\u201d\u7684 apt-get \u5b58\u50a8\u5e93\u914d\u7f6e\u6587\u4ef6 deb file:/home/openbayes/MLNX_OFED_LINUX-23.07-0.5.1.2-ubuntu22.04-x86_64/DEBS ./ 2.\u4e0b\u8f7d\u5e76\u5b89\u88c5 Mellanox Technologies GPG-KEY wget -qO - http://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox | sudo apt-key add - 3.\u66f4\u65b0 apt-get \u7f13\u5b58 sudo apt-get update 4.\u4f7f\u7528 apt-get \u5de5\u5177\u5b89\u88c5 MLNX_OFED apt-get install mlnx-ofed-all 5.\u66f4\u65b0\u5230\u56fa\u4ef6 apt-get install mlnx-fw-updater 5.\u4f7f\u7528 mlnxofedinstall \u811a\u672c\u5b89\u88c5 /opt/mlnxofedinstall Infiniband\u5361\u5207\u6362IB/Ethernet\u6a21\u5f0f \u00b6 root@bayes:/home/lixie# mst status MST modules: ------------ MST PCI module is not loaded MST PCI configuration module loaded MST devices: ------------ /dev/mst/mt4119_pciconf0 - PCI configuration cycles access. domain:bus:dev.fn = 0000 :06:00.0 addr.reg = 88 data.reg = 92 cr_bar.gw_offset = -1 Chip revision is: 00 \u9996\u5148\uff0c\u542f\u52a8mst \u5de5\u5177\uff0c\u901a\u8fc7 mst\u5de5\u5177\u67e5\u770b\u81ea\u5df1\u7684MST devices\uff1a/dev/mst/mt4119_pciconf0 \uff08\u6ca1\u6709mst\u5de5\u5177\uff0c\u9700\u8981\u4e0b\u8f7d\u5b89\u88c5\uff09 root@bayes:/home/lixie# mlxconfig -d /dev/mst/mt4119_pciconf0 query LINK_TYPE_P1 IB(1) LINK_TYPE_P2 IB(1) \u5de5\u4f5c\u6a21\u5f0f\u4fee\u6539: Ethernet\u6a21\u5f0f\uff1a mlxconfig -d /dev/mst/mt4119_pciconf0 set LINK_TYPE_P1=2 IB\u6a21\u5f0f\uff1a mlxconfig -d /dev/mst/mt4119_pciconf0 set LINK_TYPE_P1=1 \u6e29\u99a8\u63d0\u793a \u8c03\u6574\u4e4b\u540e\uff0c\u9700\u8981\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u5668\u3002","title":"\u7f51\u7edc \u7f51\u5361\u6a21\u5f0f\u8c03\u6574"},{"location":"0.Internet/IB-ET-docs/#ib-","text":"","title":"\u7f51\u7edc\u6a21\u5f0f\u8c03\u6574(IB-&gt;\u4ee5\u592a\u7f51)"},{"location":"0.Internet/IB-ET-docs/#_1","text":"\u5b98\u7f51\u5730\u5740: https://developer.nvidia.com/networking/infiniband-software \u6839\u636e\u81ea\u5df1\u7cfb\u7edf\u7684\u7248\u672c\u8fdb\u884c\u9009\u62e9 \u8fde\u63a5\u5730\u5740: https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/","title":"\u4e0b\u8f7d\u9a71\u52a8\u7a0b\u5e8f"},{"location":"0.Internet/IB-ET-docs/#_2","text":"\u5c06\u6211\u4eec\u4e0b\u8f7d\u597d\u7684\u9a71\u52a8\u7a0b\u5e8f\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u4e0a\uff0c\u5e76\u89e3\u538b\u3002 1.\u8bbe\u7f6e MLNX_OFED apt-get \u5b58\u50a8\u5e93 \u4f7f\u7528\u4ee5\u4e0b\u5185\u5bb9\u521b\u5efa\u540d\u4e3a\u201c/etc/apt/sources.list.d/mlnx_ofed.list\u201d\u7684 apt-get \u5b58\u50a8\u5e93\u914d\u7f6e\u6587\u4ef6 deb file:/home/openbayes/MLNX_OFED_LINUX-23.07-0.5.1.2-ubuntu22.04-x86_64/DEBS ./ 2.\u4e0b\u8f7d\u5e76\u5b89\u88c5 Mellanox Technologies GPG-KEY wget -qO - http://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox | sudo apt-key add - 3.\u66f4\u65b0 apt-get \u7f13\u5b58 sudo apt-get update 4.\u4f7f\u7528 apt-get \u5de5\u5177\u5b89\u88c5 MLNX_OFED apt-get install mlnx-ofed-all 5.\u66f4\u65b0\u5230\u56fa\u4ef6 apt-get install mlnx-fw-updater 5.\u4f7f\u7528 mlnxofedinstall \u811a\u672c\u5b89\u88c5 /opt/mlnxofedinstall","title":"\u5b89\u88c5:"},{"location":"0.Internet/IB-ET-docs/#infinibandibethernet","text":"root@bayes:/home/lixie# mst status MST modules: ------------ MST PCI module is not loaded MST PCI configuration module loaded MST devices: ------------ /dev/mst/mt4119_pciconf0 - PCI configuration cycles access. domain:bus:dev.fn = 0000 :06:00.0 addr.reg = 88 data.reg = 92 cr_bar.gw_offset = -1 Chip revision is: 00 \u9996\u5148\uff0c\u542f\u52a8mst \u5de5\u5177\uff0c\u901a\u8fc7 mst\u5de5\u5177\u67e5\u770b\u81ea\u5df1\u7684MST devices\uff1a/dev/mst/mt4119_pciconf0 \uff08\u6ca1\u6709mst\u5de5\u5177\uff0c\u9700\u8981\u4e0b\u8f7d\u5b89\u88c5\uff09 root@bayes:/home/lixie# mlxconfig -d /dev/mst/mt4119_pciconf0 query LINK_TYPE_P1 IB(1) LINK_TYPE_P2 IB(1) \u5de5\u4f5c\u6a21\u5f0f\u4fee\u6539: Ethernet\u6a21\u5f0f\uff1a mlxconfig -d /dev/mst/mt4119_pciconf0 set LINK_TYPE_P1=2 IB\u6a21\u5f0f\uff1a mlxconfig -d /dev/mst/mt4119_pciconf0 set LINK_TYPE_P1=1 \u6e29\u99a8\u63d0\u793a \u8c03\u6574\u4e4b\u540e\uff0c\u9700\u8981\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u5668\u3002","title":"Infiniband\u5361\u5207\u6362IB/Ethernet\u6a21\u5f0f"},{"location":"0.Internet/Tcp-ip-docs/","text":"\u7f51\u7edc\u5b66\u4e60\u624b\u518c \u00b6 1.\u8ba1\u7b97\u673a\u7f51\u7edc\u53c2\u8003\u6a21\u578b\u4e0e5G\u534f\u8bae 2.\u7f51\u7edc\u5e03\u7ebf\u4e0e\u6570\u5236\u8f6c\u6362 3.\u4ea4\u6362\u673a\u57fa\u672c\u539f\u7406\u4e0e\u914d\u7f6e 4.\u7f51\u7edc\u5c42\u534f\u8bae\u4ecb\u7ecd 5.\u4f20\u8f93\u5c42\u534f\u8bae\u4ecb\u7ecd","title":"\u7f51\u7edc Tcp/IP"},{"location":"0.Internet/Tcp-ip-docs/#_1","text":"1.\u8ba1\u7b97\u673a\u7f51\u7edc\u53c2\u8003\u6a21\u578b\u4e0e5G\u534f\u8bae 2.\u7f51\u7edc\u5e03\u7ebf\u4e0e\u6570\u5236\u8f6c\u6362 3.\u4ea4\u6362\u673a\u57fa\u672c\u539f\u7406\u4e0e\u914d\u7f6e 4.\u7f51\u7edc\u5c42\u534f\u8bae\u4ecb\u7ecd 5.\u4f20\u8f93\u5c42\u534f\u8bae\u4ecb\u7ecd","title":"\u7f51\u7edc\u5b66\u4e60\u624b\u518c"},{"location":"0.Internet/ZeroTier/","text":"ZeroTier \u5185\u7f51 \u00b6 \u80cc\u666f \u00b6 \u968f\u7740\u4e92\u8054\u7f51\u7684\u666e\u53ca\uff0c\u53ef\u7528\u7684\u516c\u7f51 IPv4 \u5730\u5740\u8d8a\u6765\u8d8a\u5c11\uff0c\u73b0\u5728\u7684\u8fd0\u8425\u5546\u57fa\u672c\u4e0d\u7ed9\u5bb6\u7528\u5bbd\u5e26\u5206\u914d\u516c\u7f51 IP \u4e86\u3002\u5982\u679c\u4f60\u60f3\u901a\u8fc7\u5916\u7f51\u8bbf\u95ee\u5230\u5185\u7f51\u7684\u8d44\u6e90\uff0c\u76ee\u524d\u53ea\u80fd\u91c7\u7528\u5185\u7f51\u7a7f\u900f\u7684\u8f6f\u4ef6\u6765\u5b9e\u73b0\u3002\u5e38\u89c1\u7684\u5185\u7f51\u7a7f\u900f\u5982: frp \u8fd9\u6837\u7684\u5de5\u5177\uff0c\u4f46\u662f\u5982\u679c\u8981\u4f7f\u7528\u8fd9\u6837\u7684\u5de5\u5177\u9700\u8981\u6709\u4e00\u53f0\u5177\u5907\u516c\u7f51\u5730\u5740\u7684\u670d\u52a1\u5668\u624d\u53ef\u4ee5\u3002 \u505a\u4e3a\u4e00\u540d\u4f18\u79c0\u7684\u6280\u672f\u4eba\u5458\uff0c\u5f53\u7136\u662f\u80fd\u767d\u5ad6\u5c31\u767d\u5ad6\uff0c\u4e0b\u9762\u4e3b\u8981\u6765\u4ecb\u7ecd\u4e00\u6b3e\u4e0d\u9700\u8981\u516c\u7f51\u7684P2P\u5de5\u5177ZeroTier \u539f\u7406 \u00b6 ZeroTier \u8fd9\u4e00\u7c7b P2P VPN \u662f\u5728\u4e92\u8054\u7f51\u7684\u57fa\u7840\u4e0a\u5c06\u81ea\u5df1\u7684\u6240\u6709\u8bbe\u5907\u7ec4\u6210\u4e00\u4e2a\u79c1\u6709\u7684\u7f51\u7edc\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e92\u8054\u7f51\u8fde\u63a5\u7684\u5c40\u57df\u7f51\u3002 \u5927\u767d\u8bdd\u5c31\u662f\u4e00\u5806\u670d\u52a1\u5668\u5b89\u88c5\u4e0a\u8fd9\u4e2a\u8f6f\u4ef6\u5c31\u7ec4\u5efa\u4e86\u4e00\u4e2a\u5185\u7f51\uff0c\u5927\u5bb6\u901a\u8fc7\u8fd9\u4e2a\u7279\u5b9a\u7f51\u6bb5\u5185\u7f51\u53ef\u4ee5\u4e92\u76f8\u8bbf\u95ee\u3002 \u4f18\u70b9 \u5185\u7f51\u7a7f\u900f\u5de5\u5177\uff08\u514d\u8d39\uff09 ZeroTier \u652f\u6301 Windows\u3001macOS\u3001Linux \u4e09\u5927\u4e3b\u6d41\u5e73\u53f0\uff0ciOS\u3001Android \u4e24\u5927\u79fb\u52a8\u5e73\u53f0 \u6211\u4eec\u6b63\u5728\u9010\u6b65\u7528 Tailscale \u66ff\u6362\u6389 ZeroTier \u7f51\u7edc\uff0cZeroTier \u5c06\u4f5c\u4e3a Tailscale \u4e0d\u53ef\u7528\u65f6\u7684\u5907\u9009\u65b9\u6848 \u5b98\u7f51\u5730\u5740: https://www.zerotier.com/ \u4e0b\u8f7d\u5ba2\u6237\u7aef: https://www.zerotier.com/download/ Linux (DEB/RPM) \u00b6 curl -s https://install.zerotier.com | sudo bash macOS \u00b6 \u53ef\u9009\u62e9\u5b98\u65b9\u7684 DMG \u5b89\u88c5\uff0c\u6216\u4ece Homebrew \u8fdb\u884c\u5b89\u88c5\uff1a brew cask install zerotier-one \u6e29\u99a8\u63d0\u793a \u6211\u8fd9\u8fb9\u4e3b\u8981\u662f\u4ee5\u4f7f\u7528linux\u548cmac\u4e3a\u4e3b\uff0c\u5176\u4ed6\u5e73\u53f0\u8bf7\u76f4\u63a5\u8bbf\u95ee\u4e0a\u65b9\u7684 Zerotier \u5b98\u7f51\u8fdb\u884c\u4e0b\u8f7d \u5b89\u88c5 \u00b6 \u64cd\u4f5c\u6b65\u9aa4 Linux\u6216\u8005Mac\u5b89\u88c5zerotier \u52a0\u5165\u5230zerotier\u7f51\u7edc zerotier\u7684UI\u754c\u9762\u52fe\u9009\u521a\u521a\u6dfb\u52a0\u7684\u8282\u70b9 \u5b89\u88c5: \u53c2\u8003\u5b98\u7f51 curl -s https://install.zerotier.com | sudo bash \u8282\u70b9\u52a0\u5165zerotier\u7f51\u7edc\uff0c\u52a0\u5165\u7f51\u7edc\u4e4b\u524d\u9700\u8981\u63d0\u524d\u521b\u5efa\u8fd9\u4e2a\u7f51\u7edc root@user:/home/user# zerotier-cli join b15644912ebd050d 200 join OK \u767b\u9646\u81ea\u5df1\u7684zerotier\u5e10\u53f7\uff0c\u52fe\u9009\u5141\u8bb8\u5bf9\u5e94\u673a\u5668\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u91cc\u63a8\u8350\u4f7f\u7528github\u5e10\u53f7\u3002","title":"ZeroTier\u7ec4\u7f51"},{"location":"0.Internet/ZeroTier/#zerotier","text":"","title":"ZeroTier \u5185\u7f51"},{"location":"0.Internet/ZeroTier/#_1","text":"\u968f\u7740\u4e92\u8054\u7f51\u7684\u666e\u53ca\uff0c\u53ef\u7528\u7684\u516c\u7f51 IPv4 \u5730\u5740\u8d8a\u6765\u8d8a\u5c11\uff0c\u73b0\u5728\u7684\u8fd0\u8425\u5546\u57fa\u672c\u4e0d\u7ed9\u5bb6\u7528\u5bbd\u5e26\u5206\u914d\u516c\u7f51 IP \u4e86\u3002\u5982\u679c\u4f60\u60f3\u901a\u8fc7\u5916\u7f51\u8bbf\u95ee\u5230\u5185\u7f51\u7684\u8d44\u6e90\uff0c\u76ee\u524d\u53ea\u80fd\u91c7\u7528\u5185\u7f51\u7a7f\u900f\u7684\u8f6f\u4ef6\u6765\u5b9e\u73b0\u3002\u5e38\u89c1\u7684\u5185\u7f51\u7a7f\u900f\u5982: frp \u8fd9\u6837\u7684\u5de5\u5177\uff0c\u4f46\u662f\u5982\u679c\u8981\u4f7f\u7528\u8fd9\u6837\u7684\u5de5\u5177\u9700\u8981\u6709\u4e00\u53f0\u5177\u5907\u516c\u7f51\u5730\u5740\u7684\u670d\u52a1\u5668\u624d\u53ef\u4ee5\u3002 \u505a\u4e3a\u4e00\u540d\u4f18\u79c0\u7684\u6280\u672f\u4eba\u5458\uff0c\u5f53\u7136\u662f\u80fd\u767d\u5ad6\u5c31\u767d\u5ad6\uff0c\u4e0b\u9762\u4e3b\u8981\u6765\u4ecb\u7ecd\u4e00\u6b3e\u4e0d\u9700\u8981\u516c\u7f51\u7684P2P\u5de5\u5177ZeroTier","title":"\u80cc\u666f"},{"location":"0.Internet/ZeroTier/#_2","text":"ZeroTier \u8fd9\u4e00\u7c7b P2P VPN \u662f\u5728\u4e92\u8054\u7f51\u7684\u57fa\u7840\u4e0a\u5c06\u81ea\u5df1\u7684\u6240\u6709\u8bbe\u5907\u7ec4\u6210\u4e00\u4e2a\u79c1\u6709\u7684\u7f51\u7edc\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e92\u8054\u7f51\u8fde\u63a5\u7684\u5c40\u57df\u7f51\u3002 \u5927\u767d\u8bdd\u5c31\u662f\u4e00\u5806\u670d\u52a1\u5668\u5b89\u88c5\u4e0a\u8fd9\u4e2a\u8f6f\u4ef6\u5c31\u7ec4\u5efa\u4e86\u4e00\u4e2a\u5185\u7f51\uff0c\u5927\u5bb6\u901a\u8fc7\u8fd9\u4e2a\u7279\u5b9a\u7f51\u6bb5\u5185\u7f51\u53ef\u4ee5\u4e92\u76f8\u8bbf\u95ee\u3002 \u4f18\u70b9 \u5185\u7f51\u7a7f\u900f\u5de5\u5177\uff08\u514d\u8d39\uff09 ZeroTier \u652f\u6301 Windows\u3001macOS\u3001Linux \u4e09\u5927\u4e3b\u6d41\u5e73\u53f0\uff0ciOS\u3001Android \u4e24\u5927\u79fb\u52a8\u5e73\u53f0 \u6211\u4eec\u6b63\u5728\u9010\u6b65\u7528 Tailscale \u66ff\u6362\u6389 ZeroTier \u7f51\u7edc\uff0cZeroTier \u5c06\u4f5c\u4e3a Tailscale \u4e0d\u53ef\u7528\u65f6\u7684\u5907\u9009\u65b9\u6848 \u5b98\u7f51\u5730\u5740: https://www.zerotier.com/ \u4e0b\u8f7d\u5ba2\u6237\u7aef: https://www.zerotier.com/download/","title":"\u539f\u7406"},{"location":"0.Internet/ZeroTier/#linux-debrpm","text":"curl -s https://install.zerotier.com | sudo bash","title":"Linux (DEB/RPM)"},{"location":"0.Internet/ZeroTier/#macos","text":"\u53ef\u9009\u62e9\u5b98\u65b9\u7684 DMG \u5b89\u88c5\uff0c\u6216\u4ece Homebrew \u8fdb\u884c\u5b89\u88c5\uff1a brew cask install zerotier-one \u6e29\u99a8\u63d0\u793a \u6211\u8fd9\u8fb9\u4e3b\u8981\u662f\u4ee5\u4f7f\u7528linux\u548cmac\u4e3a\u4e3b\uff0c\u5176\u4ed6\u5e73\u53f0\u8bf7\u76f4\u63a5\u8bbf\u95ee\u4e0a\u65b9\u7684 Zerotier \u5b98\u7f51\u8fdb\u884c\u4e0b\u8f7d","title":"macOS"},{"location":"0.Internet/ZeroTier/#_3","text":"\u64cd\u4f5c\u6b65\u9aa4 Linux\u6216\u8005Mac\u5b89\u88c5zerotier \u52a0\u5165\u5230zerotier\u7f51\u7edc zerotier\u7684UI\u754c\u9762\u52fe\u9009\u521a\u521a\u6dfb\u52a0\u7684\u8282\u70b9 \u5b89\u88c5: \u53c2\u8003\u5b98\u7f51 curl -s https://install.zerotier.com | sudo bash \u8282\u70b9\u52a0\u5165zerotier\u7f51\u7edc\uff0c\u52a0\u5165\u7f51\u7edc\u4e4b\u524d\u9700\u8981\u63d0\u524d\u521b\u5efa\u8fd9\u4e2a\u7f51\u7edc root@user:/home/user# zerotier-cli join b15644912ebd050d 200 join OK \u767b\u9646\u81ea\u5df1\u7684zerotier\u5e10\u53f7\uff0c\u52fe\u9009\u5141\u8bb8\u5bf9\u5e94\u673a\u5668\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u91cc\u63a8\u8350\u4f7f\u7528github\u5e10\u53f7\u3002","title":"\u5b89\u88c5"},{"location":"0.Internet/frp/","text":"\u4e00\u3001\u5185\u7f51\u7a7f\u900fFrp\uff1a \u00b6 \u4e0b\u8f7d\u5730\u5740\uff1a https://github.com/fatedier/frp/releases 1.1\u3001\u6982\u8ff0\uff1a \u00b6 1.1.1\uff1afrp\u5185\u7f51\u7a7f\u900f\u5de5\u5177\uff1a \u00b6 \u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u53cd\u5411\u4ee3\u7406\u5e94\u7528\uff0c\u53ef\u4ee5\u5e2e\u52a9\u60a8\u8f7b\u677e\u5730\u8fdb\u884c\u5185\u7f51\u7a7f\u900f\uff0c\u5bf9\u5916\u7f51\u63d0\u4f9b\u670d\u52a1\uff0c\u652f\u6301 tcp, http, https \u7b49\u534f\u8bae\u7c7b\u578b\uff0c\u5e76\u4e14 web \u670d\u52a1\u652f\u6301\u6839\u636e\u57df\u540d\u8fdb\u884c\u8def\u7531\u8f6c\u53d1\u3002 1.1.2\uff1afrp\u7684\u4f5c\u7528\uff1a \u00b6 \u5229\u7528\u5904\u4e8e\u5185\u7f51\u6216\u9632\u706b\u5899\u540e\u7684\u673a\u5668\uff0c\u5bf9\u5916\u7f51\u73af\u5883\u63d0\u4f9b http \u6216 https \u670d\u52a1\u3002 \u5bf9\u4e8e http \u670d\u52a1\u652f\u6301\u57fa\u4e8e\u57df\u540d\u7684\u865a\u62df\u4e3b\u673a\uff0c\u652f\u6301\u81ea\u5b9a\u4e49\u57df\u540d\u7ed1\u5b9a\uff0c\u4f7f\u591a\u4e2a\u57df\u540d\u53ef\u4ee5\u5171\u7528\u4e00\u4e2a80\u7aef\u53e3\u3002 \u5229\u7528\u5904\u4e8e\u5185\u7f51\u6216\u9632\u706b\u5899\u540e\u7684\u673a\u5668\uff0c\u5bf9\u5916\u7f51\u73af\u5883\u63d0\u4f9b tcp \u670d\u52a1\uff0c\u4f8b\u5982\u5728\u5bb6\u91cc\u901a\u8fc7 ssh \u8bbf\u95ee\u5904\u4e8e\u516c\u53f8\u5185\u7f51\u73af\u5883\u5185\u7684\u4e3b\u673a\u3002 \u53ef\u67e5\u770b\u901a\u8fc7\u4ee3\u7406\u7684\u6240\u6709 http \u8bf7\u6c42\u548c\u54cd\u5e94\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\uff08\u5f85\u5f00\u53d1\uff09 2.1\u3001\u9879\u76ee\u601d\u8def\u53ca\u91cd\u96be\u70b9\u5185\u5bb9 \u00b6 \u6e29\u99a8\u63d0\u793a \u4ee5\u4e0b\u6b65\u9aa4\u53ea\u9488\u5bf9\u9488\u5bf9\u4e8ecentos \u64cd\u4f5c\u7cfb\u7edf 2.1.1\uff1a\u9879\u76ee\u62d3\u6251\u56fe\uff1a \u00b6 2.1.2\uff1a\u5b9e\u9a8c\u601d\u8def\uff1a \u00b6 \u7b2c\u4e00\u6b65 \u8d2d\u4e70\u4e00\u53f0\u4e91\u670d\u52a1\u5668\u4f5c\u4e3afrp-server\u7aef\uff0c\u4e3b\u8981\u662f\u9700\u8981\u4e00\u4e2a\u56fa\u5b9a\u516c\u7f51\u5730\u5740\uff0c\u5982\u679c\u516c\u53f8\u6709\u56fa\u5b9a\u516c\u7f51\u5730\u5740\u6700\u597d \u7b2c\u4e8c\u6b65 \u5728\u516c\u53f8\u6216\u8005\u5185\u7f51\u51c6\u5907\u4e00\u53f0\u4e3b\u673a\u4f5c\u4e3afrp-client\u7aef \u7b2c\u4e09\u6b65 \u5728\u516c\u53f8\u6216\u8005\u5185\u7f51\u51c6\u5907\u4e00\u53f0\u4e3b\u673a\u6765\u90e8\u7f72vpn \u7b2c\u56db\u6b65 \u5229\u7528\u7a7f\u900f\u6765\u5b9e\u73b0\u8fde\u63a5VPN 2.1.3\uff1afrp\u914d\u7f6e\u6587\u4ef6\u8bf4\u660e\uff1a \u00b6 [ root@localhost frpc ] # ll \u603b\u7528\u91cf 21136 -rwxr-xr-x 1 root root 10466752 8\u6708 18 2021 frpc -rw-r--r-- 1 root root 6818 8\u6708 18 2021 frpc_full.ini -rw-r--r-- 1 root root 283 5\u6708 2 23 :35 frpc.ini -rwxr-xr-x 1 root root 11133376 8\u6708 18 2021 frps -rw-r--r-- 1 root root 2199 8\u6708 18 2021 frps_full.ini -rw-r--r-- 1 root root 26 8\u6708 18 2021 frps.ini -rw-r--r-- 1 root root 11358 8\u6708 18 2021 LICENSE -rw-r--r-- 1 root root 21 8\u6708 18 2021 run.sh drwxrwxr-x 2 root root 88 8\u6708 18 2021 systemd \u6587\u4ef6\u8bf4\u660e\uff1a frpc # \u5ba2\u6237\u7aef\u4e8c\u8fdb\u5236\u6587\u4ef6 frpc_full.ini # \u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6\u5b8c\u6574\u793a\u4f8b frpc.ini # \u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6 frps # \u670d\u52a1\u7aef\u4e8c\u8fdb\u5236\u6587\u4ef6 frps_full.ini # \u670d\u52a1\u7aef\u914d\u7f6e\u6587\u4ef6\u5b8c\u6574\u793a\u4f8b frps.in1 # \u670d\u52a1\u7aef\u914d\u7f6e\u6587\u4ef6 3.1\u3001Frp\u90e8\u7f72\uff1a \u00b6 3.1.1\uff1a\u90e8\u7f72frps\uff1a \u00b6 \u6ce8\u91ca\uff1a\u4e00\u822cfrps \u662f\u516c\u7f51\u4e0a\u7684\u4e00\u53f0\u4e91\u670d\u52a1\u5668\uff0c\u8fd9\u91cc\u53ef\u4ee5\u662f\u4efb\u610f\u7684\u4e91\u5e73\u53f0\uff0c\u6ce8\u610f\u4e00\u5b9a\u8bb0\u5f97\u5f00\u5b89\u5168\u7ec4\uff01\uff01\uff01 [ root@VM-16-9-centos frps ] # cat frps.ini [ common ] bind_port = 50070 vhost_http_port = 50080 vhost_https_port = 50443 token = $pF @7zz^LDuh7^xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx \u8fd9\u4e2atoken\u662f\u7528\u4e8e\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u8fde\u63a5 # \u542f\u52a8 ./frps -c ./frps.ini 3.1.2\uff1a\u90e8\u7f72frpc\uff1a \u00b6 [ root@moban frp_0.38.0_linux_amd64 ] # cat frpc.ini [ common ] server_addr = 115 .29.189.57 # server_addr\u8868\u793a\u4e0efrps\u8fde\u63a5\u7684\u5730\u5740 server_port = 50081 # \u4e0efrps\u8fde\u63a5\u7684\u7aef\u53e3 token = pass@word1 # \u914d\u7f6etoken\u7528\u6765\u9a8c\u8bc1 [ openvpn ] type = udp local_ip = 192 .168.8.82 local_port = 51194 remote_port = 51194 # remote_port\u8868\u793a\u7528\u6237\u8bbf\u95ee\u516c\u7f51\u5730\u5740+\u7aef\u53e3,\u5c31\u53cd\u5411\u4ee3\u7406\u5230local_ip+\u7aef\u53e3 # \u542f\u52a8 ./frps -c ./frps.ini 3.1.3\uff1anj\u5730\u533a\uff1a192.165.0.20 \u00b6 [ root@moban frp_0.26.0_linux_amd64 ] # cat frpc.ini [ common ] tls_enable = true server_addr = 39 .104.160.84 server_port = 50070 token = $pF @xxxxxx [ openvpn-nj ] type = udp local_ip = 192 .165.0.21 local_port = 31194 remote_port = 31194 [ root@moban frp_0.26.0_linux_amd64 ] # cat frp.sh ./frpc -c ./frpc.ini 3.1.4\uff1abj\u5730\u533a\uff1a \u00b6 [ root@frp-40 frpc ] # cat frpc.ini [ common ] tls_enable = true server_addr = 39 .104.160.84 server_port = 50070 token = $pF @7zz^LDuh7^X0Uxxxxx 4.1\u3001vpn\u90e8\u7f72\uff1a \u00b6 4.4.1\uff1avpn\u90e8\u7f72\u811a\u672c\uff1a \u00b6 #!/bin/bash # \u642d\u5efavpenvpn\u811a\u672c # \u4f5c\u8005:lixie # \u65e5\u671f:2021-10-19 # openvpn\u662f\u670d\u52a1\u7aef,easy-rsa\u662f\u8bc1\u4e66\u7ba1\u7406\u5de5\u5177 yum -y install wget mkdir -p /etc/yum.repos.d/backup mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/ wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo yum -y install openvpn easy-rsa & > /dev/null # \u83b7\u53d6openvpn\u548ceasy-rsa\u7684\u7248\u672c OPENVER = $( rpm -qi openvpn | awk -F \": \" 'NR==2{print $2}' ) EASYVER = $( rpm -qi easy-rsa | awk -F \": \" 'NR==2{print $2}' ) #echo \"openvpn-$OPENVER\" #echo \"easy-rsa-$EASYVER\" #\u751f\u6210\u670d\u52a1\u5668\u914d\u7f6e\u6587\u4ef6 #cp /usr/share/doc/openvpn-$OPENVER/sample/sample-config-files/server.conf /etc/openvpn/ cat << EOF >> /etc/openvpn/server/server.conf local 0.0.0.0 port 41194 proto udp dev tun ca /etc/openvpn/certs/ca.crt cert /etc/openvpn/certs/server.crt dh /etc/openvpn/certs/dh.pem push \"route 192.168.0.0 255.255.0.0\" server 10.10.0.0 255.255.255.0 ifconfig-pool-persist /var/log/openvpn/ipp.txt client-to-client keepalive 10 120 comp-lzo max-clients 100 persist-key persist-tun status /var/log/openvpn/openvpn-status.log log-append /var/log/openvpn/openvpn.log verb 3 key /etc/openvpn/certs/server.key cipher AES-256-CBC client-config-dir /etc/openvpn/ccd auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env username-as-common-name script-security 3 verify-client-cert none EOF # \u6ce8\u610f\uff01\uff01\uff01 \u8fd9\u91cc\u521b\u5efa\u5b8c\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u9700\u8981\u505a\u4e2a\u914d\u7f6e\u6587\u4ef6\u7684\u8f6f\u8fde\u63a5\uff0c\u56e0\u4e3a\u5f53\u524d\u7248\u672c\u7684 openvpn systemd \u542f\u52a8\u6587\u4ef6\u4e2d\u8bfb\u53d6\u7684\u662f.service.conf\u914d\u7f6e cd /etc/openvpn/server/ && ln -sf server.conf .service.conf #\u51c6\u5907\u8bc1\u4e66\u7b7e\u53d1\u76f8\u5173\u6587\u4ef6 cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server #\u51c6\u5907\u7b7e\u53d1\u8bc1\u4e66\u76f8\u5173\u53d8\u91cf\u7684\u914d\u7f6e\u6587\u4ef6 cp /usr/share/doc/easy-rsa- $EASYVER /vars.example /etc/openvpn/easy-rsa-server/3/vars #CA\u7684\u8bc1\u4e66\u6709\u6548\u671f\u9ed8\u4e3a\u4e3a10\u5e74,\u53ef\u4ee5\u9002\u5f53\u5ef6\u957f,\u6bd4\u5982:36500\u5929 sed -i '/3650/ s/3650/36500/g' /etc/openvpn/easy-rsa-server/3/vars #\u670d\u52a1\u5668\u8bc1\u4e66\u9ed8\u4e3a\u4e3a825\u5929 sed -i '/825/ s/825/82500/g' /etc/openvpn/easy-rsa-server/3/vars \u521d\u59cb\u5316\u6570\u636e,\u5728\u5f53\u524d\u76ee\u5f55\u4e0b\u751f\u6210pki\u76ee\u5f55\u53ca\u76f8\u5173\u6587\u4ef6 cd /etc/openvpn/easy-rsa-server/3/ pwd ./easyrsa init-pki \u521b\u5efaCA\u673a\u6784 cd /etc/openvpn/easy-rsa-server/3 ./easyrsa build-ca nopass <<EOF EOF # \u521b\u5efa\u670d\u52a1\u7aef\u8bc1\u4e66\u7533\u8bf7 cd /etc/openvpn/easy-rsa-server/3 ./easyrsa gen-req server nopass <<EOF EOF ## \u9881\u53d1\u670d\u52a1\u7aef\u8bc1\u4e66 # cd /etc/openvpn/easy-rsa-server/3 ./easyrsa sign server server <<EOF yes EOF # \u521b\u5efa Diffie-Hellman \u5bc6\u94a5,\u8fd9\u4e2a\u6b65\u9aa4\u5b8c\u4e86\u670d\u52a1\u5668\u90e8\u5206\u5c31\u5b8c\u6210\u4e86 cd /etc/openvpn/easy-rsa-server/3 ./easyrsa gen-dh #\u4e3a\u5ba2\u6237\u7aef\u51c6\u5907\u8bc1\u4e66\u73af\u5883 cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client cp /usr/share/doc/easy-rsa- $EASYVER /vars.example /etc/openvpn/easy-rsa-client/3/vars cd /etc/openvpn/easy-rsa-client/3/ ./easyrsa init-pki # \u5c06CA\u548c\u670d\u52a1\u5668\u8bc1\u4e66\u76f8\u5173\u6587\u4ef6\u590d\u5236\u5230\u670d\u52a1\u5668\u76f8\u5e94\u7684\u76ee\u5f55 mkdir /etc/openvpn/certs cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/ cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/ cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/ cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/ # \u4fee\u6539\u670d\u52a1\u5668\u7aef\u914d\u7f6e\u6587\u4ef6 # \u521b\u5efa\u65e5\u5fd7\u76ee\u5f55 mkdir /etc/openvpn/ccd mkdir /var/log/openvpn chown openvpn.openvpn /var/log/openvpn cat <<EOF>> /etc/openvpn/psw-file LIXIE ABC123, EOF chmod 600 /etc/openvpn/psw-file chown openvpn:openvpn /etc/openvpn/psw-file chmod +x /etc/openvpn/checkpsw.sh chown -R openvpn:openvpn /etc/openvpn/ #\u5728\u670d\u52a1\u5668\u5f00\u542fip_forward\u8f6c\u53d1\u529f\u80fd echo net.ipv4.ip_forward = 1 >> /etc/sysctl.conf && sysctl -p & > /dev/null echo 'iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -j MASQUERADE' >> /etc/rc.d/rc.local chmod +x /etc/rc.d/rc.local /etc/rc.d/rc.local systemctl daemon-reload systemctl start openvpn-server@.service.service systemctl enable openvpn-server@.service.service 4.4.2\uff1a\u65b0\u589e\u7528\u6237\u811a\u672c\uff1a \u00b6 cat <<EOF>> /etc/openvpn/checkpsw.sh #!/bin/sh ########################################################### # checkpsw.sh (C) 2004 Mathias Sundman <mathias@openvpn.se> # # This script will authenticate OpenVPN users against # a plain text file. The passfile should simply contain # one row per user with the username first followed by # one or more space(s) or tab(s) and then the password. PASSFILE=\"/etc/openvpn/psw-file\" LOG_FILE=\"/var/log/openvpn/password.log\" TIME_STAMP=`date \"+%Y-%m-%d %T\"` ########################################################### if [ ! -r \"${PASSFILE}\" ]; then echo \"${TIME_STAMP}: Could not open password file \\\"${PASSFILE}\\\" for reading.\" >> ${LOG_FILE} exit 1 fi CORRECT_PASSWORD=`awk '!/^;/&&!/^#/&&$1==\"'${username}'\"{print $2;exit}' ${PASSFILE}` if [ \"${CORRECT_PASSWORD}\" = \"\" ]; then echo \"${TIME_STAMP}: User does not exist: username=\\\"${username}\\\", password= \\\"${password}\\\".\" >> ${LOG_FILE} exit 1 fi if [ \"${password}\" = \"${CORRECT_PASSWORD}\" ]; then echo \"${TIME_STAMP}: Successful authentication: username=\\\"${username}\\\".\" >> ${LOG_FILE} exit 0 fi echo \"${TIME_STAMP}: Incorrect password: username=\\\"${username}\\\", password= \\\"${password}\\\".\" >> ${LOG_FILE} exit 1 EOF \u6ce8\u610f\uff1a\u9700\u8981\u7ed9\u8fd9\u4e2a\u811a\u672c\u4e00\u4e2a\u6267\u884c\u6743\u9650 4.4.3\uff1a\u90e8\u7f72iptables\uff1a \u00b6 \u9632\u706b\u5899\u914d\u7f6e\uff08firewalld\u914d\u7f6e\u6216\u8005iptables\u914d\u7f6e\u9009\u4e00\u4e2a\uff09 # firewalld\u914d\u7f6e firewall-cmd --permanent --add-masquerade firewall-cmd --permanent --add-service = openvpn # \u6216\u8005\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7aef\u53e3 # firewall-cmd --permanent --add-port=1194/tcp firewall-cmd --permanent --direct --passthrough ipv4 -t nat -A POSTROUTING -s 10 .8.0.0/24 -o eth0 -j MASQUERADE firewall-cmd --reload # iptables \uff08\u548c\u4e0a\u9762\u7684\u7f51\u6bb5\u914d\u7f6e\u4e0d\u540c\uff0c\u4fee\u6539\u4e0b\u9762\u7684\u7f51\u6bb5\u5373\u53ef\uff09 yum install iptables-services systemctl enable iptables iptables -X iptables -F iptables -Z iptables -P INPUT ACCEPT iptables -P OUTPUT ACCEPT iptables -P FORWARD ACCEPT service iptables save iptables -t nat -A POSTROUTING -s 10 .10.0.0/255.255.255.0 -o eth0 -j MASQUERADE iptables -A FORWARD -s 10 .10.0.0/24 -d 192 .168.0.0/24 -i tun0 -j ACCEPT iptables -A FORWARD -s 192 .168.0.0/24 -d 10 .10.0.0/24 -i eth0 -j ACCEPT service iptables save 4.4.4\uff1a\u51c6\u5907\u5ba2\u6237\u7aef\u8bc1\u4e66\uff1a \u00b6 \u5907\u6ce8\uff1a\u5b89\u88c5openvpn\u5ba2\u6237\u7aef\u8f6f\u4ef6\uff1aconfig\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0ca\u8bc1\u4e66\u548c.opvn client dev tun proto udp # \u516c\u7f51ip\u9700\u8981\u4fee\u6539 remote \u516c\u7f51\u5730\u5740 41194 resolv-retry infinite nobind persist-key persist-tun ca ca.crt comp-lzo verb 3 cipher AES-256-CBC auth-user-pass 5.1\uff1a\u5176\u4ed6\u6848\u4f8b\u914d\u7f6e\uff1a \u00b6 \u9644\u4ef6\uff1a \u00b6 \u5b66\u4e60\u535a\u5ba2\uff1a https://www.jianshu.com/p/09603d9e0b6c","title":"frp \u5185\u7f51\u7a7f\u900f"},{"location":"0.Internet/frp/#frp","text":"\u4e0b\u8f7d\u5730\u5740\uff1a https://github.com/fatedier/frp/releases","title":"\u4e00\u3001\u5185\u7f51\u7a7f\u900fFrp\uff1a"},{"location":"0.Internet/frp/#11","text":"","title":"1.1\u3001\u6982\u8ff0\uff1a"},{"location":"0.Internet/frp/#111frp","text":"\u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u53cd\u5411\u4ee3\u7406\u5e94\u7528\uff0c\u53ef\u4ee5\u5e2e\u52a9\u60a8\u8f7b\u677e\u5730\u8fdb\u884c\u5185\u7f51\u7a7f\u900f\uff0c\u5bf9\u5916\u7f51\u63d0\u4f9b\u670d\u52a1\uff0c\u652f\u6301 tcp, http, https \u7b49\u534f\u8bae\u7c7b\u578b\uff0c\u5e76\u4e14 web \u670d\u52a1\u652f\u6301\u6839\u636e\u57df\u540d\u8fdb\u884c\u8def\u7531\u8f6c\u53d1\u3002","title":"1.1.1\uff1afrp\u5185\u7f51\u7a7f\u900f\u5de5\u5177\uff1a"},{"location":"0.Internet/frp/#112frp","text":"\u5229\u7528\u5904\u4e8e\u5185\u7f51\u6216\u9632\u706b\u5899\u540e\u7684\u673a\u5668\uff0c\u5bf9\u5916\u7f51\u73af\u5883\u63d0\u4f9b http \u6216 https \u670d\u52a1\u3002 \u5bf9\u4e8e http \u670d\u52a1\u652f\u6301\u57fa\u4e8e\u57df\u540d\u7684\u865a\u62df\u4e3b\u673a\uff0c\u652f\u6301\u81ea\u5b9a\u4e49\u57df\u540d\u7ed1\u5b9a\uff0c\u4f7f\u591a\u4e2a\u57df\u540d\u53ef\u4ee5\u5171\u7528\u4e00\u4e2a80\u7aef\u53e3\u3002 \u5229\u7528\u5904\u4e8e\u5185\u7f51\u6216\u9632\u706b\u5899\u540e\u7684\u673a\u5668\uff0c\u5bf9\u5916\u7f51\u73af\u5883\u63d0\u4f9b tcp \u670d\u52a1\uff0c\u4f8b\u5982\u5728\u5bb6\u91cc\u901a\u8fc7 ssh \u8bbf\u95ee\u5904\u4e8e\u516c\u53f8\u5185\u7f51\u73af\u5883\u5185\u7684\u4e3b\u673a\u3002 \u53ef\u67e5\u770b\u901a\u8fc7\u4ee3\u7406\u7684\u6240\u6709 http \u8bf7\u6c42\u548c\u54cd\u5e94\u7684\u8be6\u7ec6\u4fe1\u606f\u3002\uff08\u5f85\u5f00\u53d1\uff09","title":"1.1.2\uff1afrp\u7684\u4f5c\u7528\uff1a"},{"location":"0.Internet/frp/#21","text":"\u6e29\u99a8\u63d0\u793a \u4ee5\u4e0b\u6b65\u9aa4\u53ea\u9488\u5bf9\u9488\u5bf9\u4e8ecentos \u64cd\u4f5c\u7cfb\u7edf","title":"2.1\u3001\u9879\u76ee\u601d\u8def\u53ca\u91cd\u96be\u70b9\u5185\u5bb9"},{"location":"0.Internet/frp/#211","text":"","title":"2.1.1\uff1a\u9879\u76ee\u62d3\u6251\u56fe\uff1a"},{"location":"0.Internet/frp/#212","text":"\u7b2c\u4e00\u6b65 \u8d2d\u4e70\u4e00\u53f0\u4e91\u670d\u52a1\u5668\u4f5c\u4e3afrp-server\u7aef\uff0c\u4e3b\u8981\u662f\u9700\u8981\u4e00\u4e2a\u56fa\u5b9a\u516c\u7f51\u5730\u5740\uff0c\u5982\u679c\u516c\u53f8\u6709\u56fa\u5b9a\u516c\u7f51\u5730\u5740\u6700\u597d \u7b2c\u4e8c\u6b65 \u5728\u516c\u53f8\u6216\u8005\u5185\u7f51\u51c6\u5907\u4e00\u53f0\u4e3b\u673a\u4f5c\u4e3afrp-client\u7aef \u7b2c\u4e09\u6b65 \u5728\u516c\u53f8\u6216\u8005\u5185\u7f51\u51c6\u5907\u4e00\u53f0\u4e3b\u673a\u6765\u90e8\u7f72vpn \u7b2c\u56db\u6b65 \u5229\u7528\u7a7f\u900f\u6765\u5b9e\u73b0\u8fde\u63a5VPN","title":"2.1.2\uff1a\u5b9e\u9a8c\u601d\u8def\uff1a"},{"location":"0.Internet/frp/#213frp","text":"[ root@localhost frpc ] # ll \u603b\u7528\u91cf 21136 -rwxr-xr-x 1 root root 10466752 8\u6708 18 2021 frpc -rw-r--r-- 1 root root 6818 8\u6708 18 2021 frpc_full.ini -rw-r--r-- 1 root root 283 5\u6708 2 23 :35 frpc.ini -rwxr-xr-x 1 root root 11133376 8\u6708 18 2021 frps -rw-r--r-- 1 root root 2199 8\u6708 18 2021 frps_full.ini -rw-r--r-- 1 root root 26 8\u6708 18 2021 frps.ini -rw-r--r-- 1 root root 11358 8\u6708 18 2021 LICENSE -rw-r--r-- 1 root root 21 8\u6708 18 2021 run.sh drwxrwxr-x 2 root root 88 8\u6708 18 2021 systemd \u6587\u4ef6\u8bf4\u660e\uff1a frpc # \u5ba2\u6237\u7aef\u4e8c\u8fdb\u5236\u6587\u4ef6 frpc_full.ini # \u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6\u5b8c\u6574\u793a\u4f8b frpc.ini # \u5ba2\u6237\u7aef\u914d\u7f6e\u6587\u4ef6 frps # \u670d\u52a1\u7aef\u4e8c\u8fdb\u5236\u6587\u4ef6 frps_full.ini # \u670d\u52a1\u7aef\u914d\u7f6e\u6587\u4ef6\u5b8c\u6574\u793a\u4f8b frps.in1 # \u670d\u52a1\u7aef\u914d\u7f6e\u6587\u4ef6","title":"2.1.3\uff1afrp\u914d\u7f6e\u6587\u4ef6\u8bf4\u660e\uff1a"},{"location":"0.Internet/frp/#31frp","text":"","title":"3.1\u3001Frp\u90e8\u7f72\uff1a"},{"location":"0.Internet/frp/#311frps","text":"\u6ce8\u91ca\uff1a\u4e00\u822cfrps \u662f\u516c\u7f51\u4e0a\u7684\u4e00\u53f0\u4e91\u670d\u52a1\u5668\uff0c\u8fd9\u91cc\u53ef\u4ee5\u662f\u4efb\u610f\u7684\u4e91\u5e73\u53f0\uff0c\u6ce8\u610f\u4e00\u5b9a\u8bb0\u5f97\u5f00\u5b89\u5168\u7ec4\uff01\uff01\uff01 [ root@VM-16-9-centos frps ] # cat frps.ini [ common ] bind_port = 50070 vhost_http_port = 50080 vhost_https_port = 50443 token = $pF @7zz^LDuh7^xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx \u8fd9\u4e2atoken\u662f\u7528\u4e8e\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u8fde\u63a5 # \u542f\u52a8 ./frps -c ./frps.ini","title":"3.1.1\uff1a\u90e8\u7f72frps\uff1a"},{"location":"0.Internet/frp/#312frpc","text":"[ root@moban frp_0.38.0_linux_amd64 ] # cat frpc.ini [ common ] server_addr = 115 .29.189.57 # server_addr\u8868\u793a\u4e0efrps\u8fde\u63a5\u7684\u5730\u5740 server_port = 50081 # \u4e0efrps\u8fde\u63a5\u7684\u7aef\u53e3 token = pass@word1 # \u914d\u7f6etoken\u7528\u6765\u9a8c\u8bc1 [ openvpn ] type = udp local_ip = 192 .168.8.82 local_port = 51194 remote_port = 51194 # remote_port\u8868\u793a\u7528\u6237\u8bbf\u95ee\u516c\u7f51\u5730\u5740+\u7aef\u53e3,\u5c31\u53cd\u5411\u4ee3\u7406\u5230local_ip+\u7aef\u53e3 # \u542f\u52a8 ./frps -c ./frps.ini","title":"3.1.2\uff1a\u90e8\u7f72frpc\uff1a"},{"location":"0.Internet/frp/#313nj192165020","text":"[ root@moban frp_0.26.0_linux_amd64 ] # cat frpc.ini [ common ] tls_enable = true server_addr = 39 .104.160.84 server_port = 50070 token = $pF @xxxxxx [ openvpn-nj ] type = udp local_ip = 192 .165.0.21 local_port = 31194 remote_port = 31194 [ root@moban frp_0.26.0_linux_amd64 ] # cat frp.sh ./frpc -c ./frpc.ini","title":"3.1.3\uff1anj\u5730\u533a\uff1a192.165.0.20"},{"location":"0.Internet/frp/#314bj","text":"[ root@frp-40 frpc ] # cat frpc.ini [ common ] tls_enable = true server_addr = 39 .104.160.84 server_port = 50070 token = $pF @7zz^LDuh7^X0Uxxxxx","title":"3.1.4\uff1abj\u5730\u533a\uff1a"},{"location":"0.Internet/frp/#41vpn","text":"","title":"4.1\u3001vpn\u90e8\u7f72\uff1a"},{"location":"0.Internet/frp/#441vpn","text":"#!/bin/bash # \u642d\u5efavpenvpn\u811a\u672c # \u4f5c\u8005:lixie # \u65e5\u671f:2021-10-19 # openvpn\u662f\u670d\u52a1\u7aef,easy-rsa\u662f\u8bc1\u4e66\u7ba1\u7406\u5de5\u5177 yum -y install wget mkdir -p /etc/yum.repos.d/backup mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/ wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo yum -y install openvpn easy-rsa & > /dev/null # \u83b7\u53d6openvpn\u548ceasy-rsa\u7684\u7248\u672c OPENVER = $( rpm -qi openvpn | awk -F \": \" 'NR==2{print $2}' ) EASYVER = $( rpm -qi easy-rsa | awk -F \": \" 'NR==2{print $2}' ) #echo \"openvpn-$OPENVER\" #echo \"easy-rsa-$EASYVER\" #\u751f\u6210\u670d\u52a1\u5668\u914d\u7f6e\u6587\u4ef6 #cp /usr/share/doc/openvpn-$OPENVER/sample/sample-config-files/server.conf /etc/openvpn/ cat << EOF >> /etc/openvpn/server/server.conf local 0.0.0.0 port 41194 proto udp dev tun ca /etc/openvpn/certs/ca.crt cert /etc/openvpn/certs/server.crt dh /etc/openvpn/certs/dh.pem push \"route 192.168.0.0 255.255.0.0\" server 10.10.0.0 255.255.255.0 ifconfig-pool-persist /var/log/openvpn/ipp.txt client-to-client keepalive 10 120 comp-lzo max-clients 100 persist-key persist-tun status /var/log/openvpn/openvpn-status.log log-append /var/log/openvpn/openvpn.log verb 3 key /etc/openvpn/certs/server.key cipher AES-256-CBC client-config-dir /etc/openvpn/ccd auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env username-as-common-name script-security 3 verify-client-cert none EOF # \u6ce8\u610f\uff01\uff01\uff01 \u8fd9\u91cc\u521b\u5efa\u5b8c\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u9700\u8981\u505a\u4e2a\u914d\u7f6e\u6587\u4ef6\u7684\u8f6f\u8fde\u63a5\uff0c\u56e0\u4e3a\u5f53\u524d\u7248\u672c\u7684 openvpn systemd \u542f\u52a8\u6587\u4ef6\u4e2d\u8bfb\u53d6\u7684\u662f.service.conf\u914d\u7f6e cd /etc/openvpn/server/ && ln -sf server.conf .service.conf #\u51c6\u5907\u8bc1\u4e66\u7b7e\u53d1\u76f8\u5173\u6587\u4ef6 cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server #\u51c6\u5907\u7b7e\u53d1\u8bc1\u4e66\u76f8\u5173\u53d8\u91cf\u7684\u914d\u7f6e\u6587\u4ef6 cp /usr/share/doc/easy-rsa- $EASYVER /vars.example /etc/openvpn/easy-rsa-server/3/vars #CA\u7684\u8bc1\u4e66\u6709\u6548\u671f\u9ed8\u4e3a\u4e3a10\u5e74,\u53ef\u4ee5\u9002\u5f53\u5ef6\u957f,\u6bd4\u5982:36500\u5929 sed -i '/3650/ s/3650/36500/g' /etc/openvpn/easy-rsa-server/3/vars #\u670d\u52a1\u5668\u8bc1\u4e66\u9ed8\u4e3a\u4e3a825\u5929 sed -i '/825/ s/825/82500/g' /etc/openvpn/easy-rsa-server/3/vars \u521d\u59cb\u5316\u6570\u636e,\u5728\u5f53\u524d\u76ee\u5f55\u4e0b\u751f\u6210pki\u76ee\u5f55\u53ca\u76f8\u5173\u6587\u4ef6 cd /etc/openvpn/easy-rsa-server/3/ pwd ./easyrsa init-pki \u521b\u5efaCA\u673a\u6784 cd /etc/openvpn/easy-rsa-server/3 ./easyrsa build-ca nopass <<EOF EOF # \u521b\u5efa\u670d\u52a1\u7aef\u8bc1\u4e66\u7533\u8bf7 cd /etc/openvpn/easy-rsa-server/3 ./easyrsa gen-req server nopass <<EOF EOF ## \u9881\u53d1\u670d\u52a1\u7aef\u8bc1\u4e66 # cd /etc/openvpn/easy-rsa-server/3 ./easyrsa sign server server <<EOF yes EOF # \u521b\u5efa Diffie-Hellman \u5bc6\u94a5,\u8fd9\u4e2a\u6b65\u9aa4\u5b8c\u4e86\u670d\u52a1\u5668\u90e8\u5206\u5c31\u5b8c\u6210\u4e86 cd /etc/openvpn/easy-rsa-server/3 ./easyrsa gen-dh #\u4e3a\u5ba2\u6237\u7aef\u51c6\u5907\u8bc1\u4e66\u73af\u5883 cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client cp /usr/share/doc/easy-rsa- $EASYVER /vars.example /etc/openvpn/easy-rsa-client/3/vars cd /etc/openvpn/easy-rsa-client/3/ ./easyrsa init-pki # \u5c06CA\u548c\u670d\u52a1\u5668\u8bc1\u4e66\u76f8\u5173\u6587\u4ef6\u590d\u5236\u5230\u670d\u52a1\u5668\u76f8\u5e94\u7684\u76ee\u5f55 mkdir /etc/openvpn/certs cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/ cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/ cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/ cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/ # \u4fee\u6539\u670d\u52a1\u5668\u7aef\u914d\u7f6e\u6587\u4ef6 # \u521b\u5efa\u65e5\u5fd7\u76ee\u5f55 mkdir /etc/openvpn/ccd mkdir /var/log/openvpn chown openvpn.openvpn /var/log/openvpn cat <<EOF>> /etc/openvpn/psw-file LIXIE ABC123, EOF chmod 600 /etc/openvpn/psw-file chown openvpn:openvpn /etc/openvpn/psw-file chmod +x /etc/openvpn/checkpsw.sh chown -R openvpn:openvpn /etc/openvpn/ #\u5728\u670d\u52a1\u5668\u5f00\u542fip_forward\u8f6c\u53d1\u529f\u80fd echo net.ipv4.ip_forward = 1 >> /etc/sysctl.conf && sysctl -p & > /dev/null echo 'iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -j MASQUERADE' >> /etc/rc.d/rc.local chmod +x /etc/rc.d/rc.local /etc/rc.d/rc.local systemctl daemon-reload systemctl start openvpn-server@.service.service systemctl enable openvpn-server@.service.service","title":"4.4.1\uff1avpn\u90e8\u7f72\u811a\u672c\uff1a"},{"location":"0.Internet/frp/#442","text":"cat <<EOF>> /etc/openvpn/checkpsw.sh #!/bin/sh ########################################################### # checkpsw.sh (C) 2004 Mathias Sundman <mathias@openvpn.se> # # This script will authenticate OpenVPN users against # a plain text file. The passfile should simply contain # one row per user with the username first followed by # one or more space(s) or tab(s) and then the password. PASSFILE=\"/etc/openvpn/psw-file\" LOG_FILE=\"/var/log/openvpn/password.log\" TIME_STAMP=`date \"+%Y-%m-%d %T\"` ########################################################### if [ ! -r \"${PASSFILE}\" ]; then echo \"${TIME_STAMP}: Could not open password file \\\"${PASSFILE}\\\" for reading.\" >> ${LOG_FILE} exit 1 fi CORRECT_PASSWORD=`awk '!/^;/&&!/^#/&&$1==\"'${username}'\"{print $2;exit}' ${PASSFILE}` if [ \"${CORRECT_PASSWORD}\" = \"\" ]; then echo \"${TIME_STAMP}: User does not exist: username=\\\"${username}\\\", password= \\\"${password}\\\".\" >> ${LOG_FILE} exit 1 fi if [ \"${password}\" = \"${CORRECT_PASSWORD}\" ]; then echo \"${TIME_STAMP}: Successful authentication: username=\\\"${username}\\\".\" >> ${LOG_FILE} exit 0 fi echo \"${TIME_STAMP}: Incorrect password: username=\\\"${username}\\\", password= \\\"${password}\\\".\" >> ${LOG_FILE} exit 1 EOF \u6ce8\u610f\uff1a\u9700\u8981\u7ed9\u8fd9\u4e2a\u811a\u672c\u4e00\u4e2a\u6267\u884c\u6743\u9650","title":"4.4.2\uff1a\u65b0\u589e\u7528\u6237\u811a\u672c\uff1a"},{"location":"0.Internet/frp/#443iptables","text":"\u9632\u706b\u5899\u914d\u7f6e\uff08firewalld\u914d\u7f6e\u6216\u8005iptables\u914d\u7f6e\u9009\u4e00\u4e2a\uff09 # firewalld\u914d\u7f6e firewall-cmd --permanent --add-masquerade firewall-cmd --permanent --add-service = openvpn # \u6216\u8005\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7aef\u53e3 # firewall-cmd --permanent --add-port=1194/tcp firewall-cmd --permanent --direct --passthrough ipv4 -t nat -A POSTROUTING -s 10 .8.0.0/24 -o eth0 -j MASQUERADE firewall-cmd --reload # iptables \uff08\u548c\u4e0a\u9762\u7684\u7f51\u6bb5\u914d\u7f6e\u4e0d\u540c\uff0c\u4fee\u6539\u4e0b\u9762\u7684\u7f51\u6bb5\u5373\u53ef\uff09 yum install iptables-services systemctl enable iptables iptables -X iptables -F iptables -Z iptables -P INPUT ACCEPT iptables -P OUTPUT ACCEPT iptables -P FORWARD ACCEPT service iptables save iptables -t nat -A POSTROUTING -s 10 .10.0.0/255.255.255.0 -o eth0 -j MASQUERADE iptables -A FORWARD -s 10 .10.0.0/24 -d 192 .168.0.0/24 -i tun0 -j ACCEPT iptables -A FORWARD -s 192 .168.0.0/24 -d 10 .10.0.0/24 -i eth0 -j ACCEPT service iptables save","title":"4.4.3\uff1a\u90e8\u7f72iptables\uff1a"},{"location":"0.Internet/frp/#444","text":"\u5907\u6ce8\uff1a\u5b89\u88c5openvpn\u5ba2\u6237\u7aef\u8f6f\u4ef6\uff1aconfig\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0ca\u8bc1\u4e66\u548c.opvn client dev tun proto udp # \u516c\u7f51ip\u9700\u8981\u4fee\u6539 remote \u516c\u7f51\u5730\u5740 41194 resolv-retry infinite nobind persist-key persist-tun ca ca.crt comp-lzo verb 3 cipher AES-256-CBC auth-user-pass","title":"4.4.4\uff1a\u51c6\u5907\u5ba2\u6237\u7aef\u8bc1\u4e66\uff1a"},{"location":"0.Internet/frp/#51","text":"","title":"5.1\uff1a\u5176\u4ed6\u6848\u4f8b\u914d\u7f6e\uff1a"},{"location":"0.Internet/frp/#_1","text":"\u5b66\u4e60\u535a\u5ba2\uff1a https://www.jianshu.com/p/09603d9e0b6c","title":"\u9644\u4ef6\uff1a"},{"location":"1.os/2024-9-25-ssh-proxy-docs/","text":"SSH \u8f6c\u53d1\u4ee3\u7406 \u00b6 \u5728\u5de5\u4f5c\u4e2d\uff0c\u5e38\u5e38\u4f1a\u9047\u89c1\u4e00\u4e9b\u6076\u5fc3\u7684\u73af\u5883\uff0c\u4f8b\u5982\u53ef\u4ee5\u901a\u8fc7VPN\u7684\u65b9\u5f0f\u8fde\u63a5\u5230\u5ba2\u6237\u7684\u673a\u5668\u4e0a\uff0c\u4f46\u662f\u5374\u65e0\u6cd5\u4e0a\u7f51\u3002\u5bfc\u81f4\u5b89\u88c5\u96be\u5ea6\u8f83\u5927\u3002 \u5ba2\u6237\u8fd8\u4f1a\u8bf4\uff1a \u4eba\u4eec\u5c31\u5e94\u8be5\u6765\u6211\u4eec\u8fd9\u91cc\u5e72\u6d3b\u548c\u51fa\u5dee...... \u9488\u5bf9\u4ee5\u4e0a\u8fd9\u79cd\u5ba2\u6237\uff0c\u53ea\u8981\u6211\u4eec\u53ef\u4ee5\u8fde\u63a5\u4e0a\u4ed6\u4eec\u7684linux\u673a\u5668\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u540c\u8fc7ssh\u8f6c\u53d1\u7684\u4ee3\u7406\u7684\u5f62\u5f0f\uff0c\u8ba9\u4ed6\u4eec\u7684\u673a\u5668\u4e0a\u7f51\u3002(\u5b9e\u73b0\u4e00\u4e9b\u9a9a\u64cd\u4f5c) \u5b9e\u8df5\u64cd\u4f5c \u00b6 \u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u6307\u5b9a\u4e00\u53f0ssh \u8f6c\u53d1\u7684\u670d\u52a1\u5668\u3002\u901a\u8fc7\u6211\u4eec\u672c\u5730\u7684Mac\uff0c\u6765\u5b9e\u73b0ssh\u7684\u8f6c\u53d1 \u6211\u7684Mac\u7535\u8111 \u00b6 # \u8fd9\u6761\u547d\u4ee4\u4e3b\u8981\u7684\u4f5c\u7528\u901a\u8fc7 SSH \u96a7\u9053\u8fdb\u884c\u8fdc\u7a0b\u7aef\u53e3\u8f6c\u53d1\uff0c\u5e76\u5c06\u672c\u5730\u7684\u7aef\u53e3\u6620\u5c04\u5230\u8fdc\u7a0b\u670d\u52a1\u5668\u4e0a\uff08\u5176\u4e2dmaster.nb\u5c31\u662f\u6211\u4eec\u7684\u8fdc\u7a0b\u670d\u52a1\u5668\uff09 ssh -R 7890 :localhost:7890 master.nb \u901a\u8fc7\u4ee5\u4e0a\u7684\u65b9\u5f0f\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba9\u6211\u4eec\u7684master.nb\u4e0a\u7f51\u4e86\u3002\u63a5\u4e0b\u6765\u662f\u6d4b\u8bd5\u6b65\u9aa4(\u8fd9\u4e2a\u9700\u8981\u58f0\u660e\u4e00\u4e0b\u73af\u5883\u53d8\u91cf) # \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5176\u5b9e\u5c31\u80fd\u8bbf\u95ee\u5916\u7f51\u4e86 export http_proxy = http://127.0.0.1:7890 && export https_proxy = http://127.0.0.1:7890 curl https://openbayes.com/api/users/lixie/keys.txt \u68c0\u67e5\u7aef\u53e3\uff1a\uff08\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u4f1a\u663e\u793a7890\u7aef\u53e3\u53ea\u9650\u5236\u5728\u4e86\u672c\u5730\u56de\u73af127.0.0.1\u4e0a\uff0c\u4e5f\u5c31\u662f\u8bf4\u548cmaster.nb\u76f8\u540c\u7f51\u6bb5\u7684\u673a\u5668\u65e0\u6cd5\u901a\u8fc7master.nb\u4ee3\u7406\u51fa\u53bb\uff09 \u6240\u4ee5\uff0c\u5f88\u91cd\u8981\u7684\u4e24\u4e2a\u53c2\u6570\u914d\u7f6e (\u4fee\u6539master.nb /etc/ssh/sshd_config) GatewayPorts yes \u628a\u76d1\u542c\u7aef\u53e3127.0.0.1:7890\u7ed1\u5b9a\u5230 0.0.0.0:7890 \u5730\u5740\u4e0a,\u8fd9\u6837\u5916\u90e8\u7684\u6240\u6709\u673a\u5668\u90fd\u80fd\u8bbf\u95ee\u5230\u8fd9\u4e2a\u76d1\u542c\u7aef\u53e3\uff0c\u7136\u540e\u4fdd\u5b58\u9000\u51fa\u3002\u91cd\u542fssh\u670d\u52a1 \u6f14\u793a\u6d4b\u8bd5: \u00b6 $ ip route del default via 10.0.10.1 dev ens33 proto static # \u5220\u9664\u672c\u5730\u7684\u9ed8\u8ba4\u8def\u7531,\u8fd9\u6837\u6a21\u62df\u65e0\u6cd5\u4e0a\u7f51\u7684\u73af\u5883 # \u6211\u4eec\u9700\u8981\u58f0\u660e\u5c06\u4ee3\u7406\u6307\u5411\u4ee3\u7406\u670d\u52a1\u5668.\u6211\u4eec\u5c31\u80fd\u5b9e\u73b0\u4e0a\u7f51,\u751a\u81f3\u662f\u7ffb\u5899 [cpu] root@nfs-server:~# export http_proxy=http://{proxy-ip-address}:7890 [cpu] root@nfs-server:~# export https_proxy=http://{proxy-ip-address}:7890 [cpu] root@nfs-server:~# curl https://openbayes.com/api/users/lixie/keys.txt ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDwWSc73tyq4TAkXxt3rWmGggbpgdm+egc8mOSDu0hauuvPdieIe1qUbKsIKC1O93KyDPlsfP5gcwqdEmf5Di0S6CCxRh6ENyZ9mtN+s1pCDeHiKbjhPyG4o71tafIDOjhcbpEtCwPA0YTrp5i1oO466qYHeFmTCmkcDFhuEKZx78EZdTwbFH0vhOGTymLFgUVauzmd45ZxpTzaZHrd093nFHWg6FeZWk2axkDiijLALNxiAAaECn2S69y5SxXgKSqpe4Z25b2cKKySlM1lBv1eI7CSxAUoxuXSpcgoRiVUx5VgJwkixKvq8NpihYEkV5pFRjB8W0ssu1YF6d+3MlzOkwa+kir9JJlLq+F/rrBTfF2mCLBgg0KE+voDd8vjEkqSmweNs2gEO7Gi/fUEfcabNAOuNNPL2dhdFl+BH2TCofDYvZcWd8Wrl/0qoW5nbUdCaC7aznb0lpVgseB/gj6ah3adCzfA/W8S+1znD9VMHDdMNy+AN8eeQQ6d2t05SOc=[cpu] root@nfs-server:~# \u6848\u4f8b \u00b6 \u4e3b\u8981\u7684\u6539\u52a8\u5176\u5b9e\u5c31\u662f\u4ee5\u4e0b\u4e24\u4e2a\u5730\u65b9\uff0c\u5176\u4ed6\u540c\u7f51\u6bb5\u7684\u673a\u5668\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u5b9e\u73b0\u4e0a\u7f51 [ningbo] root@gtx1070-1:/home/lixie# cat /etc/systemd/system/docker.service.d/http-proxy.conf [Service] Environment=\"HTTP_PROXY=http://master.nb:7890\" Environment=\"HTTPS_PROXY=http://master.nb:7890\" Environment=\"NO_PROXY=localhost,10.2.4.52\" [ningbo] root@gtx1070-1:/home/lixie# cat /etc/apt/apt.conf.d/02proxy Acquire::http { Proxy \"http://master.ningbo:nb\" } Acquire::https { Proxy \"http://master.ningbo:nb\" } Ansible\u81ea\u52a8\u5316\u914d\u7f6e \u00b6 \u4ee5\u4e0a\u7684\u811a\u672c\u53ef\u4ee5\u901a\u8fc7ansible\u6765\u81ea\u52a8\u5316\u7684\uff0c\u914d\u7f6e\u4e0a\uff0c\u8fd9\u6837\u6240\u6709\u7684\u8282\u70b9\u5c31\u90fd\u53ef\u4ee5\u4e0a\u7f51\u4e86\u3002(\u8fd9\u4e2a\u811a\u672c\u53ef\u4ee5\u5e2e\u7ec4\u6211\u4eec\u6765\u914d\u7f6eapt\uff0cdocker\u7684proxy) - name : Gather facts about the system ansible.builtin.setup : - name : Check if Docker is installed command : docker --version register : docker_installed ignore_errors : true - name : Ensure the Docker proxy directory exists (only if Docker is installed) file : dest : /etc/systemd/system/docker.service.d state : directory when : docker_installed.rc == 0 - name : Add Docker proxy settings (only if Docker is installed) copy : directory_mode : yes dest : /etc/systemd/system/docker.service.d/http-proxy.conf content : | [Service] Environment=\"HTTP_PROXY={{ http_proxy }}\" Environment=\"HTTPS_PROXY={{ https_proxy }}\" Environment=\"NO_PROXY={{ no_proxy }}\" when : docker_installed.rc == 0 - name : Reload Docker (only if Docker is installed) service : name : docker state : restarted daemon_reload : yes when : docker_installed.rc == 0 - name : Add proxy for apt copy : dest : /etc/apt/apt.conf.d/02proxy content : | Acquire::http { Proxy \"{{ http_proxy }}\" } Acquire::https { Proxy \"{{ https_proxy }}\" }","title":"Linux SSH \u8f6c\u53d1\u4ee3\u7406\u5b9e\u73b0"},{"location":"1.os/2024-9-25-ssh-proxy-docs/#ssh","text":"\u5728\u5de5\u4f5c\u4e2d\uff0c\u5e38\u5e38\u4f1a\u9047\u89c1\u4e00\u4e9b\u6076\u5fc3\u7684\u73af\u5883\uff0c\u4f8b\u5982\u53ef\u4ee5\u901a\u8fc7VPN\u7684\u65b9\u5f0f\u8fde\u63a5\u5230\u5ba2\u6237\u7684\u673a\u5668\u4e0a\uff0c\u4f46\u662f\u5374\u65e0\u6cd5\u4e0a\u7f51\u3002\u5bfc\u81f4\u5b89\u88c5\u96be\u5ea6\u8f83\u5927\u3002 \u5ba2\u6237\u8fd8\u4f1a\u8bf4\uff1a \u4eba\u4eec\u5c31\u5e94\u8be5\u6765\u6211\u4eec\u8fd9\u91cc\u5e72\u6d3b\u548c\u51fa\u5dee...... \u9488\u5bf9\u4ee5\u4e0a\u8fd9\u79cd\u5ba2\u6237\uff0c\u53ea\u8981\u6211\u4eec\u53ef\u4ee5\u8fde\u63a5\u4e0a\u4ed6\u4eec\u7684linux\u673a\u5668\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u540c\u8fc7ssh\u8f6c\u53d1\u7684\u4ee3\u7406\u7684\u5f62\u5f0f\uff0c\u8ba9\u4ed6\u4eec\u7684\u673a\u5668\u4e0a\u7f51\u3002(\u5b9e\u73b0\u4e00\u4e9b\u9a9a\u64cd\u4f5c)","title":"SSH \u8f6c\u53d1\u4ee3\u7406"},{"location":"1.os/2024-9-25-ssh-proxy-docs/#_1","text":"\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u6307\u5b9a\u4e00\u53f0ssh \u8f6c\u53d1\u7684\u670d\u52a1\u5668\u3002\u901a\u8fc7\u6211\u4eec\u672c\u5730\u7684Mac\uff0c\u6765\u5b9e\u73b0ssh\u7684\u8f6c\u53d1","title":"\u5b9e\u8df5\u64cd\u4f5c"},{"location":"1.os/2024-9-25-ssh-proxy-docs/#mac","text":"# \u8fd9\u6761\u547d\u4ee4\u4e3b\u8981\u7684\u4f5c\u7528\u901a\u8fc7 SSH \u96a7\u9053\u8fdb\u884c\u8fdc\u7a0b\u7aef\u53e3\u8f6c\u53d1\uff0c\u5e76\u5c06\u672c\u5730\u7684\u7aef\u53e3\u6620\u5c04\u5230\u8fdc\u7a0b\u670d\u52a1\u5668\u4e0a\uff08\u5176\u4e2dmaster.nb\u5c31\u662f\u6211\u4eec\u7684\u8fdc\u7a0b\u670d\u52a1\u5668\uff09 ssh -R 7890 :localhost:7890 master.nb \u901a\u8fc7\u4ee5\u4e0a\u7684\u65b9\u5f0f\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba9\u6211\u4eec\u7684master.nb\u4e0a\u7f51\u4e86\u3002\u63a5\u4e0b\u6765\u662f\u6d4b\u8bd5\u6b65\u9aa4(\u8fd9\u4e2a\u9700\u8981\u58f0\u660e\u4e00\u4e0b\u73af\u5883\u53d8\u91cf) # \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5176\u5b9e\u5c31\u80fd\u8bbf\u95ee\u5916\u7f51\u4e86 export http_proxy = http://127.0.0.1:7890 && export https_proxy = http://127.0.0.1:7890 curl https://openbayes.com/api/users/lixie/keys.txt \u68c0\u67e5\u7aef\u53e3\uff1a\uff08\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u4f1a\u663e\u793a7890\u7aef\u53e3\u53ea\u9650\u5236\u5728\u4e86\u672c\u5730\u56de\u73af127.0.0.1\u4e0a\uff0c\u4e5f\u5c31\u662f\u8bf4\u548cmaster.nb\u76f8\u540c\u7f51\u6bb5\u7684\u673a\u5668\u65e0\u6cd5\u901a\u8fc7master.nb\u4ee3\u7406\u51fa\u53bb\uff09 \u6240\u4ee5\uff0c\u5f88\u91cd\u8981\u7684\u4e24\u4e2a\u53c2\u6570\u914d\u7f6e (\u4fee\u6539master.nb /etc/ssh/sshd_config) GatewayPorts yes \u628a\u76d1\u542c\u7aef\u53e3127.0.0.1:7890\u7ed1\u5b9a\u5230 0.0.0.0:7890 \u5730\u5740\u4e0a,\u8fd9\u6837\u5916\u90e8\u7684\u6240\u6709\u673a\u5668\u90fd\u80fd\u8bbf\u95ee\u5230\u8fd9\u4e2a\u76d1\u542c\u7aef\u53e3\uff0c\u7136\u540e\u4fdd\u5b58\u9000\u51fa\u3002\u91cd\u542fssh\u670d\u52a1","title":"\u6211\u7684Mac\u7535\u8111"},{"location":"1.os/2024-9-25-ssh-proxy-docs/#_2","text":"$ ip route del default via 10.0.10.1 dev ens33 proto static # \u5220\u9664\u672c\u5730\u7684\u9ed8\u8ba4\u8def\u7531,\u8fd9\u6837\u6a21\u62df\u65e0\u6cd5\u4e0a\u7f51\u7684\u73af\u5883 # \u6211\u4eec\u9700\u8981\u58f0\u660e\u5c06\u4ee3\u7406\u6307\u5411\u4ee3\u7406\u670d\u52a1\u5668.\u6211\u4eec\u5c31\u80fd\u5b9e\u73b0\u4e0a\u7f51,\u751a\u81f3\u662f\u7ffb\u5899 [cpu] root@nfs-server:~# export http_proxy=http://{proxy-ip-address}:7890 [cpu] root@nfs-server:~# export https_proxy=http://{proxy-ip-address}:7890 [cpu] root@nfs-server:~# curl https://openbayes.com/api/users/lixie/keys.txt ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDwWSc73tyq4TAkXxt3rWmGggbpgdm+egc8mOSDu0hauuvPdieIe1qUbKsIKC1O93KyDPlsfP5gcwqdEmf5Di0S6CCxRh6ENyZ9mtN+s1pCDeHiKbjhPyG4o71tafIDOjhcbpEtCwPA0YTrp5i1oO466qYHeFmTCmkcDFhuEKZx78EZdTwbFH0vhOGTymLFgUVauzmd45ZxpTzaZHrd093nFHWg6FeZWk2axkDiijLALNxiAAaECn2S69y5SxXgKSqpe4Z25b2cKKySlM1lBv1eI7CSxAUoxuXSpcgoRiVUx5VgJwkixKvq8NpihYEkV5pFRjB8W0ssu1YF6d+3MlzOkwa+kir9JJlLq+F/rrBTfF2mCLBgg0KE+voDd8vjEkqSmweNs2gEO7Gi/fUEfcabNAOuNNPL2dhdFl+BH2TCofDYvZcWd8Wrl/0qoW5nbUdCaC7aznb0lpVgseB/gj6ah3adCzfA/W8S+1znD9VMHDdMNy+AN8eeQQ6d2t05SOc=[cpu] root@nfs-server:~#","title":"\u6f14\u793a\u6d4b\u8bd5:"},{"location":"1.os/2024-9-25-ssh-proxy-docs/#_3","text":"\u4e3b\u8981\u7684\u6539\u52a8\u5176\u5b9e\u5c31\u662f\u4ee5\u4e0b\u4e24\u4e2a\u5730\u65b9\uff0c\u5176\u4ed6\u540c\u7f51\u6bb5\u7684\u673a\u5668\u5c31\u53ef\u4ee5\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u5b9e\u73b0\u4e0a\u7f51 [ningbo] root@gtx1070-1:/home/lixie# cat /etc/systemd/system/docker.service.d/http-proxy.conf [Service] Environment=\"HTTP_PROXY=http://master.nb:7890\" Environment=\"HTTPS_PROXY=http://master.nb:7890\" Environment=\"NO_PROXY=localhost,10.2.4.52\" [ningbo] root@gtx1070-1:/home/lixie# cat /etc/apt/apt.conf.d/02proxy Acquire::http { Proxy \"http://master.ningbo:nb\" } Acquire::https { Proxy \"http://master.ningbo:nb\" }","title":"\u6848\u4f8b"},{"location":"1.os/2024-9-25-ssh-proxy-docs/#ansible","text":"\u4ee5\u4e0a\u7684\u811a\u672c\u53ef\u4ee5\u901a\u8fc7ansible\u6765\u81ea\u52a8\u5316\u7684\uff0c\u914d\u7f6e\u4e0a\uff0c\u8fd9\u6837\u6240\u6709\u7684\u8282\u70b9\u5c31\u90fd\u53ef\u4ee5\u4e0a\u7f51\u4e86\u3002(\u8fd9\u4e2a\u811a\u672c\u53ef\u4ee5\u5e2e\u7ec4\u6211\u4eec\u6765\u914d\u7f6eapt\uff0cdocker\u7684proxy) - name : Gather facts about the system ansible.builtin.setup : - name : Check if Docker is installed command : docker --version register : docker_installed ignore_errors : true - name : Ensure the Docker proxy directory exists (only if Docker is installed) file : dest : /etc/systemd/system/docker.service.d state : directory when : docker_installed.rc == 0 - name : Add Docker proxy settings (only if Docker is installed) copy : directory_mode : yes dest : /etc/systemd/system/docker.service.d/http-proxy.conf content : | [Service] Environment=\"HTTP_PROXY={{ http_proxy }}\" Environment=\"HTTPS_PROXY={{ https_proxy }}\" Environment=\"NO_PROXY={{ no_proxy }}\" when : docker_installed.rc == 0 - name : Reload Docker (only if Docker is installed) service : name : docker state : restarted daemon_reload : yes when : docker_installed.rc == 0 - name : Add proxy for apt copy : dest : /etc/apt/apt.conf.d/02proxy content : | Acquire::http { Proxy \"{{ http_proxy }}\" } Acquire::https { Proxy \"{{ https_proxy }}\" }","title":"Ansible\u81ea\u52a8\u5316\u914d\u7f6e"},{"location":"1.os/asus/asus-docs/","text":"\u4ee5\u4e0b\u5185\u5bb9\u662f\u9488\u5bf9\u6211\u5b89\u88c5\u534e\u7855\u670d\u52a1\u5668\u9047\u5230\u7684\u5404\u79cd\u5947\u8469\u95ee\u9898\uff0c\u505a\u4e86\u4ee5\u4e0b\u7684\u8bb0\u5f55\u3002\u5f53\u7136\u8fd9\u4e9b\u95ee\u9898\u4e5f\u5b58\u5728\u4e8e\u5176\u4ed6\u7684\u670d\u52a1\u5668\u3002\u53ef\u4ee5\u53c2\u8003\u4e00\u4e0b\uff5e \u95ee\u98981 \u00b6 \u5317\u4eac\u529e\u516c\u5ba4\u8fd9\u8fb9\u9700\u8981\u6211\u4eec\u6765\u4e32\u51e0\u53f0\u673a\u5668,\u6211\u4eec\u5c31\u91c7\u8d2d\u4e86\u51e0\u53f0\u534e\u7855\u7684\u673a\u5668,\u5728\u5b89\u88c5\u65f6\u9047\u5230\u4e86\u5f88\u591a\u7684\u95ee\u9898,\u5bf9\u6b64\u505a\u4e86\u4e00\u4e0b\u8bb0\u5f55. \u65e0\u6cd5\u542f\u52a8\u670d\u52a1\u5668 \u95ee\u9898\u539f\u56e0: \u6211\u4eec\u8d2d\u4e70\u7684 cpu \u578b\u53f7\u4e0e\u4e3b\u677f\u578b\u53f7\u4e0d\u4e00\u81f4,\u5bfc\u81f4\u65e0\u6cd5\u542f\u52a8\u7cfb\u7edf, \u9700\u8981\u94fe\u63a5\u5e26\u5916\u7ba1\u7406\u66f4\u65b0\u56fa\u4ef6\u548c Bios \u4e5f\u53ef\u4ee5\u5f00\u673a,\u800c\u4e14\u5f00\u59cb\u5fc5\u987b\u53ea\u63d2\u4e00\u6839\u5185\u5b58.(\u5426\u5219\u65e0\u6cd5\u5f00\u673a) \u540c\u65f6\u63d2\u5165\u5185\u5b58\u65e0\u6cd5\u5f00\u673a \u5b89\u88c5\u7cfb\u7edf\u65f6,\u7a81\u7136\u65ad\u7535 \u6211\u4eec\u5728\u5b89\u88c5\u7cfb\u7edf\u7684\u65f6\u5019,\u53d1\u73b0\u5b89\u88c5\u8fc7\u7a0b\u4e2d,\u7a81\u7136\u7cfb\u7edf\u5c31\u5173\u673a\u4e86,\u641e\u5f97\u4e00\u8138\u61f5.\u6700\u540e\u5b89\u88c5\u4e86\u6563\u70ed\u5668,\u624d\u597d,\u53ef\u80fd\u662f\u51ac\u5929\u5ba4\u5185\u6e29\u5ea6\u592a\u9ad8,\u5bfc\u81f4 cpu \u8fc7\u70ed\u5f15\u8d77\u7684. \u5173\u4e8envme\u548csata\u76d8\u4f4d\u7684\u8bc6\u522b\u95ee\u9898 \u5b89\u88c5\u597dcpu\u5185\u5b58\u786c\u76d8\u65e0\u6cd5\u542f\u52a8\u95ee\u9898 \u670d\u52a1\u5668\u540e\u9762\u7248\u4ee3\u7801\u542b\u4e49 \u4e0a\u56fe\u5c31\u662f\u534e\u7855\u670d\u52a1\u5668\u7684\u5185\u90e8\u7ed3\u6784\uff08\u4e00U\u670d\u52a1\u5668\uff09 \u5f53\u6211\u5b89\u88c5\u597d\u4e86\u78c1\u76d8\u4e4b\u540e\u63d2\u5165\u670d\u52a1\u5668\u63d2\u69fd\u53d1\u73b0\u65e0\u6cd5\u8bc6\u522bnvme\u78c1\u76d8\uff0c\u8868\u793a\u5f88\u61f5\u903c\u3002\u540e\u6765\u624d\u77e5\u9053\uff0cnvme\u53ea\u6709\u56fa\u5b9a\u76844\u4e2a\u76d8\u4f4d\u624d\u80fd\u8bc6\u522bnvme\u7684\u786c\u76d8\u3002\u5f53\u6211\u4eec\u63d2\u5165\u63d2\u69fd\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u670d\u52a1\u5668\u4e0a\u5b89\u88c5 apt install nvme-cli \u5de5\u5177 \uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 nvme list \u6765\u770bnvme\u7684\u78c1\u76d8\u5217\u8868\uff1b \u5728\u5b89\u88c5\u597dcpu \u548c \u5185\u5b58\u4e4b\u540e\u6211\u53d1\u73b0\u65e0\u6cd5\u542f\u52a8\u670d\u52a1\u5668\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u89c2\u5bdf\u540e\u9762\u677f\u7684\u4ee3\u7801\uff0c\u4e5f\u6ca1\u6709\u4efb\u4f55\u6570\u5b57\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4ee5\u4e3a\u662f\u6211\u5185\u5b58\u6ca1\u6709\u63d2\u597d\u5bfc\u81f4\u65e0\u6cd5\u542f\u52a8\u673a\u5668\uff0c\u6211\u5c06\u6240\u6709\u7684\u5185\u5b58\u90fd\u62d4\u6389\u3002\u53ea\u7559\u4e86\u4e00\u6839\uff0c\u8fd9\u65f6\u5019\u53d1\u73b0\u8fd8\u662f\u65e0\u6cd5\u542f\u52a8\u670d\u52a1\u5668\u3002\u6211\u60f3\u4e86\u534a\u5929\u4ee5\u4e3a\u662f\u670d\u52a1\u5668\u574f\u4e86\uff0c\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u6211\u7a81\u7136\u53d1\u73b0CPU\u6ca1\u6709\u62e7\u7d27\uff0c\u5c31\u91cd\u65b0\u7d27\u4e86\u4e00\u4e0bcpu\uff1b\u8fd9\u4e2a\u65f6\u5019\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u542f\u52a8\u5b89\u88c5\u7cfb\u7edf\u4e86\uff1b \u5f53\u6211\u4eec\u5728\u5b89\u88c5\u670d\u52a1\u5668\u7684\u65f6\u5019\u5c31\u4f1a\u9047\u5230\u5404\u79cd\u4e2a\u6837\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u901a\u8fc7\u670d\u52a1\u5668\u540e\u7684\u9762\u677f\u6765\u67e5\u770b\u4ee3\u7801\uff1b\u5173\u4e8e\u534e\u7855\u670d\u52a1\u5668\u4ee3\u7801\u542b\u4e49\uff0c\u53ef\u4ee5\u53c2\u6570\u4ee5\u4e0b\u7684\u94fe\u63a5\u3002 \u6587\u7ae0\u53c2\u8003 \u00b6 \u5b98\u65b9\u534e\u7855\u670d\u52a1\u5668\u624b\u518c","title":"\u534e\u7855\u670d\u52a1\u5668"},{"location":"1.os/asus/asus-docs/#1","text":"\u5317\u4eac\u529e\u516c\u5ba4\u8fd9\u8fb9\u9700\u8981\u6211\u4eec\u6765\u4e32\u51e0\u53f0\u673a\u5668,\u6211\u4eec\u5c31\u91c7\u8d2d\u4e86\u51e0\u53f0\u534e\u7855\u7684\u673a\u5668,\u5728\u5b89\u88c5\u65f6\u9047\u5230\u4e86\u5f88\u591a\u7684\u95ee\u9898,\u5bf9\u6b64\u505a\u4e86\u4e00\u4e0b\u8bb0\u5f55. \u65e0\u6cd5\u542f\u52a8\u670d\u52a1\u5668 \u95ee\u9898\u539f\u56e0: \u6211\u4eec\u8d2d\u4e70\u7684 cpu \u578b\u53f7\u4e0e\u4e3b\u677f\u578b\u53f7\u4e0d\u4e00\u81f4,\u5bfc\u81f4\u65e0\u6cd5\u542f\u52a8\u7cfb\u7edf, \u9700\u8981\u94fe\u63a5\u5e26\u5916\u7ba1\u7406\u66f4\u65b0\u56fa\u4ef6\u548c Bios \u4e5f\u53ef\u4ee5\u5f00\u673a,\u800c\u4e14\u5f00\u59cb\u5fc5\u987b\u53ea\u63d2\u4e00\u6839\u5185\u5b58.(\u5426\u5219\u65e0\u6cd5\u5f00\u673a) \u540c\u65f6\u63d2\u5165\u5185\u5b58\u65e0\u6cd5\u5f00\u673a \u5b89\u88c5\u7cfb\u7edf\u65f6,\u7a81\u7136\u65ad\u7535 \u6211\u4eec\u5728\u5b89\u88c5\u7cfb\u7edf\u7684\u65f6\u5019,\u53d1\u73b0\u5b89\u88c5\u8fc7\u7a0b\u4e2d,\u7a81\u7136\u7cfb\u7edf\u5c31\u5173\u673a\u4e86,\u641e\u5f97\u4e00\u8138\u61f5.\u6700\u540e\u5b89\u88c5\u4e86\u6563\u70ed\u5668,\u624d\u597d,\u53ef\u80fd\u662f\u51ac\u5929\u5ba4\u5185\u6e29\u5ea6\u592a\u9ad8,\u5bfc\u81f4 cpu \u8fc7\u70ed\u5f15\u8d77\u7684. \u5173\u4e8envme\u548csata\u76d8\u4f4d\u7684\u8bc6\u522b\u95ee\u9898 \u5b89\u88c5\u597dcpu\u5185\u5b58\u786c\u76d8\u65e0\u6cd5\u542f\u52a8\u95ee\u9898 \u670d\u52a1\u5668\u540e\u9762\u7248\u4ee3\u7801\u542b\u4e49 \u4e0a\u56fe\u5c31\u662f\u534e\u7855\u670d\u52a1\u5668\u7684\u5185\u90e8\u7ed3\u6784\uff08\u4e00U\u670d\u52a1\u5668\uff09 \u5f53\u6211\u5b89\u88c5\u597d\u4e86\u78c1\u76d8\u4e4b\u540e\u63d2\u5165\u670d\u52a1\u5668\u63d2\u69fd\u53d1\u73b0\u65e0\u6cd5\u8bc6\u522bnvme\u78c1\u76d8\uff0c\u8868\u793a\u5f88\u61f5\u903c\u3002\u540e\u6765\u624d\u77e5\u9053\uff0cnvme\u53ea\u6709\u56fa\u5b9a\u76844\u4e2a\u76d8\u4f4d\u624d\u80fd\u8bc6\u522bnvme\u7684\u786c\u76d8\u3002\u5f53\u6211\u4eec\u63d2\u5165\u63d2\u69fd\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u670d\u52a1\u5668\u4e0a\u5b89\u88c5 apt install nvme-cli \u5de5\u5177 \uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 nvme list \u6765\u770bnvme\u7684\u78c1\u76d8\u5217\u8868\uff1b \u5728\u5b89\u88c5\u597dcpu \u548c \u5185\u5b58\u4e4b\u540e\u6211\u53d1\u73b0\u65e0\u6cd5\u542f\u52a8\u670d\u52a1\u5668\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u89c2\u5bdf\u540e\u9762\u677f\u7684\u4ee3\u7801\uff0c\u4e5f\u6ca1\u6709\u4efb\u4f55\u6570\u5b57\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4ee5\u4e3a\u662f\u6211\u5185\u5b58\u6ca1\u6709\u63d2\u597d\u5bfc\u81f4\u65e0\u6cd5\u542f\u52a8\u673a\u5668\uff0c\u6211\u5c06\u6240\u6709\u7684\u5185\u5b58\u90fd\u62d4\u6389\u3002\u53ea\u7559\u4e86\u4e00\u6839\uff0c\u8fd9\u65f6\u5019\u53d1\u73b0\u8fd8\u662f\u65e0\u6cd5\u542f\u52a8\u670d\u52a1\u5668\u3002\u6211\u60f3\u4e86\u534a\u5929\u4ee5\u4e3a\u662f\u670d\u52a1\u5668\u574f\u4e86\uff0c\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u6211\u7a81\u7136\u53d1\u73b0CPU\u6ca1\u6709\u62e7\u7d27\uff0c\u5c31\u91cd\u65b0\u7d27\u4e86\u4e00\u4e0bcpu\uff1b\u8fd9\u4e2a\u65f6\u5019\u53d1\u73b0\u53ef\u4ee5\u6b63\u5e38\u542f\u52a8\u5b89\u88c5\u7cfb\u7edf\u4e86\uff1b \u5f53\u6211\u4eec\u5728\u5b89\u88c5\u670d\u52a1\u5668\u7684\u65f6\u5019\u5c31\u4f1a\u9047\u5230\u5404\u79cd\u4e2a\u6837\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u901a\u8fc7\u670d\u52a1\u5668\u540e\u7684\u9762\u677f\u6765\u67e5\u770b\u4ee3\u7801\uff1b\u5173\u4e8e\u534e\u7855\u670d\u52a1\u5668\u4ee3\u7801\u542b\u4e49\uff0c\u53ef\u4ee5\u53c2\u6570\u4ee5\u4e0b\u7684\u94fe\u63a5\u3002","title":"\u95ee\u98981"},{"location":"1.os/asus/asus-docs/#_1","text":"\u5b98\u65b9\u534e\u7855\u670d\u52a1\u5668\u624b\u518c","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"1.os/ubuntu/kjc-doc/","text":"Linux \u4e91\u8ba1\u7b97\u603b\u7eb2 \u00b6 1-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e00\u518c-Linux\u7cfb\u7edf\u7ba1\u7406 2-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e8c\u518c-Linux\u7f51\u7edc\u670d\u52a1 3-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e09\u518c-Shell\u811a\u672c\u7f16\u7a0b 4-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u56db\u518c-Linux\u5b89\u5168-\u9632\u706b\u5899 5-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e94\u518c-Web\u670d\u52a1\u5668 6-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u516d\u518c-MySQL\u6570\u636e\u5e93 7-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e03\u518c-\u7fa4\u96c6 8-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u516b\u518c-\u7f13\u5b58\u53ca\u52a0\u901f 9-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e5d\u518c-\u76d1\u63a7\u4e0e\u5206\u5e03\u5f0f\u6587\u4ef6\u670d\u52a1 10-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u5341\u518c-Oracle+MongDB 11-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u5341\u4e00\u518c-\u865a\u62df\u5316\u7ba1\u7406","title":"Linux \u4e91\u8ba1\u7b97\u624b\u518c\u5927\u7eb2"},{"location":"1.os/ubuntu/kjc-doc/#linux","text":"1-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e00\u518c-Linux\u7cfb\u7edf\u7ba1\u7406 2-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e8c\u518c-Linux\u7f51\u7edc\u670d\u52a1 3-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e09\u518c-Shell\u811a\u672c\u7f16\u7a0b 4-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u56db\u518c-Linux\u5b89\u5168-\u9632\u706b\u5899 5-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e94\u518c-Web\u670d\u52a1\u5668 6-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u516d\u518c-MySQL\u6570\u636e\u5e93 7-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e03\u518c-\u7fa4\u96c6 8-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u516b\u518c-\u7f13\u5b58\u53ca\u52a0\u901f 9-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u4e5d\u518c-\u76d1\u63a7\u4e0e\u5206\u5e03\u5f0f\u6587\u4ef6\u670d\u52a1 10-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u5341\u518c-Oracle+MongDB 11-\u4e91\u8ba1\u7b97\u8bfe\u7a0b\u7b14\u8bb0\u7b2c\u5341\u4e00\u518c-\u865a\u62df\u5316\u7ba1\u7406","title":"Linux \u4e91\u8ba1\u7b97\u603b\u7eb2"},{"location":"1.os/ubuntu/ubuntu-bmc-doc/","text":"\u670d\u52a1\u5668BMC\uff08\u5e26\u5916\uff09 \u00b6 \u7b80\u4ecb \u00b6 \u670d\u52a1\u5668\u9664\u4e86\u88c5linux\uff0cwindows\u7cfb\u7edf\u5916\uff0c\u76f8\u5e94\u8fd8\u6709\u4e00\u4e2a\u53ef\u901a\u8fc7\u7f51\u7ebf\uff08\u670d\u52a1\u5668\u9ed8\u8ba4\u5e26\u5916\u5730\u5740--\u53ef\u6539\uff09\u8fde\u63a5\u5177\u4f53\u5382\u5546\u670d\u52a1\u5668\u7684BMC\uff08Baseboard Management Controller\uff0c\u57fa\u677f\u7ba1\u7406\u63a7\u5236\u5668\uff09 \u667a\u80fd\u5e73\u53f0\u7ba1\u7406\u63a5\u53e3 (IPMI) \u662f\u4e00\u79cd\u5f00\u653e\u6807\u51c6\u7684\u786c\u4ef6\u7ba1\u7406\u63a5\u53e3\u89c4\u683c\uff0c\u5b9a\u4e49\u4e86\u5d4c\u5165\u5f0f\u7ba1\u7406\u5b50\u7cfb\u7edf\u8fdb\u884c\u901a\u4fe1\u7684\u7279\u5b9a\u65b9\u6cd5\u3002IPMI \u4fe1\u606f\u901a\u8fc7\u57fa\u677f\u7ba1\u7406\u63a7\u5236\u5668 (BMC)\uff08\u4f4d\u4e8e IPMI \u89c4\u683c\u7684\u786c\u4ef6\u7ec4\u4ef6\u4e0a\uff09\u8fdb\u884c\u4ea4\u6d41\u3002\u4f7f\u7528\u4f4e\u7ea7\u786c\u4ef6\u667a\u80fd\u7ba1\u7406\u800c\u4e0d\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u884c\u7ba1\u7406\uff0c\u5177\u6709\u4e24\u4e2a\u4e3b\u8981\u4f18\u70b9\uff1a \u9996\u5148\uff0c\u6b64\u914d\u7f6e\u5141\u8bb8\u8fdb\u884c\u5e26\u5916\u670d\u52a1\u5668\u7ba1\u7406\uff1b\u5176\u6b21\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u5fc5\u8d1f\u62c5\u4f20\u8f93\u7cfb\u7edf\u72b6\u6001\u6570\u636e\u7684\u4efb\u52a1\u3002\u4e00\u822c\u7edf\u79f0Mgmt\u7ba1\u7406\u7f51\u53e3\uff0c\u534e\u4e3a\u7684\u767d\u76ae\u4e66\u53ebiBMC\uff0c\u6234\u5c14\u53ebidrac\uff0c\u5176\u5b9e\u90fd\u662f\u517c\u5bb9ipmi\u534f\u8bae\u7684\u7f51\u53e3\u800c\u5df2~ BMC\u7cfb\u7edf\u72ec\u7acb\uff0c\u7ba1\u7406\u786c\u4ef6\uff08cpu\uff0c\u98ce\u6247\u7b49\u4fe1\u606f\uff09\uff0c\u6253\u5f00\u63a7\u5236\u53f0,\u6765\u8fdc\u7a0b\u7ba1\u7406\u6211\u4eec\u7684\u670d\u52a1\u5668\uff0c\u8ba9\u8fd0\u7ef4\u7684\u540c\u5b66\u5c11\u8dd1\u4e00\u4e07\u6b21\u7684\u673a\u623f\uff5e \u5b9e\u8df5 \u00b6 \u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e0b\u6211\u8fd9\u8fb9\u66d9\u5149GPU\u670d\u52a1\u5668\u7684\u5e26\u5916\u7ba1\u7406\u3002 $ ssh -L 3443 :192.168.2.x:443 routerx.c1 \u8fd9\u4e2a\u6211\u4eec\u662f\u7528\u53e6\u4e00\u53f0\u673a\u5668\u505a\u8df3\u677f\u624d\u80fd\u767b\u9646\uff0c\u6240\u4ee5\u9700\u8981\u6267\u884c\u4ee5\u4e0a\u547d\u4ee4\uff5e \u81ea\u5e26\u6d4f\u89c8\u8bbf\u95ee: https://127.0.0.1:3443 \u9700\u8981\u8f93\u5165\u5e10\u53f7\u5bc6\u7801 \u901a\u8fc7\u4ee5\u4e0a\u7684\u65b9\u5f0f,\u5c31\u53ef\u4ee5\u5bf9\u670d\u52a1\u5668\u8fdb\u884c\u91cd\u542f,\u5173\u673a,\u91cd\u88c5\u7cfb\u7edf\u7b49\u64cd\u4f5c~ \u9644\u4ef6 \u00b6 Linux\u914d\u7f6e apt-get install ipmitool ipmitool lan print # \u67e5\u770bBMC\u7684\u5730\u5740 ipmitool lan set 1 ipsrc static ipmitool lan set 1 ipaddr 192 .168.2.21 ipmitool lan set 1 netmask 255 .255.255.0 ipmitool lan set 1 defgw ipaddr 192 .168.2.1 Warning \u5e26\u5916\u7ba1\u7406\u662f\u8fd0\u7ef4\u4e2d\uff0c\u6bd4\u8f83\u91cd\u8981\u7684\u4e00\u4e2a\u6280\u80fd\uff0c\u53ef\u4ee5\u4e0d\u7528\u5728\u673a\u623f\u7ed9\u7cfb\u7edf\u91cd\u542f\uff0c\u548c\u5b89\u88c5\u7cfb\u7edf\u7b49\u5f88\u591a\u7684\u64cd\u4f5c","title":"Linux \u5e26\u5916\u7ba1\u7406"},{"location":"1.os/ubuntu/ubuntu-bmc-doc/#bmc","text":"","title":"\u670d\u52a1\u5668BMC\uff08\u5e26\u5916\uff09"},{"location":"1.os/ubuntu/ubuntu-bmc-doc/#_1","text":"\u670d\u52a1\u5668\u9664\u4e86\u88c5linux\uff0cwindows\u7cfb\u7edf\u5916\uff0c\u76f8\u5e94\u8fd8\u6709\u4e00\u4e2a\u53ef\u901a\u8fc7\u7f51\u7ebf\uff08\u670d\u52a1\u5668\u9ed8\u8ba4\u5e26\u5916\u5730\u5740--\u53ef\u6539\uff09\u8fde\u63a5\u5177\u4f53\u5382\u5546\u670d\u52a1\u5668\u7684BMC\uff08Baseboard Management Controller\uff0c\u57fa\u677f\u7ba1\u7406\u63a7\u5236\u5668\uff09 \u667a\u80fd\u5e73\u53f0\u7ba1\u7406\u63a5\u53e3 (IPMI) \u662f\u4e00\u79cd\u5f00\u653e\u6807\u51c6\u7684\u786c\u4ef6\u7ba1\u7406\u63a5\u53e3\u89c4\u683c\uff0c\u5b9a\u4e49\u4e86\u5d4c\u5165\u5f0f\u7ba1\u7406\u5b50\u7cfb\u7edf\u8fdb\u884c\u901a\u4fe1\u7684\u7279\u5b9a\u65b9\u6cd5\u3002IPMI \u4fe1\u606f\u901a\u8fc7\u57fa\u677f\u7ba1\u7406\u63a7\u5236\u5668 (BMC)\uff08\u4f4d\u4e8e IPMI \u89c4\u683c\u7684\u786c\u4ef6\u7ec4\u4ef6\u4e0a\uff09\u8fdb\u884c\u4ea4\u6d41\u3002\u4f7f\u7528\u4f4e\u7ea7\u786c\u4ef6\u667a\u80fd\u7ba1\u7406\u800c\u4e0d\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u884c\u7ba1\u7406\uff0c\u5177\u6709\u4e24\u4e2a\u4e3b\u8981\u4f18\u70b9\uff1a \u9996\u5148\uff0c\u6b64\u914d\u7f6e\u5141\u8bb8\u8fdb\u884c\u5e26\u5916\u670d\u52a1\u5668\u7ba1\u7406\uff1b\u5176\u6b21\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u5fc5\u8d1f\u62c5\u4f20\u8f93\u7cfb\u7edf\u72b6\u6001\u6570\u636e\u7684\u4efb\u52a1\u3002\u4e00\u822c\u7edf\u79f0Mgmt\u7ba1\u7406\u7f51\u53e3\uff0c\u534e\u4e3a\u7684\u767d\u76ae\u4e66\u53ebiBMC\uff0c\u6234\u5c14\u53ebidrac\uff0c\u5176\u5b9e\u90fd\u662f\u517c\u5bb9ipmi\u534f\u8bae\u7684\u7f51\u53e3\u800c\u5df2~ BMC\u7cfb\u7edf\u72ec\u7acb\uff0c\u7ba1\u7406\u786c\u4ef6\uff08cpu\uff0c\u98ce\u6247\u7b49\u4fe1\u606f\uff09\uff0c\u6253\u5f00\u63a7\u5236\u53f0,\u6765\u8fdc\u7a0b\u7ba1\u7406\u6211\u4eec\u7684\u670d\u52a1\u5668\uff0c\u8ba9\u8fd0\u7ef4\u7684\u540c\u5b66\u5c11\u8dd1\u4e00\u4e07\u6b21\u7684\u673a\u623f\uff5e","title":"\u7b80\u4ecb"},{"location":"1.os/ubuntu/ubuntu-bmc-doc/#_2","text":"\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e0b\u6211\u8fd9\u8fb9\u66d9\u5149GPU\u670d\u52a1\u5668\u7684\u5e26\u5916\u7ba1\u7406\u3002 $ ssh -L 3443 :192.168.2.x:443 routerx.c1 \u8fd9\u4e2a\u6211\u4eec\u662f\u7528\u53e6\u4e00\u53f0\u673a\u5668\u505a\u8df3\u677f\u624d\u80fd\u767b\u9646\uff0c\u6240\u4ee5\u9700\u8981\u6267\u884c\u4ee5\u4e0a\u547d\u4ee4\uff5e \u81ea\u5e26\u6d4f\u89c8\u8bbf\u95ee: https://127.0.0.1:3443 \u9700\u8981\u8f93\u5165\u5e10\u53f7\u5bc6\u7801 \u901a\u8fc7\u4ee5\u4e0a\u7684\u65b9\u5f0f,\u5c31\u53ef\u4ee5\u5bf9\u670d\u52a1\u5668\u8fdb\u884c\u91cd\u542f,\u5173\u673a,\u91cd\u88c5\u7cfb\u7edf\u7b49\u64cd\u4f5c~","title":"\u5b9e\u8df5"},{"location":"1.os/ubuntu/ubuntu-bmc-doc/#_3","text":"Linux\u914d\u7f6e apt-get install ipmitool ipmitool lan print # \u67e5\u770bBMC\u7684\u5730\u5740 ipmitool lan set 1 ipsrc static ipmitool lan set 1 ipaddr 192 .168.2.21 ipmitool lan set 1 netmask 255 .255.255.0 ipmitool lan set 1 defgw ipaddr 192 .168.2.1 Warning \u5e26\u5916\u7ba1\u7406\u662f\u8fd0\u7ef4\u4e2d\uff0c\u6bd4\u8f83\u91cd\u8981\u7684\u4e00\u4e2a\u6280\u80fd\uff0c\u53ef\u4ee5\u4e0d\u7528\u5728\u673a\u623f\u7ed9\u7cfb\u7edf\u91cd\u542f\uff0c\u548c\u5b89\u88c5\u7cfb\u7edf\u7b49\u5f88\u591a\u7684\u64cd\u4f5c","title":"\u9644\u4ef6"},{"location":"1.os/ubuntu/ubuntu-cli-doc/","text":"\u7cfb\u7edf\u547d\u4ee4 \u00b6 \u4e00\u3001Linux\u547d\u4ee4\u7684\u5206\u7c7b \u00b6 \u5185\u90e8\u547d\u4ee4\uff1a\u5c5e\u4e8eShell\u89e3\u91ca\u5668\u7684\u4e00\u90e8\u5206 \u5916\u90e8\u547d\u4ee4\uff1a\u72ec\u7acb\u4e8eShell\u89e3\u91ca\u5668\u4e4b\u5916\u7684\u7a0b\u5e8f \u5185\u90e8\u547d\u4ee4\u5c31\u662f\u7cfb\u7edf\u81ea\u5e26\u7684\uff0c\u5916\u90e8\u547d\u4ee4\u9700\u8981\u989d\u5916\u5355\u72ec\u6765\u7231\u7740\u4f60 3\u3001type\u547d\u4ee4\uff0c\u67e5\u770b\u547d\u4ee4\u662f\u5916\u90e8\u547d\u4ee4\u8fd8\u662f\u5185\u90e8\u547d\u4ee4\uff1a [root@www ~]# type cd cd is a shell builtin \u3010cd\u662f\u4e00\u4e2a\u5185\u90e8\u547d\u4ee4\u3011 [root@www ~]# type ifconfig ifconfig is /sbin/ifconfig \u3010ifconfig\u662f\u4e00\u4e2a\u5916\u90e8\u547d\u4ee4\u3011 \u4e8c\u3001Linux\u547d\u4ee4\u683c\u5f0f \u00b6 1\u3001Linux\u547d\u4ee4\u7684\u901a\u7528\u683c\u5f0f\uff1a\u547d\u4ee4\u5b57 [\u9009\u9879] [\u53c2\u6570] 2\u3001\u9009\u9879\uff1a\u7528\u4e8e\u8c03\u8282\u547d\u4ee4\u7684\u5177\u4f53\u529f\u80fd \u201c-\u201d\u5f15\u5bfc\u77ed\u683c\u5f0f\u9009\u9879\uff0c\u4f8b\u5982\u201cls -a\u201d \u201c--\u201d\u5f15\u5bfc\u957f\u683c\u5f0f\u9009\u9879\uff0c\u4f8b\u5982\u201cls --help\u201d \u6ce8\u610f\uff1a\u591a\u4e2a\u77ed\u683c\u5f0f\u9009\u9879\u53ef\u4ee5\u5408\u5e76\uff0c\u4f8b\u5982\u201cls -alh\u201d \u4f46\u662f\u591a\u4e2a\u957f\u683c\u5f0f\u9009\u9879\uff0c\u4e0d\u80fd\u5408\u5e76\u3002 3\u3001\u53c2\u6570\uff1a\u547d\u4ee4\u7684\u5bf9\u8c61\uff0c\u5982\u6587\u4ef6\u3001\u76ee\u5f55\u540d\u7b49 \u4f8b\u5982\uff1a[root@www ~]# ls -alh /etc ls\u2014\u2014\u547d\u4ee4\u5b57\uff1b-alh\u2014\u2014\u9009\u9879\uff1b/etc\u2014\u2014\u53c2\u6570 \u4e09\u3001\u547d\u4ee4\u5feb\u6377\u952e \u00b6 \u2022 tab\u952e\uff1a\u81ea\u52a8\u8865\u9f50\u6587\u4ef6\u540d\uff0c\u547d\u4ee4\u7b49\uff1b\u6309\u4e24\u6b21tab\u952e\uff0c\u7cfb\u7edf\u5c06\u8f93\u51fa\u53ef\u7528\u7684\u6240\u6709\u540d\u79f0\u5217\u8868\u3002 \u2022 \u53cd\u659c\u6760\u201c\\\u201d:\u5f3a\u884c\u6362\u884c \u2022 ctrl+U\uff1a\u5feb\u901f\u5220\u9664\u5149\u6807\u4e4b\u524d\u6240\u6709\u5b57\u7b26\uff08\u53ef\u89c6\u4e3a\u526a\u5207\uff09 \u2022 ctrl+K\uff1a\u5feb\u901f\u5220\u9664\u5149\u6807\u4e4b\u540e\u6240\u6709\u5b57\u7b26\uff08\u53ef\u89c6\u4e3a\u526a\u5207\uff09 \u2022 ctrl+Y\uff1a\u9ecf\u8d34\u521a\u624d\u6240\u5220\u9664\uff08\u526a\u5207\uff09\u7684\u5b57\u7b26 \u2022 ctrl+L\uff1a\u6e05\u5c4f \u2022 ctrl+C\uff1a\u53d6\u6d88\u5f53\u524d\u547d\u4ee4\u884c\u7f16\u8f91\uff1b\u7ed3\u675f\u5f53\u524d\u6267\u884c\u7684\u547d\u4ee4 \u2022 ctrl+D\uff1a\u4eceshell\u63d0\u793a\u4e2d\u6ce8\u9500\u5173\u95ed\uff0c\u7c7b\u4f3c\u8f93\u5165exit \u2022 ctrl+A\uff1a\u628a\u5149\u6807\u79fb\u52a8\u5230\u884c\u9996\uff0c\u7c7b\u4f3c\u4e8eHome\u952e \u2022 ctrl+E\uff1a\u628a\u5149\u6807\u79fb\u52a8\u5230\u884c\u5c3e\uff0c\u7c7b\u4f3c\u4e8eEnd\u952e \u2022 ctrl+Z\uff1a\u8f6c\u5165\u540e\u53f0\u8fd0\u884c \u2022 ctrl+R\uff1a\u5728\u5386\u53f2\u547d\u4ee4\u4e2d\u67e5\u627e\uff08\u5e38\u7528\u5e76\u4e14\u5f88\u597d\u7528\uff09 \u56db\u3001\u5e2e\u52a9\u547d\u4ee4 \u00b6 1\u3001help\u5185\u90e8\u547d\u4ee4\u5e2e\u52a9\uff0c\u67e5\u770bbash\u5185\u90e8\u547d\u4ee4\u7684\u5e2e\u52a9 \u7528\u6cd51\uff1ahelp \u5185\u90e8\u547d\u4ee4\u5b57 [root@www ~]# help cd \u7528\u6cd52\uff1a\u547d\u4ee4\u5b57 --help \u5373\u547d\u4ee4\u7684\u201c--help\u201d\u9009\u9879\uff0c\u9002\u7528\u4e8e\u5927\u591a\u6570\u5916\u90e8\u547d\u4ee4 [root@www ~]# ls --help 2\u3001man\u7528\u6765\u63d0\u4f9b\u5728\u7ebf\u5e2e\u52a9\uff0c\u4f7f\u7528\u6743\u9650\u662f\u6240\u6709\u7528\u6237\u3002\u5728Linux\u7cfb\u7edf\u4e2d\u5b58\u50a8\u7740\u4e00\u90e8\u8054\u673a\u4f7f\u7528\u7684\u624b\u518c\uff0c\u4ee5\u4f9b\u7528\u6237\u5728\u7ec8\u7aef\u4e0a\u67e5\u627e\u3002\u4f7f\u7528man\u547d\u4ee4\u53ef\u4ee5\u8c03\u9605\u5176\u4e2d\u7684\u5e2e\u52a9\u4fe1\u606f\uff0c\u975e\u5e38\u65b9\u4fbf\u5b9e\u7528\u3002 \uff081\uff09\u7528\u6cd5\uff1aman \u547d\u4ee4\u5b57 man [-acdfhkKtwW] [-m system] [-p string] [-C config\\_file] [-Mpath] [-P pager] [-S section\\_list][section] name ... \uff082\uff09\u793a\u4f8b\uff1a [root@www ~]# man ls \uff083\uff09\u53c2\u6570 -C config_file\uff1a\u6307\u5b9a\u8bbe\u5b9a\u6587\u4ef6man.conf\uff0c\u7f3a\u7701\u503c\u662f/etc/man.conf\u3002 [root@www ~]# man 1 man [root@www ~]# man 7 man \u4e94\u3001ls\uff08list\uff09\u547d\u4ee4\u8be6\u89e3 \u00b6 1\u3001\u4f5c\u7528\uff1a\u5217\u8868\u663e\u793a\u76ee\u5f55\u5185\u7684\u6587\u4ef6\u53ca\u76ee\u5f55\uff0c\u7ed3\u5408\u4e0d\u540c\u9009\u9879\u5b9e\u73b0\u4e0d\u540c\u7684\u4f5c\u7528\u3002 2\u3001\u683c\u5f0f\uff1als [\u9009\u9879] \u76ee\u5f55\u6216\u6587\u4ef6\u540d 3\u3001\u5e38\u7528\u9009\u9879\uff1a -l\uff1a\u4ee5\u957f\u683c\u5f0f\uff08long\uff09\u663e\u793a\u6587\u4ef6\u548c\u76ee\u5f55\u7684\u5217\u8868 -a\uff1a\u663e\u793a\u6240\u6709\uff08all\uff09\u5b50\u76ee\u5f55\u548c\u6587\u4ef6\u7684\u4fe1\u606f -A\uff1a\u4e0e-a\u57fa\u672c\u7c7b\u4f3c\uff0c\u4f46\u6709\u4e24\u4e2a\u7279\u6b8a\u9690\u85cf\u76ee\u5f55\u201c.\u201d\u548c\u201c..\u201d\u4e0d\u663e\u793a -d\uff1a\u663e\u793a\u76ee\u5f55\uff08directory\uff09\u672c\u8eab\u7684\u5c5e\u6027\uff0c\u5e38\u4e0e-l\u540c\u65f6\u4f7f\u7528 -h\uff1a\u4ee5\u66f4\u4eba\u6027\u5316\uff08human\uff09\u7684\u65b9\u5f0f\u663e\u793a\u51fa\u76ee\u5f55\u6216\u6587\u4ef6\u7684\u5927\u5c0f\uff0c\u5e38\u4e0e-l\u540c\u65f6\u4f7f\u7528 -R\uff1a\u4ee5\u9012\u5f52\uff08recursive\uff09\u7684\u65b9\u5f0f\u663e\u793a\u76ee\u5f55\u53ca\u5176\u5b50\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u5185\u5bb9 \u516d\u3001du\uff08disk usage\uff09\u547d\u4ee4\u8be6\u89e3 \u00b6 1\u3001\u4f5c\u7528\uff1a\u7528\u4e8e\u7edf\u8ba1\u5236\u5b9a\u76ee\u5f55\u6216\u6587\u4ef6\u6240\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\u7684\u5927\u5c0f 2\u3001\u683c\u5f0f\uff1adu [\u9009\u9879] \u76ee\u5f55\u6216\u6587\u4ef6\u540d 3\u3001\u5e38\u89c1\u9009\u9879\uff1a -a\uff1a\u7edf\u8ba1\u78c1\u76d8\u7a7a\u95f4\u5360\u7528\u65f6\u6240\u6709\u7684\u6587\u4ef6\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u7edf\u8ba1\u76ee\u5f55 -s\uff1a\u53ea\u7edf\u8ba1\u6240\u5360\u7528\u7a7a\u95f4\u603b\u7684\uff08summary\uff09\u5927\u5c0f \u4e03\u3001touch\u547d\u4ee4 \u00b6 1\u3001\u4f5c\u7528\uff1a\u521b\u5efa\u7a7a\u6587\u4ef6\uff0c\u7528\u4e8e\u6d4b\u8bd5\u3002\u82e5\u5f53\u524d\u6587\u4ef6\u5df2\u5b58\u5728\u65f6\uff0c\u5c06\u66f4\u65b0\u8be5\u6587\u4ef6\u7684\u65f6\u95f4\u6233 2\u3001\u683c\u5f0f\uff1atouch \u6587\u4ef6\u540d \u516b\u3001mkdir\uff08make directory\uff09\u547d\u4ee4 \u00b6 1\u3001\u4f5c\u7528\uff1a\u521b\u5efa\u65b0\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1amkdir [\u9009\u9879] \u76ee\u5f55\u4f4d\u7f6e\u53ca\u540d\u79f0 3\u3001\u5e38\u7528\u9009\u9879\uff1a -p \u4e00\u6b21\u6027\u521b\u5efa\u5d4c\u5957\u7684\u591a\u5c42\u76ee\u5f55 -v \u663e\u793a\u8be6\u7ec6 -m \u8df3\u51fa\u5f53\u524d\u7684umask\u503c \u4e5d\u3001cp\uff08copy\uff09\u547d\u4ee4 \u00b6 1\u3001\u4f5c\u7528\uff1a\u590d\u5236\u6587\u4ef6\u6216\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1acp [\u9009\u9879] \u6e90\u6587\u4ef6\u6216\u76ee\u5f55 \u76ee\u6807\u6587\u4ef6\u6216\u76ee\u5f55 3\u3001\u5e38\u7528\u9009\u9879\uff1a -f \u8986\u76d6\u540c\u540d\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5f3a\u5236\uff08force\uff09\u590d\u5236 -i \u63d0\u9192\u7528\u6237\u786e\u8ba4\uff08interactive\uff0c\u4ea4\u4e92\u5f0f\uff09 -p \u4fdd\u6301\uff08preserve\uff09\u6e90\u6587\u4ef6\u6743\u9650\u3001\u5c5e\u6027\u3001\u5c5e\u4e3b\u53ca\u65f6\u95f4\u6807\u8bb0\u7b49\u4e0d\u53d8 -r \u9012\u5f52\uff08recursive\uff09\u590d\u5236 4\u3001\u793a\u4f8b\uff1a \u5341\u3001rm\uff08remove\uff09\u547d\u4ee4 \u00b6 1\u3001\u4f5c\u7528\uff1a\u5220\u9664\u5236\u5b9a\u7684\u6587\u4ef6\u6216\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1arm [\u9009\u9879] \u8981\u5220\u9664\u7684\u6587\u4ef6\u6216\u76ee\u5f55 3\u3001\u5e38\u7528\u9009\u9879\uff1a -f \u4e0d\u63d0\u793a\uff0c\u76f4\u63a5\u5f3a\u5236\u5220\u9664 -i \u63d0\u793a\u7528\u6237\u786e\u8ba4 -r \u9012\u5f52\u5f0f\u5220\u9664\u6574\u4e2a\u76ee\u5f55\u6811 4\u3001\u793a\u4f8b\uff1a [root@www /]# rm -rf test \u3010\u6b64\u547d\u4ee4\u5371\u9669\uff0c\u5efa\u8bae\u8fdb\u5165\u5230\u6587\u4ef6\u5939\u540e\u5220\u9664\u3011 \u5efa\u8bae\u5982\u4e0b\u64cd\u4f5c\uff1a [root@www /]# cd test/ [root@www test]# rm -rf * \u5341\u4e00\u3001mv\uff08move\uff09\u547d\u4ee4 \u00b6 1\u3001\u4f5c\u7528\uff1a\u5c06\u6307\u5b9a\u6587\u4ef6\u6216\u76ee\u5f55\u8f6c\u79fb\u4f4d\u7f6e\uff08\u526a\u5207\uff09\uff0c\u5982\u679c\u76ee\u6807\u4f4d\u7f6e\u4e0e\u6e90\u4f4d\u7f6e\u76f8\u540c\uff0c\u5219\u76f8\u5f53\u4e8e\u6267\u884c\u91cd\u547d\u540d\u64cd\u4f5c 2\u3001\u683c\u5f0f\uff1amv [\u9009\u9879] \u6e90\u6587\u4ef6\u6216\u76ee\u5f55 \u76ee\u6807\u6587\u4ef6\u6216\u76ee\u5f55 3\u3001\u793a\u4f8b\uff1a \u5341\u4e8c\u3001which\u547d\u4ee4 \u00b6 1\u3001\u4f5c\u7528\uff1a\u67e5\u627eLinux\u547d\u4ee4\u7a0b\u5e8f\u6240\u5728\u7684\u4f4d\u7f6e 2\u3001\u683c\u5f0f\uff1awhich \u547d\u4ee4|\u7a0b\u5e8f\u540d 3\u3001\u793a\u4f8b\uff1a [root@www ~]# which du /usr/bin/du \u6ce8\u610f\uff1a\u9ed8\u8ba4\u5f53\u53ea\u71ac\u5230\u7b2c\u4e00\u4e2a\u76ee\u6807\u540e\u4e0d\u518d\u7ee7\u7eed\u67e5\u627e\uff0c\u82e5\u9700\u67e5\u627e\u5168\u90e8\uff0c\u52a0\u9009\u9879-a\u3002 \u5341\u4e09\u3001find\u547d\u4ee4 \u00b6 1\u3001\u4f5c\u7528\uff1a\u7cbe\u7ec6\u67e5\u627e\u6587\u4ef6\u6216\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1afind [\u67e5\u627e\u8303\u56f4] [\u67e5\u627e\u6761\u4ef6\u8868\u8fbe\u5f0f] 3\u3001\u5e38\u7528\u67e5\u627e\u6761\u4ef6\uff1a -name \u6309\u540d\u79f0\u67e5\u627e \u4f8b\uff1afind /etc \u2013name \u201cresol*.conf\u201d -size \u6309\u5927\u5c0f\u67e5\u627e \u4f8b\uff1afind /etc \u2013size +1M \u3010k\uff0cM\uff0cG\u3011 -user \u6309\u5c5e\u6027\u67e5\u627e \u4f8b\uff1afind /etc \u2013user root -type \u6309\u7c7b\u578b\u67e5\u627e \u4f8b\uff1afind /boot \u2013type d \u3010d\u76ee\u5f55\uff1bf\u666e\u901a\u6587\u4ef6\uff1bb\u5757\u8bbe\u5907\uff1bc\u5b57 \u7b26\u8bbe\u5907\u6587\u4ef6\u3011 4\u3001\u903b\u8f91\u8fd0\u7b97\u7b26 \uff081\uff09-a \uff08and\uff09\u903b\u8f91\u201c\u4e0e\u201d\u8fd0\u7b97 [root@www ~]# find /boot -size +1M -a -name \"vm*\" /boot/vmlinuz-2.6.32-431.el6.x86_64 \uff082\uff09-o \uff08or\uff09\u903b\u8f91\u201c\u6216\u201d\u8fd0\u7b97 [root@www ~]# find /boot -size +1M -o -name \"vm*\" /boot/vmlinuz-2.6.32-431.el6.x86_64 /boot/initramfs-2.6.32-431.el6.x86_64.img /boot/System.map-2.6.32-431.el6.x86_64 PAGE \\* MERGEFORMAT 6","title":"Linux \u7cfb\u7edf\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#_1","text":"","title":"\u7cfb\u7edf\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#linux","text":"\u5185\u90e8\u547d\u4ee4\uff1a\u5c5e\u4e8eShell\u89e3\u91ca\u5668\u7684\u4e00\u90e8\u5206 \u5916\u90e8\u547d\u4ee4\uff1a\u72ec\u7acb\u4e8eShell\u89e3\u91ca\u5668\u4e4b\u5916\u7684\u7a0b\u5e8f \u5185\u90e8\u547d\u4ee4\u5c31\u662f\u7cfb\u7edf\u81ea\u5e26\u7684\uff0c\u5916\u90e8\u547d\u4ee4\u9700\u8981\u989d\u5916\u5355\u72ec\u6765\u7231\u7740\u4f60 3\u3001type\u547d\u4ee4\uff0c\u67e5\u770b\u547d\u4ee4\u662f\u5916\u90e8\u547d\u4ee4\u8fd8\u662f\u5185\u90e8\u547d\u4ee4\uff1a [root@www ~]# type cd cd is a shell builtin \u3010cd\u662f\u4e00\u4e2a\u5185\u90e8\u547d\u4ee4\u3011 [root@www ~]# type ifconfig ifconfig is /sbin/ifconfig \u3010ifconfig\u662f\u4e00\u4e2a\u5916\u90e8\u547d\u4ee4\u3011","title":"\u4e00\u3001Linux\u547d\u4ee4\u7684\u5206\u7c7b"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#linux_1","text":"1\u3001Linux\u547d\u4ee4\u7684\u901a\u7528\u683c\u5f0f\uff1a\u547d\u4ee4\u5b57 [\u9009\u9879] [\u53c2\u6570] 2\u3001\u9009\u9879\uff1a\u7528\u4e8e\u8c03\u8282\u547d\u4ee4\u7684\u5177\u4f53\u529f\u80fd \u201c-\u201d\u5f15\u5bfc\u77ed\u683c\u5f0f\u9009\u9879\uff0c\u4f8b\u5982\u201cls -a\u201d \u201c--\u201d\u5f15\u5bfc\u957f\u683c\u5f0f\u9009\u9879\uff0c\u4f8b\u5982\u201cls --help\u201d \u6ce8\u610f\uff1a\u591a\u4e2a\u77ed\u683c\u5f0f\u9009\u9879\u53ef\u4ee5\u5408\u5e76\uff0c\u4f8b\u5982\u201cls -alh\u201d \u4f46\u662f\u591a\u4e2a\u957f\u683c\u5f0f\u9009\u9879\uff0c\u4e0d\u80fd\u5408\u5e76\u3002 3\u3001\u53c2\u6570\uff1a\u547d\u4ee4\u7684\u5bf9\u8c61\uff0c\u5982\u6587\u4ef6\u3001\u76ee\u5f55\u540d\u7b49 \u4f8b\u5982\uff1a[root@www ~]# ls -alh /etc ls\u2014\u2014\u547d\u4ee4\u5b57\uff1b-alh\u2014\u2014\u9009\u9879\uff1b/etc\u2014\u2014\u53c2\u6570","title":"\u4e8c\u3001Linux\u547d\u4ee4\u683c\u5f0f"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#_2","text":"\u2022 tab\u952e\uff1a\u81ea\u52a8\u8865\u9f50\u6587\u4ef6\u540d\uff0c\u547d\u4ee4\u7b49\uff1b\u6309\u4e24\u6b21tab\u952e\uff0c\u7cfb\u7edf\u5c06\u8f93\u51fa\u53ef\u7528\u7684\u6240\u6709\u540d\u79f0\u5217\u8868\u3002 \u2022 \u53cd\u659c\u6760\u201c\\\u201d:\u5f3a\u884c\u6362\u884c \u2022 ctrl+U\uff1a\u5feb\u901f\u5220\u9664\u5149\u6807\u4e4b\u524d\u6240\u6709\u5b57\u7b26\uff08\u53ef\u89c6\u4e3a\u526a\u5207\uff09 \u2022 ctrl+K\uff1a\u5feb\u901f\u5220\u9664\u5149\u6807\u4e4b\u540e\u6240\u6709\u5b57\u7b26\uff08\u53ef\u89c6\u4e3a\u526a\u5207\uff09 \u2022 ctrl+Y\uff1a\u9ecf\u8d34\u521a\u624d\u6240\u5220\u9664\uff08\u526a\u5207\uff09\u7684\u5b57\u7b26 \u2022 ctrl+L\uff1a\u6e05\u5c4f \u2022 ctrl+C\uff1a\u53d6\u6d88\u5f53\u524d\u547d\u4ee4\u884c\u7f16\u8f91\uff1b\u7ed3\u675f\u5f53\u524d\u6267\u884c\u7684\u547d\u4ee4 \u2022 ctrl+D\uff1a\u4eceshell\u63d0\u793a\u4e2d\u6ce8\u9500\u5173\u95ed\uff0c\u7c7b\u4f3c\u8f93\u5165exit \u2022 ctrl+A\uff1a\u628a\u5149\u6807\u79fb\u52a8\u5230\u884c\u9996\uff0c\u7c7b\u4f3c\u4e8eHome\u952e \u2022 ctrl+E\uff1a\u628a\u5149\u6807\u79fb\u52a8\u5230\u884c\u5c3e\uff0c\u7c7b\u4f3c\u4e8eEnd\u952e \u2022 ctrl+Z\uff1a\u8f6c\u5165\u540e\u53f0\u8fd0\u884c \u2022 ctrl+R\uff1a\u5728\u5386\u53f2\u547d\u4ee4\u4e2d\u67e5\u627e\uff08\u5e38\u7528\u5e76\u4e14\u5f88\u597d\u7528\uff09","title":"\u4e09\u3001\u547d\u4ee4\u5feb\u6377\u952e"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#_3","text":"1\u3001help\u5185\u90e8\u547d\u4ee4\u5e2e\u52a9\uff0c\u67e5\u770bbash\u5185\u90e8\u547d\u4ee4\u7684\u5e2e\u52a9 \u7528\u6cd51\uff1ahelp \u5185\u90e8\u547d\u4ee4\u5b57 [root@www ~]# help cd \u7528\u6cd52\uff1a\u547d\u4ee4\u5b57 --help \u5373\u547d\u4ee4\u7684\u201c--help\u201d\u9009\u9879\uff0c\u9002\u7528\u4e8e\u5927\u591a\u6570\u5916\u90e8\u547d\u4ee4 [root@www ~]# ls --help 2\u3001man\u7528\u6765\u63d0\u4f9b\u5728\u7ebf\u5e2e\u52a9\uff0c\u4f7f\u7528\u6743\u9650\u662f\u6240\u6709\u7528\u6237\u3002\u5728Linux\u7cfb\u7edf\u4e2d\u5b58\u50a8\u7740\u4e00\u90e8\u8054\u673a\u4f7f\u7528\u7684\u624b\u518c\uff0c\u4ee5\u4f9b\u7528\u6237\u5728\u7ec8\u7aef\u4e0a\u67e5\u627e\u3002\u4f7f\u7528man\u547d\u4ee4\u53ef\u4ee5\u8c03\u9605\u5176\u4e2d\u7684\u5e2e\u52a9\u4fe1\u606f\uff0c\u975e\u5e38\u65b9\u4fbf\u5b9e\u7528\u3002 \uff081\uff09\u7528\u6cd5\uff1aman \u547d\u4ee4\u5b57 man [-acdfhkKtwW] [-m system] [-p string] [-C config\\_file] [-Mpath] [-P pager] [-S section\\_list][section] name ... \uff082\uff09\u793a\u4f8b\uff1a [root@www ~]# man ls \uff083\uff09\u53c2\u6570 -C config_file\uff1a\u6307\u5b9a\u8bbe\u5b9a\u6587\u4ef6man.conf\uff0c\u7f3a\u7701\u503c\u662f/etc/man.conf\u3002 [root@www ~]# man 1 man [root@www ~]# man 7 man","title":"\u56db\u3001\u5e2e\u52a9\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#lslist","text":"1\u3001\u4f5c\u7528\uff1a\u5217\u8868\u663e\u793a\u76ee\u5f55\u5185\u7684\u6587\u4ef6\u53ca\u76ee\u5f55\uff0c\u7ed3\u5408\u4e0d\u540c\u9009\u9879\u5b9e\u73b0\u4e0d\u540c\u7684\u4f5c\u7528\u3002 2\u3001\u683c\u5f0f\uff1als [\u9009\u9879] \u76ee\u5f55\u6216\u6587\u4ef6\u540d 3\u3001\u5e38\u7528\u9009\u9879\uff1a -l\uff1a\u4ee5\u957f\u683c\u5f0f\uff08long\uff09\u663e\u793a\u6587\u4ef6\u548c\u76ee\u5f55\u7684\u5217\u8868 -a\uff1a\u663e\u793a\u6240\u6709\uff08all\uff09\u5b50\u76ee\u5f55\u548c\u6587\u4ef6\u7684\u4fe1\u606f -A\uff1a\u4e0e-a\u57fa\u672c\u7c7b\u4f3c\uff0c\u4f46\u6709\u4e24\u4e2a\u7279\u6b8a\u9690\u85cf\u76ee\u5f55\u201c.\u201d\u548c\u201c..\u201d\u4e0d\u663e\u793a -d\uff1a\u663e\u793a\u76ee\u5f55\uff08directory\uff09\u672c\u8eab\u7684\u5c5e\u6027\uff0c\u5e38\u4e0e-l\u540c\u65f6\u4f7f\u7528 -h\uff1a\u4ee5\u66f4\u4eba\u6027\u5316\uff08human\uff09\u7684\u65b9\u5f0f\u663e\u793a\u51fa\u76ee\u5f55\u6216\u6587\u4ef6\u7684\u5927\u5c0f\uff0c\u5e38\u4e0e-l\u540c\u65f6\u4f7f\u7528 -R\uff1a\u4ee5\u9012\u5f52\uff08recursive\uff09\u7684\u65b9\u5f0f\u663e\u793a\u76ee\u5f55\u53ca\u5176\u5b50\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u5185\u5bb9","title":"\u4e94\u3001ls\uff08list\uff09\u547d\u4ee4\u8be6\u89e3"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#dudisk-usage","text":"1\u3001\u4f5c\u7528\uff1a\u7528\u4e8e\u7edf\u8ba1\u5236\u5b9a\u76ee\u5f55\u6216\u6587\u4ef6\u6240\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\u7684\u5927\u5c0f 2\u3001\u683c\u5f0f\uff1adu [\u9009\u9879] \u76ee\u5f55\u6216\u6587\u4ef6\u540d 3\u3001\u5e38\u89c1\u9009\u9879\uff1a -a\uff1a\u7edf\u8ba1\u78c1\u76d8\u7a7a\u95f4\u5360\u7528\u65f6\u6240\u6709\u7684\u6587\u4ef6\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u7edf\u8ba1\u76ee\u5f55 -s\uff1a\u53ea\u7edf\u8ba1\u6240\u5360\u7528\u7a7a\u95f4\u603b\u7684\uff08summary\uff09\u5927\u5c0f","title":"\u516d\u3001du\uff08disk usage\uff09\u547d\u4ee4\u8be6\u89e3"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#touch","text":"1\u3001\u4f5c\u7528\uff1a\u521b\u5efa\u7a7a\u6587\u4ef6\uff0c\u7528\u4e8e\u6d4b\u8bd5\u3002\u82e5\u5f53\u524d\u6587\u4ef6\u5df2\u5b58\u5728\u65f6\uff0c\u5c06\u66f4\u65b0\u8be5\u6587\u4ef6\u7684\u65f6\u95f4\u6233 2\u3001\u683c\u5f0f\uff1atouch \u6587\u4ef6\u540d","title":"\u4e03\u3001touch\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#mkdirmake-directory","text":"1\u3001\u4f5c\u7528\uff1a\u521b\u5efa\u65b0\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1amkdir [\u9009\u9879] \u76ee\u5f55\u4f4d\u7f6e\u53ca\u540d\u79f0 3\u3001\u5e38\u7528\u9009\u9879\uff1a -p \u4e00\u6b21\u6027\u521b\u5efa\u5d4c\u5957\u7684\u591a\u5c42\u76ee\u5f55 -v \u663e\u793a\u8be6\u7ec6 -m \u8df3\u51fa\u5f53\u524d\u7684umask\u503c","title":"\u516b\u3001mkdir\uff08make directory\uff09\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#cpcopy","text":"1\u3001\u4f5c\u7528\uff1a\u590d\u5236\u6587\u4ef6\u6216\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1acp [\u9009\u9879] \u6e90\u6587\u4ef6\u6216\u76ee\u5f55 \u76ee\u6807\u6587\u4ef6\u6216\u76ee\u5f55 3\u3001\u5e38\u7528\u9009\u9879\uff1a -f \u8986\u76d6\u540c\u540d\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5f3a\u5236\uff08force\uff09\u590d\u5236 -i \u63d0\u9192\u7528\u6237\u786e\u8ba4\uff08interactive\uff0c\u4ea4\u4e92\u5f0f\uff09 -p \u4fdd\u6301\uff08preserve\uff09\u6e90\u6587\u4ef6\u6743\u9650\u3001\u5c5e\u6027\u3001\u5c5e\u4e3b\u53ca\u65f6\u95f4\u6807\u8bb0\u7b49\u4e0d\u53d8 -r \u9012\u5f52\uff08recursive\uff09\u590d\u5236 4\u3001\u793a\u4f8b\uff1a","title":"\u4e5d\u3001cp\uff08copy\uff09\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#rmremove","text":"1\u3001\u4f5c\u7528\uff1a\u5220\u9664\u5236\u5b9a\u7684\u6587\u4ef6\u6216\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1arm [\u9009\u9879] \u8981\u5220\u9664\u7684\u6587\u4ef6\u6216\u76ee\u5f55 3\u3001\u5e38\u7528\u9009\u9879\uff1a -f \u4e0d\u63d0\u793a\uff0c\u76f4\u63a5\u5f3a\u5236\u5220\u9664 -i \u63d0\u793a\u7528\u6237\u786e\u8ba4 -r \u9012\u5f52\u5f0f\u5220\u9664\u6574\u4e2a\u76ee\u5f55\u6811 4\u3001\u793a\u4f8b\uff1a [root@www /]# rm -rf test \u3010\u6b64\u547d\u4ee4\u5371\u9669\uff0c\u5efa\u8bae\u8fdb\u5165\u5230\u6587\u4ef6\u5939\u540e\u5220\u9664\u3011 \u5efa\u8bae\u5982\u4e0b\u64cd\u4f5c\uff1a [root@www /]# cd test/ [root@www test]# rm -rf *","title":"\u5341\u3001rm\uff08remove\uff09\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#mvmove","text":"1\u3001\u4f5c\u7528\uff1a\u5c06\u6307\u5b9a\u6587\u4ef6\u6216\u76ee\u5f55\u8f6c\u79fb\u4f4d\u7f6e\uff08\u526a\u5207\uff09\uff0c\u5982\u679c\u76ee\u6807\u4f4d\u7f6e\u4e0e\u6e90\u4f4d\u7f6e\u76f8\u540c\uff0c\u5219\u76f8\u5f53\u4e8e\u6267\u884c\u91cd\u547d\u540d\u64cd\u4f5c 2\u3001\u683c\u5f0f\uff1amv [\u9009\u9879] \u6e90\u6587\u4ef6\u6216\u76ee\u5f55 \u76ee\u6807\u6587\u4ef6\u6216\u76ee\u5f55 3\u3001\u793a\u4f8b\uff1a","title":"\u5341\u4e00\u3001mv\uff08move\uff09\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#which","text":"1\u3001\u4f5c\u7528\uff1a\u67e5\u627eLinux\u547d\u4ee4\u7a0b\u5e8f\u6240\u5728\u7684\u4f4d\u7f6e 2\u3001\u683c\u5f0f\uff1awhich \u547d\u4ee4|\u7a0b\u5e8f\u540d 3\u3001\u793a\u4f8b\uff1a [root@www ~]# which du /usr/bin/du \u6ce8\u610f\uff1a\u9ed8\u8ba4\u5f53\u53ea\u71ac\u5230\u7b2c\u4e00\u4e2a\u76ee\u6807\u540e\u4e0d\u518d\u7ee7\u7eed\u67e5\u627e\uff0c\u82e5\u9700\u67e5\u627e\u5168\u90e8\uff0c\u52a0\u9009\u9879-a\u3002","title":"\u5341\u4e8c\u3001which\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-cli-doc/#find","text":"1\u3001\u4f5c\u7528\uff1a\u7cbe\u7ec6\u67e5\u627e\u6587\u4ef6\u6216\u76ee\u5f55 2\u3001\u683c\u5f0f\uff1afind [\u67e5\u627e\u8303\u56f4] [\u67e5\u627e\u6761\u4ef6\u8868\u8fbe\u5f0f] 3\u3001\u5e38\u7528\u67e5\u627e\u6761\u4ef6\uff1a -name \u6309\u540d\u79f0\u67e5\u627e \u4f8b\uff1afind /etc \u2013name \u201cresol*.conf\u201d -size \u6309\u5927\u5c0f\u67e5\u627e \u4f8b\uff1afind /etc \u2013size +1M \u3010k\uff0cM\uff0cG\u3011 -user \u6309\u5c5e\u6027\u67e5\u627e \u4f8b\uff1afind /etc \u2013user root -type \u6309\u7c7b\u578b\u67e5\u627e \u4f8b\uff1afind /boot \u2013type d \u3010d\u76ee\u5f55\uff1bf\u666e\u901a\u6587\u4ef6\uff1bb\u5757\u8bbe\u5907\uff1bc\u5b57 \u7b26\u8bbe\u5907\u6587\u4ef6\u3011 4\u3001\u903b\u8f91\u8fd0\u7b97\u7b26 \uff081\uff09-a \uff08and\uff09\u903b\u8f91\u201c\u4e0e\u201d\u8fd0\u7b97 [root@www ~]# find /boot -size +1M -a -name \"vm*\" /boot/vmlinuz-2.6.32-431.el6.x86_64 \uff082\uff09-o \uff08or\uff09\u903b\u8f91\u201c\u6216\u201d\u8fd0\u7b97 [root@www ~]# find /boot -size +1M -o -name \"vm*\" /boot/vmlinuz-2.6.32-431.el6.x86_64 /boot/initramfs-2.6.32-431.el6.x86_64.img /boot/System.map-2.6.32-431.el6.x86_64 PAGE \\* MERGEFORMAT 6","title":"\u5341\u4e09\u3001find\u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-disk-doc/","text":"\u516d: Linux\u7cfb\u7edf\u7ba1\u7406-\u78c1\u76d8\u7ba1\u7406 \u00b6 6.1. \u78c1\u76d8\u7ed3\u6784 \u00b6 \u786c\u76d8\u7684\u7269\u7406\u7ed3\u6784 \u76d8\u7247: \u786c\u76d8\u6709\u591a\u4e2a\u76d8\u7247\uff0c\u6bcf\u4e2a\u76d8\u72472\u9762 \u78c1\u5934: \u6bcf\u9762\u4e00\u4e2a\u78c1\u5934 \u786c\u76d8\u7684\u6570\u636e\u7ed3\u6784 \u6247\u533a: \u76d8\u7247\u88ab\u5206\u4e3a\u591a\u4e2a\u6247\u5f62\u533a\u57df\uff0c\u6bcf\u4e2a\u6247\u5f62\u533a\u5b58\u653e512\u5b57\u8282\u7684\u6570\u636e \u78c1\u9053:\u7edf\u4e00\u76d8\u7247\u4e0d\u540c\u534a\u5f84\u7684\u540c\u5fc3\u5706 \u67f1\u9762:\u4e0d\u540c\u76d8\u7247\u76f8\u540c\u534a\u5f84\u6784\u6210\u7684\u5706\u67f1\u9762 6.2. \u78c1\u76d8\u63a5\u53e3 \u00b6 IDE\uff08\u5e76\u53e3\uff09 SATA\uff08\u4e32\u53e3\uff09 \u901f\u5ea6\u5feb \u7ea0\u9519\u80fd\u529b\u5f3a SCSI 6.3. MBR \u00b6 \u5b9a\u4e49: MBR \u4e3b\u5f15\u5bfc\u8bb0\u5f55 \u4f4d\u7f6e: MBR \u4f4d\u4e8e\u786c\u76d8\u7b2c\u4e00\u4e2a\u7269\u7406\u6247\u533a\u5904 6.4. \u78c1\u76d8\u5206\u533a\u8868\u793a \u00b6","title":"Linux \u78c1\u76d8\u7ba1\u7406"},{"location":"1.os/ubuntu/ubuntu-disk-doc/#linux-","text":"","title":"\u516d: Linux\u7cfb\u7edf\u7ba1\u7406-\u78c1\u76d8\u7ba1\u7406"},{"location":"1.os/ubuntu/ubuntu-disk-doc/#61","text":"\u786c\u76d8\u7684\u7269\u7406\u7ed3\u6784 \u76d8\u7247: \u786c\u76d8\u6709\u591a\u4e2a\u76d8\u7247\uff0c\u6bcf\u4e2a\u76d8\u72472\u9762 \u78c1\u5934: \u6bcf\u9762\u4e00\u4e2a\u78c1\u5934 \u786c\u76d8\u7684\u6570\u636e\u7ed3\u6784 \u6247\u533a: \u76d8\u7247\u88ab\u5206\u4e3a\u591a\u4e2a\u6247\u5f62\u533a\u57df\uff0c\u6bcf\u4e2a\u6247\u5f62\u533a\u5b58\u653e512\u5b57\u8282\u7684\u6570\u636e \u78c1\u9053:\u7edf\u4e00\u76d8\u7247\u4e0d\u540c\u534a\u5f84\u7684\u540c\u5fc3\u5706 \u67f1\u9762:\u4e0d\u540c\u76d8\u7247\u76f8\u540c\u534a\u5f84\u6784\u6210\u7684\u5706\u67f1\u9762","title":"6.1. \u78c1\u76d8\u7ed3\u6784"},{"location":"1.os/ubuntu/ubuntu-disk-doc/#62","text":"IDE\uff08\u5e76\u53e3\uff09 SATA\uff08\u4e32\u53e3\uff09 \u901f\u5ea6\u5feb \u7ea0\u9519\u80fd\u529b\u5f3a SCSI","title":"6.2. \u78c1\u76d8\u63a5\u53e3"},{"location":"1.os/ubuntu/ubuntu-disk-doc/#63-mbr","text":"\u5b9a\u4e49: MBR \u4e3b\u5f15\u5bfc\u8bb0\u5f55 \u4f4d\u7f6e: MBR \u4f4d\u4e8e\u786c\u76d8\u7b2c\u4e00\u4e2a\u7269\u7406\u6247\u533a\u5904","title":"6.3. MBR"},{"location":"1.os/ubuntu/ubuntu-disk-doc/#64","text":"","title":"6.4. \u78c1\u76d8\u5206\u533a\u8868\u793a"},{"location":"1.os/ubuntu/ubuntu-install-doc/","text":"\u7cfb\u7edf\u5b89\u88c5 \u00b6 \u6b63\u6240\u8c13\u4e0d\u4f1a\u88c5\u7cfb\u7edf\u7684\u8fd0\u7ef4\u5c31\u4e0d\u662f\u597d\u8fd0\u7ef4\u7684\u7406\u5ff5\uff0c\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e0bubuntu\u7cfb\u7edf\u5b89\u88c5 \u51c6\u5907\u5de5\u4f5c \u6b65\u9aa4\u4e00: \u4e0b\u8f7diso\u955c\u50cf \u4e0b\u8f7d\u5730\u5740: https://mirrors.aliyun.com/ubuntu-releases/ \u6b65\u9aa4\u4e8c: \u5236\u4f5c\u7cfb\u7edf\u76d8 \u53ef\u4ee5\u53c2\u8003\u6587\u7ae0\u4e2dMac\u5236\u4f5c\u7cfb\u7edf\u76d8\u8fd9\u7bc7\u6587\u7ae0 \u6b65\u9aa4\u4e09: \u88c5\u5c31\u5b8c\u4e8b\u4e86 1.1. \u9009\u62e9\u8bed\u8a00 1.2. \u9009\u62e9\u952e\u76d8\uff08\u672c\u6b65\u9aa4\u76f4\u63a5\u9ed8\u8ba4\u6309\u56de\u8f66\u5373\u53ef\u3002\uff09 1.3. \u914d\u7f6e\u7f51\u7edc\uff08\u4e00\u822c\u60c5\u51b5\u4f1a\u76f4\u63a5\u8df3\u8fc7\u8fd9\u4e00\u6b65\uff09 1.4. \u9009\u62e9\u4ee3\u7406\uff08\u9ed8\u8ba4\u56de\u8f66\u8df3\u8fc7\uff09 1.5. \u914d\u7f6e\u955c\u50cf\u6e90\uff08\u8df3\u8fc7\uff09\uff0c\u914d\u7f6e\u7f51\u7edc\u7684\u6b65\u9aa4\u4e5f\u53ef\u4ee5\u8df3\u8fc7\u4e4b\u540e\u4ece\u7cfb\u7edf\u4e2d\u914d\u7f6e\u4e5f\u662f\u53ef\u4ee5\u7684\u3002 1.6. \u9009\u62e9\u78c1\u76d8\uff08\u8fd9\u4e2a\u6b65\u9aa4\u6bd4\u8f83\u5173\u952e\uff09 \u9009\u62e9\u78c1\u76d8\u8fd9\u4e00\u6b65\u9700\u8981\u6ce8\u610f\uff0c\u9700\u8981\u6240\u6709\u78c1\u76d8\u7a7a\u95f4\u5206\u7ed9\u6839\u5206\u533a 1.7. \u7528\u6237\u4fe1\u606f 1.8. openssh server \u5207\u8bb0\u8981\u9009\u62e9\u4e0a ( \u5207\u8bb0 )","title":"Linux \u7cfb\u7edf\u5b89\u88c5"},{"location":"1.os/ubuntu/ubuntu-install-doc/#_1","text":"\u6b63\u6240\u8c13\u4e0d\u4f1a\u88c5\u7cfb\u7edf\u7684\u8fd0\u7ef4\u5c31\u4e0d\u662f\u597d\u8fd0\u7ef4\u7684\u7406\u5ff5\uff0c\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e0bubuntu\u7cfb\u7edf\u5b89\u88c5 \u51c6\u5907\u5de5\u4f5c \u6b65\u9aa4\u4e00: \u4e0b\u8f7diso\u955c\u50cf \u4e0b\u8f7d\u5730\u5740: https://mirrors.aliyun.com/ubuntu-releases/ \u6b65\u9aa4\u4e8c: \u5236\u4f5c\u7cfb\u7edf\u76d8 \u53ef\u4ee5\u53c2\u8003\u6587\u7ae0\u4e2dMac\u5236\u4f5c\u7cfb\u7edf\u76d8\u8fd9\u7bc7\u6587\u7ae0 \u6b65\u9aa4\u4e09: \u88c5\u5c31\u5b8c\u4e8b\u4e86 1.1. \u9009\u62e9\u8bed\u8a00 1.2. \u9009\u62e9\u952e\u76d8\uff08\u672c\u6b65\u9aa4\u76f4\u63a5\u9ed8\u8ba4\u6309\u56de\u8f66\u5373\u53ef\u3002\uff09 1.3. \u914d\u7f6e\u7f51\u7edc\uff08\u4e00\u822c\u60c5\u51b5\u4f1a\u76f4\u63a5\u8df3\u8fc7\u8fd9\u4e00\u6b65\uff09 1.4. \u9009\u62e9\u4ee3\u7406\uff08\u9ed8\u8ba4\u56de\u8f66\u8df3\u8fc7\uff09 1.5. \u914d\u7f6e\u955c\u50cf\u6e90\uff08\u8df3\u8fc7\uff09\uff0c\u914d\u7f6e\u7f51\u7edc\u7684\u6b65\u9aa4\u4e5f\u53ef\u4ee5\u8df3\u8fc7\u4e4b\u540e\u4ece\u7cfb\u7edf\u4e2d\u914d\u7f6e\u4e5f\u662f\u53ef\u4ee5\u7684\u3002 1.6. \u9009\u62e9\u78c1\u76d8\uff08\u8fd9\u4e2a\u6b65\u9aa4\u6bd4\u8f83\u5173\u952e\uff09 \u9009\u62e9\u78c1\u76d8\u8fd9\u4e00\u6b65\u9700\u8981\u6ce8\u610f\uff0c\u9700\u8981\u6240\u6709\u78c1\u76d8\u7a7a\u95f4\u5206\u7ed9\u6839\u5206\u533a 1.7. \u7528\u6237\u4fe1\u606f 1.8. openssh server \u5207\u8bb0\u8981\u9009\u62e9\u4e0a ( \u5207\u8bb0 )","title":"\u7cfb\u7edf\u5b89\u88c5"},{"location":"1.os/ubuntu/ubuntu-kernel-doc/","text":"\u6e05\u9664\u5185\u6838\u7f13\u5b58 \u00b6 https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/","title":"Ubuntu kernel doc"},{"location":"1.os/ubuntu/ubuntu-kernel-doc/#_1","text":"https://www.tecmint.com/clear-ram-memory-cache-buffer-and-swap-space-on-linux/","title":"\u6e05\u9664\u5185\u6838\u7f13\u5b58"},{"location":"1.os/ubuntu/ubuntu-mirror-doc/","text":"\u66f4\u6362\u56fd\u5185\u6e90 \u00b6 \u901a\u5e38\u6765\u8bf4\uff0c\u6211\u4eec\u5728\u5b89\u88c5\u597d\u7cfb\u7edf\u4e4b\u540e\u9700\u8981\u5bf9yum/apt\u7684\u6e90\u8fdb\u884c\u66f4\u6362\uff0c\u9ed8\u8ba4\u4e3a\u56fd\u5916\u6e90\u6bd4\u8f83\u6162\uff5e ubuntu22.04 \u6e05\u534e\u6e90 \u9700\u8981\u6ce8\u610f\u4e00\u4e0b\uff0c\u5982\u679c apt update \u62a5\u9519\uff0c\u5c31\u5c06https\u6539\u6210http \u5982\u679c\u9700\u8981\u6dfb\u52a0\u5176\u4ed6\u7684\u7248\u672c\u7684\u6e90\u53ef\u4ee5\u8bbf\u95ee: https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ # \u9ed8\u8ba4\u6ce8\u91ca\u4e86\u6e90\u7801\u955c\u50cf\u4ee5\u63d0\u9ad8 apt update \u901f\u5ea6\uff0c\u5982\u6709\u9700\u8981\u53ef\u81ea\u884c\u53d6\u6d88\u6ce8\u91ca deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse # deb-src http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse # \u9884\u53d1\u5e03\u8f6f\u4ef6\u6e90\uff0c\u4e0d\u5efa\u8bae\u542f\u7528 # deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-proposed main restricted universe multiverse # # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-proposed main restricted universe multiverse \u6e05\u534e\u6e90\u5730\u5740 \u00b6 https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/","title":"Linux \u56fd\u5185apt\u6e90"},{"location":"1.os/ubuntu/ubuntu-mirror-doc/#_1","text":"\u901a\u5e38\u6765\u8bf4\uff0c\u6211\u4eec\u5728\u5b89\u88c5\u597d\u7cfb\u7edf\u4e4b\u540e\u9700\u8981\u5bf9yum/apt\u7684\u6e90\u8fdb\u884c\u66f4\u6362\uff0c\u9ed8\u8ba4\u4e3a\u56fd\u5916\u6e90\u6bd4\u8f83\u6162\uff5e ubuntu22.04 \u6e05\u534e\u6e90 \u9700\u8981\u6ce8\u610f\u4e00\u4e0b\uff0c\u5982\u679c apt update \u62a5\u9519\uff0c\u5c31\u5c06https\u6539\u6210http \u5982\u679c\u9700\u8981\u6dfb\u52a0\u5176\u4ed6\u7684\u7248\u672c\u7684\u6e90\u53ef\u4ee5\u8bbf\u95ee: https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ # \u9ed8\u8ba4\u6ce8\u91ca\u4e86\u6e90\u7801\u955c\u50cf\u4ee5\u63d0\u9ad8 apt update \u901f\u5ea6\uff0c\u5982\u6709\u9700\u8981\u53ef\u81ea\u884c\u53d6\u6d88\u6ce8\u91ca deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse # deb-src http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse # \u9884\u53d1\u5e03\u8f6f\u4ef6\u6e90\uff0c\u4e0d\u5efa\u8bae\u542f\u7528 # deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-proposed main restricted universe multiverse # # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-proposed main restricted universe multiverse","title":"\u66f4\u6362\u56fd\u5185\u6e90"},{"location":"1.os/ubuntu/ubuntu-mirror-doc/#_2","text":"https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/","title":"\u6e05\u534e\u6e90\u5730\u5740"},{"location":"1.os/ubuntu/ubuntu-network-doc/","text":"1.1 \u67e5\u770b\u53ca\u6d4b\u8bd5\u7f51\u7edc \u00b6 \u67e5\u770b\u53ca\u6d4b\u8bd5\u7f51\u7edc\u914d\u7f6e\u662f\u7ba1\u7406 Linux \u7f51\u7edc\u670d\u52a1\u7684\u7b2c\u4e00\u6b65\uff0c\u672c\u8282\u5c06\u5b66\u4e60 Linux \u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684 \u7f51\u7edc\u67e5\u770b\u53ca\u6d4b\u8bd5\u547d\u4ee4\u3002\u5176\u4e2d\u8bb2\u89e3\u7684\u5927\u591a\u6570\u547d\u4ee4\u4ee5\u666e\u901a\u7528\u6237\u6743\u9650\u5c31\u53ef\u4ee5\u5b8c\u6210\u64cd\u4f5c\uff0c\u4f46\u666e\u901a\u7528\u6237 \u5728\u6267\u884c/sbin/\u76ee\u5f55\u4e2d\u7684\u547d\u4ee4\u65f6\u9700\u8981\u6307\u5b9a\u547d\u4ee4\u6587\u4ef6\u7684\u7edd\u5bf9\u8def\u5f84\u3002 1.1.1 \u67e5\u770b\u7f51\u7edc\u914d\u7f6e \u00b6 1. \u67e5\u770b\u7f51\u7edc\u63a5\u53e3\u5730\u5740 \u00b6 \uff081\uff09\u67e5\u770b\u6d3b\u52a8\u7684\u7f51\u7edc\u63a5\u53e3\u8bbe\u5907 \u82e5\u91c7\u7528 mini \u7248 CentOS 7 \u5b89\u88c5\u7684\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u662f\u6ca1\u6709 ifconfig \u547d\u4ee4\u7684\uff0c\u9700\u8981\u5148\u901a\u8fc7 yum \u65b9\u5f0f\u5b89\u88c5 net-tools \u8f6f\u4ef6\u5305\uff0c\u624d\u6709 ifconfig \u547d\u4ee4\u3002\u5728\u4e0d\u5e26\u4efb\u4f55\u9009\u9879\u548c\u53c2\u6570\u6267\u884c ifconfig \u547d\u4ee4\u65f6\uff0c \u5c06\u663e\u793a\u5f53\u524d\u4e3b\u673a\u4e2d\u5df2\u542f\u7528\uff08\u6d3b\u52a8\uff09\u7684\u7f51\u7edc\u63a5\u53e3\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u76f4\u63a5\u6267\u884c ifconfig \u547d\u4ee4\u540e\u53ef\u4ee5\u770b \u5230 ens33\u3001lo \u8fd9\u4e24\u4e2a\u7f51\u7edc\u63a5\u53e3\u7684\u4fe1\u606f\uff0c\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a [ root@VM-16-9-centos ] # ifconfig docker0: flags = 4099 <UP,BROADCAST,MULTICAST> mtu 1500 inet 172 .17.0.1 netmask 255 .255.0.0 broadcast 172 .17.255.255 ether 02 :42:7c:2d:55:50 txqueuelen 0 ( Ethernet ) RX packets 0 bytes 0 ( 0 .0 B ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 ( 0 .0 B ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 eth0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 10 .0.16.9 netmask 255 .255.252.0 broadcast 10 .0.19.255 inet6 fe80::5054:ff:fe16:3a9 prefixlen 64 scopeid 0x20<link> ether 52 :54:00:16:03:a9 txqueuelen 1000 ( Ethernet ) RX packets 51791902 bytes 9684145526 ( 9 .0 GiB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 49095710 bytes 7697835155 ( 7 .1 GiB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: flags = 73 <UP,LOOPBACK,RUNNING> mtu 65536 inet 127 .0.0.1 netmask 255 .0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10<host> loop txqueuelen 1000 ( Local Loopback ) RX packets 14076 bytes 1715488 ( 1 .6 MiB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 14076 bytes 1715488 ( 1 .6 MiB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \uff082\uff09\u67e5\u770b\u6307\u5b9a\u7684\u7f51\u7edc\u63a5\u53e3\u4fe1\u606f \u5f53\u53ea\u9700\u8981\u67e5\u770b\u5176\u4e2d\u67d0\u4e00\u4e2a\u7f51\u7edc\u63a5\u53e3\u7684\u4fe1\u606f\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u7f51\u7edc\u63a5\u53e3\u7684\u540d\u79f0\u4f5c\u4e3a ifconfig \u547d \u4ee4\u7684\u53c2\u6570\uff08\u4e0d\u8bba\u8be5\u7f51\u7edc\u63a5\u53e3\u662f\u5426\u5904\u4e8e\u6fc0\u6d3b\u72b6\u6001\uff09\u3002\u4f8b\u5982\uff0c\u6267\u884c\u201cifconfig ens33\u201d\u547d\u4ee4\u540e\u53ef\u4ee5 \u53ea\u67e5\u770b\u7f51\u5361 ens33 \u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a [ root@VM-16-9-centos ~ ] # ifconfig eth0 eth0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 10 .0.16.9 netmask 255 .255.252.0 broadcast 10 .0.19.255 inet6 fe80::5054:ff:fe16:3a9 prefixlen 64 scopeid 0x20<link> ether 52 :54:00:16:03:a9 txqueuelen 1000 ( Ethernet ) RX packets 51792964 bytes 9684253645 ( 9 .0 GiB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 49096762 bytes 7698009938 ( 7 .1 GiB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \u4ece\u4e0a\u8ff0\u547d\u4ee4\u663e\u793a\u7684\u7ed3\u679c\u4e2d\uff0c\u53ef\u4ee5\u83b7\u77e5 ens33 \u7f51\u5361\u7684\u4e00\u4e9b\u57fa\u672c\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 inet\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u7684 IP \u5730\u5740\uff0c\u5982\u201c192.168.4.11\u201d\u3002 netmask\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u7684\u5b50\u7f51\u63a9\u7801\uff0c\u5982\u201c255.255.255.0\u201d\u3002 broadcast\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u6240\u5728\u7f51\u7edc\u7684\u5e7f\u64ad\u5730\u5740\uff0c\u5982\u201c192.168.4.255\u201d\u3002 ether\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u7684\u7269\u7406\u5730\u5740\uff08MAC \u5730\u5740\uff09\uff0c\u5982\u201c00:0c:29:3a:81:cc\u201d\u3002\u7f51\u7edc\u63a5 \u53e3\u7684\u7269\u7406\u5730\u5740\u901a\u5e38\u4e0d\u80fd\u66f4\u6539\uff0c\u662f\u7f51\u5361\u5728\u751f\u4ea7\u65f6\u786e\u5b9a\u7684\u5168\u7403\u552f\u4e00\u7684\u786c\u4ef6\u5730\u5740\u3002 \u9664\u6b64\u4ee5\u5916\uff0c\u8fd8\u80fd\u591f\u901a\u8fc7\u201cTX\u201d\u548c\u201cRX\u201d\u7b49\u4fe1\u606f\u4e86\u89e3\u901a\u8fc7\u8be5\u7f51\u7edc\u63a5\u53e3\u53d1\u9001\u548c\u63a5\u6536\u7684\u6570\u636e\u5305\u4e2a \u6570\u3001\u6d41\u91cf\u7b49\u66f4\u591a\u5c5e\u6027\u3002 2. \u67e5\u770b\u4e3b\u673a\u540d\u79f0 \u00b6 \u5728 Linux \u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u76f8\u5f53\u4e00\u90e8\u5206\u7f51\u7edc\u670d\u52a1\u90fd\u4f1a\u901a\u8fc7\u4e3b\u673a\u540d\u6765\u8bc6\u522b\u4e3b\u673a\uff0c\u5982\u679c\u4e3b\u673a\u540d\u914d \u7f6e\u4e0d\u5f53\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7a0b\u5e8f\u529f\u80fd\u51fa\u73b0\u6545\u969c\u3002\u4f7f\u7528 hostname \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u4e3b\u673a\u7684\u4e3b\u673a\u540d\uff0c \u4e0d\u7528\u6dfb\u52a0\u4efb\u4f55\u9009\u9879\u6216\u53c2\u6570\uff0c\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a(\u53e6\u5916\u9664\u4e86\u67e5\u770b\u4e3b\u673a\u540d\u8fd8\u53ef\u4ee5\u4f7f\u7528-i/-I\u53c2\u6570\u6765\u67e5\u770bip) [ root@VM-16-9-centos ~ ] # hostname VM-16-9-centos [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # hostname -i ::1 127 .0.0.1 [ root@VM-16-9-centos ~ ] # hostname -I 10 .0.16.9 172 .17.0.1 3. \u67e5\u770b\u8def\u7531\u8868\u6761\u76ee \u00b6 Linux \u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u8def\u7531\u8868\u51b3\u5b9a\u7740\u4ece\u672c\u673a\u5411\u5176\u4ed6\u4e3b\u673a\u3001\u5176\u4ed6\u7f51\u7edc\u53d1\u9001\u6570\u636e\u7684\u53bb\u5411\uff0c\u662f\u6392 \u9664\u7f51\u7edc\u6545\u969c\u7684\u5173\u952e\u4fe1\u606f\u3002\u76f4\u63a5\u6267\u884c\u201croute\u201d\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u4e3b\u673a\u4e2d\u7684\u8def\u7531\u8868\u4fe1\u606f\uff0c\u5728\u8f93\u51fa\u7ed3 \u679c\u4e2d\uff0cDestination \u5217\u5bf9\u5e94\u76ee\u6807\u7f51\u6bb5\u7684\u5730\u5740\uff0cGateway \u5217\u5bf9\u5e94\u4e0b\u4e00\u8df3\u8def\u7531\u5668\u7684\u5730\u5740\uff0cIface \u5217 \u5bf9\u5e94\u53d1\u9001\u6570\u636e\u7684\u7f51\u7edc\u63a5\u53e3\u3002\u82e5\u7ed3\u5408\u201c-n\u201d\u9009\u9879\u4f7f\u7528\uff0c\u53ef\u4ee5\u5c06\u8def\u7531\u8bb0\u5f55\u4e2d\u7684\u5730\u5740\u663e\u793a\u4e3a\u6570\u5b57\u5f62\u5f0f\uff0c\u8fd9\u53ef\u4ee5\u8df3\u8fc7\u89e3\u6790\u4e3b\u673a \u540d\u7684\u8fc7\u7a0b\uff0c\u5728\u8def\u7531\u8868\u6761\u76ee\u8f83\u591a\u7684\u60c5\u51b5\u4e0b\u80fd\u591f\u52a0\u5feb\u6267\u884c\u901f\u5ea6\u3002 [ root@VM-16-9-centos ~ ] # route Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface default gateway 0 .0.0.0 UG 0 0 0 eth0 10 .0.16.0 0 .0.0.0 255 .255.252.0 U 0 0 0 eth0 link-local 0 .0.0.0 255 .255.0.0 U 1002 0 0 eth0 172 .17.0.0 0 .0.0.0 255 .255.0.0 U 0 0 0 docker0 [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0 .0.0.0 10 .0.16.1 0 .0.0.0 UG 0 0 0 eth0 10 .0.16.0 0 .0.0.0 255 .255.252.0 U 0 0 0 eth0 169 .254.0.0 0 .0.0.0 255 .255.0.0 U 1002 0 0 eth0 172 .17.0.0 0 .0.0.0 255 .255.0.0 U 0 0 0 docker0 4. \u67e5\u770b\u7f51\u7edc\u8fde\u63a5\u60c5\u51b5 \u00b6 \u901a\u8fc7 netstat \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u64cd\u4f5c\u7cfb\u7edf\u7684\u7f51\u7edc\u8fde\u63a5\u72b6\u6001\u3001\u8def\u7531\u8868\u3001\u63a5\u53e3\u7edf\u8ba1\u7b49\u4fe1\u606f\uff0c \u5b83\u662f\u4e86\u89e3\u7f51\u7edc\u72b6\u6001\u53ca\u6392\u9664\u7f51\u7edc\u670d\u52a1\u6545\u969c\u7684\u6709\u6548\u5de5\u5177\u3002\u4ee5\u4e0b\u662f netstat \u547d\u4ee4\u5e38\u7528\u7684\u51e0\u4e2a\u9009\u9879 -a\uff1a\u663e\u793a\u4e3b\u673a\u4e2d\u6240\u6709\u6d3b\u52a8\u7684\u7f51\u7edc\u8fde\u63a5\u4fe1\u606f\uff08\u5305\u62ec\u76d1\u542c\u3001\u975e\u76d1\u542c\u72b6\u6001\u7684\u670d\u52a1\u7aef\u53e3\uff09 -n\uff1a\u4ee5\u6570\u5b57\u7684\u5f62\u5f0f\u663e\u793a\u76f8\u5173\u7684\u4e3b\u673a\u5730\u5740\u3001\u7aef\u53e3\u7b49\u4fe1\u606f\u3002 -r\uff1a\u663e\u793a\u8def\u7531\u8868\u4fe1\u606f\u3002 -l\uff1a\u663e\u793a\u5904\u4e8e\u76d1\u542c\uff08Listening\uff09\u72b6\u6001\u7684\u7f51\u7edc\u8fde\u63a5\u53ca\u7aef\u53e3\u4fe1\u606f\u3002 -t\uff1a\u67e5\u770b TCP\uff08Transmission Control Protocol\uff0c\u4f20\u8f93\u63a7\u5236\u534f\u8bae\uff09\u76f8\u5173\u7684\u4fe1\u606f -u\uff1a\u663e\u793a UDP\uff08User Datagram Protocol\uff0c\u7528\u6237\u6570\u636e\u62a5\u534f\u8bae\uff09\u534f\u8bae\u76f8\u5173\u7684\u4fe1\u606f\u3002 -p\uff1a\u663e\u793a\u4e0e\u7f51\u7edc\u8fde\u63a5\u76f8\u5173\u8054\u7684\u8fdb\u7a0b\u53f7\u3001\u8fdb\u7a0b\u540d\u79f0\u4fe1\u606f\uff08\u8be5\u9009\u9879\u9700\u8981 root \u6743\u9650\uff09\u3002 \u901a\u5e38\u4f7f\u7528\u201c-anpt\u201d\u7ec4\u5408\u9009\u9879\uff0c\u4ee5\u6570\u5b57\u5f62\u5f0f\u663e\u793a\u5f53\u524d\u7cfb\u7edf\u4e2d\u6240\u6709\u7684 TCP \u8fde\u63a5\u4fe1\u606f\uff0c\u540c\u65f6\u663e \u793a\u5bf9\u5e94\u7684\u8fdb\u7a0b\u4fe1\u606f\u3002\u7ed3\u5408\u7ba1\u9053\u547d\u4ee4\u4f7f\u7528\u201cgrep\u201d\u547d\u4ee4\uff0c\u8fd8\u53ef\u4ee5\u5728\u7ed3\u679c\u4e2d\u8fc7\u6ee4\u51fa\u6240\u9700\u8981\u7684\u7279\u5b9a\u8bb0 \u5f55\u3002\u4f8b\u5982\uff0c\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\u53ef\u4ee5\u67e5\u770b\u672c\u673a\u4e2d\u662f\u5426\u6709\u76d1\u542c\u201cTCP 22\u201d\u7aef\u53e3\uff08\u5373\u6807\u51c6 Web \u670d\u52a1\uff09\u7684 \u670d\u52a1\u7a0b\u5e8f\uff0c\u8f93\u51fa\u4fe1\u606f\u4e2d\u5305\u62ec PID \u53f7\u548c\u8fdb\u7a0b\u540d\u79f0\u3002 [ root@VM-16-9-centos ~ ] # netstat -antp |grep 22 tcp 0 0 0 .0.0.0:22 0 .0.0.0:* LISTEN 4344 /sshd \u9664\u4e86 netstat\uff0css \u547d\u4ee4\u4e5f\u53ef\u4ee5\u67e5\u770b\u7f51\u7edc\u8fde\u63a5\u60c5\u51b5\uff0c\u5b83\u662f Socket Statistics \u7684\u7f29\u5199\uff0c\u4e3b\u8981 \u7528\u4e8e\u83b7\u53d6 socket \u7edf\u8ba1\u4fe1\u606f\uff0c\u5b83\u53ef\u4ee5\u663e\u793a\u548c netstat \u547d\u4ee4\u7c7b\u4f3c\u7684\u8f93\u51fa\u5185\u5bb9\u3002\u4f46 ss \u7684\u4f18\u52bf\u5728\u4e8e \u5b83\u80fd\u591f\u663e\u793a\u66f4\u591a\u66f4\u8be6\u7ec6\u7684\u6709\u5173 TCP \u548c\u8fde\u63a5\u72b6\u6001\u7684\u4fe1\u606f\uff0c\u800c\u4e14\u6bd4 netstat \u66f4\u5feb\u901f\u66f4\u9ad8\u6548\u3002\u8981\u60f3 \u4f7f\u7528 ss \u547d\u4ee4\uff0c\u9996\u5148\u786e\u4fdd iproute \u7a0b\u5e8f\u5305\u5df2\u88ab\u5b89\u88c5\uff0c\u53ef\u4ee5\u901a\u8fc7 yum \u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\u3002(\u7528\u6cd5\u7c7b\u4f3c) [ root@VM-16-9-centos ~ ] # ss -antp State Recv-Q Send-Q Local Address:Port Peer Address:Port LISTEN 0 128 *:22 *:* users: (( \"sshd\" ,pid = 4344 ,fd = 3 )) LISTEN 0 100 127 .0.0.1:25 *:* 1.1.2 \u6d4b\u8bd5\u7f51\u7edc\u8fde\u63a5 \u00b6 \u7528\u6237\u8bbf\u95ee\u7f51\u7edc\u670d\u52a1\u7684\u524d\u63d0\u662f\u7f51\u7edc\u8fde\u63a5\u5904\u4e8e\u6b63\u5e38\u72b6\u6001\u3002\u82e5\u7f51\u7edc\u8fde\u63a5\u4e0d\u7a33\u5b9a\uff0c\u751a\u81f3\u65e0\u6cd5\u8fde\u63a5\uff0c \u7528\u6237\u5219\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u7f51\u7edc\u670d\u52a1\u3002\u56e0\u6b64\uff0c\u5f53\u7f51\u7edc\u8fde\u63a5\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u9700\u8981\u901a\u8fc7\u6d4b\u8bd5\u7f51\u7edc\u8fde\u63a5\u7684\u547d \u4ee4\u6765\u786e\u5b9a\u6545\u969c\u70b9\u3002\u4e0b\u9762\u4ecb\u7ecd\u51e0\u4e2a\u5e38\u7528\u7684\u6d4b\u8bd5\u7f51\u7edc\u8fde\u63a5\u7684\u547d\u4ee4\u3002 1. \u6d4b\u8bd5\u7f51\u7edc\u8fde\u901a\u6027 \u00b6 [ root@VM-16-9-centos ~ ] # ping baidu.com 2. \u6d4b\u8bd5DNS\u89e3\u6790 \u00b6 [ root@VM-16-9-centos ~ ] # nslookup www.google.com Server: 183 .60.83.19 Address: 183 .60.83.19#53 Non-authoritative answer: Name: www.google.com Address: 174 .37.54.20 Name: www.google.com Address: 2001 ::68f4:2e15 [ root@VM-16-9-centos ~ ] # dig www.google.com ; <<>> DiG 9 .11.4-P2-RedHat-9.11.4-26.P2.el7_9.7 <<>> www.google.com ;; global options: +cmd ;; Got answer: ;; ->>HEADER <<- opco de: QUERY, status: NOERROR, id: 44445 ;; flags: qr rd ra ; QUERY: 1 , ANSWER: 1 , AUTHORITY: 0 , ADDITIONAL: 0 ;; QUESTION SECTION: ; www.google.com. IN A ;; ANSWER SECTION: www.google.com. 133 IN A 199 .59.149.206 ;; Query time: 1 msec ;; SERVER: 183 .60.83.19#53 ( 183 .60.83.19 ) ;; WHEN: \u4e94 11\u6708 18 15 :51:47 CST 2022 ;; MSG SIZE rcvd: 48 **3. iperf \u7f51\u7edc\u6d4b\u8bd5 ** \u00b6 server: iperf -s -p 1234 -i 1 clent: iperf -c 172 .16.240.204 -p 1234 -i 1 -t 20 -w 20w \u4fee\u6539\u7f51\u5361\u914d\u7f6e root@ubuntu:/home/ubuntu# cat /etc/netplan/00-installer-config.yaml # This is the network config written by 'subiquity' network: ethernets: ens18: addresses: - 192.168.1.114/24 gateway4: 192.168.1.1 nameservers: addresses: - 192.168.1.1 search: - 202.106.46.151 version: 2","title":"Linux \u7f51\u7edc\u670d\u52a1"},{"location":"1.os/ubuntu/ubuntu-network-doc/#11","text":"\u67e5\u770b\u53ca\u6d4b\u8bd5\u7f51\u7edc\u914d\u7f6e\u662f\u7ba1\u7406 Linux \u7f51\u7edc\u670d\u52a1\u7684\u7b2c\u4e00\u6b65\uff0c\u672c\u8282\u5c06\u5b66\u4e60 Linux \u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684 \u7f51\u7edc\u67e5\u770b\u53ca\u6d4b\u8bd5\u547d\u4ee4\u3002\u5176\u4e2d\u8bb2\u89e3\u7684\u5927\u591a\u6570\u547d\u4ee4\u4ee5\u666e\u901a\u7528\u6237\u6743\u9650\u5c31\u53ef\u4ee5\u5b8c\u6210\u64cd\u4f5c\uff0c\u4f46\u666e\u901a\u7528\u6237 \u5728\u6267\u884c/sbin/\u76ee\u5f55\u4e2d\u7684\u547d\u4ee4\u65f6\u9700\u8981\u6307\u5b9a\u547d\u4ee4\u6587\u4ef6\u7684\u7edd\u5bf9\u8def\u5f84\u3002","title":"1.1 \u67e5\u770b\u53ca\u6d4b\u8bd5\u7f51\u7edc"},{"location":"1.os/ubuntu/ubuntu-network-doc/#111","text":"","title":"1.1.1 \u67e5\u770b\u7f51\u7edc\u914d\u7f6e"},{"location":"1.os/ubuntu/ubuntu-network-doc/#1","text":"\uff081\uff09\u67e5\u770b\u6d3b\u52a8\u7684\u7f51\u7edc\u63a5\u53e3\u8bbe\u5907 \u82e5\u91c7\u7528 mini \u7248 CentOS 7 \u5b89\u88c5\u7684\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u662f\u6ca1\u6709 ifconfig \u547d\u4ee4\u7684\uff0c\u9700\u8981\u5148\u901a\u8fc7 yum \u65b9\u5f0f\u5b89\u88c5 net-tools \u8f6f\u4ef6\u5305\uff0c\u624d\u6709 ifconfig \u547d\u4ee4\u3002\u5728\u4e0d\u5e26\u4efb\u4f55\u9009\u9879\u548c\u53c2\u6570\u6267\u884c ifconfig \u547d\u4ee4\u65f6\uff0c \u5c06\u663e\u793a\u5f53\u524d\u4e3b\u673a\u4e2d\u5df2\u542f\u7528\uff08\u6d3b\u52a8\uff09\u7684\u7f51\u7edc\u63a5\u53e3\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u76f4\u63a5\u6267\u884c ifconfig \u547d\u4ee4\u540e\u53ef\u4ee5\u770b \u5230 ens33\u3001lo \u8fd9\u4e24\u4e2a\u7f51\u7edc\u63a5\u53e3\u7684\u4fe1\u606f\uff0c\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a [ root@VM-16-9-centos ] # ifconfig docker0: flags = 4099 <UP,BROADCAST,MULTICAST> mtu 1500 inet 172 .17.0.1 netmask 255 .255.0.0 broadcast 172 .17.255.255 ether 02 :42:7c:2d:55:50 txqueuelen 0 ( Ethernet ) RX packets 0 bytes 0 ( 0 .0 B ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 ( 0 .0 B ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 eth0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 10 .0.16.9 netmask 255 .255.252.0 broadcast 10 .0.19.255 inet6 fe80::5054:ff:fe16:3a9 prefixlen 64 scopeid 0x20<link> ether 52 :54:00:16:03:a9 txqueuelen 1000 ( Ethernet ) RX packets 51791902 bytes 9684145526 ( 9 .0 GiB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 49095710 bytes 7697835155 ( 7 .1 GiB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: flags = 73 <UP,LOOPBACK,RUNNING> mtu 65536 inet 127 .0.0.1 netmask 255 .0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10<host> loop txqueuelen 1000 ( Local Loopback ) RX packets 14076 bytes 1715488 ( 1 .6 MiB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 14076 bytes 1715488 ( 1 .6 MiB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \uff082\uff09\u67e5\u770b\u6307\u5b9a\u7684\u7f51\u7edc\u63a5\u53e3\u4fe1\u606f \u5f53\u53ea\u9700\u8981\u67e5\u770b\u5176\u4e2d\u67d0\u4e00\u4e2a\u7f51\u7edc\u63a5\u53e3\u7684\u4fe1\u606f\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u7f51\u7edc\u63a5\u53e3\u7684\u540d\u79f0\u4f5c\u4e3a ifconfig \u547d \u4ee4\u7684\u53c2\u6570\uff08\u4e0d\u8bba\u8be5\u7f51\u7edc\u63a5\u53e3\u662f\u5426\u5904\u4e8e\u6fc0\u6d3b\u72b6\u6001\uff09\u3002\u4f8b\u5982\uff0c\u6267\u884c\u201cifconfig ens33\u201d\u547d\u4ee4\u540e\u53ef\u4ee5 \u53ea\u67e5\u770b\u7f51\u5361 ens33 \u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a [ root@VM-16-9-centos ~ ] # ifconfig eth0 eth0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 10 .0.16.9 netmask 255 .255.252.0 broadcast 10 .0.19.255 inet6 fe80::5054:ff:fe16:3a9 prefixlen 64 scopeid 0x20<link> ether 52 :54:00:16:03:a9 txqueuelen 1000 ( Ethernet ) RX packets 51792964 bytes 9684253645 ( 9 .0 GiB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 49096762 bytes 7698009938 ( 7 .1 GiB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \u4ece\u4e0a\u8ff0\u547d\u4ee4\u663e\u793a\u7684\u7ed3\u679c\u4e2d\uff0c\u53ef\u4ee5\u83b7\u77e5 ens33 \u7f51\u5361\u7684\u4e00\u4e9b\u57fa\u672c\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u8ff0\u3002 inet\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u7684 IP \u5730\u5740\uff0c\u5982\u201c192.168.4.11\u201d\u3002 netmask\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u7684\u5b50\u7f51\u63a9\u7801\uff0c\u5982\u201c255.255.255.0\u201d\u3002 broadcast\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u6240\u5728\u7f51\u7edc\u7684\u5e7f\u64ad\u5730\u5740\uff0c\u5982\u201c192.168.4.255\u201d\u3002 ether\uff1a\u8868\u793a\u7f51\u7edc\u63a5\u53e3\u7684\u7269\u7406\u5730\u5740\uff08MAC \u5730\u5740\uff09\uff0c\u5982\u201c00:0c:29:3a:81:cc\u201d\u3002\u7f51\u7edc\u63a5 \u53e3\u7684\u7269\u7406\u5730\u5740\u901a\u5e38\u4e0d\u80fd\u66f4\u6539\uff0c\u662f\u7f51\u5361\u5728\u751f\u4ea7\u65f6\u786e\u5b9a\u7684\u5168\u7403\u552f\u4e00\u7684\u786c\u4ef6\u5730\u5740\u3002 \u9664\u6b64\u4ee5\u5916\uff0c\u8fd8\u80fd\u591f\u901a\u8fc7\u201cTX\u201d\u548c\u201cRX\u201d\u7b49\u4fe1\u606f\u4e86\u89e3\u901a\u8fc7\u8be5\u7f51\u7edc\u63a5\u53e3\u53d1\u9001\u548c\u63a5\u6536\u7684\u6570\u636e\u5305\u4e2a \u6570\u3001\u6d41\u91cf\u7b49\u66f4\u591a\u5c5e\u6027\u3002","title":"1. \u67e5\u770b\u7f51\u7edc\u63a5\u53e3\u5730\u5740"},{"location":"1.os/ubuntu/ubuntu-network-doc/#2","text":"\u5728 Linux \u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u76f8\u5f53\u4e00\u90e8\u5206\u7f51\u7edc\u670d\u52a1\u90fd\u4f1a\u901a\u8fc7\u4e3b\u673a\u540d\u6765\u8bc6\u522b\u4e3b\u673a\uff0c\u5982\u679c\u4e3b\u673a\u540d\u914d \u7f6e\u4e0d\u5f53\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7a0b\u5e8f\u529f\u80fd\u51fa\u73b0\u6545\u969c\u3002\u4f7f\u7528 hostname \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u4e3b\u673a\u7684\u4e3b\u673a\u540d\uff0c \u4e0d\u7528\u6dfb\u52a0\u4efb\u4f55\u9009\u9879\u6216\u53c2\u6570\uff0c\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a(\u53e6\u5916\u9664\u4e86\u67e5\u770b\u4e3b\u673a\u540d\u8fd8\u53ef\u4ee5\u4f7f\u7528-i/-I\u53c2\u6570\u6765\u67e5\u770bip) [ root@VM-16-9-centos ~ ] # hostname VM-16-9-centos [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # hostname -i ::1 127 .0.0.1 [ root@VM-16-9-centos ~ ] # hostname -I 10 .0.16.9 172 .17.0.1","title":"2. \u67e5\u770b\u4e3b\u673a\u540d\u79f0"},{"location":"1.os/ubuntu/ubuntu-network-doc/#3","text":"Linux \u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u8def\u7531\u8868\u51b3\u5b9a\u7740\u4ece\u672c\u673a\u5411\u5176\u4ed6\u4e3b\u673a\u3001\u5176\u4ed6\u7f51\u7edc\u53d1\u9001\u6570\u636e\u7684\u53bb\u5411\uff0c\u662f\u6392 \u9664\u7f51\u7edc\u6545\u969c\u7684\u5173\u952e\u4fe1\u606f\u3002\u76f4\u63a5\u6267\u884c\u201croute\u201d\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u4e3b\u673a\u4e2d\u7684\u8def\u7531\u8868\u4fe1\u606f\uff0c\u5728\u8f93\u51fa\u7ed3 \u679c\u4e2d\uff0cDestination \u5217\u5bf9\u5e94\u76ee\u6807\u7f51\u6bb5\u7684\u5730\u5740\uff0cGateway \u5217\u5bf9\u5e94\u4e0b\u4e00\u8df3\u8def\u7531\u5668\u7684\u5730\u5740\uff0cIface \u5217 \u5bf9\u5e94\u53d1\u9001\u6570\u636e\u7684\u7f51\u7edc\u63a5\u53e3\u3002\u82e5\u7ed3\u5408\u201c-n\u201d\u9009\u9879\u4f7f\u7528\uff0c\u53ef\u4ee5\u5c06\u8def\u7531\u8bb0\u5f55\u4e2d\u7684\u5730\u5740\u663e\u793a\u4e3a\u6570\u5b57\u5f62\u5f0f\uff0c\u8fd9\u53ef\u4ee5\u8df3\u8fc7\u89e3\u6790\u4e3b\u673a \u540d\u7684\u8fc7\u7a0b\uff0c\u5728\u8def\u7531\u8868\u6761\u76ee\u8f83\u591a\u7684\u60c5\u51b5\u4e0b\u80fd\u591f\u52a0\u5feb\u6267\u884c\u901f\u5ea6\u3002 [ root@VM-16-9-centos ~ ] # route Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface default gateway 0 .0.0.0 UG 0 0 0 eth0 10 .0.16.0 0 .0.0.0 255 .255.252.0 U 0 0 0 eth0 link-local 0 .0.0.0 255 .255.0.0 U 1002 0 0 eth0 172 .17.0.0 0 .0.0.0 255 .255.0.0 U 0 0 0 docker0 [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # [ root@VM-16-9-centos ~ ] # route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0 .0.0.0 10 .0.16.1 0 .0.0.0 UG 0 0 0 eth0 10 .0.16.0 0 .0.0.0 255 .255.252.0 U 0 0 0 eth0 169 .254.0.0 0 .0.0.0 255 .255.0.0 U 1002 0 0 eth0 172 .17.0.0 0 .0.0.0 255 .255.0.0 U 0 0 0 docker0","title":"3. \u67e5\u770b\u8def\u7531\u8868\u6761\u76ee"},{"location":"1.os/ubuntu/ubuntu-network-doc/#4","text":"\u901a\u8fc7 netstat \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u64cd\u4f5c\u7cfb\u7edf\u7684\u7f51\u7edc\u8fde\u63a5\u72b6\u6001\u3001\u8def\u7531\u8868\u3001\u63a5\u53e3\u7edf\u8ba1\u7b49\u4fe1\u606f\uff0c \u5b83\u662f\u4e86\u89e3\u7f51\u7edc\u72b6\u6001\u53ca\u6392\u9664\u7f51\u7edc\u670d\u52a1\u6545\u969c\u7684\u6709\u6548\u5de5\u5177\u3002\u4ee5\u4e0b\u662f netstat \u547d\u4ee4\u5e38\u7528\u7684\u51e0\u4e2a\u9009\u9879 -a\uff1a\u663e\u793a\u4e3b\u673a\u4e2d\u6240\u6709\u6d3b\u52a8\u7684\u7f51\u7edc\u8fde\u63a5\u4fe1\u606f\uff08\u5305\u62ec\u76d1\u542c\u3001\u975e\u76d1\u542c\u72b6\u6001\u7684\u670d\u52a1\u7aef\u53e3\uff09 -n\uff1a\u4ee5\u6570\u5b57\u7684\u5f62\u5f0f\u663e\u793a\u76f8\u5173\u7684\u4e3b\u673a\u5730\u5740\u3001\u7aef\u53e3\u7b49\u4fe1\u606f\u3002 -r\uff1a\u663e\u793a\u8def\u7531\u8868\u4fe1\u606f\u3002 -l\uff1a\u663e\u793a\u5904\u4e8e\u76d1\u542c\uff08Listening\uff09\u72b6\u6001\u7684\u7f51\u7edc\u8fde\u63a5\u53ca\u7aef\u53e3\u4fe1\u606f\u3002 -t\uff1a\u67e5\u770b TCP\uff08Transmission Control Protocol\uff0c\u4f20\u8f93\u63a7\u5236\u534f\u8bae\uff09\u76f8\u5173\u7684\u4fe1\u606f -u\uff1a\u663e\u793a UDP\uff08User Datagram Protocol\uff0c\u7528\u6237\u6570\u636e\u62a5\u534f\u8bae\uff09\u534f\u8bae\u76f8\u5173\u7684\u4fe1\u606f\u3002 -p\uff1a\u663e\u793a\u4e0e\u7f51\u7edc\u8fde\u63a5\u76f8\u5173\u8054\u7684\u8fdb\u7a0b\u53f7\u3001\u8fdb\u7a0b\u540d\u79f0\u4fe1\u606f\uff08\u8be5\u9009\u9879\u9700\u8981 root \u6743\u9650\uff09\u3002 \u901a\u5e38\u4f7f\u7528\u201c-anpt\u201d\u7ec4\u5408\u9009\u9879\uff0c\u4ee5\u6570\u5b57\u5f62\u5f0f\u663e\u793a\u5f53\u524d\u7cfb\u7edf\u4e2d\u6240\u6709\u7684 TCP \u8fde\u63a5\u4fe1\u606f\uff0c\u540c\u65f6\u663e \u793a\u5bf9\u5e94\u7684\u8fdb\u7a0b\u4fe1\u606f\u3002\u7ed3\u5408\u7ba1\u9053\u547d\u4ee4\u4f7f\u7528\u201cgrep\u201d\u547d\u4ee4\uff0c\u8fd8\u53ef\u4ee5\u5728\u7ed3\u679c\u4e2d\u8fc7\u6ee4\u51fa\u6240\u9700\u8981\u7684\u7279\u5b9a\u8bb0 \u5f55\u3002\u4f8b\u5982\uff0c\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\u53ef\u4ee5\u67e5\u770b\u672c\u673a\u4e2d\u662f\u5426\u6709\u76d1\u542c\u201cTCP 22\u201d\u7aef\u53e3\uff08\u5373\u6807\u51c6 Web \u670d\u52a1\uff09\u7684 \u670d\u52a1\u7a0b\u5e8f\uff0c\u8f93\u51fa\u4fe1\u606f\u4e2d\u5305\u62ec PID \u53f7\u548c\u8fdb\u7a0b\u540d\u79f0\u3002 [ root@VM-16-9-centos ~ ] # netstat -antp |grep 22 tcp 0 0 0 .0.0.0:22 0 .0.0.0:* LISTEN 4344 /sshd \u9664\u4e86 netstat\uff0css \u547d\u4ee4\u4e5f\u53ef\u4ee5\u67e5\u770b\u7f51\u7edc\u8fde\u63a5\u60c5\u51b5\uff0c\u5b83\u662f Socket Statistics \u7684\u7f29\u5199\uff0c\u4e3b\u8981 \u7528\u4e8e\u83b7\u53d6 socket \u7edf\u8ba1\u4fe1\u606f\uff0c\u5b83\u53ef\u4ee5\u663e\u793a\u548c netstat \u547d\u4ee4\u7c7b\u4f3c\u7684\u8f93\u51fa\u5185\u5bb9\u3002\u4f46 ss \u7684\u4f18\u52bf\u5728\u4e8e \u5b83\u80fd\u591f\u663e\u793a\u66f4\u591a\u66f4\u8be6\u7ec6\u7684\u6709\u5173 TCP \u548c\u8fde\u63a5\u72b6\u6001\u7684\u4fe1\u606f\uff0c\u800c\u4e14\u6bd4 netstat \u66f4\u5feb\u901f\u66f4\u9ad8\u6548\u3002\u8981\u60f3 \u4f7f\u7528 ss \u547d\u4ee4\uff0c\u9996\u5148\u786e\u4fdd iproute \u7a0b\u5e8f\u5305\u5df2\u88ab\u5b89\u88c5\uff0c\u53ef\u4ee5\u901a\u8fc7 yum \u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\u3002(\u7528\u6cd5\u7c7b\u4f3c) [ root@VM-16-9-centos ~ ] # ss -antp State Recv-Q Send-Q Local Address:Port Peer Address:Port LISTEN 0 128 *:22 *:* users: (( \"sshd\" ,pid = 4344 ,fd = 3 )) LISTEN 0 100 127 .0.0.1:25 *:*","title":"4. \u67e5\u770b\u7f51\u7edc\u8fde\u63a5\u60c5\u51b5"},{"location":"1.os/ubuntu/ubuntu-network-doc/#112","text":"\u7528\u6237\u8bbf\u95ee\u7f51\u7edc\u670d\u52a1\u7684\u524d\u63d0\u662f\u7f51\u7edc\u8fde\u63a5\u5904\u4e8e\u6b63\u5e38\u72b6\u6001\u3002\u82e5\u7f51\u7edc\u8fde\u63a5\u4e0d\u7a33\u5b9a\uff0c\u751a\u81f3\u65e0\u6cd5\u8fde\u63a5\uff0c \u7528\u6237\u5219\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u7f51\u7edc\u670d\u52a1\u3002\u56e0\u6b64\uff0c\u5f53\u7f51\u7edc\u8fde\u63a5\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u9700\u8981\u901a\u8fc7\u6d4b\u8bd5\u7f51\u7edc\u8fde\u63a5\u7684\u547d \u4ee4\u6765\u786e\u5b9a\u6545\u969c\u70b9\u3002\u4e0b\u9762\u4ecb\u7ecd\u51e0\u4e2a\u5e38\u7528\u7684\u6d4b\u8bd5\u7f51\u7edc\u8fde\u63a5\u7684\u547d\u4ee4\u3002","title":"1.1.2 \u6d4b\u8bd5\u7f51\u7edc\u8fde\u63a5"},{"location":"1.os/ubuntu/ubuntu-network-doc/#1_1","text":"[ root@VM-16-9-centos ~ ] # ping baidu.com","title":"1. \u6d4b\u8bd5\u7f51\u7edc\u8fde\u901a\u6027"},{"location":"1.os/ubuntu/ubuntu-network-doc/#2-dns","text":"[ root@VM-16-9-centos ~ ] # nslookup www.google.com Server: 183 .60.83.19 Address: 183 .60.83.19#53 Non-authoritative answer: Name: www.google.com Address: 174 .37.54.20 Name: www.google.com Address: 2001 ::68f4:2e15 [ root@VM-16-9-centos ~ ] # dig www.google.com ; <<>> DiG 9 .11.4-P2-RedHat-9.11.4-26.P2.el7_9.7 <<>> www.google.com ;; global options: +cmd ;; Got answer: ;; ->>HEADER <<- opco de: QUERY, status: NOERROR, id: 44445 ;; flags: qr rd ra ; QUERY: 1 , ANSWER: 1 , AUTHORITY: 0 , ADDITIONAL: 0 ;; QUESTION SECTION: ; www.google.com. IN A ;; ANSWER SECTION: www.google.com. 133 IN A 199 .59.149.206 ;; Query time: 1 msec ;; SERVER: 183 .60.83.19#53 ( 183 .60.83.19 ) ;; WHEN: \u4e94 11\u6708 18 15 :51:47 CST 2022 ;; MSG SIZE rcvd: 48","title":"2. \u6d4b\u8bd5DNS\u89e3\u6790"},{"location":"1.os/ubuntu/ubuntu-network-doc/#3-iperf","text":"server: iperf -s -p 1234 -i 1 clent: iperf -c 172 .16.240.204 -p 1234 -i 1 -t 20 -w 20w \u4fee\u6539\u7f51\u5361\u914d\u7f6e root@ubuntu:/home/ubuntu# cat /etc/netplan/00-installer-config.yaml # This is the network config written by 'subiquity' network: ethernets: ens18: addresses: - 192.168.1.114/24 gateway4: 192.168.1.1 nameservers: addresses: - 192.168.1.1 search: - 202.106.46.151 version: 2","title":"**3. iperf \u7f51\u7edc\u6d4b\u8bd5 **"},{"location":"1.os/ubuntu/ubuntu-nvme-doc/","text":"6.6. nvme \u6a21\u5757 \u00b6 \u67e5\u770b\u786c\u76d8\u5065\u5eb7\u72b6\u6001 smartctl smartctl -a /dev/nvme10n1 smartctl 7.2 2020-12-30 r5155 [x86_64-linux-5.15.0-60-generic] (local build) Copyright (C) 2002-20, Bruce Allen, Christian Franke, www.smartmontools.org === START OF INFORMATION SECTION === Model Number: WUS4BB076D7P3E3 Serial Number: A0608B4C Firmware Version: R1110021 PCI Vendor/Subsystem ID: 0x1b96 IEEE OUI Identifier: 0x0014ee Total NVM Capacity: 7,681,501,126,656 [7.68 TB] Unallocated NVM Capacity: 0 Controller ID: 0 NVMe Version: 1.3 Number of Namespaces: 1 Namespace 1 Size/Capacity: 7,681,501,126,656 [7.68 TB] Namespace 1 Formatted LBA Size: 4096 Namespace 1 IEEE EUI-64: 0014ee 83009c4080 Local Time is: Thu Feb 29 18:54:34 2024 CST Firmware Updates (0x19): 4 Slots, Slot 1 R/O, no Reset required Optional Admin Commands (0x001f): Security Format Frmw_DL NS_Mngmt Self_Test Optional NVM Commands (0x005e): Wr_Unc DS_Mngmt Wr_Zero Sav/Sel_Feat Timestmp Log Page Attributes (0x03): S/H_per_NS Cmd_Eff_Lg Warning Comp. Temp. Threshold: 70 Celsius Critical Comp. Temp. Threshold: 80 Celsius Namespace 1 Features (0x02): NA_Fields \u5217\u51fanvme\u76f8\u5173\u7684\u78c1\u76d8 apt install nvme-cli -y nvme list \u5b89\u88c5\u4e00\u5b9a\u7684\u683c\u5f0f\u8f93\u51fanvme\u7684\u78c1\u76d8\uff0c\u5e76\u7edf\u8ba1nvme\u78c1\u76d8\u7684\u4e2a\u6570 nvme list | tail -n +3 | awk '{print $1}' | sed 's/\\/dev\\///' | sort -V | awk '{print \"- name: \\\"\"$1\"\\\"\"}' # \u5217\u4e3e\u51fanvme\u6240\u6709\u78c1\u76d8 nvme list | tail -n +3 | awk '{print $1}' | sed 's/\\/dev\\///' | sort -V | awk '{print \"- name: \\\"\"$1\"\\\"\"}' |wc -l # \u7edf\u8ba1nvme\u78c1\u76d8","title":"Linux nvme\u78c1\u76d8\u7ba1\u7406"},{"location":"1.os/ubuntu/ubuntu-nvme-doc/#66-nvme","text":"\u67e5\u770b\u786c\u76d8\u5065\u5eb7\u72b6\u6001 smartctl smartctl -a /dev/nvme10n1 smartctl 7.2 2020-12-30 r5155 [x86_64-linux-5.15.0-60-generic] (local build) Copyright (C) 2002-20, Bruce Allen, Christian Franke, www.smartmontools.org === START OF INFORMATION SECTION === Model Number: WUS4BB076D7P3E3 Serial Number: A0608B4C Firmware Version: R1110021 PCI Vendor/Subsystem ID: 0x1b96 IEEE OUI Identifier: 0x0014ee Total NVM Capacity: 7,681,501,126,656 [7.68 TB] Unallocated NVM Capacity: 0 Controller ID: 0 NVMe Version: 1.3 Number of Namespaces: 1 Namespace 1 Size/Capacity: 7,681,501,126,656 [7.68 TB] Namespace 1 Formatted LBA Size: 4096 Namespace 1 IEEE EUI-64: 0014ee 83009c4080 Local Time is: Thu Feb 29 18:54:34 2024 CST Firmware Updates (0x19): 4 Slots, Slot 1 R/O, no Reset required Optional Admin Commands (0x001f): Security Format Frmw_DL NS_Mngmt Self_Test Optional NVM Commands (0x005e): Wr_Unc DS_Mngmt Wr_Zero Sav/Sel_Feat Timestmp Log Page Attributes (0x03): S/H_per_NS Cmd_Eff_Lg Warning Comp. Temp. Threshold: 70 Celsius Critical Comp. Temp. Threshold: 80 Celsius Namespace 1 Features (0x02): NA_Fields \u5217\u51fanvme\u76f8\u5173\u7684\u78c1\u76d8 apt install nvme-cli -y nvme list \u5b89\u88c5\u4e00\u5b9a\u7684\u683c\u5f0f\u8f93\u51fanvme\u7684\u78c1\u76d8\uff0c\u5e76\u7edf\u8ba1nvme\u78c1\u76d8\u7684\u4e2a\u6570 nvme list | tail -n +3 | awk '{print $1}' | sed 's/\\/dev\\///' | sort -V | awk '{print \"- name: \\\"\"$1\"\\\"\"}' # \u5217\u4e3e\u51fanvme\u6240\u6709\u78c1\u76d8 nvme list | tail -n +3 | awk '{print $1}' | sed 's/\\/dev\\///' | sort -V | awk '{print \"- name: \\\"\"$1\"\\\"\"}' |wc -l # \u7edf\u8ba1nvme\u78c1\u76d8","title":"6.6. nvme \u6a21\u5757"},{"location":"1.os/ubuntu/ubuntu-parted-doc/","text":"Parted \u547d\u4ee4 \u00b6 \u4f5c\u7528: \u89c4\u5212\u683c\u5f0f\u5316\u8d85\u8fc72T\u4ee5\u4e0a\u7684\u5206\u533a\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e8e\u5c0f\u5206\u533a\u7684\u89c4\u5212 parted /dev/sdb mklabel gpt # \u8bbe\u7f6e\u5206\u533a\u7c7b\u578b\u4e3agpt mkpart primary 0% 100% # \u5f00\u59cb\u5206\u533a \u5982\u56fe\u6240\u793a\uff1a \u6587\u7ae0\u53c2\u8003 \u00b6 \u6587\u7ae0\u5730\u5740: parted\u6587\u7ae0","title":"Linux parted\u78c1\u76d8\u7ba1\u7406"},{"location":"1.os/ubuntu/ubuntu-parted-doc/#parted","text":"\u4f5c\u7528: \u89c4\u5212\u683c\u5f0f\u5316\u8d85\u8fc72T\u4ee5\u4e0a\u7684\u5206\u533a\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e8e\u5c0f\u5206\u533a\u7684\u89c4\u5212 parted /dev/sdb mklabel gpt # \u8bbe\u7f6e\u5206\u533a\u7c7b\u578b\u4e3agpt mkpart primary 0% 100% # \u5f00\u59cb\u5206\u533a \u5982\u56fe\u6240\u793a\uff1a","title":"Parted \u547d\u4ee4"},{"location":"1.os/ubuntu/ubuntu-parted-doc/#_1","text":"\u6587\u7ae0\u5730\u5740: parted\u6587\u7ae0","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"1.os/ubuntu/ubuntu-reboot-doc/","text":"ubuntu \u5173\u673a\u6216\u8005\u91cd\u542f \u00b6 echo b > /proc/sysrq-trigger # \u5f3a\u5236\u91cd\u542f - https://developer.aliyun.com/article/520273 \u5b98\u7f51: \u53c2\u8003\u5730\u5740\u94fe\u63a5","title":"Linux \u7cfb\u7edf\u5f3a\u5236\u91cd\u542f"},{"location":"1.os/ubuntu/ubuntu-reboot-doc/#ubuntu","text":"echo b > /proc/sysrq-trigger # \u5f3a\u5236\u91cd\u542f - https://developer.aliyun.com/article/520273 \u5b98\u7f51: \u53c2\u8003\u5730\u5740\u94fe\u63a5","title":"ubuntu \u5173\u673a\u6216\u8005\u91cd\u542f"},{"location":"1.os/ubuntu/ubuntu-ssh-doc/","text":"\u5b89\u5168 \u00b6 \u4e94: \u7cfb\u7edf\u5b89\u5168 \u00b6 \u901a\u5e38\u5728\u4f01\u4e1a\u4e2d\uff0c\u670d\u52a1\u5668\u4f1a\u906d\u53d7\u5916\u6765\u7684\u5f88\u591a\u7684\u6076\u610f\u653b\u51fb\uff0c\u90a3\u4e48\u670d\u52a1\u5668\u7684\u5b89\u5168\u5c31\u663e\u5f97\u683c\u5916\u7684\u91cd\u8981\u3002\u9996\u5148\u80af\u5b9a\u60f3\u5230\u7684\u662f\u670d\u52a1\u5668\u7684\u5e10\u53f7\u548c\u5bc6\u7801\u7ba1\u7406\uff0c\u901a\u5e38\u7684\u60c5\u51b5\u4e0b\u4f1a\u7981\u6b62root\u8fd9\u6837\u7684\u7ba1\u7406\u5458\u7528\u6237\u767b\u9646\uff0c\u4e5f\u4f1a\u7981\u6b62\u5bc6\u7801\u8fd9\u6837\u7684\u65b9\u5f0f\u767b\u9646\u3002 \u539f\u56e0: root\u7528\u6237\u7684\u6743\u9650\u592a\u9ad8\uff0c\u5982\u679c\u4e00\u65e6\u5e10\u53f7\u5bc6\u7801\u6cc4\u6f0f\uff0c\u5c31\u4f1a\u9020\u6210\u5f88\u4e25\u91cd\u7684\u540e\u679c\u3002 \u7981\u6b62\u5bc6\u7801\u65b9\u5f0f\u767b\u9646\u4e5f\u662f\u4e3a\u4e86\u5b89\u5168\u8003\u8651\uff0c\u6bd5\u7adf\u5bc6\u7801\u4e22\u5931\u4e5f\u662f\u5f88\u5e73\u5e38\u7684\u4e8b\u60c5\u3002\u63a8\u8350\u4f7f\u7528\u516c\u94a5\u7684\u65b9\u5f0f\u6765\u767b\u9646\u670d\u52a1\u5668\u3002 5.1: \u7981\u6b62root\u7528\u6237: \uff08centos/ubuntu\u90fd\u9002\u7528\uff09 \u00b6 \u53ef\u4ee5\u4fee\u6539 /etc/ssh/sshd_config \u914d\u7f6e\u6587\u4ef6 \u6dfb\u52a0: PermitRootLogin yes \u914d\u7f6e\uff08\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u5728\u5b8c\u6210\u521d\u59cb\u5316\u5c31\u7981\u6b62root\u767b\u9646\u4e86\uff09 yes \u4e3a\u5141\u8bb8root\u767b\u9646 no \u4e3a\u7981\u6b62root\u767b\u9646 \u91cd\u65b0\u542f\u52a8sshd\u670d\u52a1\u3002 systemctl restart sshd \u5f53\u7136\u4e5f\u53ef\u4ee5\u52a0\u5165\u7cfb\u7edf\u521d\u59cb\u5316\u6b65\u9aa4\u4e2d\uff0c\u7565\uff5e 5.2: \u5bc6\u94a5\u5bf9\u6765\u767b\u9646\u670d\u52a1\u5668 \u00b6 \u751f\u6210\u516c\u94a5\u548c\u79c1\u94a5 root@user:~# ssh-keygen //\u4e00\u8def\u56de\u8f66 Generating public/private rsa key pair. Enter file in which to save the key ( /root/.ssh/id_rsa ) : Enter passphrase ( empty for no passphrase ) : Enter same passphrase again: Your identification has been saved in /root/.ssh/id_rsa Your public key has been saved in /root/.ssh/id_rsa.pub The key fingerprint is: SHA256:J0s/ZHIRTj/UCcDQLHtxd5Qa0p3r2CYlcz7lPS7VaXU root@user The key ' s randomart image is: +--- [ RSA 3072 ] ----+ | . = +.+o.o+ | | .o == .o++. | | ooo+.o.. | | . .. = +E | | S. = X.B | | . X o @+ | | . o * o | | . . . | | . | +---- [ SHA256 ] -----+ \u8fd9\u4e2a\u65f6\u5019\u5728.ssh\u76ee\u5f55\u4e0b\u751f\u6210\u51e0\u4e2a\u6587\u4ef6 root@user:~# ll .ssh/ total 16 drwx------ 2 root root 4096 Sep 20 09 :46 ./ drwx------ 5 root root 4096 Sep 20 09 :35 ../ -rw------- 1 root root 0 May 24 15 :30 authorized_keys // \u8fd9\u4e2a\u662f\u6388\u6743\u6587\u4ef6 -rw------- 1 root root 2590 Sep 20 09 :46 id_rsa // \u8fd9\u4e2a\u662f\u79c1\u94a5\u6587\u4ef6 -rw-r--r-- 1 root root 563 Sep 20 09 :46 id_rsa.pub //\u8fd9\u4e2a\u662f\u516c\u94a5\u6587\u4ef6 \u5c06\u516c\u94a5\u52a0\u5165user\u7528\u6237\u4e0b: .ssh/authorized_keys root@user:/home/user# ls -a .ssh/ . .. authorized_keys \u8bdd\u4e0d\u591a\u8bf4\u6d4b\u8bd5\u767b\u9646 $ ssh user@172.30.42.244 //\u8fd9\u662f\u6211\u4eec\u4f7f\u7528user\u7528\u6237\u767b\u9646\uff0c\u5c31\u4e0d\u9700\u8981\u5bc6\u7801\u4e86 Welcome to Ubuntu 20 .04.4 LTS ( GNU/Linux 5 .4.0-113-generic x86_64 ) \u5f53\u7136\u4e86\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e0b\u8fd9\u6837\u6dfb\u52a0\u81ea\u5df1\u7684\u516c\u94a5 curl https://openbayes.com/api/users/lixie/keys.txt >> authorized_keys \u7981\u6b62\u7528\u6237\u5bc6\u7801\u767b\u9646 \u4e3a\u4e86\u5b89\u5168\u7684\u8003\u8651\uff0c\u6211\u4eec\u9700\u8981\u5173\u95ed\u7528\u6237\u5bc6\u7801\u767b\u9646\u7684\u8fd9\u79cd\u65b9\u5f0f PubkeyAuthentication yes # \u542f\u7528\u516c\u544a\u5bc6\u94a5\u914d\u5bf9\u8ba4\u8bc1\u65b9\u5f0f RSAAuthentication yes # \u5141\u8bb8RSA\u5bc6\u94a5 PasswordAuthentication no # \u7981\u6b62\u5bc6\u7801\u9a8c\u8bc1\u767b\u5f55,\u5982\u679c\u542f\u7528\u7684\u8bdd,RSA\u8ba4\u8bc1\u767b\u5f55\u5c31\u6ca1\u6709\u610f\u4e49\u4e86 PermitRootLogin no # \u7981\u7528root\u8d26\u6237\u767b\u5f55\uff0c\u975e\u5fc5\u8981\uff0c\u4f46\u4e3a\u4e86\u5b89\u5168\u6027\uff0c\u8bf7\u914d\u7f6e \u8fd9\u6837\u7ed3\u5408\u4e0a\u4e00\u6b65\u9aa4\uff0c\u5173\u95ed\u7528\u6237\u8d26\u53f7\u5bc6\u7801\u9a8c\u8bc1\u65b9\u5f0f\uff0c\u53ea\u91c7\u7528\u5bc6\u94a5\u5bf9\u4f1a\u5b89\u5168\u5f88\u591a\u3002","title":"Ubuntu ssh doc"},{"location":"1.os/ubuntu/ubuntu-ssh-doc/#_1","text":"","title":"\u5b89\u5168"},{"location":"1.os/ubuntu/ubuntu-ssh-doc/#_2","text":"\u901a\u5e38\u5728\u4f01\u4e1a\u4e2d\uff0c\u670d\u52a1\u5668\u4f1a\u906d\u53d7\u5916\u6765\u7684\u5f88\u591a\u7684\u6076\u610f\u653b\u51fb\uff0c\u90a3\u4e48\u670d\u52a1\u5668\u7684\u5b89\u5168\u5c31\u663e\u5f97\u683c\u5916\u7684\u91cd\u8981\u3002\u9996\u5148\u80af\u5b9a\u60f3\u5230\u7684\u662f\u670d\u52a1\u5668\u7684\u5e10\u53f7\u548c\u5bc6\u7801\u7ba1\u7406\uff0c\u901a\u5e38\u7684\u60c5\u51b5\u4e0b\u4f1a\u7981\u6b62root\u8fd9\u6837\u7684\u7ba1\u7406\u5458\u7528\u6237\u767b\u9646\uff0c\u4e5f\u4f1a\u7981\u6b62\u5bc6\u7801\u8fd9\u6837\u7684\u65b9\u5f0f\u767b\u9646\u3002 \u539f\u56e0: root\u7528\u6237\u7684\u6743\u9650\u592a\u9ad8\uff0c\u5982\u679c\u4e00\u65e6\u5e10\u53f7\u5bc6\u7801\u6cc4\u6f0f\uff0c\u5c31\u4f1a\u9020\u6210\u5f88\u4e25\u91cd\u7684\u540e\u679c\u3002 \u7981\u6b62\u5bc6\u7801\u65b9\u5f0f\u767b\u9646\u4e5f\u662f\u4e3a\u4e86\u5b89\u5168\u8003\u8651\uff0c\u6bd5\u7adf\u5bc6\u7801\u4e22\u5931\u4e5f\u662f\u5f88\u5e73\u5e38\u7684\u4e8b\u60c5\u3002\u63a8\u8350\u4f7f\u7528\u516c\u94a5\u7684\u65b9\u5f0f\u6765\u767b\u9646\u670d\u52a1\u5668\u3002","title":"\u4e94: \u7cfb\u7edf\u5b89\u5168"},{"location":"1.os/ubuntu/ubuntu-ssh-doc/#51-root-centosubuntu","text":"\u53ef\u4ee5\u4fee\u6539 /etc/ssh/sshd_config \u914d\u7f6e\u6587\u4ef6 \u6dfb\u52a0: PermitRootLogin yes \u914d\u7f6e\uff08\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u5728\u5b8c\u6210\u521d\u59cb\u5316\u5c31\u7981\u6b62root\u767b\u9646\u4e86\uff09 yes \u4e3a\u5141\u8bb8root\u767b\u9646 no \u4e3a\u7981\u6b62root\u767b\u9646 \u91cd\u65b0\u542f\u52a8sshd\u670d\u52a1\u3002 systemctl restart sshd \u5f53\u7136\u4e5f\u53ef\u4ee5\u52a0\u5165\u7cfb\u7edf\u521d\u59cb\u5316\u6b65\u9aa4\u4e2d\uff0c\u7565\uff5e","title":"5.1: \u7981\u6b62root\u7528\u6237: \uff08centos/ubuntu\u90fd\u9002\u7528\uff09"},{"location":"1.os/ubuntu/ubuntu-ssh-doc/#52","text":"\u751f\u6210\u516c\u94a5\u548c\u79c1\u94a5 root@user:~# ssh-keygen //\u4e00\u8def\u56de\u8f66 Generating public/private rsa key pair. Enter file in which to save the key ( /root/.ssh/id_rsa ) : Enter passphrase ( empty for no passphrase ) : Enter same passphrase again: Your identification has been saved in /root/.ssh/id_rsa Your public key has been saved in /root/.ssh/id_rsa.pub The key fingerprint is: SHA256:J0s/ZHIRTj/UCcDQLHtxd5Qa0p3r2CYlcz7lPS7VaXU root@user The key ' s randomart image is: +--- [ RSA 3072 ] ----+ | . = +.+o.o+ | | .o == .o++. | | ooo+.o.. | | . .. = +E | | S. = X.B | | . X o @+ | | . o * o | | . . . | | . | +---- [ SHA256 ] -----+ \u8fd9\u4e2a\u65f6\u5019\u5728.ssh\u76ee\u5f55\u4e0b\u751f\u6210\u51e0\u4e2a\u6587\u4ef6 root@user:~# ll .ssh/ total 16 drwx------ 2 root root 4096 Sep 20 09 :46 ./ drwx------ 5 root root 4096 Sep 20 09 :35 ../ -rw------- 1 root root 0 May 24 15 :30 authorized_keys // \u8fd9\u4e2a\u662f\u6388\u6743\u6587\u4ef6 -rw------- 1 root root 2590 Sep 20 09 :46 id_rsa // \u8fd9\u4e2a\u662f\u79c1\u94a5\u6587\u4ef6 -rw-r--r-- 1 root root 563 Sep 20 09 :46 id_rsa.pub //\u8fd9\u4e2a\u662f\u516c\u94a5\u6587\u4ef6 \u5c06\u516c\u94a5\u52a0\u5165user\u7528\u6237\u4e0b: .ssh/authorized_keys root@user:/home/user# ls -a .ssh/ . .. authorized_keys \u8bdd\u4e0d\u591a\u8bf4\u6d4b\u8bd5\u767b\u9646 $ ssh user@172.30.42.244 //\u8fd9\u662f\u6211\u4eec\u4f7f\u7528user\u7528\u6237\u767b\u9646\uff0c\u5c31\u4e0d\u9700\u8981\u5bc6\u7801\u4e86 Welcome to Ubuntu 20 .04.4 LTS ( GNU/Linux 5 .4.0-113-generic x86_64 ) \u5f53\u7136\u4e86\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e0b\u8fd9\u6837\u6dfb\u52a0\u81ea\u5df1\u7684\u516c\u94a5 curl https://openbayes.com/api/users/lixie/keys.txt >> authorized_keys \u7981\u6b62\u7528\u6237\u5bc6\u7801\u767b\u9646 \u4e3a\u4e86\u5b89\u5168\u7684\u8003\u8651\uff0c\u6211\u4eec\u9700\u8981\u5173\u95ed\u7528\u6237\u5bc6\u7801\u767b\u9646\u7684\u8fd9\u79cd\u65b9\u5f0f PubkeyAuthentication yes # \u542f\u7528\u516c\u544a\u5bc6\u94a5\u914d\u5bf9\u8ba4\u8bc1\u65b9\u5f0f RSAAuthentication yes # \u5141\u8bb8RSA\u5bc6\u94a5 PasswordAuthentication no # \u7981\u6b62\u5bc6\u7801\u9a8c\u8bc1\u767b\u5f55,\u5982\u679c\u542f\u7528\u7684\u8bdd,RSA\u8ba4\u8bc1\u767b\u5f55\u5c31\u6ca1\u6709\u610f\u4e49\u4e86 PermitRootLogin no # \u7981\u7528root\u8d26\u6237\u767b\u5f55\uff0c\u975e\u5fc5\u8981\uff0c\u4f46\u4e3a\u4e86\u5b89\u5168\u6027\uff0c\u8bf7\u914d\u7f6e \u8fd9\u6837\u7ed3\u5408\u4e0a\u4e00\u6b65\u9aa4\uff0c\u5173\u95ed\u7528\u6237\u8d26\u53f7\u5bc6\u7801\u9a8c\u8bc1\u65b9\u5f0f\uff0c\u53ea\u91c7\u7528\u5bc6\u94a5\u5bf9\u4f1a\u5b89\u5168\u5f88\u591a\u3002","title":"5.2: \u5bc6\u94a5\u5bf9\u6765\u767b\u9646\u670d\u52a1\u5668"},{"location":"20.mylife/2021-life-docs/","text":"\u6211\u76842021 \u00b6 Hello! \u5927\u5bb6\u597d\uff0c\u6211\u662f\u6765\u81ea\u5c71\u897f\u7684\u5317\u6f02\u4e00\u65cf\uff0c\u8bb0\u5f55\u6587\u7ae0\u4e3b\u8981\u662f\u5b66\u4e60\u548c\u4e2a\u4eba\u7684\u4e00\u4e9b\u7231\u597d\uff01 \u8fd9\u91cc\u4e3b\u8981\u629b\u5f00\u5de5\u4f5c\uff0c\u6765\u804a\u804a\u81ea\u5df1\u7684\u4e2a\u4eba\u751f\u6d3b\u548c\u672a\u6765\u89c4\u5212\u3002 \u90a32021\u5462\uff0c\u662f\u6211\u6765\u5317\u4eac\u5de5\u4f5c\u7684\u7b2c\u4e00\u5e74\uff0c\u4e5f\u662f\u548c\u5927\u591a\u6570\u7684\u4e0a\u73ed\u65cf\u4e00\u6837\uff0c\u62b1\u7740\u8ff7\u832b\u7684\u773c\u795e\u6765\u5230\u8fd9\u4e2a\u5927\u7684\u57ce\u5e02\uff0c\u4e5f\u4e0d\u77e5\u5230\u672a\u6765\u4f1a\u548b\u6837\uff0c\u4f46\u662f\u8fd8\u662f\u60f3\u7740\u8bf4\u5e74\u8f7b\u5e94\u8be5\u591a\u95ef\u8361\u4e00\u4e0b\uff0c\u6bd5\u7adf\u5e74\u8f7b\u6709\u8bd5\u9519\u7684\u673a\u4f1a\uff5e \uff0c\u4e07\u4e00\u5bf9\u5427\uff0c\u6df7\u7684\u4e0d\u9519\uff0c\u4e5f\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\uff0c\u6b63\u5982\u738b\u8001\u677f\u8bf4\u7684\u6e05\u534e\u5317\u5927\u4e0d\u5982\u80c6\u5b50\u5927\uff0c\u54c8\u54c8\u54c8\uff0c\u5f53\u7136\u662f\u51e1\u5c14\u8d5b\u3002\u8c01\u8fd8\u6ca1\u6709\u4e00\u4ebf\u7684\u5c0f\u76ee\u6807\u5462\uff01 \u5148\u4ecb\u7ecd\u4e00\u4e0b\u6765\u5317\u4eac\u7b2c\u4e00\u5bb6\u516c\u53f8\uff0c\u662f\u505a\u4e92\u8054\u7f51\u6559\u80b2\u7684\uff0c\u5b98\u65b9\u4e00\u70b9\u7684\u8bdd\u53eb\u6559\u5b66\u4e91\u670d\u52a1\u5e73\u53f0\uff0c\u8bf4\u767d\u4e86\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u5e2e\u52a9\u8001\u5e08\u6559\u5b66\u7684\u4e00\u6b3e\u5de5\u5177\uff0c\u5982\u679c\u5b9e\u5728\u7406\u89e3\u4e0d\u4e86\uff0c\u5c31\u6bd4\u5982\u6709\u4e9b\u4eba\u79bb\u5f00github\uff0c\u8fd9\u4e2a\u4ee3\u7801\u6211\u5c31\u4e0d\u4f1a\u5199\u4e0d\u4e86\uff5e \u4e0d\u8fc7\u603b\u7684\u6765\u8bf4\u6211\u4e5f\u7ecf\u5386\u7684\u6765\u4e00\u6b21\u516c\u53f8\u7684\u642c\u5bb6\uff0c\u4ece\u524d\u516b\u5bb6\u642c\u5230\u6c47\u667a\u5927\u53a6\uff0c\u4e0b\u9762\u6765\u6211\u62cd\u4e86\u4e00\u5f20\u56fe\u53ef\u4ee5\u770b\u4e00\u4e0b \u53ef\u4ee5\u5148\u770b\u4e00\u4e0b\u88c5\u4fee\u524d\u7684\u6837\u5b50 \u597d\u5bb6\u4f19\uff0c\u4e0d\u77e5\u9053\u7684\u8fd8\u4ee5\u4e3a\u662f\u5e9f\u589f\u5462 \u88c5\u4fee\u597d\u4e4b\u540e\u8fd8\u662f\u5f88\u597d\u7684 \u5176\u5b9e\u8fd8\u662f\u76f8\u5f53\u5927\u7684\uff0c\u6bd4\u8d77\u4e4b\u524d\u7684\u90a3\u4e2a\u73af\u5883\u8981\u597d\u4e0d\u5c11\u3002\u524d\u9762\u90a3\u4f4d\u662f\u6211\u7684leader\uff01 \u4e0d\u8fc7\u5728\u8fd9\u91cc\u5de5\u4f5c\u6211\u8ba4\u4e3a\u6700\u4e0d\u8212\u670d\u7684\u5c31\u662f\u6709\u70b9\u592a\u8d76\u4e86\uff0c\u5c31\u50cf\u662f\u960e\u738b\u7237\u50ac\u547d\u4f3c\u7684\uff0c\u800c\u4e14\u5929\u5929\u5f00\u4f1a\u8fd9\u4e2a\u771f\u7684\u8ba9\u4eba\u65e0\u6cd5\u7406\u89e3\uff0c\u5f53\u7136\u5927\u90e8\u5206\u516c\u53f8\u90fd\u662f\u8fd9\u6837\uff0c\u4e5f\u662f\u6ca1\u5f97\u529e\u6cd5\uff0c\u6253\u5de5\u4eba\u4e0d\u5c31\u662f\u4eba\u5bb6\u8ba9\u5e72\u5565\u548b\u5c31\u5e72\u5565\uff5e \u4e5f\u662f\u5927\u90e8\u5206\u4e2d\u56fd\u516c\u53f8\u7684\u901a\u75c5\uff0c\u4e0d\u8fc7\u4e2a\u4eba\u633a\u4e0d\u559c\u6b22\u8fd9\u6837\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u6709\u6bb5\u65f6\u95f4\u7b80\u76f4\u6709\u70b9\u5c0f\u5d29\u6e83\uff0c\u540e\u6765\u60f3\u60f3\u65e2\u7136\u89e3\u51b3\u4e0d\u4e86\u95ee\u9898\uff0c\u5c31\u89e3\u51b3\u6211\uff0c\u54c8\u54c8\u54c8\uff5e \u603b\u7684\u6765\u8bf4: \u4e2a\u4eba\u8bc4\u4ef7\u4e0d\u4ee3\u8868\u6240\u6709\u4eba\u7684\u770b\u6cd5\uff0c\u516c\u53f8\u7684\u5927\u90e8\u5206\u540c\u4e8b\u90fd\u662f\u7279\u522b\u597d\u7684\uff0c\u9886\u5bfc\u4e5f\u6bd4\u8f83\u7684\u968f\u548c\uff0c\u6ca1\u6709\u4ec0\u4e48\u5b98\u67b6\u5b50\uff0c\u9664\u4e86\u516c\u53f8\u5236\u5ea6\u4e2a\u4eba\u6709\u70b9\u63a5\u53d7\u4e0d\u4e86\u4ee5\u5916\uff0c\u8fd8\u662f\u633a\u4e0d\u9519\u7684\u3002 \u8981\u8bf4\u5728\u5317\u4eac\u9664\u4e86\u5de5\u4f5c\uff0c\u4ec0\u4e48\u6700\u7d2f\uff1f \u4e0d\u7528\u8bf4\uff0c\u642c\u5bb6\uff01 \u90a3\u4e48\u6211\u662f\u4ece\u8042\u5404\u5e84\u642c\u5230\u5929\u901a\u82d1\uff08\u4e9a\u6d32\u6700\u5927\u793e\u533a\uff09 \u8fd8\u771f\u7684\u662f\uff0c\u4e0d\u6765\u4e0d\u77e5\u9053\uff0c\u6765\u4e86\u5c31\u518d\u4e5f\u4e0d\u60f3\u6765\u4e86\uff01 \u90a3\u5c31\u6709\u5f88\u591a\u4e0d\u7406\u89e3\u7684\u5c0f\u660e\u8bf4\u4e3a\u5565\u4e0d\u60f3\u6765\u4e86\uff0c\u53ef\u4ee5\u770b\u770b\u4e0b\u9762\u8fd9\u5f20\u56fe \u770b\u628a\u8fd9\u5927\u59b9\u5b50\u6324\u7684\uff0c\u8981\u8bf4\u600e\u4e48\u624d\u80fd\u6324\u4e0a\u5730\u94c1\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u4e00\u4e0b\u4e24\u7c73\u51b2\u523a\u4e4b\u7c7b\u7684\u524d\u51b2\u52a8\u4f5c\uff0c\u5728\u5f00\u95e8\u7684\u4e00\u77ac\u95f4\u8d77\u8df3\u3002 \u5982\u679c\u4f60\u540e\u9762\u6709\u4e94\u7c73\u9ad8\u7684\u58ee\u6c49\uff0c\u90a3\u606d\u559c\u4f60\u51b2\u523a\u5c31\u4e0d\u9700\u8981\u4e86\uff0c\u8fd9\u4e2a\u808c\u8089\u731b\u7537\u53ef\u4ee5\u76f4\u63a5\u5c06\u4f60\u9001\u4f60\u5230\u8f66\u53a2\u7684\u6b63\u4e2d\u95f4\u3002\u800c\u4e14\u5929\u901a\u82d1\u79df\u623f\u5b50\u73af\u5883\u5f88\u4e0d\u53cb\u597d\uff0c\u4e00\u822c\u90fd\u662f \u7fa4\u5c45 \uff0c\u5efa\u8bae\u6709\u5173\u90e8\u95e8\u53ef\u4ee5\u597d\u597d\u67e5\u67e5\uff5e \u901a\u8fc7\u8fd9\u4e24\u70b9\u5c31\u8db3\u4ee5\u88ab\u8bc4\u4e0a\u6700\u5dee\u5e78\u798f\u6307\u6570\u7b2c\u4e00\u540d\u3002 \u4e0d\u8fc7\u503c\u5f97\u9ad8\u5174\u7684\u662f\uff0c\u4e0a\u73ed\u7684\u65f6\u95f4\u4ece\u957f\u8fbe1\u4e2a\u5c0f\u65f640\u5206\u949f\u51cf\u5c11\u52301\u4e2a\u5c0f\u65f6\u3002\uff08\u53ef\u4ee5\u591a\u7761\u534a\u5c0f\u65f6\uff09 \u5f53\u7136\u79df\u623f\u5343\u4e07\u4e0d\u8981\u5927\u610f\uff0c\u4e0d\u8981\u4fe1\u4efb\u4f55\u4e2d\u4ecb\u6ca1\u6709\u4e66\u9762\u5408\u540c\u7684\u9b3c\u8bdd\uff0c\u4eba\u751f\u7ecf\u9a8c\u554a\uff01\u4e0d\u7136\u7684\u8bdd\uff0c\u4e2d\u4ecb\u4f1a\u548c\u4f60\u7b7e\u7f72\u4e00\u7cfb\u5217\u7684\u4e0d\u5e73\u7b49\u6761\u7ea6\uff0c\u6700\u540e\u8fd8\u8981\u60f3\u5c3d\u529e\u6cd5\u6263\u4f60\u7684\u62bc\u91d1\uff0c\u4e0d\u8981\u95ee\u6211\u600e\u4e48\u77e5\u9053\u7684\uff5e \u6240\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u9075\u7eaa\u5b88\u6cd5\u7684\u597d\u516c\u6c11\uff0c\u6211\u80af\u5b9a\u4f1a\u5148\u95ee\u5019\u7684\u4ed6\u4eec\u7684\u7956\u5b97\u5341\u516b\u4ee3\u4e4b\u540e\uff0c\u518d\u6253\u4e2a\u6295\u8bc9\u7535\u8bdd\uff0c\u8ba9\u76f8\u5173\u90e8\u95e8\u5904\u7406\uff0c\u4e00\u4e2a\u4e0d\u5c0f\u5fc3\u5c31\u5168\u62c6\u4e86\u3002\u7531\u6b64\u53ef\u4ee5\u5f97\u51fa\u4e00\u4e2a\u5e7f\u544a\u8bed: \u5927\u5bb6\u597d\uff0c\u624d\u662f\u771f\u7684\u597d\u3002 \u9177\u72d7\u97f3\u4e50\u89e3\u9501 https://demo.unlock-music.dev/ https://blog.csdn.net/r1553789169/article/details/106900832","title":"\u6211\u76842021"},{"location":"20.mylife/2021-life-docs/#2021","text":"Hello! \u5927\u5bb6\u597d\uff0c\u6211\u662f\u6765\u81ea\u5c71\u897f\u7684\u5317\u6f02\u4e00\u65cf\uff0c\u8bb0\u5f55\u6587\u7ae0\u4e3b\u8981\u662f\u5b66\u4e60\u548c\u4e2a\u4eba\u7684\u4e00\u4e9b\u7231\u597d\uff01 \u8fd9\u91cc\u4e3b\u8981\u629b\u5f00\u5de5\u4f5c\uff0c\u6765\u804a\u804a\u81ea\u5df1\u7684\u4e2a\u4eba\u751f\u6d3b\u548c\u672a\u6765\u89c4\u5212\u3002 \u90a32021\u5462\uff0c\u662f\u6211\u6765\u5317\u4eac\u5de5\u4f5c\u7684\u7b2c\u4e00\u5e74\uff0c\u4e5f\u662f\u548c\u5927\u591a\u6570\u7684\u4e0a\u73ed\u65cf\u4e00\u6837\uff0c\u62b1\u7740\u8ff7\u832b\u7684\u773c\u795e\u6765\u5230\u8fd9\u4e2a\u5927\u7684\u57ce\u5e02\uff0c\u4e5f\u4e0d\u77e5\u5230\u672a\u6765\u4f1a\u548b\u6837\uff0c\u4f46\u662f\u8fd8\u662f\u60f3\u7740\u8bf4\u5e74\u8f7b\u5e94\u8be5\u591a\u95ef\u8361\u4e00\u4e0b\uff0c\u6bd5\u7adf\u5e74\u8f7b\u6709\u8bd5\u9519\u7684\u673a\u4f1a\uff5e \uff0c\u4e07\u4e00\u5bf9\u5427\uff0c\u6df7\u7684\u4e0d\u9519\uff0c\u4e5f\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\uff0c\u6b63\u5982\u738b\u8001\u677f\u8bf4\u7684\u6e05\u534e\u5317\u5927\u4e0d\u5982\u80c6\u5b50\u5927\uff0c\u54c8\u54c8\u54c8\uff0c\u5f53\u7136\u662f\u51e1\u5c14\u8d5b\u3002\u8c01\u8fd8\u6ca1\u6709\u4e00\u4ebf\u7684\u5c0f\u76ee\u6807\u5462\uff01 \u5148\u4ecb\u7ecd\u4e00\u4e0b\u6765\u5317\u4eac\u7b2c\u4e00\u5bb6\u516c\u53f8\uff0c\u662f\u505a\u4e92\u8054\u7f51\u6559\u80b2\u7684\uff0c\u5b98\u65b9\u4e00\u70b9\u7684\u8bdd\u53eb\u6559\u5b66\u4e91\u670d\u52a1\u5e73\u53f0\uff0c\u8bf4\u767d\u4e86\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u5e2e\u52a9\u8001\u5e08\u6559\u5b66\u7684\u4e00\u6b3e\u5de5\u5177\uff0c\u5982\u679c\u5b9e\u5728\u7406\u89e3\u4e0d\u4e86\uff0c\u5c31\u6bd4\u5982\u6709\u4e9b\u4eba\u79bb\u5f00github\uff0c\u8fd9\u4e2a\u4ee3\u7801\u6211\u5c31\u4e0d\u4f1a\u5199\u4e0d\u4e86\uff5e \u4e0d\u8fc7\u603b\u7684\u6765\u8bf4\u6211\u4e5f\u7ecf\u5386\u7684\u6765\u4e00\u6b21\u516c\u53f8\u7684\u642c\u5bb6\uff0c\u4ece\u524d\u516b\u5bb6\u642c\u5230\u6c47\u667a\u5927\u53a6\uff0c\u4e0b\u9762\u6765\u6211\u62cd\u4e86\u4e00\u5f20\u56fe\u53ef\u4ee5\u770b\u4e00\u4e0b \u53ef\u4ee5\u5148\u770b\u4e00\u4e0b\u88c5\u4fee\u524d\u7684\u6837\u5b50 \u597d\u5bb6\u4f19\uff0c\u4e0d\u77e5\u9053\u7684\u8fd8\u4ee5\u4e3a\u662f\u5e9f\u589f\u5462 \u88c5\u4fee\u597d\u4e4b\u540e\u8fd8\u662f\u5f88\u597d\u7684 \u5176\u5b9e\u8fd8\u662f\u76f8\u5f53\u5927\u7684\uff0c\u6bd4\u8d77\u4e4b\u524d\u7684\u90a3\u4e2a\u73af\u5883\u8981\u597d\u4e0d\u5c11\u3002\u524d\u9762\u90a3\u4f4d\u662f\u6211\u7684leader\uff01 \u4e0d\u8fc7\u5728\u8fd9\u91cc\u5de5\u4f5c\u6211\u8ba4\u4e3a\u6700\u4e0d\u8212\u670d\u7684\u5c31\u662f\u6709\u70b9\u592a\u8d76\u4e86\uff0c\u5c31\u50cf\u662f\u960e\u738b\u7237\u50ac\u547d\u4f3c\u7684\uff0c\u800c\u4e14\u5929\u5929\u5f00\u4f1a\u8fd9\u4e2a\u771f\u7684\u8ba9\u4eba\u65e0\u6cd5\u7406\u89e3\uff0c\u5f53\u7136\u5927\u90e8\u5206\u516c\u53f8\u90fd\u662f\u8fd9\u6837\uff0c\u4e5f\u662f\u6ca1\u5f97\u529e\u6cd5\uff0c\u6253\u5de5\u4eba\u4e0d\u5c31\u662f\u4eba\u5bb6\u8ba9\u5e72\u5565\u548b\u5c31\u5e72\u5565\uff5e \u4e5f\u662f\u5927\u90e8\u5206\u4e2d\u56fd\u516c\u53f8\u7684\u901a\u75c5\uff0c\u4e0d\u8fc7\u4e2a\u4eba\u633a\u4e0d\u559c\u6b22\u8fd9\u6837\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u6709\u6bb5\u65f6\u95f4\u7b80\u76f4\u6709\u70b9\u5c0f\u5d29\u6e83\uff0c\u540e\u6765\u60f3\u60f3\u65e2\u7136\u89e3\u51b3\u4e0d\u4e86\u95ee\u9898\uff0c\u5c31\u89e3\u51b3\u6211\uff0c\u54c8\u54c8\u54c8\uff5e \u603b\u7684\u6765\u8bf4: \u4e2a\u4eba\u8bc4\u4ef7\u4e0d\u4ee3\u8868\u6240\u6709\u4eba\u7684\u770b\u6cd5\uff0c\u516c\u53f8\u7684\u5927\u90e8\u5206\u540c\u4e8b\u90fd\u662f\u7279\u522b\u597d\u7684\uff0c\u9886\u5bfc\u4e5f\u6bd4\u8f83\u7684\u968f\u548c\uff0c\u6ca1\u6709\u4ec0\u4e48\u5b98\u67b6\u5b50\uff0c\u9664\u4e86\u516c\u53f8\u5236\u5ea6\u4e2a\u4eba\u6709\u70b9\u63a5\u53d7\u4e0d\u4e86\u4ee5\u5916\uff0c\u8fd8\u662f\u633a\u4e0d\u9519\u7684\u3002 \u8981\u8bf4\u5728\u5317\u4eac\u9664\u4e86\u5de5\u4f5c\uff0c\u4ec0\u4e48\u6700\u7d2f\uff1f \u4e0d\u7528\u8bf4\uff0c\u642c\u5bb6\uff01 \u90a3\u4e48\u6211\u662f\u4ece\u8042\u5404\u5e84\u642c\u5230\u5929\u901a\u82d1\uff08\u4e9a\u6d32\u6700\u5927\u793e\u533a\uff09 \u8fd8\u771f\u7684\u662f\uff0c\u4e0d\u6765\u4e0d\u77e5\u9053\uff0c\u6765\u4e86\u5c31\u518d\u4e5f\u4e0d\u60f3\u6765\u4e86\uff01 \u90a3\u5c31\u6709\u5f88\u591a\u4e0d\u7406\u89e3\u7684\u5c0f\u660e\u8bf4\u4e3a\u5565\u4e0d\u60f3\u6765\u4e86\uff0c\u53ef\u4ee5\u770b\u770b\u4e0b\u9762\u8fd9\u5f20\u56fe \u770b\u628a\u8fd9\u5927\u59b9\u5b50\u6324\u7684\uff0c\u8981\u8bf4\u600e\u4e48\u624d\u80fd\u6324\u4e0a\u5730\u94c1\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u4e00\u4e0b\u4e24\u7c73\u51b2\u523a\u4e4b\u7c7b\u7684\u524d\u51b2\u52a8\u4f5c\uff0c\u5728\u5f00\u95e8\u7684\u4e00\u77ac\u95f4\u8d77\u8df3\u3002 \u5982\u679c\u4f60\u540e\u9762\u6709\u4e94\u7c73\u9ad8\u7684\u58ee\u6c49\uff0c\u90a3\u606d\u559c\u4f60\u51b2\u523a\u5c31\u4e0d\u9700\u8981\u4e86\uff0c\u8fd9\u4e2a\u808c\u8089\u731b\u7537\u53ef\u4ee5\u76f4\u63a5\u5c06\u4f60\u9001\u4f60\u5230\u8f66\u53a2\u7684\u6b63\u4e2d\u95f4\u3002\u800c\u4e14\u5929\u901a\u82d1\u79df\u623f\u5b50\u73af\u5883\u5f88\u4e0d\u53cb\u597d\uff0c\u4e00\u822c\u90fd\u662f \u7fa4\u5c45 \uff0c\u5efa\u8bae\u6709\u5173\u90e8\u95e8\u53ef\u4ee5\u597d\u597d\u67e5\u67e5\uff5e \u901a\u8fc7\u8fd9\u4e24\u70b9\u5c31\u8db3\u4ee5\u88ab\u8bc4\u4e0a\u6700\u5dee\u5e78\u798f\u6307\u6570\u7b2c\u4e00\u540d\u3002 \u4e0d\u8fc7\u503c\u5f97\u9ad8\u5174\u7684\u662f\uff0c\u4e0a\u73ed\u7684\u65f6\u95f4\u4ece\u957f\u8fbe1\u4e2a\u5c0f\u65f640\u5206\u949f\u51cf\u5c11\u52301\u4e2a\u5c0f\u65f6\u3002\uff08\u53ef\u4ee5\u591a\u7761\u534a\u5c0f\u65f6\uff09 \u5f53\u7136\u79df\u623f\u5343\u4e07\u4e0d\u8981\u5927\u610f\uff0c\u4e0d\u8981\u4fe1\u4efb\u4f55\u4e2d\u4ecb\u6ca1\u6709\u4e66\u9762\u5408\u540c\u7684\u9b3c\u8bdd\uff0c\u4eba\u751f\u7ecf\u9a8c\u554a\uff01\u4e0d\u7136\u7684\u8bdd\uff0c\u4e2d\u4ecb\u4f1a\u548c\u4f60\u7b7e\u7f72\u4e00\u7cfb\u5217\u7684\u4e0d\u5e73\u7b49\u6761\u7ea6\uff0c\u6700\u540e\u8fd8\u8981\u60f3\u5c3d\u529e\u6cd5\u6263\u4f60\u7684\u62bc\u91d1\uff0c\u4e0d\u8981\u95ee\u6211\u600e\u4e48\u77e5\u9053\u7684\uff5e \u6240\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u9075\u7eaa\u5b88\u6cd5\u7684\u597d\u516c\u6c11\uff0c\u6211\u80af\u5b9a\u4f1a\u5148\u95ee\u5019\u7684\u4ed6\u4eec\u7684\u7956\u5b97\u5341\u516b\u4ee3\u4e4b\u540e\uff0c\u518d\u6253\u4e2a\u6295\u8bc9\u7535\u8bdd\uff0c\u8ba9\u76f8\u5173\u90e8\u95e8\u5904\u7406\uff0c\u4e00\u4e2a\u4e0d\u5c0f\u5fc3\u5c31\u5168\u62c6\u4e86\u3002\u7531\u6b64\u53ef\u4ee5\u5f97\u51fa\u4e00\u4e2a\u5e7f\u544a\u8bed: \u5927\u5bb6\u597d\uff0c\u624d\u662f\u771f\u7684\u597d\u3002 \u9177\u72d7\u97f3\u4e50\u89e3\u9501 https://demo.unlock-music.dev/ https://blog.csdn.net/r1553789169/article/details/106900832","title":"\u6211\u76842021"},{"location":"20.mylife/2022-life-docs/","text":"\u6211\u76842022 \u00b6 Hello! \u5927\u5bb6\u597d\uff0c\u4eca\u5929\u662f2022\u7684\u6700\u540e\u4e00\u5929\uff0c\u4ece\u53bb\u5e74\u5f00\u59cb\u6709\u4e86\u4ee5\u6587\u7ae0\u8bb0\u5f55\u751f\u6d3b\u7684\u4e60\u60ef\uff0c\u6ce8\u610f\u8bb0\u5f55\u548c\u603b\u7ed3\u4e00\u4e0b\u4eca\u5e74\u53d1\u751f\u6709\u8da3\u7684\u4e8b\u60c5\u548c\u751f\u6d3b\uff0c\u7528\u6765\u6fc0\u52b1\u672a\u6765\uff0c\u6000\u5ff5\u66fe\u7ecf\u3002 \u5927\u81f4\u5185\u5bb9\u6709\u51e0\u4e2a\u65b9\u9762: \u00b6 \u4e8b\u60c5\u4e00: HexFuture\u516c\u53f8\u7ecf\u5386\u642c\u5bb6\uff08\u6e05\u534e--\u516d\u9053\u53e3\uff09 \u4e8b\u60c5\u4e8c: \u7b2c\u4e00\u6b21\u5728\u516c\u53f8\u91cc\u83b7\u5956 \u4e8b\u60c5\u4e09: \u4eca\u5e74\u6700\u5927\u7684\u4e00\u4ef6\u4e8b\u60c5\u5c31\u662f\u6362\u5de5\u4f5c\u4e86\uff0c\u4e4b\u524d\u662f\u5728\u5341\u516d\u8fdb\u5236\uff0c\u4eca\u5e744\u6708\u4efd\u6765\u5230openbayes\u3002 \u4e8b\u60c5\u56db: \u548c\u540c\u4e8b\u4e00\u8d77\u53bb\u4e86\u4ea6\u5e84\uff0c\u4f53\u9a8c\u4e86\u4e00\u4e0b\u65e0\u4eba\u9a7e\u9a76\u3002 \u4e8b\u60c5\u4e94: \u7ecf\u5386\u4e86\u4e8c\u6b21\u642c\u5bb6\uff0c\u4ece\u5929\u901a\u82d1\u642c\u5230\u4e86\u987a\u4e49\uff0c\u53c8\u4ece\u987a\u4e49\u642c\u5230\u4e86\u5b59\u6cb3\u3002 \u4e8b\u60c5\u516d: \u7b2c\u4e00\u6b21\u53bbucloud\u6570\u636e\u4e2d\u5fc3 \u4e8b\u60c5\u4e03: \u56fd\u5e86\u56de\u5bb6\uff0c\u56e0\u4e3a\u75ab\u60c5\u88ab\u5c01\u4e86\u4e00\u4e2a\u6708 \u4e8b\u60c5\u516b: \u8f97\u8f6c\u6765\u5317\u4eac\uff08\u6d2a\u6850--\u6dbf\u5dde--\u71d5\u90ca--\u5317\u4eac\uff09 \u4e8b\u60c5\u4e5d: \u7ef4\u62a4\u4e86\u4e00\u4e2a\u81ea\u5df1\u535a\u5ba2 \u4e8b\u60c5\u5341: \u4e70\u4e86\u7b2c\u4e00\u8f86\u7535\u52a8\u8f66 \u4e8b\u60c5\u5341\u4e00: \u4e70\u4e86\u7b2c\u4e00\u53f0\u82f9\u679c14pro \u4e8b\u60c5\u5341\u4e8c: \u6211\u4e24\u4e2a\u6708\u7684\u5c45\u5bb6\u529e\u516c\u751f\u6d3b \u4e8b\u60c5\u5341\u4e09: \u6361\u5230\u8eab\u4efd\u8bc1\u9001\u5230\u6d3e\u51fa\u6240 \u4e8b\u60c5\u5341\u56db: \u7b2c\u4e00\u6b21\u53bb\u5c0f\u5468\u540c\u5b66\u5bb6\uff0c\u88ab\u70ed\u60c5\u6b3e\u5f85 \u4e8b\u60c5\u5341\u4e94: \u7b2c\u4e00\u6b21\u62cd\u8bc1\u4ef6\u7167 \u4e8b\u60c5\u5341\u516d: \u7b2c\u4e00\u6b21\u4e70\u4eac\u4e1c\u5927\u54e5\u7684\u82f9\u679c\u8033\u673a \u4e8b\u60c5\u5341\u4e03: \u5356\u6389\u53bb\u5e74\u7684\u7535\u8111\uff0c\u6362\u4e86\u4e00\u53f0DELL\u663e\u793a\u5668 \u4e8b\u60c5\u5341\u516b: \u5728\u5317\u4eac\u6700\u540e\u4e00\u6b21\u548c\u9a6c\u5927\u592b\u805a\u9910 \u4e8b\u60c5\u5341\u4e5d: \u4e0b\u96e8\u88ab\u56f0\u5728\u4fee\u8f66\u5e97\u4e24\u6b21 \u4e8b\u60c5\u4e8c\u5341: \u5728\u5317\u4eac\u7b2c\u4e00\u6b21\u53bb\u9493\u9c7c \u4e8b\u60c5\u4e8c\u5341\u4e00: \u548c\u670b\u53cb\u4e00\u8d77\u722c\u4e86\u516b\u8fbe\u5cad\u957f\u57ce\uff0c\u7d2f\u5230\u817f\u8f6f\u3002 \u4e8b\u60c5\u4e8c\u5341\u4e8c: \u7b2c\u4e00\u6b21\u53bb\u4e09\u91cc\u5c6f \u4e8b\u60c5\u4e8c\u5341\u4e09: \u7b2c\u4e00\u6b21\u53bb\u4ec0\u5239\u6d77 \u4e8b\u60c5\u4e8c\u5341\u56db: \u7b2c\u4e00\u6b21\u53bb\u670b\u53cb\u7684\u5b66\u6821 \u4e8b\u60c5\u4e8c\u5341\u4e94: \u7b2c\u4e00\u6b21\u53bb\u6d77\u6dc0\u9a7e\u6821 \u4e8b\u60c5\u4e8c\u5341\u516d: \u8001\u677f\u9001\u7684\u53e3\u7cae \u4e8b\u60c5\u4e8c\u5341\u4e03: \u7b2c\u4e00\u6b21\u8ba4\u8bc6\u8001\u5916\u90bb\u5c45 \u4e8b\u60c5\u4e8c\u5341\u516b: \u539f\u5b9a\u7684\u8003\u8bc1\uff0c\u53ea\u8003\u4e86\u4e00\u4e2a\uff0c\u8fd8\u5dee\u4e00\u4e2a\uff0c\u7b97\u662f\u5b8c\u6210\u4e86\u4e00\u534a \u4e8b\u60c5\u4e8c\u5341\u4e5d: \u8205\u8205\u53bb\u4e16 \u7b2c\u4e00\u6b21\u624d\u771f\u6b63\u610f\u4e49\u4e0a\u7684\u5b66\u4f1a\u4e0a\u7f51\u548cGoogle \u4e0b\u9762\u5c31\u6211\u62cd\u7684\u4e00\u4e9b\u56fe\u7247\u548c\u89c6\u9891\uff0c\u6765\u56de\u5fc6\u4e00\u4e0b\u6211\u76842022\u5427 \u300a\u516c\u53f8\u7bc7\u300b \u00b6 2022\u8fd8\u7684\u4ece\u7b2c\u4e00\u672c\u65e5\u5386\u5f00\u59cb\uff01 \u6ca1\u9519\uff0c\u8fd9\u4e2a\u65e5\u5386\u5c31\u662f\u8fd8\u6ca1\u6709\u7ffb\u5c31\u8fc7\u5b8c2022\u7684\u65e5\u5386\uff0c\u8fd8\u662f\u62bd\u5956\u4e2d\u7684\uff0c\u5f53\u65f6\u8fd8\u88ab\u540c\u4e8b\u8c03\u4f83\u6211\u8fd0\u6c14\u771f\u597d\uff0c\u5e72\u5565\u90fd\u80fd\u4e2d\u5956\uff0c\u8fd9\u4e5f\u662f2022\u7b2c\u4e00\u5929\u6765\u516c\u53f8\u3002 \u8fd9\u4e2a\u5c31\u662f\u516c\u53f8\u524d\u9762\uff0c\u53ef\u80fd\u5c31\u662f\u6211\u8fd9\u4e2a\u62cd\u7167\u6280\u672f\u6709\u70b9\u95ee\u9898\u3002\u6709\u70b9\u62cd\u6b6a\u4e86\u3002 \u7ed9\u4e0a\u4e00\u5f20\u5168\u666f\u56fe(\u4e0d\u8fc7\u642c\u5bb6\u4e4b\u540e\u786e\u5b9e\u5927\u7684\u5f88\u591a) \u524d\u9762\u5c31\u662f\u4e4b\u524d\u7684\u9886\u5bfc\uff0c\u9a6c\u5927\u592b\u3002\uff08\u8ba4\u8bc6\u5927\u4f6c\u4e2d\u7684\u4e00\u4f4d\uff09 \u5f53\u7136\u90e8\u95e8\u8fd8\u6709\u8001\u5f90\uff0c\u548c\u5c0f\u5f6d\u540c\u5b66\uff0c\u4e0d\u8fc7\u6211\u8fd9\u6ca1\u6709\u8001\u5f90\u7684\u7167\u7247,\u6280\u672f\u6ca1\u4f69\u670d\u8fc7\u51e0\u4e2a\u4eba\uff0c\u8001\u5f90\u7b97\u4e00\u4e2a\uff0c\u5e74\u7eaa\u8f7b\u8f7b\u5c31\u53ef\u4ee5\u5c45\u5bb6\u529e\u516c\uff0c\u662f\u4e00\u4e2a\u597d\u699c\u6837\uff01\u4e0b\u9762\u8fd9\u4e2a\u5c31\u662f\u5c0f\u5f6d\u540c\u5b66\uff0c\u90e8\u95e8\u552f\u4e00\u4e00\u4e2a\u5973\u5b69\u3002\u4e0d\u8fc7\u6211\u4eec\u4e00\u5171\u56db\u4e2a\u4eba\u5979\u662f\u7b2c\u4e00\u4e2a\u8d70\u7684\uff0c\u7136\u540e\u662f\u6211\uff0c\u518d\u7136\u540e\u5c31\u662f\u9a6c\u5927\u592b\uff0c\u5c31\u5269\u8001\u5f90\u8fd8\u5728\u81ea\u5df1\u7684\u5c97\u4f4d\u4e0a\uff0c\u5f53\u7136\u8fd8\u8ba4\u8bc6\u4e00\u4e9b\u522b\u7684\u90e8\u95e8\u7684\u670b\u53cb\u3002\u8fd9\u91cc\u6ca1\u6709\u7167\u7247\u5c31\u4e0d\u4e00\u4e00\u4ecb\u7ecd\u4e86\u3002 \u8fd9\u5f20\u7167\u7247\uff0c\u611f\u89c9\u62cd\u7684\u5c31\u5f88\u6709\u610f\u5883\uff08\u5916\u9762\u8fd8\u6709\u5f88\u591a\u5c0f\u9e1f\uff09 \u516c\u53f8\u4e3e\u884c\u7684\u4e00\u6b21\u9881\u5956\uff0c\u6211\u4e5f\u4e0d\u592a\u7406\u89e3\u516c\u53f8\u7684\u60f3\u6cd5\uff0c\u53ef\u80fd\u662f\u60f3\u6fc0\u52b1\u5458\u5de5\uff0c\u4e8e\u662f\u6709\u4e86\u8fd9\u4e2a\u6d3b\u52a8\u3002 \u5728\u516c\u53f8\u4e0d\u505c\u6390\u7f51\u7ebf\u7684\u6211\u3002\u5f53\u65f6\u5929\u5929\u5728\u641e\u8fd9\u4e2a\u7f51\u7ebf\u6211\u90fd\u6709\u70b9\u81ea\u95ed\uff0c\u4e00\u5ea6\u9677\u5165\u81ea\u6211\u6000\u7591\u548c\u5426\u5b9a\uff0c\u4e5f\u5c31\u662f\u8fd9\u4f1a\u4ea7\u751f\u4e86\u79bb\u804c\u7684\u60f3\u6cd5\u3002\u56e0\u4e3a\u6211\u611f\u89c9\u5c97\u4f4d\u548c\u5b9e\u9645\u5de5\u4f5c\u771f\u7684\u4e0d\u592a\u5339\u914d\u3002\u5f53\u7136\u8fd9\u4e2a\u4e5f\u5c31\u662f\u5bfc\u706b\u7d22\uff0c\u540e\u6765\u4e5f\u662f\u56e0\u4e3a\u522b\u7684\u4e8b\u60c5\uff0c\u771f\u7684\u6709\u70b9\u4e0d\u60f3\u7559\u7740\u4e86\uff0c\u867d\u7136\u90e8\u95e8\u7684\u540c\u4e8b\u90fd\u4e0d\u9519...... \u867d\u7136\u6362\u4e86\u73af\u5883\uff0c\u4f46\u662f\u603b\u7684\u6765\u8bf4\uff0c\u5728\u8fd9\u91cc\u5446\u4e86\u4e00\u5e74\u7ed9\u6211\u7684\u611f\u89c9\u6bcf\u5929\u8fc7\u7684\u5306\u5306\u5fd9\u5fd9\uff0c\u5c5e\u4e8e\u75b2\u4e8e\u5954\u547d\u7684\u5317\u6f02\u4eba\u7684\u4e00\u79cd\uff0c\u540e\u6765\u89c9\u5f97\u8fd8\u662f\u8fd9\u91cc\u4e0d\u592a\u9002\u5408\u8fd8\u662f\u518d\u627e\u4e00\u4e2a\u5427\u3002\u81ea\u5df1\u7684\u8def\u81ea\u5df1\u628a\u63e1\u3002 \u6211\u8fd8\u8bb0\u5f97\u5f53\u65f6\u6211\u8fc7\u5e74\u7684\u65f6\u5019\uff0c\u8fd8\u53bb\u5927\u8205\u5bb6\u7b97\u8fc7\u4e00\u5366\uff0c\u8bf4\u4e0d\u4f1a\u79bb\u804c\uff0c\u5de5\u8d44\u5c0f\u6da8\u3002\u540e\u9762\u8bf4\u7684\u592a\u79bb\u8c31\u4e86\uff0c\u6211\u81ea\u5df1\u90fd\u4e0d\u4fe1\uff0c\u679c\u7136\u54c8\uff0c\u4e0d\u7075\uff0c\u54c8\u54c8\u54c8\u3002 \u4e0d\u8fc7\u4eca\u5e74\u6253\u7b97\u8fd8\u53bb\uff0c\u89c9\u5f97\u8fd8\u633a\u6709\u610f\u601d\u7684\uff0c\u4e0d\u8fc7\u4eca\u5e74\u53bb\u611f\u89c9\u5c31\u6709\u4e00\u79cd\u53bb\u6253\u4ed6\u4eec\u8138\u7684\u610f\u601d\uff0c\u54c8\u54c8\u54c8\u3002 \u300a\u642c\u5bb6\u7bc7\u300b \u00b6 \u7ecf\u5386\u4e86\u4e24\u6b21\u642c\u5bb6\uff0c\u4ece\u5929\u901a\u82d1\u642c\u5230\u4e86\u987a\u4e49\uff0c\u53c8\u4ece\u987a\u4e49\u642c\u5230\u4e86\u5b59\u6cb3 \u8fd9\u4e2a\u662f\u5728\u987a\u4e49\u79df\u7684\u5c0f\u5bb6\uff0c\u623f\u79df\u5176\u5b9e\u8fd8\u53ef\u4ee5\u63a5\u53d7\uff0c\u5c31\u662f\u592a\u8fdc\uff0c\u90fd\u52306\u73af\u4e86\u5427\u3002 \u7136\u540e\u5c31\u642c\u5230\u7684\u5b59\u6cb3\uff0c\u8def\u7a0b\u5c11\u4e86\u4e00\u534a\uff0c\u623f\u79df\u4e5f\u4e0d\u591a\u8fd8\u662f\u5f88\u4e0d\u9519\u7684\uff0c\u4e0d\u8fc7\u901a\u52e4\u8fd8\u662f\u9700\u89811\u5c0f\u65f6\uff0c\u5728\u5317\u4eac\u8fd9\u4e2a\u65f6\u95f4\u5176\u5b9e\u8fd8\u633a\u6b63\u5e38\u7684\u3002\u8fd9\u91cc\u8fd8\u662f\u633a\u597d\u7684\u4e00\u517190\u591a\u5e73\u7c73\uff0c\u5bbd\u655e\u660e\u4eae\u4e00\u4e9b\uff0c\u4e0d\u50cf\u4e00\u4e9b\u9694\u65ad\u623f\u3002\u8fd8\u8bb0\u5f97\u5317\u4eac\u90a3\u4e24\u4e2a\u5973\u5b69\u561b\uff0c\u56e0\u4e3a\u79df\u5730\u4e0b\u5ba4\uff0c\u6696\u6c14\u6c34\u7ba1\u574f\u6389\uff0c\u88ab\u6df9\u6b7b\uff0c\u771f\u7684\u770b\u5230\u8fd9\u4e2a\u65b0\u95fb\u771f\u7684\u597d\u751f\u6c14\u3002\u521a\u521a\u5927\u5b66\u6bd5\u4e1a\u5c31\u8fd9\u6837\u6ca1\u4e86..... \u7ffb\u4e86\u7ffb\uff0c\u786e\u5b9e\u6709\u51e0\u5f20\u5c0f\u533a\u7684\u7167\u7247 \u4ecb\u7ecd\u4e00\u4e0b\uff0c\u5728\u5317\u4eac\u7684\u79df\u623f\u60c5\u51b5\u5427\u3002 \u8fd9\u8f88\u5b50\u6709\u5e78\u53bb\u5929\u901a\u82d1\u4f4f\u4e86\u4e00\u6b21\uff0c\u53d1\u8a93\u8fd9\u8f88\u5b50\u90fd\u4e0d\u60f3\u518d\u53bb\u4e86\uff0c\u4e00\u662f\u5230\u5904\u90fd\u662f\u9694\u65ad\u623f\uff0c\u4e8c\u662f\u4eba\u662f\u771f\u591a\uff0c\u9047\u5230\u4e86\u4e0b\u96e8\u4e0b\u96ea\u516c\u4ea4\u6839\u672c\u5750\u4e0d\u4e0a\u3002\uff08\u6211\u4e2a\u4eba\u611f\u89c9\u5317\u4eac\u79df\u623f\u5e02\u573a\u771f\u7684\u633a\u4e71\u7684\uff0c\u4e0d\u77e5\u9053\u522b\u7684\u5730\u65b9\u4f1a\u4e0d\u4f1a\u597d\u4e00\u70b9\uff09 \u5bf9\u4e86\uff0c\u6211\u8fd8\u6709\u4e00\u6b21\u627e\u623f\u5b50\u7ecf\u5386\uff0c\u90a3\u4e2a\u5730\u65b9\u5e94\u8be5\u662f\u6e05\u6cb3\uff0c\u90a3\u4e2a\u6751\u5b50\u810f\u4e71\u5dee\u4e0d\u8bf4\uff0c\u611f\u89c9\u5427\uff0c\u5982\u679c\u4e0d\u77e5\u9053\u7684\u4ee5\u4e3a\u5728\u91d1\u4e09\u89d2\u5462\u3002 \u603b\u7ed3: \u5728\u5317\u4eac\u6ca1\u94b1\uff0c\u6839\u672c\u5c31\u5446\u4e0d\u4e0b\u53bb\uff0c\u8fd9\u91cc\u4e5f\u4e0d\u9002\u5408\u751f\u6d3b\uff0c\u56e0\u4e3a\u751f\u6d3b\u8282\u594f\u5f88\u591a\uff0c\u538b\u529b\u5f88\u5927\uff0c\u5927\u5bb6\u90fd\u5728\u5377\uff0c\u6bd4\u8f83\u9002\u5408\u5b66\u4e00\u4e9b\u672c\u9886\u3002\u5f53\u7136\u5982\u679c\u4f60\u771f\u7684\u6709\u80fd\u529b\uff0c\u627e\u5de5\u4f5c\u4e5f\u6bd4\u8f83\u8f7b\u677e. \u4e70\u4e86\u7b2c\u4e00\u8f86\u7535\u52a8\u8f66,\u4e70\u4e2a\u7535\u52a8\u8f66\u771f\u7684\u662f\u592a\u65b9\u4fbf\u4e86\uff0c\u5728\u5317\u4eac\u8fd9\u4e2a\u9650\u53f7\u7684\u57ce\u5e02\uff0c\u611f\u89c9\u629b\u5f00\u5730\u94c1\u4e0d\u8bf4\uff0c\u7535\u52a8\u8f66\u4e5f\u662f\u5f88\u591a\u4eba\u9996\u9009\u7684\u4ee3\u6b65\u5de5\u5177\u3002 \u548c\u540c\u4e8b\u53bb\u4e86ucloud\u7684\u6570\u636e\u4e2d\u5fc3\u4e5f\u4f53\u9a8c\u4e86\u65e0\u4eba\u9a7e\u9a76\u7684\u8f66 \u300a\u805a\u9910\u7bc7\u300b \u00b6 \u6211\u81ea\u5df1\u770b\u7740\u90fd\u8981\u6d41\u53e3\u6c34\u4e86\uff0c\u8fd9\u662f\u6700\u540e\u4e00\u6b21\u4e0a\u524d\u9886\u5bfc\u548c\u540c\u4e8b\u5403\u996d\uff0c\u4e00\u662f\u4e3a\u4e86\u611f\u8c22\u4ed6\u4eec2022\u5e74\u5bf9\u6211\u7684\u5e2e\u52a9\uff0c\u4e8c\u662f\u5e86\u795d\u81ea\u5df1\u6765\u5230\u4e86\u65b0\u516c\u53f8\u3002 \u8fd9\u662f\u7b2c\u4e00\u6b21\u53bb\u5c0f\u5468\u540c\u5b66\u5bb6\uff0c\u5c0f\u5468\u540c\u5b66\u7684\u70ed\u60c5\u6b3e\u5f85\u3002 2023\u5e74\u5143\u65e6\u5c0f\u5468\u540c\u5b66\u5403\u7684\u4e1c\u5317\u83dc \u540c\u4e8b\u8fc7\u751f\u65e5\uff0c\u75ab\u60c5\u539f\u56e0\u4e0d\u80fd\u51fa\u53bb\u5c31\u5728\u516c\u53f8\u805a\u9910 \u300a\u6253\u5361\u7bc7\u300b \u00b6 \u4e2d\u5173\u6751\u6253\u5361 \u4e0b\u73ed\u8def\u4e0a \u7ea6\u996d\u8def\u4e0a \u673a\u573a(\u4e3a\u4ec0\u4e48\u8981\u6765\u7740\u5462\uff0c\u5750\u9519\u8f66\u4e86......) \u4ec0\u5239\u6d77 4\u6708\u8fd8\u4e0d\u53bb\u770b\u4e00\u6b21\u6843\u82b1\u561b \u300a\u957f\u57ce\u7bc7\u300b \u00b6 \u5f53\u7136\u4e5f\u548c\u597d\u670b\u53cb\u53bb\u722c\u4e86\u516b\u8fbe\u5cad\u957f\u57ce,\u5982\u679c\u6ca1\u6709\u7279\u6b8a\u60c5\u51b5\uff0c\u4ee5\u540e\u53ef\u80fd\u4e0d\u4f1a\u518d\u53bb\u4e86\uff0c\u771f\u5fc3\u7d2f\uff0c\u4e0d\u8fc7\u6211\u5012\u662f\u89c9\u5f97\u4ee5\u524d\u90a3\u4e9b\u5728\u8fd9\u4e0a\u9762\u7684\u58eb\u5175\uff0c\u771f\u7684\u662f\u723d\uff0c\u8fd9\u4e0a\u9762\u98ce\u666f\u4e5f\u7b97\u4e00\u7edd\uff0c\u5854\u697c\u91cc\u9762\u51c9\u5feb\u8212\u9002\uff0c\u8fd9\u4e2a\u653e\u73b0\u5728\u5c31\u662f\u59a5\u59a5\u7684\u516c\u52a1\u5458\u5c97\u4f4d\u554a\u3002\u9664\u4e86\u5916\u5356\u53ef\u80fd\u4e0d\u597d\u9001\uff0c\u54c8\u54c8\u54c8\u3002 \u5f53\u7136\u4e86\uff0c\u5982\u679c\u54ea\u4f4d\u670b\u53cb\u8bf7\u5ba2\uff0c\u6211\u4e5f\u613f\u610f\u966a\u7740\u53bb\u3002 \u300a\u5206\u4eab\u7bc7\u300b \u00b6 \u59b9\u59b9\u753b\u7684\u6d77\u7ef5\u5b9d\u5b9d \u670b\u53cb\u7684\u5c0f\u72d7 \u5c0f\u533a \u5e74\u521d\u96ea\u666f \u9493\u9c7c\u9047\u5230\u7684\u9493\u53cb\uff08\u9493\u53cb\u7684\u670b\u53cb\u592a\u5377\u4e86\uff0c\u6211\u8dd1\u4e8610\u516c\u91cc\u6ca1\u6709\u4f4d\u7f6e......\uff09 AI\u753b\u7684,\u6240\u4ee5\u4f60\u4ee5\u540e\u4f1a\u5931\u4e1a\u5417\uff5e \u8fd9\u9505\u4e0d\u9519\uff0c\u52f0\u54e5\u4eb2\u6d4b 2022\u6625\u8282\u521a\u8fc7\u5b8c\u548c\u8868\u54e5\u4e00\u8d77\u6765\u5317\u4eac \u300a\u5b66\u4e60\u7bc7\u300b \u00b6 \u4e5f\u662f\u5728\u4eca\u5e74\u7ef4\u62a4\u4e86\u4e00\u4e2a\u81ea\u5df1\u535a\u5ba2,\u90a3\u4e48\u5c31\u662f\u4f60\u4eec\u770b\u5230\u8fd9\u4e2a\u4e86\uff0c\u8fd9\u4e2a\u4eca\u5e74\u521a\u521a\u5f00\u59cb\u7ef4\u62a4\uff0c\u4e0d\u8fc7\u4e5f\u662f\u9700\u8981\u4fdd\u6301\u521d\u5fc3\uff0c\u6bcf\u5468\u6216\u8005\u6bcf\u6708\u575a\u6301\u5199\u4e0b\u53bb\u3002\u5f53\u7136\u8fd9\u4e2a\u611f\u89c9\u8fd8\u662f\u633a\u56f0\u96be\u7684\uff0c\u9700\u8981\u5927\u5bb6\u76d1\u7763\u3002\u5f53\u7136\u8fd9\u4e2a\u4e1c\u897f\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u4ee5\u540e\u8bb2\u8bfe\u7684\u6559\u7a0b\uff0c\u59a5\u59a5\u7684\u5b89\u6392\u660e\u767d\u3002 \u4eca\u5e74\u901a\u8fc7\u4e86CKA\u7684\u8003\u8bd5\uff0c\u4e5f\u662f11\u6708\u5e95\u8fc7\u7684\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u665a\uff0c\u7f8e\u56fd\u9ed1\u8272\u661f\u671f\u4e94\u561b\uff0c\u8fd9\u4e2a\u6253\u6298\u51e0\u4e4e\u8170\u65a9\uff0c\u679c\u65ad\u5fc5\u987b\u7b49\u8fd9\u4e2a\u65f6\u5019\uff0c\u4e00\u5171\u7701\u4e863000\u5143\u3002 \u5f53\u7136\u8fd8\u901a\u8fc7\u4e86\u65b0\u516c\u53f8\u7684\u8f6c\u6b63\uff0c\u4e5f\u662f\u503c\u5f97\u9ad8\u5174\u7684\u4e00\u4ef6\u4e8b\u60c5\u3002\u9664\u4e86\u8fd9\u4e24\u4e2a\u5728\u5b66\u4e60\u7684\u652f\u51fa\u6211\u5927\u6982\u7b97\u4e86\u4e00\u4e0b\uff0c3-4\u4e07\uff0c\u4e00\u53f0\u670d\u52a1\u5668+\u663e\u793a\u5668+\u5b66\u4e60\u8bfe\u7a0b\uff08\u8fd0\u7ef4\u8bfe+python\u8bfe\u7a0b\uff09\u7b49\u7b49\uff0c\u53cd\u6b63\u5728\u5b66\u4e60\u4e0a\u6211\u662f\u771f\u7684\u80fd\u4e0b\u672c\u94b1\u3002\u6211\u4e2a\u4eba\u89c9\u5f97\u5e74\u8f7b\u5c31\u5e94\u8be5\u591a\u5c1d\u8bd5\uff0c\u4e07\u4e00\u6210\u529f\u4e86\u5462. \u52a0\u6cb9\u6162\u6162\u5b66\u5427\uff5e 2023\u8fd8\u662f\u8981\u5377\u4e00\u5377\u5c0f\u5468\u540c\u5b66 \u300a\u82f9\u679c\u5168\u5bb6\u6876\u7bc7\u300b \u00b6 2022\u7b2c\u4e00\u6b21\u4f7f\u7528Mac \u56e0\u4e3a\u6211\u4e00\u5f00\u59cb\u7528\u4e86\u51e0\u5e74\u7684windows\uff0c\u6ca1\u6709\u7528\u8fc7Mac\uff0c\u611f\u89c9\u82f9\u679c\u7535\u8111\u6709\u70b9\u7528\u7684\u4e0d\u8212\u670d\u3002 \u82f9\u679c\u8033\u673a \u82f9\u679c\u624b\u673a \u300a\u5b58\u94b1\u7bc7\u300b \u00b6 \u4eca\u5e74\u7684\u6218\u7ee9\u4e0e\u53bb\u5e74\u76f8\u6bd4\u8fd8\u662f\u6bd4\u8f83\u5ba2\u89c2\u7684\uff0c\u4e3b\u8981\u662f\u81ea\u5df1\u592a\u80fd\u4e71\u82b1\uff0c\u672a\u6765\u5e0c\u671b\u6709\u4eba\u53ef\u4ee5\u7ba1\u7ba1\u3002\u563f\u563f~ \u53bb\u5e74\u4e5f\u5c313+\uff0c\u4eca\u5e74\u5dee\u4e0d\u591a\u53ef\u4ee512+\uff0c\u660e\u5e74\u5e0c\u671b15+\uff0c\u603b\u4e0d\u80fd\u4e00\u5e74\u4e0d\u5982\u4e00\u5e74\u5427\u3002 \u5b66\u4e60\u8d39\u7528: \u53ef\u4ee5\u6295\u51652-3w \u623f\u79df\u8d39\u7528: 3w\u4ee5\u5185 \u4e2a\u4eba\u5f00\u652f: 4w\u4ee5\u5185\uff08\u6700\u597d\u662f\u4ee5\u540e\u53ef\u4ee5\u81ea\u5df1\u505a\u996d\u6765\u51cf\u5c11\u4e00\u90e8\u5206\uff09 \u5176\u4ed6\u8d39\u7528: \u53ef\u4ee5\u63a7\u5236\u57282w \u300a\u7545\u4eab\u7bc7\u300b \u00b6 \u672a\u6765\u60f3\u505a\u7684\u4e8b\u60c5: \u53bb\u4e0a\u6d77\u65c5\u6e38\u4e00\u6b21 \u53bb\u5e03\u8fbe\u62c9\u5bab\u65c5\u6e38\u4e00\u6b21 \u5982\u679c\u53ef\u4ee5\u8bdd\u5e0c\u671b\u80fd\u548c\u559c\u6b22\u7684\u4eba\u770b\u6d77 \u5982\u679c\u672a\u6765\u6709\u673a\u4f1a\u5e0c\u671b\u53ef\u4ee5\u53bb\u770b\u5468\u6770\u4f26\u7684\u6f14\u5531\u4f1a \u539f\u5b9a2021\u6ca1\u6709\u5b8c\u6210\u7684\u4e8b\u60c5\uff0c\u57282022\u5e74\u4e5f\u6ca1\u6709\u5b8c\u6210\uff0c\u5e0c\u671b2023\u5e74\u5b8c\u6210\u3002 2023\u5c31\u5f00\u59cb\u5c1d\u8bd5\u8bb2\u5e08\uff0c\u505a\u81ea\u7531\u804c\u4e1a\u4e86 \u4eca\u5e74\u8fd8\u662f\u6bd4\u8f83\u503c\u5f97\u5e86\u795d\u7684\u4e00\u5e74\uff0c\u9996\u5148\u4eca\u5e74\u75ab\u60c5\u7ec8\u4e8e\u653e\u5f00\u4e86\uff0c\u5c01\u4e86\u4e09\u5e74\u5feb\u628a\u5927\u5bb6\u90fd\u5173\u50bb\u4e86\uff0c\u73b0\u5728\u653e\u5f00\u4e4b\u540e\u867d\u7136\u5927\u90e8\u5206\u7684\u4eba\u90fd\u7f8a\u4e86\uff0c\u597d\u5728\u60c5\u51b5\u4e0d\u662f\u5f88\u7cdf\u7cd5\u3002\u672a\u6765\u5e0c\u671b\u80fd\u591f\u8d8a\u6765\u8d8a\u597d\u3002 \u62112022\u7684\u6545\u4e8b\u5230\u8fd9\u91cc\u5c31\u7ed3\u675f\u4e86\uff0c2023\u5e0c\u671b\u80fd\u8c08\u4e00\u6bb5\u6709\u7ed3\u679c\u7684\u611f\u60c5\u3002\u80fd\u505a\u81ea\u5df1\u70ed\u7231\u7684\u4e8b\u60c5\uff0c\u79ef\u6781\uff0c\u52aa\u529b\u5411\u4e0a~","title":"\u6211\u76842022"},{"location":"20.mylife/2022-life-docs/#2022","text":"Hello! \u5927\u5bb6\u597d\uff0c\u4eca\u5929\u662f2022\u7684\u6700\u540e\u4e00\u5929\uff0c\u4ece\u53bb\u5e74\u5f00\u59cb\u6709\u4e86\u4ee5\u6587\u7ae0\u8bb0\u5f55\u751f\u6d3b\u7684\u4e60\u60ef\uff0c\u6ce8\u610f\u8bb0\u5f55\u548c\u603b\u7ed3\u4e00\u4e0b\u4eca\u5e74\u53d1\u751f\u6709\u8da3\u7684\u4e8b\u60c5\u548c\u751f\u6d3b\uff0c\u7528\u6765\u6fc0\u52b1\u672a\u6765\uff0c\u6000\u5ff5\u66fe\u7ecf\u3002","title":"\u6211\u76842022"},{"location":"20.mylife/2022-life-docs/#_1","text":"\u4e8b\u60c5\u4e00: HexFuture\u516c\u53f8\u7ecf\u5386\u642c\u5bb6\uff08\u6e05\u534e--\u516d\u9053\u53e3\uff09 \u4e8b\u60c5\u4e8c: \u7b2c\u4e00\u6b21\u5728\u516c\u53f8\u91cc\u83b7\u5956 \u4e8b\u60c5\u4e09: \u4eca\u5e74\u6700\u5927\u7684\u4e00\u4ef6\u4e8b\u60c5\u5c31\u662f\u6362\u5de5\u4f5c\u4e86\uff0c\u4e4b\u524d\u662f\u5728\u5341\u516d\u8fdb\u5236\uff0c\u4eca\u5e744\u6708\u4efd\u6765\u5230openbayes\u3002 \u4e8b\u60c5\u56db: \u548c\u540c\u4e8b\u4e00\u8d77\u53bb\u4e86\u4ea6\u5e84\uff0c\u4f53\u9a8c\u4e86\u4e00\u4e0b\u65e0\u4eba\u9a7e\u9a76\u3002 \u4e8b\u60c5\u4e94: \u7ecf\u5386\u4e86\u4e8c\u6b21\u642c\u5bb6\uff0c\u4ece\u5929\u901a\u82d1\u642c\u5230\u4e86\u987a\u4e49\uff0c\u53c8\u4ece\u987a\u4e49\u642c\u5230\u4e86\u5b59\u6cb3\u3002 \u4e8b\u60c5\u516d: \u7b2c\u4e00\u6b21\u53bbucloud\u6570\u636e\u4e2d\u5fc3 \u4e8b\u60c5\u4e03: \u56fd\u5e86\u56de\u5bb6\uff0c\u56e0\u4e3a\u75ab\u60c5\u88ab\u5c01\u4e86\u4e00\u4e2a\u6708 \u4e8b\u60c5\u516b: \u8f97\u8f6c\u6765\u5317\u4eac\uff08\u6d2a\u6850--\u6dbf\u5dde--\u71d5\u90ca--\u5317\u4eac\uff09 \u4e8b\u60c5\u4e5d: \u7ef4\u62a4\u4e86\u4e00\u4e2a\u81ea\u5df1\u535a\u5ba2 \u4e8b\u60c5\u5341: \u4e70\u4e86\u7b2c\u4e00\u8f86\u7535\u52a8\u8f66 \u4e8b\u60c5\u5341\u4e00: \u4e70\u4e86\u7b2c\u4e00\u53f0\u82f9\u679c14pro \u4e8b\u60c5\u5341\u4e8c: \u6211\u4e24\u4e2a\u6708\u7684\u5c45\u5bb6\u529e\u516c\u751f\u6d3b \u4e8b\u60c5\u5341\u4e09: \u6361\u5230\u8eab\u4efd\u8bc1\u9001\u5230\u6d3e\u51fa\u6240 \u4e8b\u60c5\u5341\u56db: \u7b2c\u4e00\u6b21\u53bb\u5c0f\u5468\u540c\u5b66\u5bb6\uff0c\u88ab\u70ed\u60c5\u6b3e\u5f85 \u4e8b\u60c5\u5341\u4e94: \u7b2c\u4e00\u6b21\u62cd\u8bc1\u4ef6\u7167 \u4e8b\u60c5\u5341\u516d: \u7b2c\u4e00\u6b21\u4e70\u4eac\u4e1c\u5927\u54e5\u7684\u82f9\u679c\u8033\u673a \u4e8b\u60c5\u5341\u4e03: \u5356\u6389\u53bb\u5e74\u7684\u7535\u8111\uff0c\u6362\u4e86\u4e00\u53f0DELL\u663e\u793a\u5668 \u4e8b\u60c5\u5341\u516b: \u5728\u5317\u4eac\u6700\u540e\u4e00\u6b21\u548c\u9a6c\u5927\u592b\u805a\u9910 \u4e8b\u60c5\u5341\u4e5d: \u4e0b\u96e8\u88ab\u56f0\u5728\u4fee\u8f66\u5e97\u4e24\u6b21 \u4e8b\u60c5\u4e8c\u5341: \u5728\u5317\u4eac\u7b2c\u4e00\u6b21\u53bb\u9493\u9c7c \u4e8b\u60c5\u4e8c\u5341\u4e00: \u548c\u670b\u53cb\u4e00\u8d77\u722c\u4e86\u516b\u8fbe\u5cad\u957f\u57ce\uff0c\u7d2f\u5230\u817f\u8f6f\u3002 \u4e8b\u60c5\u4e8c\u5341\u4e8c: \u7b2c\u4e00\u6b21\u53bb\u4e09\u91cc\u5c6f \u4e8b\u60c5\u4e8c\u5341\u4e09: \u7b2c\u4e00\u6b21\u53bb\u4ec0\u5239\u6d77 \u4e8b\u60c5\u4e8c\u5341\u56db: \u7b2c\u4e00\u6b21\u53bb\u670b\u53cb\u7684\u5b66\u6821 \u4e8b\u60c5\u4e8c\u5341\u4e94: \u7b2c\u4e00\u6b21\u53bb\u6d77\u6dc0\u9a7e\u6821 \u4e8b\u60c5\u4e8c\u5341\u516d: \u8001\u677f\u9001\u7684\u53e3\u7cae \u4e8b\u60c5\u4e8c\u5341\u4e03: \u7b2c\u4e00\u6b21\u8ba4\u8bc6\u8001\u5916\u90bb\u5c45 \u4e8b\u60c5\u4e8c\u5341\u516b: \u539f\u5b9a\u7684\u8003\u8bc1\uff0c\u53ea\u8003\u4e86\u4e00\u4e2a\uff0c\u8fd8\u5dee\u4e00\u4e2a\uff0c\u7b97\u662f\u5b8c\u6210\u4e86\u4e00\u534a \u4e8b\u60c5\u4e8c\u5341\u4e5d: \u8205\u8205\u53bb\u4e16 \u7b2c\u4e00\u6b21\u624d\u771f\u6b63\u610f\u4e49\u4e0a\u7684\u5b66\u4f1a\u4e0a\u7f51\u548cGoogle \u4e0b\u9762\u5c31\u6211\u62cd\u7684\u4e00\u4e9b\u56fe\u7247\u548c\u89c6\u9891\uff0c\u6765\u56de\u5fc6\u4e00\u4e0b\u6211\u76842022\u5427","title":"\u5927\u81f4\u5185\u5bb9\u6709\u51e0\u4e2a\u65b9\u9762:"},{"location":"20.mylife/2022-life-docs/#_2","text":"2022\u8fd8\u7684\u4ece\u7b2c\u4e00\u672c\u65e5\u5386\u5f00\u59cb\uff01 \u6ca1\u9519\uff0c\u8fd9\u4e2a\u65e5\u5386\u5c31\u662f\u8fd8\u6ca1\u6709\u7ffb\u5c31\u8fc7\u5b8c2022\u7684\u65e5\u5386\uff0c\u8fd8\u662f\u62bd\u5956\u4e2d\u7684\uff0c\u5f53\u65f6\u8fd8\u88ab\u540c\u4e8b\u8c03\u4f83\u6211\u8fd0\u6c14\u771f\u597d\uff0c\u5e72\u5565\u90fd\u80fd\u4e2d\u5956\uff0c\u8fd9\u4e5f\u662f2022\u7b2c\u4e00\u5929\u6765\u516c\u53f8\u3002 \u8fd9\u4e2a\u5c31\u662f\u516c\u53f8\u524d\u9762\uff0c\u53ef\u80fd\u5c31\u662f\u6211\u8fd9\u4e2a\u62cd\u7167\u6280\u672f\u6709\u70b9\u95ee\u9898\u3002\u6709\u70b9\u62cd\u6b6a\u4e86\u3002 \u7ed9\u4e0a\u4e00\u5f20\u5168\u666f\u56fe(\u4e0d\u8fc7\u642c\u5bb6\u4e4b\u540e\u786e\u5b9e\u5927\u7684\u5f88\u591a) \u524d\u9762\u5c31\u662f\u4e4b\u524d\u7684\u9886\u5bfc\uff0c\u9a6c\u5927\u592b\u3002\uff08\u8ba4\u8bc6\u5927\u4f6c\u4e2d\u7684\u4e00\u4f4d\uff09 \u5f53\u7136\u90e8\u95e8\u8fd8\u6709\u8001\u5f90\uff0c\u548c\u5c0f\u5f6d\u540c\u5b66\uff0c\u4e0d\u8fc7\u6211\u8fd9\u6ca1\u6709\u8001\u5f90\u7684\u7167\u7247,\u6280\u672f\u6ca1\u4f69\u670d\u8fc7\u51e0\u4e2a\u4eba\uff0c\u8001\u5f90\u7b97\u4e00\u4e2a\uff0c\u5e74\u7eaa\u8f7b\u8f7b\u5c31\u53ef\u4ee5\u5c45\u5bb6\u529e\u516c\uff0c\u662f\u4e00\u4e2a\u597d\u699c\u6837\uff01\u4e0b\u9762\u8fd9\u4e2a\u5c31\u662f\u5c0f\u5f6d\u540c\u5b66\uff0c\u90e8\u95e8\u552f\u4e00\u4e00\u4e2a\u5973\u5b69\u3002\u4e0d\u8fc7\u6211\u4eec\u4e00\u5171\u56db\u4e2a\u4eba\u5979\u662f\u7b2c\u4e00\u4e2a\u8d70\u7684\uff0c\u7136\u540e\u662f\u6211\uff0c\u518d\u7136\u540e\u5c31\u662f\u9a6c\u5927\u592b\uff0c\u5c31\u5269\u8001\u5f90\u8fd8\u5728\u81ea\u5df1\u7684\u5c97\u4f4d\u4e0a\uff0c\u5f53\u7136\u8fd8\u8ba4\u8bc6\u4e00\u4e9b\u522b\u7684\u90e8\u95e8\u7684\u670b\u53cb\u3002\u8fd9\u91cc\u6ca1\u6709\u7167\u7247\u5c31\u4e0d\u4e00\u4e00\u4ecb\u7ecd\u4e86\u3002 \u8fd9\u5f20\u7167\u7247\uff0c\u611f\u89c9\u62cd\u7684\u5c31\u5f88\u6709\u610f\u5883\uff08\u5916\u9762\u8fd8\u6709\u5f88\u591a\u5c0f\u9e1f\uff09 \u516c\u53f8\u4e3e\u884c\u7684\u4e00\u6b21\u9881\u5956\uff0c\u6211\u4e5f\u4e0d\u592a\u7406\u89e3\u516c\u53f8\u7684\u60f3\u6cd5\uff0c\u53ef\u80fd\u662f\u60f3\u6fc0\u52b1\u5458\u5de5\uff0c\u4e8e\u662f\u6709\u4e86\u8fd9\u4e2a\u6d3b\u52a8\u3002 \u5728\u516c\u53f8\u4e0d\u505c\u6390\u7f51\u7ebf\u7684\u6211\u3002\u5f53\u65f6\u5929\u5929\u5728\u641e\u8fd9\u4e2a\u7f51\u7ebf\u6211\u90fd\u6709\u70b9\u81ea\u95ed\uff0c\u4e00\u5ea6\u9677\u5165\u81ea\u6211\u6000\u7591\u548c\u5426\u5b9a\uff0c\u4e5f\u5c31\u662f\u8fd9\u4f1a\u4ea7\u751f\u4e86\u79bb\u804c\u7684\u60f3\u6cd5\u3002\u56e0\u4e3a\u6211\u611f\u89c9\u5c97\u4f4d\u548c\u5b9e\u9645\u5de5\u4f5c\u771f\u7684\u4e0d\u592a\u5339\u914d\u3002\u5f53\u7136\u8fd9\u4e2a\u4e5f\u5c31\u662f\u5bfc\u706b\u7d22\uff0c\u540e\u6765\u4e5f\u662f\u56e0\u4e3a\u522b\u7684\u4e8b\u60c5\uff0c\u771f\u7684\u6709\u70b9\u4e0d\u60f3\u7559\u7740\u4e86\uff0c\u867d\u7136\u90e8\u95e8\u7684\u540c\u4e8b\u90fd\u4e0d\u9519...... \u867d\u7136\u6362\u4e86\u73af\u5883\uff0c\u4f46\u662f\u603b\u7684\u6765\u8bf4\uff0c\u5728\u8fd9\u91cc\u5446\u4e86\u4e00\u5e74\u7ed9\u6211\u7684\u611f\u89c9\u6bcf\u5929\u8fc7\u7684\u5306\u5306\u5fd9\u5fd9\uff0c\u5c5e\u4e8e\u75b2\u4e8e\u5954\u547d\u7684\u5317\u6f02\u4eba\u7684\u4e00\u79cd\uff0c\u540e\u6765\u89c9\u5f97\u8fd8\u662f\u8fd9\u91cc\u4e0d\u592a\u9002\u5408\u8fd8\u662f\u518d\u627e\u4e00\u4e2a\u5427\u3002\u81ea\u5df1\u7684\u8def\u81ea\u5df1\u628a\u63e1\u3002 \u6211\u8fd8\u8bb0\u5f97\u5f53\u65f6\u6211\u8fc7\u5e74\u7684\u65f6\u5019\uff0c\u8fd8\u53bb\u5927\u8205\u5bb6\u7b97\u8fc7\u4e00\u5366\uff0c\u8bf4\u4e0d\u4f1a\u79bb\u804c\uff0c\u5de5\u8d44\u5c0f\u6da8\u3002\u540e\u9762\u8bf4\u7684\u592a\u79bb\u8c31\u4e86\uff0c\u6211\u81ea\u5df1\u90fd\u4e0d\u4fe1\uff0c\u679c\u7136\u54c8\uff0c\u4e0d\u7075\uff0c\u54c8\u54c8\u54c8\u3002 \u4e0d\u8fc7\u4eca\u5e74\u6253\u7b97\u8fd8\u53bb\uff0c\u89c9\u5f97\u8fd8\u633a\u6709\u610f\u601d\u7684\uff0c\u4e0d\u8fc7\u4eca\u5e74\u53bb\u611f\u89c9\u5c31\u6709\u4e00\u79cd\u53bb\u6253\u4ed6\u4eec\u8138\u7684\u610f\u601d\uff0c\u54c8\u54c8\u54c8\u3002","title":"\u300a\u516c\u53f8\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_3","text":"\u7ecf\u5386\u4e86\u4e24\u6b21\u642c\u5bb6\uff0c\u4ece\u5929\u901a\u82d1\u642c\u5230\u4e86\u987a\u4e49\uff0c\u53c8\u4ece\u987a\u4e49\u642c\u5230\u4e86\u5b59\u6cb3 \u8fd9\u4e2a\u662f\u5728\u987a\u4e49\u79df\u7684\u5c0f\u5bb6\uff0c\u623f\u79df\u5176\u5b9e\u8fd8\u53ef\u4ee5\u63a5\u53d7\uff0c\u5c31\u662f\u592a\u8fdc\uff0c\u90fd\u52306\u73af\u4e86\u5427\u3002 \u7136\u540e\u5c31\u642c\u5230\u7684\u5b59\u6cb3\uff0c\u8def\u7a0b\u5c11\u4e86\u4e00\u534a\uff0c\u623f\u79df\u4e5f\u4e0d\u591a\u8fd8\u662f\u5f88\u4e0d\u9519\u7684\uff0c\u4e0d\u8fc7\u901a\u52e4\u8fd8\u662f\u9700\u89811\u5c0f\u65f6\uff0c\u5728\u5317\u4eac\u8fd9\u4e2a\u65f6\u95f4\u5176\u5b9e\u8fd8\u633a\u6b63\u5e38\u7684\u3002\u8fd9\u91cc\u8fd8\u662f\u633a\u597d\u7684\u4e00\u517190\u591a\u5e73\u7c73\uff0c\u5bbd\u655e\u660e\u4eae\u4e00\u4e9b\uff0c\u4e0d\u50cf\u4e00\u4e9b\u9694\u65ad\u623f\u3002\u8fd8\u8bb0\u5f97\u5317\u4eac\u90a3\u4e24\u4e2a\u5973\u5b69\u561b\uff0c\u56e0\u4e3a\u79df\u5730\u4e0b\u5ba4\uff0c\u6696\u6c14\u6c34\u7ba1\u574f\u6389\uff0c\u88ab\u6df9\u6b7b\uff0c\u771f\u7684\u770b\u5230\u8fd9\u4e2a\u65b0\u95fb\u771f\u7684\u597d\u751f\u6c14\u3002\u521a\u521a\u5927\u5b66\u6bd5\u4e1a\u5c31\u8fd9\u6837\u6ca1\u4e86..... \u7ffb\u4e86\u7ffb\uff0c\u786e\u5b9e\u6709\u51e0\u5f20\u5c0f\u533a\u7684\u7167\u7247 \u4ecb\u7ecd\u4e00\u4e0b\uff0c\u5728\u5317\u4eac\u7684\u79df\u623f\u60c5\u51b5\u5427\u3002 \u8fd9\u8f88\u5b50\u6709\u5e78\u53bb\u5929\u901a\u82d1\u4f4f\u4e86\u4e00\u6b21\uff0c\u53d1\u8a93\u8fd9\u8f88\u5b50\u90fd\u4e0d\u60f3\u518d\u53bb\u4e86\uff0c\u4e00\u662f\u5230\u5904\u90fd\u662f\u9694\u65ad\u623f\uff0c\u4e8c\u662f\u4eba\u662f\u771f\u591a\uff0c\u9047\u5230\u4e86\u4e0b\u96e8\u4e0b\u96ea\u516c\u4ea4\u6839\u672c\u5750\u4e0d\u4e0a\u3002\uff08\u6211\u4e2a\u4eba\u611f\u89c9\u5317\u4eac\u79df\u623f\u5e02\u573a\u771f\u7684\u633a\u4e71\u7684\uff0c\u4e0d\u77e5\u9053\u522b\u7684\u5730\u65b9\u4f1a\u4e0d\u4f1a\u597d\u4e00\u70b9\uff09 \u5bf9\u4e86\uff0c\u6211\u8fd8\u6709\u4e00\u6b21\u627e\u623f\u5b50\u7ecf\u5386\uff0c\u90a3\u4e2a\u5730\u65b9\u5e94\u8be5\u662f\u6e05\u6cb3\uff0c\u90a3\u4e2a\u6751\u5b50\u810f\u4e71\u5dee\u4e0d\u8bf4\uff0c\u611f\u89c9\u5427\uff0c\u5982\u679c\u4e0d\u77e5\u9053\u7684\u4ee5\u4e3a\u5728\u91d1\u4e09\u89d2\u5462\u3002 \u603b\u7ed3: \u5728\u5317\u4eac\u6ca1\u94b1\uff0c\u6839\u672c\u5c31\u5446\u4e0d\u4e0b\u53bb\uff0c\u8fd9\u91cc\u4e5f\u4e0d\u9002\u5408\u751f\u6d3b\uff0c\u56e0\u4e3a\u751f\u6d3b\u8282\u594f\u5f88\u591a\uff0c\u538b\u529b\u5f88\u5927\uff0c\u5927\u5bb6\u90fd\u5728\u5377\uff0c\u6bd4\u8f83\u9002\u5408\u5b66\u4e00\u4e9b\u672c\u9886\u3002\u5f53\u7136\u5982\u679c\u4f60\u771f\u7684\u6709\u80fd\u529b\uff0c\u627e\u5de5\u4f5c\u4e5f\u6bd4\u8f83\u8f7b\u677e. \u4e70\u4e86\u7b2c\u4e00\u8f86\u7535\u52a8\u8f66,\u4e70\u4e2a\u7535\u52a8\u8f66\u771f\u7684\u662f\u592a\u65b9\u4fbf\u4e86\uff0c\u5728\u5317\u4eac\u8fd9\u4e2a\u9650\u53f7\u7684\u57ce\u5e02\uff0c\u611f\u89c9\u629b\u5f00\u5730\u94c1\u4e0d\u8bf4\uff0c\u7535\u52a8\u8f66\u4e5f\u662f\u5f88\u591a\u4eba\u9996\u9009\u7684\u4ee3\u6b65\u5de5\u5177\u3002 \u548c\u540c\u4e8b\u53bb\u4e86ucloud\u7684\u6570\u636e\u4e2d\u5fc3\u4e5f\u4f53\u9a8c\u4e86\u65e0\u4eba\u9a7e\u9a76\u7684\u8f66","title":"\u300a\u642c\u5bb6\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_4","text":"\u6211\u81ea\u5df1\u770b\u7740\u90fd\u8981\u6d41\u53e3\u6c34\u4e86\uff0c\u8fd9\u662f\u6700\u540e\u4e00\u6b21\u4e0a\u524d\u9886\u5bfc\u548c\u540c\u4e8b\u5403\u996d\uff0c\u4e00\u662f\u4e3a\u4e86\u611f\u8c22\u4ed6\u4eec2022\u5e74\u5bf9\u6211\u7684\u5e2e\u52a9\uff0c\u4e8c\u662f\u5e86\u795d\u81ea\u5df1\u6765\u5230\u4e86\u65b0\u516c\u53f8\u3002 \u8fd9\u662f\u7b2c\u4e00\u6b21\u53bb\u5c0f\u5468\u540c\u5b66\u5bb6\uff0c\u5c0f\u5468\u540c\u5b66\u7684\u70ed\u60c5\u6b3e\u5f85\u3002 2023\u5e74\u5143\u65e6\u5c0f\u5468\u540c\u5b66\u5403\u7684\u4e1c\u5317\u83dc \u540c\u4e8b\u8fc7\u751f\u65e5\uff0c\u75ab\u60c5\u539f\u56e0\u4e0d\u80fd\u51fa\u53bb\u5c31\u5728\u516c\u53f8\u805a\u9910","title":"\u300a\u805a\u9910\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_5","text":"\u4e2d\u5173\u6751\u6253\u5361 \u4e0b\u73ed\u8def\u4e0a \u7ea6\u996d\u8def\u4e0a \u673a\u573a(\u4e3a\u4ec0\u4e48\u8981\u6765\u7740\u5462\uff0c\u5750\u9519\u8f66\u4e86......) \u4ec0\u5239\u6d77 4\u6708\u8fd8\u4e0d\u53bb\u770b\u4e00\u6b21\u6843\u82b1\u561b","title":"\u300a\u6253\u5361\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_6","text":"\u5f53\u7136\u4e5f\u548c\u597d\u670b\u53cb\u53bb\u722c\u4e86\u516b\u8fbe\u5cad\u957f\u57ce,\u5982\u679c\u6ca1\u6709\u7279\u6b8a\u60c5\u51b5\uff0c\u4ee5\u540e\u53ef\u80fd\u4e0d\u4f1a\u518d\u53bb\u4e86\uff0c\u771f\u5fc3\u7d2f\uff0c\u4e0d\u8fc7\u6211\u5012\u662f\u89c9\u5f97\u4ee5\u524d\u90a3\u4e9b\u5728\u8fd9\u4e0a\u9762\u7684\u58eb\u5175\uff0c\u771f\u7684\u662f\u723d\uff0c\u8fd9\u4e0a\u9762\u98ce\u666f\u4e5f\u7b97\u4e00\u7edd\uff0c\u5854\u697c\u91cc\u9762\u51c9\u5feb\u8212\u9002\uff0c\u8fd9\u4e2a\u653e\u73b0\u5728\u5c31\u662f\u59a5\u59a5\u7684\u516c\u52a1\u5458\u5c97\u4f4d\u554a\u3002\u9664\u4e86\u5916\u5356\u53ef\u80fd\u4e0d\u597d\u9001\uff0c\u54c8\u54c8\u54c8\u3002 \u5f53\u7136\u4e86\uff0c\u5982\u679c\u54ea\u4f4d\u670b\u53cb\u8bf7\u5ba2\uff0c\u6211\u4e5f\u613f\u610f\u966a\u7740\u53bb\u3002","title":"\u300a\u957f\u57ce\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_7","text":"\u59b9\u59b9\u753b\u7684\u6d77\u7ef5\u5b9d\u5b9d \u670b\u53cb\u7684\u5c0f\u72d7 \u5c0f\u533a \u5e74\u521d\u96ea\u666f \u9493\u9c7c\u9047\u5230\u7684\u9493\u53cb\uff08\u9493\u53cb\u7684\u670b\u53cb\u592a\u5377\u4e86\uff0c\u6211\u8dd1\u4e8610\u516c\u91cc\u6ca1\u6709\u4f4d\u7f6e......\uff09 AI\u753b\u7684,\u6240\u4ee5\u4f60\u4ee5\u540e\u4f1a\u5931\u4e1a\u5417\uff5e \u8fd9\u9505\u4e0d\u9519\uff0c\u52f0\u54e5\u4eb2\u6d4b 2022\u6625\u8282\u521a\u8fc7\u5b8c\u548c\u8868\u54e5\u4e00\u8d77\u6765\u5317\u4eac","title":"\u300a\u5206\u4eab\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_8","text":"\u4e5f\u662f\u5728\u4eca\u5e74\u7ef4\u62a4\u4e86\u4e00\u4e2a\u81ea\u5df1\u535a\u5ba2,\u90a3\u4e48\u5c31\u662f\u4f60\u4eec\u770b\u5230\u8fd9\u4e2a\u4e86\uff0c\u8fd9\u4e2a\u4eca\u5e74\u521a\u521a\u5f00\u59cb\u7ef4\u62a4\uff0c\u4e0d\u8fc7\u4e5f\u662f\u9700\u8981\u4fdd\u6301\u521d\u5fc3\uff0c\u6bcf\u5468\u6216\u8005\u6bcf\u6708\u575a\u6301\u5199\u4e0b\u53bb\u3002\u5f53\u7136\u8fd9\u4e2a\u611f\u89c9\u8fd8\u662f\u633a\u56f0\u96be\u7684\uff0c\u9700\u8981\u5927\u5bb6\u76d1\u7763\u3002\u5f53\u7136\u8fd9\u4e2a\u4e1c\u897f\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u4ee5\u540e\u8bb2\u8bfe\u7684\u6559\u7a0b\uff0c\u59a5\u59a5\u7684\u5b89\u6392\u660e\u767d\u3002 \u4eca\u5e74\u901a\u8fc7\u4e86CKA\u7684\u8003\u8bd5\uff0c\u4e5f\u662f11\u6708\u5e95\u8fc7\u7684\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u665a\uff0c\u7f8e\u56fd\u9ed1\u8272\u661f\u671f\u4e94\u561b\uff0c\u8fd9\u4e2a\u6253\u6298\u51e0\u4e4e\u8170\u65a9\uff0c\u679c\u65ad\u5fc5\u987b\u7b49\u8fd9\u4e2a\u65f6\u5019\uff0c\u4e00\u5171\u7701\u4e863000\u5143\u3002 \u5f53\u7136\u8fd8\u901a\u8fc7\u4e86\u65b0\u516c\u53f8\u7684\u8f6c\u6b63\uff0c\u4e5f\u662f\u503c\u5f97\u9ad8\u5174\u7684\u4e00\u4ef6\u4e8b\u60c5\u3002\u9664\u4e86\u8fd9\u4e24\u4e2a\u5728\u5b66\u4e60\u7684\u652f\u51fa\u6211\u5927\u6982\u7b97\u4e86\u4e00\u4e0b\uff0c3-4\u4e07\uff0c\u4e00\u53f0\u670d\u52a1\u5668+\u663e\u793a\u5668+\u5b66\u4e60\u8bfe\u7a0b\uff08\u8fd0\u7ef4\u8bfe+python\u8bfe\u7a0b\uff09\u7b49\u7b49\uff0c\u53cd\u6b63\u5728\u5b66\u4e60\u4e0a\u6211\u662f\u771f\u7684\u80fd\u4e0b\u672c\u94b1\u3002\u6211\u4e2a\u4eba\u89c9\u5f97\u5e74\u8f7b\u5c31\u5e94\u8be5\u591a\u5c1d\u8bd5\uff0c\u4e07\u4e00\u6210\u529f\u4e86\u5462. \u52a0\u6cb9\u6162\u6162\u5b66\u5427\uff5e 2023\u8fd8\u662f\u8981\u5377\u4e00\u5377\u5c0f\u5468\u540c\u5b66","title":"\u300a\u5b66\u4e60\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_9","text":"2022\u7b2c\u4e00\u6b21\u4f7f\u7528Mac \u56e0\u4e3a\u6211\u4e00\u5f00\u59cb\u7528\u4e86\u51e0\u5e74\u7684windows\uff0c\u6ca1\u6709\u7528\u8fc7Mac\uff0c\u611f\u89c9\u82f9\u679c\u7535\u8111\u6709\u70b9\u7528\u7684\u4e0d\u8212\u670d\u3002 \u82f9\u679c\u8033\u673a \u82f9\u679c\u624b\u673a","title":"\u300a\u82f9\u679c\u5168\u5bb6\u6876\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_10","text":"\u4eca\u5e74\u7684\u6218\u7ee9\u4e0e\u53bb\u5e74\u76f8\u6bd4\u8fd8\u662f\u6bd4\u8f83\u5ba2\u89c2\u7684\uff0c\u4e3b\u8981\u662f\u81ea\u5df1\u592a\u80fd\u4e71\u82b1\uff0c\u672a\u6765\u5e0c\u671b\u6709\u4eba\u53ef\u4ee5\u7ba1\u7ba1\u3002\u563f\u563f~ \u53bb\u5e74\u4e5f\u5c313+\uff0c\u4eca\u5e74\u5dee\u4e0d\u591a\u53ef\u4ee512+\uff0c\u660e\u5e74\u5e0c\u671b15+\uff0c\u603b\u4e0d\u80fd\u4e00\u5e74\u4e0d\u5982\u4e00\u5e74\u5427\u3002 \u5b66\u4e60\u8d39\u7528: \u53ef\u4ee5\u6295\u51652-3w \u623f\u79df\u8d39\u7528: 3w\u4ee5\u5185 \u4e2a\u4eba\u5f00\u652f: 4w\u4ee5\u5185\uff08\u6700\u597d\u662f\u4ee5\u540e\u53ef\u4ee5\u81ea\u5df1\u505a\u996d\u6765\u51cf\u5c11\u4e00\u90e8\u5206\uff09 \u5176\u4ed6\u8d39\u7528: \u53ef\u4ee5\u63a7\u5236\u57282w","title":"\u300a\u5b58\u94b1\u7bc7\u300b"},{"location":"20.mylife/2022-life-docs/#_11","text":"\u672a\u6765\u60f3\u505a\u7684\u4e8b\u60c5: \u53bb\u4e0a\u6d77\u65c5\u6e38\u4e00\u6b21 \u53bb\u5e03\u8fbe\u62c9\u5bab\u65c5\u6e38\u4e00\u6b21 \u5982\u679c\u53ef\u4ee5\u8bdd\u5e0c\u671b\u80fd\u548c\u559c\u6b22\u7684\u4eba\u770b\u6d77 \u5982\u679c\u672a\u6765\u6709\u673a\u4f1a\u5e0c\u671b\u53ef\u4ee5\u53bb\u770b\u5468\u6770\u4f26\u7684\u6f14\u5531\u4f1a \u539f\u5b9a2021\u6ca1\u6709\u5b8c\u6210\u7684\u4e8b\u60c5\uff0c\u57282022\u5e74\u4e5f\u6ca1\u6709\u5b8c\u6210\uff0c\u5e0c\u671b2023\u5e74\u5b8c\u6210\u3002 2023\u5c31\u5f00\u59cb\u5c1d\u8bd5\u8bb2\u5e08\uff0c\u505a\u81ea\u7531\u804c\u4e1a\u4e86 \u4eca\u5e74\u8fd8\u662f\u6bd4\u8f83\u503c\u5f97\u5e86\u795d\u7684\u4e00\u5e74\uff0c\u9996\u5148\u4eca\u5e74\u75ab\u60c5\u7ec8\u4e8e\u653e\u5f00\u4e86\uff0c\u5c01\u4e86\u4e09\u5e74\u5feb\u628a\u5927\u5bb6\u90fd\u5173\u50bb\u4e86\uff0c\u73b0\u5728\u653e\u5f00\u4e4b\u540e\u867d\u7136\u5927\u90e8\u5206\u7684\u4eba\u90fd\u7f8a\u4e86\uff0c\u597d\u5728\u60c5\u51b5\u4e0d\u662f\u5f88\u7cdf\u7cd5\u3002\u672a\u6765\u5e0c\u671b\u80fd\u591f\u8d8a\u6765\u8d8a\u597d\u3002 \u62112022\u7684\u6545\u4e8b\u5230\u8fd9\u91cc\u5c31\u7ed3\u675f\u4e86\uff0c2023\u5e0c\u671b\u80fd\u8c08\u4e00\u6bb5\u6709\u7ed3\u679c\u7684\u611f\u60c5\u3002\u80fd\u505a\u81ea\u5df1\u70ed\u7231\u7684\u4e8b\u60c5\uff0c\u79ef\u6781\uff0c\u52aa\u529b\u5411\u4e0a~","title":"\u300a\u7545\u4eab\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/","text":"\u6211\u76842023 \u00b6 Hello\uff0c\u5927\u5bb6\u597d\uff0c2022\u5df2\u7ecf\u8fc7\u53bb\uff0c\u5982\u4eca\u75ab\u60c5\u4e5f\u8fc7\u53bb\u4e86\uff0c\u7ec8\u4e8e\u4e0d\u7528\u80c6\u6218\u5fc3\u60ca\u4e86\u3002\u56e0\u6b64\u5bf9\u4e8e\u6211\u76842023\u8fd8\u662f\u6709\u5f88\u591a\u7684\u671f\u5f85\uff01\u5bf9\u4e8e2023\u5e74\u9700\u8981\u8fdb\u884c\u89c4\u5212\u548c\u68b3\u7406\uff0c\u770b\u770b\u4eca\u5e74\u505a\u4e86\u4ec0\u4e48\uff0c\u548c\u51c6\u5907\u505a\u4ec0\u4e48\u3002\u5bf9\u4eba\u751f\u6709\u8fd9\u89c4\u5212\u548c\u5b9a\u4f4d\u8ba9\u81ea\u5df1\u53bb\u4e0d\u65ad\u8fdb\u6b65\u3002\uff08\u4e2a\u4eba\u89c9\u5f97\u5199\u535a\u5ba2\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u4e60\u60ef\uff0c\u53ef\u4ee5\u5e2e\u52a9\u81ea\u5df1\u56de\u5fc6\u5f88\u7f8e\u597d\u7684\u8fc7\u53bb!\uff09 \u5927\u81f4\u5185\u5bb9\u6709\u51e0\u4e2a\u65b9\u9762: \u00b6 \u505a\u4e86\u4ec0\u4e48\uff1f \u00b6 \u7b2c\u4e00\u6b21\u53bb\u9b54\u90fd\u4e0a\u6d77\uff0c\u611f\u53d7\u5230\u5916\u6ee9\u7684\u591c\u666f\u3002\uff08\u771f\u7684\u5f88\u7f8e\uff0c\u786e\u5b9e\u503c\u5f97\u4e00\u53bb\uff09 \u6210\u529f\u8003\u53d6CKA\u548cCKS\u4e24\u4e2akubernetes\u8ba4\u8bc1 \u5c0f\u5b66\u540c\u5b66\u805a\u4f1a \u53bb\u592a\u539f\u89c1\u4e86\u4e24\u4e2a\u670b\u53cb\uff0c\u5218\u9e4f\u4e0e\u5e9a\u54e5\u548c\u8d85\u54e5\u3002(\u548c\u66f4\u54e5\u8c08\u4e86\u5f88\u591a\u9ad8\u6df1\u8bdd\u9898\uff5e) \u89c1\u4e86\u524d\u540c\u4e8b\u5f90\u54e5\uff08\u8bf7\u5f90\u54e5\u5403\u7684\u70e4\u8089\uff0c\u560e\u560e\u9999\uff09 \u548c\u540c\u4e8b\u4e00\u8d77\u53bbKTV\uff0c\u89c1\u8bc6\u5c0f\u946b\u6b4c\u58f0\u7684\u5531\u5de5 \u7b2c\u4e00\u6b21\u53bb\u5317\u4eac\u5927\u5174\u56fd\u9645\u673a\u573a\u548c\u4e0a\u6d77\u6d66\u4e1c\u56fd\u9645\u673a\u573a\uff08\u771f\u7684\u5927......\uff09 \u7b2c\u4e00\u6b21\u53bb\u5e7f\u5dde\uff08\u53bb\u4e86\u5e7f\u5dde\u5854\u6e9c\u8fbe\uff09 \u79d1\u4e8c\u8003\u8fc7\u4e86\uff0c\u79d1\u4e09\u8fd8\u5728\u7ee7\u7eed\u4e2d.......(\u4e0d\u8fc7\u6ca1\u6709\u6302\u79d1\uff0c\u516d\u4e2a\u4e2d\u5348\u89e3\u51b3\u79d1\u4e8c\uff0c\u6d77\u6dc0\u9a7e\u6821\u5f88\u4e0d\u9519) \u53bb\u4e0a\u6d77\u53c2\u52a0kubecon\u5927\u4f1a\uff08\u6da8\u4e86\u5f88\u591a\u89c1\u8bc6\uff09 \u4e0a\u6d77\u53bb\u4e86\u5916\u6ee9\uff0c\u8fd9\u6b21\u7b2c\u4e00\u6b21\u53bb\u9646\u5bb6\u5634 \u5927\u5e08\u9001\u6247\u5b50\u9898\u5b57 \u7b2c\u4e00\u6b21\u6765\u6df1\u5733\uff0c\u975e\u5e38\u6f02\u4eae\u7684\u57ce\u5e02\u3002 \u8868\u59b9\u5a01\u6d77\u9001\u624b\u5199\u7b7e\u540d,\u54c8\u54c8\u54c8 \u4e0b\u9762\u914d\u56fe\u770b\u4e00\u4e0b \u00b6 \u300a\u4e0a\u6d77\u7bc7\u300b \u00b6 \u591c\u666f\u5916\u6ee9 \u9646\u5bb6\u5634 \u5357\u4eac\u8def \u4e1c\u65b9\u660e\u73e0 \u300a\u5e7f\u5dde\u7bc7\u300b \u00b6 \u5e7f\u5dde\u51fa\u5dee\u62cd\u4e86\u4e00\u4e9b\u597d\u770b\u7684\u98ce\u666f \u4e0b\u9762\u5c31\u5feb\u5230\u5e7f\u5dde\u7684\u5730\u754c\u4e86 \u5e7f\u5dde\u5854\u6765\u4e86 \u6700\u540e\u4e00\u5929\u548c\u534e\u6770\u5403\u7684\u70e7\u70e4\u8fd8\u4e0d\u9519 \u300a\u6df1\u5733\u7bc7\u300b \u00b6 \u56fd\u5e86\u4e4b\u540e\u6765\u7684\u6df1\u5733\uff0c\u8bb0\u5fc6\u5f88\u6df1\u523b\uff0c\u5317\u4eac\u662f\u51ac\u5929\uff0c\u6df1\u5733\u662f\u590f\u5929\u3002 \u56e0\u4e3a\u6765\u7684\u6bd4\u8f83\u65e9\uff0c\u5c31\u53bb\u6df1\u5733\u6e7e\u901b\u4e86\u901b\uff0c@\u6211\u751f\u75c5\u7684\u5927\u6028\u79cd\u540c\u4e8b\u4e00\u8d77\u53bb\u7684 \u4e0d\u5f97\u4e0d\u8bf4\uff0c\u6df1\u5733\u786e\u5b9e\u975e\u5e38\u7684\u6f02\u4eae\u3002\u7279\u522b\u503c\u5f97\u53bb\u3002 \u5728\u6df1\u5733\u62db\u5546\u5c40\u4e0a\u7684\u4e00\u62cd \u5de5\u4f5c\u7ed3\u675f\u53bb\u722c\u4e86\u5357\u5c71\u516c\u56ed\uff08\u514d\u8d39\u7684\u5f88\u91cd\u8981\uff09 \u771f\u7684\u8d85\u7ea7\u6f02\u4eae\uff0c\u4e0d\u8fc7\u9700\u8981\u722c\u5f88\u4e45\uff5e \u300a\u5929\u6d25\u7bc7\u300b \u00b6 \u5f71\u54cd\u5f88\u6df1\u523b\u7684\u56fe\u4e66\u9986\uff0c\u771f\u7684\u5927...... \u5403\u70e7\u70e4\u8fd8\u6709\u9a7b\u5531 \u300a\u516c\u53f8\u7bc7\u300b \u00b6 \u5e74\u540e\u521a\u521a\u6765,\u8001\u738b\u7684\u7ea2\u5305 \u5c0f\u7434\u540c\u5b66\u8fc7\u751f\u65e5 \u854a\u840c\u62ff\u7684\u6c34\u679c\u679c\u76d8(\u5f88\u4e0d\u9519,\u8d5e) \u4e0a\u5929\u6d25\u65b0\u95fb\u7684\u6211\u4eec \u94c1\u6253\u7684\u6d41\u6c34\u7ebf,\u5e05\u6c14\u5de5\u4f5c\u7684\u6211(\u591a\u8c22\u4e09\u7f8a~\u62cd\u7684\u5f88\u5e05) \u6765\u81ea\u8001\u738b\u7684\u53d1\u8a00 \u8fd9\u5f20\u56fe\u5c31\u5f88\u6709\u8da3\u4e86 \u300a\u7ec3\u8f66\u7bc7\u300b \u00b6 \u5929\u8499\u8499\u4eae\u4e94\u70b9\u8d77\u5e8a\u51fa\u53d1!(\u5468\u672b\u73ed\u771f\u7684\u8f9b\u82e6) \u6211\u7684\u7ec3\u8f66\u8def\u7ebf,\u5b59\u6cb3\u2192\u7535\u52a8\u8f66\u2192\u671b\u4eac\u2192\u6d77\u6dc0\u9a7e\u6821 \u6d77\u6dc0\u65e5\u51fa \u5c31\u662f\u8fd9\u4e2a\u6559\u7ec3\u9a82\u7684\u6211\u771f\u60e8~ \u6362\u4e86\u4e00\u4e2a\u6559\u7ec3,\u7b2c\u4e00\u6b21\u7ec3\u5012\u5e93,\u8fd8\u4e0d\u9519 \u529f\u592b\u4e0d\u8d1f\u6709\u5fc3\u4eba\uff0c\u4e00\u6b21\u6ca1\u6709\u6302\u3002 \u300a\u642c\u5bb6\u7bc7\u300b \u00b6 \u516c\u53f8\u4ece12\u697c\u642c\u5230\u73b0\u5728\u768426\u697c\u5566 \u300a\u6210\u5c31\u7bc7\u300b \u00b6 \u83b7\u5f97\u4e24\u4e2a\u8ba4\u8bc1,\u8fd8\u53c2\u52a0\u7684 kubecon \u7684\u6d3b\u52a8. kubecon \u6d3b\u52a8 \u519c\u4e1a\u94f6\u884c\u67b6\u6784\u5e08 \u963f\u91cc\u5c0f\u54e5\u7684containerd \u7684\u5206\u4eab kubecon \u5927\u4f1a\u5c55\u53f0 \u611f\u89c9\u633a\u597d\u73a9,\u7b97\u4e86\u4e00\u5366 \u51fa\u95e8\u66b4\u5bcc\u592a\u7c97\u9c81\u4e86,\u5c31\u524d\u7a0b\u4f3c\u9526\u5427.\u54c8\u54c8 \u56fd\u5e86\u8282\u65e5\u5168\u6b3e\u7ed9\u8001\u7238\u62ff\u4e0b\u4ed6\u559c\u6b22\u7684\u8f66 \u300a\u4e2a\u4eba\u7bc7\u300b \u00b6 \u89c1\u4e86\u4ee5\u4e0b\u4e00\u4e2a\u597d\u54e5\u4eec,(\u9e4f\u54e5,\u8d85\u54e5,\u5e9a\u54e5,\u65ed\u54e5,\u5174\u54e5,\u745e\u8c6a,\u8001\u5f90,\u80d6\u5b50) \u5c0f\u5468\u8bf7\u5403\u7684\u81ea\u8db3\u5927\u9910 \u6765\u5c0f\u5468\u5bb6\u73a9 \u5c31\u662f\u5403\u5403\u5403 \u8fd9\u5c0f\u5bb6\u4f19\u771f\u7684\u840c \u8868\u59b9\u5728\u5a01\u6d77\u5199\u7684\u6211\u7684\u540d\u5b57(\u5c31\u5f53\u6211\u4e5f\u53bb\u8fc7\u4e86)","title":"\u6211\u76842023"},{"location":"20.mylife/2023-life-docs/#2023","text":"Hello\uff0c\u5927\u5bb6\u597d\uff0c2022\u5df2\u7ecf\u8fc7\u53bb\uff0c\u5982\u4eca\u75ab\u60c5\u4e5f\u8fc7\u53bb\u4e86\uff0c\u7ec8\u4e8e\u4e0d\u7528\u80c6\u6218\u5fc3\u60ca\u4e86\u3002\u56e0\u6b64\u5bf9\u4e8e\u6211\u76842023\u8fd8\u662f\u6709\u5f88\u591a\u7684\u671f\u5f85\uff01\u5bf9\u4e8e2023\u5e74\u9700\u8981\u8fdb\u884c\u89c4\u5212\u548c\u68b3\u7406\uff0c\u770b\u770b\u4eca\u5e74\u505a\u4e86\u4ec0\u4e48\uff0c\u548c\u51c6\u5907\u505a\u4ec0\u4e48\u3002\u5bf9\u4eba\u751f\u6709\u8fd9\u89c4\u5212\u548c\u5b9a\u4f4d\u8ba9\u81ea\u5df1\u53bb\u4e0d\u65ad\u8fdb\u6b65\u3002\uff08\u4e2a\u4eba\u89c9\u5f97\u5199\u535a\u5ba2\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u4e60\u60ef\uff0c\u53ef\u4ee5\u5e2e\u52a9\u81ea\u5df1\u56de\u5fc6\u5f88\u7f8e\u597d\u7684\u8fc7\u53bb!\uff09","title":"\u6211\u76842023"},{"location":"20.mylife/2023-life-docs/#_1","text":"","title":"\u5927\u81f4\u5185\u5bb9\u6709\u51e0\u4e2a\u65b9\u9762:"},{"location":"20.mylife/2023-life-docs/#_2","text":"\u7b2c\u4e00\u6b21\u53bb\u9b54\u90fd\u4e0a\u6d77\uff0c\u611f\u53d7\u5230\u5916\u6ee9\u7684\u591c\u666f\u3002\uff08\u771f\u7684\u5f88\u7f8e\uff0c\u786e\u5b9e\u503c\u5f97\u4e00\u53bb\uff09 \u6210\u529f\u8003\u53d6CKA\u548cCKS\u4e24\u4e2akubernetes\u8ba4\u8bc1 \u5c0f\u5b66\u540c\u5b66\u805a\u4f1a \u53bb\u592a\u539f\u89c1\u4e86\u4e24\u4e2a\u670b\u53cb\uff0c\u5218\u9e4f\u4e0e\u5e9a\u54e5\u548c\u8d85\u54e5\u3002(\u548c\u66f4\u54e5\u8c08\u4e86\u5f88\u591a\u9ad8\u6df1\u8bdd\u9898\uff5e) \u89c1\u4e86\u524d\u540c\u4e8b\u5f90\u54e5\uff08\u8bf7\u5f90\u54e5\u5403\u7684\u70e4\u8089\uff0c\u560e\u560e\u9999\uff09 \u548c\u540c\u4e8b\u4e00\u8d77\u53bbKTV\uff0c\u89c1\u8bc6\u5c0f\u946b\u6b4c\u58f0\u7684\u5531\u5de5 \u7b2c\u4e00\u6b21\u53bb\u5317\u4eac\u5927\u5174\u56fd\u9645\u673a\u573a\u548c\u4e0a\u6d77\u6d66\u4e1c\u56fd\u9645\u673a\u573a\uff08\u771f\u7684\u5927......\uff09 \u7b2c\u4e00\u6b21\u53bb\u5e7f\u5dde\uff08\u53bb\u4e86\u5e7f\u5dde\u5854\u6e9c\u8fbe\uff09 \u79d1\u4e8c\u8003\u8fc7\u4e86\uff0c\u79d1\u4e09\u8fd8\u5728\u7ee7\u7eed\u4e2d.......(\u4e0d\u8fc7\u6ca1\u6709\u6302\u79d1\uff0c\u516d\u4e2a\u4e2d\u5348\u89e3\u51b3\u79d1\u4e8c\uff0c\u6d77\u6dc0\u9a7e\u6821\u5f88\u4e0d\u9519) \u53bb\u4e0a\u6d77\u53c2\u52a0kubecon\u5927\u4f1a\uff08\u6da8\u4e86\u5f88\u591a\u89c1\u8bc6\uff09 \u4e0a\u6d77\u53bb\u4e86\u5916\u6ee9\uff0c\u8fd9\u6b21\u7b2c\u4e00\u6b21\u53bb\u9646\u5bb6\u5634 \u5927\u5e08\u9001\u6247\u5b50\u9898\u5b57 \u7b2c\u4e00\u6b21\u6765\u6df1\u5733\uff0c\u975e\u5e38\u6f02\u4eae\u7684\u57ce\u5e02\u3002 \u8868\u59b9\u5a01\u6d77\u9001\u624b\u5199\u7b7e\u540d,\u54c8\u54c8\u54c8","title":"\u505a\u4e86\u4ec0\u4e48\uff1f"},{"location":"20.mylife/2023-life-docs/#_3","text":"","title":"\u4e0b\u9762\u914d\u56fe\u770b\u4e00\u4e0b"},{"location":"20.mylife/2023-life-docs/#_4","text":"\u591c\u666f\u5916\u6ee9 \u9646\u5bb6\u5634 \u5357\u4eac\u8def \u4e1c\u65b9\u660e\u73e0","title":"\u300a\u4e0a\u6d77\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_5","text":"\u5e7f\u5dde\u51fa\u5dee\u62cd\u4e86\u4e00\u4e9b\u597d\u770b\u7684\u98ce\u666f \u4e0b\u9762\u5c31\u5feb\u5230\u5e7f\u5dde\u7684\u5730\u754c\u4e86 \u5e7f\u5dde\u5854\u6765\u4e86 \u6700\u540e\u4e00\u5929\u548c\u534e\u6770\u5403\u7684\u70e7\u70e4\u8fd8\u4e0d\u9519","title":"\u300a\u5e7f\u5dde\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_6","text":"\u56fd\u5e86\u4e4b\u540e\u6765\u7684\u6df1\u5733\uff0c\u8bb0\u5fc6\u5f88\u6df1\u523b\uff0c\u5317\u4eac\u662f\u51ac\u5929\uff0c\u6df1\u5733\u662f\u590f\u5929\u3002 \u56e0\u4e3a\u6765\u7684\u6bd4\u8f83\u65e9\uff0c\u5c31\u53bb\u6df1\u5733\u6e7e\u901b\u4e86\u901b\uff0c@\u6211\u751f\u75c5\u7684\u5927\u6028\u79cd\u540c\u4e8b\u4e00\u8d77\u53bb\u7684 \u4e0d\u5f97\u4e0d\u8bf4\uff0c\u6df1\u5733\u786e\u5b9e\u975e\u5e38\u7684\u6f02\u4eae\u3002\u7279\u522b\u503c\u5f97\u53bb\u3002 \u5728\u6df1\u5733\u62db\u5546\u5c40\u4e0a\u7684\u4e00\u62cd \u5de5\u4f5c\u7ed3\u675f\u53bb\u722c\u4e86\u5357\u5c71\u516c\u56ed\uff08\u514d\u8d39\u7684\u5f88\u91cd\u8981\uff09 \u771f\u7684\u8d85\u7ea7\u6f02\u4eae\uff0c\u4e0d\u8fc7\u9700\u8981\u722c\u5f88\u4e45\uff5e","title":"\u300a\u6df1\u5733\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_7","text":"\u5f71\u54cd\u5f88\u6df1\u523b\u7684\u56fe\u4e66\u9986\uff0c\u771f\u7684\u5927...... \u5403\u70e7\u70e4\u8fd8\u6709\u9a7b\u5531","title":"\u300a\u5929\u6d25\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_8","text":"\u5e74\u540e\u521a\u521a\u6765,\u8001\u738b\u7684\u7ea2\u5305 \u5c0f\u7434\u540c\u5b66\u8fc7\u751f\u65e5 \u854a\u840c\u62ff\u7684\u6c34\u679c\u679c\u76d8(\u5f88\u4e0d\u9519,\u8d5e) \u4e0a\u5929\u6d25\u65b0\u95fb\u7684\u6211\u4eec \u94c1\u6253\u7684\u6d41\u6c34\u7ebf,\u5e05\u6c14\u5de5\u4f5c\u7684\u6211(\u591a\u8c22\u4e09\u7f8a~\u62cd\u7684\u5f88\u5e05) \u6765\u81ea\u8001\u738b\u7684\u53d1\u8a00 \u8fd9\u5f20\u56fe\u5c31\u5f88\u6709\u8da3\u4e86","title":"\u300a\u516c\u53f8\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_9","text":"\u5929\u8499\u8499\u4eae\u4e94\u70b9\u8d77\u5e8a\u51fa\u53d1!(\u5468\u672b\u73ed\u771f\u7684\u8f9b\u82e6) \u6211\u7684\u7ec3\u8f66\u8def\u7ebf,\u5b59\u6cb3\u2192\u7535\u52a8\u8f66\u2192\u671b\u4eac\u2192\u6d77\u6dc0\u9a7e\u6821 \u6d77\u6dc0\u65e5\u51fa \u5c31\u662f\u8fd9\u4e2a\u6559\u7ec3\u9a82\u7684\u6211\u771f\u60e8~ \u6362\u4e86\u4e00\u4e2a\u6559\u7ec3,\u7b2c\u4e00\u6b21\u7ec3\u5012\u5e93,\u8fd8\u4e0d\u9519 \u529f\u592b\u4e0d\u8d1f\u6709\u5fc3\u4eba\uff0c\u4e00\u6b21\u6ca1\u6709\u6302\u3002","title":"\u300a\u7ec3\u8f66\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_10","text":"\u516c\u53f8\u4ece12\u697c\u642c\u5230\u73b0\u5728\u768426\u697c\u5566","title":"\u300a\u642c\u5bb6\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_11","text":"\u83b7\u5f97\u4e24\u4e2a\u8ba4\u8bc1,\u8fd8\u53c2\u52a0\u7684 kubecon \u7684\u6d3b\u52a8. kubecon \u6d3b\u52a8 \u519c\u4e1a\u94f6\u884c\u67b6\u6784\u5e08 \u963f\u91cc\u5c0f\u54e5\u7684containerd \u7684\u5206\u4eab kubecon \u5927\u4f1a\u5c55\u53f0 \u611f\u89c9\u633a\u597d\u73a9,\u7b97\u4e86\u4e00\u5366 \u51fa\u95e8\u66b4\u5bcc\u592a\u7c97\u9c81\u4e86,\u5c31\u524d\u7a0b\u4f3c\u9526\u5427.\u54c8\u54c8 \u56fd\u5e86\u8282\u65e5\u5168\u6b3e\u7ed9\u8001\u7238\u62ff\u4e0b\u4ed6\u559c\u6b22\u7684\u8f66","title":"\u300a\u6210\u5c31\u7bc7\u300b"},{"location":"20.mylife/2023-life-docs/#_12","text":"\u89c1\u4e86\u4ee5\u4e0b\u4e00\u4e2a\u597d\u54e5\u4eec,(\u9e4f\u54e5,\u8d85\u54e5,\u5e9a\u54e5,\u65ed\u54e5,\u5174\u54e5,\u745e\u8c6a,\u8001\u5f90,\u80d6\u5b50) \u5c0f\u5468\u8bf7\u5403\u7684\u81ea\u8db3\u5927\u9910 \u6765\u5c0f\u5468\u5bb6\u73a9 \u5c31\u662f\u5403\u5403\u5403 \u8fd9\u5c0f\u5bb6\u4f19\u771f\u7684\u840c \u8868\u59b9\u5728\u5a01\u6d77\u5199\u7684\u6211\u7684\u540d\u5b57(\u5c31\u5f53\u6211\u4e5f\u53bb\u8fc7\u4e86)","title":"\u300a\u4e2a\u4eba\u7bc7\u300b"},{"location":"20.mylife/2024-9-24-myblog-life-docs/","text":"\u6211\u7684\u535a\u5ba2 \u00b6 \u6700\u521d\u5199 blog \u7684\u76ee\u7684\u662f\u4e3a\u4e86\u5199\u7b14\u8bb0,\u540e\u6765\u6162\u6162\u89c9\u5f97\u8fd9\u4e2a\u8bb0\u5f55\u5bf9\u4e8e\u5b66\u4e60\u548c\u590d\u4e60\u6709\u7740\u5f88\u5927\u5e2e\u52a9.\u540e\u6765\u5c31\u770b\u4e00\u4e9b\u7f51\u4e0a\u7684\u6587\u7ae0\u548c\u9633\u603b\u7684\u6587\u7ae0,\u6700\u7ec8\u9009\u62e9\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u6765\u8bb0\u5f55. \u4f18\u70b9 \u00b6 \u53ef\u4ee5\u4f7f\u7528 git \u5de5\u4f5c\u6d41\u7684\u65b9\u5f0f\u534f\u540c\u5de5\u4f5c\u548c\u5199\u4f5c.(\u6bcf\u4e00\u4e2a\u4eba\u4e00\u4e2a\u5206\u652f,\u6700\u540e\u5408\u5e76\u5230\u4e3b\u7ebf\u5206\u652f,\u7136\u540e\u5bf9\u5916\u53d1\u5e03) \u56e0\u4e3a\u662f\u4f7f\u7528\u7684 git,\u6240\u4ee5\u6bcf\u4e00\u6b21\u63d0\u4ea4\u90fd\u4f1a\u6709\u8bb0\u5f55\u548c\u5bf9\u6bd4.(\u76f8\u5bf9\u4e8e gitee \u4f53\u9a8c\u611f\u4f1a\u597d\u5f88\u591a) \u4e0d\u9700\u8981\u81ea\u5df1\u7533\u8bf7\u57df\u540d,\u4f7f\u7528 github.io \u6765\u6258\u7ba1 \u7f3a\u70b9 \u00b6 \u9700\u8981\u7ffb\u5899,\u624d\u80fd\u5f88\u597d\u7684\u8bbf\u95ee github.\u4e0d\u7136\u4f1a\u5f88\u5361 \u9700\u8981\u6709\u4e00\u5b9a\u7684 git \u57fa\u7840\u624d\u80fd\u4e0a\u624b,\u4e0d\u9002\u5408\u5927\u90e8\u5206\u4eba. \u56fd\u5185\u5982\u679c\u60f3\u8bbf\u95ee\u8fd9\u4e2a blog \u4ed3\u5e93,\u9700\u8981\u5c06 github \u4ed3\u5e93 -> \u540c\u6b65 -> \u56fd\u5185(\u8fd9\u4e2a\u53ef\u4ee5\u5229\u7528 github action \u505a\u5230) \u603b\u4f53\u6765\u8bf4,\u8fd9\u79cd\u8bb0\u5f55\u65b9\u5f0f\u662f\u6211\u7528\u8fc7\u7684\u6bd4\u8f83\u597d\u8bb0\u5f55\u7b14\u8bb0\u7684\u65b9\u5f0f,\u6bd4\u8f83\u7b26\u5408\u7a0b\u5e8f\u5458\u7684\u5de5\u4f5c\u6a21\u5f0f.\u4e5f\u80fd\u66f4\u597d\u7684\u8fd0\u7528 git \u5de5\u4f5c\u6d41\u7a0b.\u9488\u5bf9\u4e00\u4e9b\u7b14\u8bb0,\u6211\u8fd8\u662f\u66f4\u503e\u5411\u4e8e\u8fd9\u79cd\u8bb0\u5f55.\u4f46\u662f\u9488\u5bf9\u4e00\u4e9b\u4fdd\u5bc6\u7684\u4e0d\u80fd\u516c\u5f00\u7684\u5efa\u8bae\u8fd8\u662f\u4f7f\u7528\u4e2a\u4eba\u8d26\u53f7\u7684 app \u6765\u8bb0\u5f55.\u6211\u5e73\u65f6\u4e00\u822c\u4f7f\u7528\u7684\u4e00\u6b3e\u8f6f\u4ef6\u53eb notion 2024 \u603b\u7ed3 \u00b6 \u5b66\u8fc7\u4e0d\u7b49\u4e8e\u4f1a.\u8981\u591a\u5728\u5b9e\u8df5\u4e2d\u8fd0\u7528,\u624d\u4f1a\u6709\u66f4\u591a\u7684\u611f\u609f.","title":"\u6211\u7684\u535a\u5ba2"},{"location":"20.mylife/2024-9-24-myblog-life-docs/#_1","text":"\u6700\u521d\u5199 blog \u7684\u76ee\u7684\u662f\u4e3a\u4e86\u5199\u7b14\u8bb0,\u540e\u6765\u6162\u6162\u89c9\u5f97\u8fd9\u4e2a\u8bb0\u5f55\u5bf9\u4e8e\u5b66\u4e60\u548c\u590d\u4e60\u6709\u7740\u5f88\u5927\u5e2e\u52a9.\u540e\u6765\u5c31\u770b\u4e00\u4e9b\u7f51\u4e0a\u7684\u6587\u7ae0\u548c\u9633\u603b\u7684\u6587\u7ae0,\u6700\u7ec8\u9009\u62e9\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u6765\u8bb0\u5f55.","title":"\u6211\u7684\u535a\u5ba2"},{"location":"20.mylife/2024-9-24-myblog-life-docs/#_2","text":"\u53ef\u4ee5\u4f7f\u7528 git \u5de5\u4f5c\u6d41\u7684\u65b9\u5f0f\u534f\u540c\u5de5\u4f5c\u548c\u5199\u4f5c.(\u6bcf\u4e00\u4e2a\u4eba\u4e00\u4e2a\u5206\u652f,\u6700\u540e\u5408\u5e76\u5230\u4e3b\u7ebf\u5206\u652f,\u7136\u540e\u5bf9\u5916\u53d1\u5e03) \u56e0\u4e3a\u662f\u4f7f\u7528\u7684 git,\u6240\u4ee5\u6bcf\u4e00\u6b21\u63d0\u4ea4\u90fd\u4f1a\u6709\u8bb0\u5f55\u548c\u5bf9\u6bd4.(\u76f8\u5bf9\u4e8e gitee \u4f53\u9a8c\u611f\u4f1a\u597d\u5f88\u591a) \u4e0d\u9700\u8981\u81ea\u5df1\u7533\u8bf7\u57df\u540d,\u4f7f\u7528 github.io \u6765\u6258\u7ba1","title":"\u4f18\u70b9"},{"location":"20.mylife/2024-9-24-myblog-life-docs/#_3","text":"\u9700\u8981\u7ffb\u5899,\u624d\u80fd\u5f88\u597d\u7684\u8bbf\u95ee github.\u4e0d\u7136\u4f1a\u5f88\u5361 \u9700\u8981\u6709\u4e00\u5b9a\u7684 git \u57fa\u7840\u624d\u80fd\u4e0a\u624b,\u4e0d\u9002\u5408\u5927\u90e8\u5206\u4eba. \u56fd\u5185\u5982\u679c\u60f3\u8bbf\u95ee\u8fd9\u4e2a blog \u4ed3\u5e93,\u9700\u8981\u5c06 github \u4ed3\u5e93 -> \u540c\u6b65 -> \u56fd\u5185(\u8fd9\u4e2a\u53ef\u4ee5\u5229\u7528 github action \u505a\u5230) \u603b\u4f53\u6765\u8bf4,\u8fd9\u79cd\u8bb0\u5f55\u65b9\u5f0f\u662f\u6211\u7528\u8fc7\u7684\u6bd4\u8f83\u597d\u8bb0\u5f55\u7b14\u8bb0\u7684\u65b9\u5f0f,\u6bd4\u8f83\u7b26\u5408\u7a0b\u5e8f\u5458\u7684\u5de5\u4f5c\u6a21\u5f0f.\u4e5f\u80fd\u66f4\u597d\u7684\u8fd0\u7528 git \u5de5\u4f5c\u6d41\u7a0b.\u9488\u5bf9\u4e00\u4e9b\u7b14\u8bb0,\u6211\u8fd8\u662f\u66f4\u503e\u5411\u4e8e\u8fd9\u79cd\u8bb0\u5f55.\u4f46\u662f\u9488\u5bf9\u4e00\u4e9b\u4fdd\u5bc6\u7684\u4e0d\u80fd\u516c\u5f00\u7684\u5efa\u8bae\u8fd8\u662f\u4f7f\u7528\u4e2a\u4eba\u8d26\u53f7\u7684 app \u6765\u8bb0\u5f55.\u6211\u5e73\u65f6\u4e00\u822c\u4f7f\u7528\u7684\u4e00\u6b3e\u8f6f\u4ef6\u53eb notion","title":"\u7f3a\u70b9"},{"location":"20.mylife/2024-9-24-myblog-life-docs/#2024","text":"\u5b66\u8fc7\u4e0d\u7b49\u4e8e\u4f1a.\u8981\u591a\u5728\u5b9e\u8df5\u4e2d\u8fd0\u7528,\u624d\u4f1a\u6709\u66f4\u591a\u7684\u611f\u609f.","title":"2024 \u603b\u7ed3"},{"location":"20.mylife/2024-life-docs/","text":"2023 \u5306\u5306\u8fc7\u53bb\uff0c\u8fc7\u5e74\u7684\u65f6\u5019\u5728\u5bb6\u505a\u4e86\u4e00\u4e9b\u4e2a\u4eba\u603b\u7ed3\uff0c\u4e3b\u8981\u662f\u7ed9\u81ea\u5df1\u63d0\u4e86\u4e00\u4e9b\u89c4\u5212\u548c\u4efb\u52a1\u57282024\u5b8c\u6210\u3002 \u89c4\u5212 \u00b6 \u751f\u6d3b\u89c4\u5212 \u5b58\u94b1\u8ba1\u5212: \u5e74\u524d\u7684\u65f6\u5019\u548c\u6211\u7684\u597d\u54e5\u4eec\u963f\u519b\u5403\u4e86\u4e2a\u996d\uff0c\u4ece\u4ed6\u90a3\u5f97\u77e5\u4e86\u4ed6\u7684\u5b58\u6b3e\uff0c\u624d\u77e5\u9053\u8fd9\u4e24\u5e74\u6709\u70b9\u5927\u624b\u5927\u811a\u4e86\uff0c\u9700\u8981\u5b66\u4e60\u4e00\u4e0b\u4ed6\u7684\u5b58\u94b1\u3002\u5bf9\u672a\u6765\u7684\u4e0d\u786e\u5b9a\u6709\u4e00\u4e2a\u4fdd\u969c\u3002 \u6574\u7259\u8ba1\u5212\u5217\u5165\u5b89\u6392 \u5b66\u4e60\u89c4\u5212 \u6b63\u7578\u7ecf\u5386 \u00b6 \u7531\u4e8e\u5c0f\u65f6\u5019\uff0c\u7236\u6bcd\u5728\u519c\u6c11\u6ca1\u6709\u5bf9\u6211\u7684\u53e3\u8154\u95ee\u9898\u7279\u522b\u7684\u91cd\u89c6\uff0c\u5bfc\u81f4\u6211\u73b0\u5728\u9700\u8981\u8fdb\u884c\u6574\u7259\u3002\u5c06\u7259\u6536\u56de\u3002 \u5317\u5927\u53e3\u8154\u7b2c\u4e8c\u95e8\u8bca \u00b6 \u5f00\u59cb\u7684\u65f6\u5019\uff0c\u6211\u5148\u53bb\u4e86\u5317\u5927\u53e3\u8154\u7b2c\u4e8c\u95e8\u8bca\u90e8\uff0c\u4e86\u89e3\u4e00\u4e0b\u6574\u7259\u7684\u5927\u6982\u6d41\u7a0b\u53ef\u4ee5\u82b1\u8d39\u3002\uff08\u4ee5\u4e0b\u662f\u5317\u5927\u53e3\u8154\u7684\u6cbb\u7597\u8d39\u7528\uff09 \u5317\u4eac\u5927\u5b66\u53e3\u8154\u533b\u9662\u6b63\u7578\u521d\u8bca\u60a3\u8005\u5c31\u8bca\u6d41\u7a0b \u7b2c\u4e00\u6b21\u5c31\u8bca\uff1a \u54a8\u8be2\uff08\u4e86\u89e3\u6b63\u7578\u6cbb\u7597\u65b9\u5f0f\u3001\u7597\u7a0b\u3001\u5927\u81f4\u8d39\u7528\u7b49\uff09\u5982\u4f55\u786e\u5b9a\u5f00\u59cb\u6b63\u7578\u6cbb\u7597 \u9886\u53d6\u9a8c\u8840\u9879\u76ee\u8981\u6c42 2. \u786e\u5b9a\u533b\u751f\u51fa\u8bca\u65f6\u95f4 \u8bf7\u81f3\u4e8c\u7532\uff08\u542b\uff09\u4ee5\u4e0a\u7efc\u5408\u533b\u9662\u7a7a\u8179\u5316\u9a8c\uff0c\u9879\u76ee\u8981\u6c42\u5982\u4e0b\uff1a \u6210\u5e74\u4eba\u9879\u76ee\u8981\u6c42\uff1a \u4e59\u809d\u8868\u9762\u6297\u539f \u4e19\u809d\u6297\u539f\u6216\u6297\u4f53 \u6885\u6bd2 \u6297HIV \u6885\u6bd2 \u672a\u6210\u5e74\u4eba\u9879\u76ee\u8981\u6c42\uff1a \u4e59\u809d\u8868\u9762\u6297\u539f \u4e19\u809d\u6297\u539f\u6216\u6297\u4f53 \u6885\u6bd2 \u7b2c\u4e8c\u6b21\u5c31\u8bca\uff1a \u643a\u5e26\u7eb8\u8d28\u7248\u5316\u9a8c\u7ed3\u679c\uff08\u7ed3\u679c\u6709\u6548\u671f\u4e3a\u4e09\u4e2a\u6708\uff09\uff0c\u91c7\u96c6\u53e3\u8154\u8d44\u6599\uff08\u7259\u79d1\u6a21\u578b\u3001X\u7ebf\u7b49\u8d44\u6599\uff09\uff08\u907f\u514d\u559d\u5496\u5561\uff09\u8d39\u7528\uff1a1500 \u7b2c\u4e09\u6b21\u5c31\u8bca\uff1a \u8bbe\u8ba1\u5e76\u6c9f\u901a\u6b63\u7578\u6cbb\u7597\u65b9\u6848\uff08\u672a\u6210\u5e74\u4eba\u9700\u76d1\u62a4\u4eba\u966a\u540c\uff09 \u8d39\u7528: 2500 \u7b2c\u56db\u6b21\u5c31\u8bca\uff1a \u6234\u671f\u77eb\u6cbb\u5668\uff08\u672a\u6210\u5e74\u4eba\u9700\u76d1\u62a4\u4eba\u966a\u540c\u5c31\u8bca\uff09\u8d39\u7528: 10500 \u7136\u540e\u5e94\u8be5\u662f\u6bcf\u5e747000 * 3 \u4ee5\u4e0a\u7684\u56fe\u662f\u5218\u5927\u592b\u7ed9\u6211\u7684\uff0c\u8fd9\u8fb9\u4e3b\u8981\u662f\u5217\u4e3e\u4e86\u4e00\u4e9b\u8d39\u7528\u7684\u95ee\u9898\u3002 \u52b2\u677e\u53e3\u8154 \u00b6 \u4ee5\u4e0b\u6211\u5728\u52b2\u677e\u53e3\u8154\u83b7\u53d6\u7684\u5927\u6982\u6700\u7ec8\u6574\u7259\u4ef7\u683c\uff0c\u6700\u540e\u780d\u4ef7\u5230\u4e863w\uff0c\u7531\u9648\u5a07\u9662\u957f\u6765\u505a\u6b63\u7578\u3002\u603b\u7684\u6765\u8bf4\u6211\u8fd8\u662f\u8003\u8651\u53bb\u4e86\u79c1\u5229\u533b\u9662\u3002\u4e5f\u4e0d\u662f\u8bf4\u516c\u5386\u4e0d\u597d\uff0c \u7b2c\u4e00\u7684\u8ddd\u79bb\u7684\u95ee\u9898\uff0c\u6709\u4e00\u4e9b\u8fdc \u7b2c\u4e8c\u662f\u8d39\u7528\u95ee\u9898\u8d85\u51fa\u4e86\u6211\u7684\u9884\u671f\u5f88\u591a \u7b2c\u4e09\u6302\u53f7\u96be\uff0c\u8fd9\u4e2a\u8fd8\u662f\u95e8\u8bca\u8fd8\u4e0d\u662f\u603b\u9662\u3002 \u4e5f\u4e86\u89e3\u5230\uff0c\u5927\u6539\u7684\u65b9\u6848\u662f\u5dee\u4e0d\u591a\u7684\uff0c\u90fd\u9700\u8981\u62d4\u56db\u9897\u7259\uff5e\u3002 \u57fa\u4e8e\u4ee5\u4e0a\u7684\u8003\u8651\uff0c\u627e\u5230\u4e86\u8fd9\u4e2a\u79c1\u5229\u533b\u9662\u3002\u8fd9\u4e2a\u9662\u957f\u4e5f\u662f\u5317\u5927\u53e3\u8154\u51fa\u6765\u7684\u3002\u60f3\u4e86\u60f3\u5c31\u5728\u8fd9\u8fb9\u6574\u7259\u4e5f\u662f\u53ef\u4ee5\u7684\u3002 \u4e0b\u9762\u7684\u4e24\u5f20\u56fe\u4e5f\u80fd\u770b\u7684\u51fa\u6765\uff0c\u5916\u51f8\u6709\u70b9\u4e25\u91cd\uff0c\u6211\u7279\u610f\u95ee\u4e86\u533b\u751f\u3002\u8bf4\u6211\u8fd9\u4e2a\u6574\u7259\u7684\u96be\u5ea6\u5c5e\u4e8e\u54ea\u4e00\u7ea7\u522b\u3002\u4e24\u4e2a\u533b\u751f\u90fd\u8bf4\u7684\u4e2d\u7b49\u3002 \u6574\u7259\u4e00\u76f4\u662f\u53c2\u52a0\u5de5\u4f5c\u4e4b\u540e\u7684\u8981\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u6709\u4e9b\u4e8b\u60c5\u8fd8\u662f\u9700\u8981\u81ea\u5df1\u6765\u505a\u51b3\u7b56\u3002\u4e5f\u662f\u5e0c\u671b\u53ef\u4ee5\u6700\u7ec8\u5c06\u7259\u9f7f\u6574\u7684\u5f88\u597d\u3002\u6211\u4e5f\u6bd4\u8f83\u671f\u5f85\u3002 \u62d4\u7259\u7ecf\u5386 \u00b6 \u6211\u4e00\u5171\u9700\u8981\u62d4\u56db\u9897\u7259\uff0c\u4e24\u9897\u6b63\u7578\u7259\uff0c\u4e24\u9897\u574f\u7259\u3002 \u5de6\u4fa7\u524d\u4e24\u9897\uff1a \u00b6 \u6211\u76ee\u524d\u53bb\u7684\u79c1\u5229\u533b\u9662\u62d4\u7259\u7684, \u4e3a\u4ec0\u4e48\u4e0d\u53bb\u516c\u5386\u533b\u9662\u5462\uff1f \u56e0\u4e3a\u7ea6\u4e0d\u4e0a\u53f7\uff0c\u6574\u4e2a\u4f53\u9a8c\u4e0b\u6765\u8fd8\u662f\u6bd4\u8f83\u597d\u7684. \u9996\u5148\u62a4\u58eb\u5e26\u6211\u91cd\u65b0\u62cd\u4e86X\u7247\uff0c\u533b\u751f\u770b\u8fc7\u7247\u5b50\u4e4b\u540e\uff0c\u4f1a\u548c\u6211\u8bf4\u660e\u62d4\u7259\u4e4b\u540e\u4f1a\u6709\u4e00\u4e9b\u5c0f\u5f71\u54cd\u3002\u6211\u7684\u5de6\u4e0a\u4e94\u6328\u7740\u9f3b\u5b50\u6bd4\u8f83\u8fd1\uff0c\u533b\u751f\u5631\u5490\u6211\u4e0d\u8981\u54b3\u55fd\u548c\u6253\u54c8\u6b20\u3002 \u4f1a\u8ba9\u81ea\u5df1\u7b7e\u8ba2\u62d4\u7259\u7684\u98ce\u9669\u4e66 \u62d4\u7259\u7684\u65f6\u5019\u6253\u4e86\u9ebb\u836f\uff0c\u7a0d\u5fae\u7684\u6709\u4e00\u70b9\u75bc\uff0c\u4f46\u662f\u53ef\u4ee5\u5ffd\u7565\u3002\u6211\u7684\u662f\u5de6\u4e0a\u4e94\u662f\u77eb\u6b63\u7259\uff0c\u9700\u8981\u62d4\u6389\uff0c\u7531\u4e8e\u8fd9\u9897\u7259\u7684\u7259\u6839\u6bd4\u8f83\u957f\u3002\u62d4\u7259\u7684\u65f6\u5019\u8d39\u4e86\u4e0d\u5c11\u529f\u592b\u3002\u8fd8\u6709\u4e00\u9897\u662f\u5de6\u4e0b\u4e03\u6b8b\u6839\u3002\uff08\u8fd9\u9897\u7279\u522b\u7684\u7b80\u5355\uff09\uff0c\u62d4\u7259\u7684\u65f6\u5019\u5927\u592b\u548c\u62a4\u58eb\u8fd8\u662f\u6bd4\u8f83\u7ec6\u5fc3\u3002 \u4f1a\u65f6\u4e0d\u65f6\u7684\u5173\u6ce8\u6211\u7684\u60c5\u51b5\u3002\u6574\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u611f\u89c9\u81ea\u5df1\u90fd\u8981\u7761\u7740\u5566\u3002\u540e\u7eed\u7b2c\u4e8c\u5929\u6211\u4f1a\u5173\u6ce8\u6211\u62d4\u7259\u7684\u7259\u9f7f\u60c5\u51b5\u3002 \u62d4\u5b8c\u4e4b\u540e\uff0c\u4f1a\u8ba9\u54ac\u4e00\u4e2a\u68c9\u7403\u3002\u7b49\u5f8530\u5206\u949f\uff0c\u5927\u592b\u4f1a\u518d\u6b21\u68c0\u67e5\uff0c\u6ca1\u6709\u95ee\u9898\u5c31\u53ef\u4ee5\u8d70\u4e86 \u6ce8\u610f\u4e8b\u9879 \u00b6 \u5b89\u88c5\u7259\u5957\uff082024.9.8\uff09 \u00b6 \u4eca\u5929\u662f\u5b89\u88c5\u7259\u5957\u7684\u7b2c\u4e00\u5929\uff0c\u6211\u9a91\u7740\u6211\u7684\u5c0f\u7535\u8f66\u6765\u5230\u4e86\u53e3\u8154\u533b\u9662\uff0c\u5168\u7a0b\u5462\u6211\u6ca1\u6709\u7741\u773c\uff0c\u5012\u662f\u4e5f\u6ca1\u6709\u4e0d\u9002\u5e94\u7684\u611f\u89c9\uff0c\u5c31\u542c\u89c1\u533b\u9662\u62ff\u7740\u7535\u952f\u4e00\u76f4\u5728\u6211\u7684\u5634\u91cc\u78e8\u6211\u7684\u7259\u9f7f\u3002\u5927\u6982\u534a\u4e2a\u5c0f\u65f6\u591a\uff0c\u6211\u4eec\u7684\u7259\u5957\u5b89\u88c5\u597d\u4e86\u3002\u611f\u89c9\u7684\u5634\u5927\u4e86\u4e00\u5708\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u8fd8\u6ca1\u6709\u610f\u601d\u5230\u95ee\u9898\u7684\u4e25\u91cd\u6027\u3002 \u533b\u751f\u5631\u5490\u53ea\u80fd\u5403\u8f6f\u7684\u4e1c\u897f\uff0c\u592a\u786c\u7684\u4e0d\u8981\u5403\uff0c\u5bb9\u6613\u5427\u7259\u5957\u4e0a\u9762\u5360\u7684\u5f04\u6389\u4e0b\u6765\u3002\u533b\u751f\u8bf4\u8fd9\u4e2a1-3\u5929\u4f1a\u9178\u75bc\u8fc7\u4e86\u5c31\u597d\u4e86\u3002\u7136\u540e\u6211\u5c31\u56de\u53bb\u81ea\u5df1\u505a\u4e86\u4e2a\u9762\u5403\u3002\u7b2c\u4e00\u6b21\u771f\u7684\u4e0d\u4e60\u60ef\uff0c\u611f\u89c9\u600e\u4e48\u54ac\u90fd\u4e0d\u662f\u3002\u5403\u5b8c\uff0c\u7259\u5957\u4e0a\u8fd8\u6709\u6b8b\u7559\uff0c\u5c31\u5fc5\u987b\u52e4\u5237\u7259.\u8981\u6c42\u662f\u996d\u540e\u9700\u8981\u5237\u7259\u3002 \u51c6\u5907\u7684\u5237\u7259\u5de5\u5177 \u00b6 \u51b2\u7259\u5668\uff08\u6709\u4e00\u4e9b\u4e0d\u597d\u6e05\u7406\u7684\u98df\u7269\u6b8b\u6e23\u53ef\u4ee5\u7528\u51b2\u7259\u5668\u6765\u51b2\u6d17\u6389\uff0c\u6211\u5728B\u7ad9\u4e0a\u770b\u7684\u8d1d\u81f3\u7684\u51b2\u7259\u5668\uff09 \u7259\u5237 \u7259\u7ebf \u7b2c\u4e00\u5929 \u00b6 \u611f\u89c9\u5c31\u662f\u6211\u7684\u7259\u5df2\u7ecf\u4e0d\u662f\u6211\u7684\u7259\u4e86\uff0c\u5df2\u7ecf\u5b8c\u5168\u5931\u53bb\u4e86\u7259\u9f7f\u7684\u5480\u56bc\u529f\u80fd\u3002\uff08\u665a\u4e0a\u7761\u89c9\u90fd\u4e0d\u80fd\u5408\u5634\uff0c\u4f46\u51e1\u78b0\u5230\u90fd\u75bc\u7684\u4e0d\u884c\uff09 \u5403\u7a00\u996d\uff0c\u8363\u83b7\u300a\u6ca1\u4e8b\u627e\u4e8b\u79f0\u53f7\u300b\uff01 \u7b2c\u4e8c\u5929 \u00b6 \u6ca1\u6709\u7b2c\u4e00\u5929\u90a3\u4e48\u75bc\u4e86\uff0c\u4f46\u662f\u8fd8\u662f\u4e0d\u80fd\u5403\u4e1c\u897f\uff0c\u6574\u4e2a\u53e3\u8154\u91cc\u90fd\u662f\u9178\u75bc\u7684\u611f\u89c9\uff0c\u5c31\u50cf\u662f\u4e00\u5929\u8bad\u7ec3\u5b8c\uff0c\u7b2c\u4e8c\u5929\u808c\u8089\u75bc\u7684\u90a3\u79cd\u611f\u89c9\uff0c\u6bd5\u7adf\u662f\u5bb9\u94c1\u4e1d\u62c9\u3002\u808c\u8089\u53d7\u5230\u529b\u80af\u5b9a\u4f1a\u96be\u53d7\u3002 \u4e00\u5468\u540e \u00b6 \u8fc7\u4e86\u4e00\u5468\uff0c\u7ec8\u4e8e\u75c7\u72b6\u7b97\u662f\u51cf\u8f7b\u4e86\uff0c\u6700\u8d77\u7801\u53ef\u4ee5\u54ac\u52a8\u8089\u4e86\uff0c\u771f\u7684\u662f\u4e0d\u5bb9\u6613\uff0c\u6574\u7259\u7684\u52c7\u58eb\uff0c\u4e0b\u6b21\u4e0d\u60f3\u6574\u4e86\u3002 \u534a\u4e2a\u6708\u56fe\u540e \u00b6 \u7ecf\u8fc7\u4e86\u534a\u4e2a\u6708,\u75bc\u75db\u7f13\u89e3\u4e86\u5f88\u591a.\u4f46\u662f\u8fd8\u662f\u4f1a\u56e0\u4e3a\u4e2a\u522b\u7684\u7259,\u5bfc\u81f4\u75bc\u7684\u5403\u4e0d\u4e86\u996d.\u7531\u4e8e\u62d4\u7259\u4e4b\u540e\u4f1a\u7559\u4e0b\u5f88\u5927\u7684\u7259\u7f1d.\u8fd9\u4e2a\u5403\u786c\u7684\u98df\u7269\u4e5f\u4f1a\u5f88\u75bc. \u611f\u60f3 \u00b6 \u5e26\u4e86\u4e00\u5468\u7684\u7259\u5957\uff0c\u8bf4\u8bf4\u6211\u5e26\u4e0a\u7259\u5957\u7684\u7f3a\u70b9\u5427\u3002 \u9996\u5148\u662f\u5e26\u4e0a\u4e4b\u540e\u5403\u5b8c\u996d\u5fc5\u987b\u8981\u5237\u7259\uff0c\u4e0d\u5237\u7259\u4f60\u7684\u7259\u9f7f\u4e0a\u5c31\u4f1a\u6709\u5f88\u591a\u6b8b\u7559\uff0c\u800c\u4e14\u5f88\u96be\u6e05\u7406\u3002 \u5176\u6b21\u5403\u996d\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u73b0\u600e\u4e48\u5403\u5c31\u5f88\u522b\u626d\u3002 \u6709\u7684\u65f6\u5019\uff0c\u8fd8\u4f1a\u522e\u4f24\u4f60\u7684\u5634 \u518d\u8bf4\u8bf4\u4f18\u70b9\uff1a \u53d8\u76f8\u7684\u51cf\u80a5\uff1a\u56e0\u4e3a\u9700\u8981\u5403\u4e1c\u897f\u540e\u5237\u7259\uff0c\u6240\u4ee5\u5403\u4e1c\u897f\u7684\u9891\u7387\u4f1a\u51cf\u5c11\u3002 \u603b\u7684\u6765\u8bf4,\u6574\u7259\u662f\u4e00\u4ef6\u975e\u5e38\u75db\u82e6\u7684\u8fc7\u7a0b,\u5982\u679c\u7259\u9f7f\u4e0d\u9f50\u5efa\u8bae\u8fd8\u662f\u8981\u5728\u5c0f\u7684\u65f6\u5019\u6765\u505a\u7259\u9f7f\u77eb\u6b63.\u8fd9\u6837\u6211\u4eec\u751f\u957f\u53d1\u80b2\u7684\u8fc7\u7a0b\u4e2d\u4e5f\u4e0d\u4f1a\u803d\u8bef. \u79df\u623f\u88ab\u5751 \u00b6 \u54ce,\u8c08\u8d77\u8fd9\u4e2a\u4e8b\u60c5,\u6211\u5c31\u662f\u4e00\u809a\u5b50\u706b\u6c14,\u771f\u662f\u51fa\u6765\u793e\u4f1a\u7684\u7b2c\u4e00\u8bfe\u5c31\u662f\u9ed1\u4e2d\u4ecb\u7ed9\u4e0a\u7684. \u9ed1\u4e2d\u4ecb\u4fe1\u606f \u00b6 \u5730\u5740: \u5eb7\u8425\u5bb6\u56ed A \u5357\u533a \u4e2d\u4ecb\u516c\u53f8\u540d\u79f0: \u5317\u4eac\u7396\u6cf0\u4f4f\u623f\u79df\u8d41\u6709\u9650\u516c\u53f8 \u4e2d\u4ecb\u59d3\u540d: \u4e8e\u4e1c \u4e8b\u60c5\u7684\u7ecf\u8fc7\u662f\u6211\u901a\u8fc7\u54b8\u9c7c,\u627e\u4e86\u4e00\u4e2a\u4e25\u5fe0\u6d69\u4e2d\u4ecb\u6765\u5eb7\u8425\u5bb6\u56ed4 \u671f\u770b\u623f. \u770b\u4e2d\u4e86\u4e00\u5bb6A \u535710 \u53f7\u697c\u7684\u4e00\u4e2a\u4e3b\u5367,\u4ef7\u683c\u4e3a 1500/\u6708.\u5f53\u65f6\u6211\u5c31\u5728\u60f3\u4e3a\u5565\u73b0\u5728\u8fd9\u8fb9\u7684\u623f\u5b50\u8fd9\u4e48\u4fbf\u5b9c\u4e86,\u4e4b\u524d\u4e3b\u5367\u662f 1700-1800/\u6708.\u56e0\u4e3a\u6211\u4e4b\u524d\u4e5f\u5728\u8fd9\u4f4f\u7684\u5927\u6982\u7684\u4ef7\u683c\u6211\u4e5f\u4e86\u89e3.\u4e0a\u4e00\u4e2a\u4e2d\u4ecb\u5f53\u65f6\u8fd8\u548c\u6211\u8bf4\u8fd9\u9644\u8fd1\u7684\u9a97\u5b50\u5f88\u591a.\u8ba9\u6211\u5c0f\u5fc3\u4e00\u70b9.\u5f53\u65f6\u5176\u5b9e\u4ed6\u4eec\u7684\u4e2d\u4ecb\u4e5f\u7ed9\u6211\u627e\u4e86\u623f\u5b50,\u4f46\u662f\u6211\u6ca1\u6709\u76f8\u4e2d.\u540e\u6765\u95ee\u4e86\u4e00\u4e0b\u4e25\u5fe0\u6d69\u4ed6\u4eec\u516c\u53f8\u7684\u540d\u79f0.\u5728\u4f01\u67e5\u67e5\u4e0a\u67e5\u4e86\u4e00\u4e0b,\u4e5f\u6ca1\u6709\u4eba\u8d77\u8bc9,\u5f53\u65f6\u4e5f\u662f\u7740\u6025\u627e\u623f\u5b50\u5c31\u6ca1\u6709\u60f3\u7279\u522b\u591a.\u5c31\u548c\u4ed6\u4eec\u79df\u4e86\u4e0b\u6765.\u5f53\u65f6\u7b7e\u5408\u540c\u7684\u662f\u4e8e\u4e1c\u6765\u7b7e\u7684.\u540e\u6765\u5728\u8fd9\u4e2a\u79df\u4e86\u8fd1\u4e24\u4e2a\u6708,\u623f\u4e1c\u5c31\u8fc7\u6765\u8bf4\u6211\u4eec\u88ab\u9a97\u4e86\u4e2d\u4ecb\u8dd1\u8def\u4e86,\u73b0\u5728\u8fdd\u7ea6\u4e0d\u7ed9\u623f\u4e1c\u6253\u6b3e,\u6309\u7167\u5408\u7ea6\u623f\u4e1c\u6709\u6743\u5229\u6536\u56de\u623f\u5b50.\u8fd9\u4e2a\u65f6\u5019\u624d\u610f\u8bc6\u5230\u88ab\u9a97\u4e86,\u5f53\u65f6\u7684\u635f\u5931\u662f 1 \u4e2a\u6708\u623f\u79df 1 \u4e2a\u6708\u62bc\u91d1. \u8bc8\u9a97\u6c34\u8d39 \u00b6 \u5728\u8fd9\u91cc\u4f4f\u4e86\u4e00\u6bb5\u65f6\u95f4,\u8fd9\u4e2a\u9ed1\u4e2d\u4ecb\u4e8e\u4e1c,\u5c31\u7ed9\u6211\u6253\u7535\u8bdd\u8ba9\u6211\u4ea4\u6c34\u8d39(\u8d39\u7528\u4e3a200/\u5e74),\u4e0d\u63d0\u4f9b\u6c34\u5355,\u53d1\u7968.\u5c31\u8bf4\u4e00\u5e74 200. \u4e8e\u662f\u6211\u54a8\u8be2\u4e86\u7269\u4e1a,\u7269\u4e1a\u8bf4: \u6c34\u8d39\u5e76\u6ca1\u6709\u5f00\u59cb\u4ea4\u5462,\u5148\u8ba9\u7528\u7740,\u7b49\u4ea4\u7684\u65f6\u5019\u518d\u8bf4.\u5f53\u65f6\u6211\u5c31\u610f\u8bc6\u5230\u4e86\u4e0d\u5bf9\u52b2. \u8fd9\u9ed1\u4e2d\u4ecb\u5c31\u4f1a\u4e00\u76f4\u627e\u7406\u7531\u5ffd\u60a0,\u7ed3\u679c\u6211\u76f4\u63a5\u53bb\u6d3e\u51fa\u6240\u8981\u56de\u6765\u4e86. \u8fd9\u5c0f\u5b50\u8fd8\u7ed9\u6211\u72c2,\u53bb\u4e86\u6d3e\u51fa\u6240\u8001\u5b9e\u4e86(\u5f53\u65f6\u53bb\u4e86\u6d3e\u51fa\u6240\u5f88\u591a\u4eba,\u5e94\u8be5\u5c31\u6211\u8981\u56de\u6765 200)~ \u5f3a\u5236\u6572\u95e8 \u00b6 \u5f53\u65f6\u662f\u6211\u4e0d\u5728\u5bb6,\u6211\u7684\u90bb\u5c45\u4e5f\u4e0d\u5728,\u4e2d\u4ecb\u8fdb\u4e0d\u6765\u5c31\u628a\u5916\u95e8\u6572\u4e86.\u6211\u56de\u5230\u5bb6\u6709\u4e9b\u61f5\u903c(\u95e8\u628a\u624b\u6ca1\u4e86\u8fdb\u90fd\u8fdb\u4e0d\u53bb)~ \u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u64ad\u653e\u89c6\u9891\u3002 \u5f88\u96be\u60f3\u8c61\u8fd9\u662f\u57282024\u7684\u5317\u4eac,\u4ed6\u4eec\u7684\u8d1f\u8d23\u4eba\u8fd8\u8868\u793a\u8981\u94b1\u6ca1\u6709,\u53ef\u4ee5\u6253\u6b20\u6761,\u8ba9\u6211\u4eec\u53bb\u8d77\u8bc9....... \u4e0b\u9762\u8fd9\u4e2a\u4eba\u662f\u4ed6\u4eec\u7684\u8d1f\u8d23\u4eba.\u5728\u6d3e\u51fa\u6240\u4e5f\u662f\u6839\u672c\u4e0d\u8fd8\u94b1.(\u6700\u7ec8\u4e5f\u662f\u6ca1\u6709\u534f\u5546\u89e3\u51b3\u4e86\u8fd9\u4e2a\u4e8b\u60c5) \u5904\u7406\u7ed3\u679c \u00b6 \u6211\u5c1d\u8bd5\u7684\u65b9\u6848: \u6253\u4e86 12345,12315,\u5de5\u5546\u5c40,\u4f4f\u5efa\u59d4,110 (\u751a\u81f3\u597d\u591a\u4eba\u90fd\u53bb\u4e86\u6d3e\u51fa\u6240)\u90fd\u4ee5\u5931\u8d25\u544a\u7ec8~ \u5907\u7528\u65b9\u6848: \u6cd5\u9662\u8d77\u8bc9 \u5b98\u65b9\u901a\u544a \u00b6 \u4ee5\u4e0b\u662f\u6765\u81ea\u5eb7\u8425\u7fa4\u91cc\u7fa4\u53cb\u7684\u622a\u56fe. \u5b98\u65b9\u6587\u7ae0\u5730\u5740 \u603b\u7ed3\u7ecf\u9a8c \u00b6 \u5728\u5916\u79df\u623f\u4e00\u5b9a\u8981\u5c3d\u91cf\u548c\u623f\u4e1c\u7b7e\u8ba2\u5408\u540c,\u4e0d\u548c\u7b2c\u4e09\u65b9\u4e2d\u4ecb\u516c\u53f8\u7b7e.\u6216\u8005\u5c31\u627e\u6b63\u89c4\u7684\u5e73\u53f0. \u5982\u679c\u5b9e\u5728\u6ca1\u6709\u529e\u6cd5\u7684\u8bdd\u548c\u4e2d\u4ecb\u7b7e\u5408\u540c.\u80fd\u62bc\u4e00\u4ed8\u4e00\u5c31\u4e0d\u62bc\u4e00\u4ed8\u4e09,\u5c31\u7b97\u4ed6\u4eec\u6709\u8981\u6c42,\u4e5f\u53ef\u4ee5\u62d2\u7edd\u8ba9\u4f60\u635f\u5931\u66f4\u5c0f. \u5c3d\u91cf\u652f\u4ed8\u8d39\u7528\u7684\u65f6\u5019,\u9009\u62e9\u5e73\u53f0\u652f\u4ed8,\u4e0d\u4f7f\u7528\u5fae\u4fe1\u652f\u4ed8,\u4e0d\u7136\u4e0d\u597d\u7ef4\u6743. \u5728\u642c\u8fdb\u623f\u5b50\u4e4b\u524d,\u4e00\u5b9a\u8981\u5bf9\u623f\u5b50\u7684\u5168\u5c4b\u8fdb\u884c\u89c6\u9891\u7167\u7247\u8bb0\u5f55.\u4e0d\u7136\u623f\u4e1c\u6216\u4e2d\u4ecb\u4f1a\u4ee5\u5404\u79cd\u7406\u7531\u6765\u627e\u4f60\u7684\u9ebb\u70e6\u4e0d\u9000\u62bc\u91d1. \u6ca1\u6709\u5199\u5728\u5408\u540c\u91cc\u7684\u4efb\u4f55\u8d39\u7528\u90fd\u53ef\u4ee5\u65e0\u89c6,\u5982\u679c\u975e\u5f3a\u5236\u8ba9\u7f34\u7eb3\u53ef\u4ee5\u6295\u8bc9. \u7f8e\u98df\u7bc7 \u00b6 \u5904\u4e86\u5de5\u4f5c\u4e0a\u7684\u5b66\u4e60\uff0c\u751f\u6d3b\u4e0a\u7684\u5b66\u4e60\u4e5f\u4e0d\u80fd\u62c9\u4e0b\u3002\u6700\u8fd1\u4e00\u76f4\u5728\u505a\u8c46\u8c49\u9cae\u9c7c\uff0c\u7ec8\u4e8e\u7b97\u662f\u5c0f\u6709\u6240\u6210\u3002\uff08\u5176\u5b9e\u8fd9\u9053\u83dc\u5e76\u4e0d\u96be\uff0c\u5c31\u662f\u6211\u6709\u70b9\u7b28\u3002\u8001\u662f\u505a\u7684\u504f\u54b8\uff09 \u83dc\u54c1\u51c6\u5907 \u00b6 \u539f\u6750\u6599 \u00b6 \u8c46\u8c49\u9cae\u9c7c\u7f50\u5934 \uff08\u4e5f\u53ef\u4ee5\u7528\u9cab\u9c7c\u7b49\u4ee3\u66ff\uff09\uff1a\u7ea6500\u514b \u5927\u849c \uff1a4-5\u74e3 \u7ea2\u8fa3\u6912 \uff08\u53ef\u9009\uff09\uff1a1-2\u4e2a \u98df\u7528\u6cb9 \uff1a\u9002\u91cf \u751f\u62bd \uff1a1\u6c64\u5319 \u8001\u62bd \uff1a\u00bd\u6c64\u5319 \u76d0 \uff1a\u9002\u91cf \u505a\u6cd5\u6b65\u9aa4 \u00b6 \u9996\u5148\uff0c\u5c06\u4e70\u56de\u6765\u7684\u8c46\u8c49\u9cae\u9c7c\u7f50\u5934\u91cc\u7684\u9c7c\u523a\u505a\u4e00\u4e0b\u6e05\u7406\u3002\u867d\u7136\u5df2\u7ecf\u505a\u8fc7\u4e86\u5904\u7406\uff0c\u4f46\u662f\u4e3a\u4e86\u5403\u8fd9\u653e\u5fc3\uff0c\u6700\u597d\u628a\u9c7c\u523a\u7528\u5c0f\u5200\u5254\u9664\u3002 \u5176\u6b21\uff0c\u5c06\u4e70\u56de\u6765\u7684\u6cb9\u9ea6\u83dc\uff0c\u6e05\u6d17\u5e72\u51c0\u4e4b\u540e\uff0c\u5207\u6bb5\u5907\u7528\u3002\u653e\u5230\u76d8\u5b50\u4e2d\u7684\u65f6\u5019\u6839\u90e8\uff0c\u653e\u5728\u76d8\u5b50\u6700\u4e0a\u653e \u7136\u540e\uff0c\u5f00\u59cb\u8d77\u9505\u70e7\u6cb9\u3002\u6cb9\u70ed\u653e\u5165\u5927\u849c\u7247\u3002\u653e\u5165\u8c46\u8c49\u9cae\u9c7c\u7f50\u5934\uff08\u4e00\u534a\u5373\u53ef\uff0c\u5373\u4e00\u74f6\u7f50\u5934\u53ef\u4ee5\u505a\u4e24\u6b21\uff09\uff0c\u7ffb\u7092\u4e24\u4e0b\u5c31\u53ef\u4ee5\u653e\u5165\u6cb9\u9ea6\u83dc\u3002 \u6cb9\u9ea6\u83dc\u8fd9\u4e2a\u65f6\u5019\u6839\u90e8\u5c31\u5728\u9505\u5e95\uff0c\u53f6\u5b50\u5c31\u662f\u4e0a\u9762\u3002\u76d6\u4e0a\u9505\u76d61-3\u5206\u949f\uff0c\u5c0f\u706b\u3002\u5728\u8fd9\u4e00\u5230\u4e09\u5206\u949f\u653e\u5165\u751f\u62bd\uff0c\u869d\u6cb9\u3002\u7b49\u5f85\u51fa\u9505\u5373\u53ef\u3002 \u56fe\u793a \u00b6 \u540e\u7eed\u83dc\u54c1\u7b49\u5f85\u5b66\u4e60\u901a\u8fc7\u4e4b\u540e\uff0c\u5206\u4eab\uff5e","title":"\u6211\u76842024"},{"location":"20.mylife/2024-life-docs/#_1","text":"\u751f\u6d3b\u89c4\u5212 \u5b58\u94b1\u8ba1\u5212: \u5e74\u524d\u7684\u65f6\u5019\u548c\u6211\u7684\u597d\u54e5\u4eec\u963f\u519b\u5403\u4e86\u4e2a\u996d\uff0c\u4ece\u4ed6\u90a3\u5f97\u77e5\u4e86\u4ed6\u7684\u5b58\u6b3e\uff0c\u624d\u77e5\u9053\u8fd9\u4e24\u5e74\u6709\u70b9\u5927\u624b\u5927\u811a\u4e86\uff0c\u9700\u8981\u5b66\u4e60\u4e00\u4e0b\u4ed6\u7684\u5b58\u94b1\u3002\u5bf9\u672a\u6765\u7684\u4e0d\u786e\u5b9a\u6709\u4e00\u4e2a\u4fdd\u969c\u3002 \u6574\u7259\u8ba1\u5212\u5217\u5165\u5b89\u6392 \u5b66\u4e60\u89c4\u5212","title":"\u89c4\u5212"},{"location":"20.mylife/2024-life-docs/#_2","text":"\u7531\u4e8e\u5c0f\u65f6\u5019\uff0c\u7236\u6bcd\u5728\u519c\u6c11\u6ca1\u6709\u5bf9\u6211\u7684\u53e3\u8154\u95ee\u9898\u7279\u522b\u7684\u91cd\u89c6\uff0c\u5bfc\u81f4\u6211\u73b0\u5728\u9700\u8981\u8fdb\u884c\u6574\u7259\u3002\u5c06\u7259\u6536\u56de\u3002","title":"\u6b63\u7578\u7ecf\u5386"},{"location":"20.mylife/2024-life-docs/#_3","text":"\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u6211\u5148\u53bb\u4e86\u5317\u5927\u53e3\u8154\u7b2c\u4e8c\u95e8\u8bca\u90e8\uff0c\u4e86\u89e3\u4e00\u4e0b\u6574\u7259\u7684\u5927\u6982\u6d41\u7a0b\u53ef\u4ee5\u82b1\u8d39\u3002\uff08\u4ee5\u4e0b\u662f\u5317\u5927\u53e3\u8154\u7684\u6cbb\u7597\u8d39\u7528\uff09 \u5317\u4eac\u5927\u5b66\u53e3\u8154\u533b\u9662\u6b63\u7578\u521d\u8bca\u60a3\u8005\u5c31\u8bca\u6d41\u7a0b \u7b2c\u4e00\u6b21\u5c31\u8bca\uff1a \u54a8\u8be2\uff08\u4e86\u89e3\u6b63\u7578\u6cbb\u7597\u65b9\u5f0f\u3001\u7597\u7a0b\u3001\u5927\u81f4\u8d39\u7528\u7b49\uff09\u5982\u4f55\u786e\u5b9a\u5f00\u59cb\u6b63\u7578\u6cbb\u7597 \u9886\u53d6\u9a8c\u8840\u9879\u76ee\u8981\u6c42 2. \u786e\u5b9a\u533b\u751f\u51fa\u8bca\u65f6\u95f4 \u8bf7\u81f3\u4e8c\u7532\uff08\u542b\uff09\u4ee5\u4e0a\u7efc\u5408\u533b\u9662\u7a7a\u8179\u5316\u9a8c\uff0c\u9879\u76ee\u8981\u6c42\u5982\u4e0b\uff1a \u6210\u5e74\u4eba\u9879\u76ee\u8981\u6c42\uff1a \u4e59\u809d\u8868\u9762\u6297\u539f \u4e19\u809d\u6297\u539f\u6216\u6297\u4f53 \u6885\u6bd2 \u6297HIV \u6885\u6bd2 \u672a\u6210\u5e74\u4eba\u9879\u76ee\u8981\u6c42\uff1a \u4e59\u809d\u8868\u9762\u6297\u539f \u4e19\u809d\u6297\u539f\u6216\u6297\u4f53 \u6885\u6bd2 \u7b2c\u4e8c\u6b21\u5c31\u8bca\uff1a \u643a\u5e26\u7eb8\u8d28\u7248\u5316\u9a8c\u7ed3\u679c\uff08\u7ed3\u679c\u6709\u6548\u671f\u4e3a\u4e09\u4e2a\u6708\uff09\uff0c\u91c7\u96c6\u53e3\u8154\u8d44\u6599\uff08\u7259\u79d1\u6a21\u578b\u3001X\u7ebf\u7b49\u8d44\u6599\uff09\uff08\u907f\u514d\u559d\u5496\u5561\uff09\u8d39\u7528\uff1a1500 \u7b2c\u4e09\u6b21\u5c31\u8bca\uff1a \u8bbe\u8ba1\u5e76\u6c9f\u901a\u6b63\u7578\u6cbb\u7597\u65b9\u6848\uff08\u672a\u6210\u5e74\u4eba\u9700\u76d1\u62a4\u4eba\u966a\u540c\uff09 \u8d39\u7528: 2500 \u7b2c\u56db\u6b21\u5c31\u8bca\uff1a \u6234\u671f\u77eb\u6cbb\u5668\uff08\u672a\u6210\u5e74\u4eba\u9700\u76d1\u62a4\u4eba\u966a\u540c\u5c31\u8bca\uff09\u8d39\u7528: 10500 \u7136\u540e\u5e94\u8be5\u662f\u6bcf\u5e747000 * 3 \u4ee5\u4e0a\u7684\u56fe\u662f\u5218\u5927\u592b\u7ed9\u6211\u7684\uff0c\u8fd9\u8fb9\u4e3b\u8981\u662f\u5217\u4e3e\u4e86\u4e00\u4e9b\u8d39\u7528\u7684\u95ee\u9898\u3002","title":"\u5317\u5927\u53e3\u8154\u7b2c\u4e8c\u95e8\u8bca"},{"location":"20.mylife/2024-life-docs/#_4","text":"\u4ee5\u4e0b\u6211\u5728\u52b2\u677e\u53e3\u8154\u83b7\u53d6\u7684\u5927\u6982\u6700\u7ec8\u6574\u7259\u4ef7\u683c\uff0c\u6700\u540e\u780d\u4ef7\u5230\u4e863w\uff0c\u7531\u9648\u5a07\u9662\u957f\u6765\u505a\u6b63\u7578\u3002\u603b\u7684\u6765\u8bf4\u6211\u8fd8\u662f\u8003\u8651\u53bb\u4e86\u79c1\u5229\u533b\u9662\u3002\u4e5f\u4e0d\u662f\u8bf4\u516c\u5386\u4e0d\u597d\uff0c \u7b2c\u4e00\u7684\u8ddd\u79bb\u7684\u95ee\u9898\uff0c\u6709\u4e00\u4e9b\u8fdc \u7b2c\u4e8c\u662f\u8d39\u7528\u95ee\u9898\u8d85\u51fa\u4e86\u6211\u7684\u9884\u671f\u5f88\u591a \u7b2c\u4e09\u6302\u53f7\u96be\uff0c\u8fd9\u4e2a\u8fd8\u662f\u95e8\u8bca\u8fd8\u4e0d\u662f\u603b\u9662\u3002 \u4e5f\u4e86\u89e3\u5230\uff0c\u5927\u6539\u7684\u65b9\u6848\u662f\u5dee\u4e0d\u591a\u7684\uff0c\u90fd\u9700\u8981\u62d4\u56db\u9897\u7259\uff5e\u3002 \u57fa\u4e8e\u4ee5\u4e0a\u7684\u8003\u8651\uff0c\u627e\u5230\u4e86\u8fd9\u4e2a\u79c1\u5229\u533b\u9662\u3002\u8fd9\u4e2a\u9662\u957f\u4e5f\u662f\u5317\u5927\u53e3\u8154\u51fa\u6765\u7684\u3002\u60f3\u4e86\u60f3\u5c31\u5728\u8fd9\u8fb9\u6574\u7259\u4e5f\u662f\u53ef\u4ee5\u7684\u3002 \u4e0b\u9762\u7684\u4e24\u5f20\u56fe\u4e5f\u80fd\u770b\u7684\u51fa\u6765\uff0c\u5916\u51f8\u6709\u70b9\u4e25\u91cd\uff0c\u6211\u7279\u610f\u95ee\u4e86\u533b\u751f\u3002\u8bf4\u6211\u8fd9\u4e2a\u6574\u7259\u7684\u96be\u5ea6\u5c5e\u4e8e\u54ea\u4e00\u7ea7\u522b\u3002\u4e24\u4e2a\u533b\u751f\u90fd\u8bf4\u7684\u4e2d\u7b49\u3002 \u6574\u7259\u4e00\u76f4\u662f\u53c2\u52a0\u5de5\u4f5c\u4e4b\u540e\u7684\u8981\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u6709\u4e9b\u4e8b\u60c5\u8fd8\u662f\u9700\u8981\u81ea\u5df1\u6765\u505a\u51b3\u7b56\u3002\u4e5f\u662f\u5e0c\u671b\u53ef\u4ee5\u6700\u7ec8\u5c06\u7259\u9f7f\u6574\u7684\u5f88\u597d\u3002\u6211\u4e5f\u6bd4\u8f83\u671f\u5f85\u3002","title":"\u52b2\u677e\u53e3\u8154"},{"location":"20.mylife/2024-life-docs/#_5","text":"\u6211\u4e00\u5171\u9700\u8981\u62d4\u56db\u9897\u7259\uff0c\u4e24\u9897\u6b63\u7578\u7259\uff0c\u4e24\u9897\u574f\u7259\u3002","title":"\u62d4\u7259\u7ecf\u5386"},{"location":"20.mylife/2024-life-docs/#_6","text":"\u6211\u76ee\u524d\u53bb\u7684\u79c1\u5229\u533b\u9662\u62d4\u7259\u7684, \u4e3a\u4ec0\u4e48\u4e0d\u53bb\u516c\u5386\u533b\u9662\u5462\uff1f \u56e0\u4e3a\u7ea6\u4e0d\u4e0a\u53f7\uff0c\u6574\u4e2a\u4f53\u9a8c\u4e0b\u6765\u8fd8\u662f\u6bd4\u8f83\u597d\u7684. \u9996\u5148\u62a4\u58eb\u5e26\u6211\u91cd\u65b0\u62cd\u4e86X\u7247\uff0c\u533b\u751f\u770b\u8fc7\u7247\u5b50\u4e4b\u540e\uff0c\u4f1a\u548c\u6211\u8bf4\u660e\u62d4\u7259\u4e4b\u540e\u4f1a\u6709\u4e00\u4e9b\u5c0f\u5f71\u54cd\u3002\u6211\u7684\u5de6\u4e0a\u4e94\u6328\u7740\u9f3b\u5b50\u6bd4\u8f83\u8fd1\uff0c\u533b\u751f\u5631\u5490\u6211\u4e0d\u8981\u54b3\u55fd\u548c\u6253\u54c8\u6b20\u3002 \u4f1a\u8ba9\u81ea\u5df1\u7b7e\u8ba2\u62d4\u7259\u7684\u98ce\u9669\u4e66 \u62d4\u7259\u7684\u65f6\u5019\u6253\u4e86\u9ebb\u836f\uff0c\u7a0d\u5fae\u7684\u6709\u4e00\u70b9\u75bc\uff0c\u4f46\u662f\u53ef\u4ee5\u5ffd\u7565\u3002\u6211\u7684\u662f\u5de6\u4e0a\u4e94\u662f\u77eb\u6b63\u7259\uff0c\u9700\u8981\u62d4\u6389\uff0c\u7531\u4e8e\u8fd9\u9897\u7259\u7684\u7259\u6839\u6bd4\u8f83\u957f\u3002\u62d4\u7259\u7684\u65f6\u5019\u8d39\u4e86\u4e0d\u5c11\u529f\u592b\u3002\u8fd8\u6709\u4e00\u9897\u662f\u5de6\u4e0b\u4e03\u6b8b\u6839\u3002\uff08\u8fd9\u9897\u7279\u522b\u7684\u7b80\u5355\uff09\uff0c\u62d4\u7259\u7684\u65f6\u5019\u5927\u592b\u548c\u62a4\u58eb\u8fd8\u662f\u6bd4\u8f83\u7ec6\u5fc3\u3002 \u4f1a\u65f6\u4e0d\u65f6\u7684\u5173\u6ce8\u6211\u7684\u60c5\u51b5\u3002\u6574\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u611f\u89c9\u81ea\u5df1\u90fd\u8981\u7761\u7740\u5566\u3002\u540e\u7eed\u7b2c\u4e8c\u5929\u6211\u4f1a\u5173\u6ce8\u6211\u62d4\u7259\u7684\u7259\u9f7f\u60c5\u51b5\u3002 \u62d4\u5b8c\u4e4b\u540e\uff0c\u4f1a\u8ba9\u54ac\u4e00\u4e2a\u68c9\u7403\u3002\u7b49\u5f8530\u5206\u949f\uff0c\u5927\u592b\u4f1a\u518d\u6b21\u68c0\u67e5\uff0c\u6ca1\u6709\u95ee\u9898\u5c31\u53ef\u4ee5\u8d70\u4e86","title":"\u5de6\u4fa7\u524d\u4e24\u9897\uff1a"},{"location":"20.mylife/2024-life-docs/#_7","text":"","title":"\u6ce8\u610f\u4e8b\u9879"},{"location":"20.mylife/2024-life-docs/#202498","text":"\u4eca\u5929\u662f\u5b89\u88c5\u7259\u5957\u7684\u7b2c\u4e00\u5929\uff0c\u6211\u9a91\u7740\u6211\u7684\u5c0f\u7535\u8f66\u6765\u5230\u4e86\u53e3\u8154\u533b\u9662\uff0c\u5168\u7a0b\u5462\u6211\u6ca1\u6709\u7741\u773c\uff0c\u5012\u662f\u4e5f\u6ca1\u6709\u4e0d\u9002\u5e94\u7684\u611f\u89c9\uff0c\u5c31\u542c\u89c1\u533b\u9662\u62ff\u7740\u7535\u952f\u4e00\u76f4\u5728\u6211\u7684\u5634\u91cc\u78e8\u6211\u7684\u7259\u9f7f\u3002\u5927\u6982\u534a\u4e2a\u5c0f\u65f6\u591a\uff0c\u6211\u4eec\u7684\u7259\u5957\u5b89\u88c5\u597d\u4e86\u3002\u611f\u89c9\u7684\u5634\u5927\u4e86\u4e00\u5708\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u8fd8\u6ca1\u6709\u610f\u601d\u5230\u95ee\u9898\u7684\u4e25\u91cd\u6027\u3002 \u533b\u751f\u5631\u5490\u53ea\u80fd\u5403\u8f6f\u7684\u4e1c\u897f\uff0c\u592a\u786c\u7684\u4e0d\u8981\u5403\uff0c\u5bb9\u6613\u5427\u7259\u5957\u4e0a\u9762\u5360\u7684\u5f04\u6389\u4e0b\u6765\u3002\u533b\u751f\u8bf4\u8fd9\u4e2a1-3\u5929\u4f1a\u9178\u75bc\u8fc7\u4e86\u5c31\u597d\u4e86\u3002\u7136\u540e\u6211\u5c31\u56de\u53bb\u81ea\u5df1\u505a\u4e86\u4e2a\u9762\u5403\u3002\u7b2c\u4e00\u6b21\u771f\u7684\u4e0d\u4e60\u60ef\uff0c\u611f\u89c9\u600e\u4e48\u54ac\u90fd\u4e0d\u662f\u3002\u5403\u5b8c\uff0c\u7259\u5957\u4e0a\u8fd8\u6709\u6b8b\u7559\uff0c\u5c31\u5fc5\u987b\u52e4\u5237\u7259.\u8981\u6c42\u662f\u996d\u540e\u9700\u8981\u5237\u7259\u3002","title":"\u5b89\u88c5\u7259\u5957\uff082024.9.8\uff09"},{"location":"20.mylife/2024-life-docs/#_8","text":"\u51b2\u7259\u5668\uff08\u6709\u4e00\u4e9b\u4e0d\u597d\u6e05\u7406\u7684\u98df\u7269\u6b8b\u6e23\u53ef\u4ee5\u7528\u51b2\u7259\u5668\u6765\u51b2\u6d17\u6389\uff0c\u6211\u5728B\u7ad9\u4e0a\u770b\u7684\u8d1d\u81f3\u7684\u51b2\u7259\u5668\uff09 \u7259\u5237 \u7259\u7ebf","title":"\u51c6\u5907\u7684\u5237\u7259\u5de5\u5177"},{"location":"20.mylife/2024-life-docs/#_9","text":"\u611f\u89c9\u5c31\u662f\u6211\u7684\u7259\u5df2\u7ecf\u4e0d\u662f\u6211\u7684\u7259\u4e86\uff0c\u5df2\u7ecf\u5b8c\u5168\u5931\u53bb\u4e86\u7259\u9f7f\u7684\u5480\u56bc\u529f\u80fd\u3002\uff08\u665a\u4e0a\u7761\u89c9\u90fd\u4e0d\u80fd\u5408\u5634\uff0c\u4f46\u51e1\u78b0\u5230\u90fd\u75bc\u7684\u4e0d\u884c\uff09 \u5403\u7a00\u996d\uff0c\u8363\u83b7\u300a\u6ca1\u4e8b\u627e\u4e8b\u79f0\u53f7\u300b\uff01","title":"\u7b2c\u4e00\u5929"},{"location":"20.mylife/2024-life-docs/#_10","text":"\u6ca1\u6709\u7b2c\u4e00\u5929\u90a3\u4e48\u75bc\u4e86\uff0c\u4f46\u662f\u8fd8\u662f\u4e0d\u80fd\u5403\u4e1c\u897f\uff0c\u6574\u4e2a\u53e3\u8154\u91cc\u90fd\u662f\u9178\u75bc\u7684\u611f\u89c9\uff0c\u5c31\u50cf\u662f\u4e00\u5929\u8bad\u7ec3\u5b8c\uff0c\u7b2c\u4e8c\u5929\u808c\u8089\u75bc\u7684\u90a3\u79cd\u611f\u89c9\uff0c\u6bd5\u7adf\u662f\u5bb9\u94c1\u4e1d\u62c9\u3002\u808c\u8089\u53d7\u5230\u529b\u80af\u5b9a\u4f1a\u96be\u53d7\u3002","title":"\u7b2c\u4e8c\u5929"},{"location":"20.mylife/2024-life-docs/#_11","text":"\u8fc7\u4e86\u4e00\u5468\uff0c\u7ec8\u4e8e\u75c7\u72b6\u7b97\u662f\u51cf\u8f7b\u4e86\uff0c\u6700\u8d77\u7801\u53ef\u4ee5\u54ac\u52a8\u8089\u4e86\uff0c\u771f\u7684\u662f\u4e0d\u5bb9\u6613\uff0c\u6574\u7259\u7684\u52c7\u58eb\uff0c\u4e0b\u6b21\u4e0d\u60f3\u6574\u4e86\u3002","title":"\u4e00\u5468\u540e"},{"location":"20.mylife/2024-life-docs/#_12","text":"\u7ecf\u8fc7\u4e86\u534a\u4e2a\u6708,\u75bc\u75db\u7f13\u89e3\u4e86\u5f88\u591a.\u4f46\u662f\u8fd8\u662f\u4f1a\u56e0\u4e3a\u4e2a\u522b\u7684\u7259,\u5bfc\u81f4\u75bc\u7684\u5403\u4e0d\u4e86\u996d.\u7531\u4e8e\u62d4\u7259\u4e4b\u540e\u4f1a\u7559\u4e0b\u5f88\u5927\u7684\u7259\u7f1d.\u8fd9\u4e2a\u5403\u786c\u7684\u98df\u7269\u4e5f\u4f1a\u5f88\u75bc.","title":"\u534a\u4e2a\u6708\u56fe\u540e"},{"location":"20.mylife/2024-life-docs/#_13","text":"\u5e26\u4e86\u4e00\u5468\u7684\u7259\u5957\uff0c\u8bf4\u8bf4\u6211\u5e26\u4e0a\u7259\u5957\u7684\u7f3a\u70b9\u5427\u3002 \u9996\u5148\u662f\u5e26\u4e0a\u4e4b\u540e\u5403\u5b8c\u996d\u5fc5\u987b\u8981\u5237\u7259\uff0c\u4e0d\u5237\u7259\u4f60\u7684\u7259\u9f7f\u4e0a\u5c31\u4f1a\u6709\u5f88\u591a\u6b8b\u7559\uff0c\u800c\u4e14\u5f88\u96be\u6e05\u7406\u3002 \u5176\u6b21\u5403\u996d\u7684\u65f6\u5019\uff0c\u4f1a\u53d1\u73b0\u600e\u4e48\u5403\u5c31\u5f88\u522b\u626d\u3002 \u6709\u7684\u65f6\u5019\uff0c\u8fd8\u4f1a\u522e\u4f24\u4f60\u7684\u5634 \u518d\u8bf4\u8bf4\u4f18\u70b9\uff1a \u53d8\u76f8\u7684\u51cf\u80a5\uff1a\u56e0\u4e3a\u9700\u8981\u5403\u4e1c\u897f\u540e\u5237\u7259\uff0c\u6240\u4ee5\u5403\u4e1c\u897f\u7684\u9891\u7387\u4f1a\u51cf\u5c11\u3002 \u603b\u7684\u6765\u8bf4,\u6574\u7259\u662f\u4e00\u4ef6\u975e\u5e38\u75db\u82e6\u7684\u8fc7\u7a0b,\u5982\u679c\u7259\u9f7f\u4e0d\u9f50\u5efa\u8bae\u8fd8\u662f\u8981\u5728\u5c0f\u7684\u65f6\u5019\u6765\u505a\u7259\u9f7f\u77eb\u6b63.\u8fd9\u6837\u6211\u4eec\u751f\u957f\u53d1\u80b2\u7684\u8fc7\u7a0b\u4e2d\u4e5f\u4e0d\u4f1a\u803d\u8bef.","title":"\u611f\u60f3"},{"location":"20.mylife/2024-life-docs/#_14","text":"\u54ce,\u8c08\u8d77\u8fd9\u4e2a\u4e8b\u60c5,\u6211\u5c31\u662f\u4e00\u809a\u5b50\u706b\u6c14,\u771f\u662f\u51fa\u6765\u793e\u4f1a\u7684\u7b2c\u4e00\u8bfe\u5c31\u662f\u9ed1\u4e2d\u4ecb\u7ed9\u4e0a\u7684.","title":"\u79df\u623f\u88ab\u5751"},{"location":"20.mylife/2024-life-docs/#_15","text":"\u5730\u5740: \u5eb7\u8425\u5bb6\u56ed A \u5357\u533a \u4e2d\u4ecb\u516c\u53f8\u540d\u79f0: \u5317\u4eac\u7396\u6cf0\u4f4f\u623f\u79df\u8d41\u6709\u9650\u516c\u53f8 \u4e2d\u4ecb\u59d3\u540d: \u4e8e\u4e1c \u4e8b\u60c5\u7684\u7ecf\u8fc7\u662f\u6211\u901a\u8fc7\u54b8\u9c7c,\u627e\u4e86\u4e00\u4e2a\u4e25\u5fe0\u6d69\u4e2d\u4ecb\u6765\u5eb7\u8425\u5bb6\u56ed4 \u671f\u770b\u623f. \u770b\u4e2d\u4e86\u4e00\u5bb6A \u535710 \u53f7\u697c\u7684\u4e00\u4e2a\u4e3b\u5367,\u4ef7\u683c\u4e3a 1500/\u6708.\u5f53\u65f6\u6211\u5c31\u5728\u60f3\u4e3a\u5565\u73b0\u5728\u8fd9\u8fb9\u7684\u623f\u5b50\u8fd9\u4e48\u4fbf\u5b9c\u4e86,\u4e4b\u524d\u4e3b\u5367\u662f 1700-1800/\u6708.\u56e0\u4e3a\u6211\u4e4b\u524d\u4e5f\u5728\u8fd9\u4f4f\u7684\u5927\u6982\u7684\u4ef7\u683c\u6211\u4e5f\u4e86\u89e3.\u4e0a\u4e00\u4e2a\u4e2d\u4ecb\u5f53\u65f6\u8fd8\u548c\u6211\u8bf4\u8fd9\u9644\u8fd1\u7684\u9a97\u5b50\u5f88\u591a.\u8ba9\u6211\u5c0f\u5fc3\u4e00\u70b9.\u5f53\u65f6\u5176\u5b9e\u4ed6\u4eec\u7684\u4e2d\u4ecb\u4e5f\u7ed9\u6211\u627e\u4e86\u623f\u5b50,\u4f46\u662f\u6211\u6ca1\u6709\u76f8\u4e2d.\u540e\u6765\u95ee\u4e86\u4e00\u4e0b\u4e25\u5fe0\u6d69\u4ed6\u4eec\u516c\u53f8\u7684\u540d\u79f0.\u5728\u4f01\u67e5\u67e5\u4e0a\u67e5\u4e86\u4e00\u4e0b,\u4e5f\u6ca1\u6709\u4eba\u8d77\u8bc9,\u5f53\u65f6\u4e5f\u662f\u7740\u6025\u627e\u623f\u5b50\u5c31\u6ca1\u6709\u60f3\u7279\u522b\u591a.\u5c31\u548c\u4ed6\u4eec\u79df\u4e86\u4e0b\u6765.\u5f53\u65f6\u7b7e\u5408\u540c\u7684\u662f\u4e8e\u4e1c\u6765\u7b7e\u7684.\u540e\u6765\u5728\u8fd9\u4e2a\u79df\u4e86\u8fd1\u4e24\u4e2a\u6708,\u623f\u4e1c\u5c31\u8fc7\u6765\u8bf4\u6211\u4eec\u88ab\u9a97\u4e86\u4e2d\u4ecb\u8dd1\u8def\u4e86,\u73b0\u5728\u8fdd\u7ea6\u4e0d\u7ed9\u623f\u4e1c\u6253\u6b3e,\u6309\u7167\u5408\u7ea6\u623f\u4e1c\u6709\u6743\u5229\u6536\u56de\u623f\u5b50.\u8fd9\u4e2a\u65f6\u5019\u624d\u610f\u8bc6\u5230\u88ab\u9a97\u4e86,\u5f53\u65f6\u7684\u635f\u5931\u662f 1 \u4e2a\u6708\u623f\u79df 1 \u4e2a\u6708\u62bc\u91d1.","title":"\u9ed1\u4e2d\u4ecb\u4fe1\u606f"},{"location":"20.mylife/2024-life-docs/#_16","text":"\u5728\u8fd9\u91cc\u4f4f\u4e86\u4e00\u6bb5\u65f6\u95f4,\u8fd9\u4e2a\u9ed1\u4e2d\u4ecb\u4e8e\u4e1c,\u5c31\u7ed9\u6211\u6253\u7535\u8bdd\u8ba9\u6211\u4ea4\u6c34\u8d39(\u8d39\u7528\u4e3a200/\u5e74),\u4e0d\u63d0\u4f9b\u6c34\u5355,\u53d1\u7968.\u5c31\u8bf4\u4e00\u5e74 200. \u4e8e\u662f\u6211\u54a8\u8be2\u4e86\u7269\u4e1a,\u7269\u4e1a\u8bf4: \u6c34\u8d39\u5e76\u6ca1\u6709\u5f00\u59cb\u4ea4\u5462,\u5148\u8ba9\u7528\u7740,\u7b49\u4ea4\u7684\u65f6\u5019\u518d\u8bf4.\u5f53\u65f6\u6211\u5c31\u610f\u8bc6\u5230\u4e86\u4e0d\u5bf9\u52b2. \u8fd9\u9ed1\u4e2d\u4ecb\u5c31\u4f1a\u4e00\u76f4\u627e\u7406\u7531\u5ffd\u60a0,\u7ed3\u679c\u6211\u76f4\u63a5\u53bb\u6d3e\u51fa\u6240\u8981\u56de\u6765\u4e86. \u8fd9\u5c0f\u5b50\u8fd8\u7ed9\u6211\u72c2,\u53bb\u4e86\u6d3e\u51fa\u6240\u8001\u5b9e\u4e86(\u5f53\u65f6\u53bb\u4e86\u6d3e\u51fa\u6240\u5f88\u591a\u4eba,\u5e94\u8be5\u5c31\u6211\u8981\u56de\u6765 200)~","title":"\u8bc8\u9a97\u6c34\u8d39"},{"location":"20.mylife/2024-life-docs/#_17","text":"\u5f53\u65f6\u662f\u6211\u4e0d\u5728\u5bb6,\u6211\u7684\u90bb\u5c45\u4e5f\u4e0d\u5728,\u4e2d\u4ecb\u8fdb\u4e0d\u6765\u5c31\u628a\u5916\u95e8\u6572\u4e86.\u6211\u56de\u5230\u5bb6\u6709\u4e9b\u61f5\u903c(\u95e8\u628a\u624b\u6ca1\u4e86\u8fdb\u90fd\u8fdb\u4e0d\u53bb)~ \u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u64ad\u653e\u89c6\u9891\u3002 \u5f88\u96be\u60f3\u8c61\u8fd9\u662f\u57282024\u7684\u5317\u4eac,\u4ed6\u4eec\u7684\u8d1f\u8d23\u4eba\u8fd8\u8868\u793a\u8981\u94b1\u6ca1\u6709,\u53ef\u4ee5\u6253\u6b20\u6761,\u8ba9\u6211\u4eec\u53bb\u8d77\u8bc9....... \u4e0b\u9762\u8fd9\u4e2a\u4eba\u662f\u4ed6\u4eec\u7684\u8d1f\u8d23\u4eba.\u5728\u6d3e\u51fa\u6240\u4e5f\u662f\u6839\u672c\u4e0d\u8fd8\u94b1.(\u6700\u7ec8\u4e5f\u662f\u6ca1\u6709\u534f\u5546\u89e3\u51b3\u4e86\u8fd9\u4e2a\u4e8b\u60c5)","title":"\u5f3a\u5236\u6572\u95e8"},{"location":"20.mylife/2024-life-docs/#_18","text":"\u6211\u5c1d\u8bd5\u7684\u65b9\u6848: \u6253\u4e86 12345,12315,\u5de5\u5546\u5c40,\u4f4f\u5efa\u59d4,110 (\u751a\u81f3\u597d\u591a\u4eba\u90fd\u53bb\u4e86\u6d3e\u51fa\u6240)\u90fd\u4ee5\u5931\u8d25\u544a\u7ec8~ \u5907\u7528\u65b9\u6848: \u6cd5\u9662\u8d77\u8bc9","title":"\u5904\u7406\u7ed3\u679c"},{"location":"20.mylife/2024-life-docs/#_19","text":"\u4ee5\u4e0b\u662f\u6765\u81ea\u5eb7\u8425\u7fa4\u91cc\u7fa4\u53cb\u7684\u622a\u56fe. \u5b98\u65b9\u6587\u7ae0\u5730\u5740","title":"\u5b98\u65b9\u901a\u544a"},{"location":"20.mylife/2024-life-docs/#_20","text":"\u5728\u5916\u79df\u623f\u4e00\u5b9a\u8981\u5c3d\u91cf\u548c\u623f\u4e1c\u7b7e\u8ba2\u5408\u540c,\u4e0d\u548c\u7b2c\u4e09\u65b9\u4e2d\u4ecb\u516c\u53f8\u7b7e.\u6216\u8005\u5c31\u627e\u6b63\u89c4\u7684\u5e73\u53f0. \u5982\u679c\u5b9e\u5728\u6ca1\u6709\u529e\u6cd5\u7684\u8bdd\u548c\u4e2d\u4ecb\u7b7e\u5408\u540c.\u80fd\u62bc\u4e00\u4ed8\u4e00\u5c31\u4e0d\u62bc\u4e00\u4ed8\u4e09,\u5c31\u7b97\u4ed6\u4eec\u6709\u8981\u6c42,\u4e5f\u53ef\u4ee5\u62d2\u7edd\u8ba9\u4f60\u635f\u5931\u66f4\u5c0f. \u5c3d\u91cf\u652f\u4ed8\u8d39\u7528\u7684\u65f6\u5019,\u9009\u62e9\u5e73\u53f0\u652f\u4ed8,\u4e0d\u4f7f\u7528\u5fae\u4fe1\u652f\u4ed8,\u4e0d\u7136\u4e0d\u597d\u7ef4\u6743. \u5728\u642c\u8fdb\u623f\u5b50\u4e4b\u524d,\u4e00\u5b9a\u8981\u5bf9\u623f\u5b50\u7684\u5168\u5c4b\u8fdb\u884c\u89c6\u9891\u7167\u7247\u8bb0\u5f55.\u4e0d\u7136\u623f\u4e1c\u6216\u4e2d\u4ecb\u4f1a\u4ee5\u5404\u79cd\u7406\u7531\u6765\u627e\u4f60\u7684\u9ebb\u70e6\u4e0d\u9000\u62bc\u91d1. \u6ca1\u6709\u5199\u5728\u5408\u540c\u91cc\u7684\u4efb\u4f55\u8d39\u7528\u90fd\u53ef\u4ee5\u65e0\u89c6,\u5982\u679c\u975e\u5f3a\u5236\u8ba9\u7f34\u7eb3\u53ef\u4ee5\u6295\u8bc9.","title":"\u603b\u7ed3\u7ecf\u9a8c"},{"location":"20.mylife/2024-life-docs/#_21","text":"\u5904\u4e86\u5de5\u4f5c\u4e0a\u7684\u5b66\u4e60\uff0c\u751f\u6d3b\u4e0a\u7684\u5b66\u4e60\u4e5f\u4e0d\u80fd\u62c9\u4e0b\u3002\u6700\u8fd1\u4e00\u76f4\u5728\u505a\u8c46\u8c49\u9cae\u9c7c\uff0c\u7ec8\u4e8e\u7b97\u662f\u5c0f\u6709\u6240\u6210\u3002\uff08\u5176\u5b9e\u8fd9\u9053\u83dc\u5e76\u4e0d\u96be\uff0c\u5c31\u662f\u6211\u6709\u70b9\u7b28\u3002\u8001\u662f\u505a\u7684\u504f\u54b8\uff09","title":"\u7f8e\u98df\u7bc7"},{"location":"20.mylife/2024-life-docs/#_22","text":"","title":"\u83dc\u54c1\u51c6\u5907"},{"location":"20.mylife/2024-life-docs/#_23","text":"\u8c46\u8c49\u9cae\u9c7c\u7f50\u5934 \uff08\u4e5f\u53ef\u4ee5\u7528\u9cab\u9c7c\u7b49\u4ee3\u66ff\uff09\uff1a\u7ea6500\u514b \u5927\u849c \uff1a4-5\u74e3 \u7ea2\u8fa3\u6912 \uff08\u53ef\u9009\uff09\uff1a1-2\u4e2a \u98df\u7528\u6cb9 \uff1a\u9002\u91cf \u751f\u62bd \uff1a1\u6c64\u5319 \u8001\u62bd \uff1a\u00bd\u6c64\u5319 \u76d0 \uff1a\u9002\u91cf","title":"\u539f\u6750\u6599"},{"location":"20.mylife/2024-life-docs/#_24","text":"\u9996\u5148\uff0c\u5c06\u4e70\u56de\u6765\u7684\u8c46\u8c49\u9cae\u9c7c\u7f50\u5934\u91cc\u7684\u9c7c\u523a\u505a\u4e00\u4e0b\u6e05\u7406\u3002\u867d\u7136\u5df2\u7ecf\u505a\u8fc7\u4e86\u5904\u7406\uff0c\u4f46\u662f\u4e3a\u4e86\u5403\u8fd9\u653e\u5fc3\uff0c\u6700\u597d\u628a\u9c7c\u523a\u7528\u5c0f\u5200\u5254\u9664\u3002 \u5176\u6b21\uff0c\u5c06\u4e70\u56de\u6765\u7684\u6cb9\u9ea6\u83dc\uff0c\u6e05\u6d17\u5e72\u51c0\u4e4b\u540e\uff0c\u5207\u6bb5\u5907\u7528\u3002\u653e\u5230\u76d8\u5b50\u4e2d\u7684\u65f6\u5019\u6839\u90e8\uff0c\u653e\u5728\u76d8\u5b50\u6700\u4e0a\u653e \u7136\u540e\uff0c\u5f00\u59cb\u8d77\u9505\u70e7\u6cb9\u3002\u6cb9\u70ed\u653e\u5165\u5927\u849c\u7247\u3002\u653e\u5165\u8c46\u8c49\u9cae\u9c7c\u7f50\u5934\uff08\u4e00\u534a\u5373\u53ef\uff0c\u5373\u4e00\u74f6\u7f50\u5934\u53ef\u4ee5\u505a\u4e24\u6b21\uff09\uff0c\u7ffb\u7092\u4e24\u4e0b\u5c31\u53ef\u4ee5\u653e\u5165\u6cb9\u9ea6\u83dc\u3002 \u6cb9\u9ea6\u83dc\u8fd9\u4e2a\u65f6\u5019\u6839\u90e8\u5c31\u5728\u9505\u5e95\uff0c\u53f6\u5b50\u5c31\u662f\u4e0a\u9762\u3002\u76d6\u4e0a\u9505\u76d61-3\u5206\u949f\uff0c\u5c0f\u706b\u3002\u5728\u8fd9\u4e00\u5230\u4e09\u5206\u949f\u653e\u5165\u751f\u62bd\uff0c\u869d\u6cb9\u3002\u7b49\u5f85\u51fa\u9505\u5373\u53ef\u3002","title":"\u505a\u6cd5\u6b65\u9aa4"},{"location":"20.mylife/2024-life-docs/#_25","text":"\u540e\u7eed\u83dc\u54c1\u7b49\u5f85\u5b66\u4e60\u901a\u8fc7\u4e4b\u540e\uff0c\u5206\u4eab\uff5e","title":"\u56fe\u793a"},{"location":"3.k8s/2024-9-19-k8s-update/","text":"k8s \u7248\u672c\u5347\u7ea7 \u00b6 \u6ce8\u610f \u5347\u7ea7k8s\u96c6\u7fa4\u5fc5\u987b \u5148\u5347\u7ea7kubeadm\u7248\u672c\u5230\u2f6c\u7684k8s\u7248\u672c\uff0c\u4e5f\u5c31\u662f\u8bf4kubeadm\u662fk8s\u5347\u7ea7\u7684\u51c6\u5347\u8bc1\u3002 Kubernetes \u6dfb\u52a0\u6e05\u534e\u6e90 \u00b6 \u6e29\u99a8\u63d0\u793a \u00b6 https://mirrors.tuna.tsinghua.edu.cn/help/kubernetes/ \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u6e05\u534e\u7684\u6e90\uff0c\u963f\u91cc\u4e91\u7684\u6e90\u5bf9\u4e8ekubeadm \u7684\u5305\u4e0d\u9f50\u5168 1.\u9996\u5148\u5bfc\u5165 gpg key\uff1a curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg 2.\u65b0\u5efa /etc/apt/sources.list.d/kubernetes.list \uff0c\u5185\u5bb9\u4e3a deb [ signed-by = /etc/apt/keyrings/kubernetes-apt-keyring.gpg ] http://mirrors.tuna.tsinghua.edu.cn/kubernetes/core:/stable:/v1.26/deb/ / 3.\u66f4\u65b0 apt apt update Master\u5b89\u88c5\u6307\u5b9a\u65b0\u7248\u672ckubeadm \u00b6 # kubeadm config images list --config kubeadm.yaml # kubeadm config images pull --config kubeadm.yaml kubeadm config images list --kubernetes-version v1.26.15 kubeadm config images pull --config kubeadm.yaml kubeadm config images list --config kubeadm.yaml $ apt-cache madison kubeadm # \u67e5\u770bk8s\u7248\u672c\u5217\u8868 $ apt-cache policy kubeadm | grep 1.26. # \u67e5\u770bk8s\u7248\u672c\u5217\u8868 $ apt-get install kubeadm=1.26.15-1.1 $ kubeadm version # \u9a8c\u8bc1kubeadm \u7248\u672c $ kubeadm upgrade plan # \u9a8c\u8bc1\u5347\u7ea7\u8ba1\u5212 $ kubeadm upgrade apply v1.26.15 # \u5347\u7ea7 \u5347\u7ea7K8s node\u8282\u70b9\u7248\u672c: \u00b6 $ apt-cache policy kubelet $ kubeadm upgrade node $ apt update && apt install kubelet=1.26.15-1.1 kubectl=1.26.15-1.1 $ systemctl restart kubelet \u6587\u7ae0\u53c2\u8003 \u00b6 https://k8s.huweihuang.com/project/etcd/etcdctl/etcdctl-v3","title":"kubernetes \u96c6\u7fa4\u5347\u7ea7"},{"location":"3.k8s/2024-9-19-k8s-update/#k8s","text":"\u6ce8\u610f \u5347\u7ea7k8s\u96c6\u7fa4\u5fc5\u987b \u5148\u5347\u7ea7kubeadm\u7248\u672c\u5230\u2f6c\u7684k8s\u7248\u672c\uff0c\u4e5f\u5c31\u662f\u8bf4kubeadm\u662fk8s\u5347\u7ea7\u7684\u51c6\u5347\u8bc1\u3002","title":"k8s \u7248\u672c\u5347\u7ea7"},{"location":"3.k8s/2024-9-19-k8s-update/#kubernetes","text":"","title":"Kubernetes \u6dfb\u52a0\u6e05\u534e\u6e90"},{"location":"3.k8s/2024-9-19-k8s-update/#_1","text":"https://mirrors.tuna.tsinghua.edu.cn/help/kubernetes/ \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u6e05\u534e\u7684\u6e90\uff0c\u963f\u91cc\u4e91\u7684\u6e90\u5bf9\u4e8ekubeadm \u7684\u5305\u4e0d\u9f50\u5168 1.\u9996\u5148\u5bfc\u5165 gpg key\uff1a curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg 2.\u65b0\u5efa /etc/apt/sources.list.d/kubernetes.list \uff0c\u5185\u5bb9\u4e3a deb [ signed-by = /etc/apt/keyrings/kubernetes-apt-keyring.gpg ] http://mirrors.tuna.tsinghua.edu.cn/kubernetes/core:/stable:/v1.26/deb/ / 3.\u66f4\u65b0 apt apt update","title":"\u6e29\u99a8\u63d0\u793a"},{"location":"3.k8s/2024-9-19-k8s-update/#masterkubeadm","text":"# kubeadm config images list --config kubeadm.yaml # kubeadm config images pull --config kubeadm.yaml kubeadm config images list --kubernetes-version v1.26.15 kubeadm config images pull --config kubeadm.yaml kubeadm config images list --config kubeadm.yaml $ apt-cache madison kubeadm # \u67e5\u770bk8s\u7248\u672c\u5217\u8868 $ apt-cache policy kubeadm | grep 1.26. # \u67e5\u770bk8s\u7248\u672c\u5217\u8868 $ apt-get install kubeadm=1.26.15-1.1 $ kubeadm version # \u9a8c\u8bc1kubeadm \u7248\u672c $ kubeadm upgrade plan # \u9a8c\u8bc1\u5347\u7ea7\u8ba1\u5212 $ kubeadm upgrade apply v1.26.15 # \u5347\u7ea7","title":"Master\u5b89\u88c5\u6307\u5b9a\u65b0\u7248\u672ckubeadm"},{"location":"3.k8s/2024-9-19-k8s-update/#k8s-node","text":"$ apt-cache policy kubelet $ kubeadm upgrade node $ apt update && apt install kubelet=1.26.15-1.1 kubectl=1.26.15-1.1 $ systemctl restart kubelet","title":"\u5347\u7ea7K8s node\u8282\u70b9\u7248\u672c:"},{"location":"3.k8s/2024-9-19-k8s-update/#_2","text":"https://k8s.huweihuang.com/project/etcd/etcdctl/etcdctl-v3","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"3.k8s/2024-9-24-helmfile-docs/","text":"Helmfile \u00b6 \u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86 Helm \u7684\u4f7f\u7528\uff0c\u4f46\u5728\u5b9e\u9645\u4f7f\u7528\u573a\u666f\u4e2d\u7684\u4e00\u4e9b\u9700\u6c42 Helm \u5e76\u4e0d\u80fd\u5f88\u597d\u7684\u6ee1\u8db3\uff0c\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u4fee\u6539\u548c\u9002\u914d\uff0c\u6bd4\u5982\u5f53\u6211\u4eec\u9700\u8981\u540c\u65f6\u90e8\u7f72\u591a\u4e2a chart\u3001\u4e0d\u540c\u90e8\u7f72\u73af\u5883\u7684\u533a\u5206\u4ee5\u53ca chart \u7684\u7248\u672c\u63a7\u5236\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a Helmfile \u7684\u5de5\u5177\u6765\u89e3\u51b3\u8fd9\u4e9b\u573a\u666f\u7684\u95ee\u9898\u3002 Helmfile \u662f\u4e00\u4e2a\u58f0\u660e\u5f0f Helm Chart \u7ba1\u7406\u5de5\u5177\uff0c\u901a\u8fc7\u4e00\u4e2a helmfile.yaml \u6587\u4ef6\u6765\u5e2e\u52a9\u7528\u6237\u7ba1\u7406\u548c\u7ef4\u62a4\u4f17\u591a\u7684 Helm Chat\uff0c\u5176\u6700\u4e3b\u8981\u4f5c\u7528\u662f\uff1a \u96c6\u6210\u5728 CI/CD \u7cfb\u7edf\u4e2d\uff0c\u63d0\u9ad8\u90e8\u7f72\u7684\u53ef\u89c2\u6d4b\u6027\u548c\u53ef\u91cd\u590d\u6027\uff0c\u533a\u5206\u73af\u5883\uff0c\u514d\u53bb\u5404\u79cd --set \u9020\u6210\u7684\u56f0\u6270\u3002 \u65b9\u4fbf\u5bf9 helm chart \u8fdb\u884c\u7248\u672c\u63a7\u5236\uff0c\u5982\u6307\u5b9a\u7248\u672c\u8303\u56f4\u3001\u9501\u5b9a\u7248\u672c\u7b49\u3002 \u5b9a\u671f\u540c\u6b65\uff0c\u907f\u514d\u73af\u5883\u4e2d\u51fa\u73b0\u4e0d\u7b26\u5408\u9884\u671f\u7684\u914d\u7f6e\u3002 Helmfile \u7684\u4e3b\u8981\u7279\u70b9\u6709\uff1a \u58f0\u660e\u5f0f\uff1a\u7f16\u5199\u3001\u7248\u672c\u63a7\u5236\u3001\u5e94\u7528\u6240\u9700\u7684\u72b6\u6001\u6587\u4ef6\u4ee5\u5b9e\u73b0\u53ef\u89c1\u6027\u548c\u53ef\u518d\u73b0\u6027\u3002 \u6a21\u5757\uff1a\u5c06\u57fa\u7840\u67b6\u6784\u7684\u901a\u7528\u6a21\u5f0f\u6a21\u5757\u5316\uff0c\u901a\u8fc7 Git\u3001S3 \u7b49\u8fdb\u884c\u5206\u53d1\uff0c\u4ee5\u4fbf\u5728\u6574\u4e2a\u516c\u53f8\u590d\u7528\u3002 \u591a\u529f\u80fd\u6027\uff1a\u7ba1\u7406\u7531 charts\u3001kustomizations \u548c Kubernetes \u8d44\u6e90\u76ee\u5f55\u7ec4\u6210\u7684\u96c6\u7fa4\uff0c\u5c06\u6240\u6709\u5185\u5bb9\u8f6c\u6362\u4e3a Helm releases\u3002 Patch\uff1aJSON/Strategic-Merge \u5728 helm \u5b89\u88c5\u4e4b\u524d patch Kubernetes \u8d44\u6e90\uff0c\u65e0\u9700\u5206\u53c9\u4e0a\u6e38 charts\u3002 \u5b89\u88c5 \u00b6 helmfile \u63d0\u4f9b\u4e86\u591a\u79cd\u5b89\u88c5\u65b9\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 release \u9875\u9762 https://github.com/helmfile/helmfile/ \u9009\u62e9\u5408\u9002\u7684\u5305\u4e0b\u8f7d\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u662f Mac m1 \u73af\u5883\u5c31\u9009\u62e9 darwin_arm64 \u7684\u5305\uff1a $ wget https://github.com/helmfile/helmfile/releases/download/v0.168.0/helmfile_0.168.0_linux_arm64.tar.gz $ tar -xvf helmfile_0.168.0_linux_arm64.tar.gz $ chmod +x helmfile && sudo mv helmfile /usr/local/bin $ helmfile version (csg/infra) \ud83c\udf34 OPENBAYES_ENV: () \ud83d\udceb KUBECONFIG: (), file () >>> HELM_DIFF_USE_UPGRADE_DRY_RUN=true helmfile version \u2593\u2593\u2593 helmfile Version 0.166.0 Git Commit 655e1f9 Build Date 26 Jun 24 21:33 CST (2 months ago) Commit Date 26 Jun 24 15:40 CST (2 months ago) Dirty Build no Go version 1.22.4 Compiler gc Platform darwin/arm64 \u2502 A new release is available: 0.166.0 \u2192 v0.168.0 \u5b89\u88c5\u4e00\u4e9b\u63d2\u4ef6 $ helmfile -v (bj-k8s/default) (base) # beiyiwangdejiyi @ beiyiwangdejiyideMacBook-Pro in ~/Desktop/tools/Helm-tools on git:main x [10:55:35] C:130 $ helmfile init (bj-k8s/default) helm version is too low, the current version is 3.12.2+g1e210a2, the required version is 3.14.4 use: 'https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3' [y/n]: y Downloading https://get.helm.sh/helm-v3.15.2-darwin-arm64.tar.gz Verifying checksum... Done. Preparing to install helm into /usr/local/bin helm installed into /usr/local/bin/helm The helm plugin \"diff\" version is too low, do you want to update it? [y/n]: y Update helm plugin diff Downloading https://github.com/databus23/helm-diff/releases/latest/download/helm-diff-macos-arm64.tgz Preparing to install into /Users/beiyiwangdejiyi/Library/helm/plugins/helm-diff Updated plugin: diff The helm plugin \"secrets\" is not installed, do you want to install it? [y/n]: y Install helm plugin secrets Installed plugin: secrets The helm plugin \"s3\" is not installed, do you want to install it? [y/n]: y Install helm plugin s3 Downloading and installing helm-s3 v0.16.0 ... Checksum is valid. Installed plugin: s3 The helm plugin \"helm-git\" is not installed, do you want to install it? [y/n]: y Install helm plugin helm-git Installed plugin: helm-git helmfile initialization completed! \u5982\u679c\u6ca1\u6709\u6267\u884c init \u547d\u4ee4\u5219\u9700\u8981\u624b\u52a8\u5b89\u88c5 helm-diff \u63d2\u4ef6\uff0c\u8be5\u63d2\u4ef6\u662f\u5fc5\u987b\u7684\uff0c\u5176\u4ed6\u63d2\u4ef6\u53ef\u4ee5\u6839\u636e\u9700\u8981\u9009\u62e9\u5b89\u88c5 $ helm plugin install https://github.com/databus23/helm-diff \u4f7f\u7528 \u00b6 \u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b Helmfile \u7684\u5177\u4f53\u4f7f\u7528\uff0c\u9996\u5148\u6211\u4eec\u4ece\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u5f00\u59cb\uff0c\u5047\u8bbe helmfile.yaml \u8868\u793a\u4f60\u7684 Helm release \u7684\u671f\u671b\u72b6\u6001\u5982\u4e0b\u6240\u793a\uff1a # helmfile.yaml repositories: - name: prometheus-community url: https://prometheus-community.github.io/helm-charts releases: - name: prom-norbac-ubuntu namespace: prometheus chart: prometheus-community/prometheus set: - name: rbac.create value: false \u6587\u7ae0\u53c2\u8003 \u00b6 Helmfile \u5b98\u65b9\u6587\u6863","title":"kubernetes Helmfile \u6587\u4ef6"},{"location":"3.k8s/2024-9-24-helmfile-docs/#helmfile","text":"\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86 Helm \u7684\u4f7f\u7528\uff0c\u4f46\u5728\u5b9e\u9645\u4f7f\u7528\u573a\u666f\u4e2d\u7684\u4e00\u4e9b\u9700\u6c42 Helm \u5e76\u4e0d\u80fd\u5f88\u597d\u7684\u6ee1\u8db3\uff0c\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u4fee\u6539\u548c\u9002\u914d\uff0c\u6bd4\u5982\u5f53\u6211\u4eec\u9700\u8981\u540c\u65f6\u90e8\u7f72\u591a\u4e2a chart\u3001\u4e0d\u540c\u90e8\u7f72\u73af\u5883\u7684\u533a\u5206\u4ee5\u53ca chart \u7684\u7248\u672c\u63a7\u5236\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a Helmfile \u7684\u5de5\u5177\u6765\u89e3\u51b3\u8fd9\u4e9b\u573a\u666f\u7684\u95ee\u9898\u3002 Helmfile \u662f\u4e00\u4e2a\u58f0\u660e\u5f0f Helm Chart \u7ba1\u7406\u5de5\u5177\uff0c\u901a\u8fc7\u4e00\u4e2a helmfile.yaml \u6587\u4ef6\u6765\u5e2e\u52a9\u7528\u6237\u7ba1\u7406\u548c\u7ef4\u62a4\u4f17\u591a\u7684 Helm Chat\uff0c\u5176\u6700\u4e3b\u8981\u4f5c\u7528\u662f\uff1a \u96c6\u6210\u5728 CI/CD \u7cfb\u7edf\u4e2d\uff0c\u63d0\u9ad8\u90e8\u7f72\u7684\u53ef\u89c2\u6d4b\u6027\u548c\u53ef\u91cd\u590d\u6027\uff0c\u533a\u5206\u73af\u5883\uff0c\u514d\u53bb\u5404\u79cd --set \u9020\u6210\u7684\u56f0\u6270\u3002 \u65b9\u4fbf\u5bf9 helm chart \u8fdb\u884c\u7248\u672c\u63a7\u5236\uff0c\u5982\u6307\u5b9a\u7248\u672c\u8303\u56f4\u3001\u9501\u5b9a\u7248\u672c\u7b49\u3002 \u5b9a\u671f\u540c\u6b65\uff0c\u907f\u514d\u73af\u5883\u4e2d\u51fa\u73b0\u4e0d\u7b26\u5408\u9884\u671f\u7684\u914d\u7f6e\u3002 Helmfile \u7684\u4e3b\u8981\u7279\u70b9\u6709\uff1a \u58f0\u660e\u5f0f\uff1a\u7f16\u5199\u3001\u7248\u672c\u63a7\u5236\u3001\u5e94\u7528\u6240\u9700\u7684\u72b6\u6001\u6587\u4ef6\u4ee5\u5b9e\u73b0\u53ef\u89c1\u6027\u548c\u53ef\u518d\u73b0\u6027\u3002 \u6a21\u5757\uff1a\u5c06\u57fa\u7840\u67b6\u6784\u7684\u901a\u7528\u6a21\u5f0f\u6a21\u5757\u5316\uff0c\u901a\u8fc7 Git\u3001S3 \u7b49\u8fdb\u884c\u5206\u53d1\uff0c\u4ee5\u4fbf\u5728\u6574\u4e2a\u516c\u53f8\u590d\u7528\u3002 \u591a\u529f\u80fd\u6027\uff1a\u7ba1\u7406\u7531 charts\u3001kustomizations \u548c Kubernetes \u8d44\u6e90\u76ee\u5f55\u7ec4\u6210\u7684\u96c6\u7fa4\uff0c\u5c06\u6240\u6709\u5185\u5bb9\u8f6c\u6362\u4e3a Helm releases\u3002 Patch\uff1aJSON/Strategic-Merge \u5728 helm \u5b89\u88c5\u4e4b\u524d patch Kubernetes \u8d44\u6e90\uff0c\u65e0\u9700\u5206\u53c9\u4e0a\u6e38 charts\u3002","title":"Helmfile"},{"location":"3.k8s/2024-9-24-helmfile-docs/#_1","text":"helmfile \u63d0\u4f9b\u4e86\u591a\u79cd\u5b89\u88c5\u65b9\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 release \u9875\u9762 https://github.com/helmfile/helmfile/ \u9009\u62e9\u5408\u9002\u7684\u5305\u4e0b\u8f7d\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u662f Mac m1 \u73af\u5883\u5c31\u9009\u62e9 darwin_arm64 \u7684\u5305\uff1a $ wget https://github.com/helmfile/helmfile/releases/download/v0.168.0/helmfile_0.168.0_linux_arm64.tar.gz $ tar -xvf helmfile_0.168.0_linux_arm64.tar.gz $ chmod +x helmfile && sudo mv helmfile /usr/local/bin $ helmfile version (csg/infra) \ud83c\udf34 OPENBAYES_ENV: () \ud83d\udceb KUBECONFIG: (), file () >>> HELM_DIFF_USE_UPGRADE_DRY_RUN=true helmfile version \u2593\u2593\u2593 helmfile Version 0.166.0 Git Commit 655e1f9 Build Date 26 Jun 24 21:33 CST (2 months ago) Commit Date 26 Jun 24 15:40 CST (2 months ago) Dirty Build no Go version 1.22.4 Compiler gc Platform darwin/arm64 \u2502 A new release is available: 0.166.0 \u2192 v0.168.0 \u5b89\u88c5\u4e00\u4e9b\u63d2\u4ef6 $ helmfile -v (bj-k8s/default) (base) # beiyiwangdejiyi @ beiyiwangdejiyideMacBook-Pro in ~/Desktop/tools/Helm-tools on git:main x [10:55:35] C:130 $ helmfile init (bj-k8s/default) helm version is too low, the current version is 3.12.2+g1e210a2, the required version is 3.14.4 use: 'https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3' [y/n]: y Downloading https://get.helm.sh/helm-v3.15.2-darwin-arm64.tar.gz Verifying checksum... Done. Preparing to install helm into /usr/local/bin helm installed into /usr/local/bin/helm The helm plugin \"diff\" version is too low, do you want to update it? [y/n]: y Update helm plugin diff Downloading https://github.com/databus23/helm-diff/releases/latest/download/helm-diff-macos-arm64.tgz Preparing to install into /Users/beiyiwangdejiyi/Library/helm/plugins/helm-diff Updated plugin: diff The helm plugin \"secrets\" is not installed, do you want to install it? [y/n]: y Install helm plugin secrets Installed plugin: secrets The helm plugin \"s3\" is not installed, do you want to install it? [y/n]: y Install helm plugin s3 Downloading and installing helm-s3 v0.16.0 ... Checksum is valid. Installed plugin: s3 The helm plugin \"helm-git\" is not installed, do you want to install it? [y/n]: y Install helm plugin helm-git Installed plugin: helm-git helmfile initialization completed! \u5982\u679c\u6ca1\u6709\u6267\u884c init \u547d\u4ee4\u5219\u9700\u8981\u624b\u52a8\u5b89\u88c5 helm-diff \u63d2\u4ef6\uff0c\u8be5\u63d2\u4ef6\u662f\u5fc5\u987b\u7684\uff0c\u5176\u4ed6\u63d2\u4ef6\u53ef\u4ee5\u6839\u636e\u9700\u8981\u9009\u62e9\u5b89\u88c5 $ helm plugin install https://github.com/databus23/helm-diff","title":"\u5b89\u88c5"},{"location":"3.k8s/2024-9-24-helmfile-docs/#_2","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b Helmfile \u7684\u5177\u4f53\u4f7f\u7528\uff0c\u9996\u5148\u6211\u4eec\u4ece\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u5f00\u59cb\uff0c\u5047\u8bbe helmfile.yaml \u8868\u793a\u4f60\u7684 Helm release \u7684\u671f\u671b\u72b6\u6001\u5982\u4e0b\u6240\u793a\uff1a # helmfile.yaml repositories: - name: prometheus-community url: https://prometheus-community.github.io/helm-charts releases: - name: prom-norbac-ubuntu namespace: prometheus chart: prometheus-community/prometheus set: - name: rbac.create value: false","title":"\u4f7f\u7528"},{"location":"3.k8s/2024-9-24-helmfile-docs/#_3","text":"Helmfile \u5b98\u65b9\u6587\u6863","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"3.k8s/3-k8s-systeminit-docs/","text":"k8s\u96c6\u7fa4\u90e8\u7f72 \u00b6 kubeadm \u521b\u5efa\u96c6\u7fa4 \u00b6 \u6ce8\u610f\u4ee5\u4e0b\u662fcentos\u642d\u5efa \u96c6\u7fa4\u521d\u59cb\u5316 \u00b6 # \u5c06 SELinux \u8bbe\u7f6e\u4e3a permissive \u6a21\u5f0f\uff08\u76f8\u5f53\u4e8e\u5c06\u5176\u7981\u7528\uff09 sudo setenforce 0 sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config #\u5173\u95edswap swapoff -a sed -ri 's/.*swap.*/#&/' /etc/fstab #\u5141\u8bb8 iptables \u68c0\u67e5\u6865\u63a5\u6d41\u91cf cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf br_netfilter EOF cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sudo sysctl --system \u5b89\u88c5kubelet\u3001kubeadm\u3001kubectl cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg exclude=kubelet kubeadm kubectl EOF sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes = kubernetes # \u6240\u6709\u8282\u70b9 sudo systemctl enable --now kubelet \u963f\u91cc\u4e91\u955c\u50cf\u5730\u5740: https://developer.aliyun.com/mirror/kubernetes/ \u6e29\u99a8\u63d0\u793a kubelet \u73b0\u5728\u6bcf\u9694\u51e0\u79d2\u5c31\u4f1a\u91cd\u542f\uff0c\u56e0\u4e3a\u5b83\u9677\u5165\u4e86\u4e00\u4e2a\u7b49\u5f85 kubeadm \u6307\u4ee4\u7684\u6b7b\u5faa\u73af \u67e5\u770bkubeadm\u7684\u7248\u672c\uff0c\u5e76\u62c9\u53d6\u8be5\u7248\u672c\u7684images kubeadm config images list --kubernetes-version v1.20.9 > k8s.images root@ubuntu:/home/ubuntu/script# cat k8s.images |awk -F'/' '{print $2}' kube-apiserver:v1.20.9 kube-controller-manager:v1.20.9 kube-scheduler:v1.20.9 kube-proxy:v1.20.9 pause:3.2 etcd:3.4.13-0 coredns:1.7.0 \u811a\u672c\u4e0b\u8f7d\u955c\u50cf root@ubuntu:/home/ubuntu/script# cat ubuntu-k8s-images.sh #!/bin/bash images=' kube-apiserver:v1.20.9 kube-controller-manager:v1.20.9 kube-scheduler:v1.20.9 kube-proxy:v1.20.9 pause:3.2 etcd:3.4.13-0 coredns:1.7.0 ' for i in $images ; do docker pull registry.aliyuncs.com/google_containers/$i done \u521d\u59cb\u5316master\u8282\u70b9\uff1a #\u6240\u6709\u673a\u5668\u6dfb\u52a0master\u57df\u540d\u6620\u5c04\uff0c\u4ee5\u4e0b\u9700\u8981\u4fee\u6539\u4e3a\u81ea\u5df1\u7684 echo \"192.168.8.70 cluster-endpoint\" >> /etc/hosts # \u4e3b\u8282\u70b9\u521d\u59cb\u5316 kubeadm init \\ --apiserver-advertise-address=192.168.159.201 \\ --control-plane-endpoint=cluster-endpoint \\ --image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \\ --kubernetes-version v1.20.9 \\ --service-cidr=10.96.0.0/16 \\ --pod-network-cidr=172.16.0.0/16 #\u6240\u6709\u7f51\u7edc\u8303\u56f4\u4e0d\u91cd\u53e0 \u8282\u70b9\u521d\u59cb\u5316 \u00b6 Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.1.11:6443 --token bv4kei.ozbuoivuj8jxaa6q \\ --discovery-token-ca-cert-hash sha256:e37c82f136192e54480555eeaa2a102cec8b630f18b5fffd0e24c1d1c0c8f730 \u521d\u59cb\u5316\u53d1\u73b0\u6240\u6709\u72b6\u6001\u90fd\u662f NotReady \u5b89\u88c5\u7f51\u7edc\u7ec4\u4ef6: calico Node\u8282\u70b9\u52a0\u5165\u96c6\u7fa4 \u00b6 Warning \u65b0\u4ee4\u724c,\u9ed8\u8ba4\u7684\u4ee4\u724c24\u5c0f\u65f6\u5019\u5931\u6548 kubeadm token create --print-join-command \u5982\u679c\u57281.24\u4e4b\u540e\u7684k8s\u7248\u672c\u4f7f\u7528docker\uff0c\u9700\u8981\u6307\u5b9a--cri-socket=/run/cri-dockerd.sock Mac\u8fde\u63a5\u96c6\u7fa4\u62a5\u9519 \u00b6 Mac \u8fde\u63a5k8s\u96c6\u7fa4\u62a5\u9519 x509: certificate signed by unknown authority \u521b\u5efa\u96c6\u7fa4\u7684\u65f6\u5019\u6ca1\u6709\u6267\u884c\u5916\u7f51\u5730\u5740.\u5bfc\u81f4\u8bc1\u4e66\u4e0d\u80fd\u6b63\u5e38\u4f7f\u7528 \u5c06 master \u7684\u5916\u7f51\u5730\u5740\u548c\u4e3b\u673a\u540d\u89e3\u6790\u5230\u672c\u5730 hosts \u6e05\u7406k8s\u96c6\u7fa4 \u00b6 Success [root@k8s-master ~]# kubeadm reset [root@k8s-master ~]# kubectl delete node 192.168.200.112 [root@k8s-node01 ~]# docker rm -f $(docker ps -aq) [root@k8s-node01 ~]# systemctl stop kubelet [root@k8s-node01 ~]# rm -rf /etc/kubernetes/* [root@k8s-node01 ~]# rm -rf /var/lib/kubelet/* \u62a5\u9519\u89e3\u51b3 \u00b6 \u5728\u4f7f\u7528k8s\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u9047\u5230\u96c6\u7fa4\u51fa\u95ee\u9898\uff0c\u90a3\u4e48\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6765\u67e5\u770bkubelet \u65e5\u5fd7\uff0c\u89e3\u51b3\u95ee\u9898\u3002 [ cka ] root@node1:/home/lixie# journalctl -u kubelet -f //\u7edd\u5927\u90e8\u5206\u7684\u9519\u8bef\u90fd\u9700\u8981\u770b\u65e5\u5fd7\u6765\u89e3\u51b3 \u5f3a\u5236\u5220\u9664namespace \u00b6 delete namespace \u6253\u5f00\u4e00\u4e2a\u65b0\u7a97\u53e3\uff1aroot@master30:~# kubectl proxy --port=8001 \u65b9\u6cd5\u4e8c $ NAMESPACE_NAME=rook-ceph cat <<EOF | curl -X PUT \\ 127.0.0.1:8001/api/v1/namespaces/$NAMESPACE_NAME/finalize \\ -H \"Content-Type : application/json\" \\ --data-binary @- { \"kind\" : \"Namespace\" , \"apiVersion\" : \"v1\" , \"metadata\" : { \"name\" : \"$NAMESPACE_NAME\" }, \"spec\" : { \"finalizers\" : null } } EOF \u83b7\u53d6\u5f53\u524dnamespace\u4e0b\u7684\u955c\u50cf \u00b6 $ cat ~/.bash_profile # \u5c06\u4e00\u4e0b\u4ee3\u7801\u590d\u5236\u5230~/.bash_profile\uff0c\u5e76source ~/.bash_profile\u3002\u5c31\u53ef\u4ee5\u901a\u8fc7podimg\u547d\u4ee4\u83b7\u53d6\u955c\u50cf podimg () { kubectl get pods -o jsonpath = \"{..image}\" | \\ tr -s '[[:space:]]' '\\n' | \\ sort | \\ uniq } System OOM encountered \u4e24\u79cdOOM\uff08\u8fdb\u7a0bOOM\uff0c\u5bb9\u5668OOM\uff09\u53d1\u751f\u540e\uff0c\u90fd\u53ef\u80fd\u4f1a\u4f34\u968f\u4e00\u4e2a\u7cfb\u7edfOOM\u4e8b\u4ef6\uff0c\u8be5\u4e8b\u4ef6\u7684\u539f\u56e0\u662f\u7531\u4e0a\u8ff0OOM\u4e8b\u4ef6\u4f34\u968f\u5bfc\u81f4\u3002 \u9700\u8981\u89e3\u51b3\u4e0a\u9762\u8fdb\u7a0bOOM\u6216\u8005\u5bb9\u5668CgroupOOM\u7684\u95ee\u9898\uff0c\u6587\u7ae0\u53c2\u8003: \u89e3\u51b3OOM \u5c0f\u6280\u5de7 \u00b6 \u5c0f\u6280\u5de7 Mac \u7ba1\u7406kubernetes\uff0c\u5408\u5e76yaml https://aisensiy.me/kubeconfig-management \u53ef\u4ee5\u901a\u8fc7journalctl -xeu kubelet \u6765\u67e5\u770b\u65e5\u5fd7","title":"kubernetes \u96c6\u7fa4\u90e8\u7f72"},{"location":"3.k8s/3-k8s-systeminit-docs/#k8s","text":"","title":"k8s\u96c6\u7fa4\u90e8\u7f72"},{"location":"3.k8s/3-k8s-systeminit-docs/#kubeadm","text":"\u6ce8\u610f\u4ee5\u4e0b\u662fcentos\u642d\u5efa","title":"kubeadm \u521b\u5efa\u96c6\u7fa4"},{"location":"3.k8s/3-k8s-systeminit-docs/#_1","text":"# \u5c06 SELinux \u8bbe\u7f6e\u4e3a permissive \u6a21\u5f0f\uff08\u76f8\u5f53\u4e8e\u5c06\u5176\u7981\u7528\uff09 sudo setenforce 0 sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config #\u5173\u95edswap swapoff -a sed -ri 's/.*swap.*/#&/' /etc/fstab #\u5141\u8bb8 iptables \u68c0\u67e5\u6865\u63a5\u6d41\u91cf cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf br_netfilter EOF cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sudo sysctl --system \u5b89\u88c5kubelet\u3001kubeadm\u3001kubectl cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg exclude=kubelet kubeadm kubectl EOF sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes = kubernetes # \u6240\u6709\u8282\u70b9 sudo systemctl enable --now kubelet \u963f\u91cc\u4e91\u955c\u50cf\u5730\u5740: https://developer.aliyun.com/mirror/kubernetes/ \u6e29\u99a8\u63d0\u793a kubelet \u73b0\u5728\u6bcf\u9694\u51e0\u79d2\u5c31\u4f1a\u91cd\u542f\uff0c\u56e0\u4e3a\u5b83\u9677\u5165\u4e86\u4e00\u4e2a\u7b49\u5f85 kubeadm \u6307\u4ee4\u7684\u6b7b\u5faa\u73af \u67e5\u770bkubeadm\u7684\u7248\u672c\uff0c\u5e76\u62c9\u53d6\u8be5\u7248\u672c\u7684images kubeadm config images list --kubernetes-version v1.20.9 > k8s.images root@ubuntu:/home/ubuntu/script# cat k8s.images |awk -F'/' '{print $2}' kube-apiserver:v1.20.9 kube-controller-manager:v1.20.9 kube-scheduler:v1.20.9 kube-proxy:v1.20.9 pause:3.2 etcd:3.4.13-0 coredns:1.7.0 \u811a\u672c\u4e0b\u8f7d\u955c\u50cf root@ubuntu:/home/ubuntu/script# cat ubuntu-k8s-images.sh #!/bin/bash images=' kube-apiserver:v1.20.9 kube-controller-manager:v1.20.9 kube-scheduler:v1.20.9 kube-proxy:v1.20.9 pause:3.2 etcd:3.4.13-0 coredns:1.7.0 ' for i in $images ; do docker pull registry.aliyuncs.com/google_containers/$i done \u521d\u59cb\u5316master\u8282\u70b9\uff1a #\u6240\u6709\u673a\u5668\u6dfb\u52a0master\u57df\u540d\u6620\u5c04\uff0c\u4ee5\u4e0b\u9700\u8981\u4fee\u6539\u4e3a\u81ea\u5df1\u7684 echo \"192.168.8.70 cluster-endpoint\" >> /etc/hosts # \u4e3b\u8282\u70b9\u521d\u59cb\u5316 kubeadm init \\ --apiserver-advertise-address=192.168.159.201 \\ --control-plane-endpoint=cluster-endpoint \\ --image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \\ --kubernetes-version v1.20.9 \\ --service-cidr=10.96.0.0/16 \\ --pod-network-cidr=172.16.0.0/16 #\u6240\u6709\u7f51\u7edc\u8303\u56f4\u4e0d\u91cd\u53e0","title":"\u96c6\u7fa4\u521d\u59cb\u5316"},{"location":"3.k8s/3-k8s-systeminit-docs/#_2","text":"Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.1.11:6443 --token bv4kei.ozbuoivuj8jxaa6q \\ --discovery-token-ca-cert-hash sha256:e37c82f136192e54480555eeaa2a102cec8b630f18b5fffd0e24c1d1c0c8f730 \u521d\u59cb\u5316\u53d1\u73b0\u6240\u6709\u72b6\u6001\u90fd\u662f NotReady \u5b89\u88c5\u7f51\u7edc\u7ec4\u4ef6: calico","title":"\u8282\u70b9\u521d\u59cb\u5316"},{"location":"3.k8s/3-k8s-systeminit-docs/#node","text":"Warning \u65b0\u4ee4\u724c,\u9ed8\u8ba4\u7684\u4ee4\u724c24\u5c0f\u65f6\u5019\u5931\u6548 kubeadm token create --print-join-command \u5982\u679c\u57281.24\u4e4b\u540e\u7684k8s\u7248\u672c\u4f7f\u7528docker\uff0c\u9700\u8981\u6307\u5b9a--cri-socket=/run/cri-dockerd.sock","title":"Node\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"},{"location":"3.k8s/3-k8s-systeminit-docs/#mac","text":"Mac \u8fde\u63a5k8s\u96c6\u7fa4\u62a5\u9519 x509: certificate signed by unknown authority \u521b\u5efa\u96c6\u7fa4\u7684\u65f6\u5019\u6ca1\u6709\u6267\u884c\u5916\u7f51\u5730\u5740.\u5bfc\u81f4\u8bc1\u4e66\u4e0d\u80fd\u6b63\u5e38\u4f7f\u7528 \u5c06 master \u7684\u5916\u7f51\u5730\u5740\u548c\u4e3b\u673a\u540d\u89e3\u6790\u5230\u672c\u5730 hosts","title":"Mac\u8fde\u63a5\u96c6\u7fa4\u62a5\u9519"},{"location":"3.k8s/3-k8s-systeminit-docs/#k8s_1","text":"Success [root@k8s-master ~]# kubeadm reset [root@k8s-master ~]# kubectl delete node 192.168.200.112 [root@k8s-node01 ~]# docker rm -f $(docker ps -aq) [root@k8s-node01 ~]# systemctl stop kubelet [root@k8s-node01 ~]# rm -rf /etc/kubernetes/* [root@k8s-node01 ~]# rm -rf /var/lib/kubelet/*","title":"\u6e05\u7406k8s\u96c6\u7fa4"},{"location":"3.k8s/3-k8s-systeminit-docs/#_3","text":"\u5728\u4f7f\u7528k8s\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u9047\u5230\u96c6\u7fa4\u51fa\u95ee\u9898\uff0c\u90a3\u4e48\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6765\u67e5\u770bkubelet \u65e5\u5fd7\uff0c\u89e3\u51b3\u95ee\u9898\u3002 [ cka ] root@node1:/home/lixie# journalctl -u kubelet -f //\u7edd\u5927\u90e8\u5206\u7684\u9519\u8bef\u90fd\u9700\u8981\u770b\u65e5\u5fd7\u6765\u89e3\u51b3","title":"\u62a5\u9519\u89e3\u51b3"},{"location":"3.k8s/3-k8s-systeminit-docs/#namespace","text":"delete namespace \u6253\u5f00\u4e00\u4e2a\u65b0\u7a97\u53e3\uff1aroot@master30:~# kubectl proxy --port=8001 \u65b9\u6cd5\u4e8c $ NAMESPACE_NAME=rook-ceph cat <<EOF | curl -X PUT \\ 127.0.0.1:8001/api/v1/namespaces/$NAMESPACE_NAME/finalize \\ -H \"Content-Type : application/json\" \\ --data-binary @- { \"kind\" : \"Namespace\" , \"apiVersion\" : \"v1\" , \"metadata\" : { \"name\" : \"$NAMESPACE_NAME\" }, \"spec\" : { \"finalizers\" : null } } EOF","title":"\u5f3a\u5236\u5220\u9664namespace"},{"location":"3.k8s/3-k8s-systeminit-docs/#namespace_1","text":"$ cat ~/.bash_profile # \u5c06\u4e00\u4e0b\u4ee3\u7801\u590d\u5236\u5230~/.bash_profile\uff0c\u5e76source ~/.bash_profile\u3002\u5c31\u53ef\u4ee5\u901a\u8fc7podimg\u547d\u4ee4\u83b7\u53d6\u955c\u50cf podimg () { kubectl get pods -o jsonpath = \"{..image}\" | \\ tr -s '[[:space:]]' '\\n' | \\ sort | \\ uniq } System OOM encountered \u4e24\u79cdOOM\uff08\u8fdb\u7a0bOOM\uff0c\u5bb9\u5668OOM\uff09\u53d1\u751f\u540e\uff0c\u90fd\u53ef\u80fd\u4f1a\u4f34\u968f\u4e00\u4e2a\u7cfb\u7edfOOM\u4e8b\u4ef6\uff0c\u8be5\u4e8b\u4ef6\u7684\u539f\u56e0\u662f\u7531\u4e0a\u8ff0OOM\u4e8b\u4ef6\u4f34\u968f\u5bfc\u81f4\u3002 \u9700\u8981\u89e3\u51b3\u4e0a\u9762\u8fdb\u7a0bOOM\u6216\u8005\u5bb9\u5668CgroupOOM\u7684\u95ee\u9898\uff0c\u6587\u7ae0\u53c2\u8003: \u89e3\u51b3OOM","title":"\u83b7\u53d6\u5f53\u524dnamespace\u4e0b\u7684\u955c\u50cf"},{"location":"3.k8s/3-k8s-systeminit-docs/#_4","text":"\u5c0f\u6280\u5de7 Mac \u7ba1\u7406kubernetes\uff0c\u5408\u5e76yaml https://aisensiy.me/kubeconfig-management \u53ef\u4ee5\u901a\u8fc7journalctl -xeu kubelet \u6765\u67e5\u770b\u65e5\u5fd7","title":"\u5c0f\u6280\u5de7"},{"location":"3.k8s/4-ansible-install-k8s/","text":"\u9879\u76ee\u4e00: Ansible\u90e8\u7f72\u4e8c\u8fdb\u5236kubernetes\u96c6\u7fa4 \u00b6 Info \u4e8c\u8fdb\u5236\u65b9\u5f0f\u662f\u5b98\u65b9\u63a8\u8350\u7684\u90e8\u7f72\u65b9\u5f0f\u7684\u4e00\u79cd\uff0c\u4f46\u662f\u7531\u4e8e\u624b\u52a8\u90e8\u7f72\u96be\u5ea6\u8f83\u5927\uff0c\u6b64\u6b21\u91c7\u7528GitHub\u7684\u5f00\u6e90\u9879\u76eekubeasz Github \u9879\u76ee\u5730\u5740: https://github.com/easzlab/kubeasz \u73af\u5883\u914d\u7f6e \u00b6 \u89d2\u8272 IP \u63cf\u8ff0 K8s-master1 192.168.10.10 kube-scheduler\uff0ckubelet\uff0ckube-proxy\uff0cdocker\uff0ckeepalived\uff0cetcd K8s-master2 192.168.10.11 kube-scheduler\uff0ckubelet\uff0ckube-proxy\uff0cdocker\uff0ckeepalived\uff0cetcd K8s-node1 192.168.10.12 kubelet\uff0ckube-proxy\uff0cdocker \u4e00.\u914d\u7f6e\u9ad8\u53ef\u7528\u8d1f\u8f7d\u5747\u8861keepalived \u00b6 1.\u5b89\u88c5keepalived \u00b6 yum -y install ipvsadm keepalived haproxy 2.master1\u4e0a\u914d\u7f6ekeepalived \u00b6 [root@k8s-master1 ~]# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state MASTER interface ens192 virtual_router_id 1 priority 100 advert_int 2 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 192.168.10.88 } } 3.master2\u4e0a\u914d\u7f6ekeepalived \u00b6 [root@k8s-master2 ~]# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state BACKUP interface ens192 virtual_router_id 1 priority 80 advert_int 2 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 192.168.10.88 } } 4.\u91cd\u542fkeepalived \u00b6 [root@k8s-master1 ~]# systemctl restart keepalived [root@k8s-master1 ~]# systemctl enable keepalived \u4e8c.\u914d\u7f6ehaproxy \u00b6 1.master1\u4e0a\u914d\u7f6ehaproxy \u00b6 [root@k8s-master1 ~]# vim /etc/haproxy/haproxy.cfg listen k8s_6443 mode tcp bind 192.168.10.88:6443 server 192.168.10.10 192.168.10.10:6443 check inter 5s rise 2 fall 3 server 192.168.10.11 192.168.10.11:6443 check inter 5s rise 2 fall 3 2.master2\u4e0a\u914d\u7f6ehaproxy \u00b6 [root@k8s-master1 ~]# vim /etc/haproxy/haproxy.cfg listen k8s_6443 mode tcp bind 192.168.10.88:6443 server 192.168.10.10 192.168.10.10:6443 check inter 5s rise 2 fall 3 server 192.168.10.11 192.168.10.11:6443 check inter 5s rise 2 fall 3 3.\u91cd\u542fhaproxy \u00b6 [root@k8s-master1 ~]# systemctl restart haproxy [root@k8s-master1 ~]# systemctl enable haproxy \u4e09.\u5b89\u88c5k8s(master\u4e0a\u914d\u7f6e) \u00b6 1.\u5b89\u88c5ansible \u00b6 yum -y install ansible 2.\u914d\u7f6e\u5404\u4e2a\u8282\u70b9\u514d\u5bc6\u767b\u9646 \u00b6 ssh-keygen -t rsa ssh-copy-id -i .ssh/id_rsa.pub root@192.168.10.10 ssh-copy-id -i .ssh/id_rsa.pub root@192.168.10.11 ssh-copy-id -i .ssh/id_rsa.pub root@192.168.10.12 3.yum\u5b89\u88c5docker \u00b6 3.1\u4e0b\u8f7d\u4f9d\u8d56\u8f6f\u4ef6 \u00b6 [root@jenkins ~]# yum install -y yum-utils device-mapper-persistent-data lvm2 3.2\u4e0b\u8f7ddocker\u6e90 \u00b6 yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 3.3\u5b89\u88c5docker \u00b6 [root@jenkins ~]# yum -y install docker-ce-19.03.15 docker-ce-cli-19.03.15 containerd.io 3.4\u4fee\u6539docker\u6839\u76ee\u5f55\u4f4d\u7f6e \u00b6 [root@jenkins ~]# mkdir -p /data/docker [root@jenkins ~]# vim /usr/lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd --graph /data/docker -H fd:// [root@jenkins ~]# systemctl start docker [root@jenkins ~]# systemctl enable docker 3.5\u914d\u7f6edocker\u955c\u50cf\u4ed3\u5e93 \u00b6 [root@jenkins docker]# cat >> /etc/docker/daemon.json << EOF { \"registry-mirrors\": [\"https://7jauxlsb.mirror.aliyuncs.com\"], \"insecure-registries\":[\"192.168.10.133\"] } EOF 3.6\u91cd\u542fdocker \u00b6 [root@jenkins docker]# systemctl daemon-reload [root@jenkins docker]# systemctl restart docker 4.\u90e8\u7f72\u8282\u70b9\u7684\u5404\u9879\u76ee\u7ec4\u4ef6 \u00b6 4.1\u5b89\u88c5ezdown \u00b6 export release=3.1.1 wget https://github.com/easzlab/kubeasz/releases/download/${release}/ezdown chmod +x ./ezdown 4.2\u521d\u59cb\u5316ezdown \u00b6 [root@k8s-master1 ~]# vim ezdown DOCKER_VER=19.03.15 KUBEASZ_VER=3.1.1 K8S_BIN_VER=v1.22.5 [root@k8s-master1 ~]# ./ezdown -D 4.3\u751f\u6210ansible hosts\u6587\u4ef6 \u00b6 [root@k8s-master1 ~]# cd /etc/kubeasz/ [root@k8s-master1 kubeasz]# ./ezctl new k8s-cluster1 4.4\u7f16\u8f91ansible hosts\u6587\u4ef6 \u00b6 # 'etcd' cluster should have odd member(s) (1,3,5,...) [etcd] 192.168.10.10 192.168.10.11 # master node(s) [kube_master] 192.168.10.10 192.168.10.11 # work node(s) [kube_node] 192.168.10.12 # [optional] harbor server, a private docker registry # 'NEW_INSTALL': 'true' to install a harbor server; 'false' to integrate with existed one [harbor] #192.168.1.8 NEW_INSTALL=false # [optional] loadbalance for accessing k8s from outside [ex_lb] 192.168.10.11 LB_ROLE=backup EX_APISERVER_VIP=192.168.10.88 EX_APISERVER_PORT=6443 192.168.10.10 LB_ROLE=master EX_APISERVER_VIP=192.168.10.88 EX_APISERVER_PORT=6443 # [optional] ntp server for the cluster [chrony] #192.168.1.1 [all:vars] # --------- Main Variables --------------- # Secure port for apiservers SECURE_PORT=\"6443\" # Cluster container-runtime supported: docker, containerd CONTAINER_RUNTIME=\"docker\" # Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn CLUSTER_NETWORK=\"calico\" # Service proxy mode of kube-proxy: 'iptables' or 'ipvs' PROXY_MODE=\"ipvs\" # K8S Service CIDR, not overlap with node(host) networking SERVICE_CIDR=\"10.10.0.0/16\" # Cluster CIDR (Pod CIDR), not overlap with node(host) networking CLUSTER_CIDR=\"172.10.0.0/16\" # NodePort Range NODE_PORT_RANGE=\"1-65535\" # Cluster DNS Domain CLUSTER_DNS_DOMAIN=\"cluster.local\" # -------- Additional Variables (don't change the default value right now) --- # Binaries Directory bin_dir=\"/usr/bin\" # Deploy Directory (kubeasz workspace) base_dir=\"/etc/kubeasz\" # Directory for a specific cluster cluster_dir=\"{{ base_dir }}/clusters/k8s-cluster1\" # CA and other components cert/key Directory ca_dir=\"/etc/kubernetes/ssl\" 4.5\u7f16\u8f91config.yml\u6587\u4ef6 \u00b6 ############################ # prepare ############################ # \u53ef\u9009\u79bb\u7ebf\u5b89\u88c5\u7cfb\u7edf\u8f6f\u4ef6\u5305 (offline|online) INSTALL_SOURCE: \"online\" # \u53ef\u9009\u8fdb\u884c\u7cfb\u7edf\u5b89\u5168\u52a0\u56fa github.com/dev-sec/ansible-collection-hardening OS_HARDEN: false # \u8bbe\u7f6e\u65f6\u95f4\u6e90\u670d\u52a1\u5668\u3010\u91cd\u8981\uff1a\u96c6\u7fa4\u5185\u673a\u5668\u65f6\u95f4\u5fc5\u987b\u540c\u6b65\u3011 ntp_servers: - \"ntp1.aliyun.com\" - \"time1.cloud.tencent.com\" - \"0.cn.pool.ntp.org\" # \u8bbe\u7f6e\u5141\u8bb8\u5185\u90e8\u65f6\u95f4\u540c\u6b65\u7684\u7f51\u7edc\u6bb5\uff0c\u6bd4\u5982\"10.0.0.0/8\"\uff0c\u9ed8\u8ba4\u5168\u90e8\u5141\u8bb8 local_network: \"0.0.0.0/0\" ############################ # role:deploy ############################ # default: ca will expire in 100 years # default: certs issued by the ca will expire in 50 years CA_EXPIRY: \"876000h\" CERT_EXPIRY: \"438000h\" # kubeconfig \u914d\u7f6e\u53c2\u6570 CLUSTER_NAME: \"cluster1\" CONTEXT_NAME: \"context-{{ CLUSTER_NAME }}\" ############################ # role:etcd ############################ # \u8bbe\u7f6e\u4e0d\u540c\u7684wal\u76ee\u5f55\uff0c\u53ef\u4ee5\u907f\u514d\u78c1\u76d8io\u7ade\u4e89\uff0c\u63d0\u9ad8\u6027\u80fd ETCD_DATA_DIR: \"/var/lib/etcd\" ETCD_WAL_DIR: \"\" ############################ # role:runtime [containerd,docker] ############################ # ------------------------------------------- containerd # [.]\u542f\u7528\u5bb9\u5668\u4ed3\u5e93\u955c\u50cf ENABLE_MIRROR_REGISTRY: true # [containerd]\u57fa\u7840\u5bb9\u5668\u955c\u50cf SANDBOX_IMAGE: \"easzlab/pause-amd64:3.5\" # [containerd]\u5bb9\u5668\u6301\u4e45\u5316\u5b58\u50a8\u76ee\u5f55 CONTAINERD_STORAGE_DIR: \"/var/lib/containerd\" # ------------------------------------------- docker # [docker]\u5bb9\u5668\u5b58\u50a8\u76ee\u5f55 DOCKER_STORAGE_DIR: \"/data/docker\" # [docker]\u5f00\u542fRestful API ENABLE_REMOTE_API: false # [docker]\u4fe1\u4efb\u7684HTTP\u4ed3\u5e93 INSECURE_REG: '[\"127.0.0.1/8\",\"192.168.10.133\"]' ############################ # role:kube-master ############################ # k8s \u96c6\u7fa4 master \u8282\u70b9\u8bc1\u4e66\u914d\u7f6e\uff0c\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2aip\u548c\u57df\u540d\uff08\u6bd4\u5982\u589e\u52a0\u516c\u7f51ip\u548c\u57df\u540d\uff09 MASTER_CERT_HOSTS: - \"10.1.1.1\" - \"k8s.test.io\" #- \"www.test.com\" # node \u8282\u70b9\u4e0a pod \u7f51\u6bb5\u63a9\u7801\u957f\u5ea6\uff08\u51b3\u5b9a\u6bcf\u4e2a\u8282\u70b9\u6700\u591a\u80fd\u5206\u914d\u7684pod ip\u5730\u5740\uff09 # \u5982\u679cflannel \u4f7f\u7528 --kube-subnet-mgr \u53c2\u6570\uff0c\u90a3\u4e48\u5b83\u5c06\u8bfb\u53d6\u8be5\u8bbe\u7f6e\u4e3a\u6bcf\u4e2a\u8282\u70b9\u5206\u914dpod\u7f51\u6bb5 # https://github.com/coreos/flannel/issues/847 NODE_CIDR_LEN: 24 ############################ # role:kube-node ############################ # Kubelet \u6839\u76ee\u5f55 KUBELET_ROOT_DIR: \"/var/lib/kubelet\" # node\u8282\u70b9\u6700\u5927pod \u6570 MAX_PODS: 300 # \u914d\u7f6e\u4e3akube\u7ec4\u4ef6\uff08kubelet,kube-proxy,dockerd\u7b49\uff09\u9884\u7559\u7684\u8d44\u6e90\u91cf # \u6570\u503c\u8bbe\u7f6e\u8be6\u89c1templates/kubelet-config.yaml.j2 KUBE_RESERVED_ENABLED: \"no\" # k8s \u5b98\u65b9\u4e0d\u5efa\u8bae\u8349\u7387\u5f00\u542f system-reserved, \u9664\u975e\u4f60\u57fa\u4e8e\u957f\u671f\u76d1\u63a7\uff0c\u4e86\u89e3\u7cfb\u7edf\u7684\u8d44\u6e90\u5360\u7528\u72b6\u51b5\uff1b # \u5e76\u4e14\u968f\u7740\u7cfb\u7edf\u8fd0\u884c\u65f6\u95f4\uff0c\u9700\u8981\u9002\u5f53\u589e\u52a0\u8d44\u6e90\u9884\u7559\uff0c\u6570\u503c\u8bbe\u7f6e\u8be6\u89c1templates/kubelet-config.yaml.j2 # \u7cfb\u7edf\u9884\u7559\u8bbe\u7f6e\u57fa\u4e8e 4c/8g \u865a\u673a\uff0c\u6700\u5c0f\u5316\u5b89\u88c5\u7cfb\u7edf\u670d\u52a1\uff0c\u5982\u679c\u4f7f\u7528\u9ad8\u6027\u80fd\u7269\u7406\u673a\u53ef\u4ee5\u9002\u5f53\u589e\u52a0\u9884\u7559 # \u53e6\u5916\uff0c\u96c6\u7fa4\u5b89\u88c5\u65f6\u5019apiserver\u7b49\u8d44\u6e90\u5360\u7528\u4f1a\u77ed\u65f6\u8f83\u5927\uff0c\u5efa\u8bae\u81f3\u5c11\u9884\u75591g\u5185\u5b58 SYS_RESERVED_ENABLED: \"no\" # haproxy balance mode BALANCE_ALG: \"roundrobin\" ############################ # role:network [flannel,calico,cilium,kube-ovn,kube-router] ############################ # ------------------------------------------- flannel # [flannel]\u8bbe\u7f6eflannel \u540e\u7aef\"host-gw\",\"vxlan\"\u7b49 FLANNEL_BACKEND: \"vxlan\" DIRECT_ROUTING: false # [flannel] flanneld_image: \"quay.io/coreos/flannel:v0.10.0-amd64\" flannelVer: \"v0.13.0-amd64\" flanneld_image: \"easzlab/flannel:{{ flannelVer }}\" # [flannel]\u79bb\u7ebf\u955c\u50cftar\u5305 flannel_offline: \"flannel_{{ flannelVer }}.tar\" # ------------------------------------------- calico # [calico]\u8bbe\u7f6e CALICO_IPV4POOL_IPIP=\u201coff\u201d,\u53ef\u4ee5\u63d0\u9ad8\u7f51\u7edc\u6027\u80fd\uff0c\u6761\u4ef6\u9650\u5236\u8be6\u89c1 docs/setup/calico.md CALICO_IPV4POOL_IPIP: \"Always\" # [calico]\u8bbe\u7f6e calico-node\u4f7f\u7528\u7684host IP\uff0cbgp\u90bb\u5c45\u901a\u8fc7\u8be5\u5730\u5740\u5efa\u7acb\uff0c\u53ef\u624b\u5de5\u6307\u5b9a\u4e5f\u53ef\u4ee5\u81ea\u52a8\u53d1\u73b0 IP_AUTODETECTION_METHOD: \"can-reach={{ groups['kube_master'][0] }}\" # [calico]\u8bbe\u7f6ecalico \u7f51\u7edc backend: brid, vxlan, none CALICO_NETWORKING_BACKEND: \"brid\" # [calico]\u66f4\u65b0\u652f\u6301calico \u7248\u672c: [v3.3.x] [v3.4.x] [v3.8.x] [v3.15.x] calico_ver: \"v3.19.2\" # [calico]calico \u4e3b\u7248\u672c calico_ver_main: \"{{ calico_ver.split('.')[0] }}.{{ calico_ver.split('.')[1] }}\" # [calico]\u79bb\u7ebf\u955c\u50cftar\u5305 calico_offline: \"calico_{{ calico_ver }}.tar\" # ------------------------------------------- cilium # [cilium]CILIUM_ETCD_OPERATOR \u521b\u5efa\u7684 etcd \u96c6\u7fa4\u8282\u70b9\u6570 1,3,5,7... ETCD_CLUSTER_SIZE: 1 # [cilium]\u955c\u50cf\u7248\u672c cilium_ver: \"v1.4.1\" # [cilium]\u79bb\u7ebf\u955c\u50cftar\u5305 cilium_offline: \"cilium_{{ cilium_ver }}.tar\" # ------------------------------------------- kube-ovn # [kube-ovn]\u9009\u62e9 OVN DB and OVN Control Plane \u8282\u70b9\uff0c\u9ed8\u8ba4\u4e3a\u7b2c\u4e00\u4e2amaster\u8282\u70b9 OVN_DB_NODE: \"{{ groups['kube_master'][0] }}\" # [kube-ovn]\u79bb\u7ebf\u955c\u50cftar\u5305 kube_ovn_ver: \"v1.5.3\" kube_ovn_offline: \"kube_ovn_{{ kube_ovn_ver }}.tar\" # ------------------------------------------- kube-router # [kube-router]\u516c\u6709\u4e91\u4e0a\u5b58\u5728\u9650\u5236\uff0c\u4e00\u822c\u9700\u8981\u59cb\u7ec8\u5f00\u542f ipinip\uff1b\u81ea\u6709\u73af\u5883\u53ef\u4ee5\u8bbe\u7f6e\u4e3a \"subnet\" OVERLAY_TYPE: \"full\" # [kube-router]NetworkPolicy \u652f\u6301\u5f00\u5173 FIREWALL_ENABLE: \"true\" # [kube-router]kube-router \u955c\u50cf\u7248\u672c kube_router_ver: \"v0.3.1\" busybox_ver: \"1.28.4\" # [kube-router]kube-router \u79bb\u7ebf\u955c\u50cftar\u5305 kuberouter_offline: \"kube-router_{{ kube_router_ver }}.tar\" busybox_offline: \"busybox_{{ busybox_ver }}.tar\" ############################ # role:cluster-addon ############################ # coredns \u81ea\u52a8\u5b89\u88c5 dns_install: \"no\" corednsVer: \"1.8.4\" ENABLE_LOCAL_DNS_CACHE: true dnsNodeCacheVer: \"1.17.0\" # \u8bbe\u7f6e local dns cache \u5730\u5740 LOCAL_DNS_CACHE: \"10.10.0.2\" # metric server \u81ea\u52a8\u5b89\u88c5 metricsserver_install: \"no\" metricsVer: \"v0.5.0\" # dashboard \u81ea\u52a8\u5b89\u88c5 dashboard_install: \"no\" dashboardVer: \"v2.3.1\" dashboardMetricsScraperVer: \"v1.0.6\" # ingress \u81ea\u52a8\u5b89\u88c5 ingress_install: \"no\" ingress_backend: \"traefik\" traefik_chart_ver: \"9.12.3\" # prometheus \u81ea\u52a8\u5b89\u88c5 prom_install: \"no\" prom_namespace: \"monitor\" prom_chart_ver: \"12.10.6\" # nfs-provisioner \u81ea\u52a8\u5b89\u88c5 nfs_provisioner_install: \"no\" nfs_provisioner_namespace: \"kube-system\" nfs_provisioner_ver: \"v4.0.1\" nfs_storage_class: \"managed-nfs-storage\" nfs_server: \"192.168.1.10\" nfs_path: \"/data/nfs\" ############################ # role:harbor ############################ # harbor version\uff0c\u5b8c\u6574\u7248\u672c\u53f7 HARBOR_VER: \"v2.1.3\" HARBOR_DOMAIN: \"harbor.yourdomain.com\" HARBOR_TLS_PORT: 8443 # if set 'false', you need to put certs named harbor.pem and harbor-key.pem in directory 'down' HARBOR_SELF_SIGNED_CERT: true # install extra component HARBOR_WITH_NOTARY: false HARBOR_WITH_TRIVY: false HARBOR_WITH_CLAIR: false HARBOR_WITH_CHARTMUSEUM: true 4.6\u914d\u7f6e\u542f\u52a8\u73af\u5883 \u00b6 \u4e00\u952e\u90e8\u7f72:ezctl setup k8s-01 all [root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 01 4.7\u914d\u7f6eetcd \u00b6 [root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 02 //\u67e5\u770betcd\u72b6\u6001 etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/kubernetes/ssl/etcd.pem --key=/etc/kubernetes/ssl/etcd-key.pem --endpoints=\"https://192.168.10.10:2379,https://192.168.10.11:2379\" endpoint health --write-out=table 4.8\u5b89\u88c5docker \u00b6 [root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 03 4.9\u5b89\u88c5master\u8282\u70b9 \u00b6 [root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 04 4.10\u5b89\u88c5node\u8282\u70b9 \u00b6 [root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 05 5.\u90e8\u7f72\u7f51\u7edc\u670d\u52a1 \u00b6 1.\u90e8\u7f72calico \u00b6 [root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 06 2.\u90e8\u7f72coredns \u00b6 # __MACHINE_GENERATED_WARNING__ apiVersion: v1 kind: ServiceAccount metadata: name: coredns namespace: kube-system labels: kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: Reconcile name: system:coredns rules: - apiGroups: - \"\" resources: - endpoints - services - pods - namespaces verbs: - list - watch - apiGroups: - \"\" resources: - nodes verbs: - get - apiGroups: - discovery.k8s.io resources: - endpointslices verbs: - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: EnsureExists name: system:coredns roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:coredns subjects: - kind: ServiceAccount name: coredns namespace: kube-system --- apiVersion: v1 kind: ConfigMap metadata: name: coredns namespace: kube-system labels: addonmanager.kubernetes.io/mode: EnsureExists data: Corefile: | .:53 { errors health { lameduck 5s } ready kubernetes cluster.local in-addr.arpa ip6.arpa { pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 forward . /etc/resolv.conf { max_concurrent 1000 } cache 30 loop reload loadbalance } --- apiVersion: apps/v1 kind: Deployment metadata: name: coredns namespace: kube-system labels: k8s-app: kube-dns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: # replicas: not specified here: # 1. In order to make Addon Manager do not reconcile this replicas parameter. # 2. Default is 1. # 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on. strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 selector: matchLabels: k8s-app: kube-dns template: metadata: labels: k8s-app: kube-dns spec: securityContext: seccompProfile: type: RuntimeDefault priorityClassName: system-cluster-critical serviceAccountName: coredns affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: k8s-app operator: In values: [\"kube-dns\"] topologyKey: kubernetes.io/hostname tolerations: - key: \"CriticalAddonsOnly\" operator: \"Exists\" nodeSelector: kubernetes.io/os: linux containers: - name: coredns image: coredns/coredns:1.8.4 imagePullPolicy: IfNotPresent resources: limits: memory: 256Mi requests: cpu: 100m memory: 70Mi args: [ \"-conf\", \"/etc/coredns/Corefile\" ] volumeMounts: - name: config-volume mountPath: /etc/coredns readOnly: true ports: - containerPort: 53 name: dns protocol: UDP - containerPort: 53 name: dns-tcp protocol: TCP - containerPort: 9153 name: metrics protocol: TCP livenessProbe: httpGet: path: /health port: 8080 scheme: HTTP initialDelaySeconds: 60 timeoutSeconds: 5 successThreshold: 1 failureThreshold: 5 readinessProbe: httpGet: path: /ready port: 8181 scheme: HTTP securityContext: allowPrivilegeEscalation: false capabilities: add: - NET_BIND_SERVICE drop: - all readOnlyRootFilesystem: true dnsPolicy: Default volumes: - name: config-volume configMap: name: coredns items: - key: Corefile path: Corefile --- apiVersion: v1 kind: Service metadata: name: kube-dns namespace: kube-system annotations: prometheus.io/port: \"9153\" prometheus.io/scrape: \"true\" labels: k8s-app: kube-dns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: selector: k8s-app: kube-dns clusterIP: 10.10.0.2 ports: - name: dns port: 53 protocol: UDP - name: dns-tcp port: 53 protocol: TCP - name: metrics port: 9153 protocol: TCP 3.\u90e8\u7f72ingress \u00b6 apiVersion: v1 kind: Namespace metadata: name: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx --- # Source: ingress-nginx/templates/controller-serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx automountServiceAccountToken: true --- # Source: ingress-nginx/templates/controller-configmap.yaml apiVersion: v1 kind: ConfigMap metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx data: --- # Source: ingress-nginx/templates/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm name: ingress-nginx rules: - apiGroups: - '' resources: - configmaps - endpoints - nodes - pods - secrets verbs: - list - watch - apiGroups: - '' resources: - nodes verbs: - get - apiGroups: - '' resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - '' resources: - events verbs: - create - patch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch --- # Source: ingress-nginx/templates/clusterrolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm name: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- # Source: ingress-nginx/templates/controller-role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx rules: - apiGroups: - '' resources: - namespaces verbs: - get - apiGroups: - '' resources: - configmaps - pods - secrets - endpoints verbs: - get - list - watch - apiGroups: - '' resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch - apiGroups: - '' resources: - configmaps resourceNames: - ingress-controller-leader verbs: - get - update - apiGroups: - '' resources: - configmaps verbs: - create - apiGroups: - '' resources: - events verbs: - create - patch --- # Source: ingress-nginx/templates/controller-rolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- # Source: ingress-nginx/templates/controller-service-webhook.yaml apiVersion: v1 kind: Service metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller-admission namespace: ingress-nginx spec: type: ClusterIP ports: - name: https-webhook port: 443 targetPort: webhook appProtocol: https selector: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller --- # Source: ingress-nginx/templates/controller-deployment.yaml apiVersion: apps/v1 kind: DaemonSet metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx spec: selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller revisionHistoryLimit: 10 minReadySeconds: 0 template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller spec: hostNetwork: true dnsPolicy: ClusterFirst containers: - name: controller image: registry.cn-beijing.aliyuncs.com/kole_chang/controller:v1.0.0 imagePullPolicy: IfNotPresent lifecycle: preStop: exec: command: - /wait-shutdown args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key - --watch-ingress-without-class=true securityContext: capabilities: drop: - ALL add: - NET_BIND_SERVICE runAsUser: 101 allowPrivilegeEscalation: true env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: LD_PRELOAD value: /usr/local/lib/libmimalloc.so livenessProbe: failureThreshold: 5 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 ports: - name: http containerPort: 80 protocol: TCP - name: https containerPort: 443 protocol: TCP - name: webhook containerPort: 8443 protocol: TCP volumeMounts: - name: webhook-cert mountPath: /usr/local/certificates/ readOnly: true resources: requests: cpu: 100m memory: 90Mi nodeSelector: kubernetes.io/os: linux serviceAccountName: ingress-nginx terminationGracePeriodSeconds: 300 volumes: - name: webhook-cert secret: secretName: ingress-nginx-admission --- # Source: ingress-nginx/templates/controller-ingressclass.yaml # We don't support namespaced ingressClass yet # So a ClusterRole and a ClusterRoleBinding is required apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: nginx namespace: ingress-nginx spec: controller: k8s.io/ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml # before changing this value, check the required kubernetes version # https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites apiVersion: admissionregistration.k8s.io/v1 kind: ValidatingWebhookConfiguration metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook name: ingress-nginx-admission webhooks: - name: validate.nginx.ingress.kubernetes.io matchPolicy: Equivalent rules: - apiGroups: - networking.k8s.io apiVersions: - v1 operations: - CREATE - UPDATE resources: - ingresses failurePolicy: Fail sideEffects: None admissionReviewVersions: - v1 clientConfig: service: namespace: ingress-nginx name: ingress-nginx-controller-admission path: /networking/v1/ingresses --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook rules: - apiGroups: - admissionregistration.k8s.io resources: - validatingwebhookconfigurations verbs: - get - update --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook rules: - apiGroups: - '' resources: - secrets verbs: - get - create --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml apiVersion: batch/v1 kind: Job metadata: name: ingress-nginx-admission-create namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: template: metadata: name: ingress-nginx-admission-create labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: create image: registry.cn-beijing.aliyuncs.com/kole_chang/kube-webhook-certgen:v1.0 imagePullPolicy: IfNotPresent args: - create - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc - --namespace=$(POD_NAMESPACE) - --secret-name=ingress-nginx-admission env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000 --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml apiVersion: batch/v1 kind: Job metadata: name: ingress-nginx-admission-patch namespace: ingress-nginx annotations: helm.sh/hook: post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: template: metadata: name: ingress-nginx-admission-patch labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: patch image: registry.cn-beijing.aliyuncs.com/kole_chang/kube-webhook-certgen:v1.0 imagePullPolicy: IfNotPresent args: - patch - --webhook-name=ingress-nginx-admission - --namespace=$(POD_NAMESPACE) - --patch-mutating=false - --secret-name=ingress-nginx-admission - --patch-failure-policy=Fail env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000 \u56db.k8s\u5b89\u88c5\u540e\u914d\u7f6e \u00b6 1.\u8bbe\u7f6emaster\u53ef\u4ee5\u8c03\u5ea6 \u00b6 [root@k8s-master2 ~]# kubectl get node NAME STATUS ROLES AGE VERSION 192.168.10.201 Ready,SchedulingDisabled master 21h v1.22.2 192.168.10.202 Ready,SchedulingDisabled master 21h v1.22.2 192.168.10.203 Ready node 21h v1.22.2 [root@k8s-master2 ~]# kubectl uncordon 192.168.10.10 192.168.10.11 node/192.168.10.201 uncordoned node/192.168.10.202 uncordoned [root@k8s-master2 ~]# kubectl get node NAME STATUS ROLES AGE VERSION 192.168.10.201 Ready master 23h v1.22.2 192.168.10.202 Ready master 23h v1.22.2 192.168.10.203 Ready node 23h v1.22.2 2.\u7ed9\u8282\u70b9\u6253\u6807\u7b7e \u00b6 //\u67e5\u770b\u6807\u7b7e kubectl get node --show-labels=true kubectl label nodes 192.168.10.10 label_name=kuboard kubectl label nodes 192.168.10.10 label_tools=tools-1 kubectl label nodes 192.168.10.11 label_name=view-1 kubectl label nodes 192.168.10.11 label_tools=tools-2 kubectl label nodes 192.168.10.12 label_name=server-1 kubectl label nodes 192.168.10.12 label_tools=tools-3 systemctl restart kube-apiserver systemctl restart kube-controller-manager systemctl restart kubelet systemctl restart kube-proxy systemctl restart kube-scheduler","title":"kubernetes \u9879\u76ee\u4e00"},{"location":"3.k8s/4-ansible-install-k8s/#ansiblekubernetes","text":"Info \u4e8c\u8fdb\u5236\u65b9\u5f0f\u662f\u5b98\u65b9\u63a8\u8350\u7684\u90e8\u7f72\u65b9\u5f0f\u7684\u4e00\u79cd\uff0c\u4f46\u662f\u7531\u4e8e\u624b\u52a8\u90e8\u7f72\u96be\u5ea6\u8f83\u5927\uff0c\u6b64\u6b21\u91c7\u7528GitHub\u7684\u5f00\u6e90\u9879\u76eekubeasz Github \u9879\u76ee\u5730\u5740: https://github.com/easzlab/kubeasz","title":"\u9879\u76ee\u4e00: Ansible\u90e8\u7f72\u4e8c\u8fdb\u5236kubernetes\u96c6\u7fa4"},{"location":"3.k8s/4-ansible-install-k8s/#_1","text":"\u89d2\u8272 IP \u63cf\u8ff0 K8s-master1 192.168.10.10 kube-scheduler\uff0ckubelet\uff0ckube-proxy\uff0cdocker\uff0ckeepalived\uff0cetcd K8s-master2 192.168.10.11 kube-scheduler\uff0ckubelet\uff0ckube-proxy\uff0cdocker\uff0ckeepalived\uff0cetcd K8s-node1 192.168.10.12 kubelet\uff0ckube-proxy\uff0cdocker","title":"\u73af\u5883\u914d\u7f6e"},{"location":"3.k8s/4-ansible-install-k8s/#keepalived","text":"","title":"\u4e00.\u914d\u7f6e\u9ad8\u53ef\u7528\u8d1f\u8f7d\u5747\u8861keepalived"},{"location":"3.k8s/4-ansible-install-k8s/#1keepalived","text":"yum -y install ipvsadm keepalived haproxy","title":"1.\u5b89\u88c5keepalived"},{"location":"3.k8s/4-ansible-install-k8s/#2master1keepalived","text":"[root@k8s-master1 ~]# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state MASTER interface ens192 virtual_router_id 1 priority 100 advert_int 2 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 192.168.10.88 } }","title":"2.master1\u4e0a\u914d\u7f6ekeepalived"},{"location":"3.k8s/4-ansible-install-k8s/#3master2keepalived","text":"[root@k8s-master2 ~]# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state BACKUP interface ens192 virtual_router_id 1 priority 80 advert_int 2 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 192.168.10.88 } }","title":"3.master2\u4e0a\u914d\u7f6ekeepalived"},{"location":"3.k8s/4-ansible-install-k8s/#4keepalived","text":"[root@k8s-master1 ~]# systemctl restart keepalived [root@k8s-master1 ~]# systemctl enable keepalived","title":"4.\u91cd\u542fkeepalived"},{"location":"3.k8s/4-ansible-install-k8s/#haproxy","text":"","title":"\u4e8c.\u914d\u7f6ehaproxy"},{"location":"3.k8s/4-ansible-install-k8s/#1master1haproxy","text":"[root@k8s-master1 ~]# vim /etc/haproxy/haproxy.cfg listen k8s_6443 mode tcp bind 192.168.10.88:6443 server 192.168.10.10 192.168.10.10:6443 check inter 5s rise 2 fall 3 server 192.168.10.11 192.168.10.11:6443 check inter 5s rise 2 fall 3","title":"1.master1\u4e0a\u914d\u7f6ehaproxy"},{"location":"3.k8s/4-ansible-install-k8s/#2master2haproxy","text":"[root@k8s-master1 ~]# vim /etc/haproxy/haproxy.cfg listen k8s_6443 mode tcp bind 192.168.10.88:6443 server 192.168.10.10 192.168.10.10:6443 check inter 5s rise 2 fall 3 server 192.168.10.11 192.168.10.11:6443 check inter 5s rise 2 fall 3","title":"2.master2\u4e0a\u914d\u7f6ehaproxy"},{"location":"3.k8s/4-ansible-install-k8s/#3haproxy","text":"[root@k8s-master1 ~]# systemctl restart haproxy [root@k8s-master1 ~]# systemctl enable haproxy","title":"3.\u91cd\u542fhaproxy"},{"location":"3.k8s/4-ansible-install-k8s/#k8smaster","text":"","title":"\u4e09.\u5b89\u88c5k8s(master\u4e0a\u914d\u7f6e)"},{"location":"3.k8s/4-ansible-install-k8s/#1ansible","text":"yum -y install ansible","title":"1.\u5b89\u88c5ansible"},{"location":"3.k8s/4-ansible-install-k8s/#2","text":"ssh-keygen -t rsa ssh-copy-id -i .ssh/id_rsa.pub root@192.168.10.10 ssh-copy-id -i .ssh/id_rsa.pub root@192.168.10.11 ssh-copy-id -i .ssh/id_rsa.pub root@192.168.10.12","title":"2.\u914d\u7f6e\u5404\u4e2a\u8282\u70b9\u514d\u5bc6\u767b\u9646"},{"location":"3.k8s/4-ansible-install-k8s/#3yumdocker","text":"","title":"3.yum\u5b89\u88c5docker"},{"location":"3.k8s/4-ansible-install-k8s/#31","text":"[root@jenkins ~]# yum install -y yum-utils device-mapper-persistent-data lvm2","title":"3.1\u4e0b\u8f7d\u4f9d\u8d56\u8f6f\u4ef6"},{"location":"3.k8s/4-ansible-install-k8s/#32docker","text":"yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo","title":"3.2\u4e0b\u8f7ddocker\u6e90"},{"location":"3.k8s/4-ansible-install-k8s/#33docker","text":"[root@jenkins ~]# yum -y install docker-ce-19.03.15 docker-ce-cli-19.03.15 containerd.io","title":"3.3\u5b89\u88c5docker"},{"location":"3.k8s/4-ansible-install-k8s/#34docker","text":"[root@jenkins ~]# mkdir -p /data/docker [root@jenkins ~]# vim /usr/lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd --graph /data/docker -H fd:// [root@jenkins ~]# systemctl start docker [root@jenkins ~]# systemctl enable docker","title":"3.4\u4fee\u6539docker\u6839\u76ee\u5f55\u4f4d\u7f6e"},{"location":"3.k8s/4-ansible-install-k8s/#35docker","text":"[root@jenkins docker]# cat >> /etc/docker/daemon.json << EOF { \"registry-mirrors\": [\"https://7jauxlsb.mirror.aliyuncs.com\"], \"insecure-registries\":[\"192.168.10.133\"] } EOF","title":"3.5\u914d\u7f6edocker\u955c\u50cf\u4ed3\u5e93"},{"location":"3.k8s/4-ansible-install-k8s/#36docker","text":"[root@jenkins docker]# systemctl daemon-reload [root@jenkins docker]# systemctl restart docker","title":"3.6\u91cd\u542fdocker"},{"location":"3.k8s/4-ansible-install-k8s/#4","text":"","title":"4.\u90e8\u7f72\u8282\u70b9\u7684\u5404\u9879\u76ee\u7ec4\u4ef6"},{"location":"3.k8s/4-ansible-install-k8s/#41ezdown","text":"export release=3.1.1 wget https://github.com/easzlab/kubeasz/releases/download/${release}/ezdown chmod +x ./ezdown","title":"4.1\u5b89\u88c5ezdown"},{"location":"3.k8s/4-ansible-install-k8s/#42ezdown","text":"[root@k8s-master1 ~]# vim ezdown DOCKER_VER=19.03.15 KUBEASZ_VER=3.1.1 K8S_BIN_VER=v1.22.5 [root@k8s-master1 ~]# ./ezdown -D","title":"4.2\u521d\u59cb\u5316ezdown"},{"location":"3.k8s/4-ansible-install-k8s/#43ansible-hosts","text":"[root@k8s-master1 ~]# cd /etc/kubeasz/ [root@k8s-master1 kubeasz]# ./ezctl new k8s-cluster1","title":"4.3\u751f\u6210ansible hosts\u6587\u4ef6"},{"location":"3.k8s/4-ansible-install-k8s/#44ansible-hosts","text":"# 'etcd' cluster should have odd member(s) (1,3,5,...) [etcd] 192.168.10.10 192.168.10.11 # master node(s) [kube_master] 192.168.10.10 192.168.10.11 # work node(s) [kube_node] 192.168.10.12 # [optional] harbor server, a private docker registry # 'NEW_INSTALL': 'true' to install a harbor server; 'false' to integrate with existed one [harbor] #192.168.1.8 NEW_INSTALL=false # [optional] loadbalance for accessing k8s from outside [ex_lb] 192.168.10.11 LB_ROLE=backup EX_APISERVER_VIP=192.168.10.88 EX_APISERVER_PORT=6443 192.168.10.10 LB_ROLE=master EX_APISERVER_VIP=192.168.10.88 EX_APISERVER_PORT=6443 # [optional] ntp server for the cluster [chrony] #192.168.1.1 [all:vars] # --------- Main Variables --------------- # Secure port for apiservers SECURE_PORT=\"6443\" # Cluster container-runtime supported: docker, containerd CONTAINER_RUNTIME=\"docker\" # Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn CLUSTER_NETWORK=\"calico\" # Service proxy mode of kube-proxy: 'iptables' or 'ipvs' PROXY_MODE=\"ipvs\" # K8S Service CIDR, not overlap with node(host) networking SERVICE_CIDR=\"10.10.0.0/16\" # Cluster CIDR (Pod CIDR), not overlap with node(host) networking CLUSTER_CIDR=\"172.10.0.0/16\" # NodePort Range NODE_PORT_RANGE=\"1-65535\" # Cluster DNS Domain CLUSTER_DNS_DOMAIN=\"cluster.local\" # -------- Additional Variables (don't change the default value right now) --- # Binaries Directory bin_dir=\"/usr/bin\" # Deploy Directory (kubeasz workspace) base_dir=\"/etc/kubeasz\" # Directory for a specific cluster cluster_dir=\"{{ base_dir }}/clusters/k8s-cluster1\" # CA and other components cert/key Directory ca_dir=\"/etc/kubernetes/ssl\"","title":"4.4\u7f16\u8f91ansible hosts\u6587\u4ef6"},{"location":"3.k8s/4-ansible-install-k8s/#45configyml","text":"############################ # prepare ############################ # \u53ef\u9009\u79bb\u7ebf\u5b89\u88c5\u7cfb\u7edf\u8f6f\u4ef6\u5305 (offline|online) INSTALL_SOURCE: \"online\" # \u53ef\u9009\u8fdb\u884c\u7cfb\u7edf\u5b89\u5168\u52a0\u56fa github.com/dev-sec/ansible-collection-hardening OS_HARDEN: false # \u8bbe\u7f6e\u65f6\u95f4\u6e90\u670d\u52a1\u5668\u3010\u91cd\u8981\uff1a\u96c6\u7fa4\u5185\u673a\u5668\u65f6\u95f4\u5fc5\u987b\u540c\u6b65\u3011 ntp_servers: - \"ntp1.aliyun.com\" - \"time1.cloud.tencent.com\" - \"0.cn.pool.ntp.org\" # \u8bbe\u7f6e\u5141\u8bb8\u5185\u90e8\u65f6\u95f4\u540c\u6b65\u7684\u7f51\u7edc\u6bb5\uff0c\u6bd4\u5982\"10.0.0.0/8\"\uff0c\u9ed8\u8ba4\u5168\u90e8\u5141\u8bb8 local_network: \"0.0.0.0/0\" ############################ # role:deploy ############################ # default: ca will expire in 100 years # default: certs issued by the ca will expire in 50 years CA_EXPIRY: \"876000h\" CERT_EXPIRY: \"438000h\" # kubeconfig \u914d\u7f6e\u53c2\u6570 CLUSTER_NAME: \"cluster1\" CONTEXT_NAME: \"context-{{ CLUSTER_NAME }}\" ############################ # role:etcd ############################ # \u8bbe\u7f6e\u4e0d\u540c\u7684wal\u76ee\u5f55\uff0c\u53ef\u4ee5\u907f\u514d\u78c1\u76d8io\u7ade\u4e89\uff0c\u63d0\u9ad8\u6027\u80fd ETCD_DATA_DIR: \"/var/lib/etcd\" ETCD_WAL_DIR: \"\" ############################ # role:runtime [containerd,docker] ############################ # ------------------------------------------- containerd # [.]\u542f\u7528\u5bb9\u5668\u4ed3\u5e93\u955c\u50cf ENABLE_MIRROR_REGISTRY: true # [containerd]\u57fa\u7840\u5bb9\u5668\u955c\u50cf SANDBOX_IMAGE: \"easzlab/pause-amd64:3.5\" # [containerd]\u5bb9\u5668\u6301\u4e45\u5316\u5b58\u50a8\u76ee\u5f55 CONTAINERD_STORAGE_DIR: \"/var/lib/containerd\" # ------------------------------------------- docker # [docker]\u5bb9\u5668\u5b58\u50a8\u76ee\u5f55 DOCKER_STORAGE_DIR: \"/data/docker\" # [docker]\u5f00\u542fRestful API ENABLE_REMOTE_API: false # [docker]\u4fe1\u4efb\u7684HTTP\u4ed3\u5e93 INSECURE_REG: '[\"127.0.0.1/8\",\"192.168.10.133\"]' ############################ # role:kube-master ############################ # k8s \u96c6\u7fa4 master \u8282\u70b9\u8bc1\u4e66\u914d\u7f6e\uff0c\u53ef\u4ee5\u6dfb\u52a0\u591a\u4e2aip\u548c\u57df\u540d\uff08\u6bd4\u5982\u589e\u52a0\u516c\u7f51ip\u548c\u57df\u540d\uff09 MASTER_CERT_HOSTS: - \"10.1.1.1\" - \"k8s.test.io\" #- \"www.test.com\" # node \u8282\u70b9\u4e0a pod \u7f51\u6bb5\u63a9\u7801\u957f\u5ea6\uff08\u51b3\u5b9a\u6bcf\u4e2a\u8282\u70b9\u6700\u591a\u80fd\u5206\u914d\u7684pod ip\u5730\u5740\uff09 # \u5982\u679cflannel \u4f7f\u7528 --kube-subnet-mgr \u53c2\u6570\uff0c\u90a3\u4e48\u5b83\u5c06\u8bfb\u53d6\u8be5\u8bbe\u7f6e\u4e3a\u6bcf\u4e2a\u8282\u70b9\u5206\u914dpod\u7f51\u6bb5 # https://github.com/coreos/flannel/issues/847 NODE_CIDR_LEN: 24 ############################ # role:kube-node ############################ # Kubelet \u6839\u76ee\u5f55 KUBELET_ROOT_DIR: \"/var/lib/kubelet\" # node\u8282\u70b9\u6700\u5927pod \u6570 MAX_PODS: 300 # \u914d\u7f6e\u4e3akube\u7ec4\u4ef6\uff08kubelet,kube-proxy,dockerd\u7b49\uff09\u9884\u7559\u7684\u8d44\u6e90\u91cf # \u6570\u503c\u8bbe\u7f6e\u8be6\u89c1templates/kubelet-config.yaml.j2 KUBE_RESERVED_ENABLED: \"no\" # k8s \u5b98\u65b9\u4e0d\u5efa\u8bae\u8349\u7387\u5f00\u542f system-reserved, \u9664\u975e\u4f60\u57fa\u4e8e\u957f\u671f\u76d1\u63a7\uff0c\u4e86\u89e3\u7cfb\u7edf\u7684\u8d44\u6e90\u5360\u7528\u72b6\u51b5\uff1b # \u5e76\u4e14\u968f\u7740\u7cfb\u7edf\u8fd0\u884c\u65f6\u95f4\uff0c\u9700\u8981\u9002\u5f53\u589e\u52a0\u8d44\u6e90\u9884\u7559\uff0c\u6570\u503c\u8bbe\u7f6e\u8be6\u89c1templates/kubelet-config.yaml.j2 # \u7cfb\u7edf\u9884\u7559\u8bbe\u7f6e\u57fa\u4e8e 4c/8g \u865a\u673a\uff0c\u6700\u5c0f\u5316\u5b89\u88c5\u7cfb\u7edf\u670d\u52a1\uff0c\u5982\u679c\u4f7f\u7528\u9ad8\u6027\u80fd\u7269\u7406\u673a\u53ef\u4ee5\u9002\u5f53\u589e\u52a0\u9884\u7559 # \u53e6\u5916\uff0c\u96c6\u7fa4\u5b89\u88c5\u65f6\u5019apiserver\u7b49\u8d44\u6e90\u5360\u7528\u4f1a\u77ed\u65f6\u8f83\u5927\uff0c\u5efa\u8bae\u81f3\u5c11\u9884\u75591g\u5185\u5b58 SYS_RESERVED_ENABLED: \"no\" # haproxy balance mode BALANCE_ALG: \"roundrobin\" ############################ # role:network [flannel,calico,cilium,kube-ovn,kube-router] ############################ # ------------------------------------------- flannel # [flannel]\u8bbe\u7f6eflannel \u540e\u7aef\"host-gw\",\"vxlan\"\u7b49 FLANNEL_BACKEND: \"vxlan\" DIRECT_ROUTING: false # [flannel] flanneld_image: \"quay.io/coreos/flannel:v0.10.0-amd64\" flannelVer: \"v0.13.0-amd64\" flanneld_image: \"easzlab/flannel:{{ flannelVer }}\" # [flannel]\u79bb\u7ebf\u955c\u50cftar\u5305 flannel_offline: \"flannel_{{ flannelVer }}.tar\" # ------------------------------------------- calico # [calico]\u8bbe\u7f6e CALICO_IPV4POOL_IPIP=\u201coff\u201d,\u53ef\u4ee5\u63d0\u9ad8\u7f51\u7edc\u6027\u80fd\uff0c\u6761\u4ef6\u9650\u5236\u8be6\u89c1 docs/setup/calico.md CALICO_IPV4POOL_IPIP: \"Always\" # [calico]\u8bbe\u7f6e calico-node\u4f7f\u7528\u7684host IP\uff0cbgp\u90bb\u5c45\u901a\u8fc7\u8be5\u5730\u5740\u5efa\u7acb\uff0c\u53ef\u624b\u5de5\u6307\u5b9a\u4e5f\u53ef\u4ee5\u81ea\u52a8\u53d1\u73b0 IP_AUTODETECTION_METHOD: \"can-reach={{ groups['kube_master'][0] }}\" # [calico]\u8bbe\u7f6ecalico \u7f51\u7edc backend: brid, vxlan, none CALICO_NETWORKING_BACKEND: \"brid\" # [calico]\u66f4\u65b0\u652f\u6301calico \u7248\u672c: [v3.3.x] [v3.4.x] [v3.8.x] [v3.15.x] calico_ver: \"v3.19.2\" # [calico]calico \u4e3b\u7248\u672c calico_ver_main: \"{{ calico_ver.split('.')[0] }}.{{ calico_ver.split('.')[1] }}\" # [calico]\u79bb\u7ebf\u955c\u50cftar\u5305 calico_offline: \"calico_{{ calico_ver }}.tar\" # ------------------------------------------- cilium # [cilium]CILIUM_ETCD_OPERATOR \u521b\u5efa\u7684 etcd \u96c6\u7fa4\u8282\u70b9\u6570 1,3,5,7... ETCD_CLUSTER_SIZE: 1 # [cilium]\u955c\u50cf\u7248\u672c cilium_ver: \"v1.4.1\" # [cilium]\u79bb\u7ebf\u955c\u50cftar\u5305 cilium_offline: \"cilium_{{ cilium_ver }}.tar\" # ------------------------------------------- kube-ovn # [kube-ovn]\u9009\u62e9 OVN DB and OVN Control Plane \u8282\u70b9\uff0c\u9ed8\u8ba4\u4e3a\u7b2c\u4e00\u4e2amaster\u8282\u70b9 OVN_DB_NODE: \"{{ groups['kube_master'][0] }}\" # [kube-ovn]\u79bb\u7ebf\u955c\u50cftar\u5305 kube_ovn_ver: \"v1.5.3\" kube_ovn_offline: \"kube_ovn_{{ kube_ovn_ver }}.tar\" # ------------------------------------------- kube-router # [kube-router]\u516c\u6709\u4e91\u4e0a\u5b58\u5728\u9650\u5236\uff0c\u4e00\u822c\u9700\u8981\u59cb\u7ec8\u5f00\u542f ipinip\uff1b\u81ea\u6709\u73af\u5883\u53ef\u4ee5\u8bbe\u7f6e\u4e3a \"subnet\" OVERLAY_TYPE: \"full\" # [kube-router]NetworkPolicy \u652f\u6301\u5f00\u5173 FIREWALL_ENABLE: \"true\" # [kube-router]kube-router \u955c\u50cf\u7248\u672c kube_router_ver: \"v0.3.1\" busybox_ver: \"1.28.4\" # [kube-router]kube-router \u79bb\u7ebf\u955c\u50cftar\u5305 kuberouter_offline: \"kube-router_{{ kube_router_ver }}.tar\" busybox_offline: \"busybox_{{ busybox_ver }}.tar\" ############################ # role:cluster-addon ############################ # coredns \u81ea\u52a8\u5b89\u88c5 dns_install: \"no\" corednsVer: \"1.8.4\" ENABLE_LOCAL_DNS_CACHE: true dnsNodeCacheVer: \"1.17.0\" # \u8bbe\u7f6e local dns cache \u5730\u5740 LOCAL_DNS_CACHE: \"10.10.0.2\" # metric server \u81ea\u52a8\u5b89\u88c5 metricsserver_install: \"no\" metricsVer: \"v0.5.0\" # dashboard \u81ea\u52a8\u5b89\u88c5 dashboard_install: \"no\" dashboardVer: \"v2.3.1\" dashboardMetricsScraperVer: \"v1.0.6\" # ingress \u81ea\u52a8\u5b89\u88c5 ingress_install: \"no\" ingress_backend: \"traefik\" traefik_chart_ver: \"9.12.3\" # prometheus \u81ea\u52a8\u5b89\u88c5 prom_install: \"no\" prom_namespace: \"monitor\" prom_chart_ver: \"12.10.6\" # nfs-provisioner \u81ea\u52a8\u5b89\u88c5 nfs_provisioner_install: \"no\" nfs_provisioner_namespace: \"kube-system\" nfs_provisioner_ver: \"v4.0.1\" nfs_storage_class: \"managed-nfs-storage\" nfs_server: \"192.168.1.10\" nfs_path: \"/data/nfs\" ############################ # role:harbor ############################ # harbor version\uff0c\u5b8c\u6574\u7248\u672c\u53f7 HARBOR_VER: \"v2.1.3\" HARBOR_DOMAIN: \"harbor.yourdomain.com\" HARBOR_TLS_PORT: 8443 # if set 'false', you need to put certs named harbor.pem and harbor-key.pem in directory 'down' HARBOR_SELF_SIGNED_CERT: true # install extra component HARBOR_WITH_NOTARY: false HARBOR_WITH_TRIVY: false HARBOR_WITH_CLAIR: false HARBOR_WITH_CHARTMUSEUM: true","title":"4.5\u7f16\u8f91config.yml\u6587\u4ef6"},{"location":"3.k8s/4-ansible-install-k8s/#46","text":"\u4e00\u952e\u90e8\u7f72:ezctl setup k8s-01 all [root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 01","title":"4.6\u914d\u7f6e\u542f\u52a8\u73af\u5883"},{"location":"3.k8s/4-ansible-install-k8s/#47etcd","text":"[root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 02 //\u67e5\u770betcd\u72b6\u6001 etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/kubernetes/ssl/etcd.pem --key=/etc/kubernetes/ssl/etcd-key.pem --endpoints=\"https://192.168.10.10:2379,https://192.168.10.11:2379\" endpoint health --write-out=table","title":"4.7\u914d\u7f6eetcd"},{"location":"3.k8s/4-ansible-install-k8s/#48docker","text":"[root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 03","title":"4.8\u5b89\u88c5docker"},{"location":"3.k8s/4-ansible-install-k8s/#49master","text":"[root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 04","title":"4.9\u5b89\u88c5master\u8282\u70b9"},{"location":"3.k8s/4-ansible-install-k8s/#410node","text":"[root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 05","title":"4.10\u5b89\u88c5node\u8282\u70b9"},{"location":"3.k8s/4-ansible-install-k8s/#5","text":"","title":"5.\u90e8\u7f72\u7f51\u7edc\u670d\u52a1"},{"location":"3.k8s/4-ansible-install-k8s/#1calico","text":"[root@k8s-master1 kubeasz]# ./ezctl setup k8s-cluster1 06","title":"1.\u90e8\u7f72calico"},{"location":"3.k8s/4-ansible-install-k8s/#2coredns","text":"# __MACHINE_GENERATED_WARNING__ apiVersion: v1 kind: ServiceAccount metadata: name: coredns namespace: kube-system labels: kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: Reconcile name: system:coredns rules: - apiGroups: - \"\" resources: - endpoints - services - pods - namespaces verbs: - list - watch - apiGroups: - \"\" resources: - nodes verbs: - get - apiGroups: - discovery.k8s.io resources: - endpointslices verbs: - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: EnsureExists name: system:coredns roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:coredns subjects: - kind: ServiceAccount name: coredns namespace: kube-system --- apiVersion: v1 kind: ConfigMap metadata: name: coredns namespace: kube-system labels: addonmanager.kubernetes.io/mode: EnsureExists data: Corefile: | .:53 { errors health { lameduck 5s } ready kubernetes cluster.local in-addr.arpa ip6.arpa { pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 forward . /etc/resolv.conf { max_concurrent 1000 } cache 30 loop reload loadbalance } --- apiVersion: apps/v1 kind: Deployment metadata: name: coredns namespace: kube-system labels: k8s-app: kube-dns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: # replicas: not specified here: # 1. In order to make Addon Manager do not reconcile this replicas parameter. # 2. Default is 1. # 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on. strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 selector: matchLabels: k8s-app: kube-dns template: metadata: labels: k8s-app: kube-dns spec: securityContext: seccompProfile: type: RuntimeDefault priorityClassName: system-cluster-critical serviceAccountName: coredns affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: k8s-app operator: In values: [\"kube-dns\"] topologyKey: kubernetes.io/hostname tolerations: - key: \"CriticalAddonsOnly\" operator: \"Exists\" nodeSelector: kubernetes.io/os: linux containers: - name: coredns image: coredns/coredns:1.8.4 imagePullPolicy: IfNotPresent resources: limits: memory: 256Mi requests: cpu: 100m memory: 70Mi args: [ \"-conf\", \"/etc/coredns/Corefile\" ] volumeMounts: - name: config-volume mountPath: /etc/coredns readOnly: true ports: - containerPort: 53 name: dns protocol: UDP - containerPort: 53 name: dns-tcp protocol: TCP - containerPort: 9153 name: metrics protocol: TCP livenessProbe: httpGet: path: /health port: 8080 scheme: HTTP initialDelaySeconds: 60 timeoutSeconds: 5 successThreshold: 1 failureThreshold: 5 readinessProbe: httpGet: path: /ready port: 8181 scheme: HTTP securityContext: allowPrivilegeEscalation: false capabilities: add: - NET_BIND_SERVICE drop: - all readOnlyRootFilesystem: true dnsPolicy: Default volumes: - name: config-volume configMap: name: coredns items: - key: Corefile path: Corefile --- apiVersion: v1 kind: Service metadata: name: kube-dns namespace: kube-system annotations: prometheus.io/port: \"9153\" prometheus.io/scrape: \"true\" labels: k8s-app: kube-dns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: selector: k8s-app: kube-dns clusterIP: 10.10.0.2 ports: - name: dns port: 53 protocol: UDP - name: dns-tcp port: 53 protocol: TCP - name: metrics port: 9153 protocol: TCP","title":"2.\u90e8\u7f72coredns"},{"location":"3.k8s/4-ansible-install-k8s/#3ingress","text":"apiVersion: v1 kind: Namespace metadata: name: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx --- # Source: ingress-nginx/templates/controller-serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx automountServiceAccountToken: true --- # Source: ingress-nginx/templates/controller-configmap.yaml apiVersion: v1 kind: ConfigMap metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx data: --- # Source: ingress-nginx/templates/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm name: ingress-nginx rules: - apiGroups: - '' resources: - configmaps - endpoints - nodes - pods - secrets verbs: - list - watch - apiGroups: - '' resources: - nodes verbs: - get - apiGroups: - '' resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - '' resources: - events verbs: - create - patch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch --- # Source: ingress-nginx/templates/clusterrolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm name: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- # Source: ingress-nginx/templates/controller-role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx rules: - apiGroups: - '' resources: - namespaces verbs: - get - apiGroups: - '' resources: - configmaps - pods - secrets - endpoints verbs: - get - list - watch - apiGroups: - '' resources: - services verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses/status verbs: - update - apiGroups: - networking.k8s.io resources: - ingressclasses verbs: - get - list - watch - apiGroups: - '' resources: - configmaps resourceNames: - ingress-controller-leader verbs: - get - update - apiGroups: - '' resources: - configmaps verbs: - create - apiGroups: - '' resources: - events verbs: - create - patch --- # Source: ingress-nginx/templates/controller-rolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx namespace: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx subjects: - kind: ServiceAccount name: ingress-nginx namespace: ingress-nginx --- # Source: ingress-nginx/templates/controller-service-webhook.yaml apiVersion: v1 kind: Service metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller-admission namespace: ingress-nginx spec: type: ClusterIP ports: - name: https-webhook port: 443 targetPort: webhook appProtocol: https selector: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller --- # Source: ingress-nginx/templates/controller-deployment.yaml apiVersion: apps/v1 kind: DaemonSet metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: ingress-nginx-controller namespace: ingress-nginx spec: selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller revisionHistoryLimit: 10 minReadySeconds: 0 template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/component: controller spec: hostNetwork: true dnsPolicy: ClusterFirst containers: - name: controller image: registry.cn-beijing.aliyuncs.com/kole_chang/controller:v1.0.0 imagePullPolicy: IfNotPresent lifecycle: preStop: exec: command: - /wait-shutdown args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key - --watch-ingress-without-class=true securityContext: capabilities: drop: - ALL add: - NET_BIND_SERVICE runAsUser: 101 allowPrivilegeEscalation: true env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: LD_PRELOAD value: /usr/local/lib/libmimalloc.so livenessProbe: failureThreshold: 5 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 ports: - name: http containerPort: 80 protocol: TCP - name: https containerPort: 443 protocol: TCP - name: webhook containerPort: 8443 protocol: TCP volumeMounts: - name: webhook-cert mountPath: /usr/local/certificates/ readOnly: true resources: requests: cpu: 100m memory: 90Mi nodeSelector: kubernetes.io/os: linux serviceAccountName: ingress-nginx terminationGracePeriodSeconds: 300 volumes: - name: webhook-cert secret: secretName: ingress-nginx-admission --- # Source: ingress-nginx/templates/controller-ingressclass.yaml # We don't support namespaced ingressClass yet # So a ClusterRole and a ClusterRoleBinding is required apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: controller name: nginx namespace: ingress-nginx spec: controller: k8s.io/ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml # before changing this value, check the required kubernetes version # https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites apiVersion: admissionregistration.k8s.io/v1 kind: ValidatingWebhookConfiguration metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook name: ingress-nginx-admission webhooks: - name: validate.nginx.ingress.kubernetes.io matchPolicy: Equivalent rules: - apiGroups: - networking.k8s.io apiVersions: - v1 operations: - CREATE - UPDATE resources: - ingresses failurePolicy: Fail sideEffects: None admissionReviewVersions: - v1 clientConfig: service: namespace: ingress-nginx name: ingress-nginx-controller-admission path: /networking/v1/ingresses --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook rules: - apiGroups: - admissionregistration.k8s.io resources: - validatingwebhookconfigurations verbs: - get - update --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: ingress-nginx-admission annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook rules: - apiGroups: - '' resources: - secrets verbs: - get - create --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: ingress-nginx-admission namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: ingress-nginx-admission subjects: - kind: ServiceAccount name: ingress-nginx-admission namespace: ingress-nginx --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml apiVersion: batch/v1 kind: Job metadata: name: ingress-nginx-admission-create namespace: ingress-nginx annotations: helm.sh/hook: pre-install,pre-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: template: metadata: name: ingress-nginx-admission-create labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: create image: registry.cn-beijing.aliyuncs.com/kole_chang/kube-webhook-certgen:v1.0 imagePullPolicy: IfNotPresent args: - create - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc - --namespace=$(POD_NAMESPACE) - --secret-name=ingress-nginx-admission env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000 --- # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml apiVersion: batch/v1 kind: Job metadata: name: ingress-nginx-admission-patch namespace: ingress-nginx annotations: helm.sh/hook: post-install,post-upgrade helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: template: metadata: name: ingress-nginx-admission-patch labels: helm.sh/chart: ingress-nginx-4.0.1 app.kubernetes.io/name: ingress-nginx app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/version: 1.0.0 app.kubernetes.io/managed-by: Helm app.kubernetes.io/component: admission-webhook spec: containers: - name: patch image: registry.cn-beijing.aliyuncs.com/kole_chang/kube-webhook-certgen:v1.0 imagePullPolicy: IfNotPresent args: - patch - --webhook-name=ingress-nginx-admission - --namespace=$(POD_NAMESPACE) - --patch-mutating=false - --secret-name=ingress-nginx-admission - --patch-failure-policy=Fail env: - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace restartPolicy: OnFailure serviceAccountName: ingress-nginx-admission nodeSelector: kubernetes.io/os: linux securityContext: runAsNonRoot: true runAsUser: 2000","title":"3.\u90e8\u7f72ingress"},{"location":"3.k8s/4-ansible-install-k8s/#k8s","text":"","title":"\u56db.k8s\u5b89\u88c5\u540e\u914d\u7f6e"},{"location":"3.k8s/4-ansible-install-k8s/#1master","text":"[root@k8s-master2 ~]# kubectl get node NAME STATUS ROLES AGE VERSION 192.168.10.201 Ready,SchedulingDisabled master 21h v1.22.2 192.168.10.202 Ready,SchedulingDisabled master 21h v1.22.2 192.168.10.203 Ready node 21h v1.22.2 [root@k8s-master2 ~]# kubectl uncordon 192.168.10.10 192.168.10.11 node/192.168.10.201 uncordoned node/192.168.10.202 uncordoned [root@k8s-master2 ~]# kubectl get node NAME STATUS ROLES AGE VERSION 192.168.10.201 Ready master 23h v1.22.2 192.168.10.202 Ready master 23h v1.22.2 192.168.10.203 Ready node 23h v1.22.2","title":"1.\u8bbe\u7f6emaster\u53ef\u4ee5\u8c03\u5ea6"},{"location":"3.k8s/4-ansible-install-k8s/#2_1","text":"//\u67e5\u770b\u6807\u7b7e kubectl get node --show-labels=true kubectl label nodes 192.168.10.10 label_name=kuboard kubectl label nodes 192.168.10.10 label_tools=tools-1 kubectl label nodes 192.168.10.11 label_name=view-1 kubectl label nodes 192.168.10.11 label_tools=tools-2 kubectl label nodes 192.168.10.12 label_name=server-1 kubectl label nodes 192.168.10.12 label_tools=tools-3 systemctl restart kube-apiserver systemctl restart kube-controller-manager systemctl restart kubelet systemctl restart kube-proxy systemctl restart kube-scheduler","title":"2.\u7ed9\u8282\u70b9\u6253\u6807\u7b7e"},{"location":"3.k8s/ansible-install-k8s-docs/","text":"\u9488\u5bf9\u672c\u6b21\u4e4c\u5170\u5bdf\u5e03\u4e0a\u7ebf\uff0c\u5bf9ansible \u811a\u672c\u505a\u4e86\u4e00\u4e9b\u6539\u52a8\uff0c\u4e3b\u8981\u6765\u505a\u81ea\u52a8\u5316\u5b89\u88c5haproxy+keepliaved\uff0c\u5e76\u5bf9\u914d\u7f6e\u505a\u4e86\u4e00\u4e9b\u81ea\u52a8\u5316\u4f18\u5316\u3002\u4e00\u4e0b\u662f\u9488\u5bf9\u9ad8\u53ef\u7528\u753b\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u89c6\u56fe\u3002 \u4ece\u56fe\u4e0a\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u9700\u8981\u505a\u7684\u5c31\u662f\u6765\u914d\u7f6e kubeadm,keepalived,haproxy; \u4ee5\u4e0b\u662f\u4e00\u4e2arole\u7684ansible\u914d\u7f6e $ tree kube-lb kube-lb \u251c\u2500\u2500 haproxy \u2502 \u251c\u2500\u2500 handlers \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 templates \u2502 \u2514\u2500\u2500 haproxy.cfg.j2 \u2514\u2500\u2500 keepalived \u251c\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 templates \u2514\u2500\u2500 keepalived.conf.j2 7 directories, 5 files \u9996\u5148\u53ef\u4ee5\u770b\u4e00\u4e2a haproxy.cfg.j2 \u6a21\u7248\u6587\u4ef6 frontend stats mode http bind *:58404 stats enable stats uri /stats stats refresh 10s stats admin if TRUE stats auth admin:Gj4QSrzxZcgmEnw listen k8s_6443 mode tcp bind *:56443 {% for host in groups['k8s_lb'] %} # \u8fd9\u4e2a\u914d\u7f6e\u4e3b\u8981\u6765\u5faa\u73afinventory k8s_lb hosts \u4e3b\u673a\u7ec4 server {{ hostvars[host]['ansible_default_ipv4']['address'] }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:6443 check inter 5s rise 2 fall 3 {% endfor %} listen treafik_http mode tcp bind *:50443 {% for host in groups['k8s_lb'] %} # \u6253\u5f00k8s_lb\u4e3b\u673a\u7ec4treafik UI server {{ hostvars[host]['ansible_default_ipv4']['address'] }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:443 check inter 5s rise 2 fall 3 {% endfor %} listen treafik_https mode tcp bind *:50080 {% for host in groups['k8s_lb'] %} # \u6253\u5f00k8s_lb\u4e3b\u673a\u7ec4treafik UI server {{ hostvars[host]['ansible_default_ipv4']['address'] }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:80 check inter 5s rise 2 fall 3 {% endfor %} \u5176\u6b21\u8fd9\u4e2a\u662f\u9488\u5bf9 keepalived.conf.j2 \u505a\u4e86\u4e00\u4e9b\u81ea\u52a8\u5316\u914d\u7f6e { % for interface in vrrp_interfaces % } # \u5bf9\u4e8e vrrp_interfaces \u5217\u8868\u4e2d\u7684\u6bcf\u4e2a\u63a5\u53e3 vrrp_instance VI_1 {{ loop.index }} { # \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a VI_1 \u52a0\u4e0a\u5f53\u524d\u5faa\u73af\u7d22\u5f15\u7684 VRRP \u5b9e\u4f8b state {{ 'MASTER' if priority == 1 else 'BACKUP' }} # \u5982\u679c\u4f18\u5148\u7ea7\u4e3a 1\uff0c\u5219\u72b6\u6001\u4e3a MASTER\uff0c\u5426\u5219\u4e3a BACKUP interface {{ interface }} # \u8bbe\u7f6e\u63a5\u53e3\u4e3a\u5f53\u524d\u5faa\u73af\u7684\u63a5\u53e3 virtual_router_id 60 # \u8bbe\u7f6e\u865a\u62df\u8def\u7531\u5668 ID \u4e3a 60 priority {{ 101 - priority }} # \u8bbe\u7f6e\u4f18\u5148\u7ea7\u4e3a 101 \u51cf\u53bb\u5f53\u524d\u4f18\u5148\u7ea7 advert_int 2 # \u8bbe\u7f6e\u5e7f\u544a\u95f4\u9694\u4e3a 2 \u79d2 authentication { # \u8bbe\u7f6e\u8ba4\u8bc1 auth_type PASS # \u8ba4\u8bc1\u7c7b\u578b\u4e3a PASS auth_pass 1111 # \u8ba4\u8bc1\u5bc6\u7801\u4e3a 1111 } virtual_ipaddress { # \u8bbe\u7f6e\u865a\u62df IP \u5730\u5740 {{ virtual_ipaddress }} # \u4f7f\u7528 virtual_ipaddress \u53d8\u91cf } unicast_src_ip {{ node_ip }} # \u8bbe\u7f6e\u5355\u64ad\u6e90 IP \u4e3a node_ip unicast_peer { # \u8bbe\u7f6e\u5355\u64ad\u5bf9\u7b49\u4f53 { %- for master in groups [ 'k8s_lb' ] % } # \u5bf9\u4e8e groups['k8s_lb'] \u5217\u8868\u4e2d\u7684\u6bcf\u4e2a master { %- if master ! = inventory_hostname % } # \u5982\u679c master \u4e0d\u7b49\u4e8e inventory_hostname {{ - \"\\n \" + hostvars [ master ] .node_ip }} # \u5219\u6dfb\u52a0 master \u7684 node_ip \u5230\u5355\u64ad\u5bf9\u7b49\u4f53\u5217\u8868 { %- endif % } { %- endfor % } } } { % endfor % }","title":"kubernetes \u81ea\u52a8\u5316\u5b89\u88c5"},{"location":"3.k8s/deploy-sts-ds-docs/","text":"","title":"kubernetes \u63a7\u5236\u5668"},{"location":"3.k8s/k8s-calico-docs/","text":"","title":"K8s calico docs"},{"location":"3.k8s/k8s-configmap-docs/","text":"","title":"kubernetes \u914d\u7f6e\u7ba1\u7406"},{"location":"3.k8s/k8s-istio-docs/","text":"","title":"kubernetes \u670d\u52a1\u7f51\u683c"},{"location":"3.k8s/k8s-logs-docs/","text":"","title":"kubernetes \u65e5\u5fd7\u7ba1\u7406"},{"location":"3.k8s/k8s-mon-docs/","text":"","title":"kubernetes \u76d1\u63a7\u670d\u52a1"},{"location":"3.k8s/pod-base-docs/","text":"\u524d\u9762\u6211\u4eec\u53ef\u4ee5\u5229\u7528ansible\u81ea\u52a8\u5316\u642d\u5efa\u4e86 Kubernetes \u96c6\u7fa4\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u6b63\u5f0f\u5f00\u59cb\u5b66\u4e60 Kubernetes \u7684\u4f7f\u7528\u4e86\uff0c\u5728\u8fd9\u4e4b\u524d\u6211\u4eec\u8fd8\u9700\u8981\u5148\u4e86\u89e3\u4e0b YAML \u6587\u4ef6\u3002 \u8981\u5728 K8s \u96c6\u7fa4\u91cc\u9762\u8fd0\u884c\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u77e5\u9053\u51e0\u4e2a\u6982\u5ff5\u3002 \u7b2c\u4e00\u4e2a\u5f53\u7136\u5c31\u662f\u5e94\u7528\u7684\u955c\u50cf\uff0c\u56e0\u4e3a\u6211\u4eec\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u662f\u5bb9\u5668\uff0c\u6240\u4ee5\u9996\u5148\u9700\u8981\u5c06\u6211\u4eec\u7684\u5e94\u7528\u6253\u5305\u6210\u955c\u50cf\u3002\u955c\u50cf\u51c6\u5907\u597d\u4e86\uff0cKubernetes \u96c6\u7fa4\u4e5f\u51c6\u5907\u597d\u4e86\uff0c\u5176\u5b9e\u5c31\u53ef\u4ee5\u628a\u6211\u4eec\u7684\u5e94\u7528\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u4e86\u3002\u4f46\u662f\u955c\u50cf\u5230\u96c6\u7fa4\u4e2d\u8fd0\u884c\u8fd9\u4e2a\u8fc7\u7a0b\u5982\u4f55\u5b8c\u6210\u5462\uff1f\u5fc5\u7136\u6709\u4e00\u4e2a\u5730\u65b9\u53ef\u4ee5\u6765\u63cf\u8ff0\u6211\u4eec\u7684\u5e94\u7528\uff0c\u7136\u540e\u628a\u8fd9\u4efd\u63cf\u8ff0\u544a\u8bc9\u96c6\u7fa4\uff0c\u7136\u540e\u96c6\u7fa4\u6309\u7167\u8fd9\u4e2a\u63cf\u8ff0\u6765\u90e8\u7f72\u5e94\u7528\u3002 \u5728 Docker \u73af\u5883\u4e0b\u9762\u6211\u4eec\u662f\u76f4\u63a5\u901a\u8fc7\u547d\u4ee4 docker run \u6765\u8fd0\u884c\u6211\u4eec\u7684\u5e94\u7528\u7684\uff0c\u5728 Kubernetes \u73af\u5883\u4e0b\u9762\u6211\u4eec\u540c\u6837\u4e5f\u53ef\u4ee5\u7528\u7c7b\u4f3c kubectl run \u8fd9\u6837\u7684\u547d\u4ee4\u6765\u8fd0\u884c\u6211\u4eec\u7684\u5e94\u7528\uff0c\u4f46\u662f\u5728 Kubernetes \u4e2d\u5374\u662f\u4e0d\u63a8\u8350\u4f7f\u7528\u547d\u4ee4\u884c\u7684\u65b9\u5f0f\uff0c\u800c\u662f\u5e0c\u671b\u4f7f\u7528\u6211\u4eec\u79f0\u4e3a\u8d44\u6e90\u6e05\u5355\u7684\u4e1c\u897f\u6765\u63cf\u8ff0\u5e94\u7528\uff0c\u8d44\u6e90\u6e05\u5355\u53ef\u4ee5\u7528 YAML \u6216\u8005 JSON \u6587\u4ef6\u6765\u7f16\u5199\uff0c\u4e00\u822c\u6765\u8bf4 YAML \u6587\u4ef6\u66f4\u65b9\u4fbf\u9605\u8bfb\u548c\u7406\u89e3\uff0c\u6240\u4ee5\u6211\u4eec\u7684\u8bfe\u7a0b\u4e2d\u90fd\u4f1a\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u8fdb\u884c\u63cf\u8ff0\u3002 \u901a\u8fc7\u4e00\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6765\u5b9a\u4e49\u597d\u4e00\u4e2a\u5e94\u7528\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 kubectl \u5de5\u5177\u6765\u76f4\u63a5\u8fd0\u884c\u5b83\uff1a kubectl create -f xxxx.yaml # \u6216\u8005 kubectl apply -f xxxx.yaml \u7b2c\u4e00\u4e2a\u5bb9\u5668\u5316\u5e94\u7528 \u00b6 \u4ee5\u4e0b\u8fd9\u4e2anginx-deploy\u7684yaml\u4e3a\u4f8b\u5b50 apiVersion : apps/v1 # API\u7248\u672c kind : Deployment # API\u5bf9\u8c61\u7c7b\u578b metadata : name : nginx-deploy namespace : default labels : chapter : first-app spec : selector : matchLabels : app : nginx replicas : 2 # Pod \u526f\u672c\u6570\u91cf template : # Pod \u6a21\u677f metadata : labels : app : nginx spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 80 \u7136\u540e\u5e94\u7528\u8be5yaml\u6587\u4ef6 k apply -f nginx-deploy.yaml \u5e38\u7528\u547d\u4ee4 k scale deployment traefik --replicas=3 //\u8c03\u6574\u526f\u672c k edit deploy traefik // \u7f16\u8f91yaml k describe pod pod-xxxx // \u67e5\u770bpod\u8be6\u7ec6\u4fe1\u606f k get pod pod-xxx -o yaml // \u67e5\u770bpod yaml\u4fe1\u606f k get deploy // \u67e5\u770bdeploy \u8d44\u6e90 k get pod -o wide // \u67e5\u770bpod\u8be6\u60c5 Yaml \u6587\u4ef6 \u00b6 \u7565...... \u6587\u7ae0\u53c2\u8003 \u00b6 pod \u57fa\u7840\u6982\u5ff5\u5b66\u4e60\u8d44\u6599 \u4e00\u5927\u5806 kubeconfig yaml \u7ef4\u62a4\u5b9e\u8df5 \u5229\u7528k9s\u6765\u7ba1\u7406kubernetes\u96c6\u7fa4","title":"kubernetes pod \u57fa\u7840\u539f\u7406"},{"location":"3.k8s/pod-base-docs/#_1","text":"\u4ee5\u4e0b\u8fd9\u4e2anginx-deploy\u7684yaml\u4e3a\u4f8b\u5b50 apiVersion : apps/v1 # API\u7248\u672c kind : Deployment # API\u5bf9\u8c61\u7c7b\u578b metadata : name : nginx-deploy namespace : default labels : chapter : first-app spec : selector : matchLabels : app : nginx replicas : 2 # Pod \u526f\u672c\u6570\u91cf template : # Pod \u6a21\u677f metadata : labels : app : nginx spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 80 \u7136\u540e\u5e94\u7528\u8be5yaml\u6587\u4ef6 k apply -f nginx-deploy.yaml \u5e38\u7528\u547d\u4ee4 k scale deployment traefik --replicas=3 //\u8c03\u6574\u526f\u672c k edit deploy traefik // \u7f16\u8f91yaml k describe pod pod-xxxx // \u67e5\u770bpod\u8be6\u7ec6\u4fe1\u606f k get pod pod-xxx -o yaml // \u67e5\u770bpod yaml\u4fe1\u606f k get deploy // \u67e5\u770bdeploy \u8d44\u6e90 k get pod -o wide // \u67e5\u770bpod\u8be6\u60c5","title":"\u7b2c\u4e00\u4e2a\u5bb9\u5668\u5316\u5e94\u7528"},{"location":"3.k8s/pod-base-docs/#yaml","text":"\u7565......","title":"Yaml \u6587\u4ef6"},{"location":"3.k8s/pod-base-docs/#_2","text":"pod \u57fa\u7840\u6982\u5ff5\u5b66\u4e60\u8d44\u6599 \u4e00\u5927\u5806 kubeconfig yaml \u7ef4\u62a4\u5b9e\u8df5 \u5229\u7528k9s\u6765\u7ba1\u7406kubernetes\u96c6\u7fa4","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"3.k8s/pod-hook-docs/","text":"","title":"kubernetes pod \u751f\u547d\u5468\u671f"},{"location":"3.k8s/7.logging/fluentd/","text":"Fluentd \u00b6 Fluentd \u00b6 Fluentd \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6570\u636e\u6536\u96c6\u5668\uff0c\u81f4\u529b\u4e8e\u4e3a\u7528\u6237\u642d\u5efa\u7edf\u4e00\u7684\u65e5\u5fd7\u6536\u96c6\u5c42\uff0c\u5b83\u53ef\u4ee5\u8ba9\u4f60\u7edf\u4e00\u65e5\u5fd7\u7684\u6536\u96c6\u548c\u6d88\u8d39\uff0c\u4ee5\u4fbf\u66f4\u597d\u5730\u4f7f\u7528\u548c\u7406\u89e3\u65e5\u5fd7\uff0c\u7edf\u4e00\u7684\u65e5\u5fd7\u8bb0\u5f55\u5c42\u53ef\u8ba9\u4f60\u548c\u4f60\u7684\u56e2\u961f\u66f4\u597d\u5730\u5229\u7528\u6570\u636e\u5e76\u66f4\u5feb\u5730\u8fed\u4ee3\u4f60\u7684\u5e94\u7528\u3002 \u5b89\u88c5 \u00b6 Fluentd \u6709\u591a\u79cd\u5b89\u88c5\u65b9\u5f0f\uff0c\u6bd4\u5982\u53ef\u4ee5\u901a\u8fc7 Docker \u6216\u8005\u624b\u52a8\u8fdb\u884c\u5b89\u88c5\uff0c\u5728\u624b\u52a8\u5b89\u88c5 Fluentd \u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u4f60\u7684\u73af\u5883\u5df2\u6b63\u786e\u8bbe\u7f6e\uff0c\u4ee5\u907f\u514d\u4ee5\u540e\u51fa\u73b0\u4efb\u4f55\u4e0d\u4e00\u81f4\u3002 \u73af\u5883\u914d\u7f6e \u00b6 \u8bf7\u9075\u5faa\u4ee5\u4e0b\u5efa\u8bae\uff1a \u8bbe\u7f6e NTP \u589e\u52a0\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf \u4f18\u5316\u7f51\u7edc\u5185\u6838\u53c2\u6570 \u8bbe\u7f6e NTP \u5f3a\u70c8\u5efa\u8bae\u4f60\u5728\u8282\u70b9\u4e0a\u8bbe\u7f6e NTP \u5b88\u62a4\u8fdb\u7a0b\uff08\u4f8b\u5982 chrony \u3001 ntpd \u7b49\uff09\u4ee5\u83b7\u5f97\u51c6\u786e\u7684\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u8fd9\u5bf9\u4e8e\u6240\u6709\u751f\u4ea7\u670d\u52a1\u81f3\u5173\u91cd\u8981\u3002 \u589e\u52a0\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 ulimit -n \u547d\u4ee4\u67e5\u770b\u73b0\u6709\u914d\u7f6e\uff1a $ ulimit -n 65535 \u5982\u679c\u4f60\u7684\u63a7\u5236\u53f0\u663e\u793a 1024\uff0c\u90a3\u662f\u4e0d\u591f\u7684\u3002\u8bf7\u5c06\u4ee5\u4e0b\u51e0\u884c\u6dfb\u52a0\u5230 /etc/security/limits.conf \u6587\u4ef6\u5e76\u91cd\u542f\u673a\u5668\uff1a root soft nofile 65536 root hard nofile 65536 * soft nofile 65536 * hard nofile 65536 \u5982\u679c\u4f7f\u7528 systemd \u4e0b\u8fd0\u884c fluentd\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u9009\u9879 LimitNOFILE=65536 \u8fdb\u884c\u914d\u7f6e\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f td-agent \u5305\uff0c\u5219\u9ed8\u8ba4\u4f1a\u8bbe\u7f6e\u8be5\u503c\u3002 \u4f18\u5316\u7f51\u7edc\u5185\u6838\u53c2\u6570 \u5bf9\u4e8e\u5177\u6709\u8bb8\u591a Fluentd \u5b9e\u4f8b\u7684\u9ad8\u8d1f\u8f7d\u73af\u5883\uff0c\u53ef\u4ee5\u5c06\u4ee5\u4e0b\u914d\u7f6e\u6dfb\u52a0\u5230 /etc/sysctl.conf \u6587\u4ef6\u4e2d\uff1a net.core.somaxconn = 1024 net.core.netdev_max_backlog = 5000 net.core.rmem_max = 16777216 net.core.wmem_max = 16777216 net.ipv4.tcp_wmem = 4096 12582912 16777216 net.ipv4.tcp_rmem = 4096 12582912 16777216 net.ipv4.tcp_max_syn_backlog = 8096 net.ipv4.tcp_slow_start_after_idle = 0 net.ipv4.tcp_tw_reuse = 1 net.ipv4.ip_local_port_range = 10240 65535 \u4f7f\u7528 sysctl -p \u547d\u4ee4\u6216\u91cd\u65b0\u542f\u52a8\u8282\u70b9\u4f7f\u66f4\u6539\u751f\u6548\u3002 td-agent \u5305 \u00b6 \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 td-agent deb \u5305\u8fdb\u884c\u5b89\u88c5\uff0c\u8fd9\u662f\u7531 Treasure Data, Inc \u548c Calyptia, Inc \u7ef4\u62a4\u7684\u7a33\u5b9a Fluentd \u5206\u53d1\u5305\u3002 Fluentd \u662f\u7528 Ruby \u7f16\u5199\u7684\uff0c\u5177\u6709\u7075\u6d3b\u6027\uff0c\u5bf9\u6027\u80fd\u654f\u611f\u7684\u90e8\u5206\u7528 C \u8bed\u8a00\u7f16\u5199\u3002\u4f46\u662f\uff0c\u4e00\u4e9b\u7528\u6237\u53ef\u80fd\u96be\u4ee5\u5b89\u88c5\u548c\u64cd\u4f5c Ruby \u5b88\u62a4\u7a0b\u5e8f\u3002\u6240\u4ee5 Treasure Data, Inc \u4e13\u95e8\u63d0\u4f9b\u4e86\u4e00\u4e2a Fluentd \u7684\u7a33\u5b9a\u53d1\u884c\u7248\uff0c\u79f0\u4e3a td-agent \u3002 \u6211\u8fd9\u91cc\u662f Ubuntu Focal \u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff1a curl -fsSL https://toolbelt.treasuredata.com/sh/install-ubuntu-focal-td-agent4.sh | sh \u4e0a\u9762\u7684\u811a\u672c\u4f1a\u81ea\u52a8\u914d\u7f6e systemd \u7684\u542f\u52a8\u811a\u672c\uff0c\u811a\u672c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a $ cat /lib/systemd/system/td-agent.service; [Unit] Description=td-agent: Fluentd based data collector for Treasure Data Documentation=https://docs.treasuredata.com/display/public/PD/About+Treasure+Data%%27s+Server-Side+Agent After=network-online.target Wants=network-online.target [Service] User=td-agent Group=td-agent LimitNOFILE=65536 Environment=LD_PRELOAD=/opt/td-agent/lib/libjemalloc.so Environment=GEM_HOME=/opt/td-agent/lib/ruby/gems/2.7.0/ Environment=GEM_PATH=/opt/td-agent/lib/ruby/gems/2.7.0/ Environment=FLUENT_CONF=/etc/td-agent/td-agent.conf Environment=FLUENT_PLUGIN=/etc/td-agent/plugin Environment=FLUENT_SOCKET=/var/run/td-agent/td-agent.sock Environment=TD_AGENT_LOG_FILE=/var/log/td-agent/td-agent.log Environment=TD_AGENT_OPTIONS= EnvironmentFile=-/etc/default/td-agent PIDFile=/var/run/td-agent/td-agent.pid RuntimeDirectory=td-agent Type=forking # XXX: Fix fluentd executables path ExecStart=/opt/td-agent/bin/fluentd --log $TD_AGENT_LOG_FILE --daemon /var/run/td-agent/td-agent.pid $TD_AGENT_OPTIONS ExecStop=/bin/kill -TERM ${MAINPID} ExecReload=/bin/kill -HUP ${MAINPID} Restart=always TimeoutStopSec=120 [Install] WantedBy=multi-user.target \u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 systemctl \u6765\u7ba1\u7406 td-agent \u670d\u52a1\uff1a $ sudo systemctl start td-agent $ sudo systemctl status td-agent \u25cf td-agent.service - td-agent: Fluentd based data collector for Treasure Data Loaded: loaded (/lib/systemd/system/td-agent.service; enabled; vendor preset: enabled) Active: active (running) since Sat 2022-06-11 11:00:04 CST; 4min 6s ago Docs: https://docs.treasuredata.com/display/public/PD/About+Treasure+Data%27s+Server-Side+Agent Process: 3664 ExecStart=/opt/td-agent/bin/fluentd --log $TD_AGENT_LOG_FILE --daemon /var/run/td-agent/td-agent.pid $TD_AGE> Main PID: 3677 (fluentd) Tasks: 9 (limit: 19106) Memory: 99.0M CGroup: /system.slice/td-agent.service \u251c\u25003677 /opt/td-agent/bin/ruby /opt/td-agent/bin/fluentd --log /var/log/td-agent/td-agent.log --daemon /var/run/td> \u2514\u25003680 /opt/td-agent/bin/ruby -Eascii-8bit:ascii-8bit /opt/td-agent/bin/fluentd --log /var/log/td-agent/td-agent.> Jun 11 11:00:03 ydzsio systemd[1]: Starting td-agent: Fluentd based data collector for Treasure Data... Jun 11 11:00:04 ydzsio systemd[1]: Started td-agent: Fluentd based data collector for Treasure Data. lines 1-14/14 (END) td-agent \u542f\u52a8\u540e\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u53d1\u9001\u4e00\u6761\u65e5\u5fd7\uff1a $ curl -X POST -d 'json={\"json\":\"message\"}' http://localhost:8888/debug.test \u53d1\u9001\u540e\u67e5\u770b td-agent \u7684\u65e5\u5fd7\uff0c\u6b63\u5e38\u4f1a\u6536\u5230\u5982\u4e0b\u6240\u793a\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a $ tail -n 1 /var/log/td-agent/td-agent.log 2022-06-11 11:09:02.377608475 +0800 debug.test: {\"json\":\"message\"} Docker \u65b9\u5f0f \u00b6 \u5f53\u7136\u66f4\u591a\u7684\u65f6\u5019\u4f7f\u7528 Docker \u65b9\u5f0f\u4f7f\u7528 Fluentd \u4f1a\u66f4\u65b9\u4fbf\uff0c\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e00\u4e9b\u7b80\u5355\u7684\u6587\u4ef6\u6765\u8fdb\u884c\u6d4b\u8bd5\uff1a $ mkdir fluentd $ cd fluentd # \u521b\u5efa\u7528\u4e8e\u4fdd\u5b58 fluentd \u7684\u914d\u7f6e\u6587\u4ef6 etc \u76ee\u5f55\u548c\u4fdd\u5b58\u65e5\u5fd7\u7684 logs \u76ee\u5f55 $ mkdir -p etc logs # \u6dfb\u52a0\u4e00\u4e2a\u7b80\u5355\u7684\u914d\u7f6e\u6587\u4ef6 $ cat etc/fluentd_basic.conf <source> @type http port 8888 bind 0.0.0.0 </source> <match test.basic> @type stdout </match> \u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a fluentd \u76ee\u5f55\u7528\u4e8e\u6d4b\u8bd5\uff0c\u5176\u4e2d etc \u76ee\u5f55\u7528\u4e8e\u4fdd\u7559\u914d\u7f6e\u6587\u4ef6\u3001logs \u76ee\u5f55\u4fdd\u5b58\u65e5\u5fd7\uff0c\u9996\u5148\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6700\u57fa\u672c\u7684\u914d\u7f6e\u6587\u4ef6 etc/fluentd_basic.conf \uff0c\u5176\u4e2d\uff1a source \u90e8\u5206\u4f7f\u7528\u4e86 http \u7c7b\u578b\u7684\u8f93\u5165\u63d2\u4ef6\uff0c\u5728 8888 \u7aef\u53e3\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\u7528\u4e8e\u63a5\u6536\u65e5\u5fd7 match \u90e8\u5206\u5b9a\u4e49\u4e86\u65e5\u5fd7\u5339\u914d test.basic \u6807\u7b7e\uff0c\u5c31\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230 stdout \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c Fluentd \u7684\u542f\u52a8\uff1a $ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_basic.conf -v \u8fd9\u91cc\u6211\u4eec\u5c06 etc \u76ee\u5f55\u548c logs \u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u7136\u540e\u901a\u8fc7 -c \u53c2\u6570\u6307\u5b9a Fluentd \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6700\u540e\u4e00\u4e2a -v \u53c2\u6570\u662f\u7528\u4e8e\u8bbe\u7f6e Fluentd \u5f00\u542f verbose \u6a21\u5f0f\uff0c\u4fbf\u4e8e\u67e5\u770b Fluentd \u7684\u65e5\u5fd7\u65b9\u4fbf\u8c03\u8bd5\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\u4fe1\u606f\uff1a 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: parsing config file is succeeded path=\"/fluentd/etc/fluentd_basic.conf\" 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: gem 'fluentd' version '1.14.3' 2022-06-11 07:23:48 +0000 [debug]: fluent/log.rb:309:debug: No fluent logger for internal event 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: using configuration file: <ROOT> <source> @type http port 8888 bind \"0.0.0.0\" </source> <match test.basic> @type stdout </match> </ROOT> 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: starting fluentd-1.14.3 pid=7 ruby=\"2.7.5\" 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: spawn command to main: cmdline=[\"/usr/bin/ruby\", \"-Eascii-8bit:ascii-8bit\", \"/usr/bin/fluentd\", \"-c\", \"/fluentd/etc/fluentd_basic.conf\", \"-v\", \"--plugin\", \"/fluentd/plugins\", \"--under-supervisor\"] 2022-06-11 07:23:49 +0000 [info]: fluent/log.rb:330:info: adding match pattern=\"test.basic\" type=\"stdout\" 2022-06-11 07:23:49 +0000 [info]: fluent/log.rb:330:info: adding source type=\"http\" 2022-06-11 07:23:49 +0000 [debug]: #0 fluent/log.rb:309:debug: No fluent logger for internal event 2022-06-11 07:23:49 +0000 [info]: #0 fluent/log.rb:330:info: starting fluentd worker pid=16 ppid=7 worker=0 2022-06-11 07:23:49 +0000 [debug]: #0 fluent/log.rb:309:debug: listening http bind=\"0.0.0.0\" port=8888 2022-06-11 07:23:49 +0000 [info]: #0 fluent/log.rb:330:info: fluentd worker is now running worker=0 \u542f\u52a8\u540e\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u53d1\u9001\u4e00\u6761\u65e5\u5fd7\u5230 Fluentd \u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u914d\u7f6e\uff1a $ curl -i -X POST -d 'json={\"action\":\"login\",\"user\":100}' http://localhost:8888/test.logs HTTP/1.1 200 OK Content-Type: text/plain Connection: Keep-Alive Content-Length: 0 \u53d1\u9001\u540e\u6b63\u5e38\u4f1a\u5728 Fluentd \u4e2d\u67e5\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u4e00\u6761\u4fe1\u606f\uff1a 2022-06-11 07:34:29.925695338 +0000 test.logs: {\"action\":\"login\",\"user\":100} \u4e8b\u4ef6\u751f\u547d\u5468\u671f \u00b6 Fluentd \u662f\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\uff0c\u4e00\u6761\u65e5\u5fd7\u6d88\u606f\u5728 Fluentd \u4e2d\u88ab\u770b\u6210\u4e00\u4e2a Event \u4e8b\u4ef6\uff0cFluentd \u7684\u4e8b\u4ef6\u4e3b\u8981\u7531\u4e0b\u9762\u4e09\u90e8\u5206\u7ec4\u6210\uff1a \u6807\u7b7e tag\uff1a\u7528\u4e8e\u63cf\u8ff0\u4e8b\u4ef6\u6765\u6e90\uff0c\u53ef\u7528\u4e8e\u540e\u9762\u7684\u4e8b\u4ef6\u8def\u7531 \u65f6\u95f4 time\uff1a\u4e8b\u4ef6\u53d1\u751f\u7684\u65f6\u95f4\uff0c\u65f6\u95f4\u683c\u5f0f\u4e3a Unix \u65f6\u95f4\u6233 \u8bb0\u5f55 record\uff1a\u4e8b\u4ef6\u5185\u5bb9\u672c\u8eab\uff0cJSON \u683c\u5f0f \u6240\u6709\u7684\u8f93\u5165\u63d2\u4ef6\u90fd\u9700\u8981\u89e3\u6790\u539f\u59cb\u65e5\u5fd7\uff0c\u751f\u6210\u6ee1\u8db3\u4e0a\u9762\u7ed3\u6784\u7684\u4e8b\u4ef6\u5b57\u6bb5\uff0c\u6bd4\u5982\u4e00\u6761 Apache \u7684\u8bbf\u95ee\u65e5\u5fd7\uff1a 192.168.0.1 - - [28/Feb/2013:12:00:00 +0900] \"GET / HTTP/1.1\" 200 777 \u5728\u901a\u8fc7 in_tail \u8f93\u5165\u63d2\u4ef6\u5904\u7406\u540e\uff0c\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\u7ed3\u679c\uff1a tag: apache.access # \u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a time: 1362020400 # 28/Feb/2013:12:00:00 +0900 record: {\"user\": \"-\", \"method\": \"GET\", \"code\": 200, \"size\": 777, \"host\": \"192.168.0.1\", \"path\": \"/\"} \u5f53 Fluentd \u6536\u5230\u4e00\u6761\u4e8b\u4ef6\u540e\u4f1a\u7ecf\u8fc7\u4e00\u7cfb\u5217\u7684\u5904\u7406\u6d41\u7a0b\uff1a \u4fee\u6539\u4e8b\u4ef6\u7684\u76f8\u5173\u5b57\u6bb5 \u8fc7\u6ee4\u6389\u4e00\u4e9b\u4e0d\u9700\u8981\u7684\u4e8b\u4ef6 \u8def\u7531\u4e8b\u4ef6\u8f93\u51fa\u5230\u4e0d\u540c\u7684\u5730\u65b9 \u8fc7\u6ee4\u5668 Filter Filter \u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a\u4e8b\u4ef6\u662f\u8be5\u88ab\u63a5\u53d7\u6216\u662f\u88ab\u8fc7\u6ee4\u6389\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\u65b0\u589e\u8fc7\u6ee4\u5668\u3002 $ cat etc/fluentd_filter.conf <source> @type http port 8888 bind 0.0.0.0 </source> <filter test.logs> @type grep <exclude> key action pattern ^logout$ </exclude> </filter> <match test.logs> @type stdout </match> \u5728\u8be5\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u65b0\u589e\u4e86\u4e00\u4e2a filter \u6a21\u5757\uff0c\u4f7f\u7528 grep \u63d2\u4ef6\uff0c exclude \u90e8\u5206\u8868\u793a\u8981\u8fc7\u6ee4\u6389\u7684\u65e5\u5fd7\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u7684\u662f action \u8fd9\u4e2a key \u5339\u914d ^logout$ \u7684\u65f6\u5019\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5c31\u662f\u76f4\u63a5\u8fc7\u6ee4\u6389 logout \u65e5\u5fd7\u4e8b\u4ef6\u3002 \u4f7f\u7528\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u91cd\u65b0\u542f\u52a8 fluentd\uff1a $ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_filter.conf -v \u7136\u540e\u91cd\u65b0\u5411 Fluentd \u63d0\u4ea4\u4e24\u6761\u65e5\u5fd7\u6570\u636e\uff1a $ curl -X POST -d 'json={\"action\":\"login\",\"user\":2}' http://localhost:8888/test.logs $ curl -X POST -d 'json={\"action\":\"logout\",\"user\":2}' http://localhost:8888/test.logs \u6b63\u5e38\u8fd9\u4e2a\u65f6\u5019 Fluentd \u53ea\u4f1a\u6536\u5230\u7b2c\u4e00\u6761\u65e5\u5fd7\u6570\u636e\uff0c logout \u8fd9\u6761\u4e8b\u4ef6\u88ab\u8fc7\u6ee4\u6389\u4e86\uff1a 2022-06-11 07:52:45.555576216 +0000 test.logs: {\"action\":\"login\",\"user\":2} \u6807\u8bc6\u7b26 Labels Fluentd \u7684\u5904\u7406\u6d41\u7a0b\u662f\u6839\u636e\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b9a\u4e49\u4ece\u4e0a\u5230\u4e0b\u4f9d\u6b21\u6267\u884c\u7684\u3002\u4f46\u662f\u5047\u5982\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u591a\u4e2a\u8f93\u5165\u6e90\uff0c\u4e0d\u540c\u7684\u8f93\u5165\u6e90\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684 Filters \u8fc7\u6ee4\u5668\u7684\u65f6\u5019\uff0c\u90a3\u4e48\u8fd8\u6309\u7167\u987a\u5e8f\u6267\u884c\u7684\u65b9\u5f0f\u8bdd\uff0c\u914d\u7f6e\u6587\u4ef6\u5c31\u4f1a\u53d8\u5f97\u975e\u5e38\u590d\u6742\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cFluentd \u4e2d\u63d0\u4f9b\u4e86\u4e00\u79cd\u6807\u8bc6\u7b26 Labels \u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u4e3a\u4e0d\u540c\u7684\u8f93\u5165\u6e90\u6307\u5b9a\u4e0d\u540c\u7684\u5904\u7406\u6d41\u7a0b\u3002 \u5982\u4e0b\u6240\u793a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u914d\u7f6e\u6587\u4ef6 fluentd_labels.conf \uff1a <source> @type http port 8888 bind 0.0.0.0 @label @TEST </source> <filter test.logs> @type grep <exclude> key action pattern ^login$ </exclude> </filter> <label @TEST> <filter test.logs> @type grep <exclude> key action pattern ^logout$ </exclude> </filter> <match test.logs> @type stdout </match> </label> \u9996\u5148\u6211\u4eec\u5728\u8f93\u5165\u6e90\u4e2d\u7ed9\u65e5\u5fd7\u6e90\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6807\u7b7e @label @TEST \uff0c\u7136\u540e\u5148\u5b9a\u4e49\u4e86\u4e00\u4e2a filter \u8fc7\u6ee4\u6389 login \u4e8b\u4ef6\uff0c\u7136\u540e\u5728\u4e00\u4e2a label \u6a21\u5757\u91cc\u9762\u8fc7\u6ee4\u4e86 logout \u4e8b\u4ef6\u3002 \u73b0\u5728\u6211\u4eec\u4f7f\u7528\u8be5\u914d\u7f6e\u91cd\u65b0\u542f\u52a8 Fluentd\uff1a $ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_labels.conf -v \u7136\u540e\u91cd\u65b0\u5411 Fluentd \u63d0\u4ea4\u4e24\u6761\u65e5\u5fd7\u6570\u636e\uff1a $ curl -X POST -d 'json={\"action\":\"login\",\"user\":2}' http://localhost:8888/test.logs $ curl -X POST -d 'json={\"action\":\"logout\",\"user\":2}' http://localhost:8888/test.logs \u6b63\u5e38 Fluentd \u4e2d\u4f1a\u8f93\u51fa\u4e00\u6761\u65e5\u5fd7\u8bb0\u5f55\uff1a 2022-06-11 08:06:41.977559894 +0000 test.logs: {\"action\":\"login\",\"user\":2} \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u4e3a\u8f93\u5165\u65e5\u5fd7\u8bbe\u7f6e\u4e86 @TEST \u7684\u6807\u7b7e\uff0c\u56e0\u6b64\u8df3\u8fc7\u4e2d\u95f4\u8bbe\u7f6e\u7684\u4e00\u4e9b\u8fc7\u6ee4\u5668\uff0c\u53ea\u8fd0\u884c\u4e86 <label @TEST>...</lable> \u6807\u7b7e\u5757\u91cc\u7684\u8fc7\u6ee4\u5668\uff0c\u5982\u679c\u6807\u7b7e\u5757\u91cc\u9762\u6ca1\u6709\u5b9a\u4e49\u8fc7\u6ee4\u5668\u5219\u5c31\u4e0d\u4f1a\u8fc7\u6ee4\u65e5\u5fd7\u4e86\u3002 \u914d\u7f6e\u6587\u4ef6 \u00b6 \u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u8be6\u7ec6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u4ee5\u4f7f\u7528\u6307\u4ee4\u5305\u62ec\uff1a source \u6307\u4ee4\u786e\u5b9a\u8f93\u5165\u6e90 match \u6307\u4ee4\u786e\u5b9a\u8f93\u51fa\u76ee\u7684\u5730 filter \u6307\u4ee4\u786e\u5b9a\u4e8b\u4ef6\u5904\u7406\u7ba1\u9053 system \u6307\u4ee4\u8bbe\u7f6e\u7cfb\u7edf\u8303\u56f4\u7684\u914d\u7f6e label \u6307\u4ee4\u5bf9\u5185\u90e8\u8def\u7531\u7684\u8f93\u51fa\u548c\u8fc7\u6ee4\u5668\u8fdb\u884c\u5206\u7ec4 @include \u6307\u4ee4\u5305\u542b\u5176\u4ed6\u6587\u4ef6 source \u901a\u8fc7\u4f7f\u7528 source \u6307\u4ee4\u9009\u62e9\u548c\u914d\u7f6e\u6240\u9700\u7684\u8f93\u5165\u63d2\u4ef6\u6765\u542f\u7528 Fluentd \u8f93\u5165\u6e90\uff0cFluentd \u6807\u51c6\u8f93\u5165\u63d2\u4ef6\u5305\u62ec http \u548c forward\u3002 http \u63d0\u4f9b\u4e86\u4e00\u4e2a HTTP \u7aef\u70b9\u6765\u63a5\u53d7\u4f20\u5165\u7684 HTTP \u6d88\u606f\uff0c\u800c forward \u63d0\u4f9b\u4e86\u4e00\u4e2a TCP \u7aef\u70b9\u6765\u63a5\u53d7 TCP \u6570\u636e\u5305\u3002\u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u540c\u65f6\u662f\u4e24\u8005\u3002\u4f8b\u5982\uff1a # \u572824224\u7aef\u53e3\u63a5\u53d7TCP\u4e8b\u4ef6 <source> @type forward port 24224 </source> # http://<ip>:9880/myapp.access?json={\"event\":\"data\"} <source> @type http port 9880 </source> \u8f93\u5165\u6e90\u53ef\u4ee5\u4e00\u6b21\u6307\u5b9a\u591a\u4e2a\uff0c @type \u53c2\u6570\u7528\u6765\u6307\u5b9a\u8f93\u5165\u63d2\u4ef6\uff0c\u8f93\u5165\u63d2\u4ef6\u6269\u5c55\u4e86 Fluentd\uff0c\u4ee5\u68c0\u7d22\u548c\u63d0\u53d6\u6765\u81ea\u5916\u90e8\u7684\u65e5\u5fd7\u4e8b\u4ef6\uff0c\u4e00\u4e2a\u8f93\u5165\u63d2\u4ef6\u901a\u5e38\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u3001\u5957\u63a5\u5b57\u548c\u4e00\u4e2a\u76d1\u542c\u5957\u63a5\u5b57\uff0c\u5b83\u4e5f\u53ef\u4ee5\u88ab\u5199\u6210\u5b9a\u671f\u4ece\u6570\u636e\u6e90\u4e2d\u63d0\u53d6\u6570\u636e\u3002Fluentd \u652f\u6301\u975e\u5e38\u591a\u79cd\u8f93\u5165\u63d2\u4ef6\uff0c\u5305\u62ec\uff1a in_tail in_forward in_udp in_tcp in_unix in_http in_syslog in_exec in_sample in_windows_eventlog tail \u63d2\u4ef6\u5e94\u8be5\u662f\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u5f97\u6700\u591a\u7684\u8f93\u5165\u63d2\u4ef6\u4e86\uff0c in_tail \u8f93\u5165\u63d2\u4ef6\u5141\u8bb8 Fluentd \u4ece\u6587\u672c\u6587\u4ef6\u7684\u5c3e\u90e8\u8bfb\u53d6\u4e8b\u4ef6\uff0c\u5176\u884c\u4e3a\u7c7b\u4f3c\u4e8e tail -F \u547d\u4ee4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u5c31\u5b9a\u4e49\u4e86\u8f93\u5165\u63d2\u4ef6\u4e3a tail \uff0c\u5176\u4e2d\u7684 path \u5c5e\u6027\u6307\u5b9a\u4e86\u65e5\u5fd7\u7684\u6e90\u8def\u5f84\uff1a <source> @type tail path /var/log/httpd-access.log pos_file /var/log/td-agent/httpd-access.log.pos tag apache.access <parse> @type apache2 </parse> </source> \u5f53 Fluentd \u7b2c\u4e00\u6b21\u88ab\u914d\u7f6e\u4e3a in_tail \u65f6\uff0c\u5b83\u5c06\u4ece\u8be5\u65e5\u5fd7\u7684\u5c3e\u90e8\u5f00\u59cb\u8bfb\u53d6\uff0c\u800c\u4e0d\u662f\u4ece\u5f00\u59cb\uff0c\u4e00\u65e6\u65e5\u5fd7\u88ab\u8f6e\u8f6c\uff0cFluentd \u5c31\u4f1a\u4ece\u5934\u5f00\u59cb\u8bfb\u53d6\u65b0\u6587\u4ef6\uff0c\u5b83\u4fdd\u6301\u7740\u5bf9\u5f53\u524d inode \u53f7\u7684\u8ddf\u8e2a\u3002\u5982\u679c Fluentd \u91cd\u65b0\u542f\u52a8\uff0c\u5b83\u4f1a\u4ece\u91cd\u65b0\u542f\u52a8\u524d\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\u7ee7\u7eed\u8bfb\u53d6\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u8bb0\u5f55\u5728 `pos_file`` \u53c2\u6570\u6307\u5b9a\u7684\u4f4d\u7f6e\u6587\u4ef6\u4e2d\u3002 match match \u7528\u6765\u6307\u5b9a\u65e5\u5fd7\u7684\u8f93\u51fa\u76ee\u7684\u5730\uff0c\u4f8b\u5982\uff1a # \u5c06\u6ee1\u8db3 myapp.acccess \u6807\u7b7e\u7684\u4e8b\u4ef6\u5168\u90e8\u8f93\u51fa\u5230 # /var/log/fluent/access.%Y-%m-%d <match myapp.access> @type file path /var/log/fluent/access </match> \u540c\u6837\u8f93\u51fa\u4e5f\u53ef\u4ee5\u4e00\u6b21\u6307\u5b9a\u591a\u4e2a\uff0c @type \u53c2\u6570\u6307\u5b9a\u4f7f\u7528\u54ea\u4e00\u4e2a\u8f93\u51fa\u63d2\u4ef6\u3002Fluentd \u8f93\u51fa\u63d2\u4ef6\u5177\u6709\u4e09\u79cd\u7f13\u51b2\u548c\u5237\u65b0\u6a21\u5f0f\uff1a \u975e\u7f13\u51b2\u6a21\u5f0f \u4e0d\u5bf9\u6570\u636e\u8fdb\u884c\u7f13\u51b2\uff0c\u800c\u662f\u7acb\u5373\u8f93\u51fa\u7ed3\u679c \u540c\u6b65\u7f13\u51b2\u6a21\u5f0f \u6709\u4e00\u4e2a\u6682\u5b58\u7684 staged \u7684\u7f13\u51b2\u5757 chunks\uff08\u4e00\u4e2a chunk \u662f\u4e00\u4e2a\u4e8b\u4ef6\u7684\u96c6\u5408\uff09\u548c\u4e00\u4e2a chunk \u961f\u5217\uff0c\u5176\u884c\u4e3a\u53ef\u4ee5\u7531 <buffer> \u90e8\u5206\u63a7\u5236 \u5f02\u6b65\u7f13\u51b2\u6a21\u5f0f \u4e5f\u6709\u6682\u5b58\u548c\u961f\u5217\uff0c\u4f46\u8f93\u51fa\u63d2\u4ef6\u4e0d\u4f1a\u5728\u65b9\u6cd5\u4e2d\u540c\u6b65\u63d0\u4ea4\u5199\u5757\uff0c\u800c\u662f\u7a0d\u540e\u63d0\u4ea4 \u8f93\u51fa\u63d2\u4ef6\u53ef\u4ee5\u652f\u6301\u6240\u6709\u7684\u6a21\u5f0f\uff0c\u4f46\u53ef\u80fd\u53ea\u652f\u6301\u5176\u4e2d\u4e00\u79cd\u6a21\u5f0f\uff0c\u5982\u679c\u914d\u7f6e\u4e2d\u6ca1\u6709 <buffer> \u90e8\u5206\uff0cFluentd \u4f1a\u81ea\u52a8\u9009\u62e9\u5408\u9002\u7684\u6a21\u5f0f\u3002\u540c\u6837 Fluentd \u652f\u6301\u591a\u79cd\u8f93\u51fa\u63d2\u4ef6, \u6bd4\u5982: out_copy out_null out_roundrobin out_stdout out_exec_filter out_forward out_mongo / out_mongo_replset out_exec out_file out_s3 out_webhdfs ...... \u6bd4\u5982\u6211\u4eec\u4f7f\u7528 out_file \u4f5c\u4e3a\u8f93\u51fa\u76ee\u7684\u5730\u63d2\u4ef6\uff0c out_file \u8f93\u51fa\u63d2\u4ef6\u5c06\u4e8b\u4ef6\u5199\u5165\u6587\u4ef6\u3002\u5f53\u6ee1\u8db3 timekey \u6761\u4ef6\u65f6\uff0c\u5c06\u521b\u5efa\u8be5\u6587\u4ef6\uff0c\u8981\u6539\u53d8\u8f93\u51fa\u9891\u7387\uff0c\u9700\u8981\u4fee\u6539 timekey \u7684\u503c\uff0c\u5982\u4e0b\u6240\u793a\uff1a <match pattern> @type file path /var/log/fluent/myapp compress gzip <buffer> timekey 1d timekey_use_utc true timekey_wait 10m </buffer> </match> filter \u4f7f\u7528 filter \u53ef\u4ee5\u6307\u5b9a\u4e8b\u4ef6\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u591a\u4e2a filter \u53ef\u4ee5\u4e32\u8054\u8d77\u6765\u4f7f\u7528\uff1a Input -> filter 1 -> ... -> filter N -> Output \u6bd4\u5982\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a\u6807\u51c6\u7684 record_transformer \u8fc7\u6ee4\u5668\u6765\u5339\u914d\u4e8b\u4ef6\u3002 1 # http://this.host:9880/myapp.access?json={\"event\":\"data\"} <source> @type http port 9880 </source> <filter myapp.access> @type record_transformer <record> host_param \"#{Socket.gethostname}\" </record> </filter> <match myapp.access> @type file path /var/log/fluent/access </match> \u63a5\u6536\u5230\u7684\u4e8b\u4ef6 {\"event\":\"data\"} \u9996\u5148\u8fdb\u5165 record_transformer \u8fc7\u6ee4\u5668\uff0c\u8be5\u8fc7\u6ee4\u5668\u5c06 host_param \u5b57\u6bb5\u6dfb\u52a0\u5230\u4e8b\u4ef6\u4e2d\uff0c\u7136\u540e\u8fc7\u6ee4\u540e\u7684\u4e8b\u4ef6\u53d8\u4e3a {\"event\":\"data\",\"host_param\":\"webserver1\"} \u8fdb\u5165 file \u6587\u4ef6\u8f93\u51fa\u63d2\u4ef6\u3002 system \u7cfb\u7edf\u8303\u56f4\u7684\u914d\u7f6e\u7531 system \u6307\u4ee4\u8bbe\u7f6e\uff0c\u5b83\u4eec\u4e2d\u7684\u5927\u591a\u6570\u4e5f\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u9009\u9879\u83b7\u5f97\u3002\u4f8b\u5982\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\uff1a log_level suppress_repeated_stacktrace emit_error_log_interval suppress_config_dump without_source process_name (\u4ec5\u5728 system \u6307\u4ee4\u4e2d\u53ef\u7528\uff0c\u6ca1\u6709 fluentd \u9009\u9879) \u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\uff1a <system> # \u7b49\u540c\u4e8e -qq \u9009\u9879 log_level error # \u7b49\u540c\u4e8e --without-source \u9009\u9879 without_source # ... </system> \u6b64\u5916\u5982\u679c\u8bbe\u7f6e\u4e86 process_name \u53c2\u6570\uff0c\u5219 fluentd supervisor \u548c\u5de5\u4f5c\u8fdb\u7a0b\u540d\u79f0\u5c06\u66f4\u6539\u3002 <system> process_name fluentd1 </system> \u4f7f\u7528\u6b64\u914d\u7f6e\uff0c ps \u547d\u4ee4\u663e\u793a\u4ee5\u4e0b\u7ed3\u679c\uff1a % ps aux | grep fluentd1 foo 45673 0.4 0.2 2523252 38620 s001 S+ 7:04AM 0:00.44 worker:fluentd1 foo 45647 0.0 0.1 2481260 23700 s001 S+ 7:04AM 0:00.40 supervisor:fluentd1 label label \u6307\u4ee4\u53ef\u4ee5\u5bf9\u5185\u90e8\u8def\u7531\u7684\u8fc7\u6ee4\u5668\u548c\u8f93\u51fa\u8fdb\u884c\u5206\u7ec4\uff0c label \u964d\u4f4e\u4e86 tag \u5904\u7406\u7684\u590d\u6742\u6027\u3002 label \u53c2\u6570\u662f\u5185\u7f6e\u63d2\u4ef6\u53c2\u6570\uff0c\u56e0\u6b64\u9700\u8981 @ \u524d\u7f00\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\uff1a <source> @type forward </source> <source> @type tail @label @SYSTEM </source> <filter access.**> @type record_transformer <record> # ... </record> </filter> <match **> @type elasticsearch # ... </match> <label @SYSTEM> <filter var.log.middleware.**> @type grep # ... </filter> <match **> @type s3 # ... </match> </label> \u5728\u8be5\u914d\u7f6e\u4e2d\uff0c forward \u4e8b\u4ef6\u88ab\u8def\u7531\u5230 record_transformer \u8fc7\u6ee4\u5668\uff0c\u7136\u540e\u8f93\u51fa\u5230 elasticsearch \uff0c\u800c in_tail \u4e8b\u4ef6\u88ab\u8def\u7531\u5230 @SYSTEM \u6807\u7b7e\u5185\u7684 grep \u8fc7\u6ee4\u5668\uff0c\u7136\u540e\u8f93\u51fa\u5230 s3\u3002 label \u53c2\u6570\u5bf9\u4e8e\u6ca1\u6709 tag \u524d\u7f00\u7684\u4e8b\u4ef6\u6d41\u5206\u79bb\u5f88\u6709\u7528\u3002 @ERROR \u6807\u7b7e\u662f\u4e00\u4e2a\u5185\u7f6e\u6807\u7b7e\uff0c\u7528\u4e8e\u63d2\u4ef6\u7684 emit_error_event API \u53d1\u51fa\u7684\u9519\u8bef\u8bb0\u5f55\u3002\u5982\u679c\u8bbe\u7f6e\u4e86 <label @ERROR> \uff0c\u5219\u5728\u53d1\u51fa\u76f8\u5173\u9519\u8bef\u65f6\u5c06\u4e8b\u4ef6\u8def\u7531\u5230\u6b64\u6807\u7b7e\uff0c\u4f8b\u5982\u7f13\u51b2\u533a\u5df2\u6ee1\u6216\u8bb0\u5f55\u65e0\u6548\u3002 @ROOT \u6807\u7b7e\u4e5f\u662f\u4e00\u4e2a\u5185\u7f6e\u6807\u7b7e\uff0c\u7528\u4e8e\u901a\u8fc7\u63d2\u4ef6\u7684 event_emitter_router API \u83b7\u53d6\u6839\u8def\u7531\u5668\u3002\u4ece v1.14.0 \u5f00\u59cb\u5f15\u5165\u6b64\u6807\u7b7e\uff0c\u4ee5\u5c06\u6807\u7b7e\u5206\u914d\u56de\u9ed8\u8ba4\u8def\u7531\uff0c\u4f8b\u5982\uff0c\u7531 concat \u8fc7\u6ee4\u5668\u5904\u7406\u7684\u8d85\u65f6\u4e8b\u4ef6\u8bb0\u5f55\u53ef\u4ee5\u53d1\u9001\u5230\u9ed8\u8ba4\u8def\u7531\u3002 @include \u4f7f\u7528 @include \u6307\u4ee4\u53ef\u4ee5\u5bfc\u5165\u5355\u72ec\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6307\u4ee4\uff0c\u4f8b\u5982\uff1a # \u5305\u542b ./config.d \u76ee\u5f55\u4e2d\u7684\u6240\u6709\u914d\u7f6e\u6587\u4ef6 @include config.d/*.conf @include \u6307\u4ee4\u652f\u6301\u5e38\u89c4\u6587\u4ef6\u8def\u5f84\u3001glob \u6a21\u5f0f\u548c http URL \u7ea6\u5b9a\uff1a # \u7edd\u5bf9\u8def\u5f84 @include /path/to/config.conf # \u5982\u679c\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\uff0c\u6307\u4ee4\u5c06\u4f7f\u7528\u6b64\u914d\u7f6e\u6587\u4ef6\u7684\u76ee\u5f55\u540d\u6765\u6269\u5c55\u8def\u5f84 @include extra.conf # glob \u5339\u914d\u6a21\u5f0f @include config.d/*.conf # http @include http://example.com/fluent.conf parse \u4e00\u4e9b Fluentd \u63d2\u4ef6\u652f\u6301 <parse> \u6307\u4ee4\u6765\u6307\u5b9a\u5982\u4f55\u89e3\u6790\u539f\u59cb\u65e5\u5fd7\u6570\u636e\u3002 <parse> \u6307\u4ee4\u53ef\u4ee5\u5728 <source> \u3001 <match> \u6216 <filter> \u4e0b\u914d\u7f6e\uff0c\u4f8b\u5982\uff1a <source> @type tail path /path/to/input/file <parse> @type nginx keep_time_key true </parse> </source> <parse> \u4e2d\u901a\u8fc7 @type \u53c2\u6570\u6765\u6307\u5b9a\u89e3\u6790\u5668\u63d2\u4ef6\u7684\u7c7b\u578b\u3002 Fluentd \u5185\u7f6e\u4e86\u4e00\u4e9b\u6709\u7528\u7684\u89e3\u6790\u5668\u63d2\u4ef6\uff0c\u5305\u62ec\uff1a regexp apache2 apache_error nginx syslog csv tsv ltsv json multiline none \u8fd8\u6709\u4e00\u4e9b\u7b2c\u4e09\u65b9\u7684\u89e3\u6790\u5668\u63d2\u4ef6\uff1a grok\uff1a\u5982\u679c\u4f60\u719f\u6089 grok \u6a21\u5f0f\uff0c\u5219 grok-parser \u63d2\u4ef6\u5f88\u6709\u7528 multi-format-parser\uff1a\u5982\u679c\u4f60\u9700\u8981\u5728\u4e00\u4e2a\u6570\u636e\u6d41\u4e2d\u89e3\u6790\u591a\u79cd\u683c\u5f0f\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u89e3\u6790\u5668 protobuf\uff1aprotocol buffers avro\uff1aApache Avro \u6bd4\u5982\u6211\u4eec\u7684\u65e5\u5fd7\u4e8b\u4ef6\u4e2d\u6709\u5305\u542b\u591a\u884c\u65e5\u5fd7\u7684\u6570\u636e\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 multiline \u8fd9\u4e2a\u89e3\u6790\u5668\u6765\u89e3\u51b3\uff0c\u8be5\u63d2\u4ef6\u53ef\u4ee5\u7528\u6765\u89e3\u6790\u591a\u884c\u65e5\u5fd7\u3002\u8fd9\u4e2a\u63d2\u4ef6\u662f\u6b63\u5219\u8868\u8fbe\u5f0f\u89e3\u6790\u5668\u7684\u591a\u884c\u7248\u672c\u3002 \u591a\u884c\u89e3\u6790\u5668\u4f7f\u7528 formatN \u548c format_firstline \u53c2\u6570\u89e3\u6790\u65e5\u5fd7\uff0c format_firstline \u7528\u4e8e\u68c0\u6d4b\u591a\u884c\u65e5\u5fd7\u7684\u8d77\u59cb\u884c\u3002 formatN \uff0c\u5176\u4e2d N \u7684\u8303\u56f4\u662f [1..20]\uff0c\u662f\u591a\u884c\u65e5\u5fd7\u7684 Regexp \u683c\u5f0f\u5217\u8868\u3002 \u4e0e\u5176\u4ed6\u89e3\u6790\u5668\u63d2\u4ef6\u4e0d\u540c\uff0c\u6b64\u63d2\u4ef6\u9700\u8981\u8f93\u5165\u63d2\u4ef6\u4e2d\u7684\u7279\u6b8a\u4ee3\u7801\uff0c\u4f8b\u5982\u5904\u7406 format_firstline \u3002\u76ee\u524d\uff0cin_tail \u63d2\u4ef6\u9002\u7528\u4e8e\u591a\u884c\uff0c\u4f46\u5176\u4ed6\u8f93\u5165\u63d2\u4ef6\u4e0d\u9002\u7528\u4e8e\u5b83\u3002 \u6bd4\u5982\u6709\u4e00\u6761\u5982\u4e0b\u6240\u793a\u7684\u8f93\u5165\u65e5\u5fd7\uff1a Started GET \"/users/123/\" for 127.0.0.1 at 2013-06-14 12:00:11 +0900 Processing by UsersController#show as HTML Parameters: {\"user_id\"=>\"123\"} Rendered users/show.html.erb within layouts/application (0.3ms) Completed 200 OK in 4ms (Views: 3.2ms | ActiveRecord: 0.0ms) \u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\u6765\u8fdb\u884c\u89e3\u6790\uff1a <parse> @type multiline format_firstline /^Started/ format1 /Started (?<method>[^ ]+) \"(?<path>[^\"]+)\" for (?<host>[^ ]+) at (?<time>[^ ]+ [^ ]+ [^ ]+)\\n/ format2 /Processing by (?<controller>[^\\u0023]+)\\u0023(?<controller_method>[^ ]+) as (?<format>[^ ]+?)\\n/ format3 /( Parameters: (?<parameters>[^ ]+)\\n)?/ format4 / Rendered (?<template>[^ ]+) within (?<layout>.+) \\([\\d\\.]+ms\\)\\n/ format5 /Completed (?<code>[^ ]+) [^ ]+ in (?<runtime>[\\d\\.]+)ms \\(Views: (?<view_runtime>[\\d\\.]+)ms \\| ActiveRecord: (?<ar_runtime>[\\d\\.]+)ms\\)/ </parse> \u5176\u4e2d\u7684 format_firstline /^Started/ \u7528\u6765\u6307\u5b9a\u7b2c\u4e00\u884c\u65e5\u5fd7\u7684\u5339\u914d\u89c4\u5219\uff0c formatN \u6307\u5b9a\u540e\u9762\u51e0\u884c\u7684\u5339\u914d\u89c4\u5219\uff0c\u6700\u540e\u53ef\u4ee5\u89e3\u6790\u6210\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\uff1a time: 1371178811 (2013-06-14 12:00:11 +0900) record: { \"method\" :\"GET\", \"path\" :\"/users/123/\", \"host\" :\"127.0.0.1\", \"controller\" :\"UsersController\", \"controller_method\":\"show\", \"format\" :\"HTML\", \"parameters\" :\"{ \\\"user_id\\\":\\\"123\\\"}\", ... } \u540c\u6837\u6709\u5982\u4e0b\u6240\u793a\u7684 JAVA \u65e5\u5fd7\u4e8b\u4ef6\uff1a 2013-3-03 14:27:33 [main] INFO Main - Start 2013-3-03 14:27:33 [main] ERROR Main - Exception javax.management.RuntimeErrorException: null at Main.main(Main.java:16) ~[bin/:na] 2013-3-03 14:27:33 [main] INFO Main - End \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u914d\u7f6e\u6765\u89e3\u6790\uff1a <parse> @type multiline format_firstline /\\d{4}-\\d{1,2}-\\d{1,2}/ format1 /^(?<time>\\d{4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}) \\[(?<thread>.*)\\] (?<level>[^\\s]+)(?<message>.*)/ </parse> \u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u6790\u6210\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\u4e86\uff1a time: 2013-03-03 14:27:33 +0900 record: { \"thread\" :\"main\", \"level\" :\"INFO\", \"message\":\" Main - Start\" } time: 2013-03-03 14:27:33 +0900 record: { \"thread\" :\"main\", \"level\" :\"ERROR\", \"message\":\" Main - Exception\\njavax.management.RuntimeErrorException: null\\n at Main.main(Main.java:16) ~[bin/:na]\" } time: 2013-03-03 14:27:33 +0900 record: { \"thread\" :\"main\", \"level\" :\"INFO\", \"message\":\" Main - End\" } \u6a21\u5f0f\u5339\u914d \u00b6 \u5982\u4e0a\u6240\u8ff0\uff0cFluentd \u5141\u8bb8\u4f60\u6839\u636e\u4e8b\u4ef6\u7684 tag \u6765\u8def\u7531\u4e8b\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u660e\u786e\u6307\u5b9a\u9700\u8981\u5904\u7406\u7684 tag\uff0c\u6bd4\u5982 <filter app.log> \u6765\u6307\u5b9a\u53ea\u5904\u7406 tag \u4e3a app.log \u7684\u4e8b\u4ef6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 filter \u548c match \u4e2d\u901a\u8fc7\u901a\u914d\u7b26\uff0c\u6765\u5904\u7406\u540c\u4e00\u7c7b tag \u7684\u4e8b\u4ef6\u3002 tag \u901a\u5e38\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u7531 . \u5206\u9694\uff0c\u6bd4\u5982 myapp.access \uff1a * : \u5339\u914d\u6ee1\u8db3\u4e00\u4e2a tag \u90e8\u5206\u7684\u4e8b\u4ef6, \u6bd4\u5982: a.* \u5c06\u5339\u914d a.b \u8fd9\u6837\u7684 tag, \u4f46\u662f\u4e0d\u4f1a\u5904\u7406 a \u6216\u8005 a.b.c \u8fd9\u7c7b tag ** : \u5339\u914d\u6ee1\u8db3 0 \u4e2a\u6216\u591a\u4e2a tag \u90e8\u5206\u7684\u4e8b\u4ef6\uff0c\u6bd4\u5982 a.** \u5c06\u5339\u914d a\u3001a.b\u3001a.b.c \u8fd9\u4e09\u79cd tag {X, Y, Z} : \u5339\u914d\u6ee1\u8db3 X\u3001Y \u6216\u8005 Z \u7684 tag\uff0c\u6bd4\u5982 {a, b} \u5c06\u5339\u914d a \u6216\u8005 b\uff0c\u4f46\u662f\u4e0d\u4f1a\u5339\u914d c\uff0c\u8fd9\u79cd\u683c\u5f0f\u4e5f\u53ef\u4ee5\u548c\u901a\u914d\u7b26\u7ec4\u5408\u4f7f\u7528,\u6bd4\u5982 a.{b.c}.* \u6216 a.{b.c}.** #{...} \u4f1a\u628a\u82b1\u62ec\u53f7\u5185\u7684\u5b57\u7b26\u4e32\u5f53\u505a\u662f ruby \u7684\u8868\u8fbe\u5f0f\u5904\u7406\u3002\u6bd4\u5982 @type stdout \u5982\u679c\u8bbe\u7f6e\u4e86\u73af\u5883\u53d8\u91cf FLUENTD_TAG \u4e3a dev,\u90a3\u4e0a\u9762\u7b49\u4ef7\u4e8e app.dev \u3002 \u5f53\u6307\u5b9a\u4e86\u591a\u4e2a\u6a21\u5f0f\u65f6\uff08\u4f7f\u7528\u4e00\u4e2a\u6216\u591a\u4e2a\u7a7a\u683c\u5206\u5f00\uff09\uff0c\u53ea\u8981\u6ee1\u8db3\u5176\u4e2d\u4efb\u610f\u4e00\u4e2a\u5c31\u884c\u3002\u6bd4\u5982: <match a b> \u5339\u914d a \u548c b\uff0c <match a.** b.*> \u5339\u914d a, a.b, a.b.c, b.d \u7b49 \u5f53\u6709\u591a\u4e2a match\uff0c\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\u5b83\u4eec\u7684\u987a\u5e8f\uff0c\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff0c\u7b2c\u4e8c\u4e2a match \u6c38\u8fdc\u4e5f\u4e0d\u4f1a\u751f\u6548\uff1a # ** \u5339\u914d\u6240\u6709\u7684 tags. Bad :( <match **> @type blackhole_plugin </match> <match myapp.access> @type file path /var/log/fluent/access </match> \u6b63\u786e\u7684\u5199\u53d1\u5e94\u8be5\u662f\u5c06\u786e\u5b9a\u7684 tag \u5c3d\u91cf\u5199\u5728\u524d\u9762\uff0c\u6a21\u7cca\u5339\u914d\u7684\u5199\u5728\u540e\u9762\u3002 <match myapp.access> @type file path /var/log/fluent/access </match> # Capture all unmatched tags. Good :) <match **> @type blackhole_plugin </match> \u53e6\u5916\u9700\u8981\u6ce8\u610f\u987a\u5e8f\u7684\u662f filter \u548c match\uff0c\u5982\u679c\u5c06 filter \u653e\u5728 match \u4e4b\u540e\uff0c\u90a3\u4e48\u5b83\u4e5f\u6c38\u8fdc\u4e0d\u4f1a\u751f\u6548\u3002 \u5173\u4e8e Fluentd \u7684\u66f4\u591a\u4f7f\u7528\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\u4e86\u89e3\u66f4\u591a\u4fe1\u606f https://docs.fluentd.org \u3002","title":"Fluentd"},{"location":"3.k8s/7.logging/fluentd/#fluentd","text":"","title":"Fluentd"},{"location":"3.k8s/7.logging/fluentd/#fluentd_1","text":"Fluentd \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6570\u636e\u6536\u96c6\u5668\uff0c\u81f4\u529b\u4e8e\u4e3a\u7528\u6237\u642d\u5efa\u7edf\u4e00\u7684\u65e5\u5fd7\u6536\u96c6\u5c42\uff0c\u5b83\u53ef\u4ee5\u8ba9\u4f60\u7edf\u4e00\u65e5\u5fd7\u7684\u6536\u96c6\u548c\u6d88\u8d39\uff0c\u4ee5\u4fbf\u66f4\u597d\u5730\u4f7f\u7528\u548c\u7406\u89e3\u65e5\u5fd7\uff0c\u7edf\u4e00\u7684\u65e5\u5fd7\u8bb0\u5f55\u5c42\u53ef\u8ba9\u4f60\u548c\u4f60\u7684\u56e2\u961f\u66f4\u597d\u5730\u5229\u7528\u6570\u636e\u5e76\u66f4\u5feb\u5730\u8fed\u4ee3\u4f60\u7684\u5e94\u7528\u3002","title":"Fluentd"},{"location":"3.k8s/7.logging/fluentd/#_1","text":"Fluentd \u6709\u591a\u79cd\u5b89\u88c5\u65b9\u5f0f\uff0c\u6bd4\u5982\u53ef\u4ee5\u901a\u8fc7 Docker \u6216\u8005\u624b\u52a8\u8fdb\u884c\u5b89\u88c5\uff0c\u5728\u624b\u52a8\u5b89\u88c5 Fluentd \u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u4f60\u7684\u73af\u5883\u5df2\u6b63\u786e\u8bbe\u7f6e\uff0c\u4ee5\u907f\u514d\u4ee5\u540e\u51fa\u73b0\u4efb\u4f55\u4e0d\u4e00\u81f4\u3002","title":"\u5b89\u88c5"},{"location":"3.k8s/7.logging/fluentd/#_2","text":"\u8bf7\u9075\u5faa\u4ee5\u4e0b\u5efa\u8bae\uff1a \u8bbe\u7f6e NTP \u589e\u52a0\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf \u4f18\u5316\u7f51\u7edc\u5185\u6838\u53c2\u6570 \u8bbe\u7f6e NTP \u5f3a\u70c8\u5efa\u8bae\u4f60\u5728\u8282\u70b9\u4e0a\u8bbe\u7f6e NTP \u5b88\u62a4\u8fdb\u7a0b\uff08\u4f8b\u5982 chrony \u3001 ntpd \u7b49\uff09\u4ee5\u83b7\u5f97\u51c6\u786e\u7684\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u8fd9\u5bf9\u4e8e\u6240\u6709\u751f\u4ea7\u670d\u52a1\u81f3\u5173\u91cd\u8981\u3002 \u589e\u52a0\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 ulimit -n \u547d\u4ee4\u67e5\u770b\u73b0\u6709\u914d\u7f6e\uff1a $ ulimit -n 65535 \u5982\u679c\u4f60\u7684\u63a7\u5236\u53f0\u663e\u793a 1024\uff0c\u90a3\u662f\u4e0d\u591f\u7684\u3002\u8bf7\u5c06\u4ee5\u4e0b\u51e0\u884c\u6dfb\u52a0\u5230 /etc/security/limits.conf \u6587\u4ef6\u5e76\u91cd\u542f\u673a\u5668\uff1a root soft nofile 65536 root hard nofile 65536 * soft nofile 65536 * hard nofile 65536 \u5982\u679c\u4f7f\u7528 systemd \u4e0b\u8fd0\u884c fluentd\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u9009\u9879 LimitNOFILE=65536 \u8fdb\u884c\u914d\u7f6e\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f td-agent \u5305\uff0c\u5219\u9ed8\u8ba4\u4f1a\u8bbe\u7f6e\u8be5\u503c\u3002 \u4f18\u5316\u7f51\u7edc\u5185\u6838\u53c2\u6570 \u5bf9\u4e8e\u5177\u6709\u8bb8\u591a Fluentd \u5b9e\u4f8b\u7684\u9ad8\u8d1f\u8f7d\u73af\u5883\uff0c\u53ef\u4ee5\u5c06\u4ee5\u4e0b\u914d\u7f6e\u6dfb\u52a0\u5230 /etc/sysctl.conf \u6587\u4ef6\u4e2d\uff1a net.core.somaxconn = 1024 net.core.netdev_max_backlog = 5000 net.core.rmem_max = 16777216 net.core.wmem_max = 16777216 net.ipv4.tcp_wmem = 4096 12582912 16777216 net.ipv4.tcp_rmem = 4096 12582912 16777216 net.ipv4.tcp_max_syn_backlog = 8096 net.ipv4.tcp_slow_start_after_idle = 0 net.ipv4.tcp_tw_reuse = 1 net.ipv4.ip_local_port_range = 10240 65535 \u4f7f\u7528 sysctl -p \u547d\u4ee4\u6216\u91cd\u65b0\u542f\u52a8\u8282\u70b9\u4f7f\u66f4\u6539\u751f\u6548\u3002","title":"\u73af\u5883\u914d\u7f6e"},{"location":"3.k8s/7.logging/fluentd/#td-agent","text":"\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 td-agent deb \u5305\u8fdb\u884c\u5b89\u88c5\uff0c\u8fd9\u662f\u7531 Treasure Data, Inc \u548c Calyptia, Inc \u7ef4\u62a4\u7684\u7a33\u5b9a Fluentd \u5206\u53d1\u5305\u3002 Fluentd \u662f\u7528 Ruby \u7f16\u5199\u7684\uff0c\u5177\u6709\u7075\u6d3b\u6027\uff0c\u5bf9\u6027\u80fd\u654f\u611f\u7684\u90e8\u5206\u7528 C \u8bed\u8a00\u7f16\u5199\u3002\u4f46\u662f\uff0c\u4e00\u4e9b\u7528\u6237\u53ef\u80fd\u96be\u4ee5\u5b89\u88c5\u548c\u64cd\u4f5c Ruby \u5b88\u62a4\u7a0b\u5e8f\u3002\u6240\u4ee5 Treasure Data, Inc \u4e13\u95e8\u63d0\u4f9b\u4e86\u4e00\u4e2a Fluentd \u7684\u7a33\u5b9a\u53d1\u884c\u7248\uff0c\u79f0\u4e3a td-agent \u3002 \u6211\u8fd9\u91cc\u662f Ubuntu Focal \u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff1a curl -fsSL https://toolbelt.treasuredata.com/sh/install-ubuntu-focal-td-agent4.sh | sh \u4e0a\u9762\u7684\u811a\u672c\u4f1a\u81ea\u52a8\u914d\u7f6e systemd \u7684\u542f\u52a8\u811a\u672c\uff0c\u811a\u672c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a $ cat /lib/systemd/system/td-agent.service; [Unit] Description=td-agent: Fluentd based data collector for Treasure Data Documentation=https://docs.treasuredata.com/display/public/PD/About+Treasure+Data%%27s+Server-Side+Agent After=network-online.target Wants=network-online.target [Service] User=td-agent Group=td-agent LimitNOFILE=65536 Environment=LD_PRELOAD=/opt/td-agent/lib/libjemalloc.so Environment=GEM_HOME=/opt/td-agent/lib/ruby/gems/2.7.0/ Environment=GEM_PATH=/opt/td-agent/lib/ruby/gems/2.7.0/ Environment=FLUENT_CONF=/etc/td-agent/td-agent.conf Environment=FLUENT_PLUGIN=/etc/td-agent/plugin Environment=FLUENT_SOCKET=/var/run/td-agent/td-agent.sock Environment=TD_AGENT_LOG_FILE=/var/log/td-agent/td-agent.log Environment=TD_AGENT_OPTIONS= EnvironmentFile=-/etc/default/td-agent PIDFile=/var/run/td-agent/td-agent.pid RuntimeDirectory=td-agent Type=forking # XXX: Fix fluentd executables path ExecStart=/opt/td-agent/bin/fluentd --log $TD_AGENT_LOG_FILE --daemon /var/run/td-agent/td-agent.pid $TD_AGENT_OPTIONS ExecStop=/bin/kill -TERM ${MAINPID} ExecReload=/bin/kill -HUP ${MAINPID} Restart=always TimeoutStopSec=120 [Install] WantedBy=multi-user.target \u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 systemctl \u6765\u7ba1\u7406 td-agent \u670d\u52a1\uff1a $ sudo systemctl start td-agent $ sudo systemctl status td-agent \u25cf td-agent.service - td-agent: Fluentd based data collector for Treasure Data Loaded: loaded (/lib/systemd/system/td-agent.service; enabled; vendor preset: enabled) Active: active (running) since Sat 2022-06-11 11:00:04 CST; 4min 6s ago Docs: https://docs.treasuredata.com/display/public/PD/About+Treasure+Data%27s+Server-Side+Agent Process: 3664 ExecStart=/opt/td-agent/bin/fluentd --log $TD_AGENT_LOG_FILE --daemon /var/run/td-agent/td-agent.pid $TD_AGE> Main PID: 3677 (fluentd) Tasks: 9 (limit: 19106) Memory: 99.0M CGroup: /system.slice/td-agent.service \u251c\u25003677 /opt/td-agent/bin/ruby /opt/td-agent/bin/fluentd --log /var/log/td-agent/td-agent.log --daemon /var/run/td> \u2514\u25003680 /opt/td-agent/bin/ruby -Eascii-8bit:ascii-8bit /opt/td-agent/bin/fluentd --log /var/log/td-agent/td-agent.> Jun 11 11:00:03 ydzsio systemd[1]: Starting td-agent: Fluentd based data collector for Treasure Data... Jun 11 11:00:04 ydzsio systemd[1]: Started td-agent: Fluentd based data collector for Treasure Data. lines 1-14/14 (END) td-agent \u542f\u52a8\u540e\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u53d1\u9001\u4e00\u6761\u65e5\u5fd7\uff1a $ curl -X POST -d 'json={\"json\":\"message\"}' http://localhost:8888/debug.test \u53d1\u9001\u540e\u67e5\u770b td-agent \u7684\u65e5\u5fd7\uff0c\u6b63\u5e38\u4f1a\u6536\u5230\u5982\u4e0b\u6240\u793a\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a $ tail -n 1 /var/log/td-agent/td-agent.log 2022-06-11 11:09:02.377608475 +0800 debug.test: {\"json\":\"message\"}","title":"td-agent \u5305"},{"location":"3.k8s/7.logging/fluentd/#docker","text":"\u5f53\u7136\u66f4\u591a\u7684\u65f6\u5019\u4f7f\u7528 Docker \u65b9\u5f0f\u4f7f\u7528 Fluentd \u4f1a\u66f4\u65b9\u4fbf\uff0c\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e00\u4e9b\u7b80\u5355\u7684\u6587\u4ef6\u6765\u8fdb\u884c\u6d4b\u8bd5\uff1a $ mkdir fluentd $ cd fluentd # \u521b\u5efa\u7528\u4e8e\u4fdd\u5b58 fluentd \u7684\u914d\u7f6e\u6587\u4ef6 etc \u76ee\u5f55\u548c\u4fdd\u5b58\u65e5\u5fd7\u7684 logs \u76ee\u5f55 $ mkdir -p etc logs # \u6dfb\u52a0\u4e00\u4e2a\u7b80\u5355\u7684\u914d\u7f6e\u6587\u4ef6 $ cat etc/fluentd_basic.conf <source> @type http port 8888 bind 0.0.0.0 </source> <match test.basic> @type stdout </match> \u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a fluentd \u76ee\u5f55\u7528\u4e8e\u6d4b\u8bd5\uff0c\u5176\u4e2d etc \u76ee\u5f55\u7528\u4e8e\u4fdd\u7559\u914d\u7f6e\u6587\u4ef6\u3001logs \u76ee\u5f55\u4fdd\u5b58\u65e5\u5fd7\uff0c\u9996\u5148\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6700\u57fa\u672c\u7684\u914d\u7f6e\u6587\u4ef6 etc/fluentd_basic.conf \uff0c\u5176\u4e2d\uff1a source \u90e8\u5206\u4f7f\u7528\u4e86 http \u7c7b\u578b\u7684\u8f93\u5165\u63d2\u4ef6\uff0c\u5728 8888 \u7aef\u53e3\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\u7528\u4e8e\u63a5\u6536\u65e5\u5fd7 match \u90e8\u5206\u5b9a\u4e49\u4e86\u65e5\u5fd7\u5339\u914d test.basic \u6807\u7b7e\uff0c\u5c31\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230 stdout \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c Fluentd \u7684\u542f\u52a8\uff1a $ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_basic.conf -v \u8fd9\u91cc\u6211\u4eec\u5c06 etc \u76ee\u5f55\u548c logs \u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u7136\u540e\u901a\u8fc7 -c \u53c2\u6570\u6307\u5b9a Fluentd \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6700\u540e\u4e00\u4e2a -v \u53c2\u6570\u662f\u7528\u4e8e\u8bbe\u7f6e Fluentd \u5f00\u542f verbose \u6a21\u5f0f\uff0c\u4fbf\u4e8e\u67e5\u770b Fluentd \u7684\u65e5\u5fd7\u65b9\u4fbf\u8c03\u8bd5\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\u4fe1\u606f\uff1a 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: parsing config file is succeeded path=\"/fluentd/etc/fluentd_basic.conf\" 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: gem 'fluentd' version '1.14.3' 2022-06-11 07:23:48 +0000 [debug]: fluent/log.rb:309:debug: No fluent logger for internal event 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: using configuration file: <ROOT> <source> @type http port 8888 bind \"0.0.0.0\" </source> <match test.basic> @type stdout </match> </ROOT> 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: starting fluentd-1.14.3 pid=7 ruby=\"2.7.5\" 2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: spawn command to main: cmdline=[\"/usr/bin/ruby\", \"-Eascii-8bit:ascii-8bit\", \"/usr/bin/fluentd\", \"-c\", \"/fluentd/etc/fluentd_basic.conf\", \"-v\", \"--plugin\", \"/fluentd/plugins\", \"--under-supervisor\"] 2022-06-11 07:23:49 +0000 [info]: fluent/log.rb:330:info: adding match pattern=\"test.basic\" type=\"stdout\" 2022-06-11 07:23:49 +0000 [info]: fluent/log.rb:330:info: adding source type=\"http\" 2022-06-11 07:23:49 +0000 [debug]: #0 fluent/log.rb:309:debug: No fluent logger for internal event 2022-06-11 07:23:49 +0000 [info]: #0 fluent/log.rb:330:info: starting fluentd worker pid=16 ppid=7 worker=0 2022-06-11 07:23:49 +0000 [debug]: #0 fluent/log.rb:309:debug: listening http bind=\"0.0.0.0\" port=8888 2022-06-11 07:23:49 +0000 [info]: #0 fluent/log.rb:330:info: fluentd worker is now running worker=0 \u542f\u52a8\u540e\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u53d1\u9001\u4e00\u6761\u65e5\u5fd7\u5230 Fluentd \u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u914d\u7f6e\uff1a $ curl -i -X POST -d 'json={\"action\":\"login\",\"user\":100}' http://localhost:8888/test.logs HTTP/1.1 200 OK Content-Type: text/plain Connection: Keep-Alive Content-Length: 0 \u53d1\u9001\u540e\u6b63\u5e38\u4f1a\u5728 Fluentd \u4e2d\u67e5\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u4e00\u6761\u4fe1\u606f\uff1a 2022-06-11 07:34:29.925695338 +0000 test.logs: {\"action\":\"login\",\"user\":100}","title":"Docker \u65b9\u5f0f"},{"location":"3.k8s/7.logging/fluentd/#_3","text":"Fluentd \u662f\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\uff0c\u4e00\u6761\u65e5\u5fd7\u6d88\u606f\u5728 Fluentd \u4e2d\u88ab\u770b\u6210\u4e00\u4e2a Event \u4e8b\u4ef6\uff0cFluentd \u7684\u4e8b\u4ef6\u4e3b\u8981\u7531\u4e0b\u9762\u4e09\u90e8\u5206\u7ec4\u6210\uff1a \u6807\u7b7e tag\uff1a\u7528\u4e8e\u63cf\u8ff0\u4e8b\u4ef6\u6765\u6e90\uff0c\u53ef\u7528\u4e8e\u540e\u9762\u7684\u4e8b\u4ef6\u8def\u7531 \u65f6\u95f4 time\uff1a\u4e8b\u4ef6\u53d1\u751f\u7684\u65f6\u95f4\uff0c\u65f6\u95f4\u683c\u5f0f\u4e3a Unix \u65f6\u95f4\u6233 \u8bb0\u5f55 record\uff1a\u4e8b\u4ef6\u5185\u5bb9\u672c\u8eab\uff0cJSON \u683c\u5f0f \u6240\u6709\u7684\u8f93\u5165\u63d2\u4ef6\u90fd\u9700\u8981\u89e3\u6790\u539f\u59cb\u65e5\u5fd7\uff0c\u751f\u6210\u6ee1\u8db3\u4e0a\u9762\u7ed3\u6784\u7684\u4e8b\u4ef6\u5b57\u6bb5\uff0c\u6bd4\u5982\u4e00\u6761 Apache \u7684\u8bbf\u95ee\u65e5\u5fd7\uff1a 192.168.0.1 - - [28/Feb/2013:12:00:00 +0900] \"GET / HTTP/1.1\" 200 777 \u5728\u901a\u8fc7 in_tail \u8f93\u5165\u63d2\u4ef6\u5904\u7406\u540e\uff0c\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\u7ed3\u679c\uff1a tag: apache.access # \u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a time: 1362020400 # 28/Feb/2013:12:00:00 +0900 record: {\"user\": \"-\", \"method\": \"GET\", \"code\": 200, \"size\": 777, \"host\": \"192.168.0.1\", \"path\": \"/\"} \u5f53 Fluentd \u6536\u5230\u4e00\u6761\u4e8b\u4ef6\u540e\u4f1a\u7ecf\u8fc7\u4e00\u7cfb\u5217\u7684\u5904\u7406\u6d41\u7a0b\uff1a \u4fee\u6539\u4e8b\u4ef6\u7684\u76f8\u5173\u5b57\u6bb5 \u8fc7\u6ee4\u6389\u4e00\u4e9b\u4e0d\u9700\u8981\u7684\u4e8b\u4ef6 \u8def\u7531\u4e8b\u4ef6\u8f93\u51fa\u5230\u4e0d\u540c\u7684\u5730\u65b9 \u8fc7\u6ee4\u5668 Filter Filter \u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a\u4e8b\u4ef6\u662f\u8be5\u88ab\u63a5\u53d7\u6216\u662f\u88ab\u8fc7\u6ee4\u6389\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\u65b0\u589e\u8fc7\u6ee4\u5668\u3002 $ cat etc/fluentd_filter.conf <source> @type http port 8888 bind 0.0.0.0 </source> <filter test.logs> @type grep <exclude> key action pattern ^logout$ </exclude> </filter> <match test.logs> @type stdout </match> \u5728\u8be5\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u65b0\u589e\u4e86\u4e00\u4e2a filter \u6a21\u5757\uff0c\u4f7f\u7528 grep \u63d2\u4ef6\uff0c exclude \u90e8\u5206\u8868\u793a\u8981\u8fc7\u6ee4\u6389\u7684\u65e5\u5fd7\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u7684\u662f action \u8fd9\u4e2a key \u5339\u914d ^logout$ \u7684\u65f6\u5019\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5c31\u662f\u76f4\u63a5\u8fc7\u6ee4\u6389 logout \u65e5\u5fd7\u4e8b\u4ef6\u3002 \u4f7f\u7528\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u91cd\u65b0\u542f\u52a8 fluentd\uff1a $ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_filter.conf -v \u7136\u540e\u91cd\u65b0\u5411 Fluentd \u63d0\u4ea4\u4e24\u6761\u65e5\u5fd7\u6570\u636e\uff1a $ curl -X POST -d 'json={\"action\":\"login\",\"user\":2}' http://localhost:8888/test.logs $ curl -X POST -d 'json={\"action\":\"logout\",\"user\":2}' http://localhost:8888/test.logs \u6b63\u5e38\u8fd9\u4e2a\u65f6\u5019 Fluentd \u53ea\u4f1a\u6536\u5230\u7b2c\u4e00\u6761\u65e5\u5fd7\u6570\u636e\uff0c logout \u8fd9\u6761\u4e8b\u4ef6\u88ab\u8fc7\u6ee4\u6389\u4e86\uff1a 2022-06-11 07:52:45.555576216 +0000 test.logs: {\"action\":\"login\",\"user\":2} \u6807\u8bc6\u7b26 Labels Fluentd \u7684\u5904\u7406\u6d41\u7a0b\u662f\u6839\u636e\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b9a\u4e49\u4ece\u4e0a\u5230\u4e0b\u4f9d\u6b21\u6267\u884c\u7684\u3002\u4f46\u662f\u5047\u5982\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u591a\u4e2a\u8f93\u5165\u6e90\uff0c\u4e0d\u540c\u7684\u8f93\u5165\u6e90\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684 Filters \u8fc7\u6ee4\u5668\u7684\u65f6\u5019\uff0c\u90a3\u4e48\u8fd8\u6309\u7167\u987a\u5e8f\u6267\u884c\u7684\u65b9\u5f0f\u8bdd\uff0c\u914d\u7f6e\u6587\u4ef6\u5c31\u4f1a\u53d8\u5f97\u975e\u5e38\u590d\u6742\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cFluentd \u4e2d\u63d0\u4f9b\u4e86\u4e00\u79cd\u6807\u8bc6\u7b26 Labels \u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u4e3a\u4e0d\u540c\u7684\u8f93\u5165\u6e90\u6307\u5b9a\u4e0d\u540c\u7684\u5904\u7406\u6d41\u7a0b\u3002 \u5982\u4e0b\u6240\u793a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u914d\u7f6e\u6587\u4ef6 fluentd_labels.conf \uff1a <source> @type http port 8888 bind 0.0.0.0 @label @TEST </source> <filter test.logs> @type grep <exclude> key action pattern ^login$ </exclude> </filter> <label @TEST> <filter test.logs> @type grep <exclude> key action pattern ^logout$ </exclude> </filter> <match test.logs> @type stdout </match> </label> \u9996\u5148\u6211\u4eec\u5728\u8f93\u5165\u6e90\u4e2d\u7ed9\u65e5\u5fd7\u6e90\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6807\u7b7e @label @TEST \uff0c\u7136\u540e\u5148\u5b9a\u4e49\u4e86\u4e00\u4e2a filter \u8fc7\u6ee4\u6389 login \u4e8b\u4ef6\uff0c\u7136\u540e\u5728\u4e00\u4e2a label \u6a21\u5757\u91cc\u9762\u8fc7\u6ee4\u4e86 logout \u4e8b\u4ef6\u3002 \u73b0\u5728\u6211\u4eec\u4f7f\u7528\u8be5\u914d\u7f6e\u91cd\u65b0\u542f\u52a8 Fluentd\uff1a $ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_labels.conf -v \u7136\u540e\u91cd\u65b0\u5411 Fluentd \u63d0\u4ea4\u4e24\u6761\u65e5\u5fd7\u6570\u636e\uff1a $ curl -X POST -d 'json={\"action\":\"login\",\"user\":2}' http://localhost:8888/test.logs $ curl -X POST -d 'json={\"action\":\"logout\",\"user\":2}' http://localhost:8888/test.logs \u6b63\u5e38 Fluentd \u4e2d\u4f1a\u8f93\u51fa\u4e00\u6761\u65e5\u5fd7\u8bb0\u5f55\uff1a 2022-06-11 08:06:41.977559894 +0000 test.logs: {\"action\":\"login\",\"user\":2} \u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u4e3a\u8f93\u5165\u65e5\u5fd7\u8bbe\u7f6e\u4e86 @TEST \u7684\u6807\u7b7e\uff0c\u56e0\u6b64\u8df3\u8fc7\u4e2d\u95f4\u8bbe\u7f6e\u7684\u4e00\u4e9b\u8fc7\u6ee4\u5668\uff0c\u53ea\u8fd0\u884c\u4e86 <label @TEST>...</lable> \u6807\u7b7e\u5757\u91cc\u7684\u8fc7\u6ee4\u5668\uff0c\u5982\u679c\u6807\u7b7e\u5757\u91cc\u9762\u6ca1\u6709\u5b9a\u4e49\u8fc7\u6ee4\u5668\u5219\u5c31\u4e0d\u4f1a\u8fc7\u6ee4\u65e5\u5fd7\u4e86\u3002","title":"\u4e8b\u4ef6\u751f\u547d\u5468\u671f"},{"location":"3.k8s/7.logging/fluentd/#_4","text":"\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u8be6\u7ec6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u4ee5\u4f7f\u7528\u6307\u4ee4\u5305\u62ec\uff1a source \u6307\u4ee4\u786e\u5b9a\u8f93\u5165\u6e90 match \u6307\u4ee4\u786e\u5b9a\u8f93\u51fa\u76ee\u7684\u5730 filter \u6307\u4ee4\u786e\u5b9a\u4e8b\u4ef6\u5904\u7406\u7ba1\u9053 system \u6307\u4ee4\u8bbe\u7f6e\u7cfb\u7edf\u8303\u56f4\u7684\u914d\u7f6e label \u6307\u4ee4\u5bf9\u5185\u90e8\u8def\u7531\u7684\u8f93\u51fa\u548c\u8fc7\u6ee4\u5668\u8fdb\u884c\u5206\u7ec4 @include \u6307\u4ee4\u5305\u542b\u5176\u4ed6\u6587\u4ef6 source \u901a\u8fc7\u4f7f\u7528 source \u6307\u4ee4\u9009\u62e9\u548c\u914d\u7f6e\u6240\u9700\u7684\u8f93\u5165\u63d2\u4ef6\u6765\u542f\u7528 Fluentd \u8f93\u5165\u6e90\uff0cFluentd \u6807\u51c6\u8f93\u5165\u63d2\u4ef6\u5305\u62ec http \u548c forward\u3002 http \u63d0\u4f9b\u4e86\u4e00\u4e2a HTTP \u7aef\u70b9\u6765\u63a5\u53d7\u4f20\u5165\u7684 HTTP \u6d88\u606f\uff0c\u800c forward \u63d0\u4f9b\u4e86\u4e00\u4e2a TCP \u7aef\u70b9\u6765\u63a5\u53d7 TCP \u6570\u636e\u5305\u3002\u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u540c\u65f6\u662f\u4e24\u8005\u3002\u4f8b\u5982\uff1a # \u572824224\u7aef\u53e3\u63a5\u53d7TCP\u4e8b\u4ef6 <source> @type forward port 24224 </source> # http://<ip>:9880/myapp.access?json={\"event\":\"data\"} <source> @type http port 9880 </source> \u8f93\u5165\u6e90\u53ef\u4ee5\u4e00\u6b21\u6307\u5b9a\u591a\u4e2a\uff0c @type \u53c2\u6570\u7528\u6765\u6307\u5b9a\u8f93\u5165\u63d2\u4ef6\uff0c\u8f93\u5165\u63d2\u4ef6\u6269\u5c55\u4e86 Fluentd\uff0c\u4ee5\u68c0\u7d22\u548c\u63d0\u53d6\u6765\u81ea\u5916\u90e8\u7684\u65e5\u5fd7\u4e8b\u4ef6\uff0c\u4e00\u4e2a\u8f93\u5165\u63d2\u4ef6\u901a\u5e38\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u3001\u5957\u63a5\u5b57\u548c\u4e00\u4e2a\u76d1\u542c\u5957\u63a5\u5b57\uff0c\u5b83\u4e5f\u53ef\u4ee5\u88ab\u5199\u6210\u5b9a\u671f\u4ece\u6570\u636e\u6e90\u4e2d\u63d0\u53d6\u6570\u636e\u3002Fluentd \u652f\u6301\u975e\u5e38\u591a\u79cd\u8f93\u5165\u63d2\u4ef6\uff0c\u5305\u62ec\uff1a in_tail in_forward in_udp in_tcp in_unix in_http in_syslog in_exec in_sample in_windows_eventlog tail \u63d2\u4ef6\u5e94\u8be5\u662f\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u5f97\u6700\u591a\u7684\u8f93\u5165\u63d2\u4ef6\u4e86\uff0c in_tail \u8f93\u5165\u63d2\u4ef6\u5141\u8bb8 Fluentd \u4ece\u6587\u672c\u6587\u4ef6\u7684\u5c3e\u90e8\u8bfb\u53d6\u4e8b\u4ef6\uff0c\u5176\u884c\u4e3a\u7c7b\u4f3c\u4e8e tail -F \u547d\u4ee4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u5c31\u5b9a\u4e49\u4e86\u8f93\u5165\u63d2\u4ef6\u4e3a tail \uff0c\u5176\u4e2d\u7684 path \u5c5e\u6027\u6307\u5b9a\u4e86\u65e5\u5fd7\u7684\u6e90\u8def\u5f84\uff1a <source> @type tail path /var/log/httpd-access.log pos_file /var/log/td-agent/httpd-access.log.pos tag apache.access <parse> @type apache2 </parse> </source> \u5f53 Fluentd \u7b2c\u4e00\u6b21\u88ab\u914d\u7f6e\u4e3a in_tail \u65f6\uff0c\u5b83\u5c06\u4ece\u8be5\u65e5\u5fd7\u7684\u5c3e\u90e8\u5f00\u59cb\u8bfb\u53d6\uff0c\u800c\u4e0d\u662f\u4ece\u5f00\u59cb\uff0c\u4e00\u65e6\u65e5\u5fd7\u88ab\u8f6e\u8f6c\uff0cFluentd \u5c31\u4f1a\u4ece\u5934\u5f00\u59cb\u8bfb\u53d6\u65b0\u6587\u4ef6\uff0c\u5b83\u4fdd\u6301\u7740\u5bf9\u5f53\u524d inode \u53f7\u7684\u8ddf\u8e2a\u3002\u5982\u679c Fluentd \u91cd\u65b0\u542f\u52a8\uff0c\u5b83\u4f1a\u4ece\u91cd\u65b0\u542f\u52a8\u524d\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\u7ee7\u7eed\u8bfb\u53d6\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u8bb0\u5f55\u5728 `pos_file`` \u53c2\u6570\u6307\u5b9a\u7684\u4f4d\u7f6e\u6587\u4ef6\u4e2d\u3002 match match \u7528\u6765\u6307\u5b9a\u65e5\u5fd7\u7684\u8f93\u51fa\u76ee\u7684\u5730\uff0c\u4f8b\u5982\uff1a # \u5c06\u6ee1\u8db3 myapp.acccess \u6807\u7b7e\u7684\u4e8b\u4ef6\u5168\u90e8\u8f93\u51fa\u5230 # /var/log/fluent/access.%Y-%m-%d <match myapp.access> @type file path /var/log/fluent/access </match> \u540c\u6837\u8f93\u51fa\u4e5f\u53ef\u4ee5\u4e00\u6b21\u6307\u5b9a\u591a\u4e2a\uff0c @type \u53c2\u6570\u6307\u5b9a\u4f7f\u7528\u54ea\u4e00\u4e2a\u8f93\u51fa\u63d2\u4ef6\u3002Fluentd \u8f93\u51fa\u63d2\u4ef6\u5177\u6709\u4e09\u79cd\u7f13\u51b2\u548c\u5237\u65b0\u6a21\u5f0f\uff1a \u975e\u7f13\u51b2\u6a21\u5f0f \u4e0d\u5bf9\u6570\u636e\u8fdb\u884c\u7f13\u51b2\uff0c\u800c\u662f\u7acb\u5373\u8f93\u51fa\u7ed3\u679c \u540c\u6b65\u7f13\u51b2\u6a21\u5f0f \u6709\u4e00\u4e2a\u6682\u5b58\u7684 staged \u7684\u7f13\u51b2\u5757 chunks\uff08\u4e00\u4e2a chunk \u662f\u4e00\u4e2a\u4e8b\u4ef6\u7684\u96c6\u5408\uff09\u548c\u4e00\u4e2a chunk \u961f\u5217\uff0c\u5176\u884c\u4e3a\u53ef\u4ee5\u7531 <buffer> \u90e8\u5206\u63a7\u5236 \u5f02\u6b65\u7f13\u51b2\u6a21\u5f0f \u4e5f\u6709\u6682\u5b58\u548c\u961f\u5217\uff0c\u4f46\u8f93\u51fa\u63d2\u4ef6\u4e0d\u4f1a\u5728\u65b9\u6cd5\u4e2d\u540c\u6b65\u63d0\u4ea4\u5199\u5757\uff0c\u800c\u662f\u7a0d\u540e\u63d0\u4ea4 \u8f93\u51fa\u63d2\u4ef6\u53ef\u4ee5\u652f\u6301\u6240\u6709\u7684\u6a21\u5f0f\uff0c\u4f46\u53ef\u80fd\u53ea\u652f\u6301\u5176\u4e2d\u4e00\u79cd\u6a21\u5f0f\uff0c\u5982\u679c\u914d\u7f6e\u4e2d\u6ca1\u6709 <buffer> \u90e8\u5206\uff0cFluentd \u4f1a\u81ea\u52a8\u9009\u62e9\u5408\u9002\u7684\u6a21\u5f0f\u3002\u540c\u6837 Fluentd \u652f\u6301\u591a\u79cd\u8f93\u51fa\u63d2\u4ef6, \u6bd4\u5982: out_copy out_null out_roundrobin out_stdout out_exec_filter out_forward out_mongo / out_mongo_replset out_exec out_file out_s3 out_webhdfs ...... \u6bd4\u5982\u6211\u4eec\u4f7f\u7528 out_file \u4f5c\u4e3a\u8f93\u51fa\u76ee\u7684\u5730\u63d2\u4ef6\uff0c out_file \u8f93\u51fa\u63d2\u4ef6\u5c06\u4e8b\u4ef6\u5199\u5165\u6587\u4ef6\u3002\u5f53\u6ee1\u8db3 timekey \u6761\u4ef6\u65f6\uff0c\u5c06\u521b\u5efa\u8be5\u6587\u4ef6\uff0c\u8981\u6539\u53d8\u8f93\u51fa\u9891\u7387\uff0c\u9700\u8981\u4fee\u6539 timekey \u7684\u503c\uff0c\u5982\u4e0b\u6240\u793a\uff1a <match pattern> @type file path /var/log/fluent/myapp compress gzip <buffer> timekey 1d timekey_use_utc true timekey_wait 10m </buffer> </match> filter \u4f7f\u7528 filter \u53ef\u4ee5\u6307\u5b9a\u4e8b\u4ef6\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u591a\u4e2a filter \u53ef\u4ee5\u4e32\u8054\u8d77\u6765\u4f7f\u7528\uff1a Input -> filter 1 -> ... -> filter N -> Output \u6bd4\u5982\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a\u6807\u51c6\u7684 record_transformer \u8fc7\u6ee4\u5668\u6765\u5339\u914d\u4e8b\u4ef6\u3002 1 # http://this.host:9880/myapp.access?json={\"event\":\"data\"} <source> @type http port 9880 </source> <filter myapp.access> @type record_transformer <record> host_param \"#{Socket.gethostname}\" </record> </filter> <match myapp.access> @type file path /var/log/fluent/access </match> \u63a5\u6536\u5230\u7684\u4e8b\u4ef6 {\"event\":\"data\"} \u9996\u5148\u8fdb\u5165 record_transformer \u8fc7\u6ee4\u5668\uff0c\u8be5\u8fc7\u6ee4\u5668\u5c06 host_param \u5b57\u6bb5\u6dfb\u52a0\u5230\u4e8b\u4ef6\u4e2d\uff0c\u7136\u540e\u8fc7\u6ee4\u540e\u7684\u4e8b\u4ef6\u53d8\u4e3a {\"event\":\"data\",\"host_param\":\"webserver1\"} \u8fdb\u5165 file \u6587\u4ef6\u8f93\u51fa\u63d2\u4ef6\u3002 system \u7cfb\u7edf\u8303\u56f4\u7684\u914d\u7f6e\u7531 system \u6307\u4ee4\u8bbe\u7f6e\uff0c\u5b83\u4eec\u4e2d\u7684\u5927\u591a\u6570\u4e5f\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u9009\u9879\u83b7\u5f97\u3002\u4f8b\u5982\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\uff1a log_level suppress_repeated_stacktrace emit_error_log_interval suppress_config_dump without_source process_name (\u4ec5\u5728 system \u6307\u4ee4\u4e2d\u53ef\u7528\uff0c\u6ca1\u6709 fluentd \u9009\u9879) \u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\uff1a <system> # \u7b49\u540c\u4e8e -qq \u9009\u9879 log_level error # \u7b49\u540c\u4e8e --without-source \u9009\u9879 without_source # ... </system> \u6b64\u5916\u5982\u679c\u8bbe\u7f6e\u4e86 process_name \u53c2\u6570\uff0c\u5219 fluentd supervisor \u548c\u5de5\u4f5c\u8fdb\u7a0b\u540d\u79f0\u5c06\u66f4\u6539\u3002 <system> process_name fluentd1 </system> \u4f7f\u7528\u6b64\u914d\u7f6e\uff0c ps \u547d\u4ee4\u663e\u793a\u4ee5\u4e0b\u7ed3\u679c\uff1a % ps aux | grep fluentd1 foo 45673 0.4 0.2 2523252 38620 s001 S+ 7:04AM 0:00.44 worker:fluentd1 foo 45647 0.0 0.1 2481260 23700 s001 S+ 7:04AM 0:00.40 supervisor:fluentd1 label label \u6307\u4ee4\u53ef\u4ee5\u5bf9\u5185\u90e8\u8def\u7531\u7684\u8fc7\u6ee4\u5668\u548c\u8f93\u51fa\u8fdb\u884c\u5206\u7ec4\uff0c label \u964d\u4f4e\u4e86 tag \u5904\u7406\u7684\u590d\u6742\u6027\u3002 label \u53c2\u6570\u662f\u5185\u7f6e\u63d2\u4ef6\u53c2\u6570\uff0c\u56e0\u6b64\u9700\u8981 @ \u524d\u7f00\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\uff1a <source> @type forward </source> <source> @type tail @label @SYSTEM </source> <filter access.**> @type record_transformer <record> # ... </record> </filter> <match **> @type elasticsearch # ... </match> <label @SYSTEM> <filter var.log.middleware.**> @type grep # ... </filter> <match **> @type s3 # ... </match> </label> \u5728\u8be5\u914d\u7f6e\u4e2d\uff0c forward \u4e8b\u4ef6\u88ab\u8def\u7531\u5230 record_transformer \u8fc7\u6ee4\u5668\uff0c\u7136\u540e\u8f93\u51fa\u5230 elasticsearch \uff0c\u800c in_tail \u4e8b\u4ef6\u88ab\u8def\u7531\u5230 @SYSTEM \u6807\u7b7e\u5185\u7684 grep \u8fc7\u6ee4\u5668\uff0c\u7136\u540e\u8f93\u51fa\u5230 s3\u3002 label \u53c2\u6570\u5bf9\u4e8e\u6ca1\u6709 tag \u524d\u7f00\u7684\u4e8b\u4ef6\u6d41\u5206\u79bb\u5f88\u6709\u7528\u3002 @ERROR \u6807\u7b7e\u662f\u4e00\u4e2a\u5185\u7f6e\u6807\u7b7e\uff0c\u7528\u4e8e\u63d2\u4ef6\u7684 emit_error_event API \u53d1\u51fa\u7684\u9519\u8bef\u8bb0\u5f55\u3002\u5982\u679c\u8bbe\u7f6e\u4e86 <label @ERROR> \uff0c\u5219\u5728\u53d1\u51fa\u76f8\u5173\u9519\u8bef\u65f6\u5c06\u4e8b\u4ef6\u8def\u7531\u5230\u6b64\u6807\u7b7e\uff0c\u4f8b\u5982\u7f13\u51b2\u533a\u5df2\u6ee1\u6216\u8bb0\u5f55\u65e0\u6548\u3002 @ROOT \u6807\u7b7e\u4e5f\u662f\u4e00\u4e2a\u5185\u7f6e\u6807\u7b7e\uff0c\u7528\u4e8e\u901a\u8fc7\u63d2\u4ef6\u7684 event_emitter_router API \u83b7\u53d6\u6839\u8def\u7531\u5668\u3002\u4ece v1.14.0 \u5f00\u59cb\u5f15\u5165\u6b64\u6807\u7b7e\uff0c\u4ee5\u5c06\u6807\u7b7e\u5206\u914d\u56de\u9ed8\u8ba4\u8def\u7531\uff0c\u4f8b\u5982\uff0c\u7531 concat \u8fc7\u6ee4\u5668\u5904\u7406\u7684\u8d85\u65f6\u4e8b\u4ef6\u8bb0\u5f55\u53ef\u4ee5\u53d1\u9001\u5230\u9ed8\u8ba4\u8def\u7531\u3002 @include \u4f7f\u7528 @include \u6307\u4ee4\u53ef\u4ee5\u5bfc\u5165\u5355\u72ec\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6307\u4ee4\uff0c\u4f8b\u5982\uff1a # \u5305\u542b ./config.d \u76ee\u5f55\u4e2d\u7684\u6240\u6709\u914d\u7f6e\u6587\u4ef6 @include config.d/*.conf @include \u6307\u4ee4\u652f\u6301\u5e38\u89c4\u6587\u4ef6\u8def\u5f84\u3001glob \u6a21\u5f0f\u548c http URL \u7ea6\u5b9a\uff1a # \u7edd\u5bf9\u8def\u5f84 @include /path/to/config.conf # \u5982\u679c\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\uff0c\u6307\u4ee4\u5c06\u4f7f\u7528\u6b64\u914d\u7f6e\u6587\u4ef6\u7684\u76ee\u5f55\u540d\u6765\u6269\u5c55\u8def\u5f84 @include extra.conf # glob \u5339\u914d\u6a21\u5f0f @include config.d/*.conf # http @include http://example.com/fluent.conf parse \u4e00\u4e9b Fluentd \u63d2\u4ef6\u652f\u6301 <parse> \u6307\u4ee4\u6765\u6307\u5b9a\u5982\u4f55\u89e3\u6790\u539f\u59cb\u65e5\u5fd7\u6570\u636e\u3002 <parse> \u6307\u4ee4\u53ef\u4ee5\u5728 <source> \u3001 <match> \u6216 <filter> \u4e0b\u914d\u7f6e\uff0c\u4f8b\u5982\uff1a <source> @type tail path /path/to/input/file <parse> @type nginx keep_time_key true </parse> </source> <parse> \u4e2d\u901a\u8fc7 @type \u53c2\u6570\u6765\u6307\u5b9a\u89e3\u6790\u5668\u63d2\u4ef6\u7684\u7c7b\u578b\u3002 Fluentd \u5185\u7f6e\u4e86\u4e00\u4e9b\u6709\u7528\u7684\u89e3\u6790\u5668\u63d2\u4ef6\uff0c\u5305\u62ec\uff1a regexp apache2 apache_error nginx syslog csv tsv ltsv json multiline none \u8fd8\u6709\u4e00\u4e9b\u7b2c\u4e09\u65b9\u7684\u89e3\u6790\u5668\u63d2\u4ef6\uff1a grok\uff1a\u5982\u679c\u4f60\u719f\u6089 grok \u6a21\u5f0f\uff0c\u5219 grok-parser \u63d2\u4ef6\u5f88\u6709\u7528 multi-format-parser\uff1a\u5982\u679c\u4f60\u9700\u8981\u5728\u4e00\u4e2a\u6570\u636e\u6d41\u4e2d\u89e3\u6790\u591a\u79cd\u683c\u5f0f\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u89e3\u6790\u5668 protobuf\uff1aprotocol buffers avro\uff1aApache Avro \u6bd4\u5982\u6211\u4eec\u7684\u65e5\u5fd7\u4e8b\u4ef6\u4e2d\u6709\u5305\u542b\u591a\u884c\u65e5\u5fd7\u7684\u6570\u636e\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 multiline \u8fd9\u4e2a\u89e3\u6790\u5668\u6765\u89e3\u51b3\uff0c\u8be5\u63d2\u4ef6\u53ef\u4ee5\u7528\u6765\u89e3\u6790\u591a\u884c\u65e5\u5fd7\u3002\u8fd9\u4e2a\u63d2\u4ef6\u662f\u6b63\u5219\u8868\u8fbe\u5f0f\u89e3\u6790\u5668\u7684\u591a\u884c\u7248\u672c\u3002 \u591a\u884c\u89e3\u6790\u5668\u4f7f\u7528 formatN \u548c format_firstline \u53c2\u6570\u89e3\u6790\u65e5\u5fd7\uff0c format_firstline \u7528\u4e8e\u68c0\u6d4b\u591a\u884c\u65e5\u5fd7\u7684\u8d77\u59cb\u884c\u3002 formatN \uff0c\u5176\u4e2d N \u7684\u8303\u56f4\u662f [1..20]\uff0c\u662f\u591a\u884c\u65e5\u5fd7\u7684 Regexp \u683c\u5f0f\u5217\u8868\u3002 \u4e0e\u5176\u4ed6\u89e3\u6790\u5668\u63d2\u4ef6\u4e0d\u540c\uff0c\u6b64\u63d2\u4ef6\u9700\u8981\u8f93\u5165\u63d2\u4ef6\u4e2d\u7684\u7279\u6b8a\u4ee3\u7801\uff0c\u4f8b\u5982\u5904\u7406 format_firstline \u3002\u76ee\u524d\uff0cin_tail \u63d2\u4ef6\u9002\u7528\u4e8e\u591a\u884c\uff0c\u4f46\u5176\u4ed6\u8f93\u5165\u63d2\u4ef6\u4e0d\u9002\u7528\u4e8e\u5b83\u3002 \u6bd4\u5982\u6709\u4e00\u6761\u5982\u4e0b\u6240\u793a\u7684\u8f93\u5165\u65e5\u5fd7\uff1a Started GET \"/users/123/\" for 127.0.0.1 at 2013-06-14 12:00:11 +0900 Processing by UsersController#show as HTML Parameters: {\"user_id\"=>\"123\"} Rendered users/show.html.erb within layouts/application (0.3ms) Completed 200 OK in 4ms (Views: 3.2ms | ActiveRecord: 0.0ms) \u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\u6765\u8fdb\u884c\u89e3\u6790\uff1a <parse> @type multiline format_firstline /^Started/ format1 /Started (?<method>[^ ]+) \"(?<path>[^\"]+)\" for (?<host>[^ ]+) at (?<time>[^ ]+ [^ ]+ [^ ]+)\\n/ format2 /Processing by (?<controller>[^\\u0023]+)\\u0023(?<controller_method>[^ ]+) as (?<format>[^ ]+?)\\n/ format3 /( Parameters: (?<parameters>[^ ]+)\\n)?/ format4 / Rendered (?<template>[^ ]+) within (?<layout>.+) \\([\\d\\.]+ms\\)\\n/ format5 /Completed (?<code>[^ ]+) [^ ]+ in (?<runtime>[\\d\\.]+)ms \\(Views: (?<view_runtime>[\\d\\.]+)ms \\| ActiveRecord: (?<ar_runtime>[\\d\\.]+)ms\\)/ </parse> \u5176\u4e2d\u7684 format_firstline /^Started/ \u7528\u6765\u6307\u5b9a\u7b2c\u4e00\u884c\u65e5\u5fd7\u7684\u5339\u914d\u89c4\u5219\uff0c formatN \u6307\u5b9a\u540e\u9762\u51e0\u884c\u7684\u5339\u914d\u89c4\u5219\uff0c\u6700\u540e\u53ef\u4ee5\u89e3\u6790\u6210\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\uff1a time: 1371178811 (2013-06-14 12:00:11 +0900) record: { \"method\" :\"GET\", \"path\" :\"/users/123/\", \"host\" :\"127.0.0.1\", \"controller\" :\"UsersController\", \"controller_method\":\"show\", \"format\" :\"HTML\", \"parameters\" :\"{ \\\"user_id\\\":\\\"123\\\"}\", ... } \u540c\u6837\u6709\u5982\u4e0b\u6240\u793a\u7684 JAVA \u65e5\u5fd7\u4e8b\u4ef6\uff1a 2013-3-03 14:27:33 [main] INFO Main - Start 2013-3-03 14:27:33 [main] ERROR Main - Exception javax.management.RuntimeErrorException: null at Main.main(Main.java:16) ~[bin/:na] 2013-3-03 14:27:33 [main] INFO Main - End \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u914d\u7f6e\u6765\u89e3\u6790\uff1a <parse> @type multiline format_firstline /\\d{4}-\\d{1,2}-\\d{1,2}/ format1 /^(?<time>\\d{4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}) \\[(?<thread>.*)\\] (?<level>[^\\s]+)(?<message>.*)/ </parse> \u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u6790\u6210\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\u4e86\uff1a time: 2013-03-03 14:27:33 +0900 record: { \"thread\" :\"main\", \"level\" :\"INFO\", \"message\":\" Main - Start\" } time: 2013-03-03 14:27:33 +0900 record: { \"thread\" :\"main\", \"level\" :\"ERROR\", \"message\":\" Main - Exception\\njavax.management.RuntimeErrorException: null\\n at Main.main(Main.java:16) ~[bin/:na]\" } time: 2013-03-03 14:27:33 +0900 record: { \"thread\" :\"main\", \"level\" :\"INFO\", \"message\":\" Main - End\" }","title":"\u914d\u7f6e\u6587\u4ef6"},{"location":"3.k8s/7.logging/fluentd/#_5","text":"\u5982\u4e0a\u6240\u8ff0\uff0cFluentd \u5141\u8bb8\u4f60\u6839\u636e\u4e8b\u4ef6\u7684 tag \u6765\u8def\u7531\u4e8b\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u660e\u786e\u6307\u5b9a\u9700\u8981\u5904\u7406\u7684 tag\uff0c\u6bd4\u5982 <filter app.log> \u6765\u6307\u5b9a\u53ea\u5904\u7406 tag \u4e3a app.log \u7684\u4e8b\u4ef6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 filter \u548c match \u4e2d\u901a\u8fc7\u901a\u914d\u7b26\uff0c\u6765\u5904\u7406\u540c\u4e00\u7c7b tag \u7684\u4e8b\u4ef6\u3002 tag \u901a\u5e38\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u7531 . \u5206\u9694\uff0c\u6bd4\u5982 myapp.access \uff1a * : \u5339\u914d\u6ee1\u8db3\u4e00\u4e2a tag \u90e8\u5206\u7684\u4e8b\u4ef6, \u6bd4\u5982: a.* \u5c06\u5339\u914d a.b \u8fd9\u6837\u7684 tag, \u4f46\u662f\u4e0d\u4f1a\u5904\u7406 a \u6216\u8005 a.b.c \u8fd9\u7c7b tag ** : \u5339\u914d\u6ee1\u8db3 0 \u4e2a\u6216\u591a\u4e2a tag \u90e8\u5206\u7684\u4e8b\u4ef6\uff0c\u6bd4\u5982 a.** \u5c06\u5339\u914d a\u3001a.b\u3001a.b.c \u8fd9\u4e09\u79cd tag {X, Y, Z} : \u5339\u914d\u6ee1\u8db3 X\u3001Y \u6216\u8005 Z \u7684 tag\uff0c\u6bd4\u5982 {a, b} \u5c06\u5339\u914d a \u6216\u8005 b\uff0c\u4f46\u662f\u4e0d\u4f1a\u5339\u914d c\uff0c\u8fd9\u79cd\u683c\u5f0f\u4e5f\u53ef\u4ee5\u548c\u901a\u914d\u7b26\u7ec4\u5408\u4f7f\u7528,\u6bd4\u5982 a.{b.c}.* \u6216 a.{b.c}.** #{...} \u4f1a\u628a\u82b1\u62ec\u53f7\u5185\u7684\u5b57\u7b26\u4e32\u5f53\u505a\u662f ruby \u7684\u8868\u8fbe\u5f0f\u5904\u7406\u3002\u6bd4\u5982 @type stdout \u5982\u679c\u8bbe\u7f6e\u4e86\u73af\u5883\u53d8\u91cf FLUENTD_TAG \u4e3a dev,\u90a3\u4e0a\u9762\u7b49\u4ef7\u4e8e app.dev \u3002 \u5f53\u6307\u5b9a\u4e86\u591a\u4e2a\u6a21\u5f0f\u65f6\uff08\u4f7f\u7528\u4e00\u4e2a\u6216\u591a\u4e2a\u7a7a\u683c\u5206\u5f00\uff09\uff0c\u53ea\u8981\u6ee1\u8db3\u5176\u4e2d\u4efb\u610f\u4e00\u4e2a\u5c31\u884c\u3002\u6bd4\u5982: <match a b> \u5339\u914d a \u548c b\uff0c <match a.** b.*> \u5339\u914d a, a.b, a.b.c, b.d \u7b49 \u5f53\u6709\u591a\u4e2a match\uff0c\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\u5b83\u4eec\u7684\u987a\u5e8f\uff0c\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff0c\u7b2c\u4e8c\u4e2a match \u6c38\u8fdc\u4e5f\u4e0d\u4f1a\u751f\u6548\uff1a # ** \u5339\u914d\u6240\u6709\u7684 tags. Bad :( <match **> @type blackhole_plugin </match> <match myapp.access> @type file path /var/log/fluent/access </match> \u6b63\u786e\u7684\u5199\u53d1\u5e94\u8be5\u662f\u5c06\u786e\u5b9a\u7684 tag \u5c3d\u91cf\u5199\u5728\u524d\u9762\uff0c\u6a21\u7cca\u5339\u914d\u7684\u5199\u5728\u540e\u9762\u3002 <match myapp.access> @type file path /var/log/fluent/access </match> # Capture all unmatched tags. Good :) <match **> @type blackhole_plugin </match> \u53e6\u5916\u9700\u8981\u6ce8\u610f\u987a\u5e8f\u7684\u662f filter \u548c match\uff0c\u5982\u679c\u5c06 filter \u653e\u5728 match \u4e4b\u540e\uff0c\u90a3\u4e48\u5b83\u4e5f\u6c38\u8fdc\u4e0d\u4f1a\u751f\u6548\u3002 \u5173\u4e8e Fluentd \u7684\u66f4\u591a\u4f7f\u7528\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\u4e86\u89e3\u66f4\u591a\u4fe1\u606f https://docs.fluentd.org \u3002","title":"\u6a21\u5f0f\u5339\u914d"},{"location":"3.k8s/7.logging/logql/","text":"LogQL \u00b6 LogQL \u00b6 \u53d7 PromQL \u7684\u542f\u53d1\uff0cLoki \u4e5f\u6709\u81ea\u5df1\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u79f0\u4e3a LogQL\uff0c\u5b83\u5c31\u50cf\u4e00\u4e2a\u5206\u5e03\u5f0f\u7684 grep\uff0c\u53ef\u4ee5\u805a\u5408\u67e5\u770b\u65e5\u5fd7\u3002\u548c PromQL \u4e00\u6837\uff0cLogQL \u4e5f\u662f\u4f7f\u7528\u6807\u7b7e\u548c\u8fd0\u7b97\u7b26\u8fdb\u884c\u8fc7\u6ee4\u7684\uff0c\u4e3b\u8981\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u67e5\u8be2\u529f\u80fd\uff1a \u67e5\u8be2\u8fd4\u56de\u65e5\u5fd7\u884c\u5185\u5bb9 \u901a\u8fc7\u8fc7\u6ee4\u89c4\u5219\u5728\u65e5\u5fd7\u6d41\u4e2d\u8ba1\u7b97\u76f8\u5173\u7684\u5ea6\u91cf\u6307\u6807 \u65e5\u5fd7\u67e5\u8be2 \u00b6 \u4e00\u4e2a\u57fa\u672c\u7684\u65e5\u5fd7\u67e5\u8be2\u7531\u4e24\u90e8\u5206\u7ec4\u6210\u3002 log stream selector \uff08\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\uff09 log pipeline \uff08\u65e5\u5fd7\u7ba1\u9053\uff09 \u7531\u4e8e Loki \u7684\u8bbe\u8ba1\uff0c\u6240\u6709 LogQL \u67e5\u8be2\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u3002\u4e00\u4e2a Log Stream \u4ee3\u8868\u4e86\u5177\u6709\u76f8\u540c\u5143\u6570\u636e(Label \u96c6)\u7684\u65e5\u5fd7\u6761\u76ee\u3002 \u65e5\u5fd7\u6d41\u9009\u62e9\u5668 \u51b3\u5b9a\u4e86\u6709\u591a\u5c11\u65e5\u5fd7\u5c06\u88ab\u641c\u7d22\u5230\uff0c\u4e00\u4e2a\u66f4\u7ec6\u7c92\u5ea6\u7684\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u5c06\u641c\u7d22\u5230\u6d41\u7684\u6570\u91cf\u51cf\u5c11\u5230\u4e00\u4e2a\u53ef\u7ba1\u7406\u7684\u6570\u91cf\uff0c\u901a\u8fc7\u7cbe\u7ec6\u7684\u5339\u914d\u65e5\u5fd7\u6d41\uff0c\u53ef\u4ee5\u5927\u5e45\u51cf\u5c11\u67e5\u8be2\u671f\u95f4\u5e26\u6765\u8d44\u6e90\u6d88\u8017\u3002 \u800c\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u540e\u9762\u7684 \u65e5\u5fd7\u7ba1\u9053 \u662f\u53ef\u9009\u7684\uff0c\u7528\u4e8e\u8fdb\u4e00\u6b65\u5904\u7406\u548c\u8fc7\u6ee4\u65e5\u5fd7\u6d41\u4fe1\u606f\uff0c\u5b83\u7531\u4e00\u7ec4\u8868\u8fbe\u5f0f\u7ec4\u6210\uff0c\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u90fd\u4ee5\u4ece\u5de6\u5230\u53f3\u7684\u987a\u5e8f\u4e3a\u6bcf\u4e2a\u65e5\u5fd7\u884c\u6267\u884c\u76f8\u5173\u8fc7\u6ee4\uff0c\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u90fd\u53ef\u4ee5\u8fc7\u6ee4\u3001\u89e3\u6790\u548c\u6539\u53d8\u65e5\u5fd7\u884c\u5185\u5bb9\u4ee5\u53ca\u5404\u81ea\u7684\u6807\u7b7e\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u663e\u793a\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684\u65e5\u5fd7\u67e5\u8be2\u7684\u64cd\u4f5c\uff1a {container=\"query-frontend\",namespace=\"loki-dev\"} |= \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \u8be5\u67e5\u8be2\u8bed\u53e5\u7531\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a \u4e00\u4e2a\u65e5\u5fd7\u6d41\u9009\u62e9\u5668 {container=\"query-frontend\",namespace=\"loki-dev\"} \uff0c\u7528\u4e8e\u8fc7\u6ee4 loki-dev \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 query-frontend \u5bb9\u5668\u7684\u65e5\u5fd7 \u7136\u540e\u540e\u9762\u8ddf\u7740\u4e00\u4e2a\u65e5\u5fd7\u7ba1\u9053 |= \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \uff0c\u8be5\u7ba1\u9053\u8868\u793a\u5c06\u7b5b\u9009\u51fa\u5305\u542b metrics.go \u8fd9\u4e2a\u8bcd\u7684\u65e5\u5fd7\uff0c\u7136\u540e\u89e3\u6790\u6bcf\u4e00\u884c\u65e5\u5fd7\u63d0\u53d6\u66f4\u591a\u7684\u8868\u8fbe\u5f0f\u5e76\u8fdb\u884c\u8fc7\u6ee4 \u4e3a\u4e86\u907f\u514d\u8f6c\u4e49\u7279\u8272\u5b57\u7b26\uff0c\u4f60\u53ef\u4ee5\u5728\u5f15\u7528\u5b57\u7b26\u4e32\u7684\u65f6\u5019\u4f7f\u7528\u5355\u5f15\u53f7\uff0c\u800c\u4e0d\u662f\u53cc\u5f15\u53f7\uff0c\u6bd4\u5982 \\w+1 \u4e0e \"\\w+\" \u662f\u76f8\u540c\u7684\u3002 Log Stream Selector \u00b6 \u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u65e5\u5fd7\u6d41\u5e94\u8be5\u88ab\u5305\u542b\u5728\u4f60\u7684\u67e5\u8be2\u7ed3\u679c\u4e2d\uff0c\u9009\u62e9\u5668\u7531 \u4e00\u4e2a\u6216\u591a\u4e2a\u952e\u503c\u5bf9 \u7ec4\u6210\uff0c\u5176\u4e2d\u6bcf\u4e2a\u952e\u662f\u4e00\u4e2a \u65e5\u5fd7\u6807\u7b7e \uff0c\u6bcf\u4e2a\u503c\u662f\u8be5\u6807\u7b7e\u7684\u503c\u3002 \u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u662f\u901a\u8fc7\u5c06\u952e\u503c\u5bf9\u5305\u88f9\u5728\u4e00\u5bf9\u5927\u62ec\u53f7\u4e2d\u7f16\u5199\u7684\uff0c\u6bd4\u5982\uff1a {app=\"mysql\", name=\"mysql-backup\"} \u4e0a\u9762\u8fd9\u4e2a\u793a\u4f8b\u8868\u793a\uff0c\u6240\u6709\u6807\u7b7e\u4e3a app \u4e14\u5176\u503c\u4e3a mysql \u548c\u6807\u7b7e\u4e3a name \u4e14\u5176\u503c\u4e3a mysql-backup \u7684\u65e5\u5fd7\u6d41\u5c06\u88ab\u5305\u62ec\u5728\u67e5\u8be2\u7ed3\u679c\u4e2d\u3002 \u5176\u4e2d\u6807\u7b7e\u540d\u540e\u9762\u7684 = \u8fd0\u7b97\u7b26\u662f\u4e00\u4e2a\u6807\u7b7e\u5339\u914d\u8fd0\u7b97\u7b26\uff0cLogQL \u4e2d\u4e00\u5171\u652f\u6301\u4ee5\u4e0b\u51e0\u79cd\u6807\u7b7e\u5339\u914d\u8fd0\u7b97\u7b26\uff1a = : \u5b8c\u5168\u5339\u914d != : \u4e0d\u76f8\u7b49 =~ : \u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d !~ : \u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d \u4f8b\u5982\uff1a {name=~\"mysql.+\"} {name!~\"mysql.+\"} {name!~\"mysql-\\\\d+\"} \u9002\u7528\u4e8e Prometheus \u6807\u7b7e\u9009\u62e9\u5668 \u7684\u89c4\u5219\u540c\u6837\u9002\u7528\u4e8e Loki \u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u3002 Log Pipeline \u00b6 \u65e5\u5fd7\u7ba1\u9053\u53ef\u4ee5\u9644\u52a0\u5230\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u4e0a\uff0c\u4ee5\u8fdb\u4e00\u6b65\u5904\u7406\u548c\u8fc7\u6ee4\u65e5\u5fd7\u6d41\u3002 \u5b83\u901a\u5e38\u7531\u4e00\u4e2a\u6216\u591a\u4e2a\u8868\u8fbe\u5f0f\u7ec4\u6210\uff0c\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u9488\u5bf9\u6bcf\u4e2a\u65e5\u5fd7\u884c\u4f9d\u6b21\u6267\u884c\u3002 \u5982\u679c\u4e00\u4e2a\u8868\u8fbe\u5f0f\u8fc7\u6ee4\u6389\u4e86\u65e5\u5fd7\u884c\uff0c\u5219\u7ba1\u9053\u5c06\u5728\u6b64\u5904\u505c\u6b62\u5e76\u5f00\u59cb\u5904\u7406\u4e0b\u4e00\u884c\u3002\u4e00\u4e9b\u8868\u8fbe\u5f0f\u53ef\u4ee5\u6539\u53d8\u65e5\u5fd7\u5185\u5bb9\u548c\u5404\u81ea\u7684\u6807\u7b7e\uff0c\u7136\u540e\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u5904\u7406\u540e\u7eed\u8868\u8fbe\u5f0f\u6216\u6307\u6807\u67e5\u8be2\u3002 \u4e00\u4e2a\u65e5\u5fd7\u7ba1\u9053\u53ef\u4ee5\u7531\u4ee5\u4e0b\u90e8\u5206\u7ec4\u6210\u3002 \u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f \u89e3\u6790\u5668\u8868\u8fbe\u5f0f \u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f \u65e5\u5fd7\u884c\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f \u6807\u7b7e\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f Unwrap \u8868\u8fbe\u5f0f \u5176\u4e2d unwrap \u8868\u8fbe\u5f0f\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u8868\u8fbe\u5f0f\uff0c\u53ea\u80fd\u5728\u5ea6\u91cf\u67e5\u8be2\u4e2d\u4f7f\u7528\u3002 \u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f \u00b6 \u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u7528\u4e8e\u5bf9\u5339\u914d\u65e5\u5fd7\u6d41\u4e2d\u7684\u805a\u5408\u65e5\u5fd7\u8fdb\u884c\u5206\u5e03\u5f0f grep\u3002 \u7f16\u5199\u5165\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a \u641c\u7d22\u8868\u8fbe\u5f0f \u8fdb\u4e00\u6b65\u8fc7\u6ee4\u5f97\u5230\u7684\u65e5\u5fd7\u6570\u636e\u96c6\uff0c\u641c\u7d22\u8868\u8fbe\u5f0f\u53ef\u4ee5\u662f\u6587\u672c\u6216\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6bd4\u5982\uff1a {job=\"mysql\"} |= \"error\" {name=\"kafka\"} |~ \"tsdb-ops.*io:2003\" {name=\"cassandra\"} |~ \"error=\\\\w+\" {instance=~\"kafka-[23]\",name=\"kafka\"} != \"kafka.server:type=ReplicaManager\" \u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 |= \u3001 |~ \u548c != \u662f \u8fc7\u6ee4\u8fd0\u7b97\u7b26 \uff0c\u652f\u6301\u4e0b\u9762\u51e0\u79cd\uff1a |= \uff1a\u65e5\u5fd7\u884c\u5305\u542b\u7684\u5b57\u7b26\u4e32 != \uff1a\u65e5\u5fd7\u884c\u4e0d\u5305\u542b\u7684\u5b57\u7b26\u4e32 |~ \uff1a\u65e5\u5fd7\u884c\u5339\u914d\u6b63\u5219\u8868\u8fbe\u5f0f !~ \uff1a\u65e5\u5fd7\u884c\u4e0e\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d \u8fc7\u6ee4\u8fd0\u7b97\u7b26\u53ef\u4ee5\u662f\u94fe\u5f0f\u7684\uff0c\u5e76\u5c06\u6309\u987a\u5e8f\u8fc7\u6ee4\u8868\u8fbe\u5f0f\uff0c\u4ea7\u751f\u7684\u65e5\u5fd7\u884c\u5fc5\u987b\u6ee1\u8db3\u6bcf\u4e2a\u8fc7\u6ee4\u5668\u3002\u5f53\u4f7f\u7528 |~ \u548c !~ \u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 Golang \u7684 RE2 \u8bed\u6cd5\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5339\u914d\u662f\u533a\u5206\u5927\u5c0f\u5199\u7684\uff0c\u53ef\u4ee5\u7528 (?i) \u4f5c\u4e3a\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u524d\u7f00\uff0c\u5207\u6362\u4e3a\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u3002 \u867d\u7136\u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u53ef\u4ee5\u653e\u5728\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\uff0c\u4f46\u6700\u597d\u628a\u5b83\u4eec\u653e\u5728\u5f00\u5934\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u67e5\u8be2\u7684\u6027\u80fd\uff0c\u5f53\u67d0\u4e00\u884c\u5339\u914d\u65f6\u624d\u505a\u8fdb\u4e00\u6b65\u7684\u540e\u7eed\u5904\u7406\u3002\u4f8b\u5982\uff0c\u867d\u7136\u7ed3\u679c\u662f\u4e00\u6837\u7684\uff0c\u4f46\u4e0b\u9762\u7684\u67e5\u8be2 {job=\"mysql\"} |= \"error\" |json | line_format \"{{.err}}\" \u4f1a\u6bd4 {job=\"mysql\"} | json | line_format \"{{.message}}\" |= \"error\" \u66f4\u5feb\uff0c \u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u662f\u7ee7\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u4e4b\u540e\u8fc7\u6ee4\u65e5\u5fd7\u7684\u6700\u5feb\u65b9\u5f0f \u3002 \u89e3\u6790\u5668\u8868\u8fbe\u5f0f \u00b6 \u89e3\u6790\u5668\u8868\u8fbe\u5f0f\u53ef\u4ee5\u89e3\u6790\u548c\u63d0\u53d6\u65e5\u5fd7\u5185\u5bb9\u4e2d\u7684\u6807\u7b7e\uff0c\u8fd9\u4e9b\u63d0\u53d6\u7684\u6807\u7b7e\u53ef\u4ee5\u7528\u4e8e\u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u8fdb\u884c\u8fc7\u6ee4\uff0c\u6216\u8005\u7528\u4e8e\u6307\u6807\u805a\u5408\u3002 \u63d0\u53d6\u7684\u6807\u7b7e\u952e\u5c06\u7531\u89e3\u6790\u5668\u8fdb\u884c\u81ea\u52a8\u683c\u5f0f\u5316\uff0c\u4ee5\u9075\u5faa Prometheus \u6307\u6807\u540d\u79f0\u7684\u7ea6\u5b9a\uff08\u5b83\u4eec\u53ea\u80fd\u5305\u542b ASCII \u5b57\u6bcd\u548c\u6570\u5b57\uff0c\u4ee5\u53ca\u4e0b\u5212\u7ebf\u548c\u5192\u53f7\uff0c\u4e0d\u80fd\u4ee5\u6570\u5b57\u5f00\u5934\uff09\u3002 \u4f8b\u5982\u4e0b\u9762\u7684\u65e5\u5fd7\u7ecf\u8fc7\u7ba1\u9053 | json \u5c06\u4ea7\u751f\u4ee5\u4e0b Map \u6570\u636e\uff1a { \"a.b\": { \"c\": \"d\" }, \"e\": \"f\" } -> {a_b_c=\"d\", e=\"f\"} \u5728\u51fa\u73b0\u9519\u8bef\u7684\u60c5\u51b5\u4e0b\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u8be5\u884c\u4e0d\u662f\u9884\u671f\u7684\u683c\u5f0f\uff0c\u8be5\u65e5\u5fd7\u884c\u4e0d\u4f1a\u88ab\u8fc7\u6ee4\uff0c\u800c\u662f\u4f1a\u88ab\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684 __error__ \u6807\u7b7e\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u4e00\u4e2a\u63d0\u53d6\u7684\u6807\u7b7e\u952e\u540d\u5df2\u7ecf\u5b58\u5728\u4e8e\u539f\u59cb\u65e5\u5fd7\u6d41\u4e2d\uff0c\u90a3\u4e48\u63d0\u53d6\u7684\u6807\u7b7e\u952e\u5c06\u4ee5 _extracted \u4f5c\u4e3a\u540e\u7f00\uff0c\u4ee5\u533a\u5206\u4e24\u4e2a\u6807\u7b7e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u6807\u7b7e\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f\u6765\u5f3a\u884c\u8986\u76d6\u539f\u59cb\u6807\u7b7e\uff0c\u4f46\u662f\u5982\u679c\u4e00\u4e2a\u63d0\u53d6\u7684\u952e\u51fa\u73b0\u4e86\u4e24\u6b21\uff0c\u90a3\u4e48\u53ea\u6709\u6700\u65b0\u7684\u6807\u7b7e\u503c\u4f1a\u88ab\u4fdd\u7559\u3002 \u76ee\u524d\u652f\u6301 json \u3001 logfmt \u3001 pattern \u3001 regexp \u548c unpack \u8fd9\u51e0\u79cd\u89e3\u6790\u5668\u3002 \u6211\u4eec\u5e94\u8be5\u5c3d\u53ef\u80fd\u4f7f\u7528 json \u548c logfmt \u7b49\u9884\u5b9a\u4e49\u7684\u89e3\u6790\u5668\uff0c\u8fd9\u4f1a\u66f4\u52a0\u5bb9\u6613\uff0c\u800c\u5f53\u65e5\u5fd7\u884c\u7ed3\u6784\u5f02\u5e38\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 regexp \uff0c\u53ef\u4ee5\u5728\u540c\u4e00\u65e5\u5fd7\u7ba1\u9053\u4e2d\u4f7f\u7528\u591a\u4e2a\u89e3\u6790\u5668\uff0c\u8fd9\u5728\u4f60\u89e3\u6790\u590d\u6742\u65e5\u5fd7\u65f6\u5f88\u6709\u7528\u3002 JSON \u00b6 json \u89e3\u6790\u5668\u6709\u4e24\u79cd\u6a21\u5f0f\u8fd0\u884c\u3002 \u6ca1\u6709\u53c2\u6570\u3002 \u5982\u679c\u65e5\u5fd7\u884c\u662f\u4e00\u4e2a\u6709\u6548\u7684 json \u6587\u6863\uff0c\u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u6dfb\u52a0 | json \u5c06\u63d0\u53d6\u6240\u6709 json \u5c5e\u6027\u4f5c\u4e3a\u6807\u7b7e\uff0c\u5d4c\u5957\u7684\u5c5e\u6027\u4f1a\u4f7f\u7528 _ \u5206\u9694\u7b26\u88ab\u5e73\u94fa\u5230\u6807\u7b7e\u952e\u4e2d\u3002 \u6ce8\u610f\uff1a\u6570\u7ec4\u4f1a\u88ab\u5ffd\u7565\u3002 \u4f8b\u5982\uff0c\u4f7f\u7528 json \u89e3\u6790\u5668\u4ece\u4ee5\u4e0b\u6587\u4ef6\u5185\u5bb9\u4e2d\u63d0\u53d6\u6807\u7b7e\u3002 { \"protocol\": \"HTTP/2.0\", \"servers\": [\"129.0.1.1\", \"10.2.1.3\"], \"request\": { \"time\": \"6.032\", \"method\": \"GET\", \"host\": \"foo.grafana.net\", \"size\": \"55\", \"headers\": { \"Accept\": \"*/*\", \"User-Agent\": \"curl/7.68.0\" } }, \"response\": { \"status\": 401, \"size\": \"228\", \"latency_seconds\": \"6.031\" } } \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6807\u7b7e\u5217\u8868\uff1a \"protocol\" => \"HTTP/2.0\" \"request_time\" => \"6.032\" \"request_method\" => \"GET\" \"request_host\" => \"foo.grafana.net\" \"request_size\" => \"55\" \"response_status\" => \"401\" \"response_size\" => \"228\" \"response_latency_seconds\" => \"6.031\" \u5e26\u53c2\u6570\u7684 \u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u4f7f\u7528 |json label=\"expression\", another=\"expression\" \u5c06\u53ea\u63d0\u53d6\u6307\u5b9a\u7684 json \u5b57\u6bb5\u4e3a\u6807\u7b7e\uff0c\u4f60\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u8868\u8fbe\u5f0f\uff0c\u4e0e label_format \u76f8\u540c\uff0c\u6240\u6709\u8868\u8fbe\u5f0f\u5fc5\u987b\u52a0\u5f15\u53f7\u3002 \u5f53\u524d\u4ec5\u652f\u6301\u5b57\u6bb5\u8bbf\u95ee\uff08 my.field , my[\"field\"] \uff09\u548c\u6570\u7ec4\u8bbf\u95ee\uff08 list[0] \uff09\uff0c\u4ee5\u53ca\u4efb\u4f55\u7ea7\u522b\u5d4c\u5957\u4e2d\u7684\u8fd9\u4e9b\u7ec4\u5408\uff08 my.list[0][\"field\"] \uff09\u3002 \u4f8b\u5982\uff0c |json first_server=\"servers[0]\", ua=\"request.headers[\\\"User-Agent\\\"] \u5c06\u4ece\u4ee5\u4e0b\u65e5\u5fd7\u6587\u4ef6\u4e2d\u63d0\u53d6\u6807\u7b7e\uff1a { \"protocol\": \"HTTP/2.0\", \"servers\": [\"129.0.1.1\", \"10.2.1.3\"], \"request\": { \"time\": \"6.032\", \"method\": \"GET\", \"host\": \"foo.grafana.net\", \"size\": \"55\", \"headers\": { \"Accept\": \"*/*\", \"User-Agent\": \"curl/7.68.0\" } }, \"response\": { \"status\": 401, \"size\": \"228\", \"latency_seconds\": \"6.031\" } } \u63d0\u53d6\u7684\u6807\u7b7e\u5217\u8868\u4e3a\uff1a \"first_server\" => \"129.0.1.1\" \"ua\" => \"curl/7.68.0\" \u5982\u679c\u8868\u8fbe\u5f0f\u8fd4\u56de\u4e00\u4e2a\u6570\u7ec4\u6216\u5bf9\u8c61\uff0c\u5b83\u5c06\u4ee5 json \u683c\u5f0f\u5206\u914d\u7ed9\u6807\u7b7e\u3002\u4f8b\u5982\uff0c |json server_list=\"services\", headers=\"request.headers \u5c06\u63d0\u53d6\u5230\u5982\u4e0b\u6807\u7b7e\uff1a \"server_list\" => `[\"129.0.1.1\",\"10.2.1.3\"]` \"headers\" => `{\"Accept\": \"*/*\", \"User-Agent\": \"curl/7.68.0\"}` logfmt \u00b6 logfmt \u89e3\u6790\u5668\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 | logfmt \u6765\u6dfb\u52a0\uff0c\u5b83\u5c06\u4ece logfmt \u683c\u5f0f\u7684\u65e5\u5fd7\u884c\u4e2d\u63d0\u524d\u6240\u6709\u7684\u952e\u548c\u503c\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff1a at=info method=GET path=/ host=grafana.net fwd=\"124.133.124.161\" service=8ms status=200 \u5c06\u63d0\u53d6\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6807\u7b7e\uff1a \"at\" => \"info\" \"method\" => \"GET\" \"path\" => \"/\" \"host\" => \"grafana.net\" \"fwd\" => \"124.133.124.161\" \"service\" => \"8ms\" \"status\" => \"200\" regexp \u00b6 \u4e0e logfmt \u548c json \uff08\u5b83\u4eec\u9690\u5f0f\u63d0\u53d6\u6240\u6709\u503c\u4e14\u4e0d\u9700\u8981\u53c2\u6570\uff09\u4e0d\u540c\uff0c regexp \u89e3\u6790\u5668\u91c7\u7528\u5355\u4e2a\u53c2\u6570 | regexp \"<re>\" \u7684\u683c\u5f0f\uff0c\u5176\u53c2\u6570\u662f\u4f7f\u7528 Golang RE2 \u8bed\u6cd5\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u3002 \u6b63\u5219\u8868\u8fbe\u5f0f\u5fc5\u987b\u5305\u542b\u81f3\u5c11\u4e00\u4e2a\u547d\u540d\u7684\u5b50\u5339\u914d\uff08\u4f8b\u5982 (?P<name>re) \uff09\uff0c\u6bcf\u4e2a\u5b50\u5339\u914d\u9879\u90fd\u4f1a\u63d0\u53d6\u4e00\u4e2a\u4e0d\u540c\u7684\u6807\u7b7e\u3002 \u4f8b\u5982\uff0c\u89e3\u6790\u5668 | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\" \u5c06\u4ece\u4ee5\u4e0b\u884c\u4e2d\u63d0\u53d6\u6807\u7b7e\uff1a POST /api/prom/api/v1/query_range (200) 1.5s \u63d0\u53d6\u7684\u6807\u7b7e\u4e3a\uff1a \"method\" => \"POST\" \"path\" => \"/api/prom/api/v1/query_range\" \"status\" => \"200\" \"duration\" => \"1.5s\" pattern \u00b6 \u6a21\u5f0f\u89e3\u6790\u5668\u5141\u8bb8\u901a\u8fc7\u5b9a\u4e49\u6a21\u5f0f\u8868\u8fbe\u5f0f\uff08 | pattern \"<pattern-expression>\" \uff09\u4ece\u65e5\u5fd7\u884c\u4e2d\u663e\u5f0f\u63d0\u53d6\u5b57\u6bb5\uff0c\u8be5\u8868\u8fbe\u5f0f\u4e0e\u65e5\u5fd7\u884c\u7684\u7ed3\u6784\u76f8\u5339\u914d\u3002 \u6bd4\u5982\u6211\u4eec\u6765\u8003\u8651\u4e0b\u9762\u7684 NGINX \u65e5\u5fd7\u884c\u6570\u636e\uff1a 0.191.12.2 - - [10/Jun/2021:09:14:29 +0000] \"GET /api/plugins/versioncheck HTTP/1.1\" 200 2 \"-\" \"Go-http-client/2.0\" \"13.76.247.102, 34.120.177.193\" \"TLSv1.2\" \"US\" \"\" \u8be5\u65e5\u5fd7\u884c\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8868\u8fbe\u5f0f\u6765\u89e3\u6790\uff1a <ip> - - <_> \"<method> <uri> <_>\" <status> <size> <_> \"<agent>\" <_> \u89e3\u6790\u540e\u53ef\u4ee5\u63d0\u53d6\u51fa\u4e0b\u9762\u7684\u8fd9\u4e9b\u5c5e\u6027\uff1a \"ip\" => \"0.191.12.2\" \"method\" => \"GET\" \"uri\" => \"/api/plugins/versioncheck\" \"status\" => \"200\" \"size\" => \"2\" \"agent\" => \"Go-http-client/2.0\" \u6a21\u5f0f\u8868\u8fbe\u5f0f\u7684\u6355\u83b7\u662f\u7531 < \u548c > \u5b57\u7b26\u5206\u9694\u7684\u5b57\u6bb5\u540d\u79f0\uff0c\u6bd4\u5982 <example> \u5b9a\u4e49\u4e86\u5b57\u6bb5\u540d\u79f0\u4e3a example \uff0c\u672a\u547d\u540d\u7684 capture \u663e\u793a\u4e3a <_> \uff0c\u672a\u547d\u540d\u7684 capture \u4f1a\u8df3\u8fc7\u5339\u914d\u7684\u5185\u5bb9\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6a21\u5f0f\u8868\u8fbe\u5f0f\u951a\u5b9a\u5728\u65e5\u5fd7\u884c\u7684\u5f00\u5934\uff0c\u53ef\u4ee5\u5728\u8868\u8fbe\u5f0f\u7684\u5f00\u5934\u4f7f\u7528 <_> \u5c06\u8868\u8fbe\u5f0f\u951a\u5b9a\u5728\u5f00\u5934\u3002 \u6bd4\u5982\u6211\u4eec\u67e5\u770b\u4e0b\u9762\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff1a level=debug ts=2021-06-10T09:24:13.472094048Z caller=logging.go:66 traceID=0568b66ad2d9294c msg=\"POST /loki/api/v1/push (204) 16.652862ms\" \u6211\u4eec\u5982\u679c\u53ea\u5e0c\u671b\u53bb\u5339\u914d msg=\" \u7684\u5185\u5bb9\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8868\u8fbe\u5f0f\u6765\u8fdb\u884c\u5339\u914d\uff1a <_> msg=\"<method> <path> (<status>) <latency>\" \u524d\u9762\u5927\u90e8\u5206\u65e5\u5fd7\u6570\u636e\u6211\u4eec\u4e0d\u9700\u8981\uff0c\u53ea\u9700\u8981\u4f7f\u7528 <_> \u8fdb\u884c\u5360\u4f4d\u5373\u53ef\uff0c\u660e\u663e\u53ef\u4ee5\u770b\u51fa\u8fd9\u79cd\u65b9\u5f0f\u6bd4\u6b63\u5219\u8868\u8fbe\u5f0f\u8981\u7b80\u5355\u5f97\u591a\u3002 unpack \u00b6 unpack \u89e3\u6790\u5668\u5c06\u89e3\u6790 json \u65e5\u5fd7\u884c\uff0c\u5e76\u901a\u8fc7\u6253\u5305\u9636\u6bb5\u89e3\u5f00\u6240\u6709\u5d4c\u5165\u7684\u6807\u7b7e\uff0c\u4e00\u4e2a\u7279\u6b8a\u7684\u5c5e\u6027 _entry \u4e5f\u5c06\u88ab\u7528\u6765\u66ff\u6362\u539f\u6765\u7684\u65e5\u5fd7\u884c\u3002 \u4f8b\u5982\uff0c\u4f7f\u7528 | unpack \u89e3\u6790\u5668\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6807\u7b7e\uff1a { \"container\": \"myapp\", \"pod\": \"pod-3223f\", \"_entry\": \"original log message\" } \u5141\u8bb8\u63d0\u53d6 container \u548c pod \u6807\u7b7e\u4ee5\u53ca\u539f\u59cb\u65e5\u5fd7\u4fe1\u606f\u4f5c\u4e3a\u65b0\u7684\u65e5\u5fd7\u884c\u3002 \u5982\u679c\u539f\u59cb\u5d4c\u5165\u7684\u65e5\u5fd7\u884c\u662f\u7279\u5b9a\u7684\u683c\u5f0f\uff0c\u4f60\u53ef\u4ee5\u5c06 unpack \u4e0e json \u89e3\u6790\u5668\uff08\u6216\u5176\u4ed6\u89e3\u6790\u5668\uff09\u76f8\u7ed3\u5408\u4f7f\u7528\u3002 \u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f \u00b6 \u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u5141\u8bb8\u4f7f\u7528\u5176\u539f\u59cb\u548c\u63d0\u53d6\u7684\u6807\u7b7e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u884c\uff0c\u5b83\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u8c13\u8bcd\u3002 \u4e00\u4e2a\u8c13\u8bcd\u5305\u542b\u4e00\u4e2a\u6807\u7b7e\u6807\u8bc6\u7b26\u3001\u64cd\u4f5c\u7b26\u548c\u7528\u4e8e\u6bd4\u8f83\u6807\u7b7e\u7684\u503c\u3002 \u4f8b\u5982 cluster=\"namespace\" \u5176\u4e2d\u7684 cluster \u662f\u6807\u7b7e\u6807\u8bc6\u7b26\uff0c\u64cd\u4f5c\u7b26\u662f = \uff0c\u503c\u662f \"namespace\" \u3002 LogQL \u652f\u6301\u4ece\u67e5\u8be2\u8f93\u5165\u4e2d\u81ea\u52a8\u63a8\u65ad\u51fa\u7684\u591a\u79cd\u503c\u7c7b\u578b\uff1a String\uff08\u5b57\u7b26\u4e32\uff09 \u7528\u53cc\u5f15\u53f7\u6216\u53cd\u5f15\u53f7\u5f15\u8d77\u6765\uff0c\u4f8b\u5982 \"200\" \u6216 us-central1 \u3002 Duration\uff08\u65f6\u95f4\uff09 \u662f\u4e00\u4e32\u5341\u8fdb\u5236\u6570\u5b57\uff0c\u6bcf\u4e2a\u6570\u5b57\u90fd\u6709\u53ef\u9009\u7684\u6570\u548c\u5355\u4f4d\u540e\u7f00\uff0c\u5982 \"300ms\" \u3001 \"1.5h\" \u6216 \"2h45m\" \uff0c\u6709\u6548\u7684\u65f6\u95f4\u5355\u4f4d\u662f \"ns\" \u3001 \"us\" \uff08\u6216 \"\u00b5s\" \uff09\u3001 \"ms\" \u3001 \"s\" \u3001 \"m\" \u3001 \"h\" \u3002 Number\uff08\u6570\u5b57\uff09 \u662f\u6d6e\u70b9\u6570\uff0864 \u4f4d\uff09\uff0c\u5982 250\u300189.923\u3002 Bytes\uff08\u5b57\u8282\uff09 \u662f\u4e00\u4e32\u5341\u8fdb\u5236\u6570\u5b57\uff0c\u6bcf\u4e2a\u6570\u5b57\u90fd\u6709\u53ef\u9009\u7684\u6570\u548c\u5355\u4f4d\u540e\u7f00\uff0c\u5982 \"42MB\" \u3001 \"1.5Kib\" \u6216 \"20b\" \uff0c\u6709\u6548\u7684\u5b57\u8282\u5355\u4f4d\u662f \"b\" \u3001 \"kib\" \u3001 \"kb\" \u3001 \"mib\" \u3001 \"mb\" \u3001 \"gib\" \u3001 \"gb\" \u3001 \"tib\" \u3001 \"tb\" \u3001 \"pib\" \u3001 \"bb\" \u3001 \"eb\" \u3002 \u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e Prometheus \u6807\u7b7e\u5339\u914d\u5668\u5728\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u4e2d\u4f7f\u7528\u7684\u65b9\u5f0f\u5b8c\u5168\u4e00\u6837\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u4f7f\u7528\u540c\u6837\u7684\u64cd\u4f5c\u7b26\uff08 = \u3001 != \u3001 =~ \u3001 !~ \uff09\u3002 \u4f7f\u7528 Duration\u3001Number \u548c Bytes \u5c06\u5728\u6bd4\u8f83\u524d\u8f6c\u6362\u6807\u7b7e\u503c\uff0c\u5e76\u652f\u6301\u4ee5\u4e0b\u6bd4\u8f83\u5668\u3002 == \u6216 = \u76f8\u7b49\u6bd4\u8f83 != \u4e0d\u7b49\u4e8e\u6bd4\u8f83 > \u548c >= \u7528\u4e8e\u5927\u4e8e\u6216\u5927\u4e8e\u7b49\u4e8e\u6bd4\u8f83 < \u548c <= \u7528\u4e8e\u5c0f\u4e8e\u6216\u5c0f\u4e8e\u7b49\u4e8e\u6bd4\u8f83 \u4f8b\u5982 logfmt | duration > 1m and bytes_consumed > 20MB \u8fc7\u6ee4\u8868\u8fbe\u5f0f\u3002 \u5982\u679c\u6807\u7b7e\u503c\u7684\u8f6c\u6362\u5931\u8d25\uff0c\u65e5\u5fd7\u884c\u5c31\u4e0d\u4f1a\u88ab\u8fc7\u6ee4\uff0c\u800c\u4f1a\u6dfb\u52a0\u4e00\u4e2a __error__ \u6807\u7b7e\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 and \u548c or \u6765\u8fde\u63a5\u591a\u4e2a\u8c13\u8bcd\uff0c\u5b83\u4eec\u5206\u522b\u8868\u793a \u4e14 \u548c \u6216 \u7684\u4e8c\u8fdb\u5236\u64cd\u4f5c\uff0c and \u53ef\u4ee5\u7528\u9017\u53f7\u3001\u7a7a\u683c\u6216\u5176\u4ed6\u7ba1\u9053\u6765\u8868\u793a\uff0c\u6807\u7b7e\u8fc7\u6ee4\u5668\u53ef\u4ee5\u653e\u5728\u65e5\u5fd7\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\u3002 \u4ee5\u4e0b\u6240\u6709\u7684\u8868\u8fbe\u5f0f\u90fd\u662f\u7b49\u4ef7\u7684: | duration >= 20ms or size == 20kb and method!~\"2..\" | duration >= 20ms or size == 20kb | method!~\"2..\" | duration >= 20ms or size == 20kb,method!~\"2..\" | duration >= 20ms or size == 20kb method!~\"2..\" \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u591a\u4e2a\u8c13\u8bcd\u7684\u4f18\u5148\u7ea7\u662f\u4ece\u53f3\u5230\u5de6\uff0c\u4f60\u53ef\u4ee5\u7528\u5706\u62ec\u53f7\u5305\u88c5\u8c13\u8bcd\uff0c\u5f3a\u5236\u4f7f\u7528\u4ece\u5de6\u5230\u53f3\u7684\u4e0d\u540c\u4f18\u5148\u7ea7\u3002 \u4f8b\u5982\uff0c\u4ee5\u4e0b\u5185\u5bb9\u662f\u7b49\u4ef7\u7684\uff1a | duration >= 20ms or method=\"GET\" and size <= 20KB | ((duration >= 20ms or method=\"GET\") and size <= 20KB) \u5b83\u5c06\u9996\u5148\u8bc4\u4f30 duration>=20ms or method=\"GET\" \uff0c\u8981\u9996\u5148\u8bc4\u4f30 method=\"GET\" and size<=20KB \uff0c\u8bf7\u786e\u4fdd\u4f7f\u7528\u9002\u5f53\u7684\u62ec\u53f7\uff0c\u5982\u4e0b\u6240\u793a\u3002 | duration >= 20ms or (method=\"GET\" and size <= 20KB) \u65e5\u5fd7\u884c\u683c\u5f0f\u8868\u8fbe\u5f0f \u00b6 \u65e5\u5fd7\u884c\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 Golang \u7684 text/template \u6a21\u677f\u683c\u5f0f\u91cd\u5199\u65e5\u5fd7\u884c\u7684\u5185\u5bb9\uff0c\u5b83\u9700\u8981\u4e00\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570 | line_format \"{{.label_name}}\" \u4f5c\u4e3a\u6a21\u677f\u683c\u5f0f\uff0c\u6240\u6709\u7684\u6807\u7b7e\u90fd\u662f\u6ce8\u5165\u6a21\u677f\u7684\u53d8\u91cf\uff0c\u53ef\u4ee5\u7528 {{.label_name}} \u7684\u7b26\u53f7\u6765\u4f7f\u7528\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u8868\u8fbe\u5f0f\uff1a {container=\"frontend\"} | logfmt | line_format \"{{.query}} {{.duration}}\" \u5c06\u63d0\u53d6\u5e76\u91cd\u5199\u65e5\u5fd7\u884c\uff0c\u53ea\u5305\u542b query \u548c\u8bf7\u6c42\u7684 duration \u3002\u4f60\u53ef\u4ee5\u4e3a\u6a21\u677f\u4f7f\u7528\u53cc\u5f15\u53f7\u5b57\u7b26\u4e32\u6216\u53cd\u5f15\u53f7 {{.label_name}} \u6765\u907f\u514d\u8f6c\u4e49\u7279\u6b8a\u5b57\u7b26\u3002 \u6b64\u5916 line_format \u4e5f\u652f\u6301\u6570\u5b66\u51fd\u6570\uff0c\u4f8b\u5982\uff1a \u5982\u679c\u6211\u4eec\u6709\u4ee5\u4e0b\u6807\u7b7e ip=1.1.1.1 , status=200 \u548c duration=3000(ms) , \u6211\u4eec\u53ef\u4ee5\u7528 duration \u9664\u4ee5 1000 \u5f97\u5230\u4ee5\u79d2\u4e3a\u5355\u4f4d\u7684\u503c\uff1a {container=\"frontend\"} | logfmt | line_format \"{{.ip}} {{.status}} {{div .duration 1000}}\" \u4e0a\u9762\u7684\u67e5\u8be2\u5c06\u5f97\u5230\u7684\u65e5\u5fd7\u884c\u5185\u5bb9\u4e3a 1.1.1.1 200 3 \u3002 \u6807\u7b7e\u683c\u5f0f\u8868\u8fbe\u5f0f \u00b6 | label_format \u8868\u8fbe\u5f0f\u53ef\u4ee5\u91cd\u547d\u540d\u3001\u4fee\u6539\u6216\u6dfb\u52a0\u6807\u7b7e\uff0c\u5b83\u4ee5\u9017\u53f7\u5206\u9694\u7684\u64cd\u4f5c\u5217\u8868\u4f5c\u4e3a\u53c2\u6570\uff0c\u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\u591a\u4e2a\u64cd\u4f5c\u3002 \u5f53\u4e24\u8fb9\u90fd\u662f\u6807\u7b7e\u6807\u8bc6\u7b26\u65f6\uff0c\u4f8b\u5982 dst=src \uff0c\u8be5\u64cd\u4f5c\u5c06\u628a src \u6807\u7b7e\u91cd\u547d\u540d\u4e3a dst \u3002 \u5de6\u8fb9\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a\u6a21\u677f\u5b57\u7b26\u4e32\uff0c\u4f8b\u5982 dst=\"{{.status}} {{.query}}\" \uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c dst \u6807\u7b7e\u503c\u4f1a\u88ab Golang \u6a21\u677f\u6267\u884c\u7ed3\u679c\u6240\u53d6\u4ee3\uff0c\u8fd9\u4e0e | line_format \u8868\u8fbe\u5f0f\u662f\u540c\u4e00\u4e2a\u6a21\u677f\u5f15\u64ce\uff0c\u8fd9\u610f\u5473\u7740\u6807\u7b7e\u53ef\u4ee5\u4f5c\u4e3a\u53d8\u91cf\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u540c\u6837\u7684\u51fd\u6570\u5217\u8868\u3002 \u5728\u4e0a\u9762\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u76ee\u6807\u6807\u7b7e\u4e0d\u5b58\u5728\uff0c\u90a3\u4e48\u5c31\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6807\u7b7e\u3002 \u91cd\u547d\u540d\u5f62\u5f0f dst=src \u4f1a\u5728\u5c06 src \u6807\u7b7e\u91cd\u65b0\u6620\u5c04\u5230 dst \u6807\u7b7e\u540e\u5c06\u5176\u5220\u9664\uff0c\u7136\u800c\uff0c\u6a21\u677f\u5f62\u5f0f\u5c06\u4fdd\u7559\u5f15\u7528\u7684\u6807\u7b7e\uff0c\u4f8b\u5982 dst=\"{{.src}}\" \u7684\u7ed3\u679c\u662f dst \u548c src \u90fd\u6709\u76f8\u540c\u7684\u503c\u3002 \u4e00\u4e2a\u6807\u7b7e\u540d\u79f0\u5728\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u4e2d\u53ea\u80fd\u51fa\u73b0\u4e00\u6b21\uff0c\u8fd9\u610f\u5473\u7740 | label_format foo=bar,foo=\"new\" \u662f\u4e0d\u5141\u8bb8\u7684\uff0c\u4f46\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e24\u4e2a\u8868\u8fbe\u5f0f\u6765\u8fbe\u5230\u9884\u671f\u6548\u679c\uff0c\u6bd4\u5982 | label_format foo=bar | label_format foo=\"new\" \u3002 \u65e5\u5fd7\u5ea6\u91cf \u00b6 LogQL \u540c\u6837\u652f\u6301\u901a\u8fc7\u51fd\u6570\u65b9\u5f0f\u5c06\u65e5\u5fd7\u6d41\u8fdb\u884c\u5ea6\u91cf\uff0c\u901a\u5e38\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u8ba1\u7b97\u6d88\u606f\u7684\u9519\u8bef\u7387\u6216\u8005\u6392\u5e8f\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u5e94\u7528\u65e5\u5fd7\u8f93\u51fa Top N\u3002 \u533a\u95f4\u5411\u91cf \u00b6 LogQL \u540c\u6837\u4e5f\u652f\u6301\u6709\u9650\u7684\u533a\u95f4\u5411\u91cf\u5ea6\u91cf\u8bed\u53e5\uff0c\u4f7f\u7528\u65b9\u5f0f\u548c PromQL \u7c7b\u4f3c\uff0c\u5e38\u7528\u51fd\u6570\u4e3b\u8981\u662f\u5982\u4e0b 4 \u4e2a\uff1a rate : \u8ba1\u7b97\u6bcf\u79d2\u7684\u65e5\u5fd7\u6761\u76ee count_over_time : \u5bf9\u6307\u5b9a\u8303\u56f4\u5185\u7684\u6bcf\u4e2a\u65e5\u5fd7\u6d41\u7684\u6761\u76ee\u8fdb\u884c\u8ba1\u6570 bytes_rate : \u8ba1\u7b97\u65e5\u5fd7\u6d41\u6bcf\u79d2\u7684\u5b57\u8282\u6570 bytes_over_time : \u5bf9\u6307\u5b9a\u8303\u56f4\u5185\u7684\u6bcf\u4e2a\u65e5\u5fd7\u6d41\u7684\u4f7f\u7528\u7684\u5b57\u8282\u6570 \u6bd4\u5982\u8ba1\u7b97 nginx \u7684 qps\uff1a rate({filename=\"/var/log/nginx/access.log\"}[5m])) \u8ba1\u7b97 kernel \u8fc7\u53bb 5 \u5206\u949f\u53d1\u751f oom \u7684\u6b21\u6570\uff1a count_over_time({filename=\"/var/log/message\"} |~ \"oom_kill_process\" [5m])) \u805a\u5408\u51fd\u6570 \u00b6 LogQL \u4e5f\u652f\u6301\u805a\u5408\u8fd0\u7b97\uff0c\u6211\u4eec\u53ef\u7528\u5b83\u6765\u805a\u5408\u5355\u4e2a\u5411\u91cf\u5185\u7684\u5143\u7d20\uff0c\u4ece\u800c\u4ea7\u751f\u4e00\u4e2a\u5177\u6709\u8f83\u5c11\u5143\u7d20\u7684\u65b0\u5411\u91cf\uff0c\u5f53\u524d\u652f\u6301\u7684\u805a\u5408\u51fd\u6570\u5982\u4e0b\uff1a sum \uff1a\u6c42\u548c min \uff1a\u6700\u5c0f\u503c max \uff1a\u6700\u5927\u503c avg \uff1a\u5e73\u5747\u503c stddev \uff1a\u6807\u51c6\u5dee stdvar \uff1a\u6807\u51c6\u65b9\u5dee count \uff1a\u8ba1\u6570 bottomk \uff1a\u6700\u5c0f\u7684 k \u4e2a\u5143\u7d20 topk \uff1a\u6700\u5927\u7684 k \u4e2a\u5143\u7d20 \u805a\u5408\u51fd\u6570\u6211\u4eec\u53ef\u4ee5\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\u63cf\u8ff0\uff1a <aggr-op>([parameter,] <vector expression>) [without|by (<label list>)] \u5bf9\u4e8e\u9700\u8981\u5bf9\u6807\u7b7e\u8fdb\u884c\u5206\u7ec4\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 without \u6216\u8005 by \u6765\u533a\u5206\u3002\u6bd4\u5982\u8ba1\u7b97 nginx \u7684 qps\uff0c\u5e76\u6309\u7167 pod \u6765\u5206\u7ec4\uff1a sum(rate({filename=\"/var/log/nginx/access.log\"}[5m])) by (pod) \u53ea\u6709\u5728\u4f7f\u7528 bottomk \u548c topk \u51fd\u6570\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u51fd\u6570\u8f93\u5165\u76f8\u5173\u7684\u53c2\u6570\u3002\u6bd4\u5982\u8ba1\u7b97 nginx \u7684 qps \u6700\u5927\u7684\u524d 5 \u4e2a\uff0c\u5e76\u6309\u7167 pod \u6765\u5206\u7ec4\uff1a topk(5,sum(rate({filename=\"/var/log/nginx/access.log\"}[5m])) by (pod))) \u4e8c\u5143\u8fd0\u7b97 \u00b6 \u6570\u5b66\u8ba1\u7b97 \u00b6 Loki \u5b58\u7684\u662f\u65e5\u5fd7\uff0c\u90fd\u662f\u6587\u672c\uff0c\u600e\u4e48\u8ba1\u7b97\u5462\uff1f\u663e\u7136 LogQL \u4e2d\u7684\u6570\u5b66\u8fd0\u7b97\u662f\u9762\u5411\u533a\u95f4\u5411\u91cf\u64cd\u4f5c\u7684\uff0cLogQL \u4e2d\u7684\u652f\u6301\u7684\u4e8c\u8fdb\u5236\u8fd0\u7b97\u7b26\u5982\u4e0b\uff1a + \uff1a\u52a0\u6cd5 - \uff1a\u51cf\u6cd5 * \uff1a\u4e58\u6cd5 / \uff1a\u9664\u6cd5 % \uff1a\u6c42\u6a21 ^ \uff1a\u6c42\u5e42 \u6bd4\u5982\u6211\u4eec\u8981\u627e\u5230\u67d0\u4e2a\u4e1a\u52a1\u65e5\u5fd7\u91cc\u9762\u7684\u9519\u8bef\u7387\uff0c\u5c31\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u65b9\u5f0f\u8ba1\u7b97\uff1a sum(rate({app=\"foo\", level=\"error\"}[1m])) / sum(rate({app=\"foo\"}[1m])) \u903b\u8f91\u8fd0\u7b97 \u00b6 \u96c6\u5408\u8fd0\u7b97\u4ec5\u5728\u533a\u95f4\u5411\u91cf\u8303\u56f4\u5185\u6709\u6548\uff0c\u5f53\u524d\u652f\u6301 and \uff1a\u5e76\u4e14 or \uff1a\u6216\u8005 unless \uff1a\u6392\u9664 \u6bd4\u5982\uff1a rate({app=~\"foo|bar\"}[1m]) and rate({app=\"bar\"}[1m]) \u6bd4\u8f83\u8fd0\u7b97 \u00b6 LogQL \u652f\u6301\u7684\u6bd4\u8f83\u8fd0\u7b97\u7b26\u548c PromQL \u4e00\u6837\uff0c\u5305\u62ec\uff1a == \uff1a\u7b49\u4e8e != \uff1a\u4e0d\u7b49\u4e8e > \uff1a\u5927\u4e8e >= : \u5927\u4e8e\u6216\u7b49\u4e8e < \uff1a\u5c0f\u4e8e <= : \u5c0f\u4e8e\u6216\u7b49\u4e8e \u901a\u5e38\u6211\u4eec\u4f7f\u7528\u533a\u95f4\u5411\u91cf\u8ba1\u7b97\u540e\u4f1a\u505a\u4e00\u4e2a\u9608\u503c\u7684\u6bd4\u8f83\uff0c\u8fd9\u5bf9\u5e94\u544a\u8b66\u662f\u975e\u5e38\u6709\u7528\u7684\uff0c\u6bd4\u5982\u7edf\u8ba1 5 \u5206\u949f\u5185 error \u7ea7\u522b\u65e5\u5fd7\u6761\u76ee\u5927\u4e8e 10 \u7684\u60c5\u51b5\uff1a count_over_time({app=\"foo\", level=\"error\"}[5m]) > 10 \u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5e03\u5c14\u8ba1\u7b97\u6765\u8868\u8fbe\uff0c\u6bd4\u5982\u7edf\u8ba1 5 \u5206\u949f\u5185 error \u7ea7\u522b\u65e5\u5fd7\u6761\u76ee\u5927\u4e8e 10 \u4e3a\u771f\uff0c\u53cd\u6b63\u5219\u4e3a\u5047\uff1a count_over_time({app=\"foo\", level=\"error\"}[5m]) > bool 10 \u6ce8\u91ca \u00b6 LogQL \u67e5\u8be2\u53ef\u4ee5\u4f7f\u7528 # \u5b57\u7b26\u8fdb\u884c\u6ce8\u91ca\uff0c\u4f8b\u5982\uff1a {app=\"foo\"} # anything that comes after will not be interpreted in your query \u5bf9\u4e8e\u591a\u884c LogQL \u67e5\u8be2\uff0c\u53ef\u4ee5\u4f7f\u7528 # \u6392\u9664\u6574\u4e2a\u6216\u90e8\u5206\u884c\uff1a {app=\"foo\"} | json # this line will be ignored | bar=\"baz\" # this checks if bar = \"baz\" \u67e5\u8be2\u793a\u4f8b \u00b6 \u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u793a\u4f8b\u5e94\u7528\uff0c\u8be5\u5e94\u7528\u7a0b\u5e8f\u662f\u4e00\u4e2a\u4f2a\u9020\u7684\u8bb0\u5f55\u5668\uff0c\u5b83\u7684\u65e5\u5fd7\u5177\u6709 debug\u3001info \u548c warning \u8f93\u51fa\u5230 stdout\u3002 error \u7ea7\u522b\u7684\u65e5\u5fd7\u5c06\u88ab\u5199\u5165 stderr\uff0c\u5b9e\u9645\u7684\u65e5\u5fd7\u6d88\u606f\u4ee5 JSON \u683c\u5f0f\u751f\u6210\uff0c\u6bcf 500 \u6beb\u79d2\u5c06\u521b\u5efa\u4e00\u6761\u65b0\u7684\u65e5\u5fd7\u6d88\u606f\u3002\u65e5\u5fd7\u6d88\u606f\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a { \"app\": \"The fanciest app of mankind\", \"executable\": \"fake-logger\", \"is_even\": true, \"level\": \"debug\", \"msg\": \"This is a debug message. Hope you'll catch the bug\", \"time\": \"2022-04-04T13:41:50+02:00\", \"version\": \"1.0.0\" } \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u521b\u5efa\u793a\u4f8b\u5e94\u7528\uff1a cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: labels: app: fake-logger environment: development name: fake-logger spec: selector: matchLabels: app: fake-logger environment: development template: metadata: labels: app: fake-logger environment: development spec: containers: - image: thorstenhans/fake-logger:0.0.2 name: fake-logger resources: requests: cpu: 10m memory: 32Mi limits: cpu: 10m memory: 32Mi EOF \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 {app=\"fake-logger\"} \u5728 Grafana \u4e2d\u67e5\u8be2\u5230\u8be5\u5e94\u7528\u7684\u65e5\u5fd7\u6d41\u6570\u636e\u3002 \u7531\u4e8e\u6211\u4eec\u8be5\u793a\u4f8b\u5e94\u7528\u7684\u65e5\u5fd7\u662f JSON \u5f62\u5f0f\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u91c7\u7528 JSON \u89e3\u6790\u5668\u6765\u89e3\u6790\u65e5\u5fd7\uff0c\u8868\u8fbe\u5f0f\u4e3a {app=\"fake-logger\"} | json \uff0c\u5982\u4e0b\u6240\u793a\u3002 \u4f7f\u7528 JSON \u89e3\u6790\u5668\u89e3\u6790\u65e5\u5fd7\u540e\u53ef\u4ee5\u770b\u5230 Grafana \u63d0\u4f9b\u7684\u9762\u677f\u4f1a\u6839\u636e level \u7684\u503c\u4f7f\u7528\u4e0d\u540c\u7684\u989c\u8272\u8fdb\u884c\u533a\u5206\uff0c\u800c\u4e14\u73b0\u5728\u6211\u4eec\u65e5\u5fd7\u7684\u5c5e\u6027\u4e5f\u88ab\u6dfb\u52a0\u5230\u4e86 Log \u7684\u6807\u7b7e\u4e2d\u53bb\u4e86\u3002 \u73b0\u5728 JSON \u4e2d\u7684\u6570\u636e\u53d8\u6210\u4e86\u65e5\u5fd7\u6807\u7b7e\u6211\u4eec\u81ea\u7136\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6807\u7b7e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u8fc7\u6ee4 level=error \u7684\u65e5\u5fd7\uff0c\u53ea\u4f7f\u7528\u8868\u8fbe\u5f0f {app=\"fake-logger\"} | json | level=\"error\" \u5373\u53ef\u5b9e\u73b0\u3002 \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u9700\u6c42\u53bb\u683c\u5f0f\u5316\u8f93\u51fa\u65e5\u5fd7\uff0c\u4f7f\u7528 line_format \u5373\u53ef\u5b9e\u73b0\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5 {app=\"fake-logger\"} | json |is_even=\"true\" | line_format \"\u5728 {{.time}} \u4e8e {{.level}}@{{.pod}} Pod\u4e2d\u4ea7\u751f\u4e86\u65e5\u5fd7 {{.msg}}\" \u6765\u683c\u5f0f\u5316\u65e5\u5fd7\u8f93\u51fa \u76d1\u63a7\u5927\u76d8 \u00b6 \u8fd9\u91cc\u6211\u4eec\u4ee5\u76d1\u63a7 Kubernetes \u7684\u4e8b\u4ef6\u4e3a\u4f8b\u8fdb\u884c\u8bf4\u660e\u3002\u9996\u5148\u9700\u8981\u5b89\u88c5 kubernetes-event-exporter \uff0c kubernetes-event-exporter \u65e5\u5fd7\u4f1a\u6253\u5370\u5230 stdout\uff0c\u7136\u540e\u6211\u4eec\u7684 promtail \u4f1a\u5c06\u65e5\u5fd7\u4e0a\u4f20\u5230 Loki\u3002 \u7136\u540e\u5bfc\u5165 https://grafana.com/grafana/dashboards/14003 \u8fd9\u4e2a Dashboard \u5373\u53ef\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u4fee\u6539\u6bcf\u4e2a\u56fe\u8868\u4e2d\u7684\u8fc7\u6ee4\u6807\u7b7e\u4e3a job=\"monitoring/event-exporter\" \u3002 \u4fee\u6539\u540e\u6b63\u5e38\u5c31\u53ef\u4ee5\u5728 Dashboard \u4e2d\u770b\u5230\u96c6\u7fa4\u4e2d\u7684\u76f8\u5173\u4e8b\u4ef6\u4fe1\u606f\u4e86\u3002 \u5efa\u8bae \u00b6 \u5c3d\u91cf\u4f7f\u7528\u9759\u6001\u6807\u7b7e\uff0c\u5f00\u9500\u66f4\u5c0f\uff0c\u901a\u5e38\u65e5\u5fd7\u5728\u53d1\u9001\u5230 Loki \u4e4b\u524d\u6ce8\u5165 label\uff0c\u63a8\u8350\u7684\u9759\u6001\u6807\u7b7e\u5305\u542b\uff1a \u5bbf\u4e3b\u673a\uff1akubernetes/hosts \u5e94\u7528\u540d\uff1akubernetes/labels/app_kubernetes_io/name \u7ec4\u4ef6\u540d\uff1akubernetes/labels/name \u547d\u540d\u7a7a\u95f4\uff1akubernetes/namespace \u5176\u4ed6\u9759\u6001\u6807\u7b7e\uff0c\u5982\u73af\u5883\u3001\u7248\u672c\u7b49 \u8c28\u614e\u4f7f\u7528\u52a8\u6001\u6807\u7b7e\u3002 \u8fc7\u591a\u7684\u6807\u7b7e\u7ec4\u5408\u4f1a\u9020\u6210\u5927\u91cf\u7684\u6d41\uff0c\u5b83\u4f1a\u8ba9 Loki \u5b58\u50a8\u5927\u91cf\u7684\u7d22\u5f15\u548c\u5c0f\u5757\u7684\u5bf9\u8c61\u6587\u4ef6\u3002\u8fd9\u4e9b\u90fd\u4f1a\u663e\u8457\u6d88\u8017 Loki \u7684\u67e5\u8be2\u6027\u80fd\u3002\u4e3a\u907f\u514d\u8fd9\u4e9b\u95ee\u9898\uff0c \u5728\u4f60\u77e5\u9053\u9700\u8981\u4e4b\u524d\u4e0d\u8981\u6dfb\u52a0\u6807\u7b7e \u3002Loki \u7684\u4f18\u52bf\u5728\u4e8e\u5e76\u884c\u67e5\u8be2\uff0c\u4f7f\u7528\u8fc7\u6ee4\u5668\u8868\u8fbe\u5f0f\uff08label=\"text\", |~ \"regex\", ...\uff09\u6765\u67e5\u8be2\u65e5\u5fd7\u4f1a\u66f4\u6709\u6548\uff0c\u5e76\u4e14\u901f\u5ea6\u4e5f\u5f88\u5feb\u3002 \u6709\u754c\u7684\u6807\u7b7e\u503c\u8303\u56f4\uff0c\u4f5c\u4e3a Loki \u7684\u7528\u6237\u6216\u64cd\u4f5c\u5458\uff0c\u6211\u4eec\u7684\u76ee\u6807\u5e94\u8be5\u662f\u4f7f\u7528\u5c3d\u53ef\u80fd\u5c11\u7684\u6807\u7b7e\u6765\u5b58\u50a8\u4f60\u7684\u65e5\u5fd7\u3002\u8fd9\u610f\u5473\u7740\uff0c \u66f4\u5c11\u7684\u6807\u7b7e\u5e26\u6765\u66f4\u5c0f\u7684\u7d22\u5f15\uff0c\u4ece\u800c\u5bfc\u81f4\u66f4\u597d\u7684\u6027\u80fd \uff0c\u6240\u4ee5\u6211\u4eec\u5728\u6dfb\u52a0\u6807\u7b7e\u4e4b\u524d\u4e00\u5b9a\u8981\u4e09\u601d\u800c\u884c\u3002 \u914d\u7f6e\u7f13\u5b58\uff0cLoki \u53ef\u4ee5\u4e3a\u591a\u4e2a\u7ec4\u4ef6\u914d\u7f6e\u7f13\u5b58, \u53ef\u4ee5\u9009\u62e9 redis \u6216\u8005 memcached\uff0c\u8fd9\u53ef\u4ee5\u663e\u8457\u63d0\u9ad8\u6027\u80fd\u3002 \u5408\u7406\u4f7f\u7528 LogQL \u8bed\u6cd5\uff0c\u53ef\u5927\u5e45\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002Label matchers(\u6807\u7b7e\u5339\u914d\u5668)\u662f\u4f60\u7684\u7b2c\u4e00\u9053\u9632\u7ebf\uff0c\u662f\u5927\u5e45\u51cf\u5c11\u4f60\u641c\u7d22\u7684\u65e5\u5fd7\u6570\u91cf(\u4f8b\u5982\uff0c\u4ece 100TB \u5230 1TB)\u7684\u6700\u597d\u65b9\u6cd5\u3002\u5f53\u7136\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u9700\u8981\u5728\u65e5\u5fd7\u91c7\u96c6\u7aef\u4e0a\u6709\u826f\u597d\u7684\u6807\u7b7e\u5b9a\u4e49\u89c4\u8303\u3002","title":"kubernetes \u65e5\u5fd7 Logql"},{"location":"3.k8s/7.logging/logql/#logql","text":"","title":"LogQL"},{"location":"3.k8s/7.logging/logql/#logql_1","text":"\u53d7 PromQL \u7684\u542f\u53d1\uff0cLoki \u4e5f\u6709\u81ea\u5df1\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u79f0\u4e3a LogQL\uff0c\u5b83\u5c31\u50cf\u4e00\u4e2a\u5206\u5e03\u5f0f\u7684 grep\uff0c\u53ef\u4ee5\u805a\u5408\u67e5\u770b\u65e5\u5fd7\u3002\u548c PromQL \u4e00\u6837\uff0cLogQL \u4e5f\u662f\u4f7f\u7528\u6807\u7b7e\u548c\u8fd0\u7b97\u7b26\u8fdb\u884c\u8fc7\u6ee4\u7684\uff0c\u4e3b\u8981\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u67e5\u8be2\u529f\u80fd\uff1a \u67e5\u8be2\u8fd4\u56de\u65e5\u5fd7\u884c\u5185\u5bb9 \u901a\u8fc7\u8fc7\u6ee4\u89c4\u5219\u5728\u65e5\u5fd7\u6d41\u4e2d\u8ba1\u7b97\u76f8\u5173\u7684\u5ea6\u91cf\u6307\u6807","title":"LogQL"},{"location":"3.k8s/7.logging/logql/#_1","text":"\u4e00\u4e2a\u57fa\u672c\u7684\u65e5\u5fd7\u67e5\u8be2\u7531\u4e24\u90e8\u5206\u7ec4\u6210\u3002 log stream selector \uff08\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\uff09 log pipeline \uff08\u65e5\u5fd7\u7ba1\u9053\uff09 \u7531\u4e8e Loki \u7684\u8bbe\u8ba1\uff0c\u6240\u6709 LogQL \u67e5\u8be2\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u3002\u4e00\u4e2a Log Stream \u4ee3\u8868\u4e86\u5177\u6709\u76f8\u540c\u5143\u6570\u636e(Label \u96c6)\u7684\u65e5\u5fd7\u6761\u76ee\u3002 \u65e5\u5fd7\u6d41\u9009\u62e9\u5668 \u51b3\u5b9a\u4e86\u6709\u591a\u5c11\u65e5\u5fd7\u5c06\u88ab\u641c\u7d22\u5230\uff0c\u4e00\u4e2a\u66f4\u7ec6\u7c92\u5ea6\u7684\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u5c06\u641c\u7d22\u5230\u6d41\u7684\u6570\u91cf\u51cf\u5c11\u5230\u4e00\u4e2a\u53ef\u7ba1\u7406\u7684\u6570\u91cf\uff0c\u901a\u8fc7\u7cbe\u7ec6\u7684\u5339\u914d\u65e5\u5fd7\u6d41\uff0c\u53ef\u4ee5\u5927\u5e45\u51cf\u5c11\u67e5\u8be2\u671f\u95f4\u5e26\u6765\u8d44\u6e90\u6d88\u8017\u3002 \u800c\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u540e\u9762\u7684 \u65e5\u5fd7\u7ba1\u9053 \u662f\u53ef\u9009\u7684\uff0c\u7528\u4e8e\u8fdb\u4e00\u6b65\u5904\u7406\u548c\u8fc7\u6ee4\u65e5\u5fd7\u6d41\u4fe1\u606f\uff0c\u5b83\u7531\u4e00\u7ec4\u8868\u8fbe\u5f0f\u7ec4\u6210\uff0c\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u90fd\u4ee5\u4ece\u5de6\u5230\u53f3\u7684\u987a\u5e8f\u4e3a\u6bcf\u4e2a\u65e5\u5fd7\u884c\u6267\u884c\u76f8\u5173\u8fc7\u6ee4\uff0c\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u90fd\u53ef\u4ee5\u8fc7\u6ee4\u3001\u89e3\u6790\u548c\u6539\u53d8\u65e5\u5fd7\u884c\u5185\u5bb9\u4ee5\u53ca\u5404\u81ea\u7684\u6807\u7b7e\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u663e\u793a\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684\u65e5\u5fd7\u67e5\u8be2\u7684\u64cd\u4f5c\uff1a {container=\"query-frontend\",namespace=\"loki-dev\"} |= \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \u8be5\u67e5\u8be2\u8bed\u53e5\u7531\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a \u4e00\u4e2a\u65e5\u5fd7\u6d41\u9009\u62e9\u5668 {container=\"query-frontend\",namespace=\"loki-dev\"} \uff0c\u7528\u4e8e\u8fc7\u6ee4 loki-dev \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 query-frontend \u5bb9\u5668\u7684\u65e5\u5fd7 \u7136\u540e\u540e\u9762\u8ddf\u7740\u4e00\u4e2a\u65e5\u5fd7\u7ba1\u9053 |= \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \uff0c\u8be5\u7ba1\u9053\u8868\u793a\u5c06\u7b5b\u9009\u51fa\u5305\u542b metrics.go \u8fd9\u4e2a\u8bcd\u7684\u65e5\u5fd7\uff0c\u7136\u540e\u89e3\u6790\u6bcf\u4e00\u884c\u65e5\u5fd7\u63d0\u53d6\u66f4\u591a\u7684\u8868\u8fbe\u5f0f\u5e76\u8fdb\u884c\u8fc7\u6ee4 \u4e3a\u4e86\u907f\u514d\u8f6c\u4e49\u7279\u8272\u5b57\u7b26\uff0c\u4f60\u53ef\u4ee5\u5728\u5f15\u7528\u5b57\u7b26\u4e32\u7684\u65f6\u5019\u4f7f\u7528\u5355\u5f15\u53f7\uff0c\u800c\u4e0d\u662f\u53cc\u5f15\u53f7\uff0c\u6bd4\u5982 \\w+1 \u4e0e \"\\w+\" \u662f\u76f8\u540c\u7684\u3002","title":"\u65e5\u5fd7\u67e5\u8be2"},{"location":"3.k8s/7.logging/logql/#log-stream-selector","text":"\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u51b3\u5b9a\u4e86\u54ea\u4e9b\u65e5\u5fd7\u6d41\u5e94\u8be5\u88ab\u5305\u542b\u5728\u4f60\u7684\u67e5\u8be2\u7ed3\u679c\u4e2d\uff0c\u9009\u62e9\u5668\u7531 \u4e00\u4e2a\u6216\u591a\u4e2a\u952e\u503c\u5bf9 \u7ec4\u6210\uff0c\u5176\u4e2d\u6bcf\u4e2a\u952e\u662f\u4e00\u4e2a \u65e5\u5fd7\u6807\u7b7e \uff0c\u6bcf\u4e2a\u503c\u662f\u8be5\u6807\u7b7e\u7684\u503c\u3002 \u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u662f\u901a\u8fc7\u5c06\u952e\u503c\u5bf9\u5305\u88f9\u5728\u4e00\u5bf9\u5927\u62ec\u53f7\u4e2d\u7f16\u5199\u7684\uff0c\u6bd4\u5982\uff1a {app=\"mysql\", name=\"mysql-backup\"} \u4e0a\u9762\u8fd9\u4e2a\u793a\u4f8b\u8868\u793a\uff0c\u6240\u6709\u6807\u7b7e\u4e3a app \u4e14\u5176\u503c\u4e3a mysql \u548c\u6807\u7b7e\u4e3a name \u4e14\u5176\u503c\u4e3a mysql-backup \u7684\u65e5\u5fd7\u6d41\u5c06\u88ab\u5305\u62ec\u5728\u67e5\u8be2\u7ed3\u679c\u4e2d\u3002 \u5176\u4e2d\u6807\u7b7e\u540d\u540e\u9762\u7684 = \u8fd0\u7b97\u7b26\u662f\u4e00\u4e2a\u6807\u7b7e\u5339\u914d\u8fd0\u7b97\u7b26\uff0cLogQL \u4e2d\u4e00\u5171\u652f\u6301\u4ee5\u4e0b\u51e0\u79cd\u6807\u7b7e\u5339\u914d\u8fd0\u7b97\u7b26\uff1a = : \u5b8c\u5168\u5339\u914d != : \u4e0d\u76f8\u7b49 =~ : \u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d !~ : \u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d \u4f8b\u5982\uff1a {name=~\"mysql.+\"} {name!~\"mysql.+\"} {name!~\"mysql-\\\\d+\"} \u9002\u7528\u4e8e Prometheus \u6807\u7b7e\u9009\u62e9\u5668 \u7684\u89c4\u5219\u540c\u6837\u9002\u7528\u4e8e Loki \u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u3002","title":"Log Stream Selector"},{"location":"3.k8s/7.logging/logql/#log-pipeline","text":"\u65e5\u5fd7\u7ba1\u9053\u53ef\u4ee5\u9644\u52a0\u5230\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u4e0a\uff0c\u4ee5\u8fdb\u4e00\u6b65\u5904\u7406\u548c\u8fc7\u6ee4\u65e5\u5fd7\u6d41\u3002 \u5b83\u901a\u5e38\u7531\u4e00\u4e2a\u6216\u591a\u4e2a\u8868\u8fbe\u5f0f\u7ec4\u6210\uff0c\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u9488\u5bf9\u6bcf\u4e2a\u65e5\u5fd7\u884c\u4f9d\u6b21\u6267\u884c\u3002 \u5982\u679c\u4e00\u4e2a\u8868\u8fbe\u5f0f\u8fc7\u6ee4\u6389\u4e86\u65e5\u5fd7\u884c\uff0c\u5219\u7ba1\u9053\u5c06\u5728\u6b64\u5904\u505c\u6b62\u5e76\u5f00\u59cb\u5904\u7406\u4e0b\u4e00\u884c\u3002\u4e00\u4e9b\u8868\u8fbe\u5f0f\u53ef\u4ee5\u6539\u53d8\u65e5\u5fd7\u5185\u5bb9\u548c\u5404\u81ea\u7684\u6807\u7b7e\uff0c\u7136\u540e\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u5904\u7406\u540e\u7eed\u8868\u8fbe\u5f0f\u6216\u6307\u6807\u67e5\u8be2\u3002 \u4e00\u4e2a\u65e5\u5fd7\u7ba1\u9053\u53ef\u4ee5\u7531\u4ee5\u4e0b\u90e8\u5206\u7ec4\u6210\u3002 \u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f \u89e3\u6790\u5668\u8868\u8fbe\u5f0f \u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f \u65e5\u5fd7\u884c\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f \u6807\u7b7e\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f Unwrap \u8868\u8fbe\u5f0f \u5176\u4e2d unwrap \u8868\u8fbe\u5f0f\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u8868\u8fbe\u5f0f\uff0c\u53ea\u80fd\u5728\u5ea6\u91cf\u67e5\u8be2\u4e2d\u4f7f\u7528\u3002","title":"Log Pipeline"},{"location":"3.k8s/7.logging/logql/#_2","text":"\u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u7528\u4e8e\u5bf9\u5339\u914d\u65e5\u5fd7\u6d41\u4e2d\u7684\u805a\u5408\u65e5\u5fd7\u8fdb\u884c\u5206\u5e03\u5f0f grep\u3002 \u7f16\u5199\u5165\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a \u641c\u7d22\u8868\u8fbe\u5f0f \u8fdb\u4e00\u6b65\u8fc7\u6ee4\u5f97\u5230\u7684\u65e5\u5fd7\u6570\u636e\u96c6\uff0c\u641c\u7d22\u8868\u8fbe\u5f0f\u53ef\u4ee5\u662f\u6587\u672c\u6216\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6bd4\u5982\uff1a {job=\"mysql\"} |= \"error\" {name=\"kafka\"} |~ \"tsdb-ops.*io:2003\" {name=\"cassandra\"} |~ \"error=\\\\w+\" {instance=~\"kafka-[23]\",name=\"kafka\"} != \"kafka.server:type=ReplicaManager\" \u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 |= \u3001 |~ \u548c != \u662f \u8fc7\u6ee4\u8fd0\u7b97\u7b26 \uff0c\u652f\u6301\u4e0b\u9762\u51e0\u79cd\uff1a |= \uff1a\u65e5\u5fd7\u884c\u5305\u542b\u7684\u5b57\u7b26\u4e32 != \uff1a\u65e5\u5fd7\u884c\u4e0d\u5305\u542b\u7684\u5b57\u7b26\u4e32 |~ \uff1a\u65e5\u5fd7\u884c\u5339\u914d\u6b63\u5219\u8868\u8fbe\u5f0f !~ \uff1a\u65e5\u5fd7\u884c\u4e0e\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d \u8fc7\u6ee4\u8fd0\u7b97\u7b26\u53ef\u4ee5\u662f\u94fe\u5f0f\u7684\uff0c\u5e76\u5c06\u6309\u987a\u5e8f\u8fc7\u6ee4\u8868\u8fbe\u5f0f\uff0c\u4ea7\u751f\u7684\u65e5\u5fd7\u884c\u5fc5\u987b\u6ee1\u8db3\u6bcf\u4e2a\u8fc7\u6ee4\u5668\u3002\u5f53\u4f7f\u7528 |~ \u548c !~ \u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 Golang \u7684 RE2 \u8bed\u6cd5\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5339\u914d\u662f\u533a\u5206\u5927\u5c0f\u5199\u7684\uff0c\u53ef\u4ee5\u7528 (?i) \u4f5c\u4e3a\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u524d\u7f00\uff0c\u5207\u6362\u4e3a\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u3002 \u867d\u7136\u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u53ef\u4ee5\u653e\u5728\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\uff0c\u4f46\u6700\u597d\u628a\u5b83\u4eec\u653e\u5728\u5f00\u5934\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u67e5\u8be2\u7684\u6027\u80fd\uff0c\u5f53\u67d0\u4e00\u884c\u5339\u914d\u65f6\u624d\u505a\u8fdb\u4e00\u6b65\u7684\u540e\u7eed\u5904\u7406\u3002\u4f8b\u5982\uff0c\u867d\u7136\u7ed3\u679c\u662f\u4e00\u6837\u7684\uff0c\u4f46\u4e0b\u9762\u7684\u67e5\u8be2 {job=\"mysql\"} |= \"error\" |json | line_format \"{{.err}}\" \u4f1a\u6bd4 {job=\"mysql\"} | json | line_format \"{{.message}}\" |= \"error\" \u66f4\u5feb\uff0c \u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u662f\u7ee7\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u4e4b\u540e\u8fc7\u6ee4\u65e5\u5fd7\u7684\u6700\u5feb\u65b9\u5f0f \u3002","title":"\u65e5\u5fd7\u884c\u8fc7\u6ee4\u8868\u8fbe\u5f0f"},{"location":"3.k8s/7.logging/logql/#_3","text":"\u89e3\u6790\u5668\u8868\u8fbe\u5f0f\u53ef\u4ee5\u89e3\u6790\u548c\u63d0\u53d6\u65e5\u5fd7\u5185\u5bb9\u4e2d\u7684\u6807\u7b7e\uff0c\u8fd9\u4e9b\u63d0\u53d6\u7684\u6807\u7b7e\u53ef\u4ee5\u7528\u4e8e\u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u8fdb\u884c\u8fc7\u6ee4\uff0c\u6216\u8005\u7528\u4e8e\u6307\u6807\u805a\u5408\u3002 \u63d0\u53d6\u7684\u6807\u7b7e\u952e\u5c06\u7531\u89e3\u6790\u5668\u8fdb\u884c\u81ea\u52a8\u683c\u5f0f\u5316\uff0c\u4ee5\u9075\u5faa Prometheus \u6307\u6807\u540d\u79f0\u7684\u7ea6\u5b9a\uff08\u5b83\u4eec\u53ea\u80fd\u5305\u542b ASCII \u5b57\u6bcd\u548c\u6570\u5b57\uff0c\u4ee5\u53ca\u4e0b\u5212\u7ebf\u548c\u5192\u53f7\uff0c\u4e0d\u80fd\u4ee5\u6570\u5b57\u5f00\u5934\uff09\u3002 \u4f8b\u5982\u4e0b\u9762\u7684\u65e5\u5fd7\u7ecf\u8fc7\u7ba1\u9053 | json \u5c06\u4ea7\u751f\u4ee5\u4e0b Map \u6570\u636e\uff1a { \"a.b\": { \"c\": \"d\" }, \"e\": \"f\" } -> {a_b_c=\"d\", e=\"f\"} \u5728\u51fa\u73b0\u9519\u8bef\u7684\u60c5\u51b5\u4e0b\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u8be5\u884c\u4e0d\u662f\u9884\u671f\u7684\u683c\u5f0f\uff0c\u8be5\u65e5\u5fd7\u884c\u4e0d\u4f1a\u88ab\u8fc7\u6ee4\uff0c\u800c\u662f\u4f1a\u88ab\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684 __error__ \u6807\u7b7e\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u4e00\u4e2a\u63d0\u53d6\u7684\u6807\u7b7e\u952e\u540d\u5df2\u7ecf\u5b58\u5728\u4e8e\u539f\u59cb\u65e5\u5fd7\u6d41\u4e2d\uff0c\u90a3\u4e48\u63d0\u53d6\u7684\u6807\u7b7e\u952e\u5c06\u4ee5 _extracted \u4f5c\u4e3a\u540e\u7f00\uff0c\u4ee5\u533a\u5206\u4e24\u4e2a\u6807\u7b7e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u6807\u7b7e\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f\u6765\u5f3a\u884c\u8986\u76d6\u539f\u59cb\u6807\u7b7e\uff0c\u4f46\u662f\u5982\u679c\u4e00\u4e2a\u63d0\u53d6\u7684\u952e\u51fa\u73b0\u4e86\u4e24\u6b21\uff0c\u90a3\u4e48\u53ea\u6709\u6700\u65b0\u7684\u6807\u7b7e\u503c\u4f1a\u88ab\u4fdd\u7559\u3002 \u76ee\u524d\u652f\u6301 json \u3001 logfmt \u3001 pattern \u3001 regexp \u548c unpack \u8fd9\u51e0\u79cd\u89e3\u6790\u5668\u3002 \u6211\u4eec\u5e94\u8be5\u5c3d\u53ef\u80fd\u4f7f\u7528 json \u548c logfmt \u7b49\u9884\u5b9a\u4e49\u7684\u89e3\u6790\u5668\uff0c\u8fd9\u4f1a\u66f4\u52a0\u5bb9\u6613\uff0c\u800c\u5f53\u65e5\u5fd7\u884c\u7ed3\u6784\u5f02\u5e38\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 regexp \uff0c\u53ef\u4ee5\u5728\u540c\u4e00\u65e5\u5fd7\u7ba1\u9053\u4e2d\u4f7f\u7528\u591a\u4e2a\u89e3\u6790\u5668\uff0c\u8fd9\u5728\u4f60\u89e3\u6790\u590d\u6742\u65e5\u5fd7\u65f6\u5f88\u6709\u7528\u3002","title":"\u89e3\u6790\u5668\u8868\u8fbe\u5f0f"},{"location":"3.k8s/7.logging/logql/#json","text":"json \u89e3\u6790\u5668\u6709\u4e24\u79cd\u6a21\u5f0f\u8fd0\u884c\u3002 \u6ca1\u6709\u53c2\u6570\u3002 \u5982\u679c\u65e5\u5fd7\u884c\u662f\u4e00\u4e2a\u6709\u6548\u7684 json \u6587\u6863\uff0c\u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u6dfb\u52a0 | json \u5c06\u63d0\u53d6\u6240\u6709 json \u5c5e\u6027\u4f5c\u4e3a\u6807\u7b7e\uff0c\u5d4c\u5957\u7684\u5c5e\u6027\u4f1a\u4f7f\u7528 _ \u5206\u9694\u7b26\u88ab\u5e73\u94fa\u5230\u6807\u7b7e\u952e\u4e2d\u3002 \u6ce8\u610f\uff1a\u6570\u7ec4\u4f1a\u88ab\u5ffd\u7565\u3002 \u4f8b\u5982\uff0c\u4f7f\u7528 json \u89e3\u6790\u5668\u4ece\u4ee5\u4e0b\u6587\u4ef6\u5185\u5bb9\u4e2d\u63d0\u53d6\u6807\u7b7e\u3002 { \"protocol\": \"HTTP/2.0\", \"servers\": [\"129.0.1.1\", \"10.2.1.3\"], \"request\": { \"time\": \"6.032\", \"method\": \"GET\", \"host\": \"foo.grafana.net\", \"size\": \"55\", \"headers\": { \"Accept\": \"*/*\", \"User-Agent\": \"curl/7.68.0\" } }, \"response\": { \"status\": 401, \"size\": \"228\", \"latency_seconds\": \"6.031\" } } \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6807\u7b7e\u5217\u8868\uff1a \"protocol\" => \"HTTP/2.0\" \"request_time\" => \"6.032\" \"request_method\" => \"GET\" \"request_host\" => \"foo.grafana.net\" \"request_size\" => \"55\" \"response_status\" => \"401\" \"response_size\" => \"228\" \"response_latency_seconds\" => \"6.031\" \u5e26\u53c2\u6570\u7684 \u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u4f7f\u7528 |json label=\"expression\", another=\"expression\" \u5c06\u53ea\u63d0\u53d6\u6307\u5b9a\u7684 json \u5b57\u6bb5\u4e3a\u6807\u7b7e\uff0c\u4f60\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u8868\u8fbe\u5f0f\uff0c\u4e0e label_format \u76f8\u540c\uff0c\u6240\u6709\u8868\u8fbe\u5f0f\u5fc5\u987b\u52a0\u5f15\u53f7\u3002 \u5f53\u524d\u4ec5\u652f\u6301\u5b57\u6bb5\u8bbf\u95ee\uff08 my.field , my[\"field\"] \uff09\u548c\u6570\u7ec4\u8bbf\u95ee\uff08 list[0] \uff09\uff0c\u4ee5\u53ca\u4efb\u4f55\u7ea7\u522b\u5d4c\u5957\u4e2d\u7684\u8fd9\u4e9b\u7ec4\u5408\uff08 my.list[0][\"field\"] \uff09\u3002 \u4f8b\u5982\uff0c |json first_server=\"servers[0]\", ua=\"request.headers[\\\"User-Agent\\\"] \u5c06\u4ece\u4ee5\u4e0b\u65e5\u5fd7\u6587\u4ef6\u4e2d\u63d0\u53d6\u6807\u7b7e\uff1a { \"protocol\": \"HTTP/2.0\", \"servers\": [\"129.0.1.1\", \"10.2.1.3\"], \"request\": { \"time\": \"6.032\", \"method\": \"GET\", \"host\": \"foo.grafana.net\", \"size\": \"55\", \"headers\": { \"Accept\": \"*/*\", \"User-Agent\": \"curl/7.68.0\" } }, \"response\": { \"status\": 401, \"size\": \"228\", \"latency_seconds\": \"6.031\" } } \u63d0\u53d6\u7684\u6807\u7b7e\u5217\u8868\u4e3a\uff1a \"first_server\" => \"129.0.1.1\" \"ua\" => \"curl/7.68.0\" \u5982\u679c\u8868\u8fbe\u5f0f\u8fd4\u56de\u4e00\u4e2a\u6570\u7ec4\u6216\u5bf9\u8c61\uff0c\u5b83\u5c06\u4ee5 json \u683c\u5f0f\u5206\u914d\u7ed9\u6807\u7b7e\u3002\u4f8b\u5982\uff0c |json server_list=\"services\", headers=\"request.headers \u5c06\u63d0\u53d6\u5230\u5982\u4e0b\u6807\u7b7e\uff1a \"server_list\" => `[\"129.0.1.1\",\"10.2.1.3\"]` \"headers\" => `{\"Accept\": \"*/*\", \"User-Agent\": \"curl/7.68.0\"}`","title":"JSON"},{"location":"3.k8s/7.logging/logql/#logfmt","text":"logfmt \u89e3\u6790\u5668\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 | logfmt \u6765\u6dfb\u52a0\uff0c\u5b83\u5c06\u4ece logfmt \u683c\u5f0f\u7684\u65e5\u5fd7\u884c\u4e2d\u63d0\u524d\u6240\u6709\u7684\u952e\u548c\u503c\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff1a at=info method=GET path=/ host=grafana.net fwd=\"124.133.124.161\" service=8ms status=200 \u5c06\u63d0\u53d6\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6807\u7b7e\uff1a \"at\" => \"info\" \"method\" => \"GET\" \"path\" => \"/\" \"host\" => \"grafana.net\" \"fwd\" => \"124.133.124.161\" \"service\" => \"8ms\" \"status\" => \"200\"","title":"logfmt"},{"location":"3.k8s/7.logging/logql/#regexp","text":"\u4e0e logfmt \u548c json \uff08\u5b83\u4eec\u9690\u5f0f\u63d0\u53d6\u6240\u6709\u503c\u4e14\u4e0d\u9700\u8981\u53c2\u6570\uff09\u4e0d\u540c\uff0c regexp \u89e3\u6790\u5668\u91c7\u7528\u5355\u4e2a\u53c2\u6570 | regexp \"<re>\" \u7684\u683c\u5f0f\uff0c\u5176\u53c2\u6570\u662f\u4f7f\u7528 Golang RE2 \u8bed\u6cd5\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u3002 \u6b63\u5219\u8868\u8fbe\u5f0f\u5fc5\u987b\u5305\u542b\u81f3\u5c11\u4e00\u4e2a\u547d\u540d\u7684\u5b50\u5339\u914d\uff08\u4f8b\u5982 (?P<name>re) \uff09\uff0c\u6bcf\u4e2a\u5b50\u5339\u914d\u9879\u90fd\u4f1a\u63d0\u53d6\u4e00\u4e2a\u4e0d\u540c\u7684\u6807\u7b7e\u3002 \u4f8b\u5982\uff0c\u89e3\u6790\u5668 | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\" \u5c06\u4ece\u4ee5\u4e0b\u884c\u4e2d\u63d0\u53d6\u6807\u7b7e\uff1a POST /api/prom/api/v1/query_range (200) 1.5s \u63d0\u53d6\u7684\u6807\u7b7e\u4e3a\uff1a \"method\" => \"POST\" \"path\" => \"/api/prom/api/v1/query_range\" \"status\" => \"200\" \"duration\" => \"1.5s\"","title":"regexp"},{"location":"3.k8s/7.logging/logql/#pattern","text":"\u6a21\u5f0f\u89e3\u6790\u5668\u5141\u8bb8\u901a\u8fc7\u5b9a\u4e49\u6a21\u5f0f\u8868\u8fbe\u5f0f\uff08 | pattern \"<pattern-expression>\" \uff09\u4ece\u65e5\u5fd7\u884c\u4e2d\u663e\u5f0f\u63d0\u53d6\u5b57\u6bb5\uff0c\u8be5\u8868\u8fbe\u5f0f\u4e0e\u65e5\u5fd7\u884c\u7684\u7ed3\u6784\u76f8\u5339\u914d\u3002 \u6bd4\u5982\u6211\u4eec\u6765\u8003\u8651\u4e0b\u9762\u7684 NGINX \u65e5\u5fd7\u884c\u6570\u636e\uff1a 0.191.12.2 - - [10/Jun/2021:09:14:29 +0000] \"GET /api/plugins/versioncheck HTTP/1.1\" 200 2 \"-\" \"Go-http-client/2.0\" \"13.76.247.102, 34.120.177.193\" \"TLSv1.2\" \"US\" \"\" \u8be5\u65e5\u5fd7\u884c\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8868\u8fbe\u5f0f\u6765\u89e3\u6790\uff1a <ip> - - <_> \"<method> <uri> <_>\" <status> <size> <_> \"<agent>\" <_> \u89e3\u6790\u540e\u53ef\u4ee5\u63d0\u53d6\u51fa\u4e0b\u9762\u7684\u8fd9\u4e9b\u5c5e\u6027\uff1a \"ip\" => \"0.191.12.2\" \"method\" => \"GET\" \"uri\" => \"/api/plugins/versioncheck\" \"status\" => \"200\" \"size\" => \"2\" \"agent\" => \"Go-http-client/2.0\" \u6a21\u5f0f\u8868\u8fbe\u5f0f\u7684\u6355\u83b7\u662f\u7531 < \u548c > \u5b57\u7b26\u5206\u9694\u7684\u5b57\u6bb5\u540d\u79f0\uff0c\u6bd4\u5982 <example> \u5b9a\u4e49\u4e86\u5b57\u6bb5\u540d\u79f0\u4e3a example \uff0c\u672a\u547d\u540d\u7684 capture \u663e\u793a\u4e3a <_> \uff0c\u672a\u547d\u540d\u7684 capture \u4f1a\u8df3\u8fc7\u5339\u914d\u7684\u5185\u5bb9\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6a21\u5f0f\u8868\u8fbe\u5f0f\u951a\u5b9a\u5728\u65e5\u5fd7\u884c\u7684\u5f00\u5934\uff0c\u53ef\u4ee5\u5728\u8868\u8fbe\u5f0f\u7684\u5f00\u5934\u4f7f\u7528 <_> \u5c06\u8868\u8fbe\u5f0f\u951a\u5b9a\u5728\u5f00\u5934\u3002 \u6bd4\u5982\u6211\u4eec\u67e5\u770b\u4e0b\u9762\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff1a level=debug ts=2021-06-10T09:24:13.472094048Z caller=logging.go:66 traceID=0568b66ad2d9294c msg=\"POST /loki/api/v1/push (204) 16.652862ms\" \u6211\u4eec\u5982\u679c\u53ea\u5e0c\u671b\u53bb\u5339\u914d msg=\" \u7684\u5185\u5bb9\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8868\u8fbe\u5f0f\u6765\u8fdb\u884c\u5339\u914d\uff1a <_> msg=\"<method> <path> (<status>) <latency>\" \u524d\u9762\u5927\u90e8\u5206\u65e5\u5fd7\u6570\u636e\u6211\u4eec\u4e0d\u9700\u8981\uff0c\u53ea\u9700\u8981\u4f7f\u7528 <_> \u8fdb\u884c\u5360\u4f4d\u5373\u53ef\uff0c\u660e\u663e\u53ef\u4ee5\u770b\u51fa\u8fd9\u79cd\u65b9\u5f0f\u6bd4\u6b63\u5219\u8868\u8fbe\u5f0f\u8981\u7b80\u5355\u5f97\u591a\u3002","title":"pattern"},{"location":"3.k8s/7.logging/logql/#unpack","text":"unpack \u89e3\u6790\u5668\u5c06\u89e3\u6790 json \u65e5\u5fd7\u884c\uff0c\u5e76\u901a\u8fc7\u6253\u5305\u9636\u6bb5\u89e3\u5f00\u6240\u6709\u5d4c\u5165\u7684\u6807\u7b7e\uff0c\u4e00\u4e2a\u7279\u6b8a\u7684\u5c5e\u6027 _entry \u4e5f\u5c06\u88ab\u7528\u6765\u66ff\u6362\u539f\u6765\u7684\u65e5\u5fd7\u884c\u3002 \u4f8b\u5982\uff0c\u4f7f\u7528 | unpack \u89e3\u6790\u5668\uff0c\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6807\u7b7e\uff1a { \"container\": \"myapp\", \"pod\": \"pod-3223f\", \"_entry\": \"original log message\" } \u5141\u8bb8\u63d0\u53d6 container \u548c pod \u6807\u7b7e\u4ee5\u53ca\u539f\u59cb\u65e5\u5fd7\u4fe1\u606f\u4f5c\u4e3a\u65b0\u7684\u65e5\u5fd7\u884c\u3002 \u5982\u679c\u539f\u59cb\u5d4c\u5165\u7684\u65e5\u5fd7\u884c\u662f\u7279\u5b9a\u7684\u683c\u5f0f\uff0c\u4f60\u53ef\u4ee5\u5c06 unpack \u4e0e json \u89e3\u6790\u5668\uff08\u6216\u5176\u4ed6\u89e3\u6790\u5668\uff09\u76f8\u7ed3\u5408\u4f7f\u7528\u3002","title":"unpack"},{"location":"3.k8s/7.logging/logql/#_4","text":"\u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u5141\u8bb8\u4f7f\u7528\u5176\u539f\u59cb\u548c\u63d0\u53d6\u7684\u6807\u7b7e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u884c\uff0c\u5b83\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u8c13\u8bcd\u3002 \u4e00\u4e2a\u8c13\u8bcd\u5305\u542b\u4e00\u4e2a\u6807\u7b7e\u6807\u8bc6\u7b26\u3001\u64cd\u4f5c\u7b26\u548c\u7528\u4e8e\u6bd4\u8f83\u6807\u7b7e\u7684\u503c\u3002 \u4f8b\u5982 cluster=\"namespace\" \u5176\u4e2d\u7684 cluster \u662f\u6807\u7b7e\u6807\u8bc6\u7b26\uff0c\u64cd\u4f5c\u7b26\u662f = \uff0c\u503c\u662f \"namespace\" \u3002 LogQL \u652f\u6301\u4ece\u67e5\u8be2\u8f93\u5165\u4e2d\u81ea\u52a8\u63a8\u65ad\u51fa\u7684\u591a\u79cd\u503c\u7c7b\u578b\uff1a String\uff08\u5b57\u7b26\u4e32\uff09 \u7528\u53cc\u5f15\u53f7\u6216\u53cd\u5f15\u53f7\u5f15\u8d77\u6765\uff0c\u4f8b\u5982 \"200\" \u6216 us-central1 \u3002 Duration\uff08\u65f6\u95f4\uff09 \u662f\u4e00\u4e32\u5341\u8fdb\u5236\u6570\u5b57\uff0c\u6bcf\u4e2a\u6570\u5b57\u90fd\u6709\u53ef\u9009\u7684\u6570\u548c\u5355\u4f4d\u540e\u7f00\uff0c\u5982 \"300ms\" \u3001 \"1.5h\" \u6216 \"2h45m\" \uff0c\u6709\u6548\u7684\u65f6\u95f4\u5355\u4f4d\u662f \"ns\" \u3001 \"us\" \uff08\u6216 \"\u00b5s\" \uff09\u3001 \"ms\" \u3001 \"s\" \u3001 \"m\" \u3001 \"h\" \u3002 Number\uff08\u6570\u5b57\uff09 \u662f\u6d6e\u70b9\u6570\uff0864 \u4f4d\uff09\uff0c\u5982 250\u300189.923\u3002 Bytes\uff08\u5b57\u8282\uff09 \u662f\u4e00\u4e32\u5341\u8fdb\u5236\u6570\u5b57\uff0c\u6bcf\u4e2a\u6570\u5b57\u90fd\u6709\u53ef\u9009\u7684\u6570\u548c\u5355\u4f4d\u540e\u7f00\uff0c\u5982 \"42MB\" \u3001 \"1.5Kib\" \u6216 \"20b\" \uff0c\u6709\u6548\u7684\u5b57\u8282\u5355\u4f4d\u662f \"b\" \u3001 \"kib\" \u3001 \"kb\" \u3001 \"mib\" \u3001 \"mb\" \u3001 \"gib\" \u3001 \"gb\" \u3001 \"tib\" \u3001 \"tb\" \u3001 \"pib\" \u3001 \"bb\" \u3001 \"eb\" \u3002 \u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e Prometheus \u6807\u7b7e\u5339\u914d\u5668\u5728\u65e5\u5fd7\u6d41\u9009\u62e9\u5668\u4e2d\u4f7f\u7528\u7684\u65b9\u5f0f\u5b8c\u5168\u4e00\u6837\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u4f7f\u7528\u540c\u6837\u7684\u64cd\u4f5c\u7b26\uff08 = \u3001 != \u3001 =~ \u3001 !~ \uff09\u3002 \u4f7f\u7528 Duration\u3001Number \u548c Bytes \u5c06\u5728\u6bd4\u8f83\u524d\u8f6c\u6362\u6807\u7b7e\u503c\uff0c\u5e76\u652f\u6301\u4ee5\u4e0b\u6bd4\u8f83\u5668\u3002 == \u6216 = \u76f8\u7b49\u6bd4\u8f83 != \u4e0d\u7b49\u4e8e\u6bd4\u8f83 > \u548c >= \u7528\u4e8e\u5927\u4e8e\u6216\u5927\u4e8e\u7b49\u4e8e\u6bd4\u8f83 < \u548c <= \u7528\u4e8e\u5c0f\u4e8e\u6216\u5c0f\u4e8e\u7b49\u4e8e\u6bd4\u8f83 \u4f8b\u5982 logfmt | duration > 1m and bytes_consumed > 20MB \u8fc7\u6ee4\u8868\u8fbe\u5f0f\u3002 \u5982\u679c\u6807\u7b7e\u503c\u7684\u8f6c\u6362\u5931\u8d25\uff0c\u65e5\u5fd7\u884c\u5c31\u4e0d\u4f1a\u88ab\u8fc7\u6ee4\uff0c\u800c\u4f1a\u6dfb\u52a0\u4e00\u4e2a __error__ \u6807\u7b7e\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 and \u548c or \u6765\u8fde\u63a5\u591a\u4e2a\u8c13\u8bcd\uff0c\u5b83\u4eec\u5206\u522b\u8868\u793a \u4e14 \u548c \u6216 \u7684\u4e8c\u8fdb\u5236\u64cd\u4f5c\uff0c and \u53ef\u4ee5\u7528\u9017\u53f7\u3001\u7a7a\u683c\u6216\u5176\u4ed6\u7ba1\u9053\u6765\u8868\u793a\uff0c\u6807\u7b7e\u8fc7\u6ee4\u5668\u53ef\u4ee5\u653e\u5728\u65e5\u5fd7\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\u3002 \u4ee5\u4e0b\u6240\u6709\u7684\u8868\u8fbe\u5f0f\u90fd\u662f\u7b49\u4ef7\u7684: | duration >= 20ms or size == 20kb and method!~\"2..\" | duration >= 20ms or size == 20kb | method!~\"2..\" | duration >= 20ms or size == 20kb,method!~\"2..\" | duration >= 20ms or size == 20kb method!~\"2..\" \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u591a\u4e2a\u8c13\u8bcd\u7684\u4f18\u5148\u7ea7\u662f\u4ece\u53f3\u5230\u5de6\uff0c\u4f60\u53ef\u4ee5\u7528\u5706\u62ec\u53f7\u5305\u88c5\u8c13\u8bcd\uff0c\u5f3a\u5236\u4f7f\u7528\u4ece\u5de6\u5230\u53f3\u7684\u4e0d\u540c\u4f18\u5148\u7ea7\u3002 \u4f8b\u5982\uff0c\u4ee5\u4e0b\u5185\u5bb9\u662f\u7b49\u4ef7\u7684\uff1a | duration >= 20ms or method=\"GET\" and size <= 20KB | ((duration >= 20ms or method=\"GET\") and size <= 20KB) \u5b83\u5c06\u9996\u5148\u8bc4\u4f30 duration>=20ms or method=\"GET\" \uff0c\u8981\u9996\u5148\u8bc4\u4f30 method=\"GET\" and size<=20KB \uff0c\u8bf7\u786e\u4fdd\u4f7f\u7528\u9002\u5f53\u7684\u62ec\u53f7\uff0c\u5982\u4e0b\u6240\u793a\u3002 | duration >= 20ms or (method=\"GET\" and size <= 20KB)","title":"\u6807\u7b7e\u8fc7\u6ee4\u8868\u8fbe\u5f0f"},{"location":"3.k8s/7.logging/logql/#_5","text":"\u65e5\u5fd7\u884c\u683c\u5f0f\u5316\u8868\u8fbe\u5f0f\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 Golang \u7684 text/template \u6a21\u677f\u683c\u5f0f\u91cd\u5199\u65e5\u5fd7\u884c\u7684\u5185\u5bb9\uff0c\u5b83\u9700\u8981\u4e00\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570 | line_format \"{{.label_name}}\" \u4f5c\u4e3a\u6a21\u677f\u683c\u5f0f\uff0c\u6240\u6709\u7684\u6807\u7b7e\u90fd\u662f\u6ce8\u5165\u6a21\u677f\u7684\u53d8\u91cf\uff0c\u53ef\u4ee5\u7528 {{.label_name}} \u7684\u7b26\u53f7\u6765\u4f7f\u7528\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u8868\u8fbe\u5f0f\uff1a {container=\"frontend\"} | logfmt | line_format \"{{.query}} {{.duration}}\" \u5c06\u63d0\u53d6\u5e76\u91cd\u5199\u65e5\u5fd7\u884c\uff0c\u53ea\u5305\u542b query \u548c\u8bf7\u6c42\u7684 duration \u3002\u4f60\u53ef\u4ee5\u4e3a\u6a21\u677f\u4f7f\u7528\u53cc\u5f15\u53f7\u5b57\u7b26\u4e32\u6216\u53cd\u5f15\u53f7 {{.label_name}} \u6765\u907f\u514d\u8f6c\u4e49\u7279\u6b8a\u5b57\u7b26\u3002 \u6b64\u5916 line_format \u4e5f\u652f\u6301\u6570\u5b66\u51fd\u6570\uff0c\u4f8b\u5982\uff1a \u5982\u679c\u6211\u4eec\u6709\u4ee5\u4e0b\u6807\u7b7e ip=1.1.1.1 , status=200 \u548c duration=3000(ms) , \u6211\u4eec\u53ef\u4ee5\u7528 duration \u9664\u4ee5 1000 \u5f97\u5230\u4ee5\u79d2\u4e3a\u5355\u4f4d\u7684\u503c\uff1a {container=\"frontend\"} | logfmt | line_format \"{{.ip}} {{.status}} {{div .duration 1000}}\" \u4e0a\u9762\u7684\u67e5\u8be2\u5c06\u5f97\u5230\u7684\u65e5\u5fd7\u884c\u5185\u5bb9\u4e3a 1.1.1.1 200 3 \u3002","title":"\u65e5\u5fd7\u884c\u683c\u5f0f\u8868\u8fbe\u5f0f"},{"location":"3.k8s/7.logging/logql/#_6","text":"| label_format \u8868\u8fbe\u5f0f\u53ef\u4ee5\u91cd\u547d\u540d\u3001\u4fee\u6539\u6216\u6dfb\u52a0\u6807\u7b7e\uff0c\u5b83\u4ee5\u9017\u53f7\u5206\u9694\u7684\u64cd\u4f5c\u5217\u8868\u4f5c\u4e3a\u53c2\u6570\uff0c\u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\u591a\u4e2a\u64cd\u4f5c\u3002 \u5f53\u4e24\u8fb9\u90fd\u662f\u6807\u7b7e\u6807\u8bc6\u7b26\u65f6\uff0c\u4f8b\u5982 dst=src \uff0c\u8be5\u64cd\u4f5c\u5c06\u628a src \u6807\u7b7e\u91cd\u547d\u540d\u4e3a dst \u3002 \u5de6\u8fb9\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a\u6a21\u677f\u5b57\u7b26\u4e32\uff0c\u4f8b\u5982 dst=\"{{.status}} {{.query}}\" \uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c dst \u6807\u7b7e\u503c\u4f1a\u88ab Golang \u6a21\u677f\u6267\u884c\u7ed3\u679c\u6240\u53d6\u4ee3\uff0c\u8fd9\u4e0e | line_format \u8868\u8fbe\u5f0f\u662f\u540c\u4e00\u4e2a\u6a21\u677f\u5f15\u64ce\uff0c\u8fd9\u610f\u5473\u7740\u6807\u7b7e\u53ef\u4ee5\u4f5c\u4e3a\u53d8\u91cf\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u540c\u6837\u7684\u51fd\u6570\u5217\u8868\u3002 \u5728\u4e0a\u9762\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u76ee\u6807\u6807\u7b7e\u4e0d\u5b58\u5728\uff0c\u90a3\u4e48\u5c31\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6807\u7b7e\u3002 \u91cd\u547d\u540d\u5f62\u5f0f dst=src \u4f1a\u5728\u5c06 src \u6807\u7b7e\u91cd\u65b0\u6620\u5c04\u5230 dst \u6807\u7b7e\u540e\u5c06\u5176\u5220\u9664\uff0c\u7136\u800c\uff0c\u6a21\u677f\u5f62\u5f0f\u5c06\u4fdd\u7559\u5f15\u7528\u7684\u6807\u7b7e\uff0c\u4f8b\u5982 dst=\"{{.src}}\" \u7684\u7ed3\u679c\u662f dst \u548c src \u90fd\u6709\u76f8\u540c\u7684\u503c\u3002 \u4e00\u4e2a\u6807\u7b7e\u540d\u79f0\u5728\u6bcf\u4e2a\u8868\u8fbe\u5f0f\u4e2d\u53ea\u80fd\u51fa\u73b0\u4e00\u6b21\uff0c\u8fd9\u610f\u5473\u7740 | label_format foo=bar,foo=\"new\" \u662f\u4e0d\u5141\u8bb8\u7684\uff0c\u4f46\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e24\u4e2a\u8868\u8fbe\u5f0f\u6765\u8fbe\u5230\u9884\u671f\u6548\u679c\uff0c\u6bd4\u5982 | label_format foo=bar | label_format foo=\"new\" \u3002","title":"\u6807\u7b7e\u683c\u5f0f\u8868\u8fbe\u5f0f"},{"location":"3.k8s/7.logging/logql/#_7","text":"LogQL \u540c\u6837\u652f\u6301\u901a\u8fc7\u51fd\u6570\u65b9\u5f0f\u5c06\u65e5\u5fd7\u6d41\u8fdb\u884c\u5ea6\u91cf\uff0c\u901a\u5e38\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u8ba1\u7b97\u6d88\u606f\u7684\u9519\u8bef\u7387\u6216\u8005\u6392\u5e8f\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u5e94\u7528\u65e5\u5fd7\u8f93\u51fa Top N\u3002","title":"\u65e5\u5fd7\u5ea6\u91cf"},{"location":"3.k8s/7.logging/logql/#_8","text":"LogQL \u540c\u6837\u4e5f\u652f\u6301\u6709\u9650\u7684\u533a\u95f4\u5411\u91cf\u5ea6\u91cf\u8bed\u53e5\uff0c\u4f7f\u7528\u65b9\u5f0f\u548c PromQL \u7c7b\u4f3c\uff0c\u5e38\u7528\u51fd\u6570\u4e3b\u8981\u662f\u5982\u4e0b 4 \u4e2a\uff1a rate : \u8ba1\u7b97\u6bcf\u79d2\u7684\u65e5\u5fd7\u6761\u76ee count_over_time : \u5bf9\u6307\u5b9a\u8303\u56f4\u5185\u7684\u6bcf\u4e2a\u65e5\u5fd7\u6d41\u7684\u6761\u76ee\u8fdb\u884c\u8ba1\u6570 bytes_rate : \u8ba1\u7b97\u65e5\u5fd7\u6d41\u6bcf\u79d2\u7684\u5b57\u8282\u6570 bytes_over_time : \u5bf9\u6307\u5b9a\u8303\u56f4\u5185\u7684\u6bcf\u4e2a\u65e5\u5fd7\u6d41\u7684\u4f7f\u7528\u7684\u5b57\u8282\u6570 \u6bd4\u5982\u8ba1\u7b97 nginx \u7684 qps\uff1a rate({filename=\"/var/log/nginx/access.log\"}[5m])) \u8ba1\u7b97 kernel \u8fc7\u53bb 5 \u5206\u949f\u53d1\u751f oom \u7684\u6b21\u6570\uff1a count_over_time({filename=\"/var/log/message\"} |~ \"oom_kill_process\" [5m]))","title":"\u533a\u95f4\u5411\u91cf"},{"location":"3.k8s/7.logging/logql/#_9","text":"LogQL \u4e5f\u652f\u6301\u805a\u5408\u8fd0\u7b97\uff0c\u6211\u4eec\u53ef\u7528\u5b83\u6765\u805a\u5408\u5355\u4e2a\u5411\u91cf\u5185\u7684\u5143\u7d20\uff0c\u4ece\u800c\u4ea7\u751f\u4e00\u4e2a\u5177\u6709\u8f83\u5c11\u5143\u7d20\u7684\u65b0\u5411\u91cf\uff0c\u5f53\u524d\u652f\u6301\u7684\u805a\u5408\u51fd\u6570\u5982\u4e0b\uff1a sum \uff1a\u6c42\u548c min \uff1a\u6700\u5c0f\u503c max \uff1a\u6700\u5927\u503c avg \uff1a\u5e73\u5747\u503c stddev \uff1a\u6807\u51c6\u5dee stdvar \uff1a\u6807\u51c6\u65b9\u5dee count \uff1a\u8ba1\u6570 bottomk \uff1a\u6700\u5c0f\u7684 k \u4e2a\u5143\u7d20 topk \uff1a\u6700\u5927\u7684 k \u4e2a\u5143\u7d20 \u805a\u5408\u51fd\u6570\u6211\u4eec\u53ef\u4ee5\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\u63cf\u8ff0\uff1a <aggr-op>([parameter,] <vector expression>) [without|by (<label list>)] \u5bf9\u4e8e\u9700\u8981\u5bf9\u6807\u7b7e\u8fdb\u884c\u5206\u7ec4\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 without \u6216\u8005 by \u6765\u533a\u5206\u3002\u6bd4\u5982\u8ba1\u7b97 nginx \u7684 qps\uff0c\u5e76\u6309\u7167 pod \u6765\u5206\u7ec4\uff1a sum(rate({filename=\"/var/log/nginx/access.log\"}[5m])) by (pod) \u53ea\u6709\u5728\u4f7f\u7528 bottomk \u548c topk \u51fd\u6570\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u51fd\u6570\u8f93\u5165\u76f8\u5173\u7684\u53c2\u6570\u3002\u6bd4\u5982\u8ba1\u7b97 nginx \u7684 qps \u6700\u5927\u7684\u524d 5 \u4e2a\uff0c\u5e76\u6309\u7167 pod \u6765\u5206\u7ec4\uff1a topk(5,sum(rate({filename=\"/var/log/nginx/access.log\"}[5m])) by (pod)))","title":"\u805a\u5408\u51fd\u6570"},{"location":"3.k8s/7.logging/logql/#_10","text":"","title":"\u4e8c\u5143\u8fd0\u7b97"},{"location":"3.k8s/7.logging/logql/#_11","text":"Loki \u5b58\u7684\u662f\u65e5\u5fd7\uff0c\u90fd\u662f\u6587\u672c\uff0c\u600e\u4e48\u8ba1\u7b97\u5462\uff1f\u663e\u7136 LogQL \u4e2d\u7684\u6570\u5b66\u8fd0\u7b97\u662f\u9762\u5411\u533a\u95f4\u5411\u91cf\u64cd\u4f5c\u7684\uff0cLogQL \u4e2d\u7684\u652f\u6301\u7684\u4e8c\u8fdb\u5236\u8fd0\u7b97\u7b26\u5982\u4e0b\uff1a + \uff1a\u52a0\u6cd5 - \uff1a\u51cf\u6cd5 * \uff1a\u4e58\u6cd5 / \uff1a\u9664\u6cd5 % \uff1a\u6c42\u6a21 ^ \uff1a\u6c42\u5e42 \u6bd4\u5982\u6211\u4eec\u8981\u627e\u5230\u67d0\u4e2a\u4e1a\u52a1\u65e5\u5fd7\u91cc\u9762\u7684\u9519\u8bef\u7387\uff0c\u5c31\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u65b9\u5f0f\u8ba1\u7b97\uff1a sum(rate({app=\"foo\", level=\"error\"}[1m])) / sum(rate({app=\"foo\"}[1m]))","title":"\u6570\u5b66\u8ba1\u7b97"},{"location":"3.k8s/7.logging/logql/#_12","text":"\u96c6\u5408\u8fd0\u7b97\u4ec5\u5728\u533a\u95f4\u5411\u91cf\u8303\u56f4\u5185\u6709\u6548\uff0c\u5f53\u524d\u652f\u6301 and \uff1a\u5e76\u4e14 or \uff1a\u6216\u8005 unless \uff1a\u6392\u9664 \u6bd4\u5982\uff1a rate({app=~\"foo|bar\"}[1m]) and rate({app=\"bar\"}[1m])","title":"\u903b\u8f91\u8fd0\u7b97"},{"location":"3.k8s/7.logging/logql/#_13","text":"LogQL \u652f\u6301\u7684\u6bd4\u8f83\u8fd0\u7b97\u7b26\u548c PromQL \u4e00\u6837\uff0c\u5305\u62ec\uff1a == \uff1a\u7b49\u4e8e != \uff1a\u4e0d\u7b49\u4e8e > \uff1a\u5927\u4e8e >= : \u5927\u4e8e\u6216\u7b49\u4e8e < \uff1a\u5c0f\u4e8e <= : \u5c0f\u4e8e\u6216\u7b49\u4e8e \u901a\u5e38\u6211\u4eec\u4f7f\u7528\u533a\u95f4\u5411\u91cf\u8ba1\u7b97\u540e\u4f1a\u505a\u4e00\u4e2a\u9608\u503c\u7684\u6bd4\u8f83\uff0c\u8fd9\u5bf9\u5e94\u544a\u8b66\u662f\u975e\u5e38\u6709\u7528\u7684\uff0c\u6bd4\u5982\u7edf\u8ba1 5 \u5206\u949f\u5185 error \u7ea7\u522b\u65e5\u5fd7\u6761\u76ee\u5927\u4e8e 10 \u7684\u60c5\u51b5\uff1a count_over_time({app=\"foo\", level=\"error\"}[5m]) > 10 \u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5e03\u5c14\u8ba1\u7b97\u6765\u8868\u8fbe\uff0c\u6bd4\u5982\u7edf\u8ba1 5 \u5206\u949f\u5185 error \u7ea7\u522b\u65e5\u5fd7\u6761\u76ee\u5927\u4e8e 10 \u4e3a\u771f\uff0c\u53cd\u6b63\u5219\u4e3a\u5047\uff1a count_over_time({app=\"foo\", level=\"error\"}[5m]) > bool 10","title":"\u6bd4\u8f83\u8fd0\u7b97"},{"location":"3.k8s/7.logging/logql/#_14","text":"LogQL \u67e5\u8be2\u53ef\u4ee5\u4f7f\u7528 # \u5b57\u7b26\u8fdb\u884c\u6ce8\u91ca\uff0c\u4f8b\u5982\uff1a {app=\"foo\"} # anything that comes after will not be interpreted in your query \u5bf9\u4e8e\u591a\u884c LogQL \u67e5\u8be2\uff0c\u53ef\u4ee5\u4f7f\u7528 # \u6392\u9664\u6574\u4e2a\u6216\u90e8\u5206\u884c\uff1a {app=\"foo\"} | json # this line will be ignored | bar=\"baz\" # this checks if bar = \"baz\"","title":"\u6ce8\u91ca"},{"location":"3.k8s/7.logging/logql/#_15","text":"\u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u793a\u4f8b\u5e94\u7528\uff0c\u8be5\u5e94\u7528\u7a0b\u5e8f\u662f\u4e00\u4e2a\u4f2a\u9020\u7684\u8bb0\u5f55\u5668\uff0c\u5b83\u7684\u65e5\u5fd7\u5177\u6709 debug\u3001info \u548c warning \u8f93\u51fa\u5230 stdout\u3002 error \u7ea7\u522b\u7684\u65e5\u5fd7\u5c06\u88ab\u5199\u5165 stderr\uff0c\u5b9e\u9645\u7684\u65e5\u5fd7\u6d88\u606f\u4ee5 JSON \u683c\u5f0f\u751f\u6210\uff0c\u6bcf 500 \u6beb\u79d2\u5c06\u521b\u5efa\u4e00\u6761\u65b0\u7684\u65e5\u5fd7\u6d88\u606f\u3002\u65e5\u5fd7\u6d88\u606f\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a { \"app\": \"The fanciest app of mankind\", \"executable\": \"fake-logger\", \"is_even\": true, \"level\": \"debug\", \"msg\": \"This is a debug message. Hope you'll catch the bug\", \"time\": \"2022-04-04T13:41:50+02:00\", \"version\": \"1.0.0\" } \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u521b\u5efa\u793a\u4f8b\u5e94\u7528\uff1a cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: labels: app: fake-logger environment: development name: fake-logger spec: selector: matchLabels: app: fake-logger environment: development template: metadata: labels: app: fake-logger environment: development spec: containers: - image: thorstenhans/fake-logger:0.0.2 name: fake-logger resources: requests: cpu: 10m memory: 32Mi limits: cpu: 10m memory: 32Mi EOF \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 {app=\"fake-logger\"} \u5728 Grafana \u4e2d\u67e5\u8be2\u5230\u8be5\u5e94\u7528\u7684\u65e5\u5fd7\u6d41\u6570\u636e\u3002 \u7531\u4e8e\u6211\u4eec\u8be5\u793a\u4f8b\u5e94\u7528\u7684\u65e5\u5fd7\u662f JSON \u5f62\u5f0f\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u91c7\u7528 JSON \u89e3\u6790\u5668\u6765\u89e3\u6790\u65e5\u5fd7\uff0c\u8868\u8fbe\u5f0f\u4e3a {app=\"fake-logger\"} | json \uff0c\u5982\u4e0b\u6240\u793a\u3002 \u4f7f\u7528 JSON \u89e3\u6790\u5668\u89e3\u6790\u65e5\u5fd7\u540e\u53ef\u4ee5\u770b\u5230 Grafana \u63d0\u4f9b\u7684\u9762\u677f\u4f1a\u6839\u636e level \u7684\u503c\u4f7f\u7528\u4e0d\u540c\u7684\u989c\u8272\u8fdb\u884c\u533a\u5206\uff0c\u800c\u4e14\u73b0\u5728\u6211\u4eec\u65e5\u5fd7\u7684\u5c5e\u6027\u4e5f\u88ab\u6dfb\u52a0\u5230\u4e86 Log \u7684\u6807\u7b7e\u4e2d\u53bb\u4e86\u3002 \u73b0\u5728 JSON \u4e2d\u7684\u6570\u636e\u53d8\u6210\u4e86\u65e5\u5fd7\u6807\u7b7e\u6211\u4eec\u81ea\u7136\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6807\u7b7e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u8fc7\u6ee4 level=error \u7684\u65e5\u5fd7\uff0c\u53ea\u4f7f\u7528\u8868\u8fbe\u5f0f {app=\"fake-logger\"} | json | level=\"error\" \u5373\u53ef\u5b9e\u73b0\u3002 \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u9700\u6c42\u53bb\u683c\u5f0f\u5316\u8f93\u51fa\u65e5\u5fd7\uff0c\u4f7f\u7528 line_format \u5373\u53ef\u5b9e\u73b0\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5 {app=\"fake-logger\"} | json |is_even=\"true\" | line_format \"\u5728 {{.time}} \u4e8e {{.level}}@{{.pod}} Pod\u4e2d\u4ea7\u751f\u4e86\u65e5\u5fd7 {{.msg}}\" \u6765\u683c\u5f0f\u5316\u65e5\u5fd7\u8f93\u51fa","title":"\u67e5\u8be2\u793a\u4f8b"},{"location":"3.k8s/7.logging/logql/#_16","text":"\u8fd9\u91cc\u6211\u4eec\u4ee5\u76d1\u63a7 Kubernetes \u7684\u4e8b\u4ef6\u4e3a\u4f8b\u8fdb\u884c\u8bf4\u660e\u3002\u9996\u5148\u9700\u8981\u5b89\u88c5 kubernetes-event-exporter \uff0c kubernetes-event-exporter \u65e5\u5fd7\u4f1a\u6253\u5370\u5230 stdout\uff0c\u7136\u540e\u6211\u4eec\u7684 promtail \u4f1a\u5c06\u65e5\u5fd7\u4e0a\u4f20\u5230 Loki\u3002 \u7136\u540e\u5bfc\u5165 https://grafana.com/grafana/dashboards/14003 \u8fd9\u4e2a Dashboard \u5373\u53ef\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u4fee\u6539\u6bcf\u4e2a\u56fe\u8868\u4e2d\u7684\u8fc7\u6ee4\u6807\u7b7e\u4e3a job=\"monitoring/event-exporter\" \u3002 \u4fee\u6539\u540e\u6b63\u5e38\u5c31\u53ef\u4ee5\u5728 Dashboard \u4e2d\u770b\u5230\u96c6\u7fa4\u4e2d\u7684\u76f8\u5173\u4e8b\u4ef6\u4fe1\u606f\u4e86\u3002","title":"\u76d1\u63a7\u5927\u76d8"},{"location":"3.k8s/7.logging/logql/#_17","text":"\u5c3d\u91cf\u4f7f\u7528\u9759\u6001\u6807\u7b7e\uff0c\u5f00\u9500\u66f4\u5c0f\uff0c\u901a\u5e38\u65e5\u5fd7\u5728\u53d1\u9001\u5230 Loki \u4e4b\u524d\u6ce8\u5165 label\uff0c\u63a8\u8350\u7684\u9759\u6001\u6807\u7b7e\u5305\u542b\uff1a \u5bbf\u4e3b\u673a\uff1akubernetes/hosts \u5e94\u7528\u540d\uff1akubernetes/labels/app_kubernetes_io/name \u7ec4\u4ef6\u540d\uff1akubernetes/labels/name \u547d\u540d\u7a7a\u95f4\uff1akubernetes/namespace \u5176\u4ed6\u9759\u6001\u6807\u7b7e\uff0c\u5982\u73af\u5883\u3001\u7248\u672c\u7b49 \u8c28\u614e\u4f7f\u7528\u52a8\u6001\u6807\u7b7e\u3002 \u8fc7\u591a\u7684\u6807\u7b7e\u7ec4\u5408\u4f1a\u9020\u6210\u5927\u91cf\u7684\u6d41\uff0c\u5b83\u4f1a\u8ba9 Loki \u5b58\u50a8\u5927\u91cf\u7684\u7d22\u5f15\u548c\u5c0f\u5757\u7684\u5bf9\u8c61\u6587\u4ef6\u3002\u8fd9\u4e9b\u90fd\u4f1a\u663e\u8457\u6d88\u8017 Loki \u7684\u67e5\u8be2\u6027\u80fd\u3002\u4e3a\u907f\u514d\u8fd9\u4e9b\u95ee\u9898\uff0c \u5728\u4f60\u77e5\u9053\u9700\u8981\u4e4b\u524d\u4e0d\u8981\u6dfb\u52a0\u6807\u7b7e \u3002Loki \u7684\u4f18\u52bf\u5728\u4e8e\u5e76\u884c\u67e5\u8be2\uff0c\u4f7f\u7528\u8fc7\u6ee4\u5668\u8868\u8fbe\u5f0f\uff08label=\"text\", |~ \"regex\", ...\uff09\u6765\u67e5\u8be2\u65e5\u5fd7\u4f1a\u66f4\u6709\u6548\uff0c\u5e76\u4e14\u901f\u5ea6\u4e5f\u5f88\u5feb\u3002 \u6709\u754c\u7684\u6807\u7b7e\u503c\u8303\u56f4\uff0c\u4f5c\u4e3a Loki \u7684\u7528\u6237\u6216\u64cd\u4f5c\u5458\uff0c\u6211\u4eec\u7684\u76ee\u6807\u5e94\u8be5\u662f\u4f7f\u7528\u5c3d\u53ef\u80fd\u5c11\u7684\u6807\u7b7e\u6765\u5b58\u50a8\u4f60\u7684\u65e5\u5fd7\u3002\u8fd9\u610f\u5473\u7740\uff0c \u66f4\u5c11\u7684\u6807\u7b7e\u5e26\u6765\u66f4\u5c0f\u7684\u7d22\u5f15\uff0c\u4ece\u800c\u5bfc\u81f4\u66f4\u597d\u7684\u6027\u80fd \uff0c\u6240\u4ee5\u6211\u4eec\u5728\u6dfb\u52a0\u6807\u7b7e\u4e4b\u524d\u4e00\u5b9a\u8981\u4e09\u601d\u800c\u884c\u3002 \u914d\u7f6e\u7f13\u5b58\uff0cLoki \u53ef\u4ee5\u4e3a\u591a\u4e2a\u7ec4\u4ef6\u914d\u7f6e\u7f13\u5b58, \u53ef\u4ee5\u9009\u62e9 redis \u6216\u8005 memcached\uff0c\u8fd9\u53ef\u4ee5\u663e\u8457\u63d0\u9ad8\u6027\u80fd\u3002 \u5408\u7406\u4f7f\u7528 LogQL \u8bed\u6cd5\uff0c\u53ef\u5927\u5e45\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002Label matchers(\u6807\u7b7e\u5339\u914d\u5668)\u662f\u4f60\u7684\u7b2c\u4e00\u9053\u9632\u7ebf\uff0c\u662f\u5927\u5e45\u51cf\u5c11\u4f60\u641c\u7d22\u7684\u65e5\u5fd7\u6570\u91cf(\u4f8b\u5982\uff0c\u4ece 100TB \u5230 1TB)\u7684\u6700\u597d\u65b9\u6cd5\u3002\u5f53\u7136\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u9700\u8981\u5728\u65e5\u5fd7\u91c7\u96c6\u7aef\u4e0a\u6709\u826f\u597d\u7684\u6807\u7b7e\u5b9a\u4e49\u89c4\u8303\u3002","title":"\u5efa\u8bae"},{"location":"3.k8s/7.logging/loki/","text":"Loki \u00b6 Loki \u00b6 Grafana Loki \u662f\u4e00\u5957\u53ef\u4ee5\u7ec4\u5408\u6210\u4e00\u4e2a\u529f\u80fd\u9f50\u5168\u7684\u65e5\u5fd7\u5806\u6808\u7ec4\u4ef6\uff0c\u4e0e\u5176\u4ed6\u65e5\u5fd7\u8bb0\u5f55\u7cfb\u7edf\u4e0d\u540c\uff0cLoki \u662f\u57fa\u4e8e\u4ec5\u7d22\u5f15\u6709\u5173\u65e5\u5fd7\u5143\u6570\u636e\u7684\u60f3\u6cd5\u800c\u6784\u5efa\u7684\uff1a \u6807\u7b7e \uff08\u5c31\u50cf Prometheus \u6807\u7b7e\u4e00\u6837\uff09\u3002\u65e5\u5fd7\u6570\u636e\u672c\u8eab\u88ab\u538b\u7f29\u7136\u540e\u5e76\u5b58\u50a8\u5728\u5bf9\u8c61\u5b58\u50a8\uff08\u4f8b\u5982 S3 \u6216 GCS\uff09\u7684\u5757\u4e2d\uff0c\u751a\u81f3\u5b58\u50a8\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e0a\uff0c\u8f7b\u91cf\u7ea7\u7684\u7d22\u5f15\u548c\u9ad8\u5ea6\u538b\u7f29\u7684\u5757\u7b80\u5316\u4e86\u64cd\u4f5c\uff0c\u5e76\u663e\u8457\u964d\u4f4e\u4e86 Loki \u7684\u6210\u672c\uff0cLoki \u66f4\u9002\u5408\u4e2d\u5c0f\u56e2\u961f\u3002\u7531\u4e8e Loki \u4f7f\u7528\u548c Prometheus \u7c7b\u4f3c\u7684\u6807\u7b7e\u6982\u5ff5\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u719f\u6089 Prometheus \u90a3\u4e48\u5c06\u5f88\u5bb9\u6613\u4e0a\u624b\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u548c Grafana \u96c6\u6210\uff0c\u53ea\u9700\u8981\u6dfb\u52a0 Loki \u6570\u636e\u6e90\u5c31\u53ef\u4ee5\u5f00\u59cb\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\u4e86\u3002 Loki \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u65e5\u5fd7\u67e5\u8be2\u7684 LogQL \u67e5\u8be2\u8bed\u53e5\uff0c\u7c7b\u4f3c\u4e8e PromQL \uff0c\u901a\u8fc7 LogQL \u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u67e5\u8be2\u5230\u9700\u8981\u7684\u65e5\u5fd7\uff0c\u4e5f\u53ef\u4ee5\u5f88\u8f7b\u677e\u83b7\u53d6\u76d1\u63a7\u6307\u6807\u3002Loki \u8fd8\u80fd\u591f\u5c06 LogQL \u67e5\u8be2\u76f4\u63a5\u8f6c\u6362\u4e3a Prometheus \u6307\u6807\u3002\u6b64\u5916 Loki \u5141\u8bb8\u6211\u4eec\u5b9a\u4e49\u6709\u5173 LogQL \u6307\u6807\u7684\u62a5\u8b66\uff0c\u5e76\u53ef\u4ee5\u5c06\u5b83\u4eec\u548c Alertmanager \u8fdb\u884c\u5bf9\u63a5\u3002 Grafana Loki \u4e3b\u8981\u7531 3 \u90e8\u5206\u7ec4\u6210: loki : \u65e5\u5fd7\u8bb0\u5f55\u5f15\u64ce\uff0c\u8d1f\u8d23\u5b58\u50a8\u65e5\u5fd7\u548c\u5904\u7406\u67e5\u8be2 promtail : \u4ee3\u7406\uff0c\u8d1f\u8d23\u6536\u96c6\u65e5\u5fd7\u5e76\u5c06\u5176\u53d1\u9001\u7ed9 loki grafana : UI \u754c\u9762 \u6982\u8ff0 \u00b6 Loki \u662f\u4e00\u7ec4\u53ef\u4ee5\u7ec4\u6210\u529f\u80fd\u9f50\u5168\u7684\u65e5\u5fd7\u6536\u96c6\u5806\u6808\u7684\u7ec4\u4ef6\uff0c\u4e0e\u5176\u4ed6\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u4e0d\u540c\uff0cLoki \u7684\u6784\u5efa\u601d\u60f3\u662f\u4ec5\u4e3a\u65e5\u5fd7\u5efa\u7acb\u7d22\u5f15\u6807\u7b7e\uff0c\u800c\u4f7f\u539f\u59cb\u65e5\u5fd7\u6d88\u606f\u4fdd\u6301\u672a\u7d22\u5f15\u72b6\u6001\u3002\u8fd9\u610f\u5473\u7740 Loki \u7684\u8fd0\u8425\u6210\u672c\u66f4\u4f4e\uff0c\u5e76\u4e14\u6548\u7387\u66f4\u9ad8\u3002 \u591a\u79df\u6237 \u00b6 Loki \u652f\u6301\u591a\u79df\u6237\uff0c\u4ee5\u4f7f\u79df\u6237\u4e4b\u95f4\u7684\u6570\u636e\u5b8c\u5168\u5206\u79bb\u3002\u5f53 Loki \u5728\u591a\u79df\u6237\u6a21\u5f0f\u4e0b\u8fd0\u884c\u65f6\uff0c\u6240\u6709\u6570\u636e\uff08\u5305\u62ec\u5185\u5b58\u548c\u957f\u671f\u5b58\u50a8\u4e2d\u7684\u6570\u636e\uff09\u90fd\u7531\u79df\u6237 ID \u5206\u533a\uff0c\u8be5\u79df\u6237 ID \u662f\u4ece\u8bf7\u6c42\u4e2d\u7684 X-Scope-OrgID HTTP \u5934\u4e2d\u63d0\u53d6\u7684\u3002 \u5f53 Loki \u4e0d\u5728\u591a\u79df\u6237\u6a21\u5f0f\u4e0b\u65f6\uff0c\u5c06\u5ffd\u7565 Header \u5934\uff0c\u5e76\u5c06\u79df\u6237 ID \u8bbe\u7f6e\u4e3a fake \uff0c\u8fd9\u5c06\u663e\u793a\u5728\u7d22\u5f15\u548c\u5b58\u50a8\u7684\u5757\u4e2d\u3002 \u8fd0\u884c\u6a21\u5f0f \u00b6 Loki \u9488\u5bf9\u672c\u5730\u8fd0\u884c\uff08\u6216\u5c0f\u89c4\u6a21\u8fd0\u884c\uff09\u548c\u6c34\u5e73\u6269\u5c55\u8fdb\u884c\u4e86\u4f18\u5316\uff0cLoki \u5e26\u6709\u5355\u4e00\u8fdb\u7a0b\u6a21\u5f0f\uff0c\u53ef\u5728\u4e00\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u6240\u6709\u5fc5\u9700\u7684\u5fae\u670d\u52a1\u3002\u5355\u8fdb\u7a0b\u6a21\u5f0f\u975e\u5e38\u9002\u5408\u6d4b\u8bd5 Loki \u6216\u4ee5\u5c0f\u89c4\u6a21\u8fd0\u884c\u3002\u4e3a\u4e86\u5b9e\u73b0\u6c34\u5e73\u53ef\u4f38\u7f29\u6027\uff0c\u53ef\u4ee5\u5c06 Loki \u7684\u670d\u52a1\u62c6\u5206\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u4ece\u800c\u4f7f\u5b83\u4eec\u5f7c\u6b64\u72ec\u7acb\u5730\u6269\u5c55\u3002\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4ea7\u751f\u4e00\u4e2a\u7528\u4e8e\u5185\u90e8\u8bf7\u6c42\u7684 gRPC \u670d\u52a1\u5668\u548c\u4e00\u4e2a\u7528\u4e8e\u5916\u90e8 API \u8bf7\u6c42\u7684 HTTP \u670d\u52a1\uff0c\u6240\u6709\u7ec4\u4ef6\u90fd\u5e26\u6709 HTTP \u670d\u52a1\u5668\uff0c\u4f46\u662f\u5927\u591a\u6570\u53ea\u66b4\u9732\u5c31\u7eea\u63a5\u53e3\u3001\u8fd0\u884c\u72b6\u51b5\u548c\u6307\u6807\u7aef\u70b9\u3002 Loki \u8fd0\u884c\u54ea\u4e2a\u7ec4\u4ef6\u53d6\u51b3\u4e8e\u547d\u4ee4\u884c\u4e2d\u7684 -target \u6807\u5fd7\u6216 Loki \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 target\uff1a<string> \u914d\u7f6e\u3002 \u5f53 target \u7684\u503c\u4e3a all \u65f6\uff0cLoki \u5c06\u5728\u5355\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u5176\u6240\u6709\u7ec4\u4ef6\u3002\uff0c\u8fd9\u79f0\u4e3a \u5355\u8fdb\u7a0b \u6216 \u5355\u4f53\u6a21\u5f0f \u3002 \u4f7f\u7528 Helm \u5b89\u88c5 Loki \u65f6\uff0c\u5355\u4f53\u6a21\u5f0f\u662f\u9ed8\u8ba4\u90e8\u7f72\u65b9\u5f0f\u3002 \u5f53 target \u672a\u8bbe\u7f6e\u4e3a all\uff08\u5373\u88ab\u8bbe\u7f6e\u4e3a querier \u3001 ingester \u3001 query-frontend \u6216 distributor \uff09\uff0c\u5219\u53ef\u4ee5\u8bf4 Loki \u5728 \u6c34\u5e73\u4f38\u7f29 \u6216 \u5fae\u670d\u52a1\u6a21\u5f0f \u4e0b\u8fd0\u884c\u3002 Loki \u7684\u6bcf\u4e2a\u7ec4\u4ef6\uff0c\u4f8b\u5982 ingester \u548c distributors \u90fd\u4f7f\u7528 Loki \u914d\u7f6e\u4e2d\u5b9a\u4e49\u7684 gRPC \u76d1\u542c\u7aef\u53e3\u901a\u8fc7 gRPC \u76f8\u4e92\u901a\u4fe1\u3002\u5f53\u4ee5\u5355\u4f53\u6a21\u5f0f\u8fd0\u884c\u7ec4\u4ef6\u65f6\uff0c\u4ecd\u7136\u662f\u8fd9\u6837\u7684\uff0c\u5c3d\u7ba1\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4ee5\u76f8\u540c\u7684\u8fdb\u7a0b\u8fd0\u884c\uff0c\u4f46\u5b83\u4eec\u4ecd\u5c06\u901a\u8fc7\u672c\u5730\u7f51\u7edc\u76f8\u4e92\u8fde\u63a5\u8fdb\u884c\u7ec4\u4ef6\u4e4b\u95f4\u7684\u901a\u4fe1\u3002 \u5355\u4f53\u6a21\u5f0f\u975e\u5e38\u9002\u5408\u4e8e\u672c\u5730\u5f00\u53d1\u3001\u5c0f\u89c4\u6a21\u7b49\u573a\u666f\uff0c\u5355\u4f53\u6a21\u5f0f\u53ef\u4ee5\u901a\u8fc7\u591a\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u6269\u5c55\uff0c\u4f46\u6709\u4ee5\u4e0b\u9650\u5236\uff1a \u5f53\u8fd0\u884c\u5e26\u6709\u591a\u4e2a\u526f\u672c\u7684\u5355\u4f53\u6a21\u5f0f\u65f6\uff0c\u5f53\u524d\u65e0\u6cd5\u4f7f\u7528\u672c\u5730\u7d22\u5f15\u548c\u672c\u5730\u5b58\u50a8\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u526f\u672c\u5fc5\u987b\u80fd\u591f\u8bbf\u95ee\u76f8\u540c\u7684\u5b58\u50a8\u540e\u7aef\uff0c\u5e76\u4e14\u672c\u5730\u5b58\u50a8\u5bf9\u4e8e\u5e76\u53d1\u8bbf\u95ee\u5e76\u4e0d\u5b89\u5168\u3002 \u5404\u4e2a\u7ec4\u4ef6\u65e0\u6cd5\u72ec\u7acb\u7f29\u653e\uff0c\u56e0\u6b64\u8bfb\u53d6\u7ec4\u4ef6\u7684\u6570\u91cf\u4e0d\u80fd\u8d85\u8fc7\u5199\u5165\u7ec4\u4ef6\u7684\u6570\u91cf\u3002 \u7ec4\u4ef6 \u00b6 Distributor \u00b6 distributor \u670d\u52a1\u8d1f\u8d23\u5904\u7406\u5ba2\u6237\u7aef\u5199\u5165\u7684\u65e5\u5fd7\uff0c\u5b83\u672c\u8d28\u4e0a\u662f\u65e5\u5fd7\u6570\u636e\u5199\u5165\u8def\u5f84\u4e2d\u7684 \u7b2c\u4e00\u7ad9 \uff0c\u4e00\u65e6 distributor \u6536\u5230\u65e5\u5fd7\u6570\u636e\uff0c\u4f1a\u5c06\u5176\u62c6\u5206\u4e3a\u591a\u4e2a\u6279\u6b21\uff0c\u7136\u540e\u5e76\u884c\u53d1\u9001\u7ed9\u591a\u4e2a ingester \u3002 distributor \u901a\u8fc7 gRPC \u4e0e ingester \u901a\u4fe1\uff0c\u5b83\u4eec\u90fd\u662f\u65e0\u72b6\u6001\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u6839\u636e\u9700\u8981\u6269\u5927\u6216\u7f29\u5c0f\u89c4\u6a21\u3002 Hashing distributor \u5c06 \u4e00\u81f4\u6027 Hash \u548c\u53ef\u914d\u7f6e\u7684\u590d\u5236\u56e0\u5b50\u7ed3\u5408\u4f7f\u7528\uff0c\u4ee5\u786e\u5b9a ingester \u670d\u52a1\u7684\u54ea\u4e9b\u5b9e\u4f8b\u5e94\u8be5\u63a5\u6536\u6307\u5b9a\u7684\u6570\u636e\u6d41\u3002 \u6d41\u662f\u4e00\u7ec4\u4e0e \u79df\u6237\u548c\u552f\u4e00\u6807\u7b7e\u96c6 \u5173\u8054\u7684\u65e5\u5fd7\uff0c\u4f7f\u7528\u79df\u6237 ID \u548c\u6807\u7b7e\u96c6\u5bf9\u6d41\u8fdb\u884c hash \u5904\u7406\uff0c\u7136\u540e\u4f7f\u7528\u54c8\u5e0c\u67e5\u8be2\u8981\u53d1\u9001\u6d41\u7684 ingester \u3002 \u5b58\u50a8\u5728 Consul/Etcd \u4e2d\u7684\u54c8\u5e0c\u73af\u88ab\u7528\u6765\u5b9e\u73b0\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u6240\u6709\u7684 ingester \u90fd\u4f1a\u4f7f\u7528\u81ea\u5df1\u62e5\u6709\u7684\u4e00\u7ec4 Token \u6ce8\u518c\u5230\u54c8\u5e0c\u73af\u4e2d\uff0c\u6bcf\u4e2a Token \u662f\u4e00\u4e2a\u968f\u673a\u7684\u65e0\u7b26\u53f7 32 \u4f4d\u6570\u5b57\uff0c\u4e0e\u4e00\u7ec4 Token \u4e00\u8d77\uff0c ingester \u5c06\u5176\u72b6\u6001\u6ce8\u518c\u5230\u54c8\u5e0c\u73af\u4e2d\uff0c\u72b6\u6001 JOINING \u548c ACTIVE \u90fd\u53ef\u4ee5\u63a5\u6536\u5199\u8bf7\u6c42\uff0c\u800c ACTIVE \u548c LEAVING \u7684 ingester \u53ef\u4ee5\u63a5\u6536\u8bfb\u8bf7\u6c42\u3002\u5728\u8fdb\u884c\u54c8\u5e0c\u67e5\u8be2\u65f6\uff0c distributor \u53ea\u4f7f\u7528\u5904\u4e8e\u8bf7\u6c42\u7684\u9002\u5f53\u72b6\u6001\u7684 ingester \u7684 Token\u3002 \u4e3a\u4e86\u8fdb\u884c\u54c8\u5e0c\u67e5\u627e\uff0c distributor \u627e\u5230\u6700\u5c0f\u5408\u9002\u7684 Token\uff0c\u5176\u503c\u5927\u4e8e\u65e5\u5fd7\u6d41\u7684\u54c8\u5e0c\u503c\uff0c\u5f53\u590d\u5236\u56e0\u5b50\u5927\u4e8e 1 \u65f6\uff0c\u5c5e\u4e8e\u4e0d\u540c ingester \u7684\u4e0b\u4e00\u4e2a\u540e\u7eed Token\uff08\u5728\u73af\u4e2d\u987a\u65f6\u9488\u65b9\u5411\uff09\u4e5f\u5c06\u88ab\u5305\u62ec\u5728\u7ed3\u679c\u4e2d\u3002 \u8fd9\u79cd\u54c8\u5e0c\u914d\u7f6e\u7684\u6548\u679c\u662f\uff0c\u4e00\u4e2a ingester \u62e5\u6709\u7684\u6bcf\u4e2a Token \u90fd\u8d1f\u8d23\u4e00\u4e2a\u8303\u56f4\u7684\u54c8\u5e0c\u503c\uff0c\u5982\u679c\u6709\u4e09\u4e2a\u503c\u4e3a 0\u300125 \u548c 50 \u7684 Token\uff0c\u90a3\u4e48 3 \u7684\u54c8\u5e0c\u503c\u5c06\u88ab\u7ed9\u4e88\u62e5\u6709 25 \u8fd9\u4e2a Token \u7684 ingester \uff0c\u62e5\u6709 25 \u8fd9\u4e2a Token \u7684 ingester \u8d1f\u8d23 1-25 \u7684\u54c8\u5e0c\u503c\u8303\u56f4\u3002 Ingester \u00b6 ingester \u8d1f\u8d23\u63a5\u6536 distributor \u53d1\u9001\u8fc7\u6765\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u5b58\u50a8\u65e5\u5fd7\u7684\u7d22\u5f15\u6570\u636e\u4ee5\u53ca\u5185\u5bb9\u6570\u636e\u3002\u6b64\u5916 ingester \u4f1a\u9a8c\u8bc1\u6444\u53d6\u7684\u65e5\u5fd7\u884c\u662f\u5426\u6309\u7167\u65f6\u95f4\u6233\u9012\u589e\u7684\u987a\u5e8f\u63a5\u6536\u7684\uff08\u5373\u6bcf\u6761\u65e5\u5fd7\u7684\u65f6\u95f4\u6233\u90fd\u6bd4\u524d\u9762\u7684\u65e5\u5fd7\u665a\u4e00\u4e9b\uff09\uff0c\u5f53 ingester \u6536\u5230\u4e0d\u7b26\u5408\u8fd9\u4e2a\u987a\u5e8f\u7684\u65e5\u5fd7\u65f6\uff0c\u8be5\u65e5\u5fd7\u884c\u4f1a\u88ab\u62d2\u7edd\u5e76\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\u3002 \u5982\u679c\u4f20\u5165\u7684\u884c\u4e0e\u4e4b\u524d\u6536\u5230\u7684\u884c\u5b8c\u5168\u5339\u914d\uff08\u4e0e\u4e4b\u524d\u7684\u65f6\u95f4\u6233\u548c\u65e5\u5fd7\u6587\u672c\u90fd\u5339\u914d\uff09\uff0c\u4f20\u5165\u7684\u884c\u5c06\u88ab\u89c6\u4e3a\u5b8c\u5168\u91cd\u590d\u5e76\u88ab\u5ffd\u7565\u3002 \u5982\u679c\u4f20\u5165\u7684\u884c\u4e0e\u524d\u4e00\u884c\u7684\u65f6\u95f4\u6233\u76f8\u540c\uff0c\u4f46\u5185\u5bb9\u4e0d\u540c\uff0c\u5219\u63a5\u53d7\u8be5\u65e5\u5fd7\u884c\uff0c\u8868\u793a\u540c\u4e00\u65f6\u95f4\u6233\u6709\u4e24\u4e2a\u4e0d\u540c\u7684\u65e5\u5fd7\u884c\u662f\u53ef\u80fd\u7684\u3002 \u6765\u81ea\u6bcf\u4e2a\u552f\u4e00\u6807\u7b7e\u96c6\u7684\u65e5\u5fd7\u5728\u5185\u5b58\u4e2d\u88ab\u5efa\u7acb\u6210 chunks(\u5757) \uff0c\u7136\u540e\u53ef\u4ee5\u6839\u636e\u914d\u7f6e\u7684\u65f6\u95f4\u95f4\u9694\u5237\u65b0\u5230\u652f\u6301\u7684\u540e\u7aef\u5b58\u50a8\u3002\u5728\u4e0b\u5217\u60c5\u51b5\u4e0b\uff0c\u5757\u88ab\u538b\u7f29\u5e76\u6807\u8bb0\u4e3a\u53ea\u8bfb\uff1a \u5f53\u524d\u5757\u5bb9\u91cf\u5df2\u6ee1\uff08\u8be5\u503c\u53ef\u914d\u7f6e\uff09 \u8fc7\u4e86\u592a\u957f\u65f6\u95f4\u6ca1\u6709\u66f4\u65b0\u5f53\u524d\u5757\u7684\u5185\u5bb9 \u5237\u65b0\u4e86 \u6bcf\u5f53\u4e00\u4e2a\u6570\u636e\u5757\u88ab\u538b\u7f29\u5e76\u6807\u8bb0\u4e3a\u53ea\u8bfb\u65f6\uff0c\u4e00\u4e2a\u53ef\u5199\u7684\u6570\u636e\u5757\u5c31\u4f1a\u53d6\u4ee3\u5b83\u3002\u5982\u679c\u4e00\u4e2a ingester \u8fdb\u7a0b\u5d29\u6e83\u6216\u7a81\u7136\u9000\u51fa\uff0c\u6240\u6709\u5c1a\u672a\u5237\u65b0\u7684\u6570\u636e\u90fd\u4f1a\u4e22\u5931\uff0cLoki \u901a\u5e38\u914d\u7f6e\u4e3a\u591a\u4e2a\u526f\u672c\u6765 \u964d\u4f4e \u8fd9\u79cd\u98ce\u9669\u3002 \u5f53\u5411\u6301\u4e45\u5b58\u50a8\u5237\u65b0\u65f6\uff0c\u8be5\u5757\u5c06\u6839\u636e\u5176\u79df\u6237\u3001\u6807\u7b7e\u548c\u5185\u5bb9\u8fdb\u884c\u54c8\u5e0c\u5904\u7406\uff0c\u8fd9\u610f\u5473\u7740\u5177\u6709\u76f8\u540c\u6570\u636e\u526f\u672c\u7684\u591a\u4e2a ingester \u5b9e\u4f8b\u4e0d\u4f1a\u5c06\u76f8\u540c\u7684\u6570\u636e\u4e24\u6b21\u5199\u5165\u5907\u4efd\u5b58\u50a8\u4e2d\uff0c\u4f46\u5982\u679c\u5bf9\u5176\u4e2d\u4e00\u4e2a\u526f\u672c\u7684\u5199\u5165\u5931\u8d25\uff0c\u5219\u4f1a\u5728\u5907\u4efd\u5b58\u50a8\u4e2d\u521b\u5efa\u591a\u4e2a\u4e0d\u540c\u7684\u5757\u5bf9\u8c61\u3002 WAL \u4e0a\u9762\u6211\u4eec\u63d0\u5230\u4e86 ingester \u5c06\u6570\u636e\u4e34\u65f6\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u5982\u679c\u53d1\u751f\u4e86\u5d29\u6e83\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6570\u636e\u4e22\u5931\uff0c\u800c WAL \u5c31\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u6765\u63d0\u9ad8\u8fd9\u65b9\u9762\u7684\u53ef\u9760\u6027\u3002 \u5728\u8ba1\u7b97\u673a\u9886\u57df\uff0cWAL\uff08Write-ahead logging\uff0c\u9884\u5199\u5f0f\u65e5\u5fd7\uff09\u662f\u6570\u636e\u5e93\u7cfb\u7edf\u63d0\u4f9b\u539f\u5b50\u6027\u548c\u6301\u4e45\u5316\u7684\u4e00\u7cfb\u5217\u6280\u672f\u3002 \u5728\u4f7f\u7528 WAL \u7684\u7cfb\u7edf\u4e2d\uff0c\u6240\u6709\u7684\u4fee\u6539\u90fd\u5148\u88ab\u5199\u5165\u5230\u65e5\u5fd7\u4e2d\uff0c\u7136\u540e\u518d\u88ab\u5e94\u7528\u5230\u7cfb\u7edf\u72b6\u6001\u4e2d\u3002\u901a\u5e38\u5305\u542b redo \u548c undo \u4e24\u90e8\u5206\u4fe1\u606f\u3002\u4e3a\u4ec0\u4e48\u9700\u8981\u4f7f\u7528 WAL\uff0c\u7136\u540e\u5305\u542b redo \u548c undo \u4fe1\u606f\u5462\uff1f\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5982\u679c\u4e00\u4e2a\u7cfb\u7edf\u76f4\u63a5\u5c06\u53d8\u66f4\u5e94\u7528\u5230\u7cfb\u7edf\u72b6\u6001\u4e2d\uff0c\u90a3\u4e48\u5728\u673a\u5668\u65ad\u7535\u91cd\u542f\u4e4b\u540e\u7cfb\u7edf\u9700\u8981\u77e5\u9053\u64cd\u4f5c\u662f\u6210\u529f\u4e86\uff0c\u8fd8\u662f\u53ea\u6709\u90e8\u5206\u6210\u529f\u6216\u8005\u662f\u5931\u8d25\u4e86\uff08\u4e3a\u4e86\u6062\u590d\u72b6\u6001\uff09\u3002\u5982\u679c\u4f7f\u7528\u4e86 WAL\uff0c\u90a3\u4e48\u5728\u91cd\u542f\u4e4b\u540e\u7cfb\u7edf\u53ef\u4ee5\u901a\u8fc7\u6bd4\u8f83\u65e5\u5fd7\u548c\u7cfb\u7edf\u72b6\u6001\u6765\u51b3\u5b9a\u662f\u7ee7\u7eed\u5b8c\u6210\u64cd\u4f5c\u8fd8\u662f\u64a4\u9500\u64cd\u4f5c\u3002 redo log \u79f0\u4e3a\u91cd\u505a\u65e5\u5fd7\uff0c\u6bcf\u5f53\u6709\u64cd\u4f5c\u65f6\uff0c\u5728\u6570\u636e\u53d8\u66f4\u4e4b\u524d\u5c06\u64cd\u4f5c\u5199\u5165 redo log \uff0c\u8fd9\u6837\u5f53\u53d1\u751f\u65ad\u7535\u4e4b\u7c7b\u7684\u60c5\u51b5\u65f6\u7cfb\u7edf\u53ef\u4ee5\u5728\u91cd\u542f\u540e\u7ee7\u7eed\u64cd\u4f5c\u3002 undo log \u79f0\u4e3a\u64a4\u9500\u65e5\u5fd7\uff0c\u5f53\u4e00\u4e9b\u53d8\u66f4\u6267\u884c\u5230\u4e00\u534a\u65e0\u6cd5\u5b8c\u6210\u65f6\uff0c\u53ef\u4ee5\u6839\u636e\u64a4\u9500\u65e5\u5fd7\u6062\u590d\u5230\u53d8\u66f4\u4e4b\u95f4\u7684\u72b6\u6001\u3002 Loki \u4e2d\u7684 WAL \u8bb0\u5f55\u4e86\u4f20\u5165\u7684\u6570\u636e\uff0c\u5e76\u5c06\u5176\u5b58\u50a8\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u4ee5\u4fdd\u8bc1\u5728\u8fdb\u7a0b\u5d29\u6e83\u7684\u60c5\u51b5\u4e0b\u6301\u4e45\u4fdd\u5b58\u5df2\u786e\u8ba4\u7684\u6570\u636e\u3002\u91cd\u65b0\u542f\u52a8\u540e\uff0cLoki \u5c06 \u91cd\u653e \u65e5\u5fd7\u4e2d\u7684\u6240\u6709\u6570\u636e\uff0c\u7136\u540e\u5c06\u81ea\u8eab\u6ce8\u518c\uff0c\u51c6\u5907\u8fdb\u884c\u540e\u7eed\u5199\u64cd\u4f5c\u3002\u8fd9\u4f7f\u5f97 Loki \u80fd\u591f\u4fdd\u6301\u5728\u5185\u5b58\u4e2d\u7f13\u51b2\u6570\u636e\u7684\u6027\u80fd\u548c\u6210\u672c\u4f18\u52bf\uff0c\u4ee5\u53ca\u6301\u4e45\u6027\u4f18\u52bf\uff08\u4e00\u65e6\u5199\u88ab\u786e\u8ba4\uff0c\u5b83\u5c31\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\uff09\u3002 Querier \u00b6 Querier \u63a5\u6536\u65e5\u5fd7\u6570\u636e\u67e5\u8be2\u3001\u805a\u5408\u7edf\u8ba1\u8bf7\u6c42\uff0c\u4f7f\u7528 LogQL \u67e5\u8be2\u8bed\u8a00\u5904\u7406\u67e5\u8be2\uff0c\u4ece ingester \u548c\u957f\u671f\u5b58\u50a8\u4e2d\u83b7\u53d6\u65e5\u5fd7\u3002 \u67e5\u8be2\u5668\u67e5\u8be2\u6240\u6709 ingester \u7684\u5185\u5b58\u6570\u636e\uff0c\u7136\u540e\u518d\u5230\u540e\u7aef\u5b58\u50a8\u8fd0\u884c\u76f8\u540c\u7684\u67e5\u8be2\u3002\u7531\u4e8e\u590d\u5236\u56e0\u5b50\uff0c\u67e5\u8be2\u5668\u6709\u53ef\u80fd\u4f1a\u6536\u5230\u91cd\u590d\u7684\u6570\u636e\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u67e5\u8be2\u5668\u5728\u5185\u90e8\u5bf9\u5177\u6709\u76f8\u540c\u7eb3\u79d2\u65f6\u95f4\u6233\u3001\u6807\u7b7e\u96c6\u548c\u65e5\u5fd7\u4fe1\u606f\u7684\u6570\u636e\u8fdb\u884c\u91cd\u590d\u6570\u636e\u5220\u9664\u3002 Query Frontend \u00b6 Query Frontend \u67e5\u8be2\u524d\u7aef\u662f\u4e00\u4e2a\u53ef\u9009\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u7528\u6765\u52a0\u901f\u8bfb\u53d6\u8def\u5f84\u3002\u5f53\u67e5\u8be2\u524d\u7aef\u5c31\u4f4d\u65f6\uff0c\u5c06\u4f20\u5165\u7684\u67e5\u8be2\u8bf7\u6c42\u5b9a\u5411\u5230\u67e5\u8be2\u524d\u7aef\uff0c\u800c\u4e0d\u662f querier , \u4e3a\u4e86\u6267\u884c\u5b9e\u9645\u7684\u67e5\u8be2\uff0c\u7fa4\u96c6\u4e2d\u4ecd\u9700\u8981 querier \u670d\u52a1\u3002 \u67e5\u8be2\u524d\u7aef\u5728\u5185\u90e8\u6267\u884c\u4e00\u4e9b\u67e5\u8be2\u8c03\u6574\uff0c\u5e76\u5728\u5185\u90e8\u961f\u5217\u4e2d\u4fdd\u5b58\u67e5\u8be2\u3002 querier \u4f5c\u4e3a workers \u4ece\u961f\u5217\u4e2d\u63d0\u53d6\u4f5c\u4e1a\uff0c\u6267\u884c\u5b83\u4eec\uff0c\u5e76\u5c06\u5b83\u4eec\u8fd4\u56de\u5230\u67e5\u8be2\u524d\u7aef\u8fdb\u884c\u6c47\u603b\u3002 querier \u9700\u8981\u914d\u7f6e\u67e5\u8be2\u524d\u7aef\u5730\u5740\uff0c\u4ee5\u4fbf\u5141\u8bb8\u5b83\u4eec\u8fde\u63a5\u5230\u67e5\u8be2\u524d\u7aef\u3002 \u67e5\u8be2\u524d\u7aef\u662f\u65e0\u72b6\u6001\u7684\uff0c\u7136\u800c\uff0c\u7531\u4e8e\u5185\u90e8\u961f\u5217\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u5efa\u8bae\u8fd0\u884c\u51e0\u4e2a\u67e5\u8be2\u524d\u53f0\u7684\u526f\u672c\uff0c\u4ee5\u83b7\u5f97\u516c\u5e73\u8c03\u5ea6\u7684\u597d\u5904\uff0c\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4e24\u4e2a\u526f\u672c\u5e94\u8be5\u8db3\u591f\u4e86\u3002 \u961f\u5217 \u67e5\u8be2\u524d\u7aef\u7684\u6392\u961f\u673a\u5236\u7528\u4e8e\uff1a \u786e\u4fdd\u53ef\u80fd\u5bfc\u81f4 querier \u51fa\u73b0\u5185\u5b58\u4e0d\u8db3\uff08OOM\uff09\u9519\u8bef\u7684\u67e5\u8be2\u5728\u5931\u8d25\u65f6\u88ab\u91cd\u8bd5\u3002\u8fd9\u6837\u7ba1\u7406\u5458\u5c31\u53ef\u4ee5\u4e3a\u67e5\u8be2\u63d0\u4f9b\u7a0d\u4f4e\u7684\u5185\u5b58\uff0c\u6216\u8005\u5e76\u884c\u8fd0\u884c\u66f4\u591a\u7684\u5c0f\u578b\u67e5\u8be2\uff0c\u8fd9\u6709\u52a9\u4e8e\u964d\u4f4e\u603b\u6210\u672c\u3002 \u901a\u8fc7\u4f7f\u7528\u5148\u8fdb\u5148\u51fa\u961f\u5217\uff08FIFO\uff09\u5c06\u591a\u4e2a\u5927\u578b\u8bf7\u6c42\u5206\u914d\u5230\u6240\u6709 querier \u4e0a\uff0c\u4ee5\u9632\u6b62\u5728\u5355\u4e2a querier \u4e2d\u8fdb\u884c\u591a\u4e2a\u5927\u578b\u8bf7\u6c42\u3002 \u901a\u8fc7\u5728\u79df\u6237\u4e4b\u95f4\u516c\u5e73\u8c03\u5ea6\u67e5\u8be2\u3002 \u5206\u5272 \u67e5\u8be2\u524d\u7aef\u5c06\u8f83\u5927\u7684\u67e5\u8be2\u5206\u5272\u6210\u591a\u4e2a\u8f83\u5c0f\u7684\u67e5\u8be2\uff0c\u5728\u4e0b\u6e38 querier \u4e0a\u5e76\u884c\u6267\u884c\u8fd9\u4e9b\u67e5\u8be2\uff0c\u5e76\u5c06\u7ed3\u679c\u518d\u6b21\u62fc\u63a5\u8d77\u6765\u3002\u8fd9\u53ef\u4ee5\u9632\u6b62\u5927\u578b\u67e5\u8be2\u5728\u5355\u4e2a\u67e5\u8be2\u5668\u4e2d\u9020\u6210\u5185\u5b58\u4e0d\u8db3\u7684\u95ee\u9898\uff0c\u5e76\u6709\u52a9\u4e8e\u66f4\u5feb\u5730\u6267\u884c\u8fd9\u4e9b\u67e5\u8be2\u3002 \u7f13\u5b58 \u67e5\u8be2\u524d\u7aef\u652f\u6301\u7f13\u5b58\u67e5\u8be2\u7ed3\u679c\uff0c\u5e76\u5728\u540e\u7eed\u67e5\u8be2\u4e2d\u91cd\u590d\u4f7f\u7528\u3002\u5982\u679c\u7f13\u5b58\u7684\u7ed3\u679c\u4e0d\u5b8c\u6574\uff0c\u67e5\u8be2\u524d\u7aef\u4f1a\u8ba1\u7b97\u6240\u9700\u7684\u5b50\u67e5\u8be2\uff0c\u5e76\u5728\u4e0b\u6e38 querier \u4e0a\u5e76\u884c\u6267\u884c\u8fd9\u4e9b\u5b50\u67e5\u8be2\u3002\u67e5\u8be2\u524d\u7aef\u53ef\u4ee5\u9009\u62e9\u5c06\u67e5\u8be2\u4e0e\u5176 step \u53c2\u6570\u5bf9\u9f50\uff0c\u4ee5\u63d0\u9ad8\u67e5\u8be2\u7ed3\u679c\u7684\u53ef\u7f13\u5b58\u6027\u3002 \u8bfb\u53d6\u8def\u5f84 \u00b6 \u65e5\u5fd7\u8bfb\u53d6\u8def\u5f84\u7684\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a \u67e5\u8be2\u5668\u6536\u5230\u4e00\u4e2a\u5bf9\u6570\u636e\u7684 HTTP \u8bf7\u6c42\u3002 \u67e5\u8be2\u5668\u5c06\u67e5\u8be2\u4f20\u9012\u7ed9\u6240\u6709 ingester \u3002 ingester \u6536\u5230\u8bfb\u53d6\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u4e0e\u67e5\u8be2\u76f8\u5339\u914d\u7684\u6570\u636e\u3002 \u5982\u679c\u6ca1\u6709 ingester \u8fd4\u56de\u6570\u636e\uff0c\u67e5\u8be2\u5668\u4f1a\u4ece\u540e\u7aef\u5b58\u50a8\u52a0\u8f7d\u6570\u636e\uff0c\u5e76\u5bf9\u5176\u8fd0\u884c\u67e5\u8be2\u3002 \u67e5\u8be2\u5668\u5bf9\u6240\u6709\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u8fed\u4ee3\u548c\u91cd\u590d\u8ba1\u7b97\uff0c\u901a\u8fc7 HTTP \u8fde\u63a5\u8fd4\u56de\u6700\u540e\u4e00\u7ec4\u6570\u636e\u3002 \u5199\u5165\u8def\u5f84 \u00b6 \u6574\u4f53\u7684\u65e5\u5fd7\u5199\u5165\u8def\u5f84\u5982\u4e0b\u6240\u793a\uff1a distributor \u6536\u5230\u4e00\u4e2a HTTP \u8bf7\u6c42\uff0c\u4ee5\u5b58\u50a8\u6d41\u7684\u6570\u636e\u3002 \u6bcf\u4e2a\u6d41\u90fd\u4f7f\u7528\u54c8\u5e0c\u73af\u8fdb\u884c\u54c8\u5e0c\u64cd\u4f5c\u3002 distributor \u5c06\u6bcf\u4e2a\u6d41\u53d1\u9001\u5230\u5408\u9002\u7684 ingester \u548c\u4ed6\u4eec\u7684\u526f\u672c\uff08\u57fa\u4e8e\u914d\u7f6e\u7684\u590d\u5236\u56e0\u5b50\uff09\u3002 \u6bcf\u4e2a ingester \u5c06\u4e3a\u65e5\u5fd7\u6d41\u6570\u636e\u521b\u5efa\u4e00\u4e2a\u5757\u6216\u9644\u52a0\u5230\u4e00\u4e2a\u73b0\u6709\u7684\u5757\u4e0a\u3002\u6bcf\u4e2a\u79df\u6237\u548c\u6bcf\u4e2a\u6807\u7b7e\u96c6\u7684\u5757\u662f\u552f\u4e00\u7684\u3002 \u5b89\u88c5 \u00b6 \u9996\u5148\u6dfb\u52a0 Loki \u7684 Chart \u4ed3\u5e93\uff1a $ helm repo add grafana https://grafana.github.io/helm-charts $ helm repo update \u83b7\u53d6 loki-stack \u7684 Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull grafana/loki-stack --untar --version 2.6.4 loki-stack \u8fd9\u4e2a Chart \u5305\u91cc\u9762\u5305\u542b\u6240\u6709\u7684 Loki \u76f8\u5173\u5de5\u5177\u4f9d\u8d56\uff0c\u5728\u5b89\u88c5\u7684\u65f6\u5019\u53ef\u4ee5\u6839\u636e\u9700\u8981\u5f00\u542f\u6216\u5173\u95ed\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u5b89\u88c5 Grafana\uff0c\u5219\u53ef\u4ee5\u5728\u5b89\u88c5\u7684\u65f6\u5019\u7b80\u5355\u8bbe\u7f6e --set grafana.enabled=true \u5373\u53ef\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b loki \u3001 promtail \u662f\u81ea\u52a8\u5f00\u542f\u7684\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u9700\u8981\u9009\u62e9\u4f7f\u7528 filebeat \u6216\u8005 logstash \uff0c\u540c\u6837\u5728 Chart \u5305\u6839\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 Values \u6587\u4ef6\uff1a # values-prod.yaml loki: enabled: true replicas: 1 rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path promtail: enabled: true rbac: pspEnabled: false grafana: enabled: true service: type: NodePort rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path accessModes: - ReadWriteOnce size: 1Gi \u7136\u540e\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 Values \u6587\u4ef6\u8fdb\u884c\u5b89\u88c5\u5373\u53ef\uff1a $ helm upgrade --install loki -n logging -f values-prod.yaml . Release \"loki\" does not exist. Installing it now. NAME: loki LAST DEPLOYED: Tue Jun 14 14:45:50 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 NOTES: The Loki stack has been deployed to your cluster. Loki can now be added as a datasource in Grafana. See http://docs.grafana.org/features/datasources/loki/ for more detail. \u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b Pod \u7684\u72b6\u6001\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE loki-0 1/1 Running 0 5m19s loki-grafana-5f9df99f6d-8rwbz 2/2 Running 0 5m19s loki-promtail-ptxxl 1/1 Running 0 5m19s loki-promtail-xc55z 1/1 Running 0 5m19s loki-promtail-zg9tv 1/1 Running 0 5m19s \u8fd9\u91cc\u6211\u4eec\u4e3a Grafana \u8bbe\u7f6e\u7684 NodePort \u7c7b\u578b\u7684 Service\uff1a $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE loki ClusterIP 10.104.186.9 <none> 3100/TCP 5m34s loki-grafana NodePort 10.110.58.196 <none> 80:31634/TCP 5m34s loki-headless ClusterIP None <none> 3100/TCP 5m34s \u53ef\u4ee5\u901a\u8fc7 NodePort \u7aef\u53e3 31634 \u8bbf\u95ee Grafana\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u83b7\u53d6 Grafana \u7684\u767b\u5f55\u5bc6\u7801\uff1a $ kubectl get secret --namespace logging loki-grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo \u4f7f\u7528\u7528\u6237\u540d admin \u548c\u4e0a\u9762\u7684\u83b7\u53d6\u7684\u5bc6\u7801\u5373\u53ef\u767b\u5f55 Grafana\uff0c\u7531\u4e8e Helm Chart \u5df2\u7ecf\u4e3a Grafana \u914d\u7f6e\u597d\u4e86 Loki \u7684\u6570\u636e\u6e90\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\u5230\u65e5\u5fd7\u6570\u636e\u4e86\u3002\u70b9\u51fb\u5de6\u4fa7 Explore \u83dc\u5355\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u7b5b\u9009 Loki \u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a \u6211\u4eec\u4f7f\u7528 Helm \u5b89\u88c5\u7684 Promtail \u9ed8\u8ba4\u5df2\u7ecf\u5e2e\u6211\u4eec\u505a\u597d\u4e86\u914d\u7f6e\uff0c\u5df2\u7ecf\u9488\u5bf9 Kubernetes \u505a\u4e86\u4f18\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5176\u914d\u7f6e\uff1a $ kubectl get secret loki-promtail -n logging -o json | jq -r '.data.\"promtail.yaml\"' | base64 --decode server: log_level: info http_listen_port: 3101 client: url: http://loki:3100/loki/api/v1/push positions: filename: /run/promtail/positions.yaml scrape_configs: # See also https://github.com/grafana/loki/blob/master/production/ksonnet/promtail/scrape_config.libsonnet for reference - job_name: kubernetes-pods pipeline_stages: - cri: {} kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_controller_name regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})? action: replace target_label: __tmp_controller_name - source_labels: - __meta_kubernetes_pod_label_app_kubernetes_io_name - __meta_kubernetes_pod_label_app - __tmp_controller_name - __meta_kubernetes_pod_name regex: ^;*([^;]+)(;.*)?$ action: replace target_label: app - source_labels: - __meta_kubernetes_pod_label_app_kubernetes_io_component - __meta_kubernetes_pod_label_component regex: ^;*([^;]+)(;.*)?$ action: replace target_label: component - action: replace source_labels: - __meta_kubernetes_pod_node_name target_label: node_name - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace replacement: $1 separator: / source_labels: - namespace - app target_label: job - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: replace source_labels: - __meta_kubernetes_pod_container_name target_label: container - action: replace replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_uid - __meta_kubernetes_pod_container_name target_label: __path__ - action: replace regex: true/(.*) replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash - __meta_kubernetes_pod_container_name target_label: __path__ \u6536\u96c6 Traefik \u65e5\u5fd7 \u00b6 \u8fd9\u91cc\u6211\u4eec\u4ee5\u6536\u96c6 Traefik \u4e3a\u4f8b\uff0c\u4e3a Traefik \u5b9a\u5236\u4e00\u4e2a\u53ef\u89c6\u5316\u7684 Dashboard\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8bbf\u95ee\u65e5\u5fd7\u6ca1\u6709\u8f93\u51fa\u5230 stdout\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u8bbe\u7f6e --accesslog=true \u6765\u5f00\u542f\uff0c\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u8bbf\u95ee\u65e5\u5fd7\u683c\u5f0f\u4e3a json\uff0c\u8fd9\u6837\u66f4\u65b9\u4fbf\u5728 Loki \u4e2d\u67e5\u8be2\u4f7f\u7528\uff1a containers: - args: - --accesslog=true - --accesslog.format=json ...... \u9ed8\u8ba4 traefik \u7684\u65e5\u5fd7\u8f93\u51fa\u4e3a stdout\uff0c\u5982\u679c\u4f60\u7684\u91c7\u96c6\u7aef\u662f\u901a\u8fc7\u8bfb\u53d6\u6587\u4ef6\u7684\u8bdd\uff0c\u5219\u9700\u8981\u7528 filePath \u53c2\u6570\u5c06 traefik \u7684\u65e5\u5fd7\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u76ee\u5f55\u3002 \u4fee\u6539\u5b8c\u6210\u540e\u6b63\u5e38\u5728 Grafana \u4e2d\u5c31\u53ef\u4ee5\u770b\u5230 Traefik \u7684\u8bbf\u95ee\u65e5\u5fd7\u4e86\uff1a \u7136\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u5bfc\u5165 Dashboard \u6765\u5c55\u793a Traefik \u7684\u4fe1\u606f\uff1a https://grafana.com/grafana/dashboards/13713 \uff0c\u5728 Grafana \u4e2d\u5bfc\u5165 13713 \u53f7 Dashboard\uff1a \u4e0d\u8fc7\u8981\u6ce8\u610f\u6211\u4eec\u9700\u8981\u66f4\u6539 Dashboard \u91cc\u9762\u56fe\u8868\u7684\u67e5\u8be2\u8bed\u53e5\uff0c\u5c06 job \u7684\u503c\u66f4\u6539\u4e3a\u4f60\u5b9e\u9645\u7684\u6807\u7b7e\uff0c\u6bd4\u5982\u6211\u8fd9\u91cc\u91c7\u96c6 Traefik \u65e5\u5fd7\u7684\u6700\u7ec8\u6807\u7b7e\u4e3a job=\"kube-system/traefik\" \uff1a \u6b64\u5916\u8be5 Dashboard \u4e0a\u8fd8\u51fa\u73b0\u4e86 Panel plugin not found: grafana-piechart-panel \u8fd9\u6837\u7684\u63d0\u793a\uff0c\u8fd9\u662f\u56e0\u4e3a\u8be5\u9762\u677f\u4f9d\u8d56 grafana-piechart-panel \u8fd9\u4e2a\u63d2\u4ef6\uff0c\u6211\u4eec\u8fdb\u5165 Grafana \u5bb9\u5668\u5185\u5b89\u88c5\u91cd\u5efa Pod \u5373\u53ef\uff1a $ kubectl exec -it loki-grafana-864fc6999c-z9587 -n logging -- /bin/bash bash-5.0$ grafana-cli plugins install grafana-piechart-panel installing grafana-piechart-panel @ 1.6.1 from: https://grafana.com/api/plugins/grafana-piechart-panel/versions/1.6.1/download into: /var/lib/grafana/plugins \u2714 Installed grafana-piechart-panel successfully Restart grafana after installing plugins . <service grafana-server restart> \u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5b89\u88c5\u7684\u65f6\u5019\u4e3a Grafana \u6301\u4e45\u5316\u4e86\u6570\u636e\uff0c\u6240\u4ee5\u5220\u6389 Pod \u91cd\u5efa\u5373\u53ef\uff1a kubectl delete pod loki-grafana-864fc6999c-z9587 -n logging pod \"loki-grafana-864fc6999c-z9587\" deleted \u6700\u540e\u8c03\u6574\u8fc7\u540e\u7684 Traefik Dashboard \u5927\u76d8\u6548\u679c\u5982\u4e0b\u6240\u793a\uff1a","title":"kubernete Loki"},{"location":"3.k8s/7.logging/loki/#loki","text":"","title":"Loki"},{"location":"3.k8s/7.logging/loki/#loki_1","text":"Grafana Loki \u662f\u4e00\u5957\u53ef\u4ee5\u7ec4\u5408\u6210\u4e00\u4e2a\u529f\u80fd\u9f50\u5168\u7684\u65e5\u5fd7\u5806\u6808\u7ec4\u4ef6\uff0c\u4e0e\u5176\u4ed6\u65e5\u5fd7\u8bb0\u5f55\u7cfb\u7edf\u4e0d\u540c\uff0cLoki \u662f\u57fa\u4e8e\u4ec5\u7d22\u5f15\u6709\u5173\u65e5\u5fd7\u5143\u6570\u636e\u7684\u60f3\u6cd5\u800c\u6784\u5efa\u7684\uff1a \u6807\u7b7e \uff08\u5c31\u50cf Prometheus \u6807\u7b7e\u4e00\u6837\uff09\u3002\u65e5\u5fd7\u6570\u636e\u672c\u8eab\u88ab\u538b\u7f29\u7136\u540e\u5e76\u5b58\u50a8\u5728\u5bf9\u8c61\u5b58\u50a8\uff08\u4f8b\u5982 S3 \u6216 GCS\uff09\u7684\u5757\u4e2d\uff0c\u751a\u81f3\u5b58\u50a8\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e0a\uff0c\u8f7b\u91cf\u7ea7\u7684\u7d22\u5f15\u548c\u9ad8\u5ea6\u538b\u7f29\u7684\u5757\u7b80\u5316\u4e86\u64cd\u4f5c\uff0c\u5e76\u663e\u8457\u964d\u4f4e\u4e86 Loki \u7684\u6210\u672c\uff0cLoki \u66f4\u9002\u5408\u4e2d\u5c0f\u56e2\u961f\u3002\u7531\u4e8e Loki \u4f7f\u7528\u548c Prometheus \u7c7b\u4f3c\u7684\u6807\u7b7e\u6982\u5ff5\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u719f\u6089 Prometheus \u90a3\u4e48\u5c06\u5f88\u5bb9\u6613\u4e0a\u624b\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u548c Grafana \u96c6\u6210\uff0c\u53ea\u9700\u8981\u6dfb\u52a0 Loki \u6570\u636e\u6e90\u5c31\u53ef\u4ee5\u5f00\u59cb\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\u4e86\u3002 Loki \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u65e5\u5fd7\u67e5\u8be2\u7684 LogQL \u67e5\u8be2\u8bed\u53e5\uff0c\u7c7b\u4f3c\u4e8e PromQL \uff0c\u901a\u8fc7 LogQL \u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u67e5\u8be2\u5230\u9700\u8981\u7684\u65e5\u5fd7\uff0c\u4e5f\u53ef\u4ee5\u5f88\u8f7b\u677e\u83b7\u53d6\u76d1\u63a7\u6307\u6807\u3002Loki \u8fd8\u80fd\u591f\u5c06 LogQL \u67e5\u8be2\u76f4\u63a5\u8f6c\u6362\u4e3a Prometheus \u6307\u6807\u3002\u6b64\u5916 Loki \u5141\u8bb8\u6211\u4eec\u5b9a\u4e49\u6709\u5173 LogQL \u6307\u6807\u7684\u62a5\u8b66\uff0c\u5e76\u53ef\u4ee5\u5c06\u5b83\u4eec\u548c Alertmanager \u8fdb\u884c\u5bf9\u63a5\u3002 Grafana Loki \u4e3b\u8981\u7531 3 \u90e8\u5206\u7ec4\u6210: loki : \u65e5\u5fd7\u8bb0\u5f55\u5f15\u64ce\uff0c\u8d1f\u8d23\u5b58\u50a8\u65e5\u5fd7\u548c\u5904\u7406\u67e5\u8be2 promtail : \u4ee3\u7406\uff0c\u8d1f\u8d23\u6536\u96c6\u65e5\u5fd7\u5e76\u5c06\u5176\u53d1\u9001\u7ed9 loki grafana : UI \u754c\u9762","title":"Loki"},{"location":"3.k8s/7.logging/loki/#_1","text":"Loki \u662f\u4e00\u7ec4\u53ef\u4ee5\u7ec4\u6210\u529f\u80fd\u9f50\u5168\u7684\u65e5\u5fd7\u6536\u96c6\u5806\u6808\u7684\u7ec4\u4ef6\uff0c\u4e0e\u5176\u4ed6\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\u4e0d\u540c\uff0cLoki \u7684\u6784\u5efa\u601d\u60f3\u662f\u4ec5\u4e3a\u65e5\u5fd7\u5efa\u7acb\u7d22\u5f15\u6807\u7b7e\uff0c\u800c\u4f7f\u539f\u59cb\u65e5\u5fd7\u6d88\u606f\u4fdd\u6301\u672a\u7d22\u5f15\u72b6\u6001\u3002\u8fd9\u610f\u5473\u7740 Loki \u7684\u8fd0\u8425\u6210\u672c\u66f4\u4f4e\uff0c\u5e76\u4e14\u6548\u7387\u66f4\u9ad8\u3002","title":"\u6982\u8ff0"},{"location":"3.k8s/7.logging/loki/#_2","text":"Loki \u652f\u6301\u591a\u79df\u6237\uff0c\u4ee5\u4f7f\u79df\u6237\u4e4b\u95f4\u7684\u6570\u636e\u5b8c\u5168\u5206\u79bb\u3002\u5f53 Loki \u5728\u591a\u79df\u6237\u6a21\u5f0f\u4e0b\u8fd0\u884c\u65f6\uff0c\u6240\u6709\u6570\u636e\uff08\u5305\u62ec\u5185\u5b58\u548c\u957f\u671f\u5b58\u50a8\u4e2d\u7684\u6570\u636e\uff09\u90fd\u7531\u79df\u6237 ID \u5206\u533a\uff0c\u8be5\u79df\u6237 ID \u662f\u4ece\u8bf7\u6c42\u4e2d\u7684 X-Scope-OrgID HTTP \u5934\u4e2d\u63d0\u53d6\u7684\u3002 \u5f53 Loki \u4e0d\u5728\u591a\u79df\u6237\u6a21\u5f0f\u4e0b\u65f6\uff0c\u5c06\u5ffd\u7565 Header \u5934\uff0c\u5e76\u5c06\u79df\u6237 ID \u8bbe\u7f6e\u4e3a fake \uff0c\u8fd9\u5c06\u663e\u793a\u5728\u7d22\u5f15\u548c\u5b58\u50a8\u7684\u5757\u4e2d\u3002","title":"\u591a\u79df\u6237"},{"location":"3.k8s/7.logging/loki/#_3","text":"Loki \u9488\u5bf9\u672c\u5730\u8fd0\u884c\uff08\u6216\u5c0f\u89c4\u6a21\u8fd0\u884c\uff09\u548c\u6c34\u5e73\u6269\u5c55\u8fdb\u884c\u4e86\u4f18\u5316\uff0cLoki \u5e26\u6709\u5355\u4e00\u8fdb\u7a0b\u6a21\u5f0f\uff0c\u53ef\u5728\u4e00\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u6240\u6709\u5fc5\u9700\u7684\u5fae\u670d\u52a1\u3002\u5355\u8fdb\u7a0b\u6a21\u5f0f\u975e\u5e38\u9002\u5408\u6d4b\u8bd5 Loki \u6216\u4ee5\u5c0f\u89c4\u6a21\u8fd0\u884c\u3002\u4e3a\u4e86\u5b9e\u73b0\u6c34\u5e73\u53ef\u4f38\u7f29\u6027\uff0c\u53ef\u4ee5\u5c06 Loki \u7684\u670d\u52a1\u62c6\u5206\u4e3a\u5355\u72ec\u7684\u7ec4\u4ef6\uff0c\u4ece\u800c\u4f7f\u5b83\u4eec\u5f7c\u6b64\u72ec\u7acb\u5730\u6269\u5c55\u3002\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4ea7\u751f\u4e00\u4e2a\u7528\u4e8e\u5185\u90e8\u8bf7\u6c42\u7684 gRPC \u670d\u52a1\u5668\u548c\u4e00\u4e2a\u7528\u4e8e\u5916\u90e8 API \u8bf7\u6c42\u7684 HTTP \u670d\u52a1\uff0c\u6240\u6709\u7ec4\u4ef6\u90fd\u5e26\u6709 HTTP \u670d\u52a1\u5668\uff0c\u4f46\u662f\u5927\u591a\u6570\u53ea\u66b4\u9732\u5c31\u7eea\u63a5\u53e3\u3001\u8fd0\u884c\u72b6\u51b5\u548c\u6307\u6807\u7aef\u70b9\u3002 Loki \u8fd0\u884c\u54ea\u4e2a\u7ec4\u4ef6\u53d6\u51b3\u4e8e\u547d\u4ee4\u884c\u4e2d\u7684 -target \u6807\u5fd7\u6216 Loki \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 target\uff1a<string> \u914d\u7f6e\u3002 \u5f53 target \u7684\u503c\u4e3a all \u65f6\uff0cLoki \u5c06\u5728\u5355\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u5176\u6240\u6709\u7ec4\u4ef6\u3002\uff0c\u8fd9\u79f0\u4e3a \u5355\u8fdb\u7a0b \u6216 \u5355\u4f53\u6a21\u5f0f \u3002 \u4f7f\u7528 Helm \u5b89\u88c5 Loki \u65f6\uff0c\u5355\u4f53\u6a21\u5f0f\u662f\u9ed8\u8ba4\u90e8\u7f72\u65b9\u5f0f\u3002 \u5f53 target \u672a\u8bbe\u7f6e\u4e3a all\uff08\u5373\u88ab\u8bbe\u7f6e\u4e3a querier \u3001 ingester \u3001 query-frontend \u6216 distributor \uff09\uff0c\u5219\u53ef\u4ee5\u8bf4 Loki \u5728 \u6c34\u5e73\u4f38\u7f29 \u6216 \u5fae\u670d\u52a1\u6a21\u5f0f \u4e0b\u8fd0\u884c\u3002 Loki \u7684\u6bcf\u4e2a\u7ec4\u4ef6\uff0c\u4f8b\u5982 ingester \u548c distributors \u90fd\u4f7f\u7528 Loki \u914d\u7f6e\u4e2d\u5b9a\u4e49\u7684 gRPC \u76d1\u542c\u7aef\u53e3\u901a\u8fc7 gRPC \u76f8\u4e92\u901a\u4fe1\u3002\u5f53\u4ee5\u5355\u4f53\u6a21\u5f0f\u8fd0\u884c\u7ec4\u4ef6\u65f6\uff0c\u4ecd\u7136\u662f\u8fd9\u6837\u7684\uff0c\u5c3d\u7ba1\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4ee5\u76f8\u540c\u7684\u8fdb\u7a0b\u8fd0\u884c\uff0c\u4f46\u5b83\u4eec\u4ecd\u5c06\u901a\u8fc7\u672c\u5730\u7f51\u7edc\u76f8\u4e92\u8fde\u63a5\u8fdb\u884c\u7ec4\u4ef6\u4e4b\u95f4\u7684\u901a\u4fe1\u3002 \u5355\u4f53\u6a21\u5f0f\u975e\u5e38\u9002\u5408\u4e8e\u672c\u5730\u5f00\u53d1\u3001\u5c0f\u89c4\u6a21\u7b49\u573a\u666f\uff0c\u5355\u4f53\u6a21\u5f0f\u53ef\u4ee5\u901a\u8fc7\u591a\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u6269\u5c55\uff0c\u4f46\u6709\u4ee5\u4e0b\u9650\u5236\uff1a \u5f53\u8fd0\u884c\u5e26\u6709\u591a\u4e2a\u526f\u672c\u7684\u5355\u4f53\u6a21\u5f0f\u65f6\uff0c\u5f53\u524d\u65e0\u6cd5\u4f7f\u7528\u672c\u5730\u7d22\u5f15\u548c\u672c\u5730\u5b58\u50a8\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u526f\u672c\u5fc5\u987b\u80fd\u591f\u8bbf\u95ee\u76f8\u540c\u7684\u5b58\u50a8\u540e\u7aef\uff0c\u5e76\u4e14\u672c\u5730\u5b58\u50a8\u5bf9\u4e8e\u5e76\u53d1\u8bbf\u95ee\u5e76\u4e0d\u5b89\u5168\u3002 \u5404\u4e2a\u7ec4\u4ef6\u65e0\u6cd5\u72ec\u7acb\u7f29\u653e\uff0c\u56e0\u6b64\u8bfb\u53d6\u7ec4\u4ef6\u7684\u6570\u91cf\u4e0d\u80fd\u8d85\u8fc7\u5199\u5165\u7ec4\u4ef6\u7684\u6570\u91cf\u3002","title":"\u8fd0\u884c\u6a21\u5f0f"},{"location":"3.k8s/7.logging/loki/#_4","text":"","title":"\u7ec4\u4ef6"},{"location":"3.k8s/7.logging/loki/#distributor","text":"distributor \u670d\u52a1\u8d1f\u8d23\u5904\u7406\u5ba2\u6237\u7aef\u5199\u5165\u7684\u65e5\u5fd7\uff0c\u5b83\u672c\u8d28\u4e0a\u662f\u65e5\u5fd7\u6570\u636e\u5199\u5165\u8def\u5f84\u4e2d\u7684 \u7b2c\u4e00\u7ad9 \uff0c\u4e00\u65e6 distributor \u6536\u5230\u65e5\u5fd7\u6570\u636e\uff0c\u4f1a\u5c06\u5176\u62c6\u5206\u4e3a\u591a\u4e2a\u6279\u6b21\uff0c\u7136\u540e\u5e76\u884c\u53d1\u9001\u7ed9\u591a\u4e2a ingester \u3002 distributor \u901a\u8fc7 gRPC \u4e0e ingester \u901a\u4fe1\uff0c\u5b83\u4eec\u90fd\u662f\u65e0\u72b6\u6001\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u6839\u636e\u9700\u8981\u6269\u5927\u6216\u7f29\u5c0f\u89c4\u6a21\u3002 Hashing distributor \u5c06 \u4e00\u81f4\u6027 Hash \u548c\u53ef\u914d\u7f6e\u7684\u590d\u5236\u56e0\u5b50\u7ed3\u5408\u4f7f\u7528\uff0c\u4ee5\u786e\u5b9a ingester \u670d\u52a1\u7684\u54ea\u4e9b\u5b9e\u4f8b\u5e94\u8be5\u63a5\u6536\u6307\u5b9a\u7684\u6570\u636e\u6d41\u3002 \u6d41\u662f\u4e00\u7ec4\u4e0e \u79df\u6237\u548c\u552f\u4e00\u6807\u7b7e\u96c6 \u5173\u8054\u7684\u65e5\u5fd7\uff0c\u4f7f\u7528\u79df\u6237 ID \u548c\u6807\u7b7e\u96c6\u5bf9\u6d41\u8fdb\u884c hash \u5904\u7406\uff0c\u7136\u540e\u4f7f\u7528\u54c8\u5e0c\u67e5\u8be2\u8981\u53d1\u9001\u6d41\u7684 ingester \u3002 \u5b58\u50a8\u5728 Consul/Etcd \u4e2d\u7684\u54c8\u5e0c\u73af\u88ab\u7528\u6765\u5b9e\u73b0\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u6240\u6709\u7684 ingester \u90fd\u4f1a\u4f7f\u7528\u81ea\u5df1\u62e5\u6709\u7684\u4e00\u7ec4 Token \u6ce8\u518c\u5230\u54c8\u5e0c\u73af\u4e2d\uff0c\u6bcf\u4e2a Token \u662f\u4e00\u4e2a\u968f\u673a\u7684\u65e0\u7b26\u53f7 32 \u4f4d\u6570\u5b57\uff0c\u4e0e\u4e00\u7ec4 Token \u4e00\u8d77\uff0c ingester \u5c06\u5176\u72b6\u6001\u6ce8\u518c\u5230\u54c8\u5e0c\u73af\u4e2d\uff0c\u72b6\u6001 JOINING \u548c ACTIVE \u90fd\u53ef\u4ee5\u63a5\u6536\u5199\u8bf7\u6c42\uff0c\u800c ACTIVE \u548c LEAVING \u7684 ingester \u53ef\u4ee5\u63a5\u6536\u8bfb\u8bf7\u6c42\u3002\u5728\u8fdb\u884c\u54c8\u5e0c\u67e5\u8be2\u65f6\uff0c distributor \u53ea\u4f7f\u7528\u5904\u4e8e\u8bf7\u6c42\u7684\u9002\u5f53\u72b6\u6001\u7684 ingester \u7684 Token\u3002 \u4e3a\u4e86\u8fdb\u884c\u54c8\u5e0c\u67e5\u627e\uff0c distributor \u627e\u5230\u6700\u5c0f\u5408\u9002\u7684 Token\uff0c\u5176\u503c\u5927\u4e8e\u65e5\u5fd7\u6d41\u7684\u54c8\u5e0c\u503c\uff0c\u5f53\u590d\u5236\u56e0\u5b50\u5927\u4e8e 1 \u65f6\uff0c\u5c5e\u4e8e\u4e0d\u540c ingester \u7684\u4e0b\u4e00\u4e2a\u540e\u7eed Token\uff08\u5728\u73af\u4e2d\u987a\u65f6\u9488\u65b9\u5411\uff09\u4e5f\u5c06\u88ab\u5305\u62ec\u5728\u7ed3\u679c\u4e2d\u3002 \u8fd9\u79cd\u54c8\u5e0c\u914d\u7f6e\u7684\u6548\u679c\u662f\uff0c\u4e00\u4e2a ingester \u62e5\u6709\u7684\u6bcf\u4e2a Token \u90fd\u8d1f\u8d23\u4e00\u4e2a\u8303\u56f4\u7684\u54c8\u5e0c\u503c\uff0c\u5982\u679c\u6709\u4e09\u4e2a\u503c\u4e3a 0\u300125 \u548c 50 \u7684 Token\uff0c\u90a3\u4e48 3 \u7684\u54c8\u5e0c\u503c\u5c06\u88ab\u7ed9\u4e88\u62e5\u6709 25 \u8fd9\u4e2a Token \u7684 ingester \uff0c\u62e5\u6709 25 \u8fd9\u4e2a Token \u7684 ingester \u8d1f\u8d23 1-25 \u7684\u54c8\u5e0c\u503c\u8303\u56f4\u3002","title":"Distributor"},{"location":"3.k8s/7.logging/loki/#ingester","text":"ingester \u8d1f\u8d23\u63a5\u6536 distributor \u53d1\u9001\u8fc7\u6765\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u5b58\u50a8\u65e5\u5fd7\u7684\u7d22\u5f15\u6570\u636e\u4ee5\u53ca\u5185\u5bb9\u6570\u636e\u3002\u6b64\u5916 ingester \u4f1a\u9a8c\u8bc1\u6444\u53d6\u7684\u65e5\u5fd7\u884c\u662f\u5426\u6309\u7167\u65f6\u95f4\u6233\u9012\u589e\u7684\u987a\u5e8f\u63a5\u6536\u7684\uff08\u5373\u6bcf\u6761\u65e5\u5fd7\u7684\u65f6\u95f4\u6233\u90fd\u6bd4\u524d\u9762\u7684\u65e5\u5fd7\u665a\u4e00\u4e9b\uff09\uff0c\u5f53 ingester \u6536\u5230\u4e0d\u7b26\u5408\u8fd9\u4e2a\u987a\u5e8f\u7684\u65e5\u5fd7\u65f6\uff0c\u8be5\u65e5\u5fd7\u884c\u4f1a\u88ab\u62d2\u7edd\u5e76\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\u3002 \u5982\u679c\u4f20\u5165\u7684\u884c\u4e0e\u4e4b\u524d\u6536\u5230\u7684\u884c\u5b8c\u5168\u5339\u914d\uff08\u4e0e\u4e4b\u524d\u7684\u65f6\u95f4\u6233\u548c\u65e5\u5fd7\u6587\u672c\u90fd\u5339\u914d\uff09\uff0c\u4f20\u5165\u7684\u884c\u5c06\u88ab\u89c6\u4e3a\u5b8c\u5168\u91cd\u590d\u5e76\u88ab\u5ffd\u7565\u3002 \u5982\u679c\u4f20\u5165\u7684\u884c\u4e0e\u524d\u4e00\u884c\u7684\u65f6\u95f4\u6233\u76f8\u540c\uff0c\u4f46\u5185\u5bb9\u4e0d\u540c\uff0c\u5219\u63a5\u53d7\u8be5\u65e5\u5fd7\u884c\uff0c\u8868\u793a\u540c\u4e00\u65f6\u95f4\u6233\u6709\u4e24\u4e2a\u4e0d\u540c\u7684\u65e5\u5fd7\u884c\u662f\u53ef\u80fd\u7684\u3002 \u6765\u81ea\u6bcf\u4e2a\u552f\u4e00\u6807\u7b7e\u96c6\u7684\u65e5\u5fd7\u5728\u5185\u5b58\u4e2d\u88ab\u5efa\u7acb\u6210 chunks(\u5757) \uff0c\u7136\u540e\u53ef\u4ee5\u6839\u636e\u914d\u7f6e\u7684\u65f6\u95f4\u95f4\u9694\u5237\u65b0\u5230\u652f\u6301\u7684\u540e\u7aef\u5b58\u50a8\u3002\u5728\u4e0b\u5217\u60c5\u51b5\u4e0b\uff0c\u5757\u88ab\u538b\u7f29\u5e76\u6807\u8bb0\u4e3a\u53ea\u8bfb\uff1a \u5f53\u524d\u5757\u5bb9\u91cf\u5df2\u6ee1\uff08\u8be5\u503c\u53ef\u914d\u7f6e\uff09 \u8fc7\u4e86\u592a\u957f\u65f6\u95f4\u6ca1\u6709\u66f4\u65b0\u5f53\u524d\u5757\u7684\u5185\u5bb9 \u5237\u65b0\u4e86 \u6bcf\u5f53\u4e00\u4e2a\u6570\u636e\u5757\u88ab\u538b\u7f29\u5e76\u6807\u8bb0\u4e3a\u53ea\u8bfb\u65f6\uff0c\u4e00\u4e2a\u53ef\u5199\u7684\u6570\u636e\u5757\u5c31\u4f1a\u53d6\u4ee3\u5b83\u3002\u5982\u679c\u4e00\u4e2a ingester \u8fdb\u7a0b\u5d29\u6e83\u6216\u7a81\u7136\u9000\u51fa\uff0c\u6240\u6709\u5c1a\u672a\u5237\u65b0\u7684\u6570\u636e\u90fd\u4f1a\u4e22\u5931\uff0cLoki \u901a\u5e38\u914d\u7f6e\u4e3a\u591a\u4e2a\u526f\u672c\u6765 \u964d\u4f4e \u8fd9\u79cd\u98ce\u9669\u3002 \u5f53\u5411\u6301\u4e45\u5b58\u50a8\u5237\u65b0\u65f6\uff0c\u8be5\u5757\u5c06\u6839\u636e\u5176\u79df\u6237\u3001\u6807\u7b7e\u548c\u5185\u5bb9\u8fdb\u884c\u54c8\u5e0c\u5904\u7406\uff0c\u8fd9\u610f\u5473\u7740\u5177\u6709\u76f8\u540c\u6570\u636e\u526f\u672c\u7684\u591a\u4e2a ingester \u5b9e\u4f8b\u4e0d\u4f1a\u5c06\u76f8\u540c\u7684\u6570\u636e\u4e24\u6b21\u5199\u5165\u5907\u4efd\u5b58\u50a8\u4e2d\uff0c\u4f46\u5982\u679c\u5bf9\u5176\u4e2d\u4e00\u4e2a\u526f\u672c\u7684\u5199\u5165\u5931\u8d25\uff0c\u5219\u4f1a\u5728\u5907\u4efd\u5b58\u50a8\u4e2d\u521b\u5efa\u591a\u4e2a\u4e0d\u540c\u7684\u5757\u5bf9\u8c61\u3002 WAL \u4e0a\u9762\u6211\u4eec\u63d0\u5230\u4e86 ingester \u5c06\u6570\u636e\u4e34\u65f6\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u5982\u679c\u53d1\u751f\u4e86\u5d29\u6e83\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6570\u636e\u4e22\u5931\uff0c\u800c WAL \u5c31\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u6765\u63d0\u9ad8\u8fd9\u65b9\u9762\u7684\u53ef\u9760\u6027\u3002 \u5728\u8ba1\u7b97\u673a\u9886\u57df\uff0cWAL\uff08Write-ahead logging\uff0c\u9884\u5199\u5f0f\u65e5\u5fd7\uff09\u662f\u6570\u636e\u5e93\u7cfb\u7edf\u63d0\u4f9b\u539f\u5b50\u6027\u548c\u6301\u4e45\u5316\u7684\u4e00\u7cfb\u5217\u6280\u672f\u3002 \u5728\u4f7f\u7528 WAL \u7684\u7cfb\u7edf\u4e2d\uff0c\u6240\u6709\u7684\u4fee\u6539\u90fd\u5148\u88ab\u5199\u5165\u5230\u65e5\u5fd7\u4e2d\uff0c\u7136\u540e\u518d\u88ab\u5e94\u7528\u5230\u7cfb\u7edf\u72b6\u6001\u4e2d\u3002\u901a\u5e38\u5305\u542b redo \u548c undo \u4e24\u90e8\u5206\u4fe1\u606f\u3002\u4e3a\u4ec0\u4e48\u9700\u8981\u4f7f\u7528 WAL\uff0c\u7136\u540e\u5305\u542b redo \u548c undo \u4fe1\u606f\u5462\uff1f\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5982\u679c\u4e00\u4e2a\u7cfb\u7edf\u76f4\u63a5\u5c06\u53d8\u66f4\u5e94\u7528\u5230\u7cfb\u7edf\u72b6\u6001\u4e2d\uff0c\u90a3\u4e48\u5728\u673a\u5668\u65ad\u7535\u91cd\u542f\u4e4b\u540e\u7cfb\u7edf\u9700\u8981\u77e5\u9053\u64cd\u4f5c\u662f\u6210\u529f\u4e86\uff0c\u8fd8\u662f\u53ea\u6709\u90e8\u5206\u6210\u529f\u6216\u8005\u662f\u5931\u8d25\u4e86\uff08\u4e3a\u4e86\u6062\u590d\u72b6\u6001\uff09\u3002\u5982\u679c\u4f7f\u7528\u4e86 WAL\uff0c\u90a3\u4e48\u5728\u91cd\u542f\u4e4b\u540e\u7cfb\u7edf\u53ef\u4ee5\u901a\u8fc7\u6bd4\u8f83\u65e5\u5fd7\u548c\u7cfb\u7edf\u72b6\u6001\u6765\u51b3\u5b9a\u662f\u7ee7\u7eed\u5b8c\u6210\u64cd\u4f5c\u8fd8\u662f\u64a4\u9500\u64cd\u4f5c\u3002 redo log \u79f0\u4e3a\u91cd\u505a\u65e5\u5fd7\uff0c\u6bcf\u5f53\u6709\u64cd\u4f5c\u65f6\uff0c\u5728\u6570\u636e\u53d8\u66f4\u4e4b\u524d\u5c06\u64cd\u4f5c\u5199\u5165 redo log \uff0c\u8fd9\u6837\u5f53\u53d1\u751f\u65ad\u7535\u4e4b\u7c7b\u7684\u60c5\u51b5\u65f6\u7cfb\u7edf\u53ef\u4ee5\u5728\u91cd\u542f\u540e\u7ee7\u7eed\u64cd\u4f5c\u3002 undo log \u79f0\u4e3a\u64a4\u9500\u65e5\u5fd7\uff0c\u5f53\u4e00\u4e9b\u53d8\u66f4\u6267\u884c\u5230\u4e00\u534a\u65e0\u6cd5\u5b8c\u6210\u65f6\uff0c\u53ef\u4ee5\u6839\u636e\u64a4\u9500\u65e5\u5fd7\u6062\u590d\u5230\u53d8\u66f4\u4e4b\u95f4\u7684\u72b6\u6001\u3002 Loki \u4e2d\u7684 WAL \u8bb0\u5f55\u4e86\u4f20\u5165\u7684\u6570\u636e\uff0c\u5e76\u5c06\u5176\u5b58\u50a8\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u4ee5\u4fdd\u8bc1\u5728\u8fdb\u7a0b\u5d29\u6e83\u7684\u60c5\u51b5\u4e0b\u6301\u4e45\u4fdd\u5b58\u5df2\u786e\u8ba4\u7684\u6570\u636e\u3002\u91cd\u65b0\u542f\u52a8\u540e\uff0cLoki \u5c06 \u91cd\u653e \u65e5\u5fd7\u4e2d\u7684\u6240\u6709\u6570\u636e\uff0c\u7136\u540e\u5c06\u81ea\u8eab\u6ce8\u518c\uff0c\u51c6\u5907\u8fdb\u884c\u540e\u7eed\u5199\u64cd\u4f5c\u3002\u8fd9\u4f7f\u5f97 Loki \u80fd\u591f\u4fdd\u6301\u5728\u5185\u5b58\u4e2d\u7f13\u51b2\u6570\u636e\u7684\u6027\u80fd\u548c\u6210\u672c\u4f18\u52bf\uff0c\u4ee5\u53ca\u6301\u4e45\u6027\u4f18\u52bf\uff08\u4e00\u65e6\u5199\u88ab\u786e\u8ba4\uff0c\u5b83\u5c31\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\uff09\u3002","title":"Ingester"},{"location":"3.k8s/7.logging/loki/#querier","text":"Querier \u63a5\u6536\u65e5\u5fd7\u6570\u636e\u67e5\u8be2\u3001\u805a\u5408\u7edf\u8ba1\u8bf7\u6c42\uff0c\u4f7f\u7528 LogQL \u67e5\u8be2\u8bed\u8a00\u5904\u7406\u67e5\u8be2\uff0c\u4ece ingester \u548c\u957f\u671f\u5b58\u50a8\u4e2d\u83b7\u53d6\u65e5\u5fd7\u3002 \u67e5\u8be2\u5668\u67e5\u8be2\u6240\u6709 ingester \u7684\u5185\u5b58\u6570\u636e\uff0c\u7136\u540e\u518d\u5230\u540e\u7aef\u5b58\u50a8\u8fd0\u884c\u76f8\u540c\u7684\u67e5\u8be2\u3002\u7531\u4e8e\u590d\u5236\u56e0\u5b50\uff0c\u67e5\u8be2\u5668\u6709\u53ef\u80fd\u4f1a\u6536\u5230\u91cd\u590d\u7684\u6570\u636e\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u67e5\u8be2\u5668\u5728\u5185\u90e8\u5bf9\u5177\u6709\u76f8\u540c\u7eb3\u79d2\u65f6\u95f4\u6233\u3001\u6807\u7b7e\u96c6\u548c\u65e5\u5fd7\u4fe1\u606f\u7684\u6570\u636e\u8fdb\u884c\u91cd\u590d\u6570\u636e\u5220\u9664\u3002","title":"Querier"},{"location":"3.k8s/7.logging/loki/#query-frontend","text":"Query Frontend \u67e5\u8be2\u524d\u7aef\u662f\u4e00\u4e2a\u53ef\u9009\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u7528\u6765\u52a0\u901f\u8bfb\u53d6\u8def\u5f84\u3002\u5f53\u67e5\u8be2\u524d\u7aef\u5c31\u4f4d\u65f6\uff0c\u5c06\u4f20\u5165\u7684\u67e5\u8be2\u8bf7\u6c42\u5b9a\u5411\u5230\u67e5\u8be2\u524d\u7aef\uff0c\u800c\u4e0d\u662f querier , \u4e3a\u4e86\u6267\u884c\u5b9e\u9645\u7684\u67e5\u8be2\uff0c\u7fa4\u96c6\u4e2d\u4ecd\u9700\u8981 querier \u670d\u52a1\u3002 \u67e5\u8be2\u524d\u7aef\u5728\u5185\u90e8\u6267\u884c\u4e00\u4e9b\u67e5\u8be2\u8c03\u6574\uff0c\u5e76\u5728\u5185\u90e8\u961f\u5217\u4e2d\u4fdd\u5b58\u67e5\u8be2\u3002 querier \u4f5c\u4e3a workers \u4ece\u961f\u5217\u4e2d\u63d0\u53d6\u4f5c\u4e1a\uff0c\u6267\u884c\u5b83\u4eec\uff0c\u5e76\u5c06\u5b83\u4eec\u8fd4\u56de\u5230\u67e5\u8be2\u524d\u7aef\u8fdb\u884c\u6c47\u603b\u3002 querier \u9700\u8981\u914d\u7f6e\u67e5\u8be2\u524d\u7aef\u5730\u5740\uff0c\u4ee5\u4fbf\u5141\u8bb8\u5b83\u4eec\u8fde\u63a5\u5230\u67e5\u8be2\u524d\u7aef\u3002 \u67e5\u8be2\u524d\u7aef\u662f\u65e0\u72b6\u6001\u7684\uff0c\u7136\u800c\uff0c\u7531\u4e8e\u5185\u90e8\u961f\u5217\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u5efa\u8bae\u8fd0\u884c\u51e0\u4e2a\u67e5\u8be2\u524d\u53f0\u7684\u526f\u672c\uff0c\u4ee5\u83b7\u5f97\u516c\u5e73\u8c03\u5ea6\u7684\u597d\u5904\uff0c\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4e24\u4e2a\u526f\u672c\u5e94\u8be5\u8db3\u591f\u4e86\u3002 \u961f\u5217 \u67e5\u8be2\u524d\u7aef\u7684\u6392\u961f\u673a\u5236\u7528\u4e8e\uff1a \u786e\u4fdd\u53ef\u80fd\u5bfc\u81f4 querier \u51fa\u73b0\u5185\u5b58\u4e0d\u8db3\uff08OOM\uff09\u9519\u8bef\u7684\u67e5\u8be2\u5728\u5931\u8d25\u65f6\u88ab\u91cd\u8bd5\u3002\u8fd9\u6837\u7ba1\u7406\u5458\u5c31\u53ef\u4ee5\u4e3a\u67e5\u8be2\u63d0\u4f9b\u7a0d\u4f4e\u7684\u5185\u5b58\uff0c\u6216\u8005\u5e76\u884c\u8fd0\u884c\u66f4\u591a\u7684\u5c0f\u578b\u67e5\u8be2\uff0c\u8fd9\u6709\u52a9\u4e8e\u964d\u4f4e\u603b\u6210\u672c\u3002 \u901a\u8fc7\u4f7f\u7528\u5148\u8fdb\u5148\u51fa\u961f\u5217\uff08FIFO\uff09\u5c06\u591a\u4e2a\u5927\u578b\u8bf7\u6c42\u5206\u914d\u5230\u6240\u6709 querier \u4e0a\uff0c\u4ee5\u9632\u6b62\u5728\u5355\u4e2a querier \u4e2d\u8fdb\u884c\u591a\u4e2a\u5927\u578b\u8bf7\u6c42\u3002 \u901a\u8fc7\u5728\u79df\u6237\u4e4b\u95f4\u516c\u5e73\u8c03\u5ea6\u67e5\u8be2\u3002 \u5206\u5272 \u67e5\u8be2\u524d\u7aef\u5c06\u8f83\u5927\u7684\u67e5\u8be2\u5206\u5272\u6210\u591a\u4e2a\u8f83\u5c0f\u7684\u67e5\u8be2\uff0c\u5728\u4e0b\u6e38 querier \u4e0a\u5e76\u884c\u6267\u884c\u8fd9\u4e9b\u67e5\u8be2\uff0c\u5e76\u5c06\u7ed3\u679c\u518d\u6b21\u62fc\u63a5\u8d77\u6765\u3002\u8fd9\u53ef\u4ee5\u9632\u6b62\u5927\u578b\u67e5\u8be2\u5728\u5355\u4e2a\u67e5\u8be2\u5668\u4e2d\u9020\u6210\u5185\u5b58\u4e0d\u8db3\u7684\u95ee\u9898\uff0c\u5e76\u6709\u52a9\u4e8e\u66f4\u5feb\u5730\u6267\u884c\u8fd9\u4e9b\u67e5\u8be2\u3002 \u7f13\u5b58 \u67e5\u8be2\u524d\u7aef\u652f\u6301\u7f13\u5b58\u67e5\u8be2\u7ed3\u679c\uff0c\u5e76\u5728\u540e\u7eed\u67e5\u8be2\u4e2d\u91cd\u590d\u4f7f\u7528\u3002\u5982\u679c\u7f13\u5b58\u7684\u7ed3\u679c\u4e0d\u5b8c\u6574\uff0c\u67e5\u8be2\u524d\u7aef\u4f1a\u8ba1\u7b97\u6240\u9700\u7684\u5b50\u67e5\u8be2\uff0c\u5e76\u5728\u4e0b\u6e38 querier \u4e0a\u5e76\u884c\u6267\u884c\u8fd9\u4e9b\u5b50\u67e5\u8be2\u3002\u67e5\u8be2\u524d\u7aef\u53ef\u4ee5\u9009\u62e9\u5c06\u67e5\u8be2\u4e0e\u5176 step \u53c2\u6570\u5bf9\u9f50\uff0c\u4ee5\u63d0\u9ad8\u67e5\u8be2\u7ed3\u679c\u7684\u53ef\u7f13\u5b58\u6027\u3002","title":"Query Frontend"},{"location":"3.k8s/7.logging/loki/#_5","text":"\u65e5\u5fd7\u8bfb\u53d6\u8def\u5f84\u7684\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a \u67e5\u8be2\u5668\u6536\u5230\u4e00\u4e2a\u5bf9\u6570\u636e\u7684 HTTP \u8bf7\u6c42\u3002 \u67e5\u8be2\u5668\u5c06\u67e5\u8be2\u4f20\u9012\u7ed9\u6240\u6709 ingester \u3002 ingester \u6536\u5230\u8bfb\u53d6\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u4e0e\u67e5\u8be2\u76f8\u5339\u914d\u7684\u6570\u636e\u3002 \u5982\u679c\u6ca1\u6709 ingester \u8fd4\u56de\u6570\u636e\uff0c\u67e5\u8be2\u5668\u4f1a\u4ece\u540e\u7aef\u5b58\u50a8\u52a0\u8f7d\u6570\u636e\uff0c\u5e76\u5bf9\u5176\u8fd0\u884c\u67e5\u8be2\u3002 \u67e5\u8be2\u5668\u5bf9\u6240\u6709\u6536\u5230\u7684\u6570\u636e\u8fdb\u884c\u8fed\u4ee3\u548c\u91cd\u590d\u8ba1\u7b97\uff0c\u901a\u8fc7 HTTP \u8fde\u63a5\u8fd4\u56de\u6700\u540e\u4e00\u7ec4\u6570\u636e\u3002","title":"\u8bfb\u53d6\u8def\u5f84"},{"location":"3.k8s/7.logging/loki/#_6","text":"\u6574\u4f53\u7684\u65e5\u5fd7\u5199\u5165\u8def\u5f84\u5982\u4e0b\u6240\u793a\uff1a distributor \u6536\u5230\u4e00\u4e2a HTTP \u8bf7\u6c42\uff0c\u4ee5\u5b58\u50a8\u6d41\u7684\u6570\u636e\u3002 \u6bcf\u4e2a\u6d41\u90fd\u4f7f\u7528\u54c8\u5e0c\u73af\u8fdb\u884c\u54c8\u5e0c\u64cd\u4f5c\u3002 distributor \u5c06\u6bcf\u4e2a\u6d41\u53d1\u9001\u5230\u5408\u9002\u7684 ingester \u548c\u4ed6\u4eec\u7684\u526f\u672c\uff08\u57fa\u4e8e\u914d\u7f6e\u7684\u590d\u5236\u56e0\u5b50\uff09\u3002 \u6bcf\u4e2a ingester \u5c06\u4e3a\u65e5\u5fd7\u6d41\u6570\u636e\u521b\u5efa\u4e00\u4e2a\u5757\u6216\u9644\u52a0\u5230\u4e00\u4e2a\u73b0\u6709\u7684\u5757\u4e0a\u3002\u6bcf\u4e2a\u79df\u6237\u548c\u6bcf\u4e2a\u6807\u7b7e\u96c6\u7684\u5757\u662f\u552f\u4e00\u7684\u3002","title":"\u5199\u5165\u8def\u5f84"},{"location":"3.k8s/7.logging/loki/#_7","text":"\u9996\u5148\u6dfb\u52a0 Loki \u7684 Chart \u4ed3\u5e93\uff1a $ helm repo add grafana https://grafana.github.io/helm-charts $ helm repo update \u83b7\u53d6 loki-stack \u7684 Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull grafana/loki-stack --untar --version 2.6.4 loki-stack \u8fd9\u4e2a Chart \u5305\u91cc\u9762\u5305\u542b\u6240\u6709\u7684 Loki \u76f8\u5173\u5de5\u5177\u4f9d\u8d56\uff0c\u5728\u5b89\u88c5\u7684\u65f6\u5019\u53ef\u4ee5\u6839\u636e\u9700\u8981\u5f00\u542f\u6216\u5173\u95ed\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u5b89\u88c5 Grafana\uff0c\u5219\u53ef\u4ee5\u5728\u5b89\u88c5\u7684\u65f6\u5019\u7b80\u5355\u8bbe\u7f6e --set grafana.enabled=true \u5373\u53ef\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b loki \u3001 promtail \u662f\u81ea\u52a8\u5f00\u542f\u7684\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u9700\u8981\u9009\u62e9\u4f7f\u7528 filebeat \u6216\u8005 logstash \uff0c\u540c\u6837\u5728 Chart \u5305\u6839\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 Values \u6587\u4ef6\uff1a # values-prod.yaml loki: enabled: true replicas: 1 rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path promtail: enabled: true rbac: pspEnabled: false grafana: enabled: true service: type: NodePort rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path accessModes: - ReadWriteOnce size: 1Gi \u7136\u540e\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 Values \u6587\u4ef6\u8fdb\u884c\u5b89\u88c5\u5373\u53ef\uff1a $ helm upgrade --install loki -n logging -f values-prod.yaml . Release \"loki\" does not exist. Installing it now. NAME: loki LAST DEPLOYED: Tue Jun 14 14:45:50 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 NOTES: The Loki stack has been deployed to your cluster. Loki can now be added as a datasource in Grafana. See http://docs.grafana.org/features/datasources/loki/ for more detail. \u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b Pod \u7684\u72b6\u6001\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE loki-0 1/1 Running 0 5m19s loki-grafana-5f9df99f6d-8rwbz 2/2 Running 0 5m19s loki-promtail-ptxxl 1/1 Running 0 5m19s loki-promtail-xc55z 1/1 Running 0 5m19s loki-promtail-zg9tv 1/1 Running 0 5m19s \u8fd9\u91cc\u6211\u4eec\u4e3a Grafana \u8bbe\u7f6e\u7684 NodePort \u7c7b\u578b\u7684 Service\uff1a $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE loki ClusterIP 10.104.186.9 <none> 3100/TCP 5m34s loki-grafana NodePort 10.110.58.196 <none> 80:31634/TCP 5m34s loki-headless ClusterIP None <none> 3100/TCP 5m34s \u53ef\u4ee5\u901a\u8fc7 NodePort \u7aef\u53e3 31634 \u8bbf\u95ee Grafana\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u83b7\u53d6 Grafana \u7684\u767b\u5f55\u5bc6\u7801\uff1a $ kubectl get secret --namespace logging loki-grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo \u4f7f\u7528\u7528\u6237\u540d admin \u548c\u4e0a\u9762\u7684\u83b7\u53d6\u7684\u5bc6\u7801\u5373\u53ef\u767b\u5f55 Grafana\uff0c\u7531\u4e8e Helm Chart \u5df2\u7ecf\u4e3a Grafana \u914d\u7f6e\u597d\u4e86 Loki \u7684\u6570\u636e\u6e90\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\u5230\u65e5\u5fd7\u6570\u636e\u4e86\u3002\u70b9\u51fb\u5de6\u4fa7 Explore \u83dc\u5355\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u7b5b\u9009 Loki \u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a \u6211\u4eec\u4f7f\u7528 Helm \u5b89\u88c5\u7684 Promtail \u9ed8\u8ba4\u5df2\u7ecf\u5e2e\u6211\u4eec\u505a\u597d\u4e86\u914d\u7f6e\uff0c\u5df2\u7ecf\u9488\u5bf9 Kubernetes \u505a\u4e86\u4f18\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5176\u914d\u7f6e\uff1a $ kubectl get secret loki-promtail -n logging -o json | jq -r '.data.\"promtail.yaml\"' | base64 --decode server: log_level: info http_listen_port: 3101 client: url: http://loki:3100/loki/api/v1/push positions: filename: /run/promtail/positions.yaml scrape_configs: # See also https://github.com/grafana/loki/blob/master/production/ksonnet/promtail/scrape_config.libsonnet for reference - job_name: kubernetes-pods pipeline_stages: - cri: {} kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_controller_name regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})? action: replace target_label: __tmp_controller_name - source_labels: - __meta_kubernetes_pod_label_app_kubernetes_io_name - __meta_kubernetes_pod_label_app - __tmp_controller_name - __meta_kubernetes_pod_name regex: ^;*([^;]+)(;.*)?$ action: replace target_label: app - source_labels: - __meta_kubernetes_pod_label_app_kubernetes_io_component - __meta_kubernetes_pod_label_component regex: ^;*([^;]+)(;.*)?$ action: replace target_label: component - action: replace source_labels: - __meta_kubernetes_pod_node_name target_label: node_name - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace - action: replace replacement: $1 separator: / source_labels: - namespace - app target_label: job - action: replace source_labels: - __meta_kubernetes_pod_name target_label: pod - action: replace source_labels: - __meta_kubernetes_pod_container_name target_label: container - action: replace replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_uid - __meta_kubernetes_pod_container_name target_label: __path__ - action: replace regex: true/(.*) replacement: /var/log/pods/*$1/*.log separator: / source_labels: - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash - __meta_kubernetes_pod_container_name target_label: __path__","title":"\u5b89\u88c5"},{"location":"3.k8s/7.logging/loki/#traefik","text":"\u8fd9\u91cc\u6211\u4eec\u4ee5\u6536\u96c6 Traefik \u4e3a\u4f8b\uff0c\u4e3a Traefik \u5b9a\u5236\u4e00\u4e2a\u53ef\u89c6\u5316\u7684 Dashboard\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8bbf\u95ee\u65e5\u5fd7\u6ca1\u6709\u8f93\u51fa\u5230 stdout\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u8bbe\u7f6e --accesslog=true \u6765\u5f00\u542f\uff0c\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u8bbf\u95ee\u65e5\u5fd7\u683c\u5f0f\u4e3a json\uff0c\u8fd9\u6837\u66f4\u65b9\u4fbf\u5728 Loki \u4e2d\u67e5\u8be2\u4f7f\u7528\uff1a containers: - args: - --accesslog=true - --accesslog.format=json ...... \u9ed8\u8ba4 traefik \u7684\u65e5\u5fd7\u8f93\u51fa\u4e3a stdout\uff0c\u5982\u679c\u4f60\u7684\u91c7\u96c6\u7aef\u662f\u901a\u8fc7\u8bfb\u53d6\u6587\u4ef6\u7684\u8bdd\uff0c\u5219\u9700\u8981\u7528 filePath \u53c2\u6570\u5c06 traefik \u7684\u65e5\u5fd7\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u76ee\u5f55\u3002 \u4fee\u6539\u5b8c\u6210\u540e\u6b63\u5e38\u5728 Grafana \u4e2d\u5c31\u53ef\u4ee5\u770b\u5230 Traefik \u7684\u8bbf\u95ee\u65e5\u5fd7\u4e86\uff1a \u7136\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u5bfc\u5165 Dashboard \u6765\u5c55\u793a Traefik \u7684\u4fe1\u606f\uff1a https://grafana.com/grafana/dashboards/13713 \uff0c\u5728 Grafana \u4e2d\u5bfc\u5165 13713 \u53f7 Dashboard\uff1a \u4e0d\u8fc7\u8981\u6ce8\u610f\u6211\u4eec\u9700\u8981\u66f4\u6539 Dashboard \u91cc\u9762\u56fe\u8868\u7684\u67e5\u8be2\u8bed\u53e5\uff0c\u5c06 job \u7684\u503c\u66f4\u6539\u4e3a\u4f60\u5b9e\u9645\u7684\u6807\u7b7e\uff0c\u6bd4\u5982\u6211\u8fd9\u91cc\u91c7\u96c6 Traefik \u65e5\u5fd7\u7684\u6700\u7ec8\u6807\u7b7e\u4e3a job=\"kube-system/traefik\" \uff1a \u6b64\u5916\u8be5 Dashboard \u4e0a\u8fd8\u51fa\u73b0\u4e86 Panel plugin not found: grafana-piechart-panel \u8fd9\u6837\u7684\u63d0\u793a\uff0c\u8fd9\u662f\u56e0\u4e3a\u8be5\u9762\u677f\u4f9d\u8d56 grafana-piechart-panel \u8fd9\u4e2a\u63d2\u4ef6\uff0c\u6211\u4eec\u8fdb\u5165 Grafana \u5bb9\u5668\u5185\u5b89\u88c5\u91cd\u5efa Pod \u5373\u53ef\uff1a $ kubectl exec -it loki-grafana-864fc6999c-z9587 -n logging -- /bin/bash bash-5.0$ grafana-cli plugins install grafana-piechart-panel installing grafana-piechart-panel @ 1.6.1 from: https://grafana.com/api/plugins/grafana-piechart-panel/versions/1.6.1/download into: /var/lib/grafana/plugins \u2714 Installed grafana-piechart-panel successfully Restart grafana after installing plugins . <service grafana-server restart> \u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5b89\u88c5\u7684\u65f6\u5019\u4e3a Grafana \u6301\u4e45\u5316\u4e86\u6570\u636e\uff0c\u6240\u4ee5\u5220\u6389 Pod \u91cd\u5efa\u5373\u53ef\uff1a kubectl delete pod loki-grafana-864fc6999c-z9587 -n logging pod \"loki-grafana-864fc6999c-z9587\" deleted \u6700\u540e\u8c03\u6574\u8fc7\u540e\u7684 Traefik Dashboard \u5927\u76d8\u6548\u679c\u5982\u4e0b\u6240\u793a\uff1a","title":"\u6536\u96c6 Traefik \u65e5\u5fd7"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/","text":"Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f \u00b6 Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f \u00b6 \u5728 k8s \u96c6\u7fa4\u8c03\u5ea6\u4e2d\uff0c \u4eb2\u548c\u6027 \u76f8\u5173\u7684\u6982\u5ff5\u672c\u8d28\u4e0a\u90fd\u662f\u63a7\u5236 Pod \u5982\u4f55\u88ab\u8c03\u5ea6 -- \u5806\u53e0\u6216\u6253\u6563 \u3002 podAffinity \u4ee5\u53ca podAntiAffinity \u4e24\u4e2a\u7279\u6027\u5bf9 Pod \u5728\u4e0d\u540c\u62d3\u6251\u57df\u7684\u5206\u5e03\u8fdb\u884c\u4e86\u4e00\u4e9b\u63a7\u5236\uff0c podAffinity \u53ef\u4ee5\u5c06\u65e0\u6570\u4e2a Pod \u8c03\u5ea6\u5230\u7279\u5b9a\u7684\u67d0\u4e00\u4e2a\u62d3\u6251\u57df\uff0c\u8fd9\u662f \u5806\u53e0 \u7684\u4f53\u73b0\uff1b podAntiAffinity \u5219\u53ef\u4ee5\u63a7\u5236\u4e00\u4e2a\u62d3\u6251\u57df\u53ea\u5b58\u5728\u4e00\u4e2a Pod\uff0c\u8fd9\u662f \u6253\u6563 \u7684\u4f53\u73b0\u3002\u4f46\u8fd9\u4e24\u79cd\u60c5\u51b5\u90fd\u592a\u6781\u7aef\u4e86\uff0c\u5728\u4e0d\u5c11\u573a\u666f\u4e0b\u90fd\u65e0\u6cd5\u8fbe\u5230\u7406\u60f3\u7684\u6548\u679c\uff0c\u4f8b\u5982\u4e3a\u4e86\u5b9e\u73b0\u5bb9\u707e\u548c\u9ad8\u53ef\u7528\uff0c\u5c06\u4e1a\u52a1 Pod \u5c3d\u53ef\u80fd\u5747\u5300\u7684\u5206\u5e03\u5728\u4e0d\u540c\u53ef\u7528\u533a\u5c31\u5f88\u96be\u5b9e\u73b0\u3002 PodTopologySpread\uff08Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff09 \u7279\u6027\u7684\u63d0\u51fa\u6b63\u662f\u4e3a\u4e86\u5bf9 Pod \u7684\u8c03\u5ea6\u5206\u5e03\u63d0\u4f9b\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\uff0c\u4ee5\u63d0\u9ad8\u670d\u52a1\u53ef\u7528\u6027\u4ee5\u53ca\u8d44\u6e90\u5229\u7528\u7387\uff0c PodTopologySpread \u7531 EvenPodsSpread \u7279\u6027\u95e8\u6240\u63a7\u5236\uff0c\u5728 v1.16 \u7248\u672c\u7b2c\u4e00\u6b21\u53d1\u5e03\uff0c\u5e76\u5728 v1.18 \u7248\u672c\u8fdb\u5165 beta \u9636\u6bb5\u9ed8\u8ba4\u542f\u7528\u3002 \u4f7f\u7528\u89c4\u8303 \u00b6 \u5728 Pod \u7684 Spec \u89c4\u8303\u4e2d\u65b0\u589e\u4e86\u4e00\u4e2a topologySpreadConstraints \u5b57\u6bb5\u5373\u53ef\u914d\u7f6e\u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff0c\u5982\u4e0b\u6240\u793a\uff1a spec: topologySpreadConstraints: - maxSkew: <integer> topologyKey: <string> whenUnsatisfiable: <string> labelSelector: <object> \u7531\u4e8e\u8fd9\u4e2a\u65b0\u589e\u7684\u5b57\u6bb5\u662f\u5728 Pod spec \u5c42\u9762\u6dfb\u52a0\uff0c\u56e0\u6b64\u66f4\u9ad8\u5c42\u7ea7\u7684\u63a7\u5236 (Deployment\u3001DaemonSet\u3001StatefulSet) \u4e5f\u80fd\u4f7f\u7528 PodTopologySpread \u529f\u80fd\u3002 \u8ba9\u6211\u4eec\u7ed3\u5408\u4e0a\u56fe\u6765\u7406\u89e3 topologySpreadConstraints \u4e2d\u5404\u4e2a\u5b57\u6bb5\u7684\u542b\u4e49\u548c\u4f5c\u7528\uff1a labelSelector : \u7528\u6765\u67e5\u627e\u5339\u914d\u7684 Pod\uff0c\u6211\u4eec\u80fd\u591f\u8ba1\u7b97\u51fa\u6bcf\u4e2a\u62d3\u6251\u57df\u4e2d\u5339\u914d\u8be5 label selector \u7684 Pod \u6570\u91cf\uff0c\u5728\u4e0a\u56fe\u4e2d\uff0c\u5047\u5982 label selector \u662f app:foo \uff0c\u90a3\u4e48 zone1 \u7684\u5339\u914d\u4e2a\u6570\u4e3a 2\uff0c zone2 \u7684\u5339\u914d\u4e2a\u6570\u4e3a 0\u3002 topologyKey : \u662f Node label \u7684 key\uff0c\u5982\u679c\u4e24\u4e2a Node \u7684 label \u540c\u65f6\u5177\u6709\u8be5 key \u5e76\u4e14\u503c\u76f8\u540c\uff0c\u5c31\u8bf4\u5b83\u4eec\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u3002\u5728\u4e0a\u56fe\u4e2d\uff0c\u6307\u5b9a topologyKey \u4e3a zone\uff0c \u5219\u5177\u6709 zone=zone1 \u6807\u7b7e\u7684 Node \u88ab\u5206\u5728\u4e00\u4e2a\u62d3\u6251\u57df\uff0c\u5177\u6709 zone=zone2 \u6807\u7b7e\u7684 Node \u88ab\u5206\u5728\u53e6\u4e00\u4e2a\u62d3\u6251\u57df\u3002 maxSkew : \u8fd9\u4e2a\u5c5e\u6027\u7406\u89e3\u8d77\u6765\u4e0d\u662f\u5f88\u76f4\u63a5\uff0c\u5b83\u63cf\u8ff0\u4e86 Pod \u5728\u4e0d\u540c\u62d3\u6251\u57df\u4e2d\u4e0d\u5747\u5300\u5206\u5e03\u7684\u6700\u5927\u7a0b\u5ea6 \uff08\u6307\u5b9a\u62d3\u6251\u7c7b\u578b\u4e2d\u4efb\u610f\u4e24\u4e2a\u62d3\u6251\u57df\u4e2d\u5339\u914d\u7684 Pod \u4e4b\u95f4\u7684\u6700\u5927\u5141\u8bb8\u5dee\u503c\uff09\uff0c\u5b83\u5fc5\u987b\u5927\u4e8e\u96f6\u3002\u6bcf\u4e2a\u62d3\u6251\u57df\u90fd\u6709\u4e00\u4e2a skew \u503c\uff0c\u8ba1\u7b97\u7684\u516c\u5f0f\u662f: skew[i] = \u62d3\u6251\u57df[i]\u4e2d\u5339\u914d\u7684 Pod \u4e2a\u6570 - min{\u5176\u4ed6\u62d3\u6251\u57df\u4e2d\u5339\u914d\u7684 Pod \u4e2a\u6570} \u3002\u5728\u4e0a\u56fe\u4e2d\uff0c\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u5e26\u6709 app=foo \u6807\u7b7e\u7684 Pod\uff1a \u5982\u679c\u8be5 Pod \u88ab\u8c03\u5ea6\u5230 zone1\uff0c\u90a3\u4e48 zone1 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 3\uff0czone2 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 0 (zone1 \u6709 3 \u4e2a\u5339\u914d\u7684 Pod\uff0czone2 \u6709 0 \u4e2a\u5339\u914d\u7684 Pod ) \u5982\u679c\u8be5 Pod \u88ab\u8c03\u5ea6\u5230 zone2\uff0c\u90a3\u4e48 zone1 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 2\uff0czone2 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 1(zone2 \u6709 1 \u4e2a\u5339\u914d\u7684 Pod\uff0c\u62e5\u6709\u5168\u5c40\u6700\u5c0f\u5339\u914d Pod \u6570\u7684\u62d3\u6251\u57df\u6b63\u662f zone2 \u81ea\u5df1 )\uff0c\u5219\u5b83\u6ee1\u8db3 maxSkew: 1 \u7684\u7ea6\u675f\uff08\u5dee\u503c\u4e3a 1\uff09 whenUnsatisfiable : \u63cf\u8ff0\u4e86\u5982\u679c Pod \u4e0d\u6ee1\u8db3\u5206\u5e03\u7ea6\u675f\u6761\u4ef6\u8be5\u91c7\u53d6\u4f55\u79cd\u7b56\u7565\uff1a DoNotSchedule (\u9ed8\u8ba4) \u544a\u8bc9\u8c03\u5ea6\u5668\u4e0d\u8981\u8c03\u5ea6\u8be5 Pod\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u53eb\u4f5c\u786c\u7b56\u7565\uff1b ScheduleAnyway \u544a\u8bc9\u8c03\u5ea6\u5668\u6839\u636e\u6bcf\u4e2a Node \u7684 skew \u503c\u6253\u5206\u6392\u5e8f\u540e\u4ecd\u7136\u8c03\u5ea6\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u53eb\u4f5c\u8f6f\u7b56\u7565\u3002 \u5355\u4e2a\u62d3\u6251\u7ea6\u675f \u00b6 \u5047\u8bbe\u4f60\u62e5\u6709\u4e00\u4e2a 4 \u8282\u70b9\u96c6\u7fa4\uff0c\u5176\u4e2d\u6807\u8bb0\u4e3a foo:bar \u7684 3 \u4e2a Pod \u5206\u522b\u4f4d\u4e8e node1\u3001node2 \u548c node3 \u4e2d\uff1a \u5982\u679c\u5e0c\u671b\u65b0\u6765\u7684 Pod \u5747\u5300\u5206\u5e03\u5728\u73b0\u6709\u7684\u53ef\u7528\u533a\u57df\uff0c\u5219\u53ef\u4ee5\u6309\u5982\u4e0b\u8bbe\u7f6e\u5176\u7ea6\u675f\uff1a kind: Pod apiVersion: v1 metadata: name: mypod labels: foo: bar spec: topologySpreadConstraints: - maxSkew: 1 topologyKey: zone whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar containers: - name: pause image: k8s.gcr.io/pause:3.1 topologyKey: zone \u610f\u5473\u7740\u5747\u5300\u5206\u5e03\u5c06\u53ea\u5e94\u7528\u4e8e\u5b58\u5728\u6807\u7b7e\u952e\u503c\u5bf9\u4e3a zone:<any value> \u7684\u8282\u70b9\u3002 whenUnsatisfiable: DoNotSchedule \u544a\u8bc9\u8c03\u5ea6\u5668\u5982\u679c\u65b0\u7684 Pod \u4e0d\u6ee1\u8db3\u7ea6\u675f\uff0c\u5219\u4e0d\u53ef\u8c03\u5ea6\u3002\u5982\u679c\u8c03\u5ea6\u5668\u5c06\u65b0\u7684 Pod \u653e\u5165 \"zoneA\"\uff0cPods \u5206\u5e03\u5c06\u53d8\u4e3a [3, 1] \uff0c\u56e0\u6b64\u5b9e\u9645\u7684\u504f\u5dee\u4e3a 2(3 - 1) \uff0c\u8fd9\u8fdd\u53cd\u4e86 maxSkew: 1 \u7684\u7ea6\u5b9a\u3002\u6b64\u793a\u4f8b\u4e2d\uff0c\u65b0 Pod \u53ea\u80fd\u653e\u7f6e\u5728 \"zoneB\" \u4e0a\uff1a \u6216\u8005 \u4f60\u53ef\u4ee5\u8c03\u6574 Pod \u7ea6\u675f\u4ee5\u6ee1\u8db3\u5404\u79cd\u8981\u6c42\uff1a \u5c06 maxSkew \u66f4\u6539\u4e3a\u66f4\u5927\u7684\u503c\uff0c\u6bd4\u5982 \"2\"\uff0c\u8fd9\u6837\u65b0\u7684 Pod \u4e5f\u53ef\u4ee5\u653e\u5728 \"zoneA\" \u4e0a\u3002 \u5c06 topologyKey \u66f4\u6539\u4e3a \"node\"\uff0c\u4ee5\u4fbf\u5c06 Pod \u5747\u5300\u5206\u5e03\u5728\u8282\u70b9\u4e0a\u800c\u4e0d\u662f\u533a\u57df\u4e2d\u3002 \u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5982\u679c maxSkew \u4fdd\u6301\u4e3a \"1\"\uff0c\u90a3\u4e48\u4f20\u5165\u7684 Pod \u53ea\u80fd\u653e\u5728 \"node4\" \u4e0a\u3002 \u5c06 whenUnsatisfiable: DoNotSchedule \u66f4\u6539\u4e3a whenUnsatisfiable: ScheduleAnyway \uff0c \u4ee5\u786e\u4fdd\u65b0\u7684 Pod \u53ef\u4ee5\u88ab\u8c03\u5ea6\u3002 \u591a\u4e2a\u62d3\u6251\u7ea6\u675f \u00b6 \u4e0a\u9762\u662f\u5355\u4e2a Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f\u7684\u60c5\u51b5\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u5efa\u7acb\u5728\u524d\u9762\u4f8b\u5b50\u7684\u57fa\u7840\u4e0a\u6765\u5bf9\u591a\u4e2a Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f\u8fdb\u884c\u8bf4\u660e\u3002\u5047\u8bbe\u4f60\u62e5\u6709\u4e00\u4e2a 4 \u8282\u70b9\u96c6\u7fa4\uff0c\u5176\u4e2d 3 \u4e2a\u6807\u8bb0\u4e3a foo:bar \u7684 Pod \u5206\u522b\u4f4d\u4e8e node1\u3001node2 \u548c node3 \u4e0a\uff1a \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 2 \u4e2a TopologySpreadConstraint \u6765\u63a7\u5236 Pod \u5728\u533a\u57df\u548c\u8282\u70b9\u4e24\u4e2a\u7ef4\u5ea6\u4e0a\u7684\u5206\u5e03\uff1a # two-constraints.yaml kind: Pod apiVersion: v1 metadata: name: mypod labels: foo: bar spec: topologySpreadConstraints: - maxSkew: 1 topologyKey: zone whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar - maxSkew: 1 topologyKey: node whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar containers: - name: pause image: k8s.gcr.io/pause:3.1 \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u5339\u914d\u7b2c\u4e00\u4e2a\u7ea6\u675f\uff0c\u65b0\u7684 Pod \u53ea\u80fd\u653e\u7f6e\u5728 \"zoneB\" \u4e2d\uff1b\u800c\u5728\u7b2c\u4e8c\u4e2a\u7ea6\u675f\u4e2d\uff0c \u65b0\u7684 Pod \u53ea\u80fd\u653e\u7f6e\u5728 \"node4\" \u4e0a\uff0c\u6700\u540e\u4e24\u4e2a\u7ea6\u675f\u7684\u7ed3\u679c\u52a0\u5728\u4e00\u8d77\uff0c\u552f\u4e00\u53ef\u884c\u7684\u9009\u62e9\u662f\u653e\u7f6e \u5728 \"node4\" \u4e0a\u3002 \u591a\u4e2a\u7ea6\u675f\u4e4b\u95f4\u662f\u53ef\u80fd\u5b58\u5728\u51b2\u7a81\u7684\uff0c\u5047\u8bbe\u6709\u4e00\u4e2a\u8de8\u8d8a 2 \u4e2a\u533a\u57df\u7684 3 \u8282\u70b9\u96c6\u7fa4\uff1a \u5982\u679c\u5bf9\u96c6\u7fa4\u5e94\u7528 two-constraints.yaml \uff0c\u4f1a\u53d1\u73b0 \"mypod\" \u5904\u4e8e Pending \u72b6\u6001\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e3a\u4e86\u6ee1\u8db3\u7b2c\u4e00\u4e2a\u7ea6\u675f\uff0c\"mypod\" \u53ea\u80fd\u653e\u5728 \"zoneB\" \u4e2d\uff0c\u800c\u7b2c\u4e8c\u4e2a\u7ea6\u675f\u8981\u6c42 \"mypod\" \u53ea\u80fd\u653e\u5728 \"node2\" \u4e0a\uff0cPod \u8c03\u5ea6\u65e0\u6cd5\u6ee1\u8db3\u8fd9\u4e24\u79cd\u7ea6\u675f\uff0c\u6240\u4ee5\u5c31\u51b2\u7a81\u4e86\u3002 \u4e3a\u4e86\u514b\u670d\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f60\u53ef\u4ee5\u589e\u52a0 maxSkew \u6216\u4fee\u6539\u5176\u4e2d\u4e00\u4e2a\u7ea6\u675f\uff0c\u8ba9\u5176\u4f7f\u7528 whenUnsatisfiable: ScheduleAnyway \u3002 \u4e0e NodeSelector/NodeAffinity \u4e00\u8d77\u4f7f\u7528 \u00b6 \u4ed4\u7ec6\u89c2\u5bdf\u53ef\u80fd\u4f60\u4f1a\u53d1\u73b0\u6211\u4eec\u5e76\u6ca1\u6709\u7c7b\u4f3c\u4e8e topologyValues \u7684\u5b57\u6bb5\u6765\u9650\u5236 Pod \u5c06\u88ab\u8c03\u5ea6\u5230\u54ea\u4e9b\u62d3\u6251\u53bb\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4f1a\u641c\u7d22\u6240\u6709\u8282\u70b9\u5e76\u6309 topologyKey \u5bf9\u5176\u8fdb\u884c\u5206\u7ec4\u3002\u6709\u65f6\u8fd9\u53ef\u80fd\u4e0d\u662f\u7406\u60f3\u7684\u60c5\u51b5\uff0c\u6bd4\u5982\u5047\u8bbe\u6709\u4e00\u4e2a\u96c6\u7fa4\uff0c\u5176\u8282\u70b9\u6807\u8bb0\u4e3a env=prod \u3001 env=staging \u548c env=qa \uff0c\u73b0\u5728\u4f60\u60f3\u8de8\u533a\u57df\u5c06 Pod \u5747\u5300\u5730\u653e\u7f6e\u5230 qa \u73af\u5883\u4e2d\uff0c\u662f\u5426\u53ef\u884c? \u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed3\u5408 NodeSelector \u6216 NodeAffinity \u4e00\u8d77\u4f7f\u7528\uff0c PodTopologySpread \u4f1a\u8ba1\u7b97\u6ee1\u8db3\u9009\u62e9\u5668\u7684\u8282\u70b9\u4e4b\u95f4\u7684\u4f20\u64ad\u7ea6\u675f\u3002 \u5982\u4e0a\u56fe\u6240\u793a\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a spec.affinity.nodeAffinity \u5c06 \u641c\u7d22\u8303\u56f4 \u9650\u5236\u4e3a qa \u73af\u5883\uff0c\u5728\u8be5\u8303\u56f4\u5185 Pod \u5c06\u88ab\u8c03\u5ea6\u5230\u4e00\u4e2a\u6ee1\u8db3 topologySpreadConstraints \u7684\u533a\u57df\uff0c\u8fd9\u91cc\u5c31\u53ea\u80fd\u88ab\u8c03\u5ea6\u5230 zone=zone2 \u7684\u8282\u70b9\u4e0a\u53bb\u4e86\u3002 \u96c6\u7fa4\u9ed8\u8ba4\u7ea6\u675f \u00b6 \u9664\u4e86\u4e3a\u5355\u4e2a Pod \u8bbe\u7f6e\u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u96c6\u7fa4\u8bbe\u7f6e\u9ed8\u8ba4\u7684\u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff0c\u9ed8\u8ba4\u62d3\u6251\u5206\u5e03\u7ea6\u675f\u5728\u4e14\u4ec5\u5728\u4ee5\u4e0b\u6761\u4ef6\u6ee1\u8db3 \u65f6\u624d\u4f1a\u5e94\u7528\u5230 Pod \u4e0a\uff1a Pod \u6ca1\u6709\u5728\u5176 .spec.topologySpreadConstraints \u8bbe\u7f6e\u4efb\u4f55\u7ea6\u675f\uff1b Pod \u96b6\u5c5e\u4e8e\u67d0\u4e2a\u670d\u52a1\u3001\u526f\u672c\u63a7\u5236\u5668\u3001ReplicaSet \u6216 StatefulSet\u3002 \u4f60\u53ef\u4ee5\u5728 \u8c03\u5ea6\u65b9\u6848\uff08Schedulingg Profile\uff09 \u4e2d\u5c06\u9ed8\u8ba4\u7ea6\u675f\u4f5c\u4e3a PodTopologySpread \u63d2\u4ef6\u53c2\u6570\u7684\u4e00\u90e8\u5206\u6765\u8fdb\u884c\u8bbe\u7f6e\u3002 \u7ea6\u675f\u7684\u8bbe\u7f6e\u91c7\u7528\u548c\u524d\u9762 Pod \u4e2d\u7684\u89c4\u8303\u4e00\u81f4\uff0c\u53ea\u662f labelSelector \u5fc5\u987b\u4e3a\u7a7a\u3002\u914d\u7f6e\u7684\u793a\u4f8b\u53ef\u80fd\u770b\u8d77\u6765\u50cf\u4e0b\u9762\u8fd9\u4e2a\u6837\u5b50\uff1a apiVersion: kubescheduler.config.k8s.io/v1beta1 kind: KubeSchedulerConfiguration profiles: - pluginConfig: - name: PodTopologySpread args: defaultConstraints: - maxSkew: 1 topologyKey: topology.kubernetes.io/zone whenUnsatisfiable: ScheduleAnyway defaultingType: List \u8bfe\u540e\u4e60\u9898 \u00b6 \u73b0\u5728\u6211\u4eec\u518d\u53bb\u89e3\u51b3\u4e0a\u8282\u8bfe\u7559\u4e0b\u7684\u4e00\u4e2a\u95ee\u9898 - \u5982\u679c\u60f3\u5728\u6bcf\u4e2a\u8282\u70b9\uff08\u6216\u6307\u5b9a\u7684\u4e00\u4e9b\u8282\u70b9\uff09\u4e0a\u8fd0\u884c 2 \u4e2a\uff08\u6216\u591a\u4e2a\uff09Pod \u526f\u672c\uff0c\u5982\u4f55\u5b9e\u73b0\uff1f \u8fd9\u91cc\u4ee5\u6211\u4eec\u7684\u96c6\u7fa4\u4e3a\u4f8b\uff0c\u52a0\u4e0a master \u8282\u70b9\u4e00\u5171\u6709 3 \u4e2a\u8282\u70b9\uff0c\u6bcf\u4e2a\u8282\u70b9\u8fd0\u884c 2 \u4e2a\u526f\u672c\uff0c\u603b\u5171\u5c31\u9700\u8981 6 \u4e2a Pod \u526f\u672c\uff0c\u8981\u5728 master \u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u5219\u540c\u6837\u9700\u8981\u6dfb\u52a0\u5bb9\u5fcd\uff0c\u5982\u679c\u53ea\u60f3\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c 2 \u4e2a\u526f\u672c\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u7684\u62d3\u6251\u5206\u5e03\u7ea6\u675f\u6765\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a apiVersion: apps/v1 kind: Deployment metadata: name: topo-demo spec: replicas: 6 selector: matchLabels: app: topo template: metadata: labels: app: topo spec: tolerations: - key: \"node-role.kubernetes.io/master\" operator: \"Exists\" effect: \"NoSchedule\" containers: - image: nginx name: nginx ports: - containerPort: 80 name: ngpt topologySpreadConstraints: - maxSkew: 1 topologyKey: kubernetes.io/hostname whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: app: topo \u8fd9\u91cc\u6211\u4eec\u91cd\u70b9\u9700\u8981\u5173\u6ce8\u7684\u5c31\u662f topologySpreadConstraints \u90e8\u5206\u7684\u914d\u7f6e\uff0c\u6211\u4eec\u9009\u62e9\u4f7f\u7528 kubernetes.io/hostname \u4e3a\u62d3\u6251\u57df\uff0c\u76f8\u5f53\u4e8e\u5c31\u662f 3 \u4e2a\u8282\u70b9\u90fd\u662f\u72ec\u7acb\u7684\uff0c maxSkew: 1 \u8868\u793a\u6700\u5927\u7684\u5206\u5e03\u4e0d\u5747\u5300\u5ea6\u4e3a 1\uff0c\u6240\u4ee5\u53ea\u80fd\u51fa\u73b0\u7684\u8c03\u5ea6\u7ed3\u679c\u5c31\u662f\u6bcf\u4e2a\u8282\u70b9\u8fd0\u884c 2 \u4e2a Pod\u3002 \u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5373\u53ef\u9a8c\u8bc1\uff1a \u279c kubectl get nodes NAME STATUS ROLES AGE VERSION master1 Ready control-plane,master 85d v1.22.2 node1 Ready <none> 85d v1.22.2 node2 Ready <none> 85d v1.22.2 \u279c kubectl get pods -l app=topo -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES topo-demo-6bbf65d967-7969w 1/1 Running 0 7m16s 10.244.2.40 node2 <none> <none> topo-demo-6bbf65d967-8vhb8 1/1 Running 0 7m16s 10.244.2.41 node2 <none> <none> topo-demo-6bbf65d967-cvg7j 1/1 Running 0 7m16s 10.244.1.211 node1 <none> <none> topo-demo-6bbf65d967-hzhv2 1/1 Running 0 7m16s 10.244.0.143 master1 <none> <none> topo-demo-6bbf65d967-nvg4z 1/1 Running 0 7m16s 10.244.0.144 master1 <none> <none> topo-demo-6bbf65d967-w7w29 1/1 Running 0 7m16s 10.244.1.212 node1 <none> <none> \u53ef\u4ee5\u770b\u5230\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86 2 \u4e2a Pod \u526f\u672c\uff0c\u5982\u679c\u662f\u8981\u6c42\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c 3 \u4e2a Pod \u526f\u672c\u5462\uff1f\u5927\u5bb6\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u53bb\u7ec3\u4e60\u4e0b\u3002","title":"Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#pod","text":"","title":"Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#pod_1","text":"\u5728 k8s \u96c6\u7fa4\u8c03\u5ea6\u4e2d\uff0c \u4eb2\u548c\u6027 \u76f8\u5173\u7684\u6982\u5ff5\u672c\u8d28\u4e0a\u90fd\u662f\u63a7\u5236 Pod \u5982\u4f55\u88ab\u8c03\u5ea6 -- \u5806\u53e0\u6216\u6253\u6563 \u3002 podAffinity \u4ee5\u53ca podAntiAffinity \u4e24\u4e2a\u7279\u6027\u5bf9 Pod \u5728\u4e0d\u540c\u62d3\u6251\u57df\u7684\u5206\u5e03\u8fdb\u884c\u4e86\u4e00\u4e9b\u63a7\u5236\uff0c podAffinity \u53ef\u4ee5\u5c06\u65e0\u6570\u4e2a Pod \u8c03\u5ea6\u5230\u7279\u5b9a\u7684\u67d0\u4e00\u4e2a\u62d3\u6251\u57df\uff0c\u8fd9\u662f \u5806\u53e0 \u7684\u4f53\u73b0\uff1b podAntiAffinity \u5219\u53ef\u4ee5\u63a7\u5236\u4e00\u4e2a\u62d3\u6251\u57df\u53ea\u5b58\u5728\u4e00\u4e2a Pod\uff0c\u8fd9\u662f \u6253\u6563 \u7684\u4f53\u73b0\u3002\u4f46\u8fd9\u4e24\u79cd\u60c5\u51b5\u90fd\u592a\u6781\u7aef\u4e86\uff0c\u5728\u4e0d\u5c11\u573a\u666f\u4e0b\u90fd\u65e0\u6cd5\u8fbe\u5230\u7406\u60f3\u7684\u6548\u679c\uff0c\u4f8b\u5982\u4e3a\u4e86\u5b9e\u73b0\u5bb9\u707e\u548c\u9ad8\u53ef\u7528\uff0c\u5c06\u4e1a\u52a1 Pod \u5c3d\u53ef\u80fd\u5747\u5300\u7684\u5206\u5e03\u5728\u4e0d\u540c\u53ef\u7528\u533a\u5c31\u5f88\u96be\u5b9e\u73b0\u3002 PodTopologySpread\uff08Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff09 \u7279\u6027\u7684\u63d0\u51fa\u6b63\u662f\u4e3a\u4e86\u5bf9 Pod \u7684\u8c03\u5ea6\u5206\u5e03\u63d0\u4f9b\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\uff0c\u4ee5\u63d0\u9ad8\u670d\u52a1\u53ef\u7528\u6027\u4ee5\u53ca\u8d44\u6e90\u5229\u7528\u7387\uff0c PodTopologySpread \u7531 EvenPodsSpread \u7279\u6027\u95e8\u6240\u63a7\u5236\uff0c\u5728 v1.16 \u7248\u672c\u7b2c\u4e00\u6b21\u53d1\u5e03\uff0c\u5e76\u5728 v1.18 \u7248\u672c\u8fdb\u5165 beta \u9636\u6bb5\u9ed8\u8ba4\u542f\u7528\u3002","title":"Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#_1","text":"\u5728 Pod \u7684 Spec \u89c4\u8303\u4e2d\u65b0\u589e\u4e86\u4e00\u4e2a topologySpreadConstraints \u5b57\u6bb5\u5373\u53ef\u914d\u7f6e\u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff0c\u5982\u4e0b\u6240\u793a\uff1a spec: topologySpreadConstraints: - maxSkew: <integer> topologyKey: <string> whenUnsatisfiable: <string> labelSelector: <object> \u7531\u4e8e\u8fd9\u4e2a\u65b0\u589e\u7684\u5b57\u6bb5\u662f\u5728 Pod spec \u5c42\u9762\u6dfb\u52a0\uff0c\u56e0\u6b64\u66f4\u9ad8\u5c42\u7ea7\u7684\u63a7\u5236 (Deployment\u3001DaemonSet\u3001StatefulSet) \u4e5f\u80fd\u4f7f\u7528 PodTopologySpread \u529f\u80fd\u3002 \u8ba9\u6211\u4eec\u7ed3\u5408\u4e0a\u56fe\u6765\u7406\u89e3 topologySpreadConstraints \u4e2d\u5404\u4e2a\u5b57\u6bb5\u7684\u542b\u4e49\u548c\u4f5c\u7528\uff1a labelSelector : \u7528\u6765\u67e5\u627e\u5339\u914d\u7684 Pod\uff0c\u6211\u4eec\u80fd\u591f\u8ba1\u7b97\u51fa\u6bcf\u4e2a\u62d3\u6251\u57df\u4e2d\u5339\u914d\u8be5 label selector \u7684 Pod \u6570\u91cf\uff0c\u5728\u4e0a\u56fe\u4e2d\uff0c\u5047\u5982 label selector \u662f app:foo \uff0c\u90a3\u4e48 zone1 \u7684\u5339\u914d\u4e2a\u6570\u4e3a 2\uff0c zone2 \u7684\u5339\u914d\u4e2a\u6570\u4e3a 0\u3002 topologyKey : \u662f Node label \u7684 key\uff0c\u5982\u679c\u4e24\u4e2a Node \u7684 label \u540c\u65f6\u5177\u6709\u8be5 key \u5e76\u4e14\u503c\u76f8\u540c\uff0c\u5c31\u8bf4\u5b83\u4eec\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u3002\u5728\u4e0a\u56fe\u4e2d\uff0c\u6307\u5b9a topologyKey \u4e3a zone\uff0c \u5219\u5177\u6709 zone=zone1 \u6807\u7b7e\u7684 Node \u88ab\u5206\u5728\u4e00\u4e2a\u62d3\u6251\u57df\uff0c\u5177\u6709 zone=zone2 \u6807\u7b7e\u7684 Node \u88ab\u5206\u5728\u53e6\u4e00\u4e2a\u62d3\u6251\u57df\u3002 maxSkew : \u8fd9\u4e2a\u5c5e\u6027\u7406\u89e3\u8d77\u6765\u4e0d\u662f\u5f88\u76f4\u63a5\uff0c\u5b83\u63cf\u8ff0\u4e86 Pod \u5728\u4e0d\u540c\u62d3\u6251\u57df\u4e2d\u4e0d\u5747\u5300\u5206\u5e03\u7684\u6700\u5927\u7a0b\u5ea6 \uff08\u6307\u5b9a\u62d3\u6251\u7c7b\u578b\u4e2d\u4efb\u610f\u4e24\u4e2a\u62d3\u6251\u57df\u4e2d\u5339\u914d\u7684 Pod \u4e4b\u95f4\u7684\u6700\u5927\u5141\u8bb8\u5dee\u503c\uff09\uff0c\u5b83\u5fc5\u987b\u5927\u4e8e\u96f6\u3002\u6bcf\u4e2a\u62d3\u6251\u57df\u90fd\u6709\u4e00\u4e2a skew \u503c\uff0c\u8ba1\u7b97\u7684\u516c\u5f0f\u662f: skew[i] = \u62d3\u6251\u57df[i]\u4e2d\u5339\u914d\u7684 Pod \u4e2a\u6570 - min{\u5176\u4ed6\u62d3\u6251\u57df\u4e2d\u5339\u914d\u7684 Pod \u4e2a\u6570} \u3002\u5728\u4e0a\u56fe\u4e2d\uff0c\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u5e26\u6709 app=foo \u6807\u7b7e\u7684 Pod\uff1a \u5982\u679c\u8be5 Pod \u88ab\u8c03\u5ea6\u5230 zone1\uff0c\u90a3\u4e48 zone1 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 3\uff0czone2 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 0 (zone1 \u6709 3 \u4e2a\u5339\u914d\u7684 Pod\uff0czone2 \u6709 0 \u4e2a\u5339\u914d\u7684 Pod ) \u5982\u679c\u8be5 Pod \u88ab\u8c03\u5ea6\u5230 zone2\uff0c\u90a3\u4e48 zone1 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 2\uff0czone2 \u4e2d Node \u7684 skew \u503c\u53d8\u4e3a 1(zone2 \u6709 1 \u4e2a\u5339\u914d\u7684 Pod\uff0c\u62e5\u6709\u5168\u5c40\u6700\u5c0f\u5339\u914d Pod \u6570\u7684\u62d3\u6251\u57df\u6b63\u662f zone2 \u81ea\u5df1 )\uff0c\u5219\u5b83\u6ee1\u8db3 maxSkew: 1 \u7684\u7ea6\u675f\uff08\u5dee\u503c\u4e3a 1\uff09 whenUnsatisfiable : \u63cf\u8ff0\u4e86\u5982\u679c Pod \u4e0d\u6ee1\u8db3\u5206\u5e03\u7ea6\u675f\u6761\u4ef6\u8be5\u91c7\u53d6\u4f55\u79cd\u7b56\u7565\uff1a DoNotSchedule (\u9ed8\u8ba4) \u544a\u8bc9\u8c03\u5ea6\u5668\u4e0d\u8981\u8c03\u5ea6\u8be5 Pod\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u53eb\u4f5c\u786c\u7b56\u7565\uff1b ScheduleAnyway \u544a\u8bc9\u8c03\u5ea6\u5668\u6839\u636e\u6bcf\u4e2a Node \u7684 skew \u503c\u6253\u5206\u6392\u5e8f\u540e\u4ecd\u7136\u8c03\u5ea6\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u53eb\u4f5c\u8f6f\u7b56\u7565\u3002","title":"\u4f7f\u7528\u89c4\u8303"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#_2","text":"\u5047\u8bbe\u4f60\u62e5\u6709\u4e00\u4e2a 4 \u8282\u70b9\u96c6\u7fa4\uff0c\u5176\u4e2d\u6807\u8bb0\u4e3a foo:bar \u7684 3 \u4e2a Pod \u5206\u522b\u4f4d\u4e8e node1\u3001node2 \u548c node3 \u4e2d\uff1a \u5982\u679c\u5e0c\u671b\u65b0\u6765\u7684 Pod \u5747\u5300\u5206\u5e03\u5728\u73b0\u6709\u7684\u53ef\u7528\u533a\u57df\uff0c\u5219\u53ef\u4ee5\u6309\u5982\u4e0b\u8bbe\u7f6e\u5176\u7ea6\u675f\uff1a kind: Pod apiVersion: v1 metadata: name: mypod labels: foo: bar spec: topologySpreadConstraints: - maxSkew: 1 topologyKey: zone whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar containers: - name: pause image: k8s.gcr.io/pause:3.1 topologyKey: zone \u610f\u5473\u7740\u5747\u5300\u5206\u5e03\u5c06\u53ea\u5e94\u7528\u4e8e\u5b58\u5728\u6807\u7b7e\u952e\u503c\u5bf9\u4e3a zone:<any value> \u7684\u8282\u70b9\u3002 whenUnsatisfiable: DoNotSchedule \u544a\u8bc9\u8c03\u5ea6\u5668\u5982\u679c\u65b0\u7684 Pod \u4e0d\u6ee1\u8db3\u7ea6\u675f\uff0c\u5219\u4e0d\u53ef\u8c03\u5ea6\u3002\u5982\u679c\u8c03\u5ea6\u5668\u5c06\u65b0\u7684 Pod \u653e\u5165 \"zoneA\"\uff0cPods \u5206\u5e03\u5c06\u53d8\u4e3a [3, 1] \uff0c\u56e0\u6b64\u5b9e\u9645\u7684\u504f\u5dee\u4e3a 2(3 - 1) \uff0c\u8fd9\u8fdd\u53cd\u4e86 maxSkew: 1 \u7684\u7ea6\u5b9a\u3002\u6b64\u793a\u4f8b\u4e2d\uff0c\u65b0 Pod \u53ea\u80fd\u653e\u7f6e\u5728 \"zoneB\" \u4e0a\uff1a \u6216\u8005 \u4f60\u53ef\u4ee5\u8c03\u6574 Pod \u7ea6\u675f\u4ee5\u6ee1\u8db3\u5404\u79cd\u8981\u6c42\uff1a \u5c06 maxSkew \u66f4\u6539\u4e3a\u66f4\u5927\u7684\u503c\uff0c\u6bd4\u5982 \"2\"\uff0c\u8fd9\u6837\u65b0\u7684 Pod \u4e5f\u53ef\u4ee5\u653e\u5728 \"zoneA\" \u4e0a\u3002 \u5c06 topologyKey \u66f4\u6539\u4e3a \"node\"\uff0c\u4ee5\u4fbf\u5c06 Pod \u5747\u5300\u5206\u5e03\u5728\u8282\u70b9\u4e0a\u800c\u4e0d\u662f\u533a\u57df\u4e2d\u3002 \u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5982\u679c maxSkew \u4fdd\u6301\u4e3a \"1\"\uff0c\u90a3\u4e48\u4f20\u5165\u7684 Pod \u53ea\u80fd\u653e\u5728 \"node4\" \u4e0a\u3002 \u5c06 whenUnsatisfiable: DoNotSchedule \u66f4\u6539\u4e3a whenUnsatisfiable: ScheduleAnyway \uff0c \u4ee5\u786e\u4fdd\u65b0\u7684 Pod \u53ef\u4ee5\u88ab\u8c03\u5ea6\u3002","title":"\u5355\u4e2a\u62d3\u6251\u7ea6\u675f"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#_3","text":"\u4e0a\u9762\u662f\u5355\u4e2a Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f\u7684\u60c5\u51b5\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u5efa\u7acb\u5728\u524d\u9762\u4f8b\u5b50\u7684\u57fa\u7840\u4e0a\u6765\u5bf9\u591a\u4e2a Pod \u62d3\u6251\u5206\u5e03\u7ea6\u675f\u8fdb\u884c\u8bf4\u660e\u3002\u5047\u8bbe\u4f60\u62e5\u6709\u4e00\u4e2a 4 \u8282\u70b9\u96c6\u7fa4\uff0c\u5176\u4e2d 3 \u4e2a\u6807\u8bb0\u4e3a foo:bar \u7684 Pod \u5206\u522b\u4f4d\u4e8e node1\u3001node2 \u548c node3 \u4e0a\uff1a \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 2 \u4e2a TopologySpreadConstraint \u6765\u63a7\u5236 Pod \u5728\u533a\u57df\u548c\u8282\u70b9\u4e24\u4e2a\u7ef4\u5ea6\u4e0a\u7684\u5206\u5e03\uff1a # two-constraints.yaml kind: Pod apiVersion: v1 metadata: name: mypod labels: foo: bar spec: topologySpreadConstraints: - maxSkew: 1 topologyKey: zone whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar - maxSkew: 1 topologyKey: node whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar containers: - name: pause image: k8s.gcr.io/pause:3.1 \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u5339\u914d\u7b2c\u4e00\u4e2a\u7ea6\u675f\uff0c\u65b0\u7684 Pod \u53ea\u80fd\u653e\u7f6e\u5728 \"zoneB\" \u4e2d\uff1b\u800c\u5728\u7b2c\u4e8c\u4e2a\u7ea6\u675f\u4e2d\uff0c \u65b0\u7684 Pod \u53ea\u80fd\u653e\u7f6e\u5728 \"node4\" \u4e0a\uff0c\u6700\u540e\u4e24\u4e2a\u7ea6\u675f\u7684\u7ed3\u679c\u52a0\u5728\u4e00\u8d77\uff0c\u552f\u4e00\u53ef\u884c\u7684\u9009\u62e9\u662f\u653e\u7f6e \u5728 \"node4\" \u4e0a\u3002 \u591a\u4e2a\u7ea6\u675f\u4e4b\u95f4\u662f\u53ef\u80fd\u5b58\u5728\u51b2\u7a81\u7684\uff0c\u5047\u8bbe\u6709\u4e00\u4e2a\u8de8\u8d8a 2 \u4e2a\u533a\u57df\u7684 3 \u8282\u70b9\u96c6\u7fa4\uff1a \u5982\u679c\u5bf9\u96c6\u7fa4\u5e94\u7528 two-constraints.yaml \uff0c\u4f1a\u53d1\u73b0 \"mypod\" \u5904\u4e8e Pending \u72b6\u6001\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e3a\u4e86\u6ee1\u8db3\u7b2c\u4e00\u4e2a\u7ea6\u675f\uff0c\"mypod\" \u53ea\u80fd\u653e\u5728 \"zoneB\" \u4e2d\uff0c\u800c\u7b2c\u4e8c\u4e2a\u7ea6\u675f\u8981\u6c42 \"mypod\" \u53ea\u80fd\u653e\u5728 \"node2\" \u4e0a\uff0cPod \u8c03\u5ea6\u65e0\u6cd5\u6ee1\u8db3\u8fd9\u4e24\u79cd\u7ea6\u675f\uff0c\u6240\u4ee5\u5c31\u51b2\u7a81\u4e86\u3002 \u4e3a\u4e86\u514b\u670d\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f60\u53ef\u4ee5\u589e\u52a0 maxSkew \u6216\u4fee\u6539\u5176\u4e2d\u4e00\u4e2a\u7ea6\u675f\uff0c\u8ba9\u5176\u4f7f\u7528 whenUnsatisfiable: ScheduleAnyway \u3002","title":"\u591a\u4e2a\u62d3\u6251\u7ea6\u675f"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#nodeselectornodeaffinity","text":"\u4ed4\u7ec6\u89c2\u5bdf\u53ef\u80fd\u4f60\u4f1a\u53d1\u73b0\u6211\u4eec\u5e76\u6ca1\u6709\u7c7b\u4f3c\u4e8e topologyValues \u7684\u5b57\u6bb5\u6765\u9650\u5236 Pod \u5c06\u88ab\u8c03\u5ea6\u5230\u54ea\u4e9b\u62d3\u6251\u53bb\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4f1a\u641c\u7d22\u6240\u6709\u8282\u70b9\u5e76\u6309 topologyKey \u5bf9\u5176\u8fdb\u884c\u5206\u7ec4\u3002\u6709\u65f6\u8fd9\u53ef\u80fd\u4e0d\u662f\u7406\u60f3\u7684\u60c5\u51b5\uff0c\u6bd4\u5982\u5047\u8bbe\u6709\u4e00\u4e2a\u96c6\u7fa4\uff0c\u5176\u8282\u70b9\u6807\u8bb0\u4e3a env=prod \u3001 env=staging \u548c env=qa \uff0c\u73b0\u5728\u4f60\u60f3\u8de8\u533a\u57df\u5c06 Pod \u5747\u5300\u5730\u653e\u7f6e\u5230 qa \u73af\u5883\u4e2d\uff0c\u662f\u5426\u53ef\u884c? \u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed3\u5408 NodeSelector \u6216 NodeAffinity \u4e00\u8d77\u4f7f\u7528\uff0c PodTopologySpread \u4f1a\u8ba1\u7b97\u6ee1\u8db3\u9009\u62e9\u5668\u7684\u8282\u70b9\u4e4b\u95f4\u7684\u4f20\u64ad\u7ea6\u675f\u3002 \u5982\u4e0a\u56fe\u6240\u793a\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a spec.affinity.nodeAffinity \u5c06 \u641c\u7d22\u8303\u56f4 \u9650\u5236\u4e3a qa \u73af\u5883\uff0c\u5728\u8be5\u8303\u56f4\u5185 Pod \u5c06\u88ab\u8c03\u5ea6\u5230\u4e00\u4e2a\u6ee1\u8db3 topologySpreadConstraints \u7684\u533a\u57df\uff0c\u8fd9\u91cc\u5c31\u53ea\u80fd\u88ab\u8c03\u5ea6\u5230 zone=zone2 \u7684\u8282\u70b9\u4e0a\u53bb\u4e86\u3002","title":"\u4e0e NodeSelector/NodeAffinity \u4e00\u8d77\u4f7f\u7528"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#_4","text":"\u9664\u4e86\u4e3a\u5355\u4e2a Pod \u8bbe\u7f6e\u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u96c6\u7fa4\u8bbe\u7f6e\u9ed8\u8ba4\u7684\u62d3\u6251\u5206\u5e03\u7ea6\u675f\uff0c\u9ed8\u8ba4\u62d3\u6251\u5206\u5e03\u7ea6\u675f\u5728\u4e14\u4ec5\u5728\u4ee5\u4e0b\u6761\u4ef6\u6ee1\u8db3 \u65f6\u624d\u4f1a\u5e94\u7528\u5230 Pod \u4e0a\uff1a Pod \u6ca1\u6709\u5728\u5176 .spec.topologySpreadConstraints \u8bbe\u7f6e\u4efb\u4f55\u7ea6\u675f\uff1b Pod \u96b6\u5c5e\u4e8e\u67d0\u4e2a\u670d\u52a1\u3001\u526f\u672c\u63a7\u5236\u5668\u3001ReplicaSet \u6216 StatefulSet\u3002 \u4f60\u53ef\u4ee5\u5728 \u8c03\u5ea6\u65b9\u6848\uff08Schedulingg Profile\uff09 \u4e2d\u5c06\u9ed8\u8ba4\u7ea6\u675f\u4f5c\u4e3a PodTopologySpread \u63d2\u4ef6\u53c2\u6570\u7684\u4e00\u90e8\u5206\u6765\u8fdb\u884c\u8bbe\u7f6e\u3002 \u7ea6\u675f\u7684\u8bbe\u7f6e\u91c7\u7528\u548c\u524d\u9762 Pod \u4e2d\u7684\u89c4\u8303\u4e00\u81f4\uff0c\u53ea\u662f labelSelector \u5fc5\u987b\u4e3a\u7a7a\u3002\u914d\u7f6e\u7684\u793a\u4f8b\u53ef\u80fd\u770b\u8d77\u6765\u50cf\u4e0b\u9762\u8fd9\u4e2a\u6837\u5b50\uff1a apiVersion: kubescheduler.config.k8s.io/v1beta1 kind: KubeSchedulerConfiguration profiles: - pluginConfig: - name: PodTopologySpread args: defaultConstraints: - maxSkew: 1 topologyKey: topology.kubernetes.io/zone whenUnsatisfiable: ScheduleAnyway defaultingType: List","title":"\u96c6\u7fa4\u9ed8\u8ba4\u7ea6\u675f"},{"location":"3.k8s/7.logging/pod-%E6%8B%93%E6%89%91%E5%88%86%E5%B8%83%E7%BA%A6%E6%9D%9F/#_5","text":"\u73b0\u5728\u6211\u4eec\u518d\u53bb\u89e3\u51b3\u4e0a\u8282\u8bfe\u7559\u4e0b\u7684\u4e00\u4e2a\u95ee\u9898 - \u5982\u679c\u60f3\u5728\u6bcf\u4e2a\u8282\u70b9\uff08\u6216\u6307\u5b9a\u7684\u4e00\u4e9b\u8282\u70b9\uff09\u4e0a\u8fd0\u884c 2 \u4e2a\uff08\u6216\u591a\u4e2a\uff09Pod \u526f\u672c\uff0c\u5982\u4f55\u5b9e\u73b0\uff1f \u8fd9\u91cc\u4ee5\u6211\u4eec\u7684\u96c6\u7fa4\u4e3a\u4f8b\uff0c\u52a0\u4e0a master \u8282\u70b9\u4e00\u5171\u6709 3 \u4e2a\u8282\u70b9\uff0c\u6bcf\u4e2a\u8282\u70b9\u8fd0\u884c 2 \u4e2a\u526f\u672c\uff0c\u603b\u5171\u5c31\u9700\u8981 6 \u4e2a Pod \u526f\u672c\uff0c\u8981\u5728 master \u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u5219\u540c\u6837\u9700\u8981\u6dfb\u52a0\u5bb9\u5fcd\uff0c\u5982\u679c\u53ea\u60f3\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c 2 \u4e2a\u526f\u672c\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u7684\u62d3\u6251\u5206\u5e03\u7ea6\u675f\u6765\u8fdb\u884c\u7ec6\u7c92\u5ea6\u63a7\u5236\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a apiVersion: apps/v1 kind: Deployment metadata: name: topo-demo spec: replicas: 6 selector: matchLabels: app: topo template: metadata: labels: app: topo spec: tolerations: - key: \"node-role.kubernetes.io/master\" operator: \"Exists\" effect: \"NoSchedule\" containers: - image: nginx name: nginx ports: - containerPort: 80 name: ngpt topologySpreadConstraints: - maxSkew: 1 topologyKey: kubernetes.io/hostname whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: app: topo \u8fd9\u91cc\u6211\u4eec\u91cd\u70b9\u9700\u8981\u5173\u6ce8\u7684\u5c31\u662f topologySpreadConstraints \u90e8\u5206\u7684\u914d\u7f6e\uff0c\u6211\u4eec\u9009\u62e9\u4f7f\u7528 kubernetes.io/hostname \u4e3a\u62d3\u6251\u57df\uff0c\u76f8\u5f53\u4e8e\u5c31\u662f 3 \u4e2a\u8282\u70b9\u90fd\u662f\u72ec\u7acb\u7684\uff0c maxSkew: 1 \u8868\u793a\u6700\u5927\u7684\u5206\u5e03\u4e0d\u5747\u5300\u5ea6\u4e3a 1\uff0c\u6240\u4ee5\u53ea\u80fd\u51fa\u73b0\u7684\u8c03\u5ea6\u7ed3\u679c\u5c31\u662f\u6bcf\u4e2a\u8282\u70b9\u8fd0\u884c 2 \u4e2a Pod\u3002 \u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5373\u53ef\u9a8c\u8bc1\uff1a \u279c kubectl get nodes NAME STATUS ROLES AGE VERSION master1 Ready control-plane,master 85d v1.22.2 node1 Ready <none> 85d v1.22.2 node2 Ready <none> 85d v1.22.2 \u279c kubectl get pods -l app=topo -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES topo-demo-6bbf65d967-7969w 1/1 Running 0 7m16s 10.244.2.40 node2 <none> <none> topo-demo-6bbf65d967-8vhb8 1/1 Running 0 7m16s 10.244.2.41 node2 <none> <none> topo-demo-6bbf65d967-cvg7j 1/1 Running 0 7m16s 10.244.1.211 node1 <none> <none> topo-demo-6bbf65d967-hzhv2 1/1 Running 0 7m16s 10.244.0.143 master1 <none> <none> topo-demo-6bbf65d967-nvg4z 1/1 Running 0 7m16s 10.244.0.144 master1 <none> <none> topo-demo-6bbf65d967-w7w29 1/1 Running 0 7m16s 10.244.1.212 node1 <none> <none> \u53ef\u4ee5\u770b\u5230\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86 2 \u4e2a Pod \u526f\u672c\uff0c\u5982\u679c\u662f\u8981\u6c42\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c 3 \u4e2a Pod \u526f\u672c\u5462\uff1f\u5927\u5bb6\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u53bb\u7ec3\u4e60\u4e0b\u3002","title":"\u8bfe\u540e\u4e60\u9898"},{"location":"3.k8s/7.logging/promtail/","text":"Promtail \u00b6 Promtail \u00b6 Promtail \u662f Loki \u5b98\u65b9\u652f\u6301\u7684\u65e5\u5fd7\u91c7\u96c6\u7aef\uff0c\u5728\u9700\u8981\u91c7\u96c6\u65e5\u5fd7\u7684\u8282\u70b9\u4e0a\u8fd0\u884c\u91c7\u96c6\u4ee3\u7406\uff0c\u518d\u7edf\u4e00\u53d1\u9001\u5230 Loki \u8fdb\u884c\u5904\u7406\u3002\u9664\u4e86\u4f7f\u7528 Promtail\uff0c\u793e\u533a\u8fd8\u6709\u5f88\u591a\u91c7\u96c6\u65e5\u5fd7\u7684\u7ec4\u4ef6\uff0c\u6bd4\u5982 fluentd\u3001fluent bit\u3001logstash \u7b49\uff0c\u4e5f\u90fd\u652f\u6301\u53d1\u9001\u5230 Loki\u3002 \u4f46\u662f Promtail \u662f\u8fd0\u884c Kubernetes \u65f6\u7684\u9996\u9009\u5ba2\u6237\u7aef\uff0c\u56e0\u4e3a\u4f60\u53ef\u4ee5\u5c06\u5176\u914d\u7f6e\u4e3a\u81ea\u52a8\u4ece Promtail \u8fd0\u884c\u7684\u540c\u4e00\u8282\u70b9\u4e0a\u8fd0\u884c\u7684 Pod \u4e2d\u6293\u53d6\u65e5\u5fd7\u3002Promtail \u548c Prometheus \u5728 Kubernetes \u4e2d\u4e00\u8d77\u8fd0\u884c\uff0c\u8fd8\u53ef\u4ee5\u5b9e\u73b0\u975e\u5e38\u5f3a\u5927\u7684\u8c03\u8bd5\u529f\u80fd\uff0c\u5982\u679c Prometheus \u548c Promtail \u4f7f\u7528\u76f8\u540c\u7684\u6807\u7b7e\uff0c\u7528\u6237\u8fd8\u53ef\u4ee5\u4f7f\u7528 Grafana \u6839\u636e\u6807\u7b7e\u96c6\u5728\u6307\u6807\u548c\u65e5\u5fd7\u4e4b\u95f4\u5207\u6362\u3002 \u6b64\u5916\u5982\u679c\u4f60\u60f3\u4ece\u65e5\u5fd7\u4e2d\u63d0\u53d6\u6307\u6807\uff0c\u6bd4\u5982\u8ba1\u7b97\u67d0\u4e2a\u7279\u5b9a\u4fe1\u606f\u7684\u51fa\u73b0\u6b21\u6570\uff0cPromtail \u4e5f\u662f\u975e\u5e38\u53cb\u597d\u7684\u3002\u672c\u6587\u5c06\u4ecb\u7ecd Promtail \u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\u4ee5\u53ca\u4e86\u89e3\u4e0b\u5982\u4f55\u8bbe\u7f6e Promtail \u6765\u5904\u7406\u4f60\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff0c\u5305\u62ec\u63d0\u53d6\u6307\u6807\u4e0e\u6807\u7b7e\u7b49\u3002 \u914d\u7f6e \u00b6 Promtail \u662f\u8d1f\u8d23\u6536\u96c6\u65e5\u5fd7\u53d1\u9001\u7ed9 loki \u7684\u4ee3\u7406\u7a0b\u5e8f\u3002Promtail \u9ed8\u8ba4\u901a\u8fc7\u4e00\u4e2a config.yaml \u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\uff0c\u5176\u4e2d\u5305\u542b Promtail \u670d\u52a1\u7aef\u4fe1\u606f\u3001\u5b58\u50a8\u4f4d\u7f6e\u4ee5\u53ca\u5982\u4f55\u4ece\u6587\u4ef6\u4e2d\u6293\u53d6\u65e5\u5fd7\u7b49\u914d\u7f6e\u3002 \u8981\u6307\u5b9a\u52a0\u8f7d\u54ea\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u53ea\u9700\u8981\u5728\u547d\u4ee4\u884c\u4e0b\u901a\u8fc7 -config.file \u53c2\u6570\u4f20\u9012 YAML \u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u3002\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u73af\u5883\u53d8\u91cf\u5f15\u7528\u6765\u8bbe\u7f6e\u9700\u8981\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u9700\u8981\u5728\u547d\u4ee4\u884c\u4e2d\u914d\u7f6e -config.expand-env=true \u3002 \u7136\u540e\u53ef\u4ee5\u4f7f\u7528 ${VAR} \u6765\u914d\u7f6e\uff0c\u5176\u4e2d VAR \u662f\u73af\u5883\u53d8\u91cf\u7684\u540d\u79f0\uff0c\u6bcf\u4e2a\u53d8\u91cf\u7684\u5f15\u7528\u5728\u542f\u52a8\u65f6\u88ab\u73af\u5883\u53d8\u91cf\u7684\u503c\u66ff\u6362\uff0c\u66ff\u6362\u662f\u533a\u5206\u5927\u5c0f\u5199\u7684\uff0c\u800c\u4e14\u5728 YAML \u6587\u4ef6\u88ab\u89e3\u6790\u4e4b\u524d\u53d1\u751f\uff0c\u5bf9\u672a\u5b9a\u4e49\u53d8\u91cf\u7684\u5f15\u7528\u5c06\u88ab\u66ff\u6362\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u9664\u975e\u4f60\u6307\u5b9a\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u503c\u6216\u81ea\u5b9a\u4e49\u7684\u9519\u8bef\u6587\u672c\uff0c\u8981\u6307\u5b9a\u4e00\u4e2a\u9ed8\u8ba4\u503c\uff1a ${VAR:default_value} \u5176\u4e2d default_value \u662f\u5728\u73af\u5883\u53d8\u91cf\u672a\u5b9a\u4e49\u7684\u60c5\u51b5\u4e0b\u8981\u4f7f\u7528\u7684\u9ed8\u8ba4\u503c\u3002 \u9ed8\u8ba4\u7684 config.yaml \u914d\u7f6e\u6587\u4ef6\u652f\u6301\u7684\u5185\u5bb9\u683c\u5f0f\u4e3a\uff1a # \u914d\u7f6e Promtail \u670d\u52a1\u7aef [server: <server_config>] # \u63cf\u8ff0 Promtail \u5982\u4f55\u8fde\u63a5\u5230 Loki \u7684\u591a\u4e2a\u5b9e\u4f8b\uff0c\u5411\u6bcf\u4e2a\u5b9e\u4f8b\u53d1\u9001\u65e5\u5fd7\u3002 # \u53d1\u9001\u662f\u5728\u5355\u7ebf\u7a0b\u4e0a\u5b8c\u6210\u7684! # \u5982\u679c\u4f60\u60f3\u5411\u591a\u4e2a\u8fdc\u7a0b Loki \u5b9e\u4f8b\u53d1\u9001\uff0c\u4e00\u822c\u5efa\u8bae\u5e76\u884c\u8fd0\u884c\u591a\u4e2a promtail \u5ba2\u6237\u7aef\u3002 client: <client_config> # \u63cf\u8ff0\u4e86\u5982\u4f55\u5c06\u8bfb\u53d6\u7684\u6587\u4ef6\u504f\u79fb\u91cf\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a [positions: <position_config>] # \u6293\u53d6\u65e5\u5fd7\u914d\u7f6e scrape_configs: - [<scrape_config>] # \u914d\u7f6e\u88ab watch \u7684\u76ee\u6807\u5982\u4f55 tailed [target_config: <target_config>] server server \u5c5e\u6027\u914d\u7f6e Promtail \u4f5c\u4e3a HTTP \u670d\u52a1\u5668\u7684\u884c\u4e3a\u3002 # \u7981\u7528 HTTP \u548c GRPC \u670d\u52a1 [disable: <boolean> | default = false] # HTTP \u670d\u52a1\u76d1\u542c\u7684\u4e3b\u673a [http_listen_address: <string>] # HTTP \u670d\u52a1\u76d1\u542c\u7684\u7aef\u53e3\uff080\u8868\u793a\u968f\u673a\uff09 [http_listen_port: <int> | default = 80] # gRPC \u670d\u52a1\u76d1\u542c\u4e3b\u673a [grpc_listen_address: <string>] # gRPC \u670d\u52a1\u76d1\u542c\u7684\u7aef\u53e3\uff080\u8868\u793a\u968f\u673a\uff09 [grpc_listen_port: <int> | default = 9095] # \u6ce8\u518c\u6307\u6807\u5904\u7406\u5668 [register_instrumentation: <boolean> | default = true] # \u4f18\u96c5\u9000\u51fa\u8d85\u65f6\u65f6\u95f4 [graceful_shutdown_timeout: <duration> | default = 30s] # HTTP \u670d\u52a1\u8bfb\u53d6\u8d85\u65f6\u65f6\u95f4 [http_server_read_timeout: <duration> | default = 30s] # HTTP \u670d\u52a1\u5199\u5165\u8d85\u65f6\u65f6\u95f4 [http_server_write_timeout: <duration> | default = 30s] # HTTP \u670d\u52a1\u7a7a\u95f2\u8d85\u65f6\u65f6\u95f4 [http_server_idle_timeout: <duration> | default = 120s] # \u53ef\u63a5\u6536\u7684\u6700\u5927 gRPC \u6d88\u606f\u5927\u5c0f [grpc_server_max_recv_msg_size: <int> | default = 4194304] # \u53ef\u53d1\u9001\u7684\u6700\u5927 gRPC \u6d88\u606f\u5927\u5c0f [grpc_server_max_send_msg_size: <int> | default = 4194304] # \u5bf9 gRPC \u8c03\u7528\u7684\u5e76\u53d1\u6d41\u6570\u91cf\u7684\u9650\u5236 (0 = unlimited) [grpc_server_max_concurrent_streams: <int> | default = 100] # \u53ea\u8bb0\u5f55\u7ed9\u5b9a\u4e25\u91cd\u7a0b\u5ea6\u6216\u4ee5\u4e0a\u7684\u4fe1\u606f\uff0c\u652f\u6301\u7684\u503c\uff1a[debug, info, warn, error] [log_level: <string> | default = \"info\"] # \u6240\u6709 API \u8def\u7531\u670d\u52a1\u7684\u57fa\u672c\u8def\u5f84(e.g., /v1/). [http_path_prefix: <string>] # \u76ee\u6807\u7ba1\u7406\u5668\u68c0\u6d4b promtail \u53ef\u8bfb\u7684\u6807\u5fd7\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a false \u68c0\u67e5\u5c06\u88ab\u5ffd\u7565 [health_check_target: <bool> | default = true] client client \u5c5e\u6027\u914d\u7f6e Promtail \u5982\u4f55\u8fde\u63a5\u5230 Loki \u7684\u5b9e\u4f8b\u3002 # Loki \u6b63\u5728\u76d1\u542c\u7684 URL\uff0c\u5728 Loki \u4e2d\u8868\u793a\u4e3a http_listen_address \u548c http_listen_port # \u5982\u679c Loki \u5728\u5fae\u670d\u52a1\u6a21\u5f0f\u4e0b\u8fd0\u884c\uff0c\u8fd9\u5c31\u662f Distributor \u7684 URL\uff0c\u9700\u8981\u5305\u62ec push API \u7684\u8def\u5f84\u3002 # \u4f8b\u5982\uff1ahttp://example.com:3100/loki/api/v1/push url: <string> # \u9ed8\u8ba4\u4f7f\u7528\u7684\u79df\u6237 ID\uff0c\u7528\u4e8e\u63a8\u9001\u65e5\u5fd7\u5230 Loki\u3002 # \u5982\u679c\u7701\u7565\u6216\u4e3a\u7a7a\uff0c\u5219\u4f1a\u5047\u8bbe Loki \u5728\u5355\u79df\u6237\u6a21\u5f0f\u4e0b\u8fd0\u884c\uff0c\u4e0d\u53d1\u9001 X-Scope-OrgID \u5934\u3002 [tenant_id: <string>] # \u53d1\u9001\u4e00\u6279\u65e5\u5fd7\u524d\u7684\u6700\u5927\u7b49\u5f85\u65f6\u95f4\uff0c\u5373\u4f7f\u8be5\u6279\u6b21\u65e5\u5fd7\u6570\u636e\u672a\u6ee1\u3002 [batchwait: <duration> | default = 1s] # \u5728\u5411 Loki \u53d1\u9001\u6279\u5904\u7406\u4e4b\u524d\u8981\u79ef\u7d2f\u7684\u6700\u5927\u6279\u5904\u7406\u91cf\uff08\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\uff09\u3002 [batchsize: <int> | default = 102400] # \u5982\u679c\u4f7f\u7528\u4e86 basic auth \u8ba4\u8bc1\uff0c\u5219\u9700\u8981\u914d\u7f6e\u7528\u6237\u540d\u548c\u5bc6\u7801 basic_auth: [username: <string>] [password: <string>] # \u5305\u542bbasic auth\u8ba4\u8bc1\u7684\u5bc6\u7801\u6587\u4ef6 [password_file: <filename>] # \u53d1\u9001\u7ed9\u670d\u52a1\u5668\u7684 Bearer token [bearer_token: <secret>] # \u5305\u542b Bearer token \u7684\u6587\u4ef6 [bearer_token_file: <filename>] # \u7528\u6765\u8fde\u63a5\u670d\u52a1\u5668\u7684 HTTP \u4ee3\u7406\u670d\u52a1\u5668 [proxy_url: <string>] # \u5982\u679c\u8fde\u63a5\u5230\u4e00\u4e2a TLS \u670d\u52a1\u5668\uff0c\u914d\u7f6e TLS \u8ba4\u8bc1\u65b9\u5f0f\u3002 tls_config: # \u7528\u6765\u9a8c\u8bc1\u670d\u52a1\u5668\u7684 CA \u6587\u4ef6 [ca_file: <string>] # \u53d1\u9001\u7ed9\u670d\u52a1\u5668\u7528\u4e8e\u5ba2\u6237\u7aef\u8ba4\u8bc1\u7684 cert \u6587\u4ef6 [cert_file: <filename>] # \u53d1\u9001\u7ed9\u670d\u52a1\u5668\u7528\u4e8e\u5ba2\u6237\u7aef\u8ba4\u8bc1\u7684\u5bc6\u94a5\u6587\u4ef6 [key_file: <filename>] # \u9a8c\u8bc1\u670d\u52a1\u5668\u8bc1\u4e66\u4e2d\u7684\u670d\u52a1\u5668\u540d\u79f0\u662f\u8fd9\u4e2a\u503c\u3002 [server_name: <string>] # \u5982\u679c\u4e3a true\uff0c\u5219\u5ffd\u7565\u7531\u672a\u77e5 CA \u7b7e\u7f72\u7684\u670d\u52a1\u5668\u8bc1\u4e66\u3002 [insecure_skip_verify: <boolean> | default = false] # \u914d\u7f6e\u5728\u8bf7\u6c42\u5931\u8d25\u65f6\u5982\u4f55\u91cd\u8bd5\u5bf9 Loki \u7684\u8bf7\u6c42\u3002 # \u9ed8\u8ba4\u7684\u56de\u9000\u5468\u671f\u4e3a\uff1a0.5s, 1s, 2s, 4s, 8s, 16s, 32s, 64s, 128s, 256s(4.267m) # \u5728\u65e5\u5fd7\u4e22\u5931\u4e4b\u524d\u7684\u603b\u65f6\u95f4\u4e3a511.5s(8.5m) backoff_config: # \u91cd\u8bd5\u4e4b\u95f4\u7684\u521d\u59cb\u56de\u9000\u65f6\u95f4 [min_period: <duration> | default = 500ms] # \u91cd\u8bd5\u4e4b\u95f4\u7684\u6700\u5927\u56de\u9000\u65f6\u95f4 [max_period: <duration> | default = 5m] # \u91cd\u8bd5\u7684\u6700\u5927\u6b21\u6570 [max_retries: <int> | default = 10] # \u6dfb\u52a0\u5230\u6240\u6709\u53d1\u9001\u5230 Loki \u7684\u65e5\u5fd7\u4e2d\u7684\u5916\u90e8\u6807\u7b7e # \u4f7f\u7528\u4e00\u4e2a\u7c7b\u4f3c\u4e8e {\"foo\": \"bar\"} \u7684\u6620\u5c04\u6765\u6dfb\u52a0\u4e00\u4e2a foo \u6807\u7b7e\uff0c\u503c\u4e3a bar # \u8fd9\u4e9b\u4e5f\u53ef\u4ee5\u4ece\u547d\u4ee4\u884c\u4e2d\u6307\u5b9a\uff1a-client.external-labels=k1=v1,k2=v2 # \u7531\u547d\u4ee4\u884c\u63d0\u4f9b\u7684\u6807\u7b7e\u5c06\u5e94\u7528\u4e8e\u6240\u6709\u5728 \"clients\" \u90e8\u5206\u7684\u914d\u7f6e\u3002 # \u6ce8\u610f\uff1a\u5982\u679c\u6807\u7b7e\u7684\u952e\u76f8\u540c\uff0c\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u503c\u5c06\u53d6\u4ee3\u547d\u4ee4\u884c\u4e2d\u4e3a\u7279\u5b9a client \u5b9a\u4e49\u7684\u503c external_labels: [ <labelname>: <labelvalue> ... ] # \u7b49\u5f85\u670d\u52a1\u5668\u54cd\u5e94\u4e00\u4e2a\u8bf7\u6c42\u7684\u6700\u957f\u65f6\u95f4 [timeout: <duration> | default = 10s] positions positions \u5c5e\u6027\u914d\u7f6e\u4e86 Promtail \u4fdd\u5b58\u6587\u4ef6\u7684\u4f4d\u7f6e\uff0c\u8868\u793a\u5b83\u5df2\u7ecf\u8bfb\u5230\u4e86\u65e5\u5fd7\u6587\u4ef6\u7684\u4ec0\u4e48\u4f4d\u7f6e\u3002\u5f53 Promtail \u91cd\u65b0\u542f\u52a8\u65f6\u9700\u8981\u5b83\uff0c\u4ee5\u5141\u8bb8\u5b83\u4ece\u4e2d\u65ad\u7684\u5730\u65b9\u7ee7\u7eed\u8bfb\u53d6\u65e5\u5fd7\u3002 # positions \u6587\u4ef6\u7684\u8def\u5f84 [filename: <string> | default = \"/var/log/positions.yaml\"] # \u66f4\u65b0 positions \u6587\u4ef6\u7684\u5468\u671f [sync_period: <duration> | default = 10s] # \u662f\u5426\u5ffd\u7565\u5e76\u8986\u76d6\u88ab\u7834\u574f\u7684 positions \u6587\u4ef6 [ignore_invalid_yaml: <boolean> | default = false] scrape_configs scrape_configs \u914d\u7f6e\u4e86 Promtail \u5982\u4f55\u4f7f\u7528\u6307\u5b9a\u7684\u53d1\u73b0\u65b9\u6cd5\u4ece\u4e00\u7cfb\u5217\u76ee\u6807\u4e2d\u6293\u53d6\u65e5\u5fd7\uff0c\u7c7b\u4f3c\u4e8e Prometheus \u4e2d\u7684\u6293\u53d6\u914d\u7f6e\u3002 # \u4efb\u52a1\u540d\u79f0\uff0c\u7528\u4e8e\u5728 Promtail \u4e2d\u8bc6\u522b\u8be5\u6293\u53d6\u914d\u7f6e\u7684\u540d\u79f0\u3002 job_name: <string> # \u63cf\u8ff0\u5982\u4f55\u5bf9\u76ee\u6807\u65e5\u5fd7\u8fdb\u884c\u7ed3\u6784\u5316 [pipeline_stages: <pipeline_stages>] # \u5982\u4f55\u4ece jounal \u6293\u53d6\u65e5\u5fd7 [journal: <journal_config>] # \u5982\u4f55\u4ece syslog \u6293\u53d6\u65e5\u5fd7 [syslog: <syslog_config>] # \u5982\u4f55\u901a\u8fc7 Loki push API \u63a5\u6536\u65e5\u5fd7 (\u4f8b\u5982\u4ece\u5176\u4ed6 Promtail \u6216 Docker Logging Driver \u4e2d\u83b7\u53d6\u7684\u6570\u636e) [loki_push_api: <loki_push_api_config>] # \u63cf\u8ff0\u4e86\u5982\u4f55 relabel \u76ee\u6807 relabel_configs: - [<relabel_config>] # \u6293\u53d6\u65e5\u5fd7\u9759\u6001\u76ee\u6807\u914d\u7f6e static_configs: - [<static_config>] # \u5305\u542b\u8981\u6293\u53d6\u7684\u76ee\u6807\u6587\u4ef6 file_sd_configs: - [<file_sd_configs>] # \u57fa\u4e8ekubernetes\u7684\u81ea\u52a8\u53d1\u73b0\u914d\u7f6e kubernetes_sd_configs: - [<kubernetes_sd_config>] pipeline_stages pipeline_stages \u7528\u4e8e\u8f6c\u6362\u65e5\u5fd7\u548c\u5b83\u4eec\u7684\u6807\u7b7e\uff0c\u8be5\u7ba1\u9053\u5728\u53d1\u73b0\u64cd\u4f5c\u7ed3\u675f\u540e\u6267\u884c\uff0c pipeline_stages \u5bf9\u8c61\u7531\u4e00\u4e2a\u9636\u6bb5\u5217\u8868\u7ec4\u6210\u3002 - [ <docker> | <cri> | <regex> | <json> | <template> | <match> | <timestamp> | <output> | <labels> | <metrics> | <tenant>, ] \u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4f60\u7528 regex \u6216 json \u9636\u6bb5\u4ece\u65e5\u5fd7\u4e2d\u63d0\u53d6\u6570\u636e\uff0c\u63d0\u53d6\u7684\u6570\u636e\u88ab\u8f6c\u5316\u4e3a\u4e00\u4e2a\u4e34\u65f6\u7684\u5b57\u5178 Map \u5bf9\u8c61\uff0c\u7136\u540e\u8fd9\u4e9b\u6570\u636e\u662f\u53ef\u4ee5\u88ab promtail \u4f7f\u7528\u7684\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f5c\u4e3a\u6807\u7b7e\u7684\u503c\u6216\u4f5c\u4e3a\u8f93\u51fa\u3002\u6b64\u5916\uff0c\u9664\u4e86 docker \u548c cri \u4e4b\u5916\uff0c\u4efb\u4f55\u5176\u4ed6\u9636\u6bb5\u90fd\u53ef\u4ee5\u8bbf\u95ee\u63d0\u53d6\u7684\u6570\u636e\u3002 loki_push_api loki_push_api \u5c5e\u6027\u914d\u7f6e Promtail \u6765\u66b4\u9732\u4e00\u4e2a Loki push API \u670d\u52a1 \uff0c\u6bcf\u4e2a\u914d\u7f6e\u4e86 loki_push_api \u7684\u4efb\u52a1\u90fd\u4f1a\u66b4\u9732\u8fd9\u4e2a API\uff0c\u5e76\u4e14\u9700\u8981\u4e00\u4e2a\u5355\u72ec\u7684\u7aef\u53e3\u3002 # push \u670d\u52a1\u914d\u7f6e\u9009\u9879 [server: <server_config>] # \u6807\u7b7e\u6620\u5c04\uff0c\u7528\u4e8e\u6dfb\u52a0\u5230\u53d1\u9001\u5230 push API \u7684\u6bcf\u4e00\u884c\u65e5\u5fd7\u4e0a labels: [ <labelname>: <labelvalue> ... ] # promtail \u662f\u5426\u5e94\u8be5\u4ece\u4f20\u5165\u7684\u65e5\u5fd7\u4e2d\u83b7\u53d6\u65f6\u95f4\u6233 # \u5f53\u4e3a false \u65f6\uff0cpromtail \u5c06\u628a\u5f53\u524d\u7684\u65f6\u95f4\u6233\u5206\u914d\u7ed9\u65e5\u5fd7 [use_incoming_timestamp: <bool> | default = false] \u6bd4\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\uff0c\u5c06 Promtail \u4f5c\u4e3a\u4e00\u4e2a Push \u63a5\u6536\u5668\u542f\u52a8\uff0c\u5e76\u5c06\u63a5\u53d7\u6765\u81ea\u5176\u4ed6 Promtail \u5b9e\u4f8b\u6216 Docker Logging Driver \u7684\u65e5\u5fd7\u3002 server: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml clients: - url: http://<loki url>:3100/loki/api/v1/push scrape_configs: - job_name: push1 loki_push_api: server: http_listen_port: 3500 grpc_listen_port: 3600 labels: pushserver: push1 \u6ce8\u610f\u5fc5\u987b\u63d0\u4f9b job_name \uff0c\u5e76\u4e14\u5728\u591a\u4e2a loki_push_api \u4e0e scrape_configs \u4e4b\u95f4\u5fc5\u987b\u662f\u552f\u4e00\u7684\uff0c\u5b83\u5c06\u88ab\u7528\u6765\u6ce8\u518c\u76d1\u63a7\u6307\u6807\u3002\u7531\u4e8e\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u5b9e\u4f8b\u88ab\u521b\u5efa\uff0c\u6240\u4ee5 http_listen_port \u548c grpc_listen_port \u5fc5\u987b\u4e0e promtail \u670d\u52a1\u5668\u914d\u7f6e\u90e8\u5206\u4e0d\u540c\uff08\u9664\u975e\u5b83\u88ab\u7981\u7528\uff09\u3002 relabel_configs Relabeling \u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u53ef\u4ee5\u5728\u65e5\u5fd7\u88ab\u6293\u53d6\u4e4b\u524d\u52a8\u6001\u5730\u91cd\u5199\u5176\u6807\u7b7e\u96c6\u3002\u6bcf\u4e2a\u6293\u53d6\u914d\u7f6e\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a relabeling \u6b65\u9aa4\uff0c\u6309\u7167\u5b83\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u51fa\u73b0\u7684\u987a\u5e8f\u5e94\u7528\u4e8e\u6bcf\u4e2a\u76ee\u6807\u7684\u6807\u7b7e\u96c6\u3002\u548c Prometheus \u4e2d\u7684 Relabel \u64cd\u4f5c\u4e5f\u975e\u5e38\u7c7b\u4f3c\u3002 \u5728 relabeling \u4e4b\u540e\uff0c\u5982\u679c instance \u6807\u7b7e\u5728 relabeling \u7684\u65f6\u5019\u6ca1\u6709\u88ab\u8bbe\u7f6e\uff0c\u5219\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a __address__ \u7684\u503c\u3002 __param_<name> \u6807\u7b7e\u88ab\u8bbe\u7f6e\u4e3a\u7b2c\u4e00\u4e2a\u4f20\u9012\u7684 URL \u53c2\u6570 <name> \u7684\u503c\u3002 \u5728 relabeling \u9636\u6bb5\uff0c\u4ee5 __meta_ \u4e3a\u524d\u7f00\u7684\u989d\u5916\u6807\u7b7e\u4e5f\u662f\u53ef\u7528\u7684\uff0c\u5b83\u4eec\u662f\u7531\u63d0\u4f9b\u76ee\u6807\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\u8bbe\u7f6e\u7684\uff0c\u4e0d\u540c\u7684\u673a\u5236\u4e4b\u95f4\u6709\u6240\u4e0d\u540c\u3002 \u5728\u76ee\u6807 relabeling \u5b8c\u6210\u540e\uff0c\u4ee5 __ \u5f00\u5934\u7684\u6807\u7b7e\u5c06\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u3002 \u5982\u679c\u4e00\u4e2a relabeling \u64cd\u4f5c\u53ea\u9700\u8981\u4e34\u65f6\u5b58\u50a8\u4e00\u4e2a\u6807\u7b7e\u503c\uff08\u4f5c\u4e3a\u540e\u7eed\u91cd\u65b0\u6807\u6ce8\u6b65\u9aa4\u7684\u8f93\u5165\uff09\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 __tmp \u6807\u7b7e\u540d\u79f0\u524d\u7f00\u3002 # \u4ece\u73b0\u6709\u6807\u7b7e\u4e2d\u9009\u62e9 values \u503c\u7684\u6e90\u6807\u7b7e # \u5b83\u4eec\u7684\u5185\u5bb9\u4f7f\u7528\u914d\u7f6e\u7684\u5206\u9694\u7b26\u8fde\u63a5\u8d77\u6765\uff0c\u5e76\u4e0e\u914d\u7f6e\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u76f8\u5339\u914d\uff0c\u4ee5\u8fdb\u884c\u66ff\u6362\u3001\u4fdd\u7559\u548c\u5220\u9664\u64cd\u4f5c\u3002 [ source_labels: '[' <labelname> [, ...] ']' ] # \u8fde\u63a5\u6e90\u6807\u7b7e\u503c\u4e4b\u95f4\u7684\u5206\u9694\u7b26 [ separator: <string> | default = ; ] # \u5728\u4e00\u4e2a replace \u66ff\u6362\u64cd\u4f5c\u540e\u7ed3\u679c\u503c\u88ab\u5199\u5165\u7684\u6807\u7b7e # \u5b83\u5bf9\u66ff\u6362\u52a8\u4f5c\u662f\u5f3a\u5236\u6027\u7684\uff0cRegex \u6355\u83b7\u7ec4\u662f\u53ef\u7528\u7684\u3002 [ target_label: <labelname> ] # \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u63d0\u53d6\u7684\u503c\u4e0e\u4e4b\u5339\u914d [ regex: <regex> | default = (.*) ] [ modulus: <uint64> ] # Replacement \u503c\uff1a\u5982\u679c\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\uff0c\u5219\u5bf9\u5176\u8fdb\u884c regex \u66ff\u6362 [ replacement: <string> | default = $1 ] # \u6839\u636e\u6b63\u5219\u5339\u914d\u7ed3\u679c\u6267\u884c\u7684\u52a8\u4f5c [ action: <relabel_action> | default = replace ] <regex> \u662f\u4efb\u4f55\u6709\u6548\u7684 RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5b83\u662f replace \u3001 keep \u3001 drop \u3001 labelmap \u3001 labeldrop \u548c labelkeep \u64cd\u4f5c\u7684\u5fc5\u8981\u6761\u4ef6\u3002 <relabel_action> \u51b3\u5b9a\u4e86\u8981\u91c7\u53d6\u7684 relabeling \u52a8\u4f5c\uff1a replace \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u8fde\u63a5\u7684 source_labels \u5339\u914d\uff0c\u7136\u540e\u8bbe\u7f6e target_label \u4e3a replacement \uff0c\u7528 replacement \u4e2d\u7684\u5339\u914d\u7ec4\u5f15\u7528\uff08${1}\u3001${2}\u2026\uff09\u66ff\u6362\u5176\u503c\uff0c\u5982\u679c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d\uff0c\u5219\u4e0d\u4f1a\u8fdb\u884c\u66ff\u6362\u3002 keep \uff1a\u5220\u9664\u90a3\u4e9b regex \u4e0e source_labels \u4e0d\u5339\u914d\u7684\u76ee\u6807\u3002 drop \uff1a\u5220\u9664\u4e0e regex \u76f8\u5339\u914d\u7684 source_labels \u76ee\u6807\u3002 hashmod \uff1a\u5c06 target_label \u8bbe\u7f6e\u4e3a source_labels \u7684\u54c8\u5e0c\u503c\u7684\u6a21\u3002 labelmap \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u79f0\u5339\u914d\uff0c\u7136\u540e\u5c06\u5339\u914d\u7684\u6807\u7b7e\u503c\u590d\u5236\u5230\u7531 replacement \u7ed9\u51fa\u7684\u6807\u7b7e\u540d\u4e2d\uff0creplacement \u4e2d\u7684\u5339\u914d\u7ec4\u5f15\u7528\uff08${1}, ${2}, ...\uff09\u7531\u5176\u503c\u4ee3\u66ff\u3002 labeldrop \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u79f0\u5339\u914d\uff0c\u4efb\u4f55\u5339\u914d\u7684\u6807\u7b7e\u90fd\u5c06\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u3002 labelkeep \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u79f0\u5339\u914d\uff0c\u4efb\u4f55\u4e0d\u5339\u914d\u7684\u6807\u7b7e\u5c06\u88ab\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u3002 static_configs static_configs \u9759\u6001\u914d\u7f6e\u5141\u8bb8\u6307\u5b9a\u4e00\u4e2a\u76ee\u6807\u5217\u8868\u548c\u6807\u7b7e\u96c6\uff1a # \u914d\u7f6e\u53d1\u73b0\u5728\u5f53\u524d\u8282\u70b9\u4e0a\u67e5\u627e\uff0c\u8fd9\u662f Prometheus \u6240\u8981\u6c42\u7684\uff0c\u4f46\u5e76\u4e0d\u9002\u7528\u4e8e Promtail\uff0c\u5b83\u53ea\u80fd\u67e5\u770b\u672c\u5730\u673a\u5668\u4e0a\u7684\u6587\u4ef6\u3002 # \u56e0\u6b64\uff0c\u5b83\u5e94\u8be5\u53ea\u6709 localhost \u7684\u503c\uff0c\u6216\u8005\u4e0d\u6307\u5b9a\uff0cPromtail \u4f1a\u4f7f\u7528 localhost \u7684\u9ed8\u8ba4\u503c\u3002 targets: - localhost # \u5b9a\u4e49\u4e00\u4e2a\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6587\u4ef6\u548c\u4e00\u7ec4\u53ef\u9009\u7684\u9644\u52a0\u6807\u7b7e\uff0c\u5e94\u7528\u4e8e\u7531 __path__ \u5b9a\u4e49\u7684\u6587\u4ef6\u65e5\u5fd7\u6d41\u3002 labels: # \u8981\u52a0\u8f7d\u65e5\u5fd7\u7684\u8def\u5f84\uff0c\u53ef\u4ee5\u4f7f\u7528 glob \u6a21\u5f0f(e.g., /var/log/*.log). __path__: <string> # \u6dfb\u52a0\u7684\u989d\u5916\u6807\u7b7e [ <labelname>: <labelvalue> ... ] \u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u9759\u6001\u914d\u7f6e\uff1a server: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /var/log/positions.yaml # \u8fd9\u4e2a\u4f4d\u7f6e\u9700\u8981\u662f\u53ef\u4ee5\u88ab promtail \u5199\u5165\u7684 client: url: http://<loki url>:3100/loki/api/v1/push # \u6293\u53d6\u914d\u7f6e scrape_configs: - job_name: system pipeline_stages: static_configs: - targets: - localhost labels: job: varlogs # \u5728 Prometheus\u4e2d\uff0cjob \u6807\u7b7e\u5bf9\u4e8e\u8fde\u63a5\u6307\u6807\u548c\u65e5\u5fd7\u5f88\u6709\u7528 host: yourhost # `host` \u6807\u7b7e\u53ef\u4ee5\u5e2e\u52a9\u8bc6\u522b\u65e5\u5fd7\u6765\u6e90 __path__: /var/log/*.log # \u8def\u5f84\u5339\u914d\u4f7f\u7528\u4e86\u4e00\u4e2a\u7b2c\u4e09\u65b9\u5e93: https://github.com/bmatcuk/doublestar file_sd_config \u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u63d0\u4f9b\u4e86\u4e00\u79cd\u66f4\u901a\u7528\u7684\u65b9\u5f0f\u6765\u914d\u7f6e\u9759\u6001\u76ee\u6807\u3002\u5b83\u8bfb\u53d6\u4e00\u7ec4\u5305\u542b\u96f6\u4e2a\u6216\u591a\u4e2a <static_config> \u5217\u8868\u7684\u6587\u4ef6\u3002\u5bf9\u6240\u6709\u5b9a\u4e49\u6587\u4ef6\u7684\u6539\u53d8\u901a\u8fc7\u76d1\u89c6\u78c1\u76d8\u53d8\u5316\u6765\u5e94\u7528\u3002\u6587\u4ef6\u53ef\u4ee5\u4ee5 YAML \u6216 JSON \u683c\u5f0f\u63d0\u4f9b\uff0cJSON \u6587\u4ef6\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u9759\u6001\u914d\u7f6e\u7684\u5217\u8868\uff0c\u4f7f\u7528\u8fd9\u79cd\u683c\u5f0f\u3002 [ { \"targets\": [ \"localhost\" ], \"labels\": { \"__path__\": \"<string>\", ... \"<labelname>\": \"<labelvalue>\", ... } }, ... ] \u6b64\u5916\u6587\u4ef6\u5185\u5bb9\u4e5f\u5c06\u4ee5\u6307\u5b9a\u7684\u5237\u65b0\u95f4\u9694\u5b9a\u671f\u91cd\u65b0\u8bfb\u53d6\u3002\u5728 relabeling \u6807\u8bb0\u9636\u6bb5\uff0c\u6bcf\u4e2a\u76ee\u6807\u90fd\u6709\u4e00\u4e2a\u5143\u6807\u7b7e __meta_filepath \uff0c\u5b83\u7684\u503c\u88ab\u8bbe\u7f6e\u4e3a\u88ab\u63d0\u53d6\u7684\u76ee\u6807\u6587\u4ef6\u8def\u5f84\u3002 # \u4ece\u4e2d\u63d0\u53d6\u76ee\u6807\u6587\u4ef6\u7684\u6a21\u5f0f\u3002 files: [ - <filename_pattern> ... ] # \u91cd\u65b0\u8bfb\u53d6\u6587\u4ef6\u7684\u5237\u65b0\u9891\u7387 [ refresh_interval: <duration> | default = 5m ] \u5176\u4e2d <filename_pattern> \u53ef\u4ee5\u662f\u4e00\u4e2a\u4ee5 .json \u3001 .yml \u6216 .yaml \u7ed3\u5c3e\u7684\u8def\u5f84\uff0c\u6700\u540e\u4e00\u4e2a\u8def\u5f84\u6bb5\u53ef\u4ee5\u5305\u542b\u4e00\u4e2a\u5339\u914d\u4efb\u4f55\u5b57\u7b26\u5e8f\u5217\u7684 * \uff0c\u4f8b\u5982 my/path/tg_*.json \u3002 kubernetes_sd_config \u8be5\u53d1\u73b0\u65b9\u5f0f\u5141\u8bb8\u4ece Kubernetes \u7684 REST API \u4e2d\u83b7\u53d6\u6293\u53d6\u7684\u76ee\u6807\uff0c\u5e76\u59cb\u7ec8\u4e0e\u96c6\u7fa4\u72b6\u6001\u4fdd\u6301\u540c\u6b65\u3002\u5173\u4e8e Kubernetes \u53d1\u73b0\u7684\u914d\u7f6e\u9009\u9879\uff0c\u5982\u4e0b\u6240\u793a\uff1a # Kubernetes API \u5730\u5740 # \u5982\u679c\u7559\u7a7a\uff0cPrometheus \u5c06\u88ab\u5047\u5b9a\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\uff0c\u5e76\u5c06\u81ea\u52a8\u53d1\u73b0 API \u670d\u52a1\u5668\u5e76\u4f7f\u7528 pod \u7684 CA \u8bc1\u4e66\u548c bearer token \u6587\u4ef6\uff08\u5728 /var/run/secrets/kubernetes.io/serviceaccount/ \u76ee\u5f55\u4e0b\u9762\uff09 [ api_server: <host> ] # \u53d1\u73b0\u7684 Kubernetes \u89d2\u8272 role: <role> # \u53ef\u9009\u7684\u8ba4\u8bc1\u4fe1\u606f basic_auth: [ username: <string> ] [ password: <secret> ] [ password_file: <string> ] [ bearer_token: <secret> ] [ bearer_token_file: <filename> ] [ proxy_url: <string> ] # TLS \u914d\u7f6e tls_config: [ <tls_config> ] # \u53ef\u9009\u7684\u547d\u540d\u7a7a\u95f4\u53d1\u73b0\uff0c\u5982\u679c\u7701\u7565\uff0c\u5c06\u4f7f\u7528\u6240\u6709\u547d\u540d\u7a7a\u95f4\u3002 namespaces: names: [ - <string> ] \u5176\u4e2d <role> \u5fc5\u987b\u662f endpoints \u3001 service \u3001 pod \u3001 node \u6216 ingress \u3002\u5177\u4f53\u7684\u914d\u7f6e\u4f7f\u7528\u53ef\u4ee5\u5b8c\u5168\u53c2\u8003 Prometheus \u4e2d\u7684\u57fa\u4e8e Kubernetes \u7684\u53d1\u73b0\u673a\u5236\uff0c\u53ef\u4ee5\u67e5\u770b Prometheus \u81ea\u52a8\u53d1\u73b0\u914d\u7f6e\u6587\u4ef6\uff1a https://github.com/prometheus/prometheus/blob/main/documentation/examples/prometheus-kubernetes.yml \u4e86\u89e3\u66f4\u591a\u914d\u7f6e\u3002 pipeline \u00b6 \u5728 Promtail \u4e2d\u4e00\u4e2a pipeline \u7ba1\u9053\u88ab\u7528\u6765\u8f6c\u6362\u4e00\u4e2a\u5355\u4e00\u7684\u65e5\u5fd7\u884c\u3001\u6807\u7b7e\u548c\u65f6\u95f4\u6233\u3002\u4e00\u4e2a pipeline \u7ba1\u9053\u662f\u7531\u4e00\u7ec4 stages \u9636\u6bb5\u7ec4\u6210\u7684\uff0c\u5728 Promtail \u914d\u7f6e\u4e2d\u4e00\u5171\u6709 4 \u79cd\u7c7b\u578b\u7684 stages\u3002 Parsing stages (\u89e3\u6790\u9636\u6bb5) \u7528\u4e8e\u89e3\u6790\u5f53\u524d\u7684\u65e5\u5fd7\u884c\u5e76\u4ece\u4e2d\u63d0\u53d6\u6570\u636e\uff0c\u63d0\u53d6\u7684\u6570\u636e\u53ef\u4f9b\u5176\u4ed6\u9636\u6bb5\u4f7f\u7528\u3002 Transform stages (\u8f6c\u6362\u9636\u6bb5) \u7528\u4e8e\u5bf9\u4e4b\u524d\u9636\u6bb5\u63d0\u53d6\u7684\u6570\u636e\u8fdb\u884c\u8f6c\u6362\u3002 Action stages (\u5904\u7406\u9636\u6bb5) \u7528\u4e8e\u4ece\u4ee5\u524d\u9636\u6bb5\u4e2d\u63d0\u53d6\u6570\u636e\u5e76\u5bf9\u5176\u8fdb\u884c\u5904\u7406\uff0c\u5305\u62ec\uff1a \u6dfb\u52a0\u6216\u4fee\u6539\u73b0\u6709\u65e5\u5fd7\u884c\u6807\u7b7e \u66f4\u6539\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233 \u4fee\u6539\u65e5\u5fd7\u884c\u5185\u5bb9 \u5728\u63d0\u53d6\u7684\u6570\u636e\u57fa\u7840\u4e0a\u521b\u5efa\u4e00\u4e2a metrics \u6307\u6807 Filtering stages (\u8fc7\u6ee4\u9636\u6bb5) \u53ef\u9009\u62e9\u5e94\u7528\u4e00\u4e2a\u9636\u6bb5\u7684\u5b50\u96c6\uff0c\u6216\u6839\u636e\u4e00\u4e9b\u6761\u4ef6\u5220\u9664\u65e5\u5fd7\u6570\u636e\u3002 \u4e00\u4e2a\u5178\u578b\u7684 pipeline \u5c06\u4ece\u89e3\u6790\u9636\u6bb5\u5f00\u59cb\uff08\u5982 regex \u6216 json \u9636\u6bb5\uff09\u4ece\u65e5\u5fd7\u884c\u4e2d\u63d0\u53d6\u6570\u636e\u3002\u7136\u540e\u6709\u4e00\u7cfb\u5217\u7684\u5904\u7406\u9636\u6bb5\u914d\u7f6e\uff0c\u5bf9\u63d0\u53d6\u7684\u6570\u636e\u8fdb\u884c\u5904\u7406\u3002\u6700\u5e38\u89c1\u7684\u5904\u7406\u9636\u6bb5\u662f\u4e00\u4e2a labels stage \u6807\u7b7e\u9636\u6bb5\uff0c\u5c06\u63d0\u53d6\u7684\u6570\u636e\u8f6c\u5316\u4e3a\u6807\u7b7e\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\u73b0\u5728 pipeline \u4e0d\u80fd\u7528\u4e8e\u91cd\u590d\u7684\u65e5\u5fd7\uff0c\u4f8b\u5982\uff0cLoki \u5c06\u591a\u6b21\u6536\u5230\u540c\u4e00\u6761\u65e5\u5fd7\u884c\uff1a \u4ece\u540c\u4e00\u6587\u4ef6\u4e2d\u8bfb\u53d6\u7684\u4e24\u4e2a\u6293\u53d6\u914d\u7f6e \u6587\u4ef6\u4e2d\u91cd\u590d\u7684\u65e5\u5fd7\u884c\u88ab\u53d1\u9001\u5230\u4e00\u4e2a pipeline\uff0c\u4e0d\u4f1a\u505a\u91cd\u590d\u6570\u636e\u5220\u9664 \u7136\u540e\uff0cLoki \u4f1a\u5728\u67e5\u8be2\u65f6\u5bf9\u90a3\u4e9b\u5177\u6709\u5b8c\u5168\u76f8\u540c\u7684\u7eb3\u79d2\u65f6\u95f4\u6233\u3001\u6807\u7b7e\u4e0e\u65e5\u5fd7\u5185\u5bb9\u7684\u65e5\u5fd7\u8fdb\u884c\u4e00\u4e9b\u91cd\u590d\u6570\u636e\u5220\u9664\u3002 \u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\u53ef\u4ee5\u5f88\u597d\u5730\u8bf4\u660e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 pipeline \u6765\u5bf9\u65e5\u5fd7\u884c\u6570\u636e\u5b9e\u73b0\u4ec0\u4e48\u529f\u80fd\uff1a scrape_configs: - job_name: kubernetes-pods-name kubernetes_sd_configs: .... pipeline_stages: # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u88ab\u6293\u53d6\u76ee\u6807\u6709\u4e00\u4e2a\u6807\u7b7e\u540d\u4e3a name \u4e14\u503c\u4e3a promtail \u5730\u65f6\u5019\u624d\u4f1a\u6267\u884c - match: selector: '{name=\"promtail\"}' stages: # regex \u9636\u6bb5\u89e3\u6790\u51fa\u4e00\u4e2a level\u3001timestamp \u4e0e component\uff0c\u5728\u8be5\u9636\u6bb5\u7ed3\u675f\u65f6\uff0c\u8fd9\u51e0\u4e2a\u503c\u53ea\u4e3a pipeline \u5185\u90e8\u8bbe\u7f6e\uff0c\u5728\u4ee5\u540e\u5730\u9636\u6bb5\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u503c\u5e76\u51b3\u5b9a\u5982\u4f55\u5904\u7406\u4ed6\u4eec\u3002 - regex: expression: '.*level=(?P<level>[a-zA-Z]+).*ts=(?P<timestamp>[T\\d-:.Z]*).*component=(?P<component>[a-zA-Z]+)' # labels \u9636\u6bb5\u4ece\u524d\u9762 regex \u9636\u6bb5\u83b7\u53d6 level\u3001component \u503c\uff0c\u5e76\u5c06\u4ed6\u4eec\u53d8\u6210\u4e00\u4e2a\u6807\u7b7e\uff0c\u6bd4\u5982 level=error \u53ef\u80fd\u5c31\u662f\u8fd9\u4e2a\u9636\u6bb5\u6dfb\u52a0\u7684\u4e00\u4e2a\u6807\u7b7e\u3002 - labels: level: component: # \u6700\u540e\uff0c\u65f6\u95f4\u6233\u9636\u6bb5\u91c7\u7528\u4ece regex \u63d0\u53d6\u5730 timestamp\uff0c\u5e76\u5c06\u5176\u53d8\u6210\u65e5\u5fd7\u7684\u65b0\u65f6\u95f4\u6233\uff0c\u5e76\u89e3\u6790\u4e3a RFC3339Nano \u683c\u5f0f\u3002 - timestamp: format: RFC3339Nano source: timestamp # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u6293\u53d6\u7684\u76ee\u6807\u6807\u7b7e\u4e3a name\uff0c\u503c\u4e3a nginx\uff0c\u5e76\u4e14\u65e5\u5fd7\u884c\u4e2d\u5305\u542b GET \u5b57\u6837\u7684\u65f6\u5019\u624d\u4f1a\u6267\u884c - match: selector: '{name=\"nginx\"} |= \"GET\"' stages: # regex \u9636\u6bb5\u901a\u8fc7\u5339\u914d\u4e00\u4e9b\u503c\u6765\u63d0\u53d6\u4e00\u4e2a\u65b0\u7684 output \u503c\u3002 - regex: expression: \\w{1,3}.\\w{1,3}.\\w{1,3}.\\w{1,3}(?P<output>.*) # output \u8f93\u51fa\u9636\u6bb5\u901a\u8fc7\u5c06\u6355\u83b7\u7684\u65e5\u5fd7\u884c\u8bbe\u7f6e\u4e3a\u6765\u81ea\u4e0a\u9762 regex \u9636\u6bb5\u7684\u8f93\u51fa\u503c\u6765\u66f4\u6539\u5176\u5185\u5bb9\u3002 - output: source: output # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u6293\u53d6\u5230\u76ee\u6807\u4e2d\u6709\u6807\u7b7e name\uff0c\u503c\u4e3a jaeger-agent \u65f6\u624d\u4f1a\u6267\u884c\u3002 - match: selector: '{name=\"jaeger-agent\"}' stages: # JSON \u9636\u6bb5\u5c06\u65e5\u5fd7\u884c\u4f5c\u4e3a JSON \u5b57\u7b26\u4e32\u8bfb\u53d6\uff0c\u5e76\u4ece\u5bf9\u8c61\u4e2d\u63d0\u53d6 level \u5b57\u6bb5\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u7684\u9636\u6bb5\u4e2d\u4f7f\u7528\u3002 - json: expressions: level: level # \u5c06\u4e0a\u4e00\u4e2a\u9636\u6bb5\u4e2d\u7684 level \u503c\u53d8\u6210\u4e00\u4e2a\u6807\u7b7e\u3002 - labels: level: - job_name: kubernetes-pods-app kubernetes_sd_configs: .... pipeline_stages: # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u88ab\u6293\u53d6\u7684\u76ee\u6807\u7684\u6807\u7b7e\u4e3a \"app\"\uff0c\u540d\u79f0\u4e3a grafana \u6216 prometheus \u65f6\u624d\u4f1a\u6267\u884c\u3002 - match: selector: '{app=~\"grafana|prometheus\"}' stages: # regex \u9636\u6bb5\u5c06\u63d0\u53d6\u4e00\u4e2a level \u548c component \u503c\uff0c\u4f9b\u540e\u9762\u7684\u9636\u6bb5\u4f7f\u7528\uff0c\u5141\u8bb8 level \u88ab\u5b9a\u4e49\u4e3a lvl=<level> \u6216 level=<level>\uff0c\u7ec4\u4ef6\u88ab\u5b9a\u4e49\u4e3a logger=<component> \u6216 component=<component> - regex: expression: \".*(lvl|level)=(?P<level>[a-zA-Z]+).*(logger|component)=(?P<component>[a-zA-Z]+)\" # \u7136\u540e\u6807\u7b7e\u9636\u6bb5\u5c06\u4ece\u4e0a\u9762 regex \u9636\u6bb5\u63d0\u53d6\u7684 level \u548c component \u53d8\u4e3a\u6807\u7b7e\u3002 - labels: level: component: # \u53ea\u6709\u5f53\u88ab\u6293\u53d6\u7684\u76ee\u6807\u6709\u4e00\u4e2a\u6807\u7b7e \"app\"\uff0c\u5176\u503c\u4e3a \"some-app\"\uff0c\u5e76\u4e14\u65e5\u5fd7\u884c\u4e0d\u5305\u542b \"info\" \u4e00\u8bcd\u65f6\uff0c\u8fd9\u4e2a\u9636\u6bb5\u624d\u4f1a\u6267\u884c\u3002 - match: selector: '{app=\"some-app\"} != \"info\"' stages: # regex \u9636\u6bb5\u5c1d\u8bd5\u901a\u8fc7\u67e5\u627e\u65e5\u5fd7\u4e2d\u7684 panic \u6765\u63d0\u53d6 panic \u4fe1\u606f - regex: expression: \".*(?P<panic>panic: .*)\" # metrics \u9636\u6bb5\u5c06\u589e\u52a0\u4e00\u4e2a Promtail \u66b4\u9732\u7684 panic_total \u6307\u6807\uff0c\u53ea\u6709\u5f53\u4ece\u4e0a\u9762\u7684 regex \u9636\u6bb5\u83b7\u53d6\u5230 panic \u503c\u7684\u65f6\u5019\uff0c\u8be5 Counter \u624d\u4f1a\u589e\u52a0\u3002 - metrics: panic_total: type: Counter description: \"total count of panic\" source: panic config: action: inc \u4e0b\u9762\u6211\u4eec\u5148\u7b80\u5355\u63cf\u8ff0\u4e0b\u6bcf\u4e2a\u9636\u6bb5\u53ef\u4ee5\u4f7f\u7528\u7684\u6570\u636e\u6709\u54ea\u4e9b\u3002 \u6807\u7b7e\u96c6 \uff1a\u5f53\u524d\u65e5\u5fd7\u884c\u7684\u6807\u7b7e\u96c6\u5408\uff0c\u521d\u59cb\u5316\u662f\u4e0e\u65e5\u5fd7\u4e00\u8d77\u88ab\u6293\u53d6\u7684\u6807\u7b7e\u96c6\uff0c\u6807\u7b7e\u96c6\u53ea\u7531\u5904\u7406\u9636\u6bb5\u8fdb\u884c\u4fee\u6539\uff0c\u4f46\u8fc7\u6ee4\u9636\u6bb5\u4f1a\u4ece\u4e2d\u8bfb\u53d6\uff0c\u6700\u7ec8\u7684\u6807\u7b7e\u96c6\u5c06\u7531 Loki \u5efa\u7acb\u7d22\u5f15\uff0c\u5e76\u53ef\u7528\u4e0e\u67e5\u8be2\u3002 \u63d0\u53d6\u7684\u952e\u503c\u5bf9 \uff1a\u5728\u89e3\u6790\u9636\u6bb5\u63d0\u53d6\u7684\u952e\u503c\u5bf9\u96c6\u5408\uff0c\u540e\u7eed\u7684\u9636\u6bb5\u5bf9\u63d0\u53d6\u7684 Map \u8fdb\u884c\u64cd\u4f5c\uff0c\u6216\u8005\u5bf9\u5b83\u4eec\u8fdb\u884c\u8f6c\u6362\uff0c\u6216\u8005\u5bf9\u5b83\u4eec\u8fdb\u884c\u5904\u7406\u3002\u5728\u4e00\u4e2a pipeline \u7684\u672b\u7aef\uff0c\u63d0\u53d6\u7684 Map \u4f1a\u88ab\u4e22\u5f03\u6389\uff0c\u4e3a\u4e86\u4f7f\u4e00\u4e2a\u89e3\u6790\u9636\u6bb5\u6709\u7528\uff0c\u5b83\u5fc5\u987b\u603b\u8981\u4e0e\u81f3\u5c11\u4e00\u4e2a\u5904\u7406\u9636\u6bb5\u914d\u5bf9\u3002\u63d0\u53d6\u7684 Map \u88ab\u521d\u59cb\u5316\uff0c\u5176\u521d\u59cb\u5316\u6807\u7b7e\u662f\u4e0e\u65e5\u5fd7\u884c\u4e00\u8d77\u6293\u53d6\u7684\uff0c\u8fd9\u4e2a\u521d\u59cb\u6570\u636e\u5141\u8bb8\u5728\u53ea\u64cd\u4f5c\u63d0\u53d6\u7684 Map \u7684 pipeline \u9636\u6bb5\u5185\u5bf9\u6807\u7b7e\u7684\u503c\u8fdb\u884c\u5904\u7406\u3002\u4f8b\u5982\uff0c\u4ece\u6587\u4ef6\u4e2d\u63d0\u53d6\u7684\u65e5\u5fd7\u6761\u76ee\u6709\u4e00\u4e2a\u6807\u7b7e filename\uff0c\u5176\u503c\u662f\u88ab\u63d0\u53d6\u7684\u6587\u4ef6\u8def\u5f84\uff0c\u5f53\u4e00\u4e2a pipeline \u6267\u884c\u8be5\u65e5\u5fd7\u65f6\uff0c\u6700\u521d\u63d0\u53d6\u7684 Map \u5c06\u5305\u542b\u4f7f\u7528\u4e0e\u6807\u7b7e\u76f8\u540c\u503c\u7684\u6587\u4ef6\u540d\u3002 \u65e5\u5fd7\u65f6\u95f4\u6233 \uff1a\u65e5\u5fd7\u884c\u7684\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u5904\u7406\u9636\u6bb5\u53ef\u4ee5\u4fee\u6539\u8fd9\u4e2a\u503c\u3002 \u5982\u679c\u4e0d\u8bbe\u7f6e\uff0c\u5219\u9ed8\u8ba4\u4e3a\u65e5\u5fd7\u88ab\u6293\u53d6\u7684\u65f6\u95f4 \uff0c\u65f6\u95f4\u6233\u7684\u6700\u7ec8\u503c\u4f1a\u53d1\u9001\u7ed9 Loki\u3002 \u65e5\u5fd7\u884c \uff1a\u5f53\u524d\u7684\u65e5\u5fd7\u884c\uff0c\u4ee5\u6587\u672c\u5f62\u5f0f\u8868\u793a\uff0c\u521d\u59cb\u5316\u4e3a Promtail \u6293\u53d6\u7684\u6587\u672c\u3002\u5904\u7406\u9636\u6bb5\u53ef\u4ee5\u4fee\u6539\u8fd9\u4e2a\u503c\uff0c\u65e5\u5fd7\u884c\u7684\u6700\u7ec8\u503c\u5c06\u4f5c\u4e3a\u65e5\u5fd7\u7684\u6587\u672c\u5185\u5bb9\u53d1\u9001\u7ed9 Loki\u3002 \u9636\u6bb5 \u00b6 \u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Promtail \u7684\u4e00\u4e2a pipeline \u4e2d\u6709 4 \u4e2d\u7c7b\u578b\u7684\u9636\u6bb5\uff0c\u4e0b\u9762\u6211\u4eec\u518d\u5206\u522b\u5bf9\u8fd9 4 \u4e2d\u7c7b\u578b\u9636\u6bb5\u8fdb\u884c\u7b80\u5355\u8bf4\u660e\u3002 \u89e3\u6790\u9636\u6bb5 \u00b6 \u89e3\u6790\u9636\u6bb5\u5305\u62ec\uff1adocker\u3001cri\u3001regex\u3001json \u8fd9\u51e0\u4e2a stage\u3002 docker \u00b6 docker \u9636\u6bb5\u901a\u8fc7\u4f7f\u7528\u6807\u7b7e\u7684 Docker \u65e5\u5fd7\u683c\u5f0f\u6765\u89e3\u6790\u65e5\u5fd7\u6570\u636e\u8fdb\u884c\u6570\u636e\u63d0\u53d6\u3002\u76f4\u63a5\u4f7f\u7528 docker: {} \u5373\u8868\u793a\u662f\u4e00\u4e2a docker \u9636\u6bb5\u3002 \u4e0e\u5927\u591a\u6570\u9636\u6bb5\u4e0d\u540c\uff0cdocker \u9636\u6bb5\u4e0d\u63d0\u4f9b\u914d\u7f6e\u9009\u9879\uff0c\u53ea\u652f\u6301\u7279\u5b9a\u7684 Docker \u65e5\u5fd7\u683c\u5f0f\uff0c\u6765\u81ea Docker \u7684\u6bcf\u4e00\u884c\u65e5\u5fd7\u90fd\u88ab\u5199\u6210 JSON \u683c\u5f0f\uff0c\u5176\u952e\u503c\u5982\u4e0b\u3002 log \uff1a\u65e5\u5fd7\u884c\u7684\u5185\u5bb9 stream \uff1a stdout \u6216\u8005 stderr time \uff1a\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u5b57\u7b26\u4e32 \u4f8b\u5982\u914d\u7f6e\u4e0b\u9762\u7684 pipeline\uff1a - docker: {} \u5c06\u4f1a\u89e3\u6790 Docker \u65e5\u5fd7\u6210\u5982\u4e0b\u6240\u793a\u683c\u5f0f\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output \uff1a log message\\n stream \uff1a stderr timestamp \uff1a 2019-04-30T02:12:41.8443515 cri \u00b6 \u901a\u8fc7\u4f7f\u7528\u6807\u51c6 CRI \u683c\u5f0f\u89e3\u6790\u65e5\u5fd7\u884c\u6765\u63d0\u53d6\u6570\u636e\u3002\u4f7f\u7528\u8bed\u6cd5\u4e00\u6837\u662f\u76f4\u63a5\u4f7f\u7528 cri: {} \u5373\u53ef\uff0c\u4e0e\u5927\u591a\u6570\u9636\u6bb5\u4e0d\u540c\uff0ccri \u9636\u6bb5\u4e0d\u63d0\u4f9b\u914d\u7f6e\u9009\u9879\uff0c\u53ea\u652f\u6301\u7279\u5b9a\u7684 CRI \u65e5\u5fd7\u683c\u5f0f\u3002CRI \u6307\u5b9a\u7684\u65e5\u5fd7\u884c\u662f\u4ee5\u7a7a\u683c\u5206\u9694\u7684\u503c\uff0c\u6709\u4ee5\u4e0b\u7ec4\u6210\u90e8\u5206\uff1a log \uff1a\u6574\u4e2a\u65e5\u5fd7\u884c\u7684\u5185\u5bb9 stream \uff1a stdout \u6216\u8005 stderr time \uff1a\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u5b57\u7b26\u4e32 \u7ec4\u4ef6\u4e4b\u95f4\u4e0d\u5141\u8bb8\u6709\u7a7a\u767d\uff0c\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u53ea\u6709\u7b2c\u4e00\u884c\u65e5\u5fd7\u53ef\u4ee5\u4f7f\u7528 cri \u9636\u6bb5\u8fdb\u884c\u6b63\u786e\u683c\u5f0f\u5316\u3002 \"2019-01-01T01:00:00.000000001Z stderr P test\\ngood\" \"2019-01-01 T01:00:00.000000001Z stderr testgood\" \"2019-01-01T01:00:00.000000001Z testgood\" \u4f8b\u5982\u914d\u7f6e\u4e0b\u9762\u7684 pipeline\uff1a - cri: {} \u5f53\u6211\u4eec\u6709\u5982\u4e0b\u6240\u793a\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff1a \"2019-04-30T02:12:41.8443515Z stdout xx message\" \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output : xx message stream : stdout timestamp : 2019-04-30T02:12:41.8443515 regex \u00b6 \u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u63d0\u53d6\u6570\u636e\uff0c\u5728 regex \u4e2d\u547d\u540d\u7684\u6355\u83b7\u7ec4\u652f\u6301\u5c06\u6570\u636e\u6dfb\u52a0\u5230\u63d0\u53d6\u7684 Map \u6620\u5c04\u4e2d\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a regex: # RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6bcf\u4e2a\u6355\u83b7\u7ec4\u5fc5\u987b\u88ab\u547d\u540d\u3002 expression: <string> # \u4ece\u6307\u5b9a\u540d\u79f0\u4e2d\u63d0\u53d6\u6570\u636e\uff0c\u5982\u679c\u4e3a\u7a7a\uff0c\u5219\u4f7f\u7528 log \u4fe1\u606f\u3002 [source: <string>] \u5176\u4e2d\u7684 expression \u662f\u4e00\u4e2a Google RE2 \u6b63\u5219\u8868\u8fbe\u5f0f \u5b57\u7b26\u4e32\uff0c\u6bcf\u4e2a\u6355\u83b7\u7ec4\u5c06\u88ab\u8bbe\u7f6e\u4e3a\u5230\u63d0\u53d6\u7684 Map \u4e2d\u53bb\uff0c\u6bcf\u4e2a\u6355\u83b7\u7ec4\u4e5f\u5fc5\u987b\u547d\u540d\uff1a (?P<name>re) \uff0c\u6355\u83b7\u7ec4\u7684\u540d\u79f0\u5c06\u88ab\u7528\u4f5c\u63d0\u53d6\u7684 Map \u4e2d\u7684\u952e\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\uff0c\u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u65f6\uff0c\u5fc5\u987b\u8f6c\u4e49\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u7684\u6240\u6709\u53cd\u659c\u6760\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u51e0\u4e2a\u8868\u8fbe\u5f0f\u90fd\u662f\u6709\u6548\u7684\uff1a expression: \\w* expression: '\\w*' expression: \"\\\\w*\" \u4f46\u662f\u4e0b\u9762\u7684\u8fd9\u51e0\u4e2a\u662f\u65e0\u6548\u7684\u8868\u8fbe\u5f0f\uff1a expression: \\\\w* - \u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u65f6\u624d\u8f6c\u4e49\u53cd\u659c\u7ebf expression: '\\\\w*' - \u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u65f6\u624d\u8f6c\u4e49\u53cd\u659c\u7ebf expression: \"\\w*\" - \u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u7684\u65f6\u5019\uff0c\u53cd\u659c\u6760\u5fc5\u987b\u88ab\u8f6c\u4e49 \u4f8b\u5982\u6211\u4eec\u4f7f\u7528\u4e0b\u9762\u4e0d\u5e26 source \u7684 pipeline \u914d\u7f6e\uff1a - regex: expression: \"^(?s)(?P<time>\\\\S+?) (?P<stream>stdout|stderr) (?P<flags>\\\\S+?) (?P<content>.*)$\" \u5f53\u6211\u4eec\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a 2019-01-01T01:00:00.000000001Z stderr P i'm a log message! \u8be5 pipeline \u6267\u884c\u540e\u4ee5\u4e0b\u952e\u503c\u5bf9\u5c06\u88ab\u6dfb\u52a0\u5230\u63d0\u53d6\u7684 Map \u4e2d\u53bb\uff1a time : 2019-01-01T01:00:00.000000001Z stream : stderr flags : P content : i'm a log message \u5982\u679c\u6211\u4eec\u4f7f\u7528\u5e26\u4e0a source \u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: time: - regex: expression: \"^(?P<year>\\\\d+)\" source: \"time\" \u5982\u679c\u9700\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"time\": \"2019-01-01T01:00:00.000000001Z\" } \u5219\u7b2c\u4e00\u9636\u6bb5\u5c06\u628a\u4ee5\u4e0b\u952e\u503c\u5bf9\u6dfb\u52a0\u5230\u63d0\u53d6\u7684 Map \u4e2d\uff1a time : 2019-01-01T01:00:00.000000001Z \u800c regex \u9636\u6bb5\u5c06\u89e3\u6790\u63d0\u53d6\u7684 Map \u4e2d\u7684\u65f6\u95f4\u503c\uff0c\u5e76\u5c06\u4ee5\u4e0b\u952e\u503c\u5bf9\u8ffd\u52a0\u5230\u63d0\u53d6\u7684 Map \u4e2d\u53bb\uff1a year : 2019 json \u00b6 \u901a\u8fc7\u5c06\u65e5\u5fd7\u884c\u89e3\u6790\u4e3a JSON \u6765\u63d0\u53d6\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u63a5\u53d7 JMESPath \u8868\u8fbe\u5f0f\u6765\u63d0\u53d6\u6570\u636e\uff0c\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a json: # JMESPath \u8868\u8fbe\u5f0f\u7684\u952e/\u503c\u5bf9\u96c6\u5408\uff0c\u952e\u5c06\u662f\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u7684\u952e\uff0c\u800c\u8868\u8fbe\u5f0f\u5c06\u662f\u503c\uff0c\u88ab\u8bc4\u4f30\u4e3a\u6765\u81ea\u6e90\u6570\u636e\u7684 JMESPath\u3002 # # JMESPath \u8868\u8fbe\u5f0f\u53ef\u4ee5\u901a\u8fc7\u7528\u53cc\u5f15\u53f7\u6765\u5305\u88c5\u4e00\u4e2a\u952e\u5b8c\u6210\uff0c\u7136\u540e\u5728 YAML \u4e2d\u5fc5\u987b\u7528\u5355\u5f15\u53f7\u5305\u88c5\u8d77\u6765\uff0c\u8fd9\u6837\u5b83\u4eec\u5c31\u4f1a\u88ab\u4f20\u9012\u7ed9 JMESPath \u89e3\u6790\u5668\u8fdb\u884c\u89e3\u6790\u3002 expressions: [ <string>: <string> ... ] [source: <string>] \u8be5\u9636\u6bb5\u4f7f\u7528 Golang JSON \u53cd\u5e8f\u5217\u5316\uff0c\u63d0\u53d6\u7684\u6570\u636e\u53ef\u4ee5\u6301\u6709\u975e\u5b57\u7b26\u4e32\u503c\uff0c\u672c\u9636\u6bb5\u4e0d\u505a\u4efb\u4f55\u7c7b\u578b\u8f6c\u6362\uff0c\u5728\u4e0b\u6e38\u9636\u6bb5\u5c06\u9700\u8981\u5bf9\u8fd9\u4e9b\u503c\u8fdb\u884c\u5fc5\u8981\u7684\u7c7b\u578b\u8f6c\u6362\uff0c\u53ef\u4ee5\u53c2\u8003\u540e\u9762\u7684 template \u9636\u6bb5\u4e86\u89e3\u5982\u4f55\u8fdb\u884c\u8f6c\u6362\u3002 \u6ce8\u610f\uff1a\u5982\u679c\u63d0\u53d6\u7684\u503c\u662f\u4e00\u4e2a\u590d\u6742\u7684\u7c7b\u578b\uff0c\u6bd4\u5982\u6570\u7ec4\u6216 JSON \u5bf9\u8c61\uff0c\u5b83\u5c06\u88ab\u8f6c\u6362\u4e3a JSON \u5b57\u7b26\u4e32\uff0c\u7136\u540e\u63d2\u5165\u5230\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u53bb\u3002 \u4f8b\u5982\u6211\u4eec\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: output: log stream: stream timestamp: time \u8981\u6293\u53d6\u7684\u65e5\u5fd7\u884c\u6570\u636e\u4e3a\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output : log message\\n stream : stderr timestamp : 2019-04-30T02:12:41.8443515 \u7136\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u7528\u4e0b\u9762\u7684 pipeline \u914d\u7f6e\u6765\u63d0\u524d\u6570\u636e\uff1a - json: expressions: output: log stream: stream timestamp: time extra: - json: expressions: user: source: extra \u8981\u6293\u53d6\u7684\u65e5\u5fd7\u884c\u6570\u636e\u4e3a\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\", \"extra\": \"{\\\"user\\\":\\\"marco\\\"}\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u6267\u884c\u540e\u5c06\u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output : log message\\n stream : stderr timestamp : 2019-04-30T02:12:41.8443515 extra : {\"user\": \"marco\"} \u7136\u540e\u7ecf\u8fc7\u7b2c\u4e8c\u4e2a json \u9636\u6bb5\u6267\u884c\u540e\u5c06\u628a\u63d0\u53d6\u6570\u636e\u4e2d\u7684 extra \u503c\u89e3\u6790\u4e3a JSON\uff0c\u5e76\u5c06\u4ee5\u4e0b\u952e\u503c\u5bf9\u6dfb\u52a0\u5230\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff1a user : marco \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 JMESPath \u8868\u8fbe\u5f0f\u6765\u89e3\u6790\u6709\u7279\u6b8a\u5b57\u7b26\u7684 JSON \u5b57\u6bb5\uff08\u6bd4\u5982 @ \u6216 . \uff09\uff0c\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u6709\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: output: log stream: '\"grpc.stream\"' timestamp: time \u9700\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u5982\u4e0b\u6240\u793a\uff1a { \"log\": \"log message\\n\", \"grpc.stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\u3002 output : log message\\n stream : stderr timestamp : 2019-04-30T02:12:41.8443515 \u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u5f15\u7528 grpc.stream \u65f6\uff0c\u5982\u679c\u6ca1\u6709\u7528\u5355\u5f15\u53f7\u5305\u88f9\u7684\u53cc\u5f15\u53f7\uff0c\u5c06\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\u3002 \u8f6c\u6362\u9636\u6bb5 \u00b6 \u8f6c\u6362\u9636\u6bb5\u7528\u4e8e\u5bf9\u4e4b\u524d\u9636\u6bb5\u63d0\u53d6\u7684\u6570\u636e\u8fdb\u884c\u8f6c\u6362\u3002 multiline \u00b6 \u591a\u884c\u9636\u6bb5\u5c06\u591a\u884c\u65e5\u5fd7\u8fdb\u884c\u5408\u5e76\uff0c\u7136\u540e\u518d\u5c06\u5176\u4f20\u9012\u5230 pipeline \u7684\u4e0b\u4e00\u4e2a\u9636\u6bb5\u3002 \u4e00\u4e2a\u65b0\u7684\u65e5\u5fd7\u5757\u7531 \u7b2c\u4e00\u884c\u6b63\u5219\u8868\u8fbe\u5f0f \u6765\u8bc6\u522b\uff0c\u4efb\u4f55\u4e0e\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d\u7684\u884c\u90fd\u88ab\u8ba4\u4e3a\u662f\u524d\u4e00\u4e2a\u5339\u914d\u5757\u7684\u4e00\u90e8\u5206\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a multiline: # RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5982\u679c\u5339\u914d\u5c06\u5f00\u59cb\u4e00\u4e2a\u65b0\u7684\u591a\u884c\u65e5\u5fd7\u5757 # \u8fd9\u4e2a\u8868\u8fbe\u5f0f\u5fc5\u987b\u88ab\u63d0\u4f9b firstline: <string> # \u89e3\u6790\u7684\u6700\u5927\u7b49\u5f85\u65f6\u95f4\uff08Go duration\uff09: https://golang.org/pkg/time/#ParseDuration. # \u5982\u679c\u5728\u8fd9\u4e2a\u6700\u5927\u7684\u7b49\u5f85\u65f6\u95f4\u5185\u6ca1\u6709\u65b0\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u5f53\u524d\u65e5\u5fd7\u5757\u5c06\u88ab\u7ee7\u7eed\u53d1\u9001\u3002 # \u5982\u679c\u88ab\u89c2\u5bdf\u7684\u5e94\u7528\u7a0b\u5e8f\u56e0\u4e3a\u5f02\u5e38\u800cdown\u6389\u4e86\uff0c\u8be5\u53c2\u6570\u5f88\u6709\u7528\uff0c\u6ca1\u6709\u65b0\u7684\u65e5\u5fd7\u51fa\u73b0\uff0c\u5e76\u4e14\u5f02\u5e38\u5757\u4f1a\u5728\u6700\u5927\u7b49\u5f85\u65f6\u95f4\u8fc7\u540e\u53d1\u9001 # \u9ed8\u8ba4\u4e3a 3s max_wait_time: <duration> # \u4e00\u4e2a\u591a\u884c\u65e5\u5fd7\u5757\u6709\u7684\u6700\u5927\u884c\u6570\uff0c\u5982\u679c\u8be5\u5757\u6709\u66f4\u591a\u7684\u884c\uff0c\u5c31\u4f1a\u8ba4\u4e3a\u662f\u65b0\u7684\u65e5\u5fd7\u884c # \u9ed8\u8ba4\u4e3a 128 \u884c max_lines: <integer> \u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a flask \u5e94\u7528\uff0c\u4e0b\u9762\u7684\u65e5\u5fd7\u6570\u636e\u5305\u542b\u5f02\u5e38\u4fe1\u606f\uff1a [2020-12-03 11:36:20] \"GET /hello HTTP/1.1\" 200 - [2020-12-03 11:36:23] ERROR in app: Exception on /error [GET] Traceback (most recent call last): File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 2447, in wsgi_app response = self.full_dispatch_request() File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1952, in full_dispatch_request rv = self.handle_user_exception(e) File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1821, in handle_user_exception reraise(exc_type, exc_value, tb) File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/_compat.py\", line 39, in reraise raise value File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1950, in full_dispatch_request rv = self.dispatch_request() File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1936, in dispatch_request return self.view_functions[rule.endpoint](**req.view_args) File \"/home/pallets/src/deployment_tools/hello.py\", line 10, in error raise Exception(\"Sorry, this route always breaks\") Exception: Sorry, this route always breaks [2020-12-03 11:36:23] \"GET /error HTTP/1.1\" 500 - [2020-12-03 11:36:26] \"GET /hello HTTP/1.1\" 200 - [2020-12-03 11:36:27] \"GET /hello HTTP/1.1\" 200 - \u663e\u7136\u6211\u4eec\u66f4\u5e0c\u671b\u5c06\u4e0a\u9762\u7684 Exception \u591a\u884c\u65e5\u5fd7\u8bc6\u522b\u4e3a\u4e00\u4e2a\u65e5\u5fd7\u5757\uff0c\u5728\u8fd9\u4e2a\u793a\u4f8b\u4e2d\uff0c\u6240\u6709\u7684\u65e5\u5fd7\u5757\u90fd\u662f\u4e00\u4e2a\u4e2d\u62ec\u53f7\u5305\u62ec\u7684\u65f6\u95f4\u5f00\u59cb\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7528 firstline \u6b63\u5219\u8868\u8fbe\u5f0f\uff1a ^\\[\\d{4}-\\d{2}-\\d{2} \\d{1,2}:\\d{2}:\\d{2}\\] \u6765\u914d\u7f6e\u4e00\u4e2a\u591a\u884c\u9636\u6bb5\uff0c\u8fd9\u5c06\u5339\u914d\u4e0a\u9762\u6211\u4eec\u7684\u5f02\u5e38\u65e5\u5fd7\u7684\u5f00\u5934\u90e8\u5206\uff0c\u4f46\u662f\u4e0d\u4f1a\u5339\u914d\u540e\u9762\u7684\u5f02\u5e38\u884c\uff0c\u76f4\u5230 Exception: Sorry, this route always breaks \u8fd9\u4e00\u884c\u65e5\u5fd7\uff0c\u8fd9\u4e9b\u5c06\u88ab\u8bc6\u522b\u4e3a\u5355\u4e2a\u65e5\u5fd7\u5757\uff0c\u5728 Loki \u4e2d\u4e5f\u662f\u4ee5\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\u51fa\u73b0\u7684\u3002 multiline: # \u8bc6\u522b\u65f6\u95f4\u6233\u4f5c\u4e3a\u591a\u884c\u65e5\u5fd7\u7684\u7b2c\u4e00\u884c\uff0c\u6ce8\u610f\u8fd9\u91cc\u5b57\u7b26\u4e32\u5e94\u8be5\u4f7f\u7528\u5355\u5f15\u53f7\u3002 firstline: '^\\[\\d{4}-\\d{2}-\\d{2} \\d{1,2}:\\d{2}:\\d{2}\\]' max_wait_time: 3s max_lines: 128 template \u00b6 template \u9636\u6bb5\u53ef\u4ee5\u4f7f\u7528 Go \u6a21\u677f\u8bed\u6cd5 \u6765\u64cd\u4f5c\u63d0\u53d6\u7684\u6570\u636e\u3002\u6a21\u677f\u9636\u6bb5\u4e3b\u8981\u7528\u4e8e\u5728\u5c06\u6570\u636e\u8bbe\u7f6e\u4e3a\u6807\u7b7e\u4e4b\u524d\u5bf9\u5176\u4ed6\u9636\u6bb5\u7684\u6570\u636e\u8fdb\u884c\u64cd\u4f5c\uff0c\u4f8b\u5982\u7528\u4e0b\u5212\u7ebf\u66ff\u6362\u7a7a\u683c\uff0c\u6216\u8005\u5c06\u5927\u5199\u7684\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5c0f\u5199\u7684\u5b57\u7b26\u4e32\u3002\u6a21\u677f\u4e5f\u53ef\u4ee5\u7528\u6765\u6784\u5efa\u5177\u6709\u591a\u4e2a\u952e\u7684\u4fe1\u606f\uff0c\u6a21\u677f\u9636\u6bb5\u4e5f\u53ef\u4ee5\u5728\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u521b\u5efa\u65b0\u7684\u952e\u3002 \u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a template: # \u8981\u89e3\u6790\u7684\u63d0\u53d6\u6570\u636e\u4e2d\u7684\u540d\u79f0\uff0c\u5982\u679c\u63d0\u524d\u6570\u636e\u4e2d\u7684 key \u4e0d\u5b58\u5728\uff0c\u5c06\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u503c source: <string> # \u4f7f\u7528\u7684 Go \u6a21\u677f\u5b57\u7b26\u4e32\u3002 \u9664\u4e86\u6b63\u5e38\u7684\u6a21\u677f\u4e4b\u5916 # functions, ToLower, ToUpper, Replace, Trim, TrimLeft, TrimRight, # TrimPrefix, TrimSuffix, and TrimSpace \u90fd\u662f\u53ef\u4ee5\u4f7f\u7528\u7684\u51fd\u6570\u3002 template: <string>s \u6bd4\u5982\u4e0b\u9762\u7684 pipeline \u914d\u7f6e\uff1a - template: source: new_key template: \"hello world!\" \u5047\u5982\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u88ab\u6dfb\u52a0\u5230\u63d0\u53d6\u7684\u6570\u636e\u4e2d\uff0c\u8fd9\u4e2a\u9636\u6bb5\u5c06\u9996\u5148\u5728\u63d0\u53d6\u7684\u6570\u636e Map \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u7a7a\u767d\u503c\u7684 new_key \uff0c\u7136\u540e\u5b83\u7684\u503c\u5c06\u88ab\u8bbe\u7f6e\u4e3a hello world! \u3002 \u5728\u770b\u4e0b\u9762\u7684\u6a21\u677f\u9636\u6bb5\u914d\u7f6e\uff1a - template: source: app template: \"{{ .Value }}_some_suffix\" \u8fd9\u4e2a pipeline \u5728\u73b0\u6709\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6\u952e\u4e3a app \u7684\u503c\uff0c\u5e76\u5c06 _som_suffix \u9644\u52a0\u5230\u503c\u540e\u9762\u3002\u4f8b\u5982\uff0c\u5982\u679c\u63d0\u524d\u7684\u6570\u636e Map \u7684\u952e\u4e3a app\uff0c\u503c\u4e3a loki\uff0c\u90a3\u4e48\u8fd9\u4e2a\u9636\u6bb5\u5c06\u628a\u503c\u4ece loki \u4fee\u6539\u4e3a loki_som_suffix \u3002 - template: source: app template: \"{{ ToLower .Value }}\" \u8fd9\u4e2a pipeline \u4ece\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6\u952e\u4e3a app \u7684\u503c\uff0c\u5e76\u5c06\u5176\u503c\u8f6c\u6362\u4e3a\u5c0f\u5199\u3002\u4f8b\u5982\uff0c\u5982\u679c\u63d0\u53d6\u7684\u6570\u636e\u952e app \u7684\u503c\u4e3a LOKI\uff0c\u90a3\u4e48\u8fd9\u4e2a\u9636\u6bb5\u5c06\u628a\u503c\u8f6c\u6362\u4e3a\u5c0f\u5199\u7684 loki\u3002 - template: source: output_msg template: \"{{ .level }} for app {{ ToUpper .app }}\" \u8fd9\u4e2a pipeline \u4ece\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6 level \u4e0e app \u7684\u503c\uff0c\u4e00\u4e2a\u65b0\u7684 output_msg \u5c06\u88ab\u6dfb\u52a0\u5230\u63d0\u53d6\u7684\u6570\u636e\u4e2d\uff0c\u503c\u4e3a\u4e0a\u9762\u6a21\u677f\u7684\u8ba1\u7b97\u7ed3\u679c\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u5305\u542b\u952e\u4e3a app\uff0c\u503c\u4e3a loki \u7684\u6570\u636e\uff0clevel \u7684\u503c\u4e3a warn\uff0c\u90a3\u4e48\u7ecf\u8fc7\u8be5\u9636\u6bb5\u540e\u4f1a\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u6570\u636e\uff0c\u952e\u4e3a output_msg \uff0c\u5176\u503c\u4e3a warn for app LOKI \u3002 \u4efb\u4f55\u5148\u524d\u63d0\u53d6\u7684\u952e\u90fd\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u4f7f\u7528\uff0c\u6240\u6709\u63d0\u53d6\u7684\u952e\u90fd\u53ef\u7528\u4e8e\u6a21\u677f\u7684\u6269\u5c55\u3002 - template: source: app template: \"{{ .level }} for app {{ ToUpper .Value }} in module {{.module}}\" \u4e0a\u9762\u7684\u8fd9\u4e2a pipeline \u4ece\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6 level\u3001app \u5408 module \u503c\u3002\u4f8b\u5982\uff0c\u5982\u679c\u63d0\u53d6\u7684\u6570\u636e\u5305\u542b\u503c\u4e3a loki \u7684 app\uff0clevel \u7684\u503c\u4e3a warn\uff0cmoudule \u7684\u503c\u4e3a test\uff0c\u5219\u8fd9\u4e2a\u9636\u6bb5\u4f1a\u5c06\u63d0\u53d6\u6570\u636e app \u7684\u503c\u66f4\u6539\u4e3a warn for app LOKI in module test \u3002 \u4efb\u4f55\u4e4b\u524d\u83b7\u53d6\u7684\u952e\u90fd\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u4f7f\u7528\uff0c\u6b64\u5916\uff0c\u5982\u679c source \u662f\u53ef\u7528\u7684\uff0c\u5b83\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u88ab\u79f0\u4e3a .Value \uff0c\u6211\u4eec\u8fd9\u91cc app \u88ab\u5f53\u6210\u4e86 source\uff0c\u6240\u4ee5\u5b83\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u901a\u8fc7 .Value \u4f7f\u7528\u3002 - template: source: app template: '{{ Replace .Value \"loki\" \"blokey\" 1 }}' \u8fd9\u91cc\u7684\u6a21\u677f\u4f7f\u7528 Go \u7684 string.Replace \u51fd\u6570\uff0c\u5f53\u6a21\u677f\u6267\u884c\u65f6\uff0c\u4ece\u63d0\u53d6\u7684 Map \u6570\u636e\u4e2d\u7684\u952e\u4e3a app \u7684\u5168\u90e8\u5185\u5bb9\u5c06\u6700\u591a\u6709 1 \u4e2a loki \u7684\u5b9e\u4f8b\u88ab\u6539\u4e3a blokey\u3002 \u53e6\u5916\u6709\u4e00\u4e2a\u540d\u4e3a Entry \u7684\u7279\u6b8a\u952e\u53ef\u4ee5\u7528\u6765\u5f15\u7528\u5f53\u524d\u884c\uff0c\u5f53\u4f60\u9700\u8981\u8ffd\u52a0\u6216\u9884\u8bbe\u65e5\u5fd7\u884c\u7684\u65f6\u5019\uff0c\u8fd9\u5e94\u8be5\u4f1a\u5f88\u6709\u7528\u3002 - template: source: message template: \"{{.app }}: {{ .Entry }}\" - output: source: message \u4f8b\u5982\uff0c\u4e0a\u9762\u7684\u7247\u6bb5\u4f1a\u5728\u65e5\u5fd7\u884c\u524d\u52a0\u4e0a app \u7684\u540d\u79f0\u3002 \u5728 Loki2.3 \u4e2d\uff0c\u6240\u6709\u7684 sprig \u51fd\u6570 \u90fd\u88ab\u6dfb\u52a0\u5230\u4e86\u5f53\u524d\u7684\u6a21\u677f\u9636\u6bb5\uff0c\u5305\u62ec ToLower & ToUpper\u3001Replace\u3001Trim\u3001Regex\u3001Hash \u548c Sha2Hash \u51fd\u6570\u3002 \u5904\u7406\u9636\u6bb5 \u00b6 \u7528\u4e8e\u4ece\u4ee5\u524d\u9636\u6bb5\u4e2d\u63d0\u53d6\u6570\u636e\u5e76\u5bf9\u5176\u8fdb\u884c\u5904\u7406\u3002 timestamp \u00b6 \u8bbe\u7f6e\u65e5\u5fd7\u6761\u76ee\u7684\u65f6\u95f4\u6233\u503c\uff0c\u5f53\u65f6\u95f4\u6233\u9636\u6bb5\u4e0d\u5b58\u5728\u65f6\uff0c\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u9ed8\u8ba4\u4e3a\u65e5\u5fd7\u6761\u76ee\u88ab\u6293\u53d6\u7684\u65f6\u95f4\u3002 \u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a timestamp: source: <string> # \u89e3\u6790\u65f6\u95f4\u5b57\u7b26\u4e32\u7684\u683c\u5f0f\uff0c\u53ef\u4ee5\u53ea\u6709\u9884\u5b9a\u4e49\u7684\u683c\u5f0f\u6709\uff1a[ANSIC UnixDate RubyDate RFC822 # RFC822Z RFC850 RFC1123 RFC1123Z RFC3339 RFC3339Nano Unix # UnixMs UnixUs UnixNs]. format: <string> # \u5982\u679c\u683c\u5f0f\u65e0\u6cd5\u89e3\u6790\uff0c\u53ef\u5c1d\u8bd5\u7684 fallback \u7684\u683c\u5f0f [fallback_formats: []<string>] # IANA \u65f6\u533a\u6570\u636e\u5e93\u5b57\u7b26\u4e32 [location: <string>] # \u5728\u65f6\u95f4\u6233\u65e0\u6cd5\u63d0\u53d6\u6216\u89e3\u6790\u7684\u60c5\u51b5\u4e0b\uff0c\u5e94\u91c7\u53d6\u4f55\u79cd\u884c\u52a8\u3002\u6709\u6548\u503c\u4e3a\uff1a[skip, fudge]\uff0c\u9ed8\u8ba4\u4e3a fudge\u3002 [action_on_failure: <string>] \u5176\u4e2d\u7684 format \u5b57\u6bb5\u53ef\u4ee5\u53c2\u8003\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a ANSIC : Mon Jan \\_2 15:04:05 2006 UnixDate : Mon Jan_2 15:04:05 MST 2006 RubyDate : Mon Jan 02 15:04:05 -0700 2006 RFC822 : 02 Jan 06 15:04 MST RFC822Z : 02 Jan 06 15:04 -0700 RFC850 : Monday, 02-Jan-06 15:04:05 MST RFC1123 : Mon, 02 Jan 2006 15:04:05 MST RFC1123Z : Mon, 02 Jan 2006 15:04:05 -0700 RFC3339 : 2006-01-02T15:04:05-07:00 RFC3339Nano : 2006-01-02T15:04:05.999999999-07:00 \u53e6\u5916\u652f\u6301\u5e38\u89c1\u7684 Unix \u65f6\u95f4\u6233\uff1a Unix : 1562708916 or with fractions 1562708916.000000123 UnixMs : 1562708916414 UnixUs : 1562708916414123 UnixNs : 1562708916000000123 \u81ea\u5b9a\u4e49\u683c\u5f0f\u662f\u76f4\u63a5\u4f20\u9012\u683c GO \u7684 time.Parse \u51fd\u6570\u4e2d\u7684 layout \u53c2\u6570\uff0c\u5982\u679c\u81ea\u5b9a\u4e49\u683c\u5f0f\u6ca1\u6709\u6307\u5b9a year\uff0cPromtail \u4f1a\u8ba4\u4e3a\u5e94\u8be5\u4f7f\u7528\u7cfb\u7edf\u65f6\u949f\u7684\u5f53\u524d\u5e74\u4efd\u3002 \u81ea\u5b9a\u4e49\u683c\u5f0f\u4f7f\u7528\u7684\u8bed\u6cd5\u662f\u4f7f\u7528\u65f6\u95f4\u6233\u7684\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u7279\u5b9a\u503c\u6765\u5b9a\u4e49\u65e5\u671f\u548c\u65f6\u95f4\uff08\u4f8b\u5982 Mon Jan 2 15:04:05 -0700 MST 2006\uff09\uff0c\u4e0b\u8868\u663e\u793a\u4e86\u5e94\u5728\u81ea\u5b9a\u4e49\u683c\u5f0f\u4e2d\u652f\u6301\u7684\u53c2\u8003\u503c\u3002 action_on_failure \u8bbe\u7f6e\u5b9a\u4e49\u4e86\u5728\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u4e0d\u5b58\u5728 source \u5b57\u6bb5\u6216\u65f6\u95f4\u6233\u89e3\u6790\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u5982\u4f55\u5904\u7406\uff0c\u652f\u6301\u7684\u52a8\u4f5c\u6709\uff1a fudge\uff08\u9ed8\u8ba4\uff09 \uff1a\u5c06\u65f6\u95f4\u6233\u66f4\u6539\u4e3a\u6700\u8fd1\u7684\u5df2\u77e5\u65f6\u95f4\u6233\uff0c\u603b\u8ba1 1 \u7eb3\u79d2\uff08\u4ee5\u4fdd\u8bc1\u65e5\u5fd7\u987a\u5e8f\uff09 skip \uff1a\u4e0d\u6539\u53d8\u65f6\u95f4\u6233\uff0c\u4fdd\u7559\u65e5\u5fd7\u88ab Promtail \u6293\u53d6\u7684\u65f6\u95f4 \u6bd4\u5982\u4f7f\u7528\u4e0b\u9762\u7684 pipeline \u914d\u7f6e\uff1a - timestamp: source: time format: RFC3339Nano \u7ecf\u8fc7\u4e0a\u9762\u7684 timestamp \u9636\u6bb5\u5728\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u67e5\u627e\u4e00\u4e2a time \u5b57\u6bb5\uff0c\u5e76\u4ee5 RFC3339Nano \u683c\u5f0f\u5316\u5176\u503c\uff08\u4f8b\u5982\uff0c2006-01-02T15:04:05.9999999-07:00\uff09\uff0c\u6240\u5f97\u7684\u65f6\u95f4\u503c\u5c06\u4f5c\u4e3a\u65f6\u95f4\u6233\u4e0e\u65e5\u5fd7\u884c\u4e00\u8d77\u53d1\u9001\u7ed9 Loki\u3002 output \u00b6 \u8bbe\u7f6e\u65e5\u5fd7\u884c\u6587\u672c\uff0c\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a output: source: <string> \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u914d\u7f6e\u7684 pipeline\uff1a - json: expressions: user: user message: message - labels: user: - output: source: message \u9700\u8981\u6536\u96c6\u7684\u65e5\u5fd7\u4e3a\uff1a { \"user\": \"alexis\", \"message\": \"hello, world!\" } \u5728\u7ecf\u8fc7\u7b2c\u4e00\u4e2a json \u9636\u6bb5\u540e\u5c06\u63d0\u524d\u4ee5\u4e0b\u952e\u503c\u5bf9\u5230\u6570\u636e\u4e2d\uff1a user : alexis message : hello, world! \u7136\u540e\u7b2c\u4e8c\u4e2a label \u9636\u6bb5\u5c06\u628a user=alexis \u6dfb\u52a0\u5230\u8f93\u51fa\u7684\u65e5\u5fd7\u6807\u7b7e\u96c6\u4e2d\uff0c\u6700\u540e\u7684 output \u9636\u6bb5\u5c06\u628a\u65e5\u5fd7\u6570\u636e\u4ece\u539f\u6765\u7684 JSON \u66f4\u6539\u4e3a message \u7684\u503c hello, world! \u8f93\u51fa\u3002 labels \u00b6 \u66f4\u65b0\u65e5\u5fd7\u7684\u6807\u7b7e\u96c6\uff0c\u5e76\u4e00\u8d77\u53d1\u9001\u7ed9 Loki\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a labels: # Key \u662f\u5fc5\u987b\u7684\uff0c\u662f\u5c06\u88ab\u521b\u5efa\u7684\u6807\u7b7e\u540d\u79f0\u3002 # Values \u662f\u53ef\u9009\u7684\uff0c\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u7684\u540d\u79f0\uff0c\u5176\u503c\u5c06\u88ab\u7528\u4e8e\u6807\u7b7e\u7684\u503c\u3002 # \u5982\u679c\u662f\u7a7a\u7684\uff0c\u503c\u5c06\u88ab\u63a8\u65ad\u4e3a\u4e0e\u952e\u76f8\u540c\u3002 [ <string>: [<string>] ... ] \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: stream: stream - labels: stream: \u9700\u8981\u5904\u7406\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u5c06\u63d0\u53d6 stream \u5230 Map \u6570\u636e\u4e2d\uff0c\u5176\u503c\u4e3a stderr \u3002\u7136\u540e\u5728\u7b2c\u4e8c\u4e2a labels \u9636\u6bb5\u5c06\u628a\u8fd9\u4e2a\u952e\u503c\u5bf9\u53d8\u6210\u4e00\u4e2a\u6807\u7b7e\uff0c\u5728\u53d1\u9001\u5230 Loki \u7684\u65e5\u5fd7\u884c\u4e2d\u5c06\u5305\u62ec\u6807\u7b7e stream \uff0c\u503c\u4e3a stderr \u3002 metrics \u00b6 \u6839\u636e\u63d0\u53d6\u7684\u6570\u636e\u8ba1\u7b97\u6307\u6807\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u521b\u5efa\u7684 metrics \u6307\u6807\u4e0d\u4f1a\u88ab\u63a8\u9001\u5230 Loki\uff0c\u800c\u662f\u901a\u8fc7 Promtail \u7684 /metrics \u7aef\u70b9\u66b4\u9732\u51fa\u53bb\uff0cPrometheus \u5e94\u8be5\u88ab\u914d\u7f6e\u4e3a\u53ef\u4ee5\u6293\u53d6 Promtail \u7684\u6307\u6807\uff0c\u4ee5\u4fbf\u80fd\u591f\u68c0\u7d22\u8fd9\u4e2a\u9636\u6bb5\u6240\u914d\u7f6e\u7684\u6307\u6807\u6570\u636e\u3002 \u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a # \u4e00\u4e2a\u6620\u5c04\uff0ckey\u4e3ametric\u7684\u540d\u79f0\uff0cvalue\u662f\u7279\u5b9a\u7684metric\u7c7b\u578b metrics: [<string>: [ <metric_counter> | <metric_gauge> | <metric_histogram> ] ...] metric_counter \uff1a\u5b9a\u4e49\u4e00\u4e2a Counter \u7c7b\u578b\u7684\u6307\u6807\uff0c\u5176\u503c\u53ea\u4f1a\u4e0d\u65ad\u589e\u52a0\u3002 metric_gauge \uff1a\u5b9a\u4e49\u4e00\u4e2a Gauge \u7c7b\u578b\u7684\u6307\u6807\uff0c\u5176\u503c\u53ef\u4ee5\u589e\u52a0\u6216\u51cf\u5c11\u3002 metric_histogram \uff1a\u5b9a\u4e49\u4e00\u4e2a\u76f4\u65b9\u56fe\u6307\u6807\u3002 \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a Counter \u6307\u6807\uff1a - metrics: log_lines_total: type: Counter description: \"total number of log lines\" prefix: my_promtail_custom_ max_idle_duration: 24h config: match_all: true action: inc log_bytes_total: type: Counter description: \"total bytes of log lines\" prefix: my_promtail_custom_ max_idle_duration: 24h config: match_all: true count_entry_bytes: true action: add \u8fd9\u4e2a\u6d41\u6c34\u7ebf\u5148\u521b\u5efa\u4e86\u4e00\u4e2a log_lines_total \u7684 Counter\uff0c\u901a\u8fc7\u4f7f\u7528 match_all: true \u53c2\u6570\u4e3a\u6bcf\u4e00\u4e2a\u63a5\u6536\u5230\u7684\u65e5\u5fd7\u884c\u589e\u52a0\u3002 \u7136\u540e\u8fd8\u521b\u5efa\u4e86\u4e00\u4e2a log_bytes_total \u7684 Counter \u6307\u6807\uff0c\u901a\u8fc7\u4f7f\u7528 count_entry_bytes: true \u53c2\u6570\uff0c\u5c06\u6536\u5230\u7684\u6bcf\u4e2a\u65e5\u5fd7\u884c\u7684\u5b57\u8282\u5927\u5c0f\u52a0\u5165\u5230\u6307\u6807\u4e2d\u3002 \u8fd9\u4e24\u4e2a\u6307\u6807\u5982\u679c\u6ca1\u6709\u6536\u5230\u65b0\u7684\u6570\u636e\uff0c\u5c06\u5728 24h \u540e\u5c0f\u65f6\u3002\u53e6\u5916\u8fd9\u4e9b\u9636\u6bb5\u5e94\u8be5\u653e\u5728 pipeline \u7684\u672b\u7aef\uff0c\u5728\u4efb\u4f55\u6807\u7b7e\u9636\u6bb5\u4e4b\u540e\u3002 - regex: expression: \"^.*(?P<order_success>order successful).*$\" - metrics: successful_orders_total: type: Counter description: \"log lines with the message `order successful`\" source: order_success config: action: inc \u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a pipeline \u9996\u5148\u5c1d\u8bd5\u5728\u65e5\u5fd7\u4e2d\u627e\u5230\u6210\u529f\u7684\u8ba2\u5355\uff0c\u5c06\u5176\u63d0\u53d6\u4e3a order_success \u5b57\u6bb5\uff0c\u7136\u540e\u5728 metrics \u9636\u6bb5\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a successful_orders_total \u7684 Counter \u6307\u6807\uff0c\u5176\u503c\u662f\u5728\u53ea\u6709\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u6709 order_success \u7684\u65f6\u5019\u624d\u4f1a\u589e\u52a0\u3002\u8fd9\u4e2a pipeline \u7684\u7ed3\u679c\u662f\u4e00\u4e2a\u6307\u6807\uff0c\u5176\u503c\u53ea\u6709\u5728 Promtail \u6293\u53d6\u7684\u65e5\u5fd7\u4e2d\u5e26\u6709 order successful \u6587\u672c\u7684\u65e5\u5fd7\u65f6\u624d\u4f1a\u589e\u52a0\u3002 - regex: expression: \"^.* order_status=(?P<order_status>.*?) .*$\" - metrics: successful_orders_total: type: Counter description: \"successful orders\" source: order_status config: value: success action: inc failed_orders_total: type: Counter description: \"failed orders\" source: order_status config: value: fail action: inc \u4e0a\u9762\u8fd9\u4e2a pipeline \u9996\u5148\u4f1a\u5c1d\u8bd5\u5728\u65e5\u5fd7\u4e2d\u627e\u5230\u683c\u5f0f\u4e3a order_status=<value> \u7684\u6587\u672c\uff0c\u5c06 <value> \u63d0\u53d6\u5230 order_status \u4e2d\u3002\u8be5\u6307\u6807\u9636\u6bb5\u521b\u5efa\u4e86 successful_orders_total \u548c failed_orders_total \u6307\u6807\uff0c\u53ea\u6709\u5f53\u63d0\u53d6\u6570\u636e\u4e2d\u7684 order_status \u7684\u503c\u5206\u522b\u4e3a success \u6216 fail \u65f6\u624d\u4f1a\u589e\u52a0\u3002 tenant \u00b6 \u8bbe\u7f6e\u65e5\u5fd7\u8981\u4f7f\u7528\u7684\u79df\u6237 ID \u503c\uff0c\u4ece\u63d0\u53d6\u6570\u636e\u4e2d\u7684\u4e00\u4e2a\u5b57\u6bb5\u83b7\u53d6\uff0c\u5982\u679c\u8be5\u5b57\u6bb5\u7f3a\u5931\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u7684 Promtail \u5ba2\u6237\u7aef\u79df\u6237 ID\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a tenant: # source \u6216 value \u914d\u7f6e\u9009\u9879\u662f\u5fc5\u987b\u7684\uff0c\u4f46\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u4f7f\u7528\uff08\u5b83\u4eec\u662f\u4e92\u65a5\u7684\uff09 [ source: <string> ] # \u5f53\u524d\u9636\u6bb5\u6267\u884c\u65f6\u7528\u6765\u8bbe\u7f6e\u79df\u6237 ID \u7684\u503c\u3002 # \u5f53\u8fd9\u4e2a\u9636\u6bb5\u88ab\u5305\u542b\u5728\u4e00\u4e2a\u5e26\u6709 \"match\" \u7684\u6761\u4ef6\u7ba1\u9053\u4e2d\u65f6\u975e\u5e38\u6709\u7528\u3002 [ value: <string> ] \u6bd4\u5982\u6211\u4eec\u6709\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a pipeline_stages: - json: expressions: customer_id: customer_id - tenant: source: customer_id \u9700\u8981\u83b7\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"customer_id\": \"1\", \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u5c06\u63d0\u53d6 customer_id \u7684\u503c\u5230 Map \u4e2d\uff0c\u503c\u4e3a 1\u3002\u5728\u7b2c\u4e8c\u4e2a\u79df\u6237\u9636\u6bb5\u5c06\u628a X-Scope-OrgID \u8bf7\u6c42 Header \u5934\uff08Loki \u7528\u6765\u8bc6\u522b\u79df\u6237\uff09\u8bbe\u7f6e\u4e3a\u63d0\u53d6\u7684 customer_id \u7684\u503c\uff0c\u4e5f\u5c31\u662f 1. \u53e6\u5916\u4e00\u79cd\u573a\u666f\u662f\u7528\u914d\u7f6e\u7684\u503c\u6765\u8986\u76d6\u79df\u6237 ID\uff0c\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a pipeline_stages: - json: expressions: app: message: - labels: app: - match: selector: '{app=\"api\"}' stages: - tenant: value: \"team-api\" - output: source: message \u9700\u8981\u6536\u96c6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"app\": \"api\", \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u8fd9\u4e2a pipeline \u5c06\uff1a Decode JSON \u65e5\u5fd7 \u8bbe\u7f6e\u6807\u7b7e app=\"api\" \u5904\u7406\u5339\u914d\u9636\u6bb5\uff0c\u68c0\u67e5 {app=\"api\"} \u9009\u62e9\u5668\u662f\u5426\u5339\u914d\uff0c\u5982\u679c\u5339\u914d\u4e86\u5219\u6267\u884c\u5b50\u9636\u6bb5\uff0c\u4e5f\u5c31\u662f\u8fd9\u91cc\u7684\u79df\u6237\u9636\u6bb5\uff0c\u8986\u76d6\u503c\u4e3a \"team-api\" \u7684\u79df\u6237\u3002 \u6b64\u5916\u5728\u5904\u7406\u9636\u6bb5\u8fd8\u6709 labeldrop \u9636\u6bb5\uff0c\u5b83\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u6807\u7b7e\uff0c\u8fd9\u4e9b\u6807\u7b7e\u4e0e\u65e5\u5fd7\u6761\u76ee\u4e00\u8d77\u88ab\u53d1\u9001\u5230 Loki\u3002\u8fd8\u6709\u4e00\u4e2a labelallow \u9636\u6bb5\uff0c\u5b83\u53ea\u5141\u8bb8\u5c06\u6240\u63d0\u4f9b\u7684\u6807\u7b7e\u5305\u542b\u5728\u4e0e\u65e5\u5fd7\u6761\u76ee\u4e00\u8d77\u53d1\u9001\u7ed9 Loki \u7684\u6807\u7b7e\u96c6\u4e2d\u3002 \u8fc7\u6ee4\u9636\u6bb5 \u00b6 \u53ef\u9009\u62e9\u5e94\u7528\u4e00\u4e2a\u9636\u6bb5\u7684\u5b50\u96c6\uff0c\u6216\u6839\u636e\u4e00\u4e9b\u6761\u4ef6\u5220\u9664\u65e5\u5fd7\u6570\u636e\u3002 match \u00b6 \u5f53\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\u4e0e\u53ef\u914d\u7f6e\u7684 LogQL \u6d41\u9009\u62e9\u5668\u548c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u76f8\u5339\u914d\u65f6\uff0c\u6709\u6761\u4ef6\u5730\u5e94\u7528\u4e00\u7ec4\u9636\u6bb5\u6216\u5220\u9664\u65e5\u5fd7\u6570\u636e\u3002\u914d\u7f6e\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a match: # LogQL \u6d41\u9009\u62e9\u5668\u5408\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u3002 selector: <string> # pipeline \u540d\u79f0\uff0c\u5f53\u5b9a\u4e49\u7684\u65f6\u5019\uff0c\u5728 pipeline_duration_seconds \u76f4\u65b9\u56fe\u4e2d\u521b\u5efa\u4e00\u4e2a\u989d\u5916\u7684\u6807\u7b7e\uff0c\u8be5\u503c\u4e0e job_name \u4f7f\u7528\u4e0b\u5212\u7ebf\u8fde\u63a5\u3002 [pipeline_name: <string>] # \u51b3\u5b9a\u5f53\u9009\u62e9\u5668\u4e0e\u65e5\u5fd7\u884c\u5339\u914d\u65f6\u91c7\u53d6\u4ec0\u4e48\u52a8\u4f5c\u3002 # \u9ed8\u8ba4\u662f keep\uff0c\u5f53\u8bbe\u7f6e\u4e3a drop \u65f6\uff0c\u65e5\u5fd7\u5c06\u88ab\u5220\u9664\uff0c\u4ee5\u540e\u7684\u6307\u6807\u5c06\u4e0d\u4f1a\u88ab\u8bb0\u5f55\u3002 [action: <string> | default = \"keep\"] # \u5982\u679c\u4f60\u6307\u5b9a\u4e86 `action: drop` \u90a3\u4e48 `logentry_dropped_lines_total` \u8fd9\u4e2a\u6307\u6807\u5c06\u4e3a\u6bcf\u4e00\u4e2a\u88ab\u4e22\u5f03\u7684\u884c\u800c\u589e\u52a0 # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0creaseon \u6807\u7b7e\u662f `match_stage`\uff0c\u4f46\u662f\u4f60\u53ef\u4ee5\u9009\u62e9\u6307\u5b9a\u4e00\u4e2a\u81ea\u5b9a\u4e49\u503c\u7528\u4e8e\u8be5\u6307\u6807\u7684 `reason` \u6807\u7b7e\u3002 [drop_counter_reason: <string> | default = \"match_stage\"] # \u53ea\u6709\u5f53\u9009\u62e9\u5668\u4e0e\u65e5\u5fd7\u7684\u6807\u7b7e\u76f8\u5339\u914d\u65f6\uff0c\u624d\u4f1a\u51fa\u73b0\u5d4c\u5957\u7684\u6d41\u6c34\u7ebf\u9636\u6bb5\uff1a stages: - [ <regex_stage> <json_stage> | <template_stage> | <match_stage> | <timestamp_stage> | <output_stage> | <labels_stage> | <metrics_stage> | <tenant_stage> ] \u6bd4\u5982\u6211\u4eec\u73b0\u5728\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u7684 pipeline \u914d\u7f6e\uff1a pipeline_stages: - json: expressions: app: - labels: app: - match: selector: '{app=\"loki\"}' stages: - json: expressions: msg: message - match: pipeline_name: \"app2\" selector: '{app=\"pokey\"}' action: keep stages: - json: expressions: msg: msg - match: selector: '{app=\"promtail\"} |~ \".*noisy error.*\"' action: drop drop_counter_reason: promtail_noisy_error - output: source: msg \u8981\u5904\u7406\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"time\":\"2012-11-01T22:08:41+00:00\", \"app\":\"loki\", \"component\": [\"parser\",\"type\"], \"level\" : \"WARN\", \"message\" : \"app1 log line\" } { \"time\":\"2012-11-01T22:08:41+00:00\", \"app\":\"promtail\", \"component\": [\"parser\",\"type\"], \"level\" : \"ERROR\", \"message\" : \"foo noisy error\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u5c06\u5728\u7b2c\u4e00\u4e2a\u65e5\u5fd7\u884c\u7684\u63d0\u53d6 Map \u6570\u636e\u4e2d\u6dfb\u52a0\u503c app=loki \uff0c\u7136\u540e\u7ecf\u8fc7\u7b2c\u4e8c\u4e2a labels \u9636\u6bb5\u5c06 app \u8f6c\u6362\u6210\u4e00\u4e2a\u6807\u7b7e\u3002\u5bf9\u4e8e\u7b2c\u4e8c\u884c\u65e5\u5fd7\u4e5f\u9075\u5faa\u540c\u6837\u7684\u6d41\u7a0b\uff0c\u53ea\u662f\u503c\u53d8\u6210\u4e86 promtail \u3002 \u7136\u540e\u5728\u7b2c\u4e09\u4e2a match \u9636\u6bb5\u4f7f\u7528 LogQL \u8868\u8fbe\u5f0f {app=\"loki\"} \u8fdb\u884c\u5339\u914d\uff0c\u53ea\u6709\u5728\u6807\u7b7e app=loki \u7684\u65f6\u5019\u624d\u4f1a\u6267\u884c\u5d4c\u5957 json \u9636\u6bb5\uff0c\u8fd9\u91cc\u5408\u6211\u4eec\u7684\u7b2c\u4e00\u884c\u65e5\u5fd7\u662f\u5339\u914d\u7684\uff0c\u7136\u540e\u5d4c\u5957\u7684 json \u9636\u6bb5\u5c06 message \u6570\u636e\u63d0\u53d6\u5230 Map \u6570\u636e\u4e2d\uff0ckey \u53d8\u6210\u4e86 msg \uff0c\u503c\u4e3a app1 log line \u3002 \u63a5\u4e0b\u6765\u6267\u884c\u7b2c\u56db\u4e2a match \u9636\u6bb5\uff0c\u9700\u8981\u5339\u914d app=\"pokey\" \uff0c\u5f88\u663e\u7136\u8fd9\u91cc\u6211\u4eec\u90fd\u4e0d\u5339\u914d\uff0c\u6240\u4ee5\u5d4c\u5957\u7684 json \u5b50\u9636\u6bb5\u4e0d\u4f1a\u88ab\u6267\u884c\u3002 \u7136\u540e\u6267\u884c\u7684\u7b2c\u4e94\u4e2a match \u9636\u6bb5\uff0c\u5c06\u4f1a\u5220\u6389\u4efb\u4f55\u5177\u6709 app=\"promtail\" \u6807\u7b7e\u5e76\u5305\u62ec noisy error \u6587\u672c\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u5e76\u4e14\u8fd8\u5c06\u589e\u52a0 logentry_drop_lines_total \u6307\u6807\uff0c\u6807\u7b7e\u4e3a reason=\"promtail_noisy_error\" \u3002 \u6700\u540e\u7684 output \u8f93\u51fa\u9636\u6bb5\u5c06\u65e5\u5fd7\u884c\u7684\u5185\u5bb9\u6539\u4e3a\u63d0\u53d6\u6570\u636e\u4e2d\u7684 msg \u7684\u503c\u3002\u6211\u4eec\u8fd9\u91cc\u7684\u793a\u4f8b\u6700\u540e\u8f93\u51fa\u4e3a app1 log line \u3002 drop \u00b6 drop \u9636\u6bb5\u53ef\u4ee5\u8ba9\u6211\u4eec\u6839\u636e\u914d\u7f6e\u6765\u5220\u9664\u65e5\u5fd7\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4f60\u63d0\u4f9b\u591a\u4e2a\u9009\u9879\u914d\u7f6e\uff0c\u5b83\u4eec\u5c06\u88ab\u89c6\u4e3a AND \u5b50\u53e5\uff0c\u5176\u4e2d\u6bcf\u4e2a\u9009\u9879\u5fc5\u987b\u4e3a\u771f\u624d\u80fd\u5220\u9664\u65e5\u5fd7\u3002\u5982\u679c\u4f60\u60f3\u7528\u4e00\u4e2a OR \u5b50\u53e5\u6765\u5220\u9664\uff0c\u90a3\u4e48\u5c31\u6307\u5b9a\u591a\u4e2a\u5220\u9664\u9636\u6bb5\u3002\u914d\u7f6e\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a drop: [source: <string>] # RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5982\u679c\u63d0\u4f9b\u4e86 source\uff0c\u5219\u4f1a\u5c1d\u8bd5\u5339\u914d source # \u5982\u679c\u6ca1\u6709\u63d0\u4f9b source\uff0c\u5219\u4f1a\u5c1d\u8bd5\u5339\u914d\u65e5\u5fd7\u884c\u6570\u636e # \u5982\u679c\u63d0\u4f9b\u7684\u6b63\u5219\u5339\u914d\u4e86\u65e5\u5fd7\u884c\u6216\u8005 source\uff0c\u5219\u8be5\u884c\u65e5\u5fd7\u5c06\u88ab\u5220\u9664\u3002 [expression: <string>] # \u53ea\u6709\u5728\u6307\u5b9a source \u6e90\u7684\u60c5\u51b5\u4e0b\u624d\u80fd\u6307\u5b9a value \u503c\u3002 # \u6307\u5b9a value \u4e0e regex \u662f\u9519\u8bef\u7684\u3002 # \u5982\u679c\u63d0\u4f9b\u7684\u503c\u4e0e`source`\u5b8c\u5168\u5339\u914d\uff0c\u8be5\u884c\u5c06\u88ab\u5220\u9664\u3002 [value: <string>] # older_than \u88ab\u89e3\u6790\u4e3a Go duration \u683c\u5f0f # \u5982\u679c\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u5927\u4e8e\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u6240\u63d0\u4f9b\u7684\u65f6\u95f4\uff0c\u5219\u5c06\u88ab\u5220\u9664 [older_than: <duration>] # longer_than \u662f\u4e00\u4e2a\u4ee5 bytes \u4e3a\u5355\u4f4d\u7684\u503c\uff0c\u4efb\u4f55\u8d85\u8fc7\u8fd9\u4e2a\u503c\u7684\u65e5\u5fd7\u884c\u90fd\u5c06\u88ab\u5220\u9664\u3002 # \u53ef\u4ee5\u6307\u5b9a\u4e3a\u6574\u6570\u683c\u5f0f\u7684\u5b57\u8282\u6570\uff1a8192\uff0c\u6216\u8005\u5e26\u540e\u7f00\u7684 8kb [longer_than: <string>|<int>] # \u6bcf\u5f53\u4e00\u4e2a\u65e5\u5fd7\u884c\u6570\u636e\u88ab\u5220\u9664\uff0c\u6307\u6807 `logentry_dropped_lines_total` \u90fd\u4f1a\u589e\u52a0\u3002 # \u9ed8\u8ba4\u7684 reason \u6807\u7b7e\u662f `drop_stage`\uff0c\u7136\u800c\u4f60\u53ef\u4ee5\u9009\u62e9\u6307\u5b9a\u4e00\u4e2a\u81ea\u5b9a\u4e49\u503c\uff0c\u7528\u4e8e\u8be5\u6307\u6807\u7684 \"reason\" \u6807\u7b7e\u3002 [drop_counter_reason: <string> | default = \"drop_stage\"] \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u7b80\u5355 drop \u9636\u6bb5\u914d\u7f6e\uff1a - drop: expression: \".*debug.*\" \u8be5\u9636\u6bb5\u5c06\u5220\u9664\u4efb\u4f55\u5e26\u6709 debug \u5b57\u6837\u7684\u65e5\u5fd7\u884c\u3002 \u5982\u679c\u662f\u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\uff1a - json: expressions: level: msg: - drop: source: \"level\" expression: \"(error|ERROR)\" \u5219\u4e0b\u9762\u7684\u65e5\u5fd7\u6570\u636e\u90fd\u5c06\u88ab\u5220\u9664\uff1a {\"time\":\"2019-01-01T01:00:00.000000001Z\", \"level\": \"error\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} {\"time\":\"2019-01-01T01:00:00.000000001Z\", \"level\": \"ERROR\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} \u7136\u540e\u4f7f\u7528\u4e0b\u9762\u7684\u914d\u7f6e\u6765\u5220\u9664\u8001\u7684\u65e5\u5fd7\u6570\u636e\uff1a - json: expressions: time: msg: - timestamp: source: time format: RFC3339 - drop: older_than: 24h drop_counter_reason: \"line_too_old\" \u9700\u8981\u6ce8\u610f\u7684\u662f\u4e3a\u4e86\u8ba9 old_than \u53d1\u6325\u4f5c\u7528\uff0c\u4f60\u5fc5\u987b\u5728\u5e94\u7528 drop \u9636\u6bb5\u4e4b\u524d\uff0c\u4f7f\u7528\u65f6\u95f4\u6233\u9636\u6bb5\u6765\u8bbe\u7f6e\u6293\u53d6\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u3002 \u6bd4\u5982\u5f53\u524d\u7684\u6444\u53d6\u65f6\u95f4\u4e3a 2021-05-01T12:00:00Z \uff0c\u5f53\u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u65f6\uff0c\u4f1a\u5220\u9664\u8fd9\u4e2a\u65e5\u5fd7\u884c\uff1a {\"time\":\"2021-05-01T12:00:00Z\", \"level\": \"error\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} \u4f46\u662f\u4e0b\u9762\u7684\u65e5\u5fd7\u6570\u636e\u4e0d\u4f1a\u88ab\u5220\u9664\uff1a {\"time\":\"2021-05-03T12:00:00Z\", \"level\": \"error\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5f53\u524d\u65f6\u95f4\u662f `2021-05-03T16:00:00Z \uff0c older_than \u662f 24h\u3002\u6240\u6709\u65f6\u95f4\u6233\u8d85\u8fc7 2021-05-02T16:00:00Z \u7684\u65e5\u5fd7\u884c\u90fd\u5c06\u88ab\u5220\u9664\u3002 \u8fd9\u4e2a\u5220\u9664\u9636\u6bb5\u5220\u9664\u7684\u6240\u6709\u884c\u4e5f\u5c06\u589e\u52a0 logentry_drop_lines_total \u6307\u6807\uff0c\u5e76\u6807\u660e\u539f\u56e0\u4e3a \"line_too_old\" \u3002 \u4e0b\u9762\u662f\u53e6\u5916\u4e00\u4e2a\u590d\u6742\u70b9\u7684\u914d\u7f6e\uff1a - json: expressions: time: msg: - timestamp: source: time format: RFC3339 - drop: older_than: 24h - drop: longer_than: 8kb - drop: source: msg regex: \".*trace.*\" \u4e0a\u9762\u7684 pipeline \u6267\u884c\u540e\u5c06\u5220\u9664\u6389\u6240\u6709\u8d85\u8fc7 24 \u5c0f\u65f6 \u6216\u8005 \u8d85\u8fc7 8kb \u7684\u65e5\u5fd7 \u6216\u8005 json \u7684 msg \u503c\u4e2d\u5305\u542b trace \u5b57\u6837\u7684\u65e5\u5fd7\u3002 Scraping \u00b6 Promtail \u53ef\u4ee5\u901a\u8fc7 YAML \u6587\u4ef6\u4e2d\u7684 scrape_configs \u914d\u7f6e\u6765\u81ea\u52a8\u53d1\u73b0\u65e5\u5fd7\u6587\u4ef6\u5e76\u4ece\u4e2d\u63d0\u53d6\u6807\u7b7e\uff0c\u8be5\u8bed\u6cd5\u4e0e Prometheus \u4e2d\u7684\u914d\u7f6e\u6bd4\u8f83\u7c7b\u4f3c\u3002 scrape_configs \u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u914d\u7f6e\u6761\u76ee\uff0c\u4f1a\u5bf9\u6bcf\u4e2a\u53d1\u73b0\u7684\u76ee\u6807\u6267\u884c\u65e5\u5fd7\u6293\u53d6\u4efb\u52a1\u3002 scrape_configs: - job_name: local static_configs: - ... - job_name: kubernetes kubernetes_sd_config: - ... \u4f46\u662f\u9700\u8981\u6ce8\u610f\u5982\u679c\u6709\u4e00\u4e2a\u4ee5\u4e0a\u7684\u6293\u53d6\u914d\u7f6e\u4e0e\u4f60\u7684\u65e5\u5fd7\u5339\u914d\u4e86\uff0c\u90a3\u4e48\u53ef\u80fd\u4f1a\u5f97\u5230\u91cd\u590d\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u56e0\u4e3a\u65e5\u5fd7\u662f\u5728\u4e0d\u540c\u7684\u6d41\u4e2d\u53d1\u9001\u7684\uff0c\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u7684\u6807\u7b7e\u3002 Promtail \u4e2d\u5b58\u5728\u51e0\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u6807\u7b7e\uff1a \u4ee5 __ (\u4e24\u4e2a\u4e0b\u5212\u7ebf)\u5f00\u5934\u7684\u6807\u7b7e\u662f \u5185\u90e8\u6807\u7b7e \uff0c\u5b83\u4eec\u901a\u5e38\u6765\u81ea\u52a8\u6001\u6570\u636e\u6e90\uff0c\u6bd4\u5982\u670d\u52a1\u53d1\u73b0\u3002\u4e00\u65e6\u91cd\u65b0\u6253\u4e0a\u6807\u7b7e\uff0c\u5b83\u4eec\u5c31\u4f1a\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\uff0c\u5982\u679c\u8981\u4fdd\u7559\u5185\u90e8\u6807\u7b7e\u53d1\u9001\u5230 Loki\uff0c\u8bf7\u91cd\u65b0\u547d\u540d\u5b83\u4eec\uff0c\u4f7f\u5b83\u4eec\u4e0d\u4ee5 __ \u5f00\u5934\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u7684 Relabeling \u90e8\u5206\u914d\u7f6e\u3002 \u4ee5 __meta_kubernetes_pod_label_* \u5f00\u5934\u7684\u6807\u7b7e\u662f \u5143\u6807\u7b7e \uff0c\u662f\u6839\u636e\u4f60\u7684 Kubernetes Pod \u7684\u6807\u7b7e\u751f\u6210\u7684\u3002\u6bd4\u5982\u4f60\u7684\u6709\u4e00\u4e2a Pod \u7684\u6807\u7b7e\u540d\u79f0\u662f foobar \uff0c\u90a3\u4e48 scrape_configs \u90e8\u5206\u5c06\u6536\u5230\u4e00\u4e2a\u540d\u4e3a __meta_kubernetes_pod_label_name \u7684\u5185\u90e8\u6807\u7b7e\uff0c\u503c\u4f1a\u88ab\u8bbe\u7f6e\u4e3a foobar \u3002 \u5176\u4ed6 __meta_kubernetes_* \u5f00\u5934\u7684\u6807\u7b7e\u662f\u57fa\u4e8e\u5176\u4ed6 Kubernetes \u5143\u6570\u636e\u751f\u6210\u7684\uff0c\u6bd4\u5982 Pod \u7684\u547d\u540d\u7a7a\u95f4\uff08 __meta_kubernetes_namespace \uff09\u6216 Pod \u5185\u90e8\u7684\u5bb9\u5668\u540d\u79f0\uff08 __meta_kubernetes_pod_container_name \uff09\u7b49\u7b49\uff0c\u5173\u4e8e Kubernetes \u5143\u6807\u7b7e\u7684\u5b8c\u6574\u5217\u8868\uff0c\u53ef\u4ee5\u53c2\u8003 Prometheus \u6587\u6863 \u7684\u8bf4\u660e\uff0c\u56e0\u4e3a\u8fd9\u4e8c\u8005\u5b9e\u73b0\u65b9\u5f0f\u662f\u4e00\u81f4\u7684\u3002 __path__ \u6807\u7b7e\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u6807\u7b7e\uff0cPromtail \u5728\u53d1\u73b0\u540e\u4f7f\u7528\u5b83\u6765\u8ba1\u7b97\u8981\u8bfb\u53d6\u7684\u6587\u4ef6\u4f4d\u7f6e\uff0c\u5141\u8bb8\u4f7f\u7528\u901a\u914d\u7b26\uff0c\u4f8b\u5982 /var/log/*.log \u7528\u4e8e\u83b7\u53d6\u6307\u5b9a\u76ee\u5f55\u4e2d\u6240\u6709\u5e26\u6709 log \u6269\u5c55\u540d\u7684\u6587\u4ef6\uff0c\u800c /var/log/**/*.log \u7528\u4e8e\u9012\u5f52\u5339\u914d\u6587\u4ef6\u4e0e\u76ee\u5f55\u3002 \u5728 __path__ \u4e2d\u627e\u5230\u7684\u6bcf\u4e2a\u6587\u4ef6\u90fd\u4f1a\u6dfb\u52a0\u6587\u4ef6\u540d\u6807\u7b7e\uff0c\u4ee5\u786e\u4fdd\u65e5\u5fd7\u6d41\u7684\u552f\u4e00\u6027\uff0c\u5b83\u88ab\u8bbe\u7f6e\u4e3a\u8be5\u884c\u88ab\u8bfb\u53d6\u7684\u6587\u4ef6\u7684\u7edd\u5bf9\u8def\u5f84\u3002 Promtail \u53ef\u4ee5\u4f7f\u7528 Kubernetes API \u6765\u53d1\u73b0\u4f5c\u4e3a\u76ee\u6807\u7684 Pod\uff0c\u4f46\u9700\u8981\u6ce8\u610f\u5b83 \u53ea\u80fd\u4e0e Promtail \u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u7684 Pod \u4e2d\u8bfb\u53d6\u65e5\u5fd7 \uff0cPromtail \u4f1a\u5728\u6bcf\u4e2a\u76ee\u6807\u4e2d\u67e5\u8be2\u4e00\u4e2a __host__ \u6807\u7b7e\uff0c\u5e76\u9a8c\u8bc1\u5b83\u662f\u5426\u4e0e Promtail \u7684\u4e3b\u673a\u540d\u76f8\u540c\u3002 \u6240\u4ee5\u4efb\u4f55\u65f6\u5019\u4f7f\u7528 Kubernetes \u670d\u52a1\u53d1\u73b0\uff0c\u90fd\u5fc5\u987b\u6709\u4e00\u4e2a relabel_config \u914d\u7f6e\uff0c\u4ece __meta_kubernetes_pod_node_name \u5143\u6807\u7b7e\u521b\u5efa\u4e00\u4e2a\u4e2d\u95f4\u7684 __host__ \u6807\u7b7e\u3002 relabel_configs: - source_labels: [\"__meta_kubernetes_pod_node_name\"] target_label: \"__host__\" Relabeling \u00b6 Relabeling \u8868\u793a\u4fee\u6539 labels \u6807\u7b7e\uff1a\u6dfb\u52a0\u3001\u4fee\u6539\u6216\u5220\u9664\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 scrape_configs \u4e2d\u7684 relabel_configs \u6765\u8fdb\u884c Relabel \u64cd\u4f5c\u3002\u7531\u4e8e\u91c7\u7528\u7684\u4e0e Prometheus \u4e00\u6837\u7684 Relabel \u673a\u5236\uff0c\u6240\u4ee5\u64cd\u4f5c\u65b9\u5f0f\u4e0e Prometheus \u662f\u4e00\u81f4\u7684\u3002 \u6b63\u5219\u8868\u8fbe\u5f0f Prometheus \u4f7f\u7528 RE2 \u6b63\u5219\u8868\u8fbe\u5f0f \u56fa\u5b9a\u7684\uff1a\u6b63\u5219\u8868\u8fbe\u5f0f bar \u4e0d\u4f1a\u5339\u914d foobar .*bar.* \u5219\u4e0d\u56fa\u5b9a \u4e5f\u53ef\u4ee5\u4f7f\u7528\u6355\u83b7\u7ec4\uff1a (.*)bar \u9488\u5bf9 foobar \u4f1a\u521b\u5efa\u4e00\u4e2a $1 \u7684\u53d8\u91cf\uff0c\u5b83\u7684\u503c\u662f foo \u6b63\u5219\u793a\u4f8b prom|alert \u5c06\u4f1a\u5339\u914d prom \u4e0e alert 201[78] \u5c06\u5339\u914d 2017 \u4e0e 2018 promcon(20.+) \u5c06\u5339\u914d promcon2020 \u3001 promcon20xx \u7b49\u7b49\uff0c\u5982\u679c\u662f promcon2018 \uff0c\u5219 $1 \u7684\u503c\u4e3a 2018 \u3002 relabel_configs \u4e2d\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u4e00\u4e2a drop \u64cd\u4f5c\u6765\u62d2\u7edd\u76ee\u6807\uff1a\u5982\u679c\u6807\u7b7e\u503c\u4e0e\u6307\u5b9a\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u5219\u88ab drop \u6389\u3002\u5f53\u4e00\u4e2a\u76ee\u6807\u88ab drop \u6389\uff0c\u62e5\u6709\u7684 scrape_config \u5c06\u4e0d\u4f1a\u5904\u7406\u6765\u81ea\u8be5\u7279\u5b9a\u6765\u6e90\u7684\u65e5\u5fd7\uff0c\u5176\u4ed6\u6ca1\u6709 drop \u52a8\u4f5c\u7684 scrape_configs \u4ece\u540c\u4e00\u76ee\u6807\u8bfb\u53d6\u7684\u65e5\u5fd7\u4ecd\u7136\u53ef\u4ee5\u4f7f\u7528\u5e76\u8f6c\u53d1\u7ed9 Loki\u3002 relabel_configs \u7684\u4e00\u4e2a\u5e38\u89c1\u7528\u4f8b\u5c31\u662f\u5c06\u4e00\u4e2a\u5185\u90e8\u6807\u7b7e\u5982 __meta_kubernetes_* \u8f6c\u6362\u4e3a\u4e00\u4e2a\u4e2d\u95f4\u7684\u5185\u90e8\u6807\u7b7e\u5982 __service__ \uff0c\u7136\u540e\u8fd9\u4e2a\u4e2d\u95f4\u7684\u5185\u90e8\u6807\u7b7e\u53ef\u4ee5\u6839\u636e value \u503c\u88ab drop \u6389\uff0c\u6216\u8005\u8f6c\u5316\u4e3a\u6700\u7ec8\u7684\u5916\u90e8\u6807\u7b7e\uff0c\u5982 __job__ \u3002 \u793a\u4f8b \u5982\u679c\u4e00\u4e2a\u6807\u7b7e\uff08\u4f8b\u5b50\u4e2d\u7684 __service__ \uff09\u4e3a\u7a7a\uff0c\u5219\u653e\u5f03\u6293\u53d6\u76ee\u6807\uff1a - action: drop regex: '' source_labels: - __service__ \u5982\u679c\u4efb\u4f55\u4e00\u4e2a source_labels \u6807\u7b7e\u5305\u542b\u4e00\u4e2a\u503c\uff0c\u5219\u5220\u9664\u6293\u53d6\u76ee\u6807\uff1a - action: drop regex: .+ separator: '' source_labels: - __meta_kubernetes_pod_label_name - __meta_kubernetes_pod_label_app \u901a\u8fc7\u91cd\u547d\u540d\u4e00\u4e2a\u5185\u90e8\u6807\u7b7e\u6765\u6301\u4e45\u5316\uff0c\u8fd9\u6837\u5b83\u5c31\u4f1a\u88ab\u53d1\u9001\u5230 Loki\uff1a - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace \u901a\u8fc7\u6620\u5c04\u4fdd\u7559\u6240\u6709\u7684 Kubernetes Pod \u6807\u7b7e\uff0c\u6bd4\u5982\u5c06 __meta_kube__meta_kubernetes_pod_label_foo \u6620\u5c04\u4e3a foo \uff1a - action: labelmap regex: __meta_kubernetes_pod_label_(.+)","title":"Promtail"},{"location":"3.k8s/7.logging/promtail/#promtail","text":"","title":"Promtail"},{"location":"3.k8s/7.logging/promtail/#promtail_1","text":"Promtail \u662f Loki \u5b98\u65b9\u652f\u6301\u7684\u65e5\u5fd7\u91c7\u96c6\u7aef\uff0c\u5728\u9700\u8981\u91c7\u96c6\u65e5\u5fd7\u7684\u8282\u70b9\u4e0a\u8fd0\u884c\u91c7\u96c6\u4ee3\u7406\uff0c\u518d\u7edf\u4e00\u53d1\u9001\u5230 Loki \u8fdb\u884c\u5904\u7406\u3002\u9664\u4e86\u4f7f\u7528 Promtail\uff0c\u793e\u533a\u8fd8\u6709\u5f88\u591a\u91c7\u96c6\u65e5\u5fd7\u7684\u7ec4\u4ef6\uff0c\u6bd4\u5982 fluentd\u3001fluent bit\u3001logstash \u7b49\uff0c\u4e5f\u90fd\u652f\u6301\u53d1\u9001\u5230 Loki\u3002 \u4f46\u662f Promtail \u662f\u8fd0\u884c Kubernetes \u65f6\u7684\u9996\u9009\u5ba2\u6237\u7aef\uff0c\u56e0\u4e3a\u4f60\u53ef\u4ee5\u5c06\u5176\u914d\u7f6e\u4e3a\u81ea\u52a8\u4ece Promtail \u8fd0\u884c\u7684\u540c\u4e00\u8282\u70b9\u4e0a\u8fd0\u884c\u7684 Pod \u4e2d\u6293\u53d6\u65e5\u5fd7\u3002Promtail \u548c Prometheus \u5728 Kubernetes \u4e2d\u4e00\u8d77\u8fd0\u884c\uff0c\u8fd8\u53ef\u4ee5\u5b9e\u73b0\u975e\u5e38\u5f3a\u5927\u7684\u8c03\u8bd5\u529f\u80fd\uff0c\u5982\u679c Prometheus \u548c Promtail \u4f7f\u7528\u76f8\u540c\u7684\u6807\u7b7e\uff0c\u7528\u6237\u8fd8\u53ef\u4ee5\u4f7f\u7528 Grafana \u6839\u636e\u6807\u7b7e\u96c6\u5728\u6307\u6807\u548c\u65e5\u5fd7\u4e4b\u95f4\u5207\u6362\u3002 \u6b64\u5916\u5982\u679c\u4f60\u60f3\u4ece\u65e5\u5fd7\u4e2d\u63d0\u53d6\u6307\u6807\uff0c\u6bd4\u5982\u8ba1\u7b97\u67d0\u4e2a\u7279\u5b9a\u4fe1\u606f\u7684\u51fa\u73b0\u6b21\u6570\uff0cPromtail \u4e5f\u662f\u975e\u5e38\u53cb\u597d\u7684\u3002\u672c\u6587\u5c06\u4ecb\u7ecd Promtail \u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\u4ee5\u53ca\u4e86\u89e3\u4e0b\u5982\u4f55\u8bbe\u7f6e Promtail \u6765\u5904\u7406\u4f60\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff0c\u5305\u62ec\u63d0\u53d6\u6307\u6807\u4e0e\u6807\u7b7e\u7b49\u3002","title":"Promtail"},{"location":"3.k8s/7.logging/promtail/#_1","text":"Promtail \u662f\u8d1f\u8d23\u6536\u96c6\u65e5\u5fd7\u53d1\u9001\u7ed9 loki \u7684\u4ee3\u7406\u7a0b\u5e8f\u3002Promtail \u9ed8\u8ba4\u901a\u8fc7\u4e00\u4e2a config.yaml \u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\uff0c\u5176\u4e2d\u5305\u542b Promtail \u670d\u52a1\u7aef\u4fe1\u606f\u3001\u5b58\u50a8\u4f4d\u7f6e\u4ee5\u53ca\u5982\u4f55\u4ece\u6587\u4ef6\u4e2d\u6293\u53d6\u65e5\u5fd7\u7b49\u914d\u7f6e\u3002 \u8981\u6307\u5b9a\u52a0\u8f7d\u54ea\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u53ea\u9700\u8981\u5728\u547d\u4ee4\u884c\u4e0b\u901a\u8fc7 -config.file \u53c2\u6570\u4f20\u9012 YAML \u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u3002\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u73af\u5883\u53d8\u91cf\u5f15\u7528\u6765\u8bbe\u7f6e\u9700\u8981\u7684\u914d\u7f6e\uff0c\u4f46\u662f\u9700\u8981\u5728\u547d\u4ee4\u884c\u4e2d\u914d\u7f6e -config.expand-env=true \u3002 \u7136\u540e\u53ef\u4ee5\u4f7f\u7528 ${VAR} \u6765\u914d\u7f6e\uff0c\u5176\u4e2d VAR \u662f\u73af\u5883\u53d8\u91cf\u7684\u540d\u79f0\uff0c\u6bcf\u4e2a\u53d8\u91cf\u7684\u5f15\u7528\u5728\u542f\u52a8\u65f6\u88ab\u73af\u5883\u53d8\u91cf\u7684\u503c\u66ff\u6362\uff0c\u66ff\u6362\u662f\u533a\u5206\u5927\u5c0f\u5199\u7684\uff0c\u800c\u4e14\u5728 YAML \u6587\u4ef6\u88ab\u89e3\u6790\u4e4b\u524d\u53d1\u751f\uff0c\u5bf9\u672a\u5b9a\u4e49\u53d8\u91cf\u7684\u5f15\u7528\u5c06\u88ab\u66ff\u6362\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u9664\u975e\u4f60\u6307\u5b9a\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u503c\u6216\u81ea\u5b9a\u4e49\u7684\u9519\u8bef\u6587\u672c\uff0c\u8981\u6307\u5b9a\u4e00\u4e2a\u9ed8\u8ba4\u503c\uff1a ${VAR:default_value} \u5176\u4e2d default_value \u662f\u5728\u73af\u5883\u53d8\u91cf\u672a\u5b9a\u4e49\u7684\u60c5\u51b5\u4e0b\u8981\u4f7f\u7528\u7684\u9ed8\u8ba4\u503c\u3002 \u9ed8\u8ba4\u7684 config.yaml \u914d\u7f6e\u6587\u4ef6\u652f\u6301\u7684\u5185\u5bb9\u683c\u5f0f\u4e3a\uff1a # \u914d\u7f6e Promtail \u670d\u52a1\u7aef [server: <server_config>] # \u63cf\u8ff0 Promtail \u5982\u4f55\u8fde\u63a5\u5230 Loki \u7684\u591a\u4e2a\u5b9e\u4f8b\uff0c\u5411\u6bcf\u4e2a\u5b9e\u4f8b\u53d1\u9001\u65e5\u5fd7\u3002 # \u53d1\u9001\u662f\u5728\u5355\u7ebf\u7a0b\u4e0a\u5b8c\u6210\u7684! # \u5982\u679c\u4f60\u60f3\u5411\u591a\u4e2a\u8fdc\u7a0b Loki \u5b9e\u4f8b\u53d1\u9001\uff0c\u4e00\u822c\u5efa\u8bae\u5e76\u884c\u8fd0\u884c\u591a\u4e2a promtail \u5ba2\u6237\u7aef\u3002 client: <client_config> # \u63cf\u8ff0\u4e86\u5982\u4f55\u5c06\u8bfb\u53d6\u7684\u6587\u4ef6\u504f\u79fb\u91cf\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a [positions: <position_config>] # \u6293\u53d6\u65e5\u5fd7\u914d\u7f6e scrape_configs: - [<scrape_config>] # \u914d\u7f6e\u88ab watch \u7684\u76ee\u6807\u5982\u4f55 tailed [target_config: <target_config>] server server \u5c5e\u6027\u914d\u7f6e Promtail \u4f5c\u4e3a HTTP \u670d\u52a1\u5668\u7684\u884c\u4e3a\u3002 # \u7981\u7528 HTTP \u548c GRPC \u670d\u52a1 [disable: <boolean> | default = false] # HTTP \u670d\u52a1\u76d1\u542c\u7684\u4e3b\u673a [http_listen_address: <string>] # HTTP \u670d\u52a1\u76d1\u542c\u7684\u7aef\u53e3\uff080\u8868\u793a\u968f\u673a\uff09 [http_listen_port: <int> | default = 80] # gRPC \u670d\u52a1\u76d1\u542c\u4e3b\u673a [grpc_listen_address: <string>] # gRPC \u670d\u52a1\u76d1\u542c\u7684\u7aef\u53e3\uff080\u8868\u793a\u968f\u673a\uff09 [grpc_listen_port: <int> | default = 9095] # \u6ce8\u518c\u6307\u6807\u5904\u7406\u5668 [register_instrumentation: <boolean> | default = true] # \u4f18\u96c5\u9000\u51fa\u8d85\u65f6\u65f6\u95f4 [graceful_shutdown_timeout: <duration> | default = 30s] # HTTP \u670d\u52a1\u8bfb\u53d6\u8d85\u65f6\u65f6\u95f4 [http_server_read_timeout: <duration> | default = 30s] # HTTP \u670d\u52a1\u5199\u5165\u8d85\u65f6\u65f6\u95f4 [http_server_write_timeout: <duration> | default = 30s] # HTTP \u670d\u52a1\u7a7a\u95f2\u8d85\u65f6\u65f6\u95f4 [http_server_idle_timeout: <duration> | default = 120s] # \u53ef\u63a5\u6536\u7684\u6700\u5927 gRPC \u6d88\u606f\u5927\u5c0f [grpc_server_max_recv_msg_size: <int> | default = 4194304] # \u53ef\u53d1\u9001\u7684\u6700\u5927 gRPC \u6d88\u606f\u5927\u5c0f [grpc_server_max_send_msg_size: <int> | default = 4194304] # \u5bf9 gRPC \u8c03\u7528\u7684\u5e76\u53d1\u6d41\u6570\u91cf\u7684\u9650\u5236 (0 = unlimited) [grpc_server_max_concurrent_streams: <int> | default = 100] # \u53ea\u8bb0\u5f55\u7ed9\u5b9a\u4e25\u91cd\u7a0b\u5ea6\u6216\u4ee5\u4e0a\u7684\u4fe1\u606f\uff0c\u652f\u6301\u7684\u503c\uff1a[debug, info, warn, error] [log_level: <string> | default = \"info\"] # \u6240\u6709 API \u8def\u7531\u670d\u52a1\u7684\u57fa\u672c\u8def\u5f84(e.g., /v1/). [http_path_prefix: <string>] # \u76ee\u6807\u7ba1\u7406\u5668\u68c0\u6d4b promtail \u53ef\u8bfb\u7684\u6807\u5fd7\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a false \u68c0\u67e5\u5c06\u88ab\u5ffd\u7565 [health_check_target: <bool> | default = true] client client \u5c5e\u6027\u914d\u7f6e Promtail \u5982\u4f55\u8fde\u63a5\u5230 Loki \u7684\u5b9e\u4f8b\u3002 # Loki \u6b63\u5728\u76d1\u542c\u7684 URL\uff0c\u5728 Loki \u4e2d\u8868\u793a\u4e3a http_listen_address \u548c http_listen_port # \u5982\u679c Loki \u5728\u5fae\u670d\u52a1\u6a21\u5f0f\u4e0b\u8fd0\u884c\uff0c\u8fd9\u5c31\u662f Distributor \u7684 URL\uff0c\u9700\u8981\u5305\u62ec push API \u7684\u8def\u5f84\u3002 # \u4f8b\u5982\uff1ahttp://example.com:3100/loki/api/v1/push url: <string> # \u9ed8\u8ba4\u4f7f\u7528\u7684\u79df\u6237 ID\uff0c\u7528\u4e8e\u63a8\u9001\u65e5\u5fd7\u5230 Loki\u3002 # \u5982\u679c\u7701\u7565\u6216\u4e3a\u7a7a\uff0c\u5219\u4f1a\u5047\u8bbe Loki \u5728\u5355\u79df\u6237\u6a21\u5f0f\u4e0b\u8fd0\u884c\uff0c\u4e0d\u53d1\u9001 X-Scope-OrgID \u5934\u3002 [tenant_id: <string>] # \u53d1\u9001\u4e00\u6279\u65e5\u5fd7\u524d\u7684\u6700\u5927\u7b49\u5f85\u65f6\u95f4\uff0c\u5373\u4f7f\u8be5\u6279\u6b21\u65e5\u5fd7\u6570\u636e\u672a\u6ee1\u3002 [batchwait: <duration> | default = 1s] # \u5728\u5411 Loki \u53d1\u9001\u6279\u5904\u7406\u4e4b\u524d\u8981\u79ef\u7d2f\u7684\u6700\u5927\u6279\u5904\u7406\u91cf\uff08\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\uff09\u3002 [batchsize: <int> | default = 102400] # \u5982\u679c\u4f7f\u7528\u4e86 basic auth \u8ba4\u8bc1\uff0c\u5219\u9700\u8981\u914d\u7f6e\u7528\u6237\u540d\u548c\u5bc6\u7801 basic_auth: [username: <string>] [password: <string>] # \u5305\u542bbasic auth\u8ba4\u8bc1\u7684\u5bc6\u7801\u6587\u4ef6 [password_file: <filename>] # \u53d1\u9001\u7ed9\u670d\u52a1\u5668\u7684 Bearer token [bearer_token: <secret>] # \u5305\u542b Bearer token \u7684\u6587\u4ef6 [bearer_token_file: <filename>] # \u7528\u6765\u8fde\u63a5\u670d\u52a1\u5668\u7684 HTTP \u4ee3\u7406\u670d\u52a1\u5668 [proxy_url: <string>] # \u5982\u679c\u8fde\u63a5\u5230\u4e00\u4e2a TLS \u670d\u52a1\u5668\uff0c\u914d\u7f6e TLS \u8ba4\u8bc1\u65b9\u5f0f\u3002 tls_config: # \u7528\u6765\u9a8c\u8bc1\u670d\u52a1\u5668\u7684 CA \u6587\u4ef6 [ca_file: <string>] # \u53d1\u9001\u7ed9\u670d\u52a1\u5668\u7528\u4e8e\u5ba2\u6237\u7aef\u8ba4\u8bc1\u7684 cert \u6587\u4ef6 [cert_file: <filename>] # \u53d1\u9001\u7ed9\u670d\u52a1\u5668\u7528\u4e8e\u5ba2\u6237\u7aef\u8ba4\u8bc1\u7684\u5bc6\u94a5\u6587\u4ef6 [key_file: <filename>] # \u9a8c\u8bc1\u670d\u52a1\u5668\u8bc1\u4e66\u4e2d\u7684\u670d\u52a1\u5668\u540d\u79f0\u662f\u8fd9\u4e2a\u503c\u3002 [server_name: <string>] # \u5982\u679c\u4e3a true\uff0c\u5219\u5ffd\u7565\u7531\u672a\u77e5 CA \u7b7e\u7f72\u7684\u670d\u52a1\u5668\u8bc1\u4e66\u3002 [insecure_skip_verify: <boolean> | default = false] # \u914d\u7f6e\u5728\u8bf7\u6c42\u5931\u8d25\u65f6\u5982\u4f55\u91cd\u8bd5\u5bf9 Loki \u7684\u8bf7\u6c42\u3002 # \u9ed8\u8ba4\u7684\u56de\u9000\u5468\u671f\u4e3a\uff1a0.5s, 1s, 2s, 4s, 8s, 16s, 32s, 64s, 128s, 256s(4.267m) # \u5728\u65e5\u5fd7\u4e22\u5931\u4e4b\u524d\u7684\u603b\u65f6\u95f4\u4e3a511.5s(8.5m) backoff_config: # \u91cd\u8bd5\u4e4b\u95f4\u7684\u521d\u59cb\u56de\u9000\u65f6\u95f4 [min_period: <duration> | default = 500ms] # \u91cd\u8bd5\u4e4b\u95f4\u7684\u6700\u5927\u56de\u9000\u65f6\u95f4 [max_period: <duration> | default = 5m] # \u91cd\u8bd5\u7684\u6700\u5927\u6b21\u6570 [max_retries: <int> | default = 10] # \u6dfb\u52a0\u5230\u6240\u6709\u53d1\u9001\u5230 Loki \u7684\u65e5\u5fd7\u4e2d\u7684\u5916\u90e8\u6807\u7b7e # \u4f7f\u7528\u4e00\u4e2a\u7c7b\u4f3c\u4e8e {\"foo\": \"bar\"} \u7684\u6620\u5c04\u6765\u6dfb\u52a0\u4e00\u4e2a foo \u6807\u7b7e\uff0c\u503c\u4e3a bar # \u8fd9\u4e9b\u4e5f\u53ef\u4ee5\u4ece\u547d\u4ee4\u884c\u4e2d\u6307\u5b9a\uff1a-client.external-labels=k1=v1,k2=v2 # \u7531\u547d\u4ee4\u884c\u63d0\u4f9b\u7684\u6807\u7b7e\u5c06\u5e94\u7528\u4e8e\u6240\u6709\u5728 \"clients\" \u90e8\u5206\u7684\u914d\u7f6e\u3002 # \u6ce8\u610f\uff1a\u5982\u679c\u6807\u7b7e\u7684\u952e\u76f8\u540c\uff0c\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u503c\u5c06\u53d6\u4ee3\u547d\u4ee4\u884c\u4e2d\u4e3a\u7279\u5b9a client \u5b9a\u4e49\u7684\u503c external_labels: [ <labelname>: <labelvalue> ... ] # \u7b49\u5f85\u670d\u52a1\u5668\u54cd\u5e94\u4e00\u4e2a\u8bf7\u6c42\u7684\u6700\u957f\u65f6\u95f4 [timeout: <duration> | default = 10s] positions positions \u5c5e\u6027\u914d\u7f6e\u4e86 Promtail \u4fdd\u5b58\u6587\u4ef6\u7684\u4f4d\u7f6e\uff0c\u8868\u793a\u5b83\u5df2\u7ecf\u8bfb\u5230\u4e86\u65e5\u5fd7\u6587\u4ef6\u7684\u4ec0\u4e48\u4f4d\u7f6e\u3002\u5f53 Promtail \u91cd\u65b0\u542f\u52a8\u65f6\u9700\u8981\u5b83\uff0c\u4ee5\u5141\u8bb8\u5b83\u4ece\u4e2d\u65ad\u7684\u5730\u65b9\u7ee7\u7eed\u8bfb\u53d6\u65e5\u5fd7\u3002 # positions \u6587\u4ef6\u7684\u8def\u5f84 [filename: <string> | default = \"/var/log/positions.yaml\"] # \u66f4\u65b0 positions \u6587\u4ef6\u7684\u5468\u671f [sync_period: <duration> | default = 10s] # \u662f\u5426\u5ffd\u7565\u5e76\u8986\u76d6\u88ab\u7834\u574f\u7684 positions \u6587\u4ef6 [ignore_invalid_yaml: <boolean> | default = false] scrape_configs scrape_configs \u914d\u7f6e\u4e86 Promtail \u5982\u4f55\u4f7f\u7528\u6307\u5b9a\u7684\u53d1\u73b0\u65b9\u6cd5\u4ece\u4e00\u7cfb\u5217\u76ee\u6807\u4e2d\u6293\u53d6\u65e5\u5fd7\uff0c\u7c7b\u4f3c\u4e8e Prometheus \u4e2d\u7684\u6293\u53d6\u914d\u7f6e\u3002 # \u4efb\u52a1\u540d\u79f0\uff0c\u7528\u4e8e\u5728 Promtail \u4e2d\u8bc6\u522b\u8be5\u6293\u53d6\u914d\u7f6e\u7684\u540d\u79f0\u3002 job_name: <string> # \u63cf\u8ff0\u5982\u4f55\u5bf9\u76ee\u6807\u65e5\u5fd7\u8fdb\u884c\u7ed3\u6784\u5316 [pipeline_stages: <pipeline_stages>] # \u5982\u4f55\u4ece jounal \u6293\u53d6\u65e5\u5fd7 [journal: <journal_config>] # \u5982\u4f55\u4ece syslog \u6293\u53d6\u65e5\u5fd7 [syslog: <syslog_config>] # \u5982\u4f55\u901a\u8fc7 Loki push API \u63a5\u6536\u65e5\u5fd7 (\u4f8b\u5982\u4ece\u5176\u4ed6 Promtail \u6216 Docker Logging Driver \u4e2d\u83b7\u53d6\u7684\u6570\u636e) [loki_push_api: <loki_push_api_config>] # \u63cf\u8ff0\u4e86\u5982\u4f55 relabel \u76ee\u6807 relabel_configs: - [<relabel_config>] # \u6293\u53d6\u65e5\u5fd7\u9759\u6001\u76ee\u6807\u914d\u7f6e static_configs: - [<static_config>] # \u5305\u542b\u8981\u6293\u53d6\u7684\u76ee\u6807\u6587\u4ef6 file_sd_configs: - [<file_sd_configs>] # \u57fa\u4e8ekubernetes\u7684\u81ea\u52a8\u53d1\u73b0\u914d\u7f6e kubernetes_sd_configs: - [<kubernetes_sd_config>] pipeline_stages pipeline_stages \u7528\u4e8e\u8f6c\u6362\u65e5\u5fd7\u548c\u5b83\u4eec\u7684\u6807\u7b7e\uff0c\u8be5\u7ba1\u9053\u5728\u53d1\u73b0\u64cd\u4f5c\u7ed3\u675f\u540e\u6267\u884c\uff0c pipeline_stages \u5bf9\u8c61\u7531\u4e00\u4e2a\u9636\u6bb5\u5217\u8868\u7ec4\u6210\u3002 - [ <docker> | <cri> | <regex> | <json> | <template> | <match> | <timestamp> | <output> | <labels> | <metrics> | <tenant>, ] \u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4f60\u7528 regex \u6216 json \u9636\u6bb5\u4ece\u65e5\u5fd7\u4e2d\u63d0\u53d6\u6570\u636e\uff0c\u63d0\u53d6\u7684\u6570\u636e\u88ab\u8f6c\u5316\u4e3a\u4e00\u4e2a\u4e34\u65f6\u7684\u5b57\u5178 Map \u5bf9\u8c61\uff0c\u7136\u540e\u8fd9\u4e9b\u6570\u636e\u662f\u53ef\u4ee5\u88ab promtail \u4f7f\u7528\u7684\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f5c\u4e3a\u6807\u7b7e\u7684\u503c\u6216\u4f5c\u4e3a\u8f93\u51fa\u3002\u6b64\u5916\uff0c\u9664\u4e86 docker \u548c cri \u4e4b\u5916\uff0c\u4efb\u4f55\u5176\u4ed6\u9636\u6bb5\u90fd\u53ef\u4ee5\u8bbf\u95ee\u63d0\u53d6\u7684\u6570\u636e\u3002 loki_push_api loki_push_api \u5c5e\u6027\u914d\u7f6e Promtail \u6765\u66b4\u9732\u4e00\u4e2a Loki push API \u670d\u52a1 \uff0c\u6bcf\u4e2a\u914d\u7f6e\u4e86 loki_push_api \u7684\u4efb\u52a1\u90fd\u4f1a\u66b4\u9732\u8fd9\u4e2a API\uff0c\u5e76\u4e14\u9700\u8981\u4e00\u4e2a\u5355\u72ec\u7684\u7aef\u53e3\u3002 # push \u670d\u52a1\u914d\u7f6e\u9009\u9879 [server: <server_config>] # \u6807\u7b7e\u6620\u5c04\uff0c\u7528\u4e8e\u6dfb\u52a0\u5230\u53d1\u9001\u5230 push API \u7684\u6bcf\u4e00\u884c\u65e5\u5fd7\u4e0a labels: [ <labelname>: <labelvalue> ... ] # promtail \u662f\u5426\u5e94\u8be5\u4ece\u4f20\u5165\u7684\u65e5\u5fd7\u4e2d\u83b7\u53d6\u65f6\u95f4\u6233 # \u5f53\u4e3a false \u65f6\uff0cpromtail \u5c06\u628a\u5f53\u524d\u7684\u65f6\u95f4\u6233\u5206\u914d\u7ed9\u65e5\u5fd7 [use_incoming_timestamp: <bool> | default = false] \u6bd4\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\uff0c\u5c06 Promtail \u4f5c\u4e3a\u4e00\u4e2a Push \u63a5\u6536\u5668\u542f\u52a8\uff0c\u5e76\u5c06\u63a5\u53d7\u6765\u81ea\u5176\u4ed6 Promtail \u5b9e\u4f8b\u6216 Docker Logging Driver \u7684\u65e5\u5fd7\u3002 server: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml clients: - url: http://<loki url>:3100/loki/api/v1/push scrape_configs: - job_name: push1 loki_push_api: server: http_listen_port: 3500 grpc_listen_port: 3600 labels: pushserver: push1 \u6ce8\u610f\u5fc5\u987b\u63d0\u4f9b job_name \uff0c\u5e76\u4e14\u5728\u591a\u4e2a loki_push_api \u4e0e scrape_configs \u4e4b\u95f4\u5fc5\u987b\u662f\u552f\u4e00\u7684\uff0c\u5b83\u5c06\u88ab\u7528\u6765\u6ce8\u518c\u76d1\u63a7\u6307\u6807\u3002\u7531\u4e8e\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u5b9e\u4f8b\u88ab\u521b\u5efa\uff0c\u6240\u4ee5 http_listen_port \u548c grpc_listen_port \u5fc5\u987b\u4e0e promtail \u670d\u52a1\u5668\u914d\u7f6e\u90e8\u5206\u4e0d\u540c\uff08\u9664\u975e\u5b83\u88ab\u7981\u7528\uff09\u3002 relabel_configs Relabeling \u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u53ef\u4ee5\u5728\u65e5\u5fd7\u88ab\u6293\u53d6\u4e4b\u524d\u52a8\u6001\u5730\u91cd\u5199\u5176\u6807\u7b7e\u96c6\u3002\u6bcf\u4e2a\u6293\u53d6\u914d\u7f6e\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a relabeling \u6b65\u9aa4\uff0c\u6309\u7167\u5b83\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u51fa\u73b0\u7684\u987a\u5e8f\u5e94\u7528\u4e8e\u6bcf\u4e2a\u76ee\u6807\u7684\u6807\u7b7e\u96c6\u3002\u548c Prometheus \u4e2d\u7684 Relabel \u64cd\u4f5c\u4e5f\u975e\u5e38\u7c7b\u4f3c\u3002 \u5728 relabeling \u4e4b\u540e\uff0c\u5982\u679c instance \u6807\u7b7e\u5728 relabeling \u7684\u65f6\u5019\u6ca1\u6709\u88ab\u8bbe\u7f6e\uff0c\u5219\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a __address__ \u7684\u503c\u3002 __param_<name> \u6807\u7b7e\u88ab\u8bbe\u7f6e\u4e3a\u7b2c\u4e00\u4e2a\u4f20\u9012\u7684 URL \u53c2\u6570 <name> \u7684\u503c\u3002 \u5728 relabeling \u9636\u6bb5\uff0c\u4ee5 __meta_ \u4e3a\u524d\u7f00\u7684\u989d\u5916\u6807\u7b7e\u4e5f\u662f\u53ef\u7528\u7684\uff0c\u5b83\u4eec\u662f\u7531\u63d0\u4f9b\u76ee\u6807\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\u8bbe\u7f6e\u7684\uff0c\u4e0d\u540c\u7684\u673a\u5236\u4e4b\u95f4\u6709\u6240\u4e0d\u540c\u3002 \u5728\u76ee\u6807 relabeling \u5b8c\u6210\u540e\uff0c\u4ee5 __ \u5f00\u5934\u7684\u6807\u7b7e\u5c06\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u3002 \u5982\u679c\u4e00\u4e2a relabeling \u64cd\u4f5c\u53ea\u9700\u8981\u4e34\u65f6\u5b58\u50a8\u4e00\u4e2a\u6807\u7b7e\u503c\uff08\u4f5c\u4e3a\u540e\u7eed\u91cd\u65b0\u6807\u6ce8\u6b65\u9aa4\u7684\u8f93\u5165\uff09\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 __tmp \u6807\u7b7e\u540d\u79f0\u524d\u7f00\u3002 # \u4ece\u73b0\u6709\u6807\u7b7e\u4e2d\u9009\u62e9 values \u503c\u7684\u6e90\u6807\u7b7e # \u5b83\u4eec\u7684\u5185\u5bb9\u4f7f\u7528\u914d\u7f6e\u7684\u5206\u9694\u7b26\u8fde\u63a5\u8d77\u6765\uff0c\u5e76\u4e0e\u914d\u7f6e\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u76f8\u5339\u914d\uff0c\u4ee5\u8fdb\u884c\u66ff\u6362\u3001\u4fdd\u7559\u548c\u5220\u9664\u64cd\u4f5c\u3002 [ source_labels: '[' <labelname> [, ...] ']' ] # \u8fde\u63a5\u6e90\u6807\u7b7e\u503c\u4e4b\u95f4\u7684\u5206\u9694\u7b26 [ separator: <string> | default = ; ] # \u5728\u4e00\u4e2a replace \u66ff\u6362\u64cd\u4f5c\u540e\u7ed3\u679c\u503c\u88ab\u5199\u5165\u7684\u6807\u7b7e # \u5b83\u5bf9\u66ff\u6362\u52a8\u4f5c\u662f\u5f3a\u5236\u6027\u7684\uff0cRegex \u6355\u83b7\u7ec4\u662f\u53ef\u7528\u7684\u3002 [ target_label: <labelname> ] # \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u63d0\u53d6\u7684\u503c\u4e0e\u4e4b\u5339\u914d [ regex: <regex> | default = (.*) ] [ modulus: <uint64> ] # Replacement \u503c\uff1a\u5982\u679c\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\uff0c\u5219\u5bf9\u5176\u8fdb\u884c regex \u66ff\u6362 [ replacement: <string> | default = $1 ] # \u6839\u636e\u6b63\u5219\u5339\u914d\u7ed3\u679c\u6267\u884c\u7684\u52a8\u4f5c [ action: <relabel_action> | default = replace ] <regex> \u662f\u4efb\u4f55\u6709\u6548\u7684 RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5b83\u662f replace \u3001 keep \u3001 drop \u3001 labelmap \u3001 labeldrop \u548c labelkeep \u64cd\u4f5c\u7684\u5fc5\u8981\u6761\u4ef6\u3002 <relabel_action> \u51b3\u5b9a\u4e86\u8981\u91c7\u53d6\u7684 relabeling \u52a8\u4f5c\uff1a replace \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u8fde\u63a5\u7684 source_labels \u5339\u914d\uff0c\u7136\u540e\u8bbe\u7f6e target_label \u4e3a replacement \uff0c\u7528 replacement \u4e2d\u7684\u5339\u914d\u7ec4\u5f15\u7528\uff08${1}\u3001${2}\u2026\uff09\u66ff\u6362\u5176\u503c\uff0c\u5982\u679c\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d\uff0c\u5219\u4e0d\u4f1a\u8fdb\u884c\u66ff\u6362\u3002 keep \uff1a\u5220\u9664\u90a3\u4e9b regex \u4e0e source_labels \u4e0d\u5339\u914d\u7684\u76ee\u6807\u3002 drop \uff1a\u5220\u9664\u4e0e regex \u76f8\u5339\u914d\u7684 source_labels \u76ee\u6807\u3002 hashmod \uff1a\u5c06 target_label \u8bbe\u7f6e\u4e3a source_labels \u7684\u54c8\u5e0c\u503c\u7684\u6a21\u3002 labelmap \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u79f0\u5339\u914d\uff0c\u7136\u540e\u5c06\u5339\u914d\u7684\u6807\u7b7e\u503c\u590d\u5236\u5230\u7531 replacement \u7ed9\u51fa\u7684\u6807\u7b7e\u540d\u4e2d\uff0creplacement \u4e2d\u7684\u5339\u914d\u7ec4\u5f15\u7528\uff08${1}, ${2}, ...\uff09\u7531\u5176\u503c\u4ee3\u66ff\u3002 labeldrop \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u79f0\u5339\u914d\uff0c\u4efb\u4f55\u5339\u914d\u7684\u6807\u7b7e\u90fd\u5c06\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u3002 labelkeep \uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u79f0\u5339\u914d\uff0c\u4efb\u4f55\u4e0d\u5339\u914d\u7684\u6807\u7b7e\u5c06\u88ab\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u3002 static_configs static_configs \u9759\u6001\u914d\u7f6e\u5141\u8bb8\u6307\u5b9a\u4e00\u4e2a\u76ee\u6807\u5217\u8868\u548c\u6807\u7b7e\u96c6\uff1a # \u914d\u7f6e\u53d1\u73b0\u5728\u5f53\u524d\u8282\u70b9\u4e0a\u67e5\u627e\uff0c\u8fd9\u662f Prometheus \u6240\u8981\u6c42\u7684\uff0c\u4f46\u5e76\u4e0d\u9002\u7528\u4e8e Promtail\uff0c\u5b83\u53ea\u80fd\u67e5\u770b\u672c\u5730\u673a\u5668\u4e0a\u7684\u6587\u4ef6\u3002 # \u56e0\u6b64\uff0c\u5b83\u5e94\u8be5\u53ea\u6709 localhost \u7684\u503c\uff0c\u6216\u8005\u4e0d\u6307\u5b9a\uff0cPromtail \u4f1a\u4f7f\u7528 localhost \u7684\u9ed8\u8ba4\u503c\u3002 targets: - localhost # \u5b9a\u4e49\u4e00\u4e2a\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6587\u4ef6\u548c\u4e00\u7ec4\u53ef\u9009\u7684\u9644\u52a0\u6807\u7b7e\uff0c\u5e94\u7528\u4e8e\u7531 __path__ \u5b9a\u4e49\u7684\u6587\u4ef6\u65e5\u5fd7\u6d41\u3002 labels: # \u8981\u52a0\u8f7d\u65e5\u5fd7\u7684\u8def\u5f84\uff0c\u53ef\u4ee5\u4f7f\u7528 glob \u6a21\u5f0f(e.g., /var/log/*.log). __path__: <string> # \u6dfb\u52a0\u7684\u989d\u5916\u6807\u7b7e [ <labelname>: <labelvalue> ... ] \u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u9759\u6001\u914d\u7f6e\uff1a server: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /var/log/positions.yaml # \u8fd9\u4e2a\u4f4d\u7f6e\u9700\u8981\u662f\u53ef\u4ee5\u88ab promtail \u5199\u5165\u7684 client: url: http://<loki url>:3100/loki/api/v1/push # \u6293\u53d6\u914d\u7f6e scrape_configs: - job_name: system pipeline_stages: static_configs: - targets: - localhost labels: job: varlogs # \u5728 Prometheus\u4e2d\uff0cjob \u6807\u7b7e\u5bf9\u4e8e\u8fde\u63a5\u6307\u6807\u548c\u65e5\u5fd7\u5f88\u6709\u7528 host: yourhost # `host` \u6807\u7b7e\u53ef\u4ee5\u5e2e\u52a9\u8bc6\u522b\u65e5\u5fd7\u6765\u6e90 __path__: /var/log/*.log # \u8def\u5f84\u5339\u914d\u4f7f\u7528\u4e86\u4e00\u4e2a\u7b2c\u4e09\u65b9\u5e93: https://github.com/bmatcuk/doublestar file_sd_config \u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u63d0\u4f9b\u4e86\u4e00\u79cd\u66f4\u901a\u7528\u7684\u65b9\u5f0f\u6765\u914d\u7f6e\u9759\u6001\u76ee\u6807\u3002\u5b83\u8bfb\u53d6\u4e00\u7ec4\u5305\u542b\u96f6\u4e2a\u6216\u591a\u4e2a <static_config> \u5217\u8868\u7684\u6587\u4ef6\u3002\u5bf9\u6240\u6709\u5b9a\u4e49\u6587\u4ef6\u7684\u6539\u53d8\u901a\u8fc7\u76d1\u89c6\u78c1\u76d8\u53d8\u5316\u6765\u5e94\u7528\u3002\u6587\u4ef6\u53ef\u4ee5\u4ee5 YAML \u6216 JSON \u683c\u5f0f\u63d0\u4f9b\uff0cJSON \u6587\u4ef6\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u9759\u6001\u914d\u7f6e\u7684\u5217\u8868\uff0c\u4f7f\u7528\u8fd9\u79cd\u683c\u5f0f\u3002 [ { \"targets\": [ \"localhost\" ], \"labels\": { \"__path__\": \"<string>\", ... \"<labelname>\": \"<labelvalue>\", ... } }, ... ] \u6b64\u5916\u6587\u4ef6\u5185\u5bb9\u4e5f\u5c06\u4ee5\u6307\u5b9a\u7684\u5237\u65b0\u95f4\u9694\u5b9a\u671f\u91cd\u65b0\u8bfb\u53d6\u3002\u5728 relabeling \u6807\u8bb0\u9636\u6bb5\uff0c\u6bcf\u4e2a\u76ee\u6807\u90fd\u6709\u4e00\u4e2a\u5143\u6807\u7b7e __meta_filepath \uff0c\u5b83\u7684\u503c\u88ab\u8bbe\u7f6e\u4e3a\u88ab\u63d0\u53d6\u7684\u76ee\u6807\u6587\u4ef6\u8def\u5f84\u3002 # \u4ece\u4e2d\u63d0\u53d6\u76ee\u6807\u6587\u4ef6\u7684\u6a21\u5f0f\u3002 files: [ - <filename_pattern> ... ] # \u91cd\u65b0\u8bfb\u53d6\u6587\u4ef6\u7684\u5237\u65b0\u9891\u7387 [ refresh_interval: <duration> | default = 5m ] \u5176\u4e2d <filename_pattern> \u53ef\u4ee5\u662f\u4e00\u4e2a\u4ee5 .json \u3001 .yml \u6216 .yaml \u7ed3\u5c3e\u7684\u8def\u5f84\uff0c\u6700\u540e\u4e00\u4e2a\u8def\u5f84\u6bb5\u53ef\u4ee5\u5305\u542b\u4e00\u4e2a\u5339\u914d\u4efb\u4f55\u5b57\u7b26\u5e8f\u5217\u7684 * \uff0c\u4f8b\u5982 my/path/tg_*.json \u3002 kubernetes_sd_config \u8be5\u53d1\u73b0\u65b9\u5f0f\u5141\u8bb8\u4ece Kubernetes \u7684 REST API \u4e2d\u83b7\u53d6\u6293\u53d6\u7684\u76ee\u6807\uff0c\u5e76\u59cb\u7ec8\u4e0e\u96c6\u7fa4\u72b6\u6001\u4fdd\u6301\u540c\u6b65\u3002\u5173\u4e8e Kubernetes \u53d1\u73b0\u7684\u914d\u7f6e\u9009\u9879\uff0c\u5982\u4e0b\u6240\u793a\uff1a # Kubernetes API \u5730\u5740 # \u5982\u679c\u7559\u7a7a\uff0cPrometheus \u5c06\u88ab\u5047\u5b9a\u5728\u96c6\u7fa4\u5185\u8fd0\u884c\uff0c\u5e76\u5c06\u81ea\u52a8\u53d1\u73b0 API \u670d\u52a1\u5668\u5e76\u4f7f\u7528 pod \u7684 CA \u8bc1\u4e66\u548c bearer token \u6587\u4ef6\uff08\u5728 /var/run/secrets/kubernetes.io/serviceaccount/ \u76ee\u5f55\u4e0b\u9762\uff09 [ api_server: <host> ] # \u53d1\u73b0\u7684 Kubernetes \u89d2\u8272 role: <role> # \u53ef\u9009\u7684\u8ba4\u8bc1\u4fe1\u606f basic_auth: [ username: <string> ] [ password: <secret> ] [ password_file: <string> ] [ bearer_token: <secret> ] [ bearer_token_file: <filename> ] [ proxy_url: <string> ] # TLS \u914d\u7f6e tls_config: [ <tls_config> ] # \u53ef\u9009\u7684\u547d\u540d\u7a7a\u95f4\u53d1\u73b0\uff0c\u5982\u679c\u7701\u7565\uff0c\u5c06\u4f7f\u7528\u6240\u6709\u547d\u540d\u7a7a\u95f4\u3002 namespaces: names: [ - <string> ] \u5176\u4e2d <role> \u5fc5\u987b\u662f endpoints \u3001 service \u3001 pod \u3001 node \u6216 ingress \u3002\u5177\u4f53\u7684\u914d\u7f6e\u4f7f\u7528\u53ef\u4ee5\u5b8c\u5168\u53c2\u8003 Prometheus \u4e2d\u7684\u57fa\u4e8e Kubernetes \u7684\u53d1\u73b0\u673a\u5236\uff0c\u53ef\u4ee5\u67e5\u770b Prometheus \u81ea\u52a8\u53d1\u73b0\u914d\u7f6e\u6587\u4ef6\uff1a https://github.com/prometheus/prometheus/blob/main/documentation/examples/prometheus-kubernetes.yml \u4e86\u89e3\u66f4\u591a\u914d\u7f6e\u3002","title":"\u914d\u7f6e"},{"location":"3.k8s/7.logging/promtail/#pipeline","text":"\u5728 Promtail \u4e2d\u4e00\u4e2a pipeline \u7ba1\u9053\u88ab\u7528\u6765\u8f6c\u6362\u4e00\u4e2a\u5355\u4e00\u7684\u65e5\u5fd7\u884c\u3001\u6807\u7b7e\u548c\u65f6\u95f4\u6233\u3002\u4e00\u4e2a pipeline \u7ba1\u9053\u662f\u7531\u4e00\u7ec4 stages \u9636\u6bb5\u7ec4\u6210\u7684\uff0c\u5728 Promtail \u914d\u7f6e\u4e2d\u4e00\u5171\u6709 4 \u79cd\u7c7b\u578b\u7684 stages\u3002 Parsing stages (\u89e3\u6790\u9636\u6bb5) \u7528\u4e8e\u89e3\u6790\u5f53\u524d\u7684\u65e5\u5fd7\u884c\u5e76\u4ece\u4e2d\u63d0\u53d6\u6570\u636e\uff0c\u63d0\u53d6\u7684\u6570\u636e\u53ef\u4f9b\u5176\u4ed6\u9636\u6bb5\u4f7f\u7528\u3002 Transform stages (\u8f6c\u6362\u9636\u6bb5) \u7528\u4e8e\u5bf9\u4e4b\u524d\u9636\u6bb5\u63d0\u53d6\u7684\u6570\u636e\u8fdb\u884c\u8f6c\u6362\u3002 Action stages (\u5904\u7406\u9636\u6bb5) \u7528\u4e8e\u4ece\u4ee5\u524d\u9636\u6bb5\u4e2d\u63d0\u53d6\u6570\u636e\u5e76\u5bf9\u5176\u8fdb\u884c\u5904\u7406\uff0c\u5305\u62ec\uff1a \u6dfb\u52a0\u6216\u4fee\u6539\u73b0\u6709\u65e5\u5fd7\u884c\u6807\u7b7e \u66f4\u6539\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233 \u4fee\u6539\u65e5\u5fd7\u884c\u5185\u5bb9 \u5728\u63d0\u53d6\u7684\u6570\u636e\u57fa\u7840\u4e0a\u521b\u5efa\u4e00\u4e2a metrics \u6307\u6807 Filtering stages (\u8fc7\u6ee4\u9636\u6bb5) \u53ef\u9009\u62e9\u5e94\u7528\u4e00\u4e2a\u9636\u6bb5\u7684\u5b50\u96c6\uff0c\u6216\u6839\u636e\u4e00\u4e9b\u6761\u4ef6\u5220\u9664\u65e5\u5fd7\u6570\u636e\u3002 \u4e00\u4e2a\u5178\u578b\u7684 pipeline \u5c06\u4ece\u89e3\u6790\u9636\u6bb5\u5f00\u59cb\uff08\u5982 regex \u6216 json \u9636\u6bb5\uff09\u4ece\u65e5\u5fd7\u884c\u4e2d\u63d0\u53d6\u6570\u636e\u3002\u7136\u540e\u6709\u4e00\u7cfb\u5217\u7684\u5904\u7406\u9636\u6bb5\u914d\u7f6e\uff0c\u5bf9\u63d0\u53d6\u7684\u6570\u636e\u8fdb\u884c\u5904\u7406\u3002\u6700\u5e38\u89c1\u7684\u5904\u7406\u9636\u6bb5\u662f\u4e00\u4e2a labels stage \u6807\u7b7e\u9636\u6bb5\uff0c\u5c06\u63d0\u53d6\u7684\u6570\u636e\u8f6c\u5316\u4e3a\u6807\u7b7e\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\u73b0\u5728 pipeline \u4e0d\u80fd\u7528\u4e8e\u91cd\u590d\u7684\u65e5\u5fd7\uff0c\u4f8b\u5982\uff0cLoki \u5c06\u591a\u6b21\u6536\u5230\u540c\u4e00\u6761\u65e5\u5fd7\u884c\uff1a \u4ece\u540c\u4e00\u6587\u4ef6\u4e2d\u8bfb\u53d6\u7684\u4e24\u4e2a\u6293\u53d6\u914d\u7f6e \u6587\u4ef6\u4e2d\u91cd\u590d\u7684\u65e5\u5fd7\u884c\u88ab\u53d1\u9001\u5230\u4e00\u4e2a pipeline\uff0c\u4e0d\u4f1a\u505a\u91cd\u590d\u6570\u636e\u5220\u9664 \u7136\u540e\uff0cLoki \u4f1a\u5728\u67e5\u8be2\u65f6\u5bf9\u90a3\u4e9b\u5177\u6709\u5b8c\u5168\u76f8\u540c\u7684\u7eb3\u79d2\u65f6\u95f4\u6233\u3001\u6807\u7b7e\u4e0e\u65e5\u5fd7\u5185\u5bb9\u7684\u65e5\u5fd7\u8fdb\u884c\u4e00\u4e9b\u91cd\u590d\u6570\u636e\u5220\u9664\u3002 \u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\u53ef\u4ee5\u5f88\u597d\u5730\u8bf4\u660e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 pipeline \u6765\u5bf9\u65e5\u5fd7\u884c\u6570\u636e\u5b9e\u73b0\u4ec0\u4e48\u529f\u80fd\uff1a scrape_configs: - job_name: kubernetes-pods-name kubernetes_sd_configs: .... pipeline_stages: # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u88ab\u6293\u53d6\u76ee\u6807\u6709\u4e00\u4e2a\u6807\u7b7e\u540d\u4e3a name \u4e14\u503c\u4e3a promtail \u5730\u65f6\u5019\u624d\u4f1a\u6267\u884c - match: selector: '{name=\"promtail\"}' stages: # regex \u9636\u6bb5\u89e3\u6790\u51fa\u4e00\u4e2a level\u3001timestamp \u4e0e component\uff0c\u5728\u8be5\u9636\u6bb5\u7ed3\u675f\u65f6\uff0c\u8fd9\u51e0\u4e2a\u503c\u53ea\u4e3a pipeline \u5185\u90e8\u8bbe\u7f6e\uff0c\u5728\u4ee5\u540e\u5730\u9636\u6bb5\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u503c\u5e76\u51b3\u5b9a\u5982\u4f55\u5904\u7406\u4ed6\u4eec\u3002 - regex: expression: '.*level=(?P<level>[a-zA-Z]+).*ts=(?P<timestamp>[T\\d-:.Z]*).*component=(?P<component>[a-zA-Z]+)' # labels \u9636\u6bb5\u4ece\u524d\u9762 regex \u9636\u6bb5\u83b7\u53d6 level\u3001component \u503c\uff0c\u5e76\u5c06\u4ed6\u4eec\u53d8\u6210\u4e00\u4e2a\u6807\u7b7e\uff0c\u6bd4\u5982 level=error \u53ef\u80fd\u5c31\u662f\u8fd9\u4e2a\u9636\u6bb5\u6dfb\u52a0\u7684\u4e00\u4e2a\u6807\u7b7e\u3002 - labels: level: component: # \u6700\u540e\uff0c\u65f6\u95f4\u6233\u9636\u6bb5\u91c7\u7528\u4ece regex \u63d0\u53d6\u5730 timestamp\uff0c\u5e76\u5c06\u5176\u53d8\u6210\u65e5\u5fd7\u7684\u65b0\u65f6\u95f4\u6233\uff0c\u5e76\u89e3\u6790\u4e3a RFC3339Nano \u683c\u5f0f\u3002 - timestamp: format: RFC3339Nano source: timestamp # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u6293\u53d6\u7684\u76ee\u6807\u6807\u7b7e\u4e3a name\uff0c\u503c\u4e3a nginx\uff0c\u5e76\u4e14\u65e5\u5fd7\u884c\u4e2d\u5305\u542b GET \u5b57\u6837\u7684\u65f6\u5019\u624d\u4f1a\u6267\u884c - match: selector: '{name=\"nginx\"} |= \"GET\"' stages: # regex \u9636\u6bb5\u901a\u8fc7\u5339\u914d\u4e00\u4e9b\u503c\u6765\u63d0\u53d6\u4e00\u4e2a\u65b0\u7684 output \u503c\u3002 - regex: expression: \\w{1,3}.\\w{1,3}.\\w{1,3}.\\w{1,3}(?P<output>.*) # output \u8f93\u51fa\u9636\u6bb5\u901a\u8fc7\u5c06\u6355\u83b7\u7684\u65e5\u5fd7\u884c\u8bbe\u7f6e\u4e3a\u6765\u81ea\u4e0a\u9762 regex \u9636\u6bb5\u7684\u8f93\u51fa\u503c\u6765\u66f4\u6539\u5176\u5185\u5bb9\u3002 - output: source: output # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u6293\u53d6\u5230\u76ee\u6807\u4e2d\u6709\u6807\u7b7e name\uff0c\u503c\u4e3a jaeger-agent \u65f6\u624d\u4f1a\u6267\u884c\u3002 - match: selector: '{name=\"jaeger-agent\"}' stages: # JSON \u9636\u6bb5\u5c06\u65e5\u5fd7\u884c\u4f5c\u4e3a JSON \u5b57\u7b26\u4e32\u8bfb\u53d6\uff0c\u5e76\u4ece\u5bf9\u8c61\u4e2d\u63d0\u53d6 level \u5b57\u6bb5\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u7684\u9636\u6bb5\u4e2d\u4f7f\u7528\u3002 - json: expressions: level: level # \u5c06\u4e0a\u4e00\u4e2a\u9636\u6bb5\u4e2d\u7684 level \u503c\u53d8\u6210\u4e00\u4e2a\u6807\u7b7e\u3002 - labels: level: - job_name: kubernetes-pods-app kubernetes_sd_configs: .... pipeline_stages: # \u8fd9\u4e2a\u9636\u6bb5\u53ea\u6709\u5728\u88ab\u6293\u53d6\u7684\u76ee\u6807\u7684\u6807\u7b7e\u4e3a \"app\"\uff0c\u540d\u79f0\u4e3a grafana \u6216 prometheus \u65f6\u624d\u4f1a\u6267\u884c\u3002 - match: selector: '{app=~\"grafana|prometheus\"}' stages: # regex \u9636\u6bb5\u5c06\u63d0\u53d6\u4e00\u4e2a level \u548c component \u503c\uff0c\u4f9b\u540e\u9762\u7684\u9636\u6bb5\u4f7f\u7528\uff0c\u5141\u8bb8 level \u88ab\u5b9a\u4e49\u4e3a lvl=<level> \u6216 level=<level>\uff0c\u7ec4\u4ef6\u88ab\u5b9a\u4e49\u4e3a logger=<component> \u6216 component=<component> - regex: expression: \".*(lvl|level)=(?P<level>[a-zA-Z]+).*(logger|component)=(?P<component>[a-zA-Z]+)\" # \u7136\u540e\u6807\u7b7e\u9636\u6bb5\u5c06\u4ece\u4e0a\u9762 regex \u9636\u6bb5\u63d0\u53d6\u7684 level \u548c component \u53d8\u4e3a\u6807\u7b7e\u3002 - labels: level: component: # \u53ea\u6709\u5f53\u88ab\u6293\u53d6\u7684\u76ee\u6807\u6709\u4e00\u4e2a\u6807\u7b7e \"app\"\uff0c\u5176\u503c\u4e3a \"some-app\"\uff0c\u5e76\u4e14\u65e5\u5fd7\u884c\u4e0d\u5305\u542b \"info\" \u4e00\u8bcd\u65f6\uff0c\u8fd9\u4e2a\u9636\u6bb5\u624d\u4f1a\u6267\u884c\u3002 - match: selector: '{app=\"some-app\"} != \"info\"' stages: # regex \u9636\u6bb5\u5c1d\u8bd5\u901a\u8fc7\u67e5\u627e\u65e5\u5fd7\u4e2d\u7684 panic \u6765\u63d0\u53d6 panic \u4fe1\u606f - regex: expression: \".*(?P<panic>panic: .*)\" # metrics \u9636\u6bb5\u5c06\u589e\u52a0\u4e00\u4e2a Promtail \u66b4\u9732\u7684 panic_total \u6307\u6807\uff0c\u53ea\u6709\u5f53\u4ece\u4e0a\u9762\u7684 regex \u9636\u6bb5\u83b7\u53d6\u5230 panic \u503c\u7684\u65f6\u5019\uff0c\u8be5 Counter \u624d\u4f1a\u589e\u52a0\u3002 - metrics: panic_total: type: Counter description: \"total count of panic\" source: panic config: action: inc \u4e0b\u9762\u6211\u4eec\u5148\u7b80\u5355\u63cf\u8ff0\u4e0b\u6bcf\u4e2a\u9636\u6bb5\u53ef\u4ee5\u4f7f\u7528\u7684\u6570\u636e\u6709\u54ea\u4e9b\u3002 \u6807\u7b7e\u96c6 \uff1a\u5f53\u524d\u65e5\u5fd7\u884c\u7684\u6807\u7b7e\u96c6\u5408\uff0c\u521d\u59cb\u5316\u662f\u4e0e\u65e5\u5fd7\u4e00\u8d77\u88ab\u6293\u53d6\u7684\u6807\u7b7e\u96c6\uff0c\u6807\u7b7e\u96c6\u53ea\u7531\u5904\u7406\u9636\u6bb5\u8fdb\u884c\u4fee\u6539\uff0c\u4f46\u8fc7\u6ee4\u9636\u6bb5\u4f1a\u4ece\u4e2d\u8bfb\u53d6\uff0c\u6700\u7ec8\u7684\u6807\u7b7e\u96c6\u5c06\u7531 Loki \u5efa\u7acb\u7d22\u5f15\uff0c\u5e76\u53ef\u7528\u4e0e\u67e5\u8be2\u3002 \u63d0\u53d6\u7684\u952e\u503c\u5bf9 \uff1a\u5728\u89e3\u6790\u9636\u6bb5\u63d0\u53d6\u7684\u952e\u503c\u5bf9\u96c6\u5408\uff0c\u540e\u7eed\u7684\u9636\u6bb5\u5bf9\u63d0\u53d6\u7684 Map \u8fdb\u884c\u64cd\u4f5c\uff0c\u6216\u8005\u5bf9\u5b83\u4eec\u8fdb\u884c\u8f6c\u6362\uff0c\u6216\u8005\u5bf9\u5b83\u4eec\u8fdb\u884c\u5904\u7406\u3002\u5728\u4e00\u4e2a pipeline \u7684\u672b\u7aef\uff0c\u63d0\u53d6\u7684 Map \u4f1a\u88ab\u4e22\u5f03\u6389\uff0c\u4e3a\u4e86\u4f7f\u4e00\u4e2a\u89e3\u6790\u9636\u6bb5\u6709\u7528\uff0c\u5b83\u5fc5\u987b\u603b\u8981\u4e0e\u81f3\u5c11\u4e00\u4e2a\u5904\u7406\u9636\u6bb5\u914d\u5bf9\u3002\u63d0\u53d6\u7684 Map \u88ab\u521d\u59cb\u5316\uff0c\u5176\u521d\u59cb\u5316\u6807\u7b7e\u662f\u4e0e\u65e5\u5fd7\u884c\u4e00\u8d77\u6293\u53d6\u7684\uff0c\u8fd9\u4e2a\u521d\u59cb\u6570\u636e\u5141\u8bb8\u5728\u53ea\u64cd\u4f5c\u63d0\u53d6\u7684 Map \u7684 pipeline \u9636\u6bb5\u5185\u5bf9\u6807\u7b7e\u7684\u503c\u8fdb\u884c\u5904\u7406\u3002\u4f8b\u5982\uff0c\u4ece\u6587\u4ef6\u4e2d\u63d0\u53d6\u7684\u65e5\u5fd7\u6761\u76ee\u6709\u4e00\u4e2a\u6807\u7b7e filename\uff0c\u5176\u503c\u662f\u88ab\u63d0\u53d6\u7684\u6587\u4ef6\u8def\u5f84\uff0c\u5f53\u4e00\u4e2a pipeline \u6267\u884c\u8be5\u65e5\u5fd7\u65f6\uff0c\u6700\u521d\u63d0\u53d6\u7684 Map \u5c06\u5305\u542b\u4f7f\u7528\u4e0e\u6807\u7b7e\u76f8\u540c\u503c\u7684\u6587\u4ef6\u540d\u3002 \u65e5\u5fd7\u65f6\u95f4\u6233 \uff1a\u65e5\u5fd7\u884c\u7684\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u5904\u7406\u9636\u6bb5\u53ef\u4ee5\u4fee\u6539\u8fd9\u4e2a\u503c\u3002 \u5982\u679c\u4e0d\u8bbe\u7f6e\uff0c\u5219\u9ed8\u8ba4\u4e3a\u65e5\u5fd7\u88ab\u6293\u53d6\u7684\u65f6\u95f4 \uff0c\u65f6\u95f4\u6233\u7684\u6700\u7ec8\u503c\u4f1a\u53d1\u9001\u7ed9 Loki\u3002 \u65e5\u5fd7\u884c \uff1a\u5f53\u524d\u7684\u65e5\u5fd7\u884c\uff0c\u4ee5\u6587\u672c\u5f62\u5f0f\u8868\u793a\uff0c\u521d\u59cb\u5316\u4e3a Promtail \u6293\u53d6\u7684\u6587\u672c\u3002\u5904\u7406\u9636\u6bb5\u53ef\u4ee5\u4fee\u6539\u8fd9\u4e2a\u503c\uff0c\u65e5\u5fd7\u884c\u7684\u6700\u7ec8\u503c\u5c06\u4f5c\u4e3a\u65e5\u5fd7\u7684\u6587\u672c\u5185\u5bb9\u53d1\u9001\u7ed9 Loki\u3002","title":"pipeline"},{"location":"3.k8s/7.logging/promtail/#_2","text":"\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Promtail \u7684\u4e00\u4e2a pipeline \u4e2d\u6709 4 \u4e2d\u7c7b\u578b\u7684\u9636\u6bb5\uff0c\u4e0b\u9762\u6211\u4eec\u518d\u5206\u522b\u5bf9\u8fd9 4 \u4e2d\u7c7b\u578b\u9636\u6bb5\u8fdb\u884c\u7b80\u5355\u8bf4\u660e\u3002","title":"\u9636\u6bb5"},{"location":"3.k8s/7.logging/promtail/#_3","text":"\u89e3\u6790\u9636\u6bb5\u5305\u62ec\uff1adocker\u3001cri\u3001regex\u3001json \u8fd9\u51e0\u4e2a stage\u3002","title":"\u89e3\u6790\u9636\u6bb5"},{"location":"3.k8s/7.logging/promtail/#docker","text":"docker \u9636\u6bb5\u901a\u8fc7\u4f7f\u7528\u6807\u7b7e\u7684 Docker \u65e5\u5fd7\u683c\u5f0f\u6765\u89e3\u6790\u65e5\u5fd7\u6570\u636e\u8fdb\u884c\u6570\u636e\u63d0\u53d6\u3002\u76f4\u63a5\u4f7f\u7528 docker: {} \u5373\u8868\u793a\u662f\u4e00\u4e2a docker \u9636\u6bb5\u3002 \u4e0e\u5927\u591a\u6570\u9636\u6bb5\u4e0d\u540c\uff0cdocker \u9636\u6bb5\u4e0d\u63d0\u4f9b\u914d\u7f6e\u9009\u9879\uff0c\u53ea\u652f\u6301\u7279\u5b9a\u7684 Docker \u65e5\u5fd7\u683c\u5f0f\uff0c\u6765\u81ea Docker \u7684\u6bcf\u4e00\u884c\u65e5\u5fd7\u90fd\u88ab\u5199\u6210 JSON \u683c\u5f0f\uff0c\u5176\u952e\u503c\u5982\u4e0b\u3002 log \uff1a\u65e5\u5fd7\u884c\u7684\u5185\u5bb9 stream \uff1a stdout \u6216\u8005 stderr time \uff1a\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u5b57\u7b26\u4e32 \u4f8b\u5982\u914d\u7f6e\u4e0b\u9762\u7684 pipeline\uff1a - docker: {} \u5c06\u4f1a\u89e3\u6790 Docker \u65e5\u5fd7\u6210\u5982\u4e0b\u6240\u793a\u683c\u5f0f\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output \uff1a log message\\n stream \uff1a stderr timestamp \uff1a 2019-04-30T02:12:41.8443515","title":"docker"},{"location":"3.k8s/7.logging/promtail/#cri","text":"\u901a\u8fc7\u4f7f\u7528\u6807\u51c6 CRI \u683c\u5f0f\u89e3\u6790\u65e5\u5fd7\u884c\u6765\u63d0\u53d6\u6570\u636e\u3002\u4f7f\u7528\u8bed\u6cd5\u4e00\u6837\u662f\u76f4\u63a5\u4f7f\u7528 cri: {} \u5373\u53ef\uff0c\u4e0e\u5927\u591a\u6570\u9636\u6bb5\u4e0d\u540c\uff0ccri \u9636\u6bb5\u4e0d\u63d0\u4f9b\u914d\u7f6e\u9009\u9879\uff0c\u53ea\u652f\u6301\u7279\u5b9a\u7684 CRI \u65e5\u5fd7\u683c\u5f0f\u3002CRI \u6307\u5b9a\u7684\u65e5\u5fd7\u884c\u662f\u4ee5\u7a7a\u683c\u5206\u9694\u7684\u503c\uff0c\u6709\u4ee5\u4e0b\u7ec4\u6210\u90e8\u5206\uff1a log \uff1a\u6574\u4e2a\u65e5\u5fd7\u884c\u7684\u5185\u5bb9 stream \uff1a stdout \u6216\u8005 stderr time \uff1a\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u5b57\u7b26\u4e32 \u7ec4\u4ef6\u4e4b\u95f4\u4e0d\u5141\u8bb8\u6709\u7a7a\u767d\uff0c\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u53ea\u6709\u7b2c\u4e00\u884c\u65e5\u5fd7\u53ef\u4ee5\u4f7f\u7528 cri \u9636\u6bb5\u8fdb\u884c\u6b63\u786e\u683c\u5f0f\u5316\u3002 \"2019-01-01T01:00:00.000000001Z stderr P test\\ngood\" \"2019-01-01 T01:00:00.000000001Z stderr testgood\" \"2019-01-01T01:00:00.000000001Z testgood\" \u4f8b\u5982\u914d\u7f6e\u4e0b\u9762\u7684 pipeline\uff1a - cri: {} \u5f53\u6211\u4eec\u6709\u5982\u4e0b\u6240\u793a\u7684\u65e5\u5fd7\u884c\u6570\u636e\uff1a \"2019-04-30T02:12:41.8443515Z stdout xx message\" \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output : xx message stream : stdout timestamp : 2019-04-30T02:12:41.8443515","title":"cri"},{"location":"3.k8s/7.logging/promtail/#regex","text":"\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u63d0\u53d6\u6570\u636e\uff0c\u5728 regex \u4e2d\u547d\u540d\u7684\u6355\u83b7\u7ec4\u652f\u6301\u5c06\u6570\u636e\u6dfb\u52a0\u5230\u63d0\u53d6\u7684 Map \u6620\u5c04\u4e2d\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a regex: # RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6bcf\u4e2a\u6355\u83b7\u7ec4\u5fc5\u987b\u88ab\u547d\u540d\u3002 expression: <string> # \u4ece\u6307\u5b9a\u540d\u79f0\u4e2d\u63d0\u53d6\u6570\u636e\uff0c\u5982\u679c\u4e3a\u7a7a\uff0c\u5219\u4f7f\u7528 log \u4fe1\u606f\u3002 [source: <string>] \u5176\u4e2d\u7684 expression \u662f\u4e00\u4e2a Google RE2 \u6b63\u5219\u8868\u8fbe\u5f0f \u5b57\u7b26\u4e32\uff0c\u6bcf\u4e2a\u6355\u83b7\u7ec4\u5c06\u88ab\u8bbe\u7f6e\u4e3a\u5230\u63d0\u53d6\u7684 Map \u4e2d\u53bb\uff0c\u6bcf\u4e2a\u6355\u83b7\u7ec4\u4e5f\u5fc5\u987b\u547d\u540d\uff1a (?P<name>re) \uff0c\u6355\u83b7\u7ec4\u7684\u540d\u79f0\u5c06\u88ab\u7528\u4f5c\u63d0\u53d6\u7684 Map \u4e2d\u7684\u952e\u3002 \u53e6\u5916\u9700\u8981\u6ce8\u610f\uff0c\u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u65f6\uff0c\u5fc5\u987b\u8f6c\u4e49\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u7684\u6240\u6709\u53cd\u659c\u6760\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u51e0\u4e2a\u8868\u8fbe\u5f0f\u90fd\u662f\u6709\u6548\u7684\uff1a expression: \\w* expression: '\\w*' expression: \"\\\\w*\" \u4f46\u662f\u4e0b\u9762\u7684\u8fd9\u51e0\u4e2a\u662f\u65e0\u6548\u7684\u8868\u8fbe\u5f0f\uff1a expression: \\\\w* - \u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u65f6\u624d\u8f6c\u4e49\u53cd\u659c\u7ebf expression: '\\\\w*' - \u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u65f6\u624d\u8f6c\u4e49\u53cd\u659c\u7ebf expression: \"\\w*\" - \u5728\u4f7f\u7528\u53cc\u5f15\u53f7\u7684\u65f6\u5019\uff0c\u53cd\u659c\u6760\u5fc5\u987b\u88ab\u8f6c\u4e49 \u4f8b\u5982\u6211\u4eec\u4f7f\u7528\u4e0b\u9762\u4e0d\u5e26 source \u7684 pipeline \u914d\u7f6e\uff1a - regex: expression: \"^(?s)(?P<time>\\\\S+?) (?P<stream>stdout|stderr) (?P<flags>\\\\S+?) (?P<content>.*)$\" \u5f53\u6211\u4eec\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a 2019-01-01T01:00:00.000000001Z stderr P i'm a log message! \u8be5 pipeline \u6267\u884c\u540e\u4ee5\u4e0b\u952e\u503c\u5bf9\u5c06\u88ab\u6dfb\u52a0\u5230\u63d0\u53d6\u7684 Map \u4e2d\u53bb\uff1a time : 2019-01-01T01:00:00.000000001Z stream : stderr flags : P content : i'm a log message \u5982\u679c\u6211\u4eec\u4f7f\u7528\u5e26\u4e0a source \u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: time: - regex: expression: \"^(?P<year>\\\\d+)\" source: \"time\" \u5982\u679c\u9700\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"time\": \"2019-01-01T01:00:00.000000001Z\" } \u5219\u7b2c\u4e00\u9636\u6bb5\u5c06\u628a\u4ee5\u4e0b\u952e\u503c\u5bf9\u6dfb\u52a0\u5230\u63d0\u53d6\u7684 Map \u4e2d\uff1a time : 2019-01-01T01:00:00.000000001Z \u800c regex \u9636\u6bb5\u5c06\u89e3\u6790\u63d0\u53d6\u7684 Map \u4e2d\u7684\u65f6\u95f4\u503c\uff0c\u5e76\u5c06\u4ee5\u4e0b\u952e\u503c\u5bf9\u8ffd\u52a0\u5230\u63d0\u53d6\u7684 Map \u4e2d\u53bb\uff1a year : 2019","title":"regex"},{"location":"3.k8s/7.logging/promtail/#json","text":"\u901a\u8fc7\u5c06\u65e5\u5fd7\u884c\u89e3\u6790\u4e3a JSON \u6765\u63d0\u53d6\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u63a5\u53d7 JMESPath \u8868\u8fbe\u5f0f\u6765\u63d0\u53d6\u6570\u636e\uff0c\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a json: # JMESPath \u8868\u8fbe\u5f0f\u7684\u952e/\u503c\u5bf9\u96c6\u5408\uff0c\u952e\u5c06\u662f\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u7684\u952e\uff0c\u800c\u8868\u8fbe\u5f0f\u5c06\u662f\u503c\uff0c\u88ab\u8bc4\u4f30\u4e3a\u6765\u81ea\u6e90\u6570\u636e\u7684 JMESPath\u3002 # # JMESPath \u8868\u8fbe\u5f0f\u53ef\u4ee5\u901a\u8fc7\u7528\u53cc\u5f15\u53f7\u6765\u5305\u88c5\u4e00\u4e2a\u952e\u5b8c\u6210\uff0c\u7136\u540e\u5728 YAML \u4e2d\u5fc5\u987b\u7528\u5355\u5f15\u53f7\u5305\u88c5\u8d77\u6765\uff0c\u8fd9\u6837\u5b83\u4eec\u5c31\u4f1a\u88ab\u4f20\u9012\u7ed9 JMESPath \u89e3\u6790\u5668\u8fdb\u884c\u89e3\u6790\u3002 expressions: [ <string>: <string> ... ] [source: <string>] \u8be5\u9636\u6bb5\u4f7f\u7528 Golang JSON \u53cd\u5e8f\u5217\u5316\uff0c\u63d0\u53d6\u7684\u6570\u636e\u53ef\u4ee5\u6301\u6709\u975e\u5b57\u7b26\u4e32\u503c\uff0c\u672c\u9636\u6bb5\u4e0d\u505a\u4efb\u4f55\u7c7b\u578b\u8f6c\u6362\uff0c\u5728\u4e0b\u6e38\u9636\u6bb5\u5c06\u9700\u8981\u5bf9\u8fd9\u4e9b\u503c\u8fdb\u884c\u5fc5\u8981\u7684\u7c7b\u578b\u8f6c\u6362\uff0c\u53ef\u4ee5\u53c2\u8003\u540e\u9762\u7684 template \u9636\u6bb5\u4e86\u89e3\u5982\u4f55\u8fdb\u884c\u8f6c\u6362\u3002 \u6ce8\u610f\uff1a\u5982\u679c\u63d0\u53d6\u7684\u503c\u662f\u4e00\u4e2a\u590d\u6742\u7684\u7c7b\u578b\uff0c\u6bd4\u5982\u6570\u7ec4\u6216 JSON \u5bf9\u8c61\uff0c\u5b83\u5c06\u88ab\u8f6c\u6362\u4e3a JSON \u5b57\u7b26\u4e32\uff0c\u7136\u540e\u63d2\u5165\u5230\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u53bb\u3002 \u4f8b\u5982\u6211\u4eec\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: output: log stream: stream timestamp: time \u8981\u6293\u53d6\u7684\u65e5\u5fd7\u884c\u6570\u636e\u4e3a\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output : log message\\n stream : stderr timestamp : 2019-04-30T02:12:41.8443515 \u7136\u540e\u6211\u4eec\u8fd8\u53ef\u4ee5\u7528\u4e0b\u9762\u7684 pipeline \u914d\u7f6e\u6765\u63d0\u524d\u6570\u636e\uff1a - json: expressions: output: log stream: stream timestamp: time extra: - json: expressions: user: source: extra \u8981\u6293\u53d6\u7684\u65e5\u5fd7\u884c\u6570\u636e\u4e3a\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\", \"extra\": \"{\\\"user\\\":\\\"marco\\\"}\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u6267\u884c\u540e\u5c06\u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\uff1a output : log message\\n stream : stderr timestamp : 2019-04-30T02:12:41.8443515 extra : {\"user\": \"marco\"} \u7136\u540e\u7ecf\u8fc7\u7b2c\u4e8c\u4e2a json \u9636\u6bb5\u6267\u884c\u540e\u5c06\u628a\u63d0\u53d6\u6570\u636e\u4e2d\u7684 extra \u503c\u89e3\u6790\u4e3a JSON\uff0c\u5e76\u5c06\u4ee5\u4e0b\u952e\u503c\u5bf9\u6dfb\u52a0\u5230\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff1a user : marco \u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 JMESPath \u8868\u8fbe\u5f0f\u6765\u89e3\u6790\u6709\u7279\u6b8a\u5b57\u7b26\u7684 JSON \u5b57\u6bb5\uff08\u6bd4\u5982 @ \u6216 . \uff09\uff0c\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u6709\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: output: log stream: '\"grpc.stream\"' timestamp: time \u9700\u8981\u6293\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u5982\u4e0b\u6240\u793a\uff1a { \"log\": \"log message\\n\", \"grpc.stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u5728\u63d0\u53d6\u7684\u6570\u636e\u96c6\u4e2d\uff0c\u5c06\u521b\u5efa\u4ee5\u4e0b\u952e\u503c\u5bf9\u3002 output : log message\\n stream : stderr timestamp : 2019-04-30T02:12:41.8443515 \u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u5f15\u7528 grpc.stream \u65f6\uff0c\u5982\u679c\u6ca1\u6709\u7528\u5355\u5f15\u53f7\u5305\u88f9\u7684\u53cc\u5f15\u53f7\uff0c\u5c06\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\u3002","title":"json"},{"location":"3.k8s/7.logging/promtail/#_4","text":"\u8f6c\u6362\u9636\u6bb5\u7528\u4e8e\u5bf9\u4e4b\u524d\u9636\u6bb5\u63d0\u53d6\u7684\u6570\u636e\u8fdb\u884c\u8f6c\u6362\u3002","title":"\u8f6c\u6362\u9636\u6bb5"},{"location":"3.k8s/7.logging/promtail/#multiline","text":"\u591a\u884c\u9636\u6bb5\u5c06\u591a\u884c\u65e5\u5fd7\u8fdb\u884c\u5408\u5e76\uff0c\u7136\u540e\u518d\u5c06\u5176\u4f20\u9012\u5230 pipeline \u7684\u4e0b\u4e00\u4e2a\u9636\u6bb5\u3002 \u4e00\u4e2a\u65b0\u7684\u65e5\u5fd7\u5757\u7531 \u7b2c\u4e00\u884c\u6b63\u5219\u8868\u8fbe\u5f0f \u6765\u8bc6\u522b\uff0c\u4efb\u4f55\u4e0e\u8868\u8fbe\u5f0f\u4e0d\u5339\u914d\u7684\u884c\u90fd\u88ab\u8ba4\u4e3a\u662f\u524d\u4e00\u4e2a\u5339\u914d\u5757\u7684\u4e00\u90e8\u5206\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a multiline: # RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5982\u679c\u5339\u914d\u5c06\u5f00\u59cb\u4e00\u4e2a\u65b0\u7684\u591a\u884c\u65e5\u5fd7\u5757 # \u8fd9\u4e2a\u8868\u8fbe\u5f0f\u5fc5\u987b\u88ab\u63d0\u4f9b firstline: <string> # \u89e3\u6790\u7684\u6700\u5927\u7b49\u5f85\u65f6\u95f4\uff08Go duration\uff09: https://golang.org/pkg/time/#ParseDuration. # \u5982\u679c\u5728\u8fd9\u4e2a\u6700\u5927\u7684\u7b49\u5f85\u65f6\u95f4\u5185\u6ca1\u6709\u65b0\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u5f53\u524d\u65e5\u5fd7\u5757\u5c06\u88ab\u7ee7\u7eed\u53d1\u9001\u3002 # \u5982\u679c\u88ab\u89c2\u5bdf\u7684\u5e94\u7528\u7a0b\u5e8f\u56e0\u4e3a\u5f02\u5e38\u800cdown\u6389\u4e86\uff0c\u8be5\u53c2\u6570\u5f88\u6709\u7528\uff0c\u6ca1\u6709\u65b0\u7684\u65e5\u5fd7\u51fa\u73b0\uff0c\u5e76\u4e14\u5f02\u5e38\u5757\u4f1a\u5728\u6700\u5927\u7b49\u5f85\u65f6\u95f4\u8fc7\u540e\u53d1\u9001 # \u9ed8\u8ba4\u4e3a 3s max_wait_time: <duration> # \u4e00\u4e2a\u591a\u884c\u65e5\u5fd7\u5757\u6709\u7684\u6700\u5927\u884c\u6570\uff0c\u5982\u679c\u8be5\u5757\u6709\u66f4\u591a\u7684\u884c\uff0c\u5c31\u4f1a\u8ba4\u4e3a\u662f\u65b0\u7684\u65e5\u5fd7\u884c # \u9ed8\u8ba4\u4e3a 128 \u884c max_lines: <integer> \u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a flask \u5e94\u7528\uff0c\u4e0b\u9762\u7684\u65e5\u5fd7\u6570\u636e\u5305\u542b\u5f02\u5e38\u4fe1\u606f\uff1a [2020-12-03 11:36:20] \"GET /hello HTTP/1.1\" 200 - [2020-12-03 11:36:23] ERROR in app: Exception on /error [GET] Traceback (most recent call last): File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 2447, in wsgi_app response = self.full_dispatch_request() File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1952, in full_dispatch_request rv = self.handle_user_exception(e) File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1821, in handle_user_exception reraise(exc_type, exc_value, tb) File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/_compat.py\", line 39, in reraise raise value File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1950, in full_dispatch_request rv = self.dispatch_request() File \"/home/pallets/.pyenv/versions/3.8.5/lib/python3.8/site-packages/flask/app.py\", line 1936, in dispatch_request return self.view_functions[rule.endpoint](**req.view_args) File \"/home/pallets/src/deployment_tools/hello.py\", line 10, in error raise Exception(\"Sorry, this route always breaks\") Exception: Sorry, this route always breaks [2020-12-03 11:36:23] \"GET /error HTTP/1.1\" 500 - [2020-12-03 11:36:26] \"GET /hello HTTP/1.1\" 200 - [2020-12-03 11:36:27] \"GET /hello HTTP/1.1\" 200 - \u663e\u7136\u6211\u4eec\u66f4\u5e0c\u671b\u5c06\u4e0a\u9762\u7684 Exception \u591a\u884c\u65e5\u5fd7\u8bc6\u522b\u4e3a\u4e00\u4e2a\u65e5\u5fd7\u5757\uff0c\u5728\u8fd9\u4e2a\u793a\u4f8b\u4e2d\uff0c\u6240\u6709\u7684\u65e5\u5fd7\u5757\u90fd\u662f\u4e00\u4e2a\u4e2d\u62ec\u53f7\u5305\u62ec\u7684\u65f6\u95f4\u5f00\u59cb\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7528 firstline \u6b63\u5219\u8868\u8fbe\u5f0f\uff1a ^\\[\\d{4}-\\d{2}-\\d{2} \\d{1,2}:\\d{2}:\\d{2}\\] \u6765\u914d\u7f6e\u4e00\u4e2a\u591a\u884c\u9636\u6bb5\uff0c\u8fd9\u5c06\u5339\u914d\u4e0a\u9762\u6211\u4eec\u7684\u5f02\u5e38\u65e5\u5fd7\u7684\u5f00\u5934\u90e8\u5206\uff0c\u4f46\u662f\u4e0d\u4f1a\u5339\u914d\u540e\u9762\u7684\u5f02\u5e38\u884c\uff0c\u76f4\u5230 Exception: Sorry, this route always breaks \u8fd9\u4e00\u884c\u65e5\u5fd7\uff0c\u8fd9\u4e9b\u5c06\u88ab\u8bc6\u522b\u4e3a\u5355\u4e2a\u65e5\u5fd7\u5757\uff0c\u5728 Loki \u4e2d\u4e5f\u662f\u4ee5\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\u51fa\u73b0\u7684\u3002 multiline: # \u8bc6\u522b\u65f6\u95f4\u6233\u4f5c\u4e3a\u591a\u884c\u65e5\u5fd7\u7684\u7b2c\u4e00\u884c\uff0c\u6ce8\u610f\u8fd9\u91cc\u5b57\u7b26\u4e32\u5e94\u8be5\u4f7f\u7528\u5355\u5f15\u53f7\u3002 firstline: '^\\[\\d{4}-\\d{2}-\\d{2} \\d{1,2}:\\d{2}:\\d{2}\\]' max_wait_time: 3s max_lines: 128","title":"multiline"},{"location":"3.k8s/7.logging/promtail/#template","text":"template \u9636\u6bb5\u53ef\u4ee5\u4f7f\u7528 Go \u6a21\u677f\u8bed\u6cd5 \u6765\u64cd\u4f5c\u63d0\u53d6\u7684\u6570\u636e\u3002\u6a21\u677f\u9636\u6bb5\u4e3b\u8981\u7528\u4e8e\u5728\u5c06\u6570\u636e\u8bbe\u7f6e\u4e3a\u6807\u7b7e\u4e4b\u524d\u5bf9\u5176\u4ed6\u9636\u6bb5\u7684\u6570\u636e\u8fdb\u884c\u64cd\u4f5c\uff0c\u4f8b\u5982\u7528\u4e0b\u5212\u7ebf\u66ff\u6362\u7a7a\u683c\uff0c\u6216\u8005\u5c06\u5927\u5199\u7684\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5c0f\u5199\u7684\u5b57\u7b26\u4e32\u3002\u6a21\u677f\u4e5f\u53ef\u4ee5\u7528\u6765\u6784\u5efa\u5177\u6709\u591a\u4e2a\u952e\u7684\u4fe1\u606f\uff0c\u6a21\u677f\u9636\u6bb5\u4e5f\u53ef\u4ee5\u5728\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u521b\u5efa\u65b0\u7684\u952e\u3002 \u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a template: # \u8981\u89e3\u6790\u7684\u63d0\u53d6\u6570\u636e\u4e2d\u7684\u540d\u79f0\uff0c\u5982\u679c\u63d0\u524d\u6570\u636e\u4e2d\u7684 key \u4e0d\u5b58\u5728\uff0c\u5c06\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u503c source: <string> # \u4f7f\u7528\u7684 Go \u6a21\u677f\u5b57\u7b26\u4e32\u3002 \u9664\u4e86\u6b63\u5e38\u7684\u6a21\u677f\u4e4b\u5916 # functions, ToLower, ToUpper, Replace, Trim, TrimLeft, TrimRight, # TrimPrefix, TrimSuffix, and TrimSpace \u90fd\u662f\u53ef\u4ee5\u4f7f\u7528\u7684\u51fd\u6570\u3002 template: <string>s \u6bd4\u5982\u4e0b\u9762\u7684 pipeline \u914d\u7f6e\uff1a - template: source: new_key template: \"hello world!\" \u5047\u5982\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u88ab\u6dfb\u52a0\u5230\u63d0\u53d6\u7684\u6570\u636e\u4e2d\uff0c\u8fd9\u4e2a\u9636\u6bb5\u5c06\u9996\u5148\u5728\u63d0\u53d6\u7684\u6570\u636e Map \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u7a7a\u767d\u503c\u7684 new_key \uff0c\u7136\u540e\u5b83\u7684\u503c\u5c06\u88ab\u8bbe\u7f6e\u4e3a hello world! \u3002 \u5728\u770b\u4e0b\u9762\u7684\u6a21\u677f\u9636\u6bb5\u914d\u7f6e\uff1a - template: source: app template: \"{{ .Value }}_some_suffix\" \u8fd9\u4e2a pipeline \u5728\u73b0\u6709\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6\u952e\u4e3a app \u7684\u503c\uff0c\u5e76\u5c06 _som_suffix \u9644\u52a0\u5230\u503c\u540e\u9762\u3002\u4f8b\u5982\uff0c\u5982\u679c\u63d0\u524d\u7684\u6570\u636e Map \u7684\u952e\u4e3a app\uff0c\u503c\u4e3a loki\uff0c\u90a3\u4e48\u8fd9\u4e2a\u9636\u6bb5\u5c06\u628a\u503c\u4ece loki \u4fee\u6539\u4e3a loki_som_suffix \u3002 - template: source: app template: \"{{ ToLower .Value }}\" \u8fd9\u4e2a pipeline \u4ece\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6\u952e\u4e3a app \u7684\u503c\uff0c\u5e76\u5c06\u5176\u503c\u8f6c\u6362\u4e3a\u5c0f\u5199\u3002\u4f8b\u5982\uff0c\u5982\u679c\u63d0\u53d6\u7684\u6570\u636e\u952e app \u7684\u503c\u4e3a LOKI\uff0c\u90a3\u4e48\u8fd9\u4e2a\u9636\u6bb5\u5c06\u628a\u503c\u8f6c\u6362\u4e3a\u5c0f\u5199\u7684 loki\u3002 - template: source: output_msg template: \"{{ .level }} for app {{ ToUpper .app }}\" \u8fd9\u4e2a pipeline \u4ece\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6 level \u4e0e app \u7684\u503c\uff0c\u4e00\u4e2a\u65b0\u7684 output_msg \u5c06\u88ab\u6dfb\u52a0\u5230\u63d0\u53d6\u7684\u6570\u636e\u4e2d\uff0c\u503c\u4e3a\u4e0a\u9762\u6a21\u677f\u7684\u8ba1\u7b97\u7ed3\u679c\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u5305\u542b\u952e\u4e3a app\uff0c\u503c\u4e3a loki \u7684\u6570\u636e\uff0clevel \u7684\u503c\u4e3a warn\uff0c\u90a3\u4e48\u7ecf\u8fc7\u8be5\u9636\u6bb5\u540e\u4f1a\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u6570\u636e\uff0c\u952e\u4e3a output_msg \uff0c\u5176\u503c\u4e3a warn for app LOKI \u3002 \u4efb\u4f55\u5148\u524d\u63d0\u53d6\u7684\u952e\u90fd\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u4f7f\u7528\uff0c\u6240\u6709\u63d0\u53d6\u7684\u952e\u90fd\u53ef\u7528\u4e8e\u6a21\u677f\u7684\u6269\u5c55\u3002 - template: source: app template: \"{{ .level }} for app {{ ToUpper .Value }} in module {{.module}}\" \u4e0a\u9762\u7684\u8fd9\u4e2a pipeline \u4ece\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u83b7\u53d6 level\u3001app \u5408 module \u503c\u3002\u4f8b\u5982\uff0c\u5982\u679c\u63d0\u53d6\u7684\u6570\u636e\u5305\u542b\u503c\u4e3a loki \u7684 app\uff0clevel \u7684\u503c\u4e3a warn\uff0cmoudule \u7684\u503c\u4e3a test\uff0c\u5219\u8fd9\u4e2a\u9636\u6bb5\u4f1a\u5c06\u63d0\u53d6\u6570\u636e app \u7684\u503c\u66f4\u6539\u4e3a warn for app LOKI in module test \u3002 \u4efb\u4f55\u4e4b\u524d\u83b7\u53d6\u7684\u952e\u90fd\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u4f7f\u7528\uff0c\u6b64\u5916\uff0c\u5982\u679c source \u662f\u53ef\u7528\u7684\uff0c\u5b83\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u88ab\u79f0\u4e3a .Value \uff0c\u6211\u4eec\u8fd9\u91cc app \u88ab\u5f53\u6210\u4e86 source\uff0c\u6240\u4ee5\u5b83\u53ef\u4ee5\u5728\u6a21\u677f\u4e2d\u901a\u8fc7 .Value \u4f7f\u7528\u3002 - template: source: app template: '{{ Replace .Value \"loki\" \"blokey\" 1 }}' \u8fd9\u91cc\u7684\u6a21\u677f\u4f7f\u7528 Go \u7684 string.Replace \u51fd\u6570\uff0c\u5f53\u6a21\u677f\u6267\u884c\u65f6\uff0c\u4ece\u63d0\u53d6\u7684 Map \u6570\u636e\u4e2d\u7684\u952e\u4e3a app \u7684\u5168\u90e8\u5185\u5bb9\u5c06\u6700\u591a\u6709 1 \u4e2a loki \u7684\u5b9e\u4f8b\u88ab\u6539\u4e3a blokey\u3002 \u53e6\u5916\u6709\u4e00\u4e2a\u540d\u4e3a Entry \u7684\u7279\u6b8a\u952e\u53ef\u4ee5\u7528\u6765\u5f15\u7528\u5f53\u524d\u884c\uff0c\u5f53\u4f60\u9700\u8981\u8ffd\u52a0\u6216\u9884\u8bbe\u65e5\u5fd7\u884c\u7684\u65f6\u5019\uff0c\u8fd9\u5e94\u8be5\u4f1a\u5f88\u6709\u7528\u3002 - template: source: message template: \"{{.app }}: {{ .Entry }}\" - output: source: message \u4f8b\u5982\uff0c\u4e0a\u9762\u7684\u7247\u6bb5\u4f1a\u5728\u65e5\u5fd7\u884c\u524d\u52a0\u4e0a app \u7684\u540d\u79f0\u3002 \u5728 Loki2.3 \u4e2d\uff0c\u6240\u6709\u7684 sprig \u51fd\u6570 \u90fd\u88ab\u6dfb\u52a0\u5230\u4e86\u5f53\u524d\u7684\u6a21\u677f\u9636\u6bb5\uff0c\u5305\u62ec ToLower & ToUpper\u3001Replace\u3001Trim\u3001Regex\u3001Hash \u548c Sha2Hash \u51fd\u6570\u3002","title":"template"},{"location":"3.k8s/7.logging/promtail/#_5","text":"\u7528\u4e8e\u4ece\u4ee5\u524d\u9636\u6bb5\u4e2d\u63d0\u53d6\u6570\u636e\u5e76\u5bf9\u5176\u8fdb\u884c\u5904\u7406\u3002","title":"\u5904\u7406\u9636\u6bb5"},{"location":"3.k8s/7.logging/promtail/#timestamp","text":"\u8bbe\u7f6e\u65e5\u5fd7\u6761\u76ee\u7684\u65f6\u95f4\u6233\u503c\uff0c\u5f53\u65f6\u95f4\u6233\u9636\u6bb5\u4e0d\u5b58\u5728\u65f6\uff0c\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u9ed8\u8ba4\u4e3a\u65e5\u5fd7\u6761\u76ee\u88ab\u6293\u53d6\u7684\u65f6\u95f4\u3002 \u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a timestamp: source: <string> # \u89e3\u6790\u65f6\u95f4\u5b57\u7b26\u4e32\u7684\u683c\u5f0f\uff0c\u53ef\u4ee5\u53ea\u6709\u9884\u5b9a\u4e49\u7684\u683c\u5f0f\u6709\uff1a[ANSIC UnixDate RubyDate RFC822 # RFC822Z RFC850 RFC1123 RFC1123Z RFC3339 RFC3339Nano Unix # UnixMs UnixUs UnixNs]. format: <string> # \u5982\u679c\u683c\u5f0f\u65e0\u6cd5\u89e3\u6790\uff0c\u53ef\u5c1d\u8bd5\u7684 fallback \u7684\u683c\u5f0f [fallback_formats: []<string>] # IANA \u65f6\u533a\u6570\u636e\u5e93\u5b57\u7b26\u4e32 [location: <string>] # \u5728\u65f6\u95f4\u6233\u65e0\u6cd5\u63d0\u53d6\u6216\u89e3\u6790\u7684\u60c5\u51b5\u4e0b\uff0c\u5e94\u91c7\u53d6\u4f55\u79cd\u884c\u52a8\u3002\u6709\u6548\u503c\u4e3a\uff1a[skip, fudge]\uff0c\u9ed8\u8ba4\u4e3a fudge\u3002 [action_on_failure: <string>] \u5176\u4e2d\u7684 format \u5b57\u6bb5\u53ef\u4ee5\u53c2\u8003\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a ANSIC : Mon Jan \\_2 15:04:05 2006 UnixDate : Mon Jan_2 15:04:05 MST 2006 RubyDate : Mon Jan 02 15:04:05 -0700 2006 RFC822 : 02 Jan 06 15:04 MST RFC822Z : 02 Jan 06 15:04 -0700 RFC850 : Monday, 02-Jan-06 15:04:05 MST RFC1123 : Mon, 02 Jan 2006 15:04:05 MST RFC1123Z : Mon, 02 Jan 2006 15:04:05 -0700 RFC3339 : 2006-01-02T15:04:05-07:00 RFC3339Nano : 2006-01-02T15:04:05.999999999-07:00 \u53e6\u5916\u652f\u6301\u5e38\u89c1\u7684 Unix \u65f6\u95f4\u6233\uff1a Unix : 1562708916 or with fractions 1562708916.000000123 UnixMs : 1562708916414 UnixUs : 1562708916414123 UnixNs : 1562708916000000123 \u81ea\u5b9a\u4e49\u683c\u5f0f\u662f\u76f4\u63a5\u4f20\u9012\u683c GO \u7684 time.Parse \u51fd\u6570\u4e2d\u7684 layout \u53c2\u6570\uff0c\u5982\u679c\u81ea\u5b9a\u4e49\u683c\u5f0f\u6ca1\u6709\u6307\u5b9a year\uff0cPromtail \u4f1a\u8ba4\u4e3a\u5e94\u8be5\u4f7f\u7528\u7cfb\u7edf\u65f6\u949f\u7684\u5f53\u524d\u5e74\u4efd\u3002 \u81ea\u5b9a\u4e49\u683c\u5f0f\u4f7f\u7528\u7684\u8bed\u6cd5\u662f\u4f7f\u7528\u65f6\u95f4\u6233\u7684\u6bcf\u4e2a\u7ec4\u4ef6\u7684\u7279\u5b9a\u503c\u6765\u5b9a\u4e49\u65e5\u671f\u548c\u65f6\u95f4\uff08\u4f8b\u5982 Mon Jan 2 15:04:05 -0700 MST 2006\uff09\uff0c\u4e0b\u8868\u663e\u793a\u4e86\u5e94\u5728\u81ea\u5b9a\u4e49\u683c\u5f0f\u4e2d\u652f\u6301\u7684\u53c2\u8003\u503c\u3002 action_on_failure \u8bbe\u7f6e\u5b9a\u4e49\u4e86\u5728\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u4e0d\u5b58\u5728 source \u5b57\u6bb5\u6216\u65f6\u95f4\u6233\u89e3\u6790\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u5982\u4f55\u5904\u7406\uff0c\u652f\u6301\u7684\u52a8\u4f5c\u6709\uff1a fudge\uff08\u9ed8\u8ba4\uff09 \uff1a\u5c06\u65f6\u95f4\u6233\u66f4\u6539\u4e3a\u6700\u8fd1\u7684\u5df2\u77e5\u65f6\u95f4\u6233\uff0c\u603b\u8ba1 1 \u7eb3\u79d2\uff08\u4ee5\u4fdd\u8bc1\u65e5\u5fd7\u987a\u5e8f\uff09 skip \uff1a\u4e0d\u6539\u53d8\u65f6\u95f4\u6233\uff0c\u4fdd\u7559\u65e5\u5fd7\u88ab Promtail \u6293\u53d6\u7684\u65f6\u95f4 \u6bd4\u5982\u4f7f\u7528\u4e0b\u9762\u7684 pipeline \u914d\u7f6e\uff1a - timestamp: source: time format: RFC3339Nano \u7ecf\u8fc7\u4e0a\u9762\u7684 timestamp \u9636\u6bb5\u5728\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u67e5\u627e\u4e00\u4e2a time \u5b57\u6bb5\uff0c\u5e76\u4ee5 RFC3339Nano \u683c\u5f0f\u5316\u5176\u503c\uff08\u4f8b\u5982\uff0c2006-01-02T15:04:05.9999999-07:00\uff09\uff0c\u6240\u5f97\u7684\u65f6\u95f4\u503c\u5c06\u4f5c\u4e3a\u65f6\u95f4\u6233\u4e0e\u65e5\u5fd7\u884c\u4e00\u8d77\u53d1\u9001\u7ed9 Loki\u3002","title":"timestamp"},{"location":"3.k8s/7.logging/promtail/#output","text":"\u8bbe\u7f6e\u65e5\u5fd7\u884c\u6587\u672c\uff0c\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a output: source: <string> \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u914d\u7f6e\u7684 pipeline\uff1a - json: expressions: user: user message: message - labels: user: - output: source: message \u9700\u8981\u6536\u96c6\u7684\u65e5\u5fd7\u4e3a\uff1a { \"user\": \"alexis\", \"message\": \"hello, world!\" } \u5728\u7ecf\u8fc7\u7b2c\u4e00\u4e2a json \u9636\u6bb5\u540e\u5c06\u63d0\u524d\u4ee5\u4e0b\u952e\u503c\u5bf9\u5230\u6570\u636e\u4e2d\uff1a user : alexis message : hello, world! \u7136\u540e\u7b2c\u4e8c\u4e2a label \u9636\u6bb5\u5c06\u628a user=alexis \u6dfb\u52a0\u5230\u8f93\u51fa\u7684\u65e5\u5fd7\u6807\u7b7e\u96c6\u4e2d\uff0c\u6700\u540e\u7684 output \u9636\u6bb5\u5c06\u628a\u65e5\u5fd7\u6570\u636e\u4ece\u539f\u6765\u7684 JSON \u66f4\u6539\u4e3a message \u7684\u503c hello, world! \u8f93\u51fa\u3002","title":"output"},{"location":"3.k8s/7.logging/promtail/#labels","text":"\u66f4\u65b0\u65e5\u5fd7\u7684\u6807\u7b7e\u96c6\uff0c\u5e76\u4e00\u8d77\u53d1\u9001\u7ed9 Loki\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a labels: # Key \u662f\u5fc5\u987b\u7684\uff0c\u662f\u5c06\u88ab\u521b\u5efa\u7684\u6807\u7b7e\u540d\u79f0\u3002 # Values \u662f\u53ef\u9009\u7684\uff0c\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u7684\u540d\u79f0\uff0c\u5176\u503c\u5c06\u88ab\u7528\u4e8e\u6807\u7b7e\u7684\u503c\u3002 # \u5982\u679c\u662f\u7a7a\u7684\uff0c\u503c\u5c06\u88ab\u63a8\u65ad\u4e3a\u4e0e\u952e\u76f8\u540c\u3002 [ <string>: [<string>] ... ] \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a - json: expressions: stream: stream - labels: stream: \u9700\u8981\u5904\u7406\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u5c06\u63d0\u53d6 stream \u5230 Map \u6570\u636e\u4e2d\uff0c\u5176\u503c\u4e3a stderr \u3002\u7136\u540e\u5728\u7b2c\u4e8c\u4e2a labels \u9636\u6bb5\u5c06\u628a\u8fd9\u4e2a\u952e\u503c\u5bf9\u53d8\u6210\u4e00\u4e2a\u6807\u7b7e\uff0c\u5728\u53d1\u9001\u5230 Loki \u7684\u65e5\u5fd7\u884c\u4e2d\u5c06\u5305\u62ec\u6807\u7b7e stream \uff0c\u503c\u4e3a stderr \u3002","title":"labels"},{"location":"3.k8s/7.logging/promtail/#metrics","text":"\u6839\u636e\u63d0\u53d6\u7684\u6570\u636e\u8ba1\u7b97\u6307\u6807\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u521b\u5efa\u7684 metrics \u6307\u6807\u4e0d\u4f1a\u88ab\u63a8\u9001\u5230 Loki\uff0c\u800c\u662f\u901a\u8fc7 Promtail \u7684 /metrics \u7aef\u70b9\u66b4\u9732\u51fa\u53bb\uff0cPrometheus \u5e94\u8be5\u88ab\u914d\u7f6e\u4e3a\u53ef\u4ee5\u6293\u53d6 Promtail \u7684\u6307\u6807\uff0c\u4ee5\u4fbf\u80fd\u591f\u68c0\u7d22\u8fd9\u4e2a\u9636\u6bb5\u6240\u914d\u7f6e\u7684\u6307\u6807\u6570\u636e\u3002 \u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a # \u4e00\u4e2a\u6620\u5c04\uff0ckey\u4e3ametric\u7684\u540d\u79f0\uff0cvalue\u662f\u7279\u5b9a\u7684metric\u7c7b\u578b metrics: [<string>: [ <metric_counter> | <metric_gauge> | <metric_histogram> ] ...] metric_counter \uff1a\u5b9a\u4e49\u4e00\u4e2a Counter \u7c7b\u578b\u7684\u6307\u6807\uff0c\u5176\u503c\u53ea\u4f1a\u4e0d\u65ad\u589e\u52a0\u3002 metric_gauge \uff1a\u5b9a\u4e49\u4e00\u4e2a Gauge \u7c7b\u578b\u7684\u6307\u6807\uff0c\u5176\u503c\u53ef\u4ee5\u589e\u52a0\u6216\u51cf\u5c11\u3002 metric_histogram \uff1a\u5b9a\u4e49\u4e00\u4e2a\u76f4\u65b9\u56fe\u6307\u6807\u3002 \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a Counter \u6307\u6807\uff1a - metrics: log_lines_total: type: Counter description: \"total number of log lines\" prefix: my_promtail_custom_ max_idle_duration: 24h config: match_all: true action: inc log_bytes_total: type: Counter description: \"total bytes of log lines\" prefix: my_promtail_custom_ max_idle_duration: 24h config: match_all: true count_entry_bytes: true action: add \u8fd9\u4e2a\u6d41\u6c34\u7ebf\u5148\u521b\u5efa\u4e86\u4e00\u4e2a log_lines_total \u7684 Counter\uff0c\u901a\u8fc7\u4f7f\u7528 match_all: true \u53c2\u6570\u4e3a\u6bcf\u4e00\u4e2a\u63a5\u6536\u5230\u7684\u65e5\u5fd7\u884c\u589e\u52a0\u3002 \u7136\u540e\u8fd8\u521b\u5efa\u4e86\u4e00\u4e2a log_bytes_total \u7684 Counter \u6307\u6807\uff0c\u901a\u8fc7\u4f7f\u7528 count_entry_bytes: true \u53c2\u6570\uff0c\u5c06\u6536\u5230\u7684\u6bcf\u4e2a\u65e5\u5fd7\u884c\u7684\u5b57\u8282\u5927\u5c0f\u52a0\u5165\u5230\u6307\u6807\u4e2d\u3002 \u8fd9\u4e24\u4e2a\u6307\u6807\u5982\u679c\u6ca1\u6709\u6536\u5230\u65b0\u7684\u6570\u636e\uff0c\u5c06\u5728 24h \u540e\u5c0f\u65f6\u3002\u53e6\u5916\u8fd9\u4e9b\u9636\u6bb5\u5e94\u8be5\u653e\u5728 pipeline \u7684\u672b\u7aef\uff0c\u5728\u4efb\u4f55\u6807\u7b7e\u9636\u6bb5\u4e4b\u540e\u3002 - regex: expression: \"^.*(?P<order_success>order successful).*$\" - metrics: successful_orders_total: type: Counter description: \"log lines with the message `order successful`\" source: order_success config: action: inc \u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a pipeline \u9996\u5148\u5c1d\u8bd5\u5728\u65e5\u5fd7\u4e2d\u627e\u5230\u6210\u529f\u7684\u8ba2\u5355\uff0c\u5c06\u5176\u63d0\u53d6\u4e3a order_success \u5b57\u6bb5\uff0c\u7136\u540e\u5728 metrics \u9636\u6bb5\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a successful_orders_total \u7684 Counter \u6307\u6807\uff0c\u5176\u503c\u662f\u5728\u53ea\u6709\u63d0\u53d6\u7684\u6570\u636e\u4e2d\u6709 order_success \u7684\u65f6\u5019\u624d\u4f1a\u589e\u52a0\u3002\u8fd9\u4e2a pipeline \u7684\u7ed3\u679c\u662f\u4e00\u4e2a\u6307\u6807\uff0c\u5176\u503c\u53ea\u6709\u5728 Promtail \u6293\u53d6\u7684\u65e5\u5fd7\u4e2d\u5e26\u6709 order successful \u6587\u672c\u7684\u65e5\u5fd7\u65f6\u624d\u4f1a\u589e\u52a0\u3002 - regex: expression: \"^.* order_status=(?P<order_status>.*?) .*$\" - metrics: successful_orders_total: type: Counter description: \"successful orders\" source: order_status config: value: success action: inc failed_orders_total: type: Counter description: \"failed orders\" source: order_status config: value: fail action: inc \u4e0a\u9762\u8fd9\u4e2a pipeline \u9996\u5148\u4f1a\u5c1d\u8bd5\u5728\u65e5\u5fd7\u4e2d\u627e\u5230\u683c\u5f0f\u4e3a order_status=<value> \u7684\u6587\u672c\uff0c\u5c06 <value> \u63d0\u53d6\u5230 order_status \u4e2d\u3002\u8be5\u6307\u6807\u9636\u6bb5\u521b\u5efa\u4e86 successful_orders_total \u548c failed_orders_total \u6307\u6807\uff0c\u53ea\u6709\u5f53\u63d0\u53d6\u6570\u636e\u4e2d\u7684 order_status \u7684\u503c\u5206\u522b\u4e3a success \u6216 fail \u65f6\u624d\u4f1a\u589e\u52a0\u3002","title":"metrics"},{"location":"3.k8s/7.logging/promtail/#tenant","text":"\u8bbe\u7f6e\u65e5\u5fd7\u8981\u4f7f\u7528\u7684\u79df\u6237 ID \u503c\uff0c\u4ece\u63d0\u53d6\u6570\u636e\u4e2d\u7684\u4e00\u4e2a\u5b57\u6bb5\u83b7\u53d6\uff0c\u5982\u679c\u8be5\u5b57\u6bb5\u7f3a\u5931\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u7684 Promtail \u5ba2\u6237\u7aef\u79df\u6237 ID\u3002\u914d\u7f6e\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a tenant: # source \u6216 value \u914d\u7f6e\u9009\u9879\u662f\u5fc5\u987b\u7684\uff0c\u4f46\u4e8c\u8005\u4e0d\u80fd\u540c\u65f6\u4f7f\u7528\uff08\u5b83\u4eec\u662f\u4e92\u65a5\u7684\uff09 [ source: <string> ] # \u5f53\u524d\u9636\u6bb5\u6267\u884c\u65f6\u7528\u6765\u8bbe\u7f6e\u79df\u6237 ID \u7684\u503c\u3002 # \u5f53\u8fd9\u4e2a\u9636\u6bb5\u88ab\u5305\u542b\u5728\u4e00\u4e2a\u5e26\u6709 \"match\" \u7684\u6761\u4ef6\u7ba1\u9053\u4e2d\u65f6\u975e\u5e38\u6709\u7528\u3002 [ value: <string> ] \u6bd4\u5982\u6211\u4eec\u6709\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a pipeline_stages: - json: expressions: customer_id: customer_id - tenant: source: customer_id \u9700\u8981\u83b7\u53d6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"customer_id\": \"1\", \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u5c06\u63d0\u53d6 customer_id \u7684\u503c\u5230 Map \u4e2d\uff0c\u503c\u4e3a 1\u3002\u5728\u7b2c\u4e8c\u4e2a\u79df\u6237\u9636\u6bb5\u5c06\u628a X-Scope-OrgID \u8bf7\u6c42 Header \u5934\uff08Loki \u7528\u6765\u8bc6\u522b\u79df\u6237\uff09\u8bbe\u7f6e\u4e3a\u63d0\u53d6\u7684 customer_id \u7684\u503c\uff0c\u4e5f\u5c31\u662f 1. \u53e6\u5916\u4e00\u79cd\u573a\u666f\u662f\u7528\u914d\u7f6e\u7684\u503c\u6765\u8986\u76d6\u79df\u6237 ID\uff0c\u5982\u4e0b\u6240\u793a\u7684 pipeline \u914d\u7f6e\uff1a pipeline_stages: - json: expressions: app: message: - labels: app: - match: selector: '{app=\"api\"}' stages: - tenant: value: \"team-api\" - output: source: message \u9700\u8981\u6536\u96c6\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"app\": \"api\", \"log\": \"log message\\n\", \"stream\": \"stderr\", \"time\": \"2019-04-30T02:12:41.8443515Z\" } \u8fd9\u4e2a pipeline \u5c06\uff1a Decode JSON \u65e5\u5fd7 \u8bbe\u7f6e\u6807\u7b7e app=\"api\" \u5904\u7406\u5339\u914d\u9636\u6bb5\uff0c\u68c0\u67e5 {app=\"api\"} \u9009\u62e9\u5668\u662f\u5426\u5339\u914d\uff0c\u5982\u679c\u5339\u914d\u4e86\u5219\u6267\u884c\u5b50\u9636\u6bb5\uff0c\u4e5f\u5c31\u662f\u8fd9\u91cc\u7684\u79df\u6237\u9636\u6bb5\uff0c\u8986\u76d6\u503c\u4e3a \"team-api\" \u7684\u79df\u6237\u3002 \u6b64\u5916\u5728\u5904\u7406\u9636\u6bb5\u8fd8\u6709 labeldrop \u9636\u6bb5\uff0c\u5b83\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\u6807\u7b7e\uff0c\u8fd9\u4e9b\u6807\u7b7e\u4e0e\u65e5\u5fd7\u6761\u76ee\u4e00\u8d77\u88ab\u53d1\u9001\u5230 Loki\u3002\u8fd8\u6709\u4e00\u4e2a labelallow \u9636\u6bb5\uff0c\u5b83\u53ea\u5141\u8bb8\u5c06\u6240\u63d0\u4f9b\u7684\u6807\u7b7e\u5305\u542b\u5728\u4e0e\u65e5\u5fd7\u6761\u76ee\u4e00\u8d77\u53d1\u9001\u7ed9 Loki \u7684\u6807\u7b7e\u96c6\u4e2d\u3002","title":"tenant"},{"location":"3.k8s/7.logging/promtail/#_6","text":"\u53ef\u9009\u62e9\u5e94\u7528\u4e00\u4e2a\u9636\u6bb5\u7684\u5b50\u96c6\uff0c\u6216\u6839\u636e\u4e00\u4e9b\u6761\u4ef6\u5220\u9664\u65e5\u5fd7\u6570\u636e\u3002","title":"\u8fc7\u6ee4\u9636\u6bb5"},{"location":"3.k8s/7.logging/promtail/#match","text":"\u5f53\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\u4e0e\u53ef\u914d\u7f6e\u7684 LogQL \u6d41\u9009\u62e9\u5668\u548c\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u76f8\u5339\u914d\u65f6\uff0c\u6709\u6761\u4ef6\u5730\u5e94\u7528\u4e00\u7ec4\u9636\u6bb5\u6216\u5220\u9664\u65e5\u5fd7\u6570\u636e\u3002\u914d\u7f6e\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a match: # LogQL \u6d41\u9009\u62e9\u5668\u5408\u8fc7\u6ee4\u8868\u8fbe\u5f0f\u3002 selector: <string> # pipeline \u540d\u79f0\uff0c\u5f53\u5b9a\u4e49\u7684\u65f6\u5019\uff0c\u5728 pipeline_duration_seconds \u76f4\u65b9\u56fe\u4e2d\u521b\u5efa\u4e00\u4e2a\u989d\u5916\u7684\u6807\u7b7e\uff0c\u8be5\u503c\u4e0e job_name \u4f7f\u7528\u4e0b\u5212\u7ebf\u8fde\u63a5\u3002 [pipeline_name: <string>] # \u51b3\u5b9a\u5f53\u9009\u62e9\u5668\u4e0e\u65e5\u5fd7\u884c\u5339\u914d\u65f6\u91c7\u53d6\u4ec0\u4e48\u52a8\u4f5c\u3002 # \u9ed8\u8ba4\u662f keep\uff0c\u5f53\u8bbe\u7f6e\u4e3a drop \u65f6\uff0c\u65e5\u5fd7\u5c06\u88ab\u5220\u9664\uff0c\u4ee5\u540e\u7684\u6307\u6807\u5c06\u4e0d\u4f1a\u88ab\u8bb0\u5f55\u3002 [action: <string> | default = \"keep\"] # \u5982\u679c\u4f60\u6307\u5b9a\u4e86 `action: drop` \u90a3\u4e48 `logentry_dropped_lines_total` \u8fd9\u4e2a\u6307\u6807\u5c06\u4e3a\u6bcf\u4e00\u4e2a\u88ab\u4e22\u5f03\u7684\u884c\u800c\u589e\u52a0 # \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0creaseon \u6807\u7b7e\u662f `match_stage`\uff0c\u4f46\u662f\u4f60\u53ef\u4ee5\u9009\u62e9\u6307\u5b9a\u4e00\u4e2a\u81ea\u5b9a\u4e49\u503c\u7528\u4e8e\u8be5\u6307\u6807\u7684 `reason` \u6807\u7b7e\u3002 [drop_counter_reason: <string> | default = \"match_stage\"] # \u53ea\u6709\u5f53\u9009\u62e9\u5668\u4e0e\u65e5\u5fd7\u7684\u6807\u7b7e\u76f8\u5339\u914d\u65f6\uff0c\u624d\u4f1a\u51fa\u73b0\u5d4c\u5957\u7684\u6d41\u6c34\u7ebf\u9636\u6bb5\uff1a stages: - [ <regex_stage> <json_stage> | <template_stage> | <match_stage> | <timestamp_stage> | <output_stage> | <labels_stage> | <metrics_stage> | <tenant_stage> ] \u6bd4\u5982\u6211\u4eec\u73b0\u5728\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u7684 pipeline \u914d\u7f6e\uff1a pipeline_stages: - json: expressions: app: - labels: app: - match: selector: '{app=\"loki\"}' stages: - json: expressions: msg: message - match: pipeline_name: \"app2\" selector: '{app=\"pokey\"}' action: keep stages: - json: expressions: msg: msg - match: selector: '{app=\"promtail\"} |~ \".*noisy error.*\"' action: drop drop_counter_reason: promtail_noisy_error - output: source: msg \u8981\u5904\u7406\u7684\u65e5\u5fd7\u6570\u636e\u4e3a\uff1a { \"time\":\"2012-11-01T22:08:41+00:00\", \"app\":\"loki\", \"component\": [\"parser\",\"type\"], \"level\" : \"WARN\", \"message\" : \"app1 log line\" } { \"time\":\"2012-11-01T22:08:41+00:00\", \"app\":\"promtail\", \"component\": [\"parser\",\"type\"], \"level\" : \"ERROR\", \"message\" : \"foo noisy error\" } \u7b2c\u4e00\u4e2a json \u9636\u6bb5\u5c06\u5728\u7b2c\u4e00\u4e2a\u65e5\u5fd7\u884c\u7684\u63d0\u53d6 Map \u6570\u636e\u4e2d\u6dfb\u52a0\u503c app=loki \uff0c\u7136\u540e\u7ecf\u8fc7\u7b2c\u4e8c\u4e2a labels \u9636\u6bb5\u5c06 app \u8f6c\u6362\u6210\u4e00\u4e2a\u6807\u7b7e\u3002\u5bf9\u4e8e\u7b2c\u4e8c\u884c\u65e5\u5fd7\u4e5f\u9075\u5faa\u540c\u6837\u7684\u6d41\u7a0b\uff0c\u53ea\u662f\u503c\u53d8\u6210\u4e86 promtail \u3002 \u7136\u540e\u5728\u7b2c\u4e09\u4e2a match \u9636\u6bb5\u4f7f\u7528 LogQL \u8868\u8fbe\u5f0f {app=\"loki\"} \u8fdb\u884c\u5339\u914d\uff0c\u53ea\u6709\u5728\u6807\u7b7e app=loki \u7684\u65f6\u5019\u624d\u4f1a\u6267\u884c\u5d4c\u5957 json \u9636\u6bb5\uff0c\u8fd9\u91cc\u5408\u6211\u4eec\u7684\u7b2c\u4e00\u884c\u65e5\u5fd7\u662f\u5339\u914d\u7684\uff0c\u7136\u540e\u5d4c\u5957\u7684 json \u9636\u6bb5\u5c06 message \u6570\u636e\u63d0\u53d6\u5230 Map \u6570\u636e\u4e2d\uff0ckey \u53d8\u6210\u4e86 msg \uff0c\u503c\u4e3a app1 log line \u3002 \u63a5\u4e0b\u6765\u6267\u884c\u7b2c\u56db\u4e2a match \u9636\u6bb5\uff0c\u9700\u8981\u5339\u914d app=\"pokey\" \uff0c\u5f88\u663e\u7136\u8fd9\u91cc\u6211\u4eec\u90fd\u4e0d\u5339\u914d\uff0c\u6240\u4ee5\u5d4c\u5957\u7684 json \u5b50\u9636\u6bb5\u4e0d\u4f1a\u88ab\u6267\u884c\u3002 \u7136\u540e\u6267\u884c\u7684\u7b2c\u4e94\u4e2a match \u9636\u6bb5\uff0c\u5c06\u4f1a\u5220\u6389\u4efb\u4f55\u5177\u6709 app=\"promtail\" \u6807\u7b7e\u5e76\u5305\u62ec noisy error \u6587\u672c\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u5e76\u4e14\u8fd8\u5c06\u589e\u52a0 logentry_drop_lines_total \u6307\u6807\uff0c\u6807\u7b7e\u4e3a reason=\"promtail_noisy_error\" \u3002 \u6700\u540e\u7684 output \u8f93\u51fa\u9636\u6bb5\u5c06\u65e5\u5fd7\u884c\u7684\u5185\u5bb9\u6539\u4e3a\u63d0\u53d6\u6570\u636e\u4e2d\u7684 msg \u7684\u503c\u3002\u6211\u4eec\u8fd9\u91cc\u7684\u793a\u4f8b\u6700\u540e\u8f93\u51fa\u4e3a app1 log line \u3002","title":"match"},{"location":"3.k8s/7.logging/promtail/#drop","text":"drop \u9636\u6bb5\u53ef\u4ee5\u8ba9\u6211\u4eec\u6839\u636e\u914d\u7f6e\u6765\u5220\u9664\u65e5\u5fd7\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4f60\u63d0\u4f9b\u591a\u4e2a\u9009\u9879\u914d\u7f6e\uff0c\u5b83\u4eec\u5c06\u88ab\u89c6\u4e3a AND \u5b50\u53e5\uff0c\u5176\u4e2d\u6bcf\u4e2a\u9009\u9879\u5fc5\u987b\u4e3a\u771f\u624d\u80fd\u5220\u9664\u65e5\u5fd7\u3002\u5982\u679c\u4f60\u60f3\u7528\u4e00\u4e2a OR \u5b50\u53e5\u6765\u5220\u9664\uff0c\u90a3\u4e48\u5c31\u6307\u5b9a\u591a\u4e2a\u5220\u9664\u9636\u6bb5\u3002\u914d\u7f6e\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a drop: [source: <string>] # RE2 \u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5982\u679c\u63d0\u4f9b\u4e86 source\uff0c\u5219\u4f1a\u5c1d\u8bd5\u5339\u914d source # \u5982\u679c\u6ca1\u6709\u63d0\u4f9b source\uff0c\u5219\u4f1a\u5c1d\u8bd5\u5339\u914d\u65e5\u5fd7\u884c\u6570\u636e # \u5982\u679c\u63d0\u4f9b\u7684\u6b63\u5219\u5339\u914d\u4e86\u65e5\u5fd7\u884c\u6216\u8005 source\uff0c\u5219\u8be5\u884c\u65e5\u5fd7\u5c06\u88ab\u5220\u9664\u3002 [expression: <string>] # \u53ea\u6709\u5728\u6307\u5b9a source \u6e90\u7684\u60c5\u51b5\u4e0b\u624d\u80fd\u6307\u5b9a value \u503c\u3002 # \u6307\u5b9a value \u4e0e regex \u662f\u9519\u8bef\u7684\u3002 # \u5982\u679c\u63d0\u4f9b\u7684\u503c\u4e0e`source`\u5b8c\u5168\u5339\u914d\uff0c\u8be5\u884c\u5c06\u88ab\u5220\u9664\u3002 [value: <string>] # older_than \u88ab\u89e3\u6790\u4e3a Go duration \u683c\u5f0f # \u5982\u679c\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u5927\u4e8e\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u6240\u63d0\u4f9b\u7684\u65f6\u95f4\uff0c\u5219\u5c06\u88ab\u5220\u9664 [older_than: <duration>] # longer_than \u662f\u4e00\u4e2a\u4ee5 bytes \u4e3a\u5355\u4f4d\u7684\u503c\uff0c\u4efb\u4f55\u8d85\u8fc7\u8fd9\u4e2a\u503c\u7684\u65e5\u5fd7\u884c\u90fd\u5c06\u88ab\u5220\u9664\u3002 # \u53ef\u4ee5\u6307\u5b9a\u4e3a\u6574\u6570\u683c\u5f0f\u7684\u5b57\u8282\u6570\uff1a8192\uff0c\u6216\u8005\u5e26\u540e\u7f00\u7684 8kb [longer_than: <string>|<int>] # \u6bcf\u5f53\u4e00\u4e2a\u65e5\u5fd7\u884c\u6570\u636e\u88ab\u5220\u9664\uff0c\u6307\u6807 `logentry_dropped_lines_total` \u90fd\u4f1a\u589e\u52a0\u3002 # \u9ed8\u8ba4\u7684 reason \u6807\u7b7e\u662f `drop_stage`\uff0c\u7136\u800c\u4f60\u53ef\u4ee5\u9009\u62e9\u6307\u5b9a\u4e00\u4e2a\u81ea\u5b9a\u4e49\u503c\uff0c\u7528\u4e8e\u8be5\u6307\u6807\u7684 \"reason\" \u6807\u7b7e\u3002 [drop_counter_reason: <string> | default = \"drop_stage\"] \u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u7b80\u5355 drop \u9636\u6bb5\u914d\u7f6e\uff1a - drop: expression: \".*debug.*\" \u8be5\u9636\u6bb5\u5c06\u5220\u9664\u4efb\u4f55\u5e26\u6709 debug \u5b57\u6837\u7684\u65e5\u5fd7\u884c\u3002 \u5982\u679c\u662f\u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\uff1a - json: expressions: level: msg: - drop: source: \"level\" expression: \"(error|ERROR)\" \u5219\u4e0b\u9762\u7684\u65e5\u5fd7\u6570\u636e\u90fd\u5c06\u88ab\u5220\u9664\uff1a {\"time\":\"2019-01-01T01:00:00.000000001Z\", \"level\": \"error\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} {\"time\":\"2019-01-01T01:00:00.000000001Z\", \"level\": \"ERROR\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} \u7136\u540e\u4f7f\u7528\u4e0b\u9762\u7684\u914d\u7f6e\u6765\u5220\u9664\u8001\u7684\u65e5\u5fd7\u6570\u636e\uff1a - json: expressions: time: msg: - timestamp: source: time format: RFC3339 - drop: older_than: 24h drop_counter_reason: \"line_too_old\" \u9700\u8981\u6ce8\u610f\u7684\u662f\u4e3a\u4e86\u8ba9 old_than \u53d1\u6325\u4f5c\u7528\uff0c\u4f60\u5fc5\u987b\u5728\u5e94\u7528 drop \u9636\u6bb5\u4e4b\u524d\uff0c\u4f7f\u7528\u65f6\u95f4\u6233\u9636\u6bb5\u6765\u8bbe\u7f6e\u6293\u53d6\u65e5\u5fd7\u884c\u7684\u65f6\u95f4\u6233\u3002 \u6bd4\u5982\u5f53\u524d\u7684\u6444\u53d6\u65f6\u95f4\u4e3a 2021-05-01T12:00:00Z \uff0c\u5f53\u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u65f6\uff0c\u4f1a\u5220\u9664\u8fd9\u4e2a\u65e5\u5fd7\u884c\uff1a {\"time\":\"2021-05-01T12:00:00Z\", \"level\": \"error\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} \u4f46\u662f\u4e0b\u9762\u7684\u65e5\u5fd7\u6570\u636e\u4e0d\u4f1a\u88ab\u5220\u9664\uff1a {\"time\":\"2021-05-03T12:00:00Z\", \"level\": \"error\", \"msg\":\"11.11.11.11 - \"POST /loki/api/push/ HTTP/1.1\" 200 932 \"-\" \"Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6\"} \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5f53\u524d\u65f6\u95f4\u662f `2021-05-03T16:00:00Z \uff0c older_than \u662f 24h\u3002\u6240\u6709\u65f6\u95f4\u6233\u8d85\u8fc7 2021-05-02T16:00:00Z \u7684\u65e5\u5fd7\u884c\u90fd\u5c06\u88ab\u5220\u9664\u3002 \u8fd9\u4e2a\u5220\u9664\u9636\u6bb5\u5220\u9664\u7684\u6240\u6709\u884c\u4e5f\u5c06\u589e\u52a0 logentry_drop_lines_total \u6307\u6807\uff0c\u5e76\u6807\u660e\u539f\u56e0\u4e3a \"line_too_old\" \u3002 \u4e0b\u9762\u662f\u53e6\u5916\u4e00\u4e2a\u590d\u6742\u70b9\u7684\u914d\u7f6e\uff1a - json: expressions: time: msg: - timestamp: source: time format: RFC3339 - drop: older_than: 24h - drop: longer_than: 8kb - drop: source: msg regex: \".*trace.*\" \u4e0a\u9762\u7684 pipeline \u6267\u884c\u540e\u5c06\u5220\u9664\u6389\u6240\u6709\u8d85\u8fc7 24 \u5c0f\u65f6 \u6216\u8005 \u8d85\u8fc7 8kb \u7684\u65e5\u5fd7 \u6216\u8005 json \u7684 msg \u503c\u4e2d\u5305\u542b trace \u5b57\u6837\u7684\u65e5\u5fd7\u3002","title":"drop"},{"location":"3.k8s/7.logging/promtail/#scraping","text":"Promtail \u53ef\u4ee5\u901a\u8fc7 YAML \u6587\u4ef6\u4e2d\u7684 scrape_configs \u914d\u7f6e\u6765\u81ea\u52a8\u53d1\u73b0\u65e5\u5fd7\u6587\u4ef6\u5e76\u4ece\u4e2d\u63d0\u53d6\u6807\u7b7e\uff0c\u8be5\u8bed\u6cd5\u4e0e Prometheus \u4e2d\u7684\u914d\u7f6e\u6bd4\u8f83\u7c7b\u4f3c\u3002 scrape_configs \u5305\u542b\u4e00\u4e2a\u6216\u591a\u4e2a\u914d\u7f6e\u6761\u76ee\uff0c\u4f1a\u5bf9\u6bcf\u4e2a\u53d1\u73b0\u7684\u76ee\u6807\u6267\u884c\u65e5\u5fd7\u6293\u53d6\u4efb\u52a1\u3002 scrape_configs: - job_name: local static_configs: - ... - job_name: kubernetes kubernetes_sd_config: - ... \u4f46\u662f\u9700\u8981\u6ce8\u610f\u5982\u679c\u6709\u4e00\u4e2a\u4ee5\u4e0a\u7684\u6293\u53d6\u914d\u7f6e\u4e0e\u4f60\u7684\u65e5\u5fd7\u5339\u914d\u4e86\uff0c\u90a3\u4e48\u53ef\u80fd\u4f1a\u5f97\u5230\u91cd\u590d\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u56e0\u4e3a\u65e5\u5fd7\u662f\u5728\u4e0d\u540c\u7684\u6d41\u4e2d\u53d1\u9001\u7684\uff0c\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u7684\u6807\u7b7e\u3002 Promtail \u4e2d\u5b58\u5728\u51e0\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u6807\u7b7e\uff1a \u4ee5 __ (\u4e24\u4e2a\u4e0b\u5212\u7ebf)\u5f00\u5934\u7684\u6807\u7b7e\u662f \u5185\u90e8\u6807\u7b7e \uff0c\u5b83\u4eec\u901a\u5e38\u6765\u81ea\u52a8\u6001\u6570\u636e\u6e90\uff0c\u6bd4\u5982\u670d\u52a1\u53d1\u73b0\u3002\u4e00\u65e6\u91cd\u65b0\u6253\u4e0a\u6807\u7b7e\uff0c\u5b83\u4eec\u5c31\u4f1a\u4ece\u6807\u7b7e\u96c6\u4e2d\u5220\u9664\uff0c\u5982\u679c\u8981\u4fdd\u7559\u5185\u90e8\u6807\u7b7e\u53d1\u9001\u5230 Loki\uff0c\u8bf7\u91cd\u65b0\u547d\u540d\u5b83\u4eec\uff0c\u4f7f\u5b83\u4eec\u4e0d\u4ee5 __ \u5f00\u5934\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u7684 Relabeling \u90e8\u5206\u914d\u7f6e\u3002 \u4ee5 __meta_kubernetes_pod_label_* \u5f00\u5934\u7684\u6807\u7b7e\u662f \u5143\u6807\u7b7e \uff0c\u662f\u6839\u636e\u4f60\u7684 Kubernetes Pod \u7684\u6807\u7b7e\u751f\u6210\u7684\u3002\u6bd4\u5982\u4f60\u7684\u6709\u4e00\u4e2a Pod \u7684\u6807\u7b7e\u540d\u79f0\u662f foobar \uff0c\u90a3\u4e48 scrape_configs \u90e8\u5206\u5c06\u6536\u5230\u4e00\u4e2a\u540d\u4e3a __meta_kubernetes_pod_label_name \u7684\u5185\u90e8\u6807\u7b7e\uff0c\u503c\u4f1a\u88ab\u8bbe\u7f6e\u4e3a foobar \u3002 \u5176\u4ed6 __meta_kubernetes_* \u5f00\u5934\u7684\u6807\u7b7e\u662f\u57fa\u4e8e\u5176\u4ed6 Kubernetes \u5143\u6570\u636e\u751f\u6210\u7684\uff0c\u6bd4\u5982 Pod \u7684\u547d\u540d\u7a7a\u95f4\uff08 __meta_kubernetes_namespace \uff09\u6216 Pod \u5185\u90e8\u7684\u5bb9\u5668\u540d\u79f0\uff08 __meta_kubernetes_pod_container_name \uff09\u7b49\u7b49\uff0c\u5173\u4e8e Kubernetes \u5143\u6807\u7b7e\u7684\u5b8c\u6574\u5217\u8868\uff0c\u53ef\u4ee5\u53c2\u8003 Prometheus \u6587\u6863 \u7684\u8bf4\u660e\uff0c\u56e0\u4e3a\u8fd9\u4e8c\u8005\u5b9e\u73b0\u65b9\u5f0f\u662f\u4e00\u81f4\u7684\u3002 __path__ \u6807\u7b7e\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u6807\u7b7e\uff0cPromtail \u5728\u53d1\u73b0\u540e\u4f7f\u7528\u5b83\u6765\u8ba1\u7b97\u8981\u8bfb\u53d6\u7684\u6587\u4ef6\u4f4d\u7f6e\uff0c\u5141\u8bb8\u4f7f\u7528\u901a\u914d\u7b26\uff0c\u4f8b\u5982 /var/log/*.log \u7528\u4e8e\u83b7\u53d6\u6307\u5b9a\u76ee\u5f55\u4e2d\u6240\u6709\u5e26\u6709 log \u6269\u5c55\u540d\u7684\u6587\u4ef6\uff0c\u800c /var/log/**/*.log \u7528\u4e8e\u9012\u5f52\u5339\u914d\u6587\u4ef6\u4e0e\u76ee\u5f55\u3002 \u5728 __path__ \u4e2d\u627e\u5230\u7684\u6bcf\u4e2a\u6587\u4ef6\u90fd\u4f1a\u6dfb\u52a0\u6587\u4ef6\u540d\u6807\u7b7e\uff0c\u4ee5\u786e\u4fdd\u65e5\u5fd7\u6d41\u7684\u552f\u4e00\u6027\uff0c\u5b83\u88ab\u8bbe\u7f6e\u4e3a\u8be5\u884c\u88ab\u8bfb\u53d6\u7684\u6587\u4ef6\u7684\u7edd\u5bf9\u8def\u5f84\u3002 Promtail \u53ef\u4ee5\u4f7f\u7528 Kubernetes API \u6765\u53d1\u73b0\u4f5c\u4e3a\u76ee\u6807\u7684 Pod\uff0c\u4f46\u9700\u8981\u6ce8\u610f\u5b83 \u53ea\u80fd\u4e0e Promtail \u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u7684 Pod \u4e2d\u8bfb\u53d6\u65e5\u5fd7 \uff0cPromtail \u4f1a\u5728\u6bcf\u4e2a\u76ee\u6807\u4e2d\u67e5\u8be2\u4e00\u4e2a __host__ \u6807\u7b7e\uff0c\u5e76\u9a8c\u8bc1\u5b83\u662f\u5426\u4e0e Promtail \u7684\u4e3b\u673a\u540d\u76f8\u540c\u3002 \u6240\u4ee5\u4efb\u4f55\u65f6\u5019\u4f7f\u7528 Kubernetes \u670d\u52a1\u53d1\u73b0\uff0c\u90fd\u5fc5\u987b\u6709\u4e00\u4e2a relabel_config \u914d\u7f6e\uff0c\u4ece __meta_kubernetes_pod_node_name \u5143\u6807\u7b7e\u521b\u5efa\u4e00\u4e2a\u4e2d\u95f4\u7684 __host__ \u6807\u7b7e\u3002 relabel_configs: - source_labels: [\"__meta_kubernetes_pod_node_name\"] target_label: \"__host__\"","title":"Scraping"},{"location":"3.k8s/7.logging/promtail/#relabeling","text":"Relabeling \u8868\u793a\u4fee\u6539 labels \u6807\u7b7e\uff1a\u6dfb\u52a0\u3001\u4fee\u6539\u6216\u5220\u9664\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 scrape_configs \u4e2d\u7684 relabel_configs \u6765\u8fdb\u884c Relabel \u64cd\u4f5c\u3002\u7531\u4e8e\u91c7\u7528\u7684\u4e0e Prometheus \u4e00\u6837\u7684 Relabel \u673a\u5236\uff0c\u6240\u4ee5\u64cd\u4f5c\u65b9\u5f0f\u4e0e Prometheus \u662f\u4e00\u81f4\u7684\u3002 \u6b63\u5219\u8868\u8fbe\u5f0f Prometheus \u4f7f\u7528 RE2 \u6b63\u5219\u8868\u8fbe\u5f0f \u56fa\u5b9a\u7684\uff1a\u6b63\u5219\u8868\u8fbe\u5f0f bar \u4e0d\u4f1a\u5339\u914d foobar .*bar.* \u5219\u4e0d\u56fa\u5b9a \u4e5f\u53ef\u4ee5\u4f7f\u7528\u6355\u83b7\u7ec4\uff1a (.*)bar \u9488\u5bf9 foobar \u4f1a\u521b\u5efa\u4e00\u4e2a $1 \u7684\u53d8\u91cf\uff0c\u5b83\u7684\u503c\u662f foo \u6b63\u5219\u793a\u4f8b prom|alert \u5c06\u4f1a\u5339\u914d prom \u4e0e alert 201[78] \u5c06\u5339\u914d 2017 \u4e0e 2018 promcon(20.+) \u5c06\u5339\u914d promcon2020 \u3001 promcon20xx \u7b49\u7b49\uff0c\u5982\u679c\u662f promcon2018 \uff0c\u5219 $1 \u7684\u503c\u4e3a 2018 \u3002 relabel_configs \u4e2d\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u4e00\u4e2a drop \u64cd\u4f5c\u6765\u62d2\u7edd\u76ee\u6807\uff1a\u5982\u679c\u6807\u7b7e\u503c\u4e0e\u6307\u5b9a\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u5219\u88ab drop \u6389\u3002\u5f53\u4e00\u4e2a\u76ee\u6807\u88ab drop \u6389\uff0c\u62e5\u6709\u7684 scrape_config \u5c06\u4e0d\u4f1a\u5904\u7406\u6765\u81ea\u8be5\u7279\u5b9a\u6765\u6e90\u7684\u65e5\u5fd7\uff0c\u5176\u4ed6\u6ca1\u6709 drop \u52a8\u4f5c\u7684 scrape_configs \u4ece\u540c\u4e00\u76ee\u6807\u8bfb\u53d6\u7684\u65e5\u5fd7\u4ecd\u7136\u53ef\u4ee5\u4f7f\u7528\u5e76\u8f6c\u53d1\u7ed9 Loki\u3002 relabel_configs \u7684\u4e00\u4e2a\u5e38\u89c1\u7528\u4f8b\u5c31\u662f\u5c06\u4e00\u4e2a\u5185\u90e8\u6807\u7b7e\u5982 __meta_kubernetes_* \u8f6c\u6362\u4e3a\u4e00\u4e2a\u4e2d\u95f4\u7684\u5185\u90e8\u6807\u7b7e\u5982 __service__ \uff0c\u7136\u540e\u8fd9\u4e2a\u4e2d\u95f4\u7684\u5185\u90e8\u6807\u7b7e\u53ef\u4ee5\u6839\u636e value \u503c\u88ab drop \u6389\uff0c\u6216\u8005\u8f6c\u5316\u4e3a\u6700\u7ec8\u7684\u5916\u90e8\u6807\u7b7e\uff0c\u5982 __job__ \u3002 \u793a\u4f8b \u5982\u679c\u4e00\u4e2a\u6807\u7b7e\uff08\u4f8b\u5b50\u4e2d\u7684 __service__ \uff09\u4e3a\u7a7a\uff0c\u5219\u653e\u5f03\u6293\u53d6\u76ee\u6807\uff1a - action: drop regex: '' source_labels: - __service__ \u5982\u679c\u4efb\u4f55\u4e00\u4e2a source_labels \u6807\u7b7e\u5305\u542b\u4e00\u4e2a\u503c\uff0c\u5219\u5220\u9664\u6293\u53d6\u76ee\u6807\uff1a - action: drop regex: .+ separator: '' source_labels: - __meta_kubernetes_pod_label_name - __meta_kubernetes_pod_label_app \u901a\u8fc7\u91cd\u547d\u540d\u4e00\u4e2a\u5185\u90e8\u6807\u7b7e\u6765\u6301\u4e45\u5316\uff0c\u8fd9\u6837\u5b83\u5c31\u4f1a\u88ab\u53d1\u9001\u5230 Loki\uff1a - action: replace source_labels: - __meta_kubernetes_namespace target_label: namespace \u901a\u8fc7\u6620\u5c04\u4fdd\u7559\u6240\u6709\u7684 Kubernetes Pod \u6807\u7b7e\uff0c\u6bd4\u5982\u5c06 __meta_kube__meta_kubernetes_pod_label_foo \u6620\u5c04\u4e3a foo \uff1a - action: labelmap regex: __meta_kubernetes_pod_label_(.+)","title":"Relabeling"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/","text":"\u5fae\u670d\u52a1\u6a21\u5f0f \u00b6 \u5fae\u670d\u52a1\u6a21\u5f0f \u00b6 \u524d\u9762\u6211\u4eec\u63d0\u5230\u4e86 Loki \u90e8\u7f72\u7684\u5355\u4f53\u6a21\u5f0f\u548c\u8bfb\u5199\u5206\u79bb\u4e24\u79cd\u6a21\u5f0f\uff0c\u5f53\u4f60\u7684\u6bcf\u5929\u65e5\u5fd7\u89c4\u6a21\u8d85\u8fc7\u4e86 TB \u7684\u91cf\u7ea7\uff0c\u90a3\u4e48\u53ef\u80fd\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230\u5fae\u670d\u52a1\u6a21\u5f0f\u6765\u90e8\u7f72 Loki \u4e86\u3002 \u5fae\u670d\u52a1\u90e8\u7f72\u6a21\u5f0f\u5c06 Loki \u7684\u7ec4\u4ef6\u5b9e\u4f8b\u5316\u4e3a\u4e0d\u540c\u7684\u8fdb\u7a0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u88ab\u8c03\u7528\u5e76\u6307\u5b9a\u5176\u76ee\u6807\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u7528\u4e8e\u5185\u90e8\u8bf7\u6c42\u7684 gRPC \u670d\u52a1\u5668\u548c\u4e00\u4e2a\u7528\u4e8e\u5916\u90e8 API \u8bf7\u6c42\u7684 HTTP \u670d\u52a1\u3002 ingester distributor query-frontend query-scheduler querier index-gateway ruler compactor \u5c06\u7ec4\u4ef6\u4f5c\u4e3a\u5355\u72ec\u7684\u5fae\u670d\u52a1\u8fd0\u884c\u5141\u8bb8\u901a\u8fc7\u589e\u52a0\u5fae\u670d\u52a1\u7684\u6570\u91cf\u6765\u8fdb\u884c\u6269\u5c55\uff0c\u5b9a\u5236\u7684\u96c6\u7fa4\u5bf9\u5404\u4e2a\u7ec4\u4ef6\u5177\u6709\u66f4\u597d\u7684\u53ef\u89c2\u5bdf\u6027\u3002\u5fae\u670d\u52a1\u6a21\u5f0f\u90e8\u7f72\u662f\u6700\u9ad8\u6548\u7684 Loki \u5b89\u88c5\uff0c\u4f46\u662f\uff0c\u5b83\u4eec\u7684\u8bbe\u7f6e\u548c\u7ef4\u62a4\u4e5f\u662f\u6700\u590d\u6742\u7684\u3002 \u5bf9\u4e8e\u8d85\u5927\u7684 Loki \u96c6\u7fa4\u6216\u9700\u8981\u5bf9\u6269\u5c55\u548c\u96c6\u7fa4\u64cd\u4f5c\u8fdb\u884c\u66f4\u591a\u63a7\u5236\u7684\u96c6\u7fa4\uff0c\u5efa\u8bae\u4f7f\u7528\u5fae\u670d\u52a1\u6a21\u5f0f\u3002 \u5fae\u670d\u52a1\u6a21\u5f0f\u6700\u9002\u5408\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\uff0c\u63d0\u4f9b\u4e86 Jsonnet \u548c Helm Chart \u4e24\u79cd\u5b89\u88c5\u65b9\u5f0f\u3002 \u5b89\u88c5 \u00b6 \u540c\u6837\u8fd9\u91cc\u6211\u4eec\u8fd8\u662f\u4f7f\u7528 Helm Chart \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki\uff0c\u5728\u5b89\u88c5\u4e4b\u524d\u8bb0\u5f97\u5c06\u524d\u9762\u7ae0\u8282\u5b89\u88c5\u7684 Loki \u76f8\u5173\u670d\u52a1\u5220\u9664\u3002 \u9996\u5148\u83b7\u53d6\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Chart \u5305\uff1a $ helm repo add grafana https://grafana.github.io/helm-charts $ helm pull grafana/loki-distributed --untar --version 0.48.4 $ cd loki-simple-scalable \u8be5 Chart \u5305\u652f\u6301\u4e0b\u8868\u4e2d\u663e\u793a\u7684\u7ec4\u4ef6\uff0cIngester\u3001distributor\u3001querier \u548c query-frontend \u7ec4\u4ef6\u662f\u59cb\u7ec8\u5b89\u88c5\u7684\uff0c\u5176\u4ed6\u7ec4\u4ef6\u662f\u53ef\u9009\u7684\u3002 \u7ec4\u4ef6 \u53ef\u9009 \u9ed8\u8ba4\u5f00\u542f\uff1f gateway \u2705 \u2705 ingester \u274e n/a distributor \u274e n/a querier \u274e n/a query-frontend \u274e n/a table-manager \u2705 \u274e compactor \u2705 \u274e ruler \u2705 \u274e index-gateway \u2705 \u274e memcached-chunks \u2705 \u274e memcached-frontend \u2705 \u274e memcached-index-queries \u2705 \u274e memcached-index-writes \u2705 \u274e \u8be5 Chart \u5305\u5728\u5fae\u670d\u52a1\u6a21\u5f0f\u4e0b\u914d\u7f6e Loki\uff0c\u5df2\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u4e0e boltdb-shipper \u548c memberlist \u4e00\u8d77\u4f7f\u7528\uff0c\u800c\u5176\u4ed6\u5b58\u50a8\u548c\u53d1\u73b0\u9009\u9879\u4e5f\u53ef\u4ee5\u4f7f\u7528\uff0c\u4f46\u662f\uff0c\u8be5\u56fe\u8868\u4e0d\u652f\u6301\u8bbe\u7f6e Consul \u6216 Etcd \u4ee5\u8fdb\u884c\u53d1\u73b0\uff0c\u5b83\u4eec\u9700\u8981\u8fdb\u884c\u5355\u72ec\u914d\u7f6e\uff0c\u76f8\u53cd\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0d\u9700\u8981\u5355\u72ec\u7684\u952e/\u503c\u5b58\u50a8\u7684 memberlist \u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8be5 Chart \u5305\u4f1a\u4e3a\u6210\u5458\u5217\u8868\u521b\u5efa\u4e86\u4e00\u4e2a Headless Service\uff0cingester\u3001distributor\u3001querier \u548c ruler \u662f\u5176\u4e2d\u7684\u4e00\u90e8\u5206\u3002 \u5b89\u88c5 minio \u00b6 \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 memberlist\u3001boltdb-shipper \u548c minio \u6765\u4f5c\u5b58\u50a8\uff0c\u7531\u4e8e\u8fd9\u4e2a Chart \u5305\u6ca1\u6709\u5305\u542b minio\uff0c\u6240\u4ee5\u9700\u8981\u6211\u4eec\u5148\u5355\u72ec\u5b89\u88c5 minio\uff1a $ helm repo add minio https://helm.min.io/ $ helm pull minio/minio --untar --version 8.0.10 $ cd minio \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/loki-values.yaml accessKey: \"myaccessKey\" secretKey: \"mysecretKey\" persistence: enabled: true storageClass: \"local-path\" accessMode: ReadWriteOnce size: 5Gi service: type: NodePort port: 9000 nodePort: 32000 resources: requests: memory: 1Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u914d\u7f6e\u7684 values \u6587\u4ef6\u5b89\u88c5 minio\uff1a $ helm upgrade --install minio -n logging -f ci/loki-values.yaml . Release \"minio\" does not exist. Installing it now. NAME: minio LAST DEPLOYED: Sun Jun 19 16:56:28 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: Minio can be accessed via port 9000 on the following DNS name from within your cluster: minio.logging.svc.cluster.local To access Minio from localhost, run the below commands: 1. export POD_NAME=$(kubectl get pods --namespace logging -l \"release=minio\" -o jsonpath=\"{.items[0].metadata.name}\") 2. kubectl port-forward $POD_NAME 9000 --namespace logging Read more about port forwarding here: http://kubernetes.io/docs/user-guide/kubectl/kubectl_port-forward/ You can now access Minio server on http://localhost:9000. Follow the below steps to connect to Minio server with mc client: 1. Download the Minio mc client - https://docs.minio.io/docs/minio-client-quickstart-guide 2. Get the ACCESS_KEY=$(kubectl get secret minio -o jsonpath=\"{.data.accesskey}\" | base64 --decode) and the SECRET_KEY=$(kubectl get secret minio -o jsonpath=\"{.data.secretkey}\" | base64 --decode) 3. mc alias set minio-local http://localhost:9000 \"$ACCESS_KEY\" \"$SECRET_KEY\" --api s3v4 4. mc ls minio-local Alternately, you can use your browser or the Minio SDK to access the server - https://docs.minio.io/categories/17 \u5b89\u88c5\u5b8c\u6210\u540e\u67e5\u770b\u5bf9\u5e94\u7684 Pod \u72b6\u6001\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE minio-548656f786-gctk9 1/1 Running 0 2m45s $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE minio NodePort 10.111.58.196 <none> 9000:32000/TCP 3h16m \u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u7684 32000 \u7aef\u53e3\u6765\u8bbf\u95ee minio\uff1a \u7136\u540e\u8bb0\u5f97\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a loki-data \u7684 bucket\u3002 \u5b89\u88c5 Loki \u00b6 \u73b0\u5728\u5c06\u6211\u4eec\u7684\u5bf9\u8c61\u5b58\u50a8\u51c6\u5907\u597d\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u5b89\u88c5\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/minio-values.yaml loki: structuredConfig: ingester: max_transfer_retries: 0 chunk_idle_period: 1h chunk_target_size: 1536000 max_chunk_age: 1h storage_config: aws: endpoint: minio.logging.svc.cluster.local:9000 insecure: true bucketnames: loki-data access_key_id: myaccessKey secret_access_key: mysecretKey s3forcepathstyle: true boltdb_shipper: shared_store: s3 schema_config: configs: - from: 2022-06-21 store: boltdb-shipper object_store: s3 schema: v12 index: prefix: loki_index_ period: 24h distributor: replicas: 2 ingester: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path querier: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path queryFrontend: replicas: 2 gateway: nginxConfig: httpSnippet: |- client_max_body_size 100M; serverSnippet: |- client_max_body_size 100M; \u4e0a\u8ff0\u914d\u7f6e\u4f1a\u9009\u62e9\u6027\u5730\u8986\u76d6 loki.config \u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u9ed8\u8ba4\u503c\uff0c\u4f7f\u7528 loki.structuredConfig \u53ef\u4ee5\u5728\u5916\u90e8\u8bbe\u7f6e\u5927\u591a\u6570\u914d\u7f6e\u53c2\u6570\u3002 loki.config \u3001 loki.schemaConfig \u548c loki.storageConfig \u4e5f\u53ef\u4ee5\u4e0e loki.structuredConfig \u7ed3\u5408\u4f7f\u7528\u3002 loki.structuredConfig \u4e2d\u7684\u503c\u4f18\u5148\u7ea7\u66f4\u9ad8\u3002 \u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 loki.structuredConfig.storage_config.aws \u6307\u5b9a\u4e86\u7528\u4e8e\u4fdd\u5b58\u6570\u636e\u7684 minio \u914d\u7f6e\uff0c\u4e3a\u4e86\u9ad8\u53ef\u7528\uff0c\u6838\u5fc3\u7684\u51e0\u4e2a\u7ec4\u4ef6\u6211\u4eec\u914d\u7f6e\u4e86 2 \u4e2a\u526f\u672c\uff0c ingester \u548c querier \u914d\u7f6e\u4e86\u6301\u4e45\u5316\u5b58\u50a8\u3002 \u73b0\u5728\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff1a $ helm upgrade --install loki -n logging -f ci/minio-values.yaml . Release \"loki\" does not exist. Installing it now. NAME: loki LAST DEPLOYED: Tue Jun 21 16:20:10 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Loki Chart version: 0.48.4 Loki version: 2.5.0 *********************************************************************** Installed components: * gateway * ingester * distributor * querier * query-frontend \u4e0a\u9762\u4f1a\u5206\u522b\u5b89\u88c5\u51e0\u4e2a\u7ec4\u4ef6\uff1agateway\u3001ingester\u3001distributor\u3001querier\u3001query-frontend\uff0c\u5bf9\u5e94\u7684 Pod \u72b6\u6001\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE loki-loki-distributed-distributor-5dfdd5bd78-nxdq8 1/1 Running 0 2m40s loki-loki-distributed-distributor-5dfdd5bd78-rh4gz 1/1 Running 0 116s loki-loki-distributed-gateway-6f4cfd898c-hpszv 1/1 Running 0 21m loki-loki-distributed-ingester-0 1/1 Running 0 96s loki-loki-distributed-ingester-1 1/1 Running 0 2m38s loki-loki-distributed-querier-0 1/1 Running 0 2m2s loki-loki-distributed-querier-1 1/1 Running 0 2m33s loki-loki-distributed-query-frontend-6d9845cb5b-p4vns 1/1 Running 0 4s loki-loki-distributed-query-frontend-6d9845cb5b-sq5hr 1/1 Running 0 2m40s minio-548656f786-gctk9 1/1 Running 1 (123m ago) 47h $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE loki-loki-distributed-distributor ClusterIP 10.102.156.127 <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-gateway ClusterIP 10.111.73.138 <none> 80/TCP 22m loki-loki-distributed-ingester ClusterIP 10.98.238.236 <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-ingester-headless ClusterIP None <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-memberlist ClusterIP None <none> 7946/TCP 22m loki-loki-distributed-querier ClusterIP 10.101.117.137 <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-querier-headless ClusterIP None <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-query-frontend ClusterIP None <none> 3100/TCP,9095/TCP,9096/TCP 22m minio NodePort 10.111.58.196 <none> 9000:32000/TCP 47h Loki \u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get cm -n logging loki-loki-distributed -o yaml apiVersion: v1 data: config.yaml: | auth_enabled: false chunk_store_config: max_look_back_period: 0s compactor: shared_store: filesystem distributor: ring: kvstore: store: memberlist frontend: compress_responses: true log_queries_longer_than: 5s tail_proxy_url: http://loki-loki-distributed-querier:3100 frontend_worker: frontend_address: loki-loki-distributed-query-frontend:9095 ingester: chunk_block_size: 262144 chunk_encoding: snappy chunk_idle_period: 1h chunk_retain_period: 1m chunk_target_size: 1536000 lifecycler: ring: kvstore: store: memberlist replication_factor: 1 max_chunk_age: 1h max_transfer_retries: 0 wal: dir: /var/loki/wal limits_config: enforce_metric_name: false max_cache_freshness_per_query: 10m reject_old_samples: true reject_old_samples_max_age: 168h split_queries_by_interval: 15m memberlist: join_members: - loki-loki-distributed-memberlist query_range: align_queries_with_step: true cache_results: true max_retries: 5 results_cache: cache: enable_fifocache: true fifocache: max_size_items: 1024 validity: 24h ruler: alertmanager_url: https://alertmanager.xx external_url: https://alertmanager.xx ring: kvstore: store: memberlist rule_path: /tmp/loki/scratch storage: local: directory: /etc/loki/rules type: local schema_config: configs: - from: \"2022-06-21\" index: period: 24h prefix: loki_index_ object_store: s3 schema: v12 store: boltdb-shipper server: http_listen_port: 3100 storage_config: aws: access_key_id: myaccessKey bucketnames: loki-data endpoint: minio.logging.svc.cluster.local:9000 insecure: true s3forcepathstyle: true secret_access_key: mysecretKey boltdb_shipper: active_index_directory: /var/loki/index cache_location: /var/loki/cache cache_ttl: 168h shared_store: s3 filesystem: directory: /var/loki/chunks table_manager: retention_deletes_enabled: false retention_period: 0s kind: ConfigMap # ...... \u540c\u6837\u5176\u4e2d\u6709\u4e00\u4e2a gateway \u7ec4\u4ef6\u4f1a\u6765\u5e2e\u52a9\u6211\u4eec\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u6b63\u786e\u7684\u7ec4\u4ef6\u4e2d\u53bb\uff0c\u8be5\u7ec4\u4ef6\u540c\u6837\u5c31\u662f\u4e00\u4e2a nginx \u670d\u52a1\uff0c\u5bf9\u5e94\u7684\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a $ kubectl -n logging exec -it loki-loki-distributed-gateway-6f4cfd898c-hpszv -- cat /etc/nginx/nginx.conf worker_processes 5; ## Default: 1 error_log /dev/stderr; pid /tmp/nginx.pid; worker_rlimit_nofile 8192; events { worker_connections 4096; ## Default: 1024 } http { client_body_temp_path /tmp/client_temp; proxy_temp_path /tmp/proxy_temp_path; fastcgi_temp_path /tmp/fastcgi_temp; uwsgi_temp_path /tmp/uwsgi_temp; scgi_temp_path /tmp/scgi_temp; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] $status ' '\"$request\" $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /dev/stderr main; sendfile on; tcp_nopush on; resolver kube-dns.kube-system.svc.cluster.local; client_max_body_size 100M; server { listen 8080; location = / { return 200 'OK'; auth_basic off; } location = /api/prom/push { proxy_pass http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100$request_uri; } location = /api/prom/tail { proxy_pass http://loki-loki-distributed-querier.logging.svc.cluster.local:3100$request_uri; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } # Ruler location ~ /prometheus/api/v1/alerts.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /prometheus/api/v1/rules.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /api/prom/rules.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /api/prom/alerts.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /api/prom/.* { proxy_pass http://loki-loki-distributed-query-frontend.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/push { proxy_pass http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/tail { proxy_pass http://loki-loki-distributed-querier.logging.svc.cluster.local:3100$request_uri; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } location ~ /loki/api/.* { proxy_pass http://loki-loki-distributed-query-frontend.logging.svc.cluster.local:3100$request_uri; } client_max_body_size 100M; } } \u4ece\u4e0a\u9762\u914d\u7f6e\u53ef\u4ee5\u770b\u51fa\u5bf9\u5e94\u7684 Push \u7aef\u70b9 /api/prom/push \u4e0e /loki/api/v1/push \u4f1a\u8f6c\u53d1\u7ed9 http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100$request_uri; \uff0c\u4e5f\u5c31\u662f\u5bf9\u5e94\u7684 distributor \u670d\u52a1\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/component=distributor,app.kubernetes.io/instance=loki,app.kubernetes.io/name=loki-distributed NAME READY STATUS RESTARTS AGE loki-loki-distributed-distributor-5dfdd5bd78-nxdq8 1/1 Running 0 8m20s loki-loki-distributed-distributor-5dfdd5bd78-rh4gz 1/1 Running 0 7m36s \u6240\u4ee5\u5982\u679c\u6211\u4eec\u8981\u5199\u5165\u65e5\u5fd7\u6570\u636e\uff0c\u81ea\u7136\u73b0\u5728\u662f\u5199\u5165\u5230 gateway \u7684 Push \u7aef\u70b9\u4e0a\u53bb\u3002\u4e3a\u4e86\u9a8c\u8bc1\u5e94\u7528\u662f\u5426\u6b63\u5e38\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5b89\u88c5 Promtail \u548c Grafana \u6765\u8fdb\u884c\u6570\u636e\u7684\u8bfb\u5199\u3002 \u5b89\u88c5 Promtail \u00b6 \u83b7\u53d6 promtail \u7684 Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull grafana/promtail --untar $ cd promtail \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/minio-values.yaml rbac: pspEnabled: false config: clients: - url: http://loki-loki-distributed-gateway/loki/api/v1/push \u6ce8\u610f\u6211\u4eec\u9700\u8981\u5c06 Promtail \u4e2d\u914d\u7f6e\u7684 Loki \u5730\u5740\u4e3a http://loki-loki-distributed-gateway/loki/api/v1/push \uff0c\u8fd9\u6837\u5c31\u662f Promtail \u5c06\u65e5\u5fd7\u6570\u636e\u9996\u5148\u53d1\u9001\u5230 gateway \u4e0a\u9762\u53bb\uff0c\u7136\u540e gateway \u6839\u636e\u6211\u4eec\u7684 Endpoints \u53bb\u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5 Promtail\uff1a $ helm upgrade --install promtail -n logging -f ci/minio-values.yaml . Release \"promtail\" does not exist. Installing it now. NAME: promtail LAST DEPLOYED: Tue Jun 21 16:31:34 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Promtail Chart version: 5.1.0 Promtail version: 2.5.0 *********************************************************************** Verify the application is working by running these commands: * kubectl --namespace logging port-forward daemonset/promtail 3101 * curl http://127.0.0.1:3101/metrics \u6b63\u5e38\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a promtail\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/name=promtail NAME READY STATUS RESTARTS AGE promtail-gbjzs 1/1 Running 0 38s promtail-gjn5p 1/1 Running 0 38s promtail-z6vhd 1/1 Running 0 38s \u6b63\u5e38 promtail \u5c31\u5df2\u7ecf\u5728\u5f00\u59cb\u91c7\u96c6\u6240\u5728\u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\u4e86\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u6570\u636e Push \u7ed9 gateway\uff0cgateway \u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b gateway \u7684\u65e5\u5fd7\uff1a $ kubectl logs -f loki-loki-distributed-gateway-6f4cfd898c-hpszv -n logging 10.244.2.26 - - [21/Jun/2022:08:41:24 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.2.1 - - [21/Jun/2022:08:41:24 +0000] 200 \"GET / HTTP/1.1\" 2 \"-\" \"kube-probe/1.22\" \"-\" 10.244.2.26 - - [21/Jun/2022:08:41:25 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.1.28 - - [21/Jun/2022:08:41:26 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" ...... \u53ef\u4ee5\u770b\u5230 gateway \u73b0\u5728\u5728\u4e00\u76f4\u63a5\u63a5\u6536\u7740 /loki/api/v1/push \u7684\u8bf7\u6c42\uff0c\u4e5f\u5c31\u662f promtail \u53d1\u9001\u8fc7\u6765\u7684\uff0c\u6b63\u5e38\u6765\u8bf4\u73b0\u5728\u65e5\u5fd7\u6570\u636e\u5df2\u7ecf\u5206\u53d1\u7ed9 write \u8282\u70b9\u4e86\uff0cwrite \u8282\u70b9\u5c06\u6570\u636e\u5b58\u50a8\u5728\u4e86 minio \u4e2d\uff0c\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b minio \u4e2d\u5df2\u7ecf\u6709\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u524d\u9762\u5b89\u88c5\u7684\u65f6\u5019\u4e3a minio \u670d\u52a1\u6307\u5b9a\u4e86\u4e00\u4e2a 32000 \u7684 NodePort \u7aef\u53e3\uff1a \u5230\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u6570\u636e\u5df2\u7ecf\u53ef\u4ee5\u6b63\u5e38\u5199\u5165\u4e86\u3002 \u5b89\u88c5 Grafana \u00b6 \u4e0b\u9762\u6211\u4eec\u6765\u9a8c\u8bc1\u4e0b\u8bfb\u53d6\u8def\u5f84\uff0c\u5b89\u88c5 Grafana \u5bf9\u63a5 Loki\uff1a $ helm pull grafana/grafana --untar $ cd grafana \u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 values \u914d\u7f6e\u6587\u4ef6\uff1a # ci/minio-values.yaml service: type: NodePort nodePort: 32001 rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path accessModes: - ReadWriteOnce size: 1Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 Grafana\uff1a $ helm upgrade --install grafana -n logging -f ci/minio-values.yaml . Release \"grafana\" does not exist. Installing it now. NAME: grafana LAST DEPLOYED: Tue Jun 21 16:47:54 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 NOTES: 1. Get your 'admin' user password by running: kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo 2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster: grafana.logging.svc.cluster.local Get the Grafana URL to visit by running these commands in the same shell: export NODE_PORT=$(kubectl get --namespace logging -o jsonpath=\"{.spec.ports[0].nodePort}\" services grafana) export NODE_IP=$(kubectl get nodes --namespace logging -o jsonpath=\"{.items[0].status.addresses[0].address}\") echo http://$NODE_IP:$NODE_PORT 3. Login with the password from step 1 and the username: admin \u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u63d0\u793a\u4e2d\u7684\u547d\u4ee4\u83b7\u53d6\u767b\u5f55\u5bc6\u7801\uff1a $ kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo \u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u5bc6\u7801\u548c admin \u7528\u6237\u540d\u767b\u5f55 Grafana\uff1a \u767b\u5f55\u540e\u8fdb\u5165 Grafana \u6dfb\u52a0\u4e00\u4e2a\u6570\u636e\u6e90\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u8981\u586b\u5199 gateway \u7684\u5730\u5740 http://loki-loki-distributed-gateway \uff1a \u4fdd\u5b58\u6570\u636e\u6e90\u540e\uff0c\u53ef\u4ee5\u8fdb\u5165 Explore \u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u5b9e\u65f6\u67e5\u770b gateway \u8fd9\u4e2a\u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u5982\u679c\u4f60\u80fd\u770b\u5230\u6700\u65b0\u7684\u65e5\u5fd7\u6570\u636e\u90a3\u8bf4\u660e\u6211\u4eec\u90e8\u7f72\u6210\u529f\u4e86\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki\uff0c\u8fd9\u79cd\u6a21\u5f0f\u7075\u6d3b\u6027\u975e\u5e38\u9ad8\uff0c\u53ef\u4ee5\u6839\u636e\u9700\u8981\u5bf9\u4e0d\u540c\u7684\u7ec4\u4ef6\u505a\u6269\u7f29\u5bb9\uff0c\u4f46\u662f\u8fd0\u7ef4\u6210\u672c\u4e5f\u4f1a\u589e\u52a0\u5f88\u591a\u3002 \u7f13\u5b58 \u00b6 \u4e0a\u9762\u867d\u7136\u6211\u4eec\u5b8c\u6210\u4e86 Loki \u7684\u5fae\u670d\u52a1\u6a21\u5f0f\u90e8\u7f72\uff0c\u5f53\u5728\u6d77\u91cf\u65e5\u5fd7\u6570\u636e\u7684\u60c5\u51b5\u4e0b\u6211\u4eec\u53ef\u80fd\u9700\u8981\u542f\u7528\u7f13\u5b58\u6765\u63d0\u5347\u67e5\u8be2\u6027\u80fd\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684 grafana/loki-distributed \u8fd9\u4e2a Chart \u5305\u53ef\u4ee5\u4e3a Loki \u4f7f\u7528\u7684\u5404\u79cd\u7f13\u5b58\u914d\u7f6e Memcached \u5b9e\u4f8b\uff0c\u6240\u6709\u7f13\u5b58\u7684\u914d\u7f6e\u90fd\u76f8\u540c\uff0c\u4f46\u662f\u76ee\u524d\u8be5\u5305\u4e2d\u7684 Memcached \u7f13\u5b58\u65b9\u5f0f\u8fd8\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u4ee5 redis \u4e3a\u4f8b\u6765\u914d\u7f6e\u7f13\u5b58\u3002 \u9996\u5148\u5f53\u7136\u9700\u8981\u4e00\u4e2a\u53ef\u7528\u7684 redis \u670d\u52a1\uff0c\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u8d44\u6e90\u6e05\u5355\u90e8\u7f72 redis \u5e94\u7528\u3002 # loki-redis.yaml apiVersion: apps/v1 kind: Deployment metadata: name: redis namespace: logging spec: selector: matchLabels: app: redis template: metadata: labels: app: redis spec: containers: - name: redis image: redis:4 resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 6379 - name: redis-exporter # \u5b83\u53ea\u4f1a\u63d0\u4f9b\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u4e3b\u5e94\u7528\u7684metrics image: oliver006/redis_exporter:latest resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 9121 --- kind: Service apiVersion: v1 metadata: name: redis namespace: logging labels: app: redis spec: selector: app: redis ports: - name: redis port: 6379 targetPort: 6379 - name: prom port: 9121 targetPort: 9121 --- apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: redis namespace: logging spec: endpoints: - port: prom selector: matchLabels: app: redis \u90e8\u7f72\u5b8c\u6210\u540e\u63a5\u4e0b\u6765\u6211\u4eec\u4e3a Loki \u96c6\u7fa4\u6dfb\u52a0 redis \u7f13\u5b58\uff0c\u5b9a\u5236\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # cache-values.yaml loki: config: | auth_enabled: false server: http_listen_port: 3100 distributor: ring: kvstore: store: memberlist memberlist: join_members: - {{ include \"loki.fullname\" . }}-memberlist ingester: lifecycler: ring: kvstore: store: memberlist replication_factor: 1 chunk_idle_period: 30m chunk_block_size: 262144 chunk_retain_period: 1m max_transfer_retries: 0 wal: dir: /var/loki/wal limits_config: enforce_metric_name: false reject_old_samples: true reject_old_samples_max_age: 168h ingestion_burst_size_mb: 20 ingestion_rate_mb: 10 split_queries_by_interval: 24h schema_config: configs: - from: 2020-09-07 store: boltdb-shipper object_store: filesystem schema: v11 index: prefix: loki_index_ period: 24h storage_config: aws: access_key_id: myaccessKey bucketnames: loki-data endpoint: minio.logging.svc.cluster.local:9000 insecure: true s3forcepathstyle: true secret_access_key: mysecretKey boltdb_shipper: shared_store: filesystem active_index_directory: /var/loki/index cache_location: /var/loki/cache cache_ttl: 168h filesystem: directory: /var/loki/chunks index_queries_cache_config: redis: endpoint: redis:6379 expiration: 1h chunk_store_config: max_look_back_period: 0 chunk_cache_config: redis: endpoint: redis:6379 expiration: 1h write_dedupe_cache_config: redis: endpoint: redis:6379 expiration: 1h query_range: cache_results: true results_cache: cache: redis: endpoint: redis:6379 expiration: 1h frontend_worker: frontend_address: {{ include \"loki.queryFrontendFullname\" . }}:9095 frontend: log_queries_longer_than: 5s compress_responses: true ruler: storage: type: local local: directory: /etc/loki/rules ring: kvstore: store: memberlist rule_path: /tmp/loki/scratch alertmanager_url: http://alertmanager-main.monitoring.svc.cluster.local:9093 # alertmanager\u7684\u5730\u5740 external_url: http://192.168.0.106\uff1a31918 distributor: replicas: 2 ingester: # WAL\uff08replay\uff09 replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path querier: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path queryFrontend: replicas: 2 gateway: # nginx\u5bb9\u5668 -> \u8def\u7531\u65e5\u5fd7\u5199/\u8bfb\u7684\u8bf7\u6c42 nginxConfig: httpSnippet: |- client_max_body_size 100M; serverSnippet: |- client_max_body_size 100M; ruler: enabled: true kind: Deployment replicas: 1 persistence: enabled: true size: 1Gi storageClass: local-path # -- Directories containing rules files directories: tenant_no: rules1.txt: | groups: - name: nginx-rate rules: - alert: LokiNginxRate expr: sum(rate({app=\"nginx\"} |= \"error\" [1m])) by (job) / sum(rate({app=\"nginx\"}[1m])) by (job) > 0.01 for: 1m labels: severity: critical annotations: summary: loki nginx rate description: high request latency \u4e0a\u9762\u7684 values \u4e2d\u6211\u4eec\u4e3a Loki \u6dfb\u52a0\u4e86\u4e00\u4e9b\u7f13\u5b58\u914d\u7f6e\uff0c\u6838\u5fc3\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a ...... query_range: results_cache: cache: redis: endpoint: redis:6379 expiration: 1h cache_results: true storage_config: index_queries_cache_config: redis: endpoint: redis:6379 expiration: 1h chunk_store_config: chunk_cache_config: redis: endpoint: redis:6379 expiration: 1h write_dedupe_cache_config: redis: endpoint: redis:6379 expiration: 1h ...... \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u91cd\u65b0\u8986\u76d6 Loki \u5373\u53ef\uff1a $ helm upgrade --install loki -n logging -f ci/cache-values.yaml . \u5b89\u88c5\u5b8c\u6210\u540e\u603b\u4f53\u7684 Pod \u5982\u4e0b\u6240\u793a\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE grafana-55d8779dc6-mm5f2 1/1 Running 0 70m loki-loki-distributed-distributor-77f8f99dbb-7snns 1/1 Running 0 38m loki-loki-distributed-distributor-77f8f99dbb-rsn7l 1/1 Running 0 38m loki-loki-distributed-gateway-6f4cfd898c-p9xxf 1/1 Running 2 (4h9m ago) 3d1h loki-loki-distributed-ingester-0 1/1 Running 0 37m loki-loki-distributed-ingester-1 1/1 Running 0 38m loki-loki-distributed-querier-0 1/1 Running 0 38m loki-loki-distributed-querier-1 1/1 Running 0 38m loki-loki-distributed-query-frontend-78c4ccc99b-4t85w 1/1 Running 0 38m loki-loki-distributed-query-frontend-78c4ccc99b-cgh8d 1/1 Running 0 38m loki-loki-distributed-ruler-5654f8cf59-pjb8p 1/1 Running 0 38m minio-548656f786-mjd4c 1/1 Running 3 (4h10m ago) 6d22h promtail-ddz27 1/1 Running 1 (4h10m ago) 3d1h promtail-lzr6v 1/1 Running 1 (4h10m ago) 3d1h promtail-nldqx 1/1 Running 2 (4h4m ago) 3d1h redis-7fb8ff6779-m26m6 2/2 Running 0 30m \u6b63\u5e38\u73b0\u5728 Redis \u670d\u52a1\u5c31\u5df2\u7ecf\u518d\u4f7f\u7528\u4e86\uff0c\u4e0b\u56fe\u5c55\u793a\u4e86 redis \u7684\u8fd0\u884c\u72b6\u6001\uff0c\u53ef\u4ee5\u770b\u51fa\u538b\u529b\u4e5f\u5e76\u4e0d\u5927\u3002","title":"kubernetes \u65e5\u5fd7\u5fae\u670d\u52a1\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#_1","text":"","title":"\u5fae\u670d\u52a1\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#_2","text":"\u524d\u9762\u6211\u4eec\u63d0\u5230\u4e86 Loki \u90e8\u7f72\u7684\u5355\u4f53\u6a21\u5f0f\u548c\u8bfb\u5199\u5206\u79bb\u4e24\u79cd\u6a21\u5f0f\uff0c\u5f53\u4f60\u7684\u6bcf\u5929\u65e5\u5fd7\u89c4\u6a21\u8d85\u8fc7\u4e86 TB \u7684\u91cf\u7ea7\uff0c\u90a3\u4e48\u53ef\u80fd\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230\u5fae\u670d\u52a1\u6a21\u5f0f\u6765\u90e8\u7f72 Loki \u4e86\u3002 \u5fae\u670d\u52a1\u90e8\u7f72\u6a21\u5f0f\u5c06 Loki \u7684\u7ec4\u4ef6\u5b9e\u4f8b\u5316\u4e3a\u4e0d\u540c\u7684\u8fdb\u7a0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u88ab\u8c03\u7528\u5e76\u6307\u5b9a\u5176\u76ee\u6807\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u7528\u4e8e\u5185\u90e8\u8bf7\u6c42\u7684 gRPC \u670d\u52a1\u5668\u548c\u4e00\u4e2a\u7528\u4e8e\u5916\u90e8 API \u8bf7\u6c42\u7684 HTTP \u670d\u52a1\u3002 ingester distributor query-frontend query-scheduler querier index-gateway ruler compactor \u5c06\u7ec4\u4ef6\u4f5c\u4e3a\u5355\u72ec\u7684\u5fae\u670d\u52a1\u8fd0\u884c\u5141\u8bb8\u901a\u8fc7\u589e\u52a0\u5fae\u670d\u52a1\u7684\u6570\u91cf\u6765\u8fdb\u884c\u6269\u5c55\uff0c\u5b9a\u5236\u7684\u96c6\u7fa4\u5bf9\u5404\u4e2a\u7ec4\u4ef6\u5177\u6709\u66f4\u597d\u7684\u53ef\u89c2\u5bdf\u6027\u3002\u5fae\u670d\u52a1\u6a21\u5f0f\u90e8\u7f72\u662f\u6700\u9ad8\u6548\u7684 Loki \u5b89\u88c5\uff0c\u4f46\u662f\uff0c\u5b83\u4eec\u7684\u8bbe\u7f6e\u548c\u7ef4\u62a4\u4e5f\u662f\u6700\u590d\u6742\u7684\u3002 \u5bf9\u4e8e\u8d85\u5927\u7684 Loki \u96c6\u7fa4\u6216\u9700\u8981\u5bf9\u6269\u5c55\u548c\u96c6\u7fa4\u64cd\u4f5c\u8fdb\u884c\u66f4\u591a\u63a7\u5236\u7684\u96c6\u7fa4\uff0c\u5efa\u8bae\u4f7f\u7528\u5fae\u670d\u52a1\u6a21\u5f0f\u3002 \u5fae\u670d\u52a1\u6a21\u5f0f\u6700\u9002\u5408\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\uff0c\u63d0\u4f9b\u4e86 Jsonnet \u548c Helm Chart \u4e24\u79cd\u5b89\u88c5\u65b9\u5f0f\u3002","title":"\u5fae\u670d\u52a1\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#_3","text":"\u540c\u6837\u8fd9\u91cc\u6211\u4eec\u8fd8\u662f\u4f7f\u7528 Helm Chart \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki\uff0c\u5728\u5b89\u88c5\u4e4b\u524d\u8bb0\u5f97\u5c06\u524d\u9762\u7ae0\u8282\u5b89\u88c5\u7684 Loki \u76f8\u5173\u670d\u52a1\u5220\u9664\u3002 \u9996\u5148\u83b7\u53d6\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Chart \u5305\uff1a $ helm repo add grafana https://grafana.github.io/helm-charts $ helm pull grafana/loki-distributed --untar --version 0.48.4 $ cd loki-simple-scalable \u8be5 Chart \u5305\u652f\u6301\u4e0b\u8868\u4e2d\u663e\u793a\u7684\u7ec4\u4ef6\uff0cIngester\u3001distributor\u3001querier \u548c query-frontend \u7ec4\u4ef6\u662f\u59cb\u7ec8\u5b89\u88c5\u7684\uff0c\u5176\u4ed6\u7ec4\u4ef6\u662f\u53ef\u9009\u7684\u3002 \u7ec4\u4ef6 \u53ef\u9009 \u9ed8\u8ba4\u5f00\u542f\uff1f gateway \u2705 \u2705 ingester \u274e n/a distributor \u274e n/a querier \u274e n/a query-frontend \u274e n/a table-manager \u2705 \u274e compactor \u2705 \u274e ruler \u2705 \u274e index-gateway \u2705 \u274e memcached-chunks \u2705 \u274e memcached-frontend \u2705 \u274e memcached-index-queries \u2705 \u274e memcached-index-writes \u2705 \u274e \u8be5 Chart \u5305\u5728\u5fae\u670d\u52a1\u6a21\u5f0f\u4e0b\u914d\u7f6e Loki\uff0c\u5df2\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u4e0e boltdb-shipper \u548c memberlist \u4e00\u8d77\u4f7f\u7528\uff0c\u800c\u5176\u4ed6\u5b58\u50a8\u548c\u53d1\u73b0\u9009\u9879\u4e5f\u53ef\u4ee5\u4f7f\u7528\uff0c\u4f46\u662f\uff0c\u8be5\u56fe\u8868\u4e0d\u652f\u6301\u8bbe\u7f6e Consul \u6216 Etcd \u4ee5\u8fdb\u884c\u53d1\u73b0\uff0c\u5b83\u4eec\u9700\u8981\u8fdb\u884c\u5355\u72ec\u914d\u7f6e\uff0c\u76f8\u53cd\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0d\u9700\u8981\u5355\u72ec\u7684\u952e/\u503c\u5b58\u50a8\u7684 memberlist \u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8be5 Chart \u5305\u4f1a\u4e3a\u6210\u5458\u5217\u8868\u521b\u5efa\u4e86\u4e00\u4e2a Headless Service\uff0cingester\u3001distributor\u3001querier \u548c ruler \u662f\u5176\u4e2d\u7684\u4e00\u90e8\u5206\u3002","title":"\u5b89\u88c5"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#minio","text":"\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 memberlist\u3001boltdb-shipper \u548c minio \u6765\u4f5c\u5b58\u50a8\uff0c\u7531\u4e8e\u8fd9\u4e2a Chart \u5305\u6ca1\u6709\u5305\u542b minio\uff0c\u6240\u4ee5\u9700\u8981\u6211\u4eec\u5148\u5355\u72ec\u5b89\u88c5 minio\uff1a $ helm repo add minio https://helm.min.io/ $ helm pull minio/minio --untar --version 8.0.10 $ cd minio \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/loki-values.yaml accessKey: \"myaccessKey\" secretKey: \"mysecretKey\" persistence: enabled: true storageClass: \"local-path\" accessMode: ReadWriteOnce size: 5Gi service: type: NodePort port: 9000 nodePort: 32000 resources: requests: memory: 1Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u914d\u7f6e\u7684 values \u6587\u4ef6\u5b89\u88c5 minio\uff1a $ helm upgrade --install minio -n logging -f ci/loki-values.yaml . Release \"minio\" does not exist. Installing it now. NAME: minio LAST DEPLOYED: Sun Jun 19 16:56:28 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: Minio can be accessed via port 9000 on the following DNS name from within your cluster: minio.logging.svc.cluster.local To access Minio from localhost, run the below commands: 1. export POD_NAME=$(kubectl get pods --namespace logging -l \"release=minio\" -o jsonpath=\"{.items[0].metadata.name}\") 2. kubectl port-forward $POD_NAME 9000 --namespace logging Read more about port forwarding here: http://kubernetes.io/docs/user-guide/kubectl/kubectl_port-forward/ You can now access Minio server on http://localhost:9000. Follow the below steps to connect to Minio server with mc client: 1. Download the Minio mc client - https://docs.minio.io/docs/minio-client-quickstart-guide 2. Get the ACCESS_KEY=$(kubectl get secret minio -o jsonpath=\"{.data.accesskey}\" | base64 --decode) and the SECRET_KEY=$(kubectl get secret minio -o jsonpath=\"{.data.secretkey}\" | base64 --decode) 3. mc alias set minio-local http://localhost:9000 \"$ACCESS_KEY\" \"$SECRET_KEY\" --api s3v4 4. mc ls minio-local Alternately, you can use your browser or the Minio SDK to access the server - https://docs.minio.io/categories/17 \u5b89\u88c5\u5b8c\u6210\u540e\u67e5\u770b\u5bf9\u5e94\u7684 Pod \u72b6\u6001\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE minio-548656f786-gctk9 1/1 Running 0 2m45s $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE minio NodePort 10.111.58.196 <none> 9000:32000/TCP 3h16m \u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u7684 32000 \u7aef\u53e3\u6765\u8bbf\u95ee minio\uff1a \u7136\u540e\u8bb0\u5f97\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a loki-data \u7684 bucket\u3002","title":"\u5b89\u88c5 minio"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#loki","text":"\u73b0\u5728\u5c06\u6211\u4eec\u7684\u5bf9\u8c61\u5b58\u50a8\u51c6\u5907\u597d\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u5b89\u88c5\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/minio-values.yaml loki: structuredConfig: ingester: max_transfer_retries: 0 chunk_idle_period: 1h chunk_target_size: 1536000 max_chunk_age: 1h storage_config: aws: endpoint: minio.logging.svc.cluster.local:9000 insecure: true bucketnames: loki-data access_key_id: myaccessKey secret_access_key: mysecretKey s3forcepathstyle: true boltdb_shipper: shared_store: s3 schema_config: configs: - from: 2022-06-21 store: boltdb-shipper object_store: s3 schema: v12 index: prefix: loki_index_ period: 24h distributor: replicas: 2 ingester: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path querier: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path queryFrontend: replicas: 2 gateway: nginxConfig: httpSnippet: |- client_max_body_size 100M; serverSnippet: |- client_max_body_size 100M; \u4e0a\u8ff0\u914d\u7f6e\u4f1a\u9009\u62e9\u6027\u5730\u8986\u76d6 loki.config \u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u9ed8\u8ba4\u503c\uff0c\u4f7f\u7528 loki.structuredConfig \u53ef\u4ee5\u5728\u5916\u90e8\u8bbe\u7f6e\u5927\u591a\u6570\u914d\u7f6e\u53c2\u6570\u3002 loki.config \u3001 loki.schemaConfig \u548c loki.storageConfig \u4e5f\u53ef\u4ee5\u4e0e loki.structuredConfig \u7ed3\u5408\u4f7f\u7528\u3002 loki.structuredConfig \u4e2d\u7684\u503c\u4f18\u5148\u7ea7\u66f4\u9ad8\u3002 \u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 loki.structuredConfig.storage_config.aws \u6307\u5b9a\u4e86\u7528\u4e8e\u4fdd\u5b58\u6570\u636e\u7684 minio \u914d\u7f6e\uff0c\u4e3a\u4e86\u9ad8\u53ef\u7528\uff0c\u6838\u5fc3\u7684\u51e0\u4e2a\u7ec4\u4ef6\u6211\u4eec\u914d\u7f6e\u4e86 2 \u4e2a\u526f\u672c\uff0c ingester \u548c querier \u914d\u7f6e\u4e86\u6301\u4e45\u5316\u5b58\u50a8\u3002 \u73b0\u5728\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff1a $ helm upgrade --install loki -n logging -f ci/minio-values.yaml . Release \"loki\" does not exist. Installing it now. NAME: loki LAST DEPLOYED: Tue Jun 21 16:20:10 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Loki Chart version: 0.48.4 Loki version: 2.5.0 *********************************************************************** Installed components: * gateway * ingester * distributor * querier * query-frontend \u4e0a\u9762\u4f1a\u5206\u522b\u5b89\u88c5\u51e0\u4e2a\u7ec4\u4ef6\uff1agateway\u3001ingester\u3001distributor\u3001querier\u3001query-frontend\uff0c\u5bf9\u5e94\u7684 Pod \u72b6\u6001\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE loki-loki-distributed-distributor-5dfdd5bd78-nxdq8 1/1 Running 0 2m40s loki-loki-distributed-distributor-5dfdd5bd78-rh4gz 1/1 Running 0 116s loki-loki-distributed-gateway-6f4cfd898c-hpszv 1/1 Running 0 21m loki-loki-distributed-ingester-0 1/1 Running 0 96s loki-loki-distributed-ingester-1 1/1 Running 0 2m38s loki-loki-distributed-querier-0 1/1 Running 0 2m2s loki-loki-distributed-querier-1 1/1 Running 0 2m33s loki-loki-distributed-query-frontend-6d9845cb5b-p4vns 1/1 Running 0 4s loki-loki-distributed-query-frontend-6d9845cb5b-sq5hr 1/1 Running 0 2m40s minio-548656f786-gctk9 1/1 Running 1 (123m ago) 47h $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE loki-loki-distributed-distributor ClusterIP 10.102.156.127 <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-gateway ClusterIP 10.111.73.138 <none> 80/TCP 22m loki-loki-distributed-ingester ClusterIP 10.98.238.236 <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-ingester-headless ClusterIP None <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-memberlist ClusterIP None <none> 7946/TCP 22m loki-loki-distributed-querier ClusterIP 10.101.117.137 <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-querier-headless ClusterIP None <none> 3100/TCP,9095/TCP 22m loki-loki-distributed-query-frontend ClusterIP None <none> 3100/TCP,9095/TCP,9096/TCP 22m minio NodePort 10.111.58.196 <none> 9000:32000/TCP 47h Loki \u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get cm -n logging loki-loki-distributed -o yaml apiVersion: v1 data: config.yaml: | auth_enabled: false chunk_store_config: max_look_back_period: 0s compactor: shared_store: filesystem distributor: ring: kvstore: store: memberlist frontend: compress_responses: true log_queries_longer_than: 5s tail_proxy_url: http://loki-loki-distributed-querier:3100 frontend_worker: frontend_address: loki-loki-distributed-query-frontend:9095 ingester: chunk_block_size: 262144 chunk_encoding: snappy chunk_idle_period: 1h chunk_retain_period: 1m chunk_target_size: 1536000 lifecycler: ring: kvstore: store: memberlist replication_factor: 1 max_chunk_age: 1h max_transfer_retries: 0 wal: dir: /var/loki/wal limits_config: enforce_metric_name: false max_cache_freshness_per_query: 10m reject_old_samples: true reject_old_samples_max_age: 168h split_queries_by_interval: 15m memberlist: join_members: - loki-loki-distributed-memberlist query_range: align_queries_with_step: true cache_results: true max_retries: 5 results_cache: cache: enable_fifocache: true fifocache: max_size_items: 1024 validity: 24h ruler: alertmanager_url: https://alertmanager.xx external_url: https://alertmanager.xx ring: kvstore: store: memberlist rule_path: /tmp/loki/scratch storage: local: directory: /etc/loki/rules type: local schema_config: configs: - from: \"2022-06-21\" index: period: 24h prefix: loki_index_ object_store: s3 schema: v12 store: boltdb-shipper server: http_listen_port: 3100 storage_config: aws: access_key_id: myaccessKey bucketnames: loki-data endpoint: minio.logging.svc.cluster.local:9000 insecure: true s3forcepathstyle: true secret_access_key: mysecretKey boltdb_shipper: active_index_directory: /var/loki/index cache_location: /var/loki/cache cache_ttl: 168h shared_store: s3 filesystem: directory: /var/loki/chunks table_manager: retention_deletes_enabled: false retention_period: 0s kind: ConfigMap # ...... \u540c\u6837\u5176\u4e2d\u6709\u4e00\u4e2a gateway \u7ec4\u4ef6\u4f1a\u6765\u5e2e\u52a9\u6211\u4eec\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u6b63\u786e\u7684\u7ec4\u4ef6\u4e2d\u53bb\uff0c\u8be5\u7ec4\u4ef6\u540c\u6837\u5c31\u662f\u4e00\u4e2a nginx \u670d\u52a1\uff0c\u5bf9\u5e94\u7684\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a $ kubectl -n logging exec -it loki-loki-distributed-gateway-6f4cfd898c-hpszv -- cat /etc/nginx/nginx.conf worker_processes 5; ## Default: 1 error_log /dev/stderr; pid /tmp/nginx.pid; worker_rlimit_nofile 8192; events { worker_connections 4096; ## Default: 1024 } http { client_body_temp_path /tmp/client_temp; proxy_temp_path /tmp/proxy_temp_path; fastcgi_temp_path /tmp/fastcgi_temp; uwsgi_temp_path /tmp/uwsgi_temp; scgi_temp_path /tmp/scgi_temp; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] $status ' '\"$request\" $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /dev/stderr main; sendfile on; tcp_nopush on; resolver kube-dns.kube-system.svc.cluster.local; client_max_body_size 100M; server { listen 8080; location = / { return 200 'OK'; auth_basic off; } location = /api/prom/push { proxy_pass http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100$request_uri; } location = /api/prom/tail { proxy_pass http://loki-loki-distributed-querier.logging.svc.cluster.local:3100$request_uri; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } # Ruler location ~ /prometheus/api/v1/alerts.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /prometheus/api/v1/rules.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /api/prom/rules.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /api/prom/alerts.* { proxy_pass http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100$request_uri; } location ~ /api/prom/.* { proxy_pass http://loki-loki-distributed-query-frontend.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/push { proxy_pass http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/tail { proxy_pass http://loki-loki-distributed-querier.logging.svc.cluster.local:3100$request_uri; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } location ~ /loki/api/.* { proxy_pass http://loki-loki-distributed-query-frontend.logging.svc.cluster.local:3100$request_uri; } client_max_body_size 100M; } } \u4ece\u4e0a\u9762\u914d\u7f6e\u53ef\u4ee5\u770b\u51fa\u5bf9\u5e94\u7684 Push \u7aef\u70b9 /api/prom/push \u4e0e /loki/api/v1/push \u4f1a\u8f6c\u53d1\u7ed9 http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100$request_uri; \uff0c\u4e5f\u5c31\u662f\u5bf9\u5e94\u7684 distributor \u670d\u52a1\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/component=distributor,app.kubernetes.io/instance=loki,app.kubernetes.io/name=loki-distributed NAME READY STATUS RESTARTS AGE loki-loki-distributed-distributor-5dfdd5bd78-nxdq8 1/1 Running 0 8m20s loki-loki-distributed-distributor-5dfdd5bd78-rh4gz 1/1 Running 0 7m36s \u6240\u4ee5\u5982\u679c\u6211\u4eec\u8981\u5199\u5165\u65e5\u5fd7\u6570\u636e\uff0c\u81ea\u7136\u73b0\u5728\u662f\u5199\u5165\u5230 gateway \u7684 Push \u7aef\u70b9\u4e0a\u53bb\u3002\u4e3a\u4e86\u9a8c\u8bc1\u5e94\u7528\u662f\u5426\u6b63\u5e38\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5b89\u88c5 Promtail \u548c Grafana \u6765\u8fdb\u884c\u6570\u636e\u7684\u8bfb\u5199\u3002","title":"\u5b89\u88c5 Loki"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#promtail","text":"\u83b7\u53d6 promtail \u7684 Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull grafana/promtail --untar $ cd promtail \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/minio-values.yaml rbac: pspEnabled: false config: clients: - url: http://loki-loki-distributed-gateway/loki/api/v1/push \u6ce8\u610f\u6211\u4eec\u9700\u8981\u5c06 Promtail \u4e2d\u914d\u7f6e\u7684 Loki \u5730\u5740\u4e3a http://loki-loki-distributed-gateway/loki/api/v1/push \uff0c\u8fd9\u6837\u5c31\u662f Promtail \u5c06\u65e5\u5fd7\u6570\u636e\u9996\u5148\u53d1\u9001\u5230 gateway \u4e0a\u9762\u53bb\uff0c\u7136\u540e gateway \u6839\u636e\u6211\u4eec\u7684 Endpoints \u53bb\u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5 Promtail\uff1a $ helm upgrade --install promtail -n logging -f ci/minio-values.yaml . Release \"promtail\" does not exist. Installing it now. NAME: promtail LAST DEPLOYED: Tue Jun 21 16:31:34 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Promtail Chart version: 5.1.0 Promtail version: 2.5.0 *********************************************************************** Verify the application is working by running these commands: * kubectl --namespace logging port-forward daemonset/promtail 3101 * curl http://127.0.0.1:3101/metrics \u6b63\u5e38\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a promtail\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/name=promtail NAME READY STATUS RESTARTS AGE promtail-gbjzs 1/1 Running 0 38s promtail-gjn5p 1/1 Running 0 38s promtail-z6vhd 1/1 Running 0 38s \u6b63\u5e38 promtail \u5c31\u5df2\u7ecf\u5728\u5f00\u59cb\u91c7\u96c6\u6240\u5728\u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\u4e86\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u6570\u636e Push \u7ed9 gateway\uff0cgateway \u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b gateway \u7684\u65e5\u5fd7\uff1a $ kubectl logs -f loki-loki-distributed-gateway-6f4cfd898c-hpszv -n logging 10.244.2.26 - - [21/Jun/2022:08:41:24 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.2.1 - - [21/Jun/2022:08:41:24 +0000] 200 \"GET / HTTP/1.1\" 2 \"-\" \"kube-probe/1.22\" \"-\" 10.244.2.26 - - [21/Jun/2022:08:41:25 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.1.28 - - [21/Jun/2022:08:41:26 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" ...... \u53ef\u4ee5\u770b\u5230 gateway \u73b0\u5728\u5728\u4e00\u76f4\u63a5\u63a5\u6536\u7740 /loki/api/v1/push \u7684\u8bf7\u6c42\uff0c\u4e5f\u5c31\u662f promtail \u53d1\u9001\u8fc7\u6765\u7684\uff0c\u6b63\u5e38\u6765\u8bf4\u73b0\u5728\u65e5\u5fd7\u6570\u636e\u5df2\u7ecf\u5206\u53d1\u7ed9 write \u8282\u70b9\u4e86\uff0cwrite \u8282\u70b9\u5c06\u6570\u636e\u5b58\u50a8\u5728\u4e86 minio \u4e2d\uff0c\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b minio \u4e2d\u5df2\u7ecf\u6709\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u524d\u9762\u5b89\u88c5\u7684\u65f6\u5019\u4e3a minio \u670d\u52a1\u6307\u5b9a\u4e86\u4e00\u4e2a 32000 \u7684 NodePort \u7aef\u53e3\uff1a \u5230\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u6570\u636e\u5df2\u7ecf\u53ef\u4ee5\u6b63\u5e38\u5199\u5165\u4e86\u3002","title":"\u5b89\u88c5 Promtail"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#grafana","text":"\u4e0b\u9762\u6211\u4eec\u6765\u9a8c\u8bc1\u4e0b\u8bfb\u53d6\u8def\u5f84\uff0c\u5b89\u88c5 Grafana \u5bf9\u63a5 Loki\uff1a $ helm pull grafana/grafana --untar $ cd grafana \u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 values \u914d\u7f6e\u6587\u4ef6\uff1a # ci/minio-values.yaml service: type: NodePort nodePort: 32001 rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path accessModes: - ReadWriteOnce size: 1Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 Grafana\uff1a $ helm upgrade --install grafana -n logging -f ci/minio-values.yaml . Release \"grafana\" does not exist. Installing it now. NAME: grafana LAST DEPLOYED: Tue Jun 21 16:47:54 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 NOTES: 1. Get your 'admin' user password by running: kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo 2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster: grafana.logging.svc.cluster.local Get the Grafana URL to visit by running these commands in the same shell: export NODE_PORT=$(kubectl get --namespace logging -o jsonpath=\"{.spec.ports[0].nodePort}\" services grafana) export NODE_IP=$(kubectl get nodes --namespace logging -o jsonpath=\"{.items[0].status.addresses[0].address}\") echo http://$NODE_IP:$NODE_PORT 3. Login with the password from step 1 and the username: admin \u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u63d0\u793a\u4e2d\u7684\u547d\u4ee4\u83b7\u53d6\u767b\u5f55\u5bc6\u7801\uff1a $ kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo \u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u5bc6\u7801\u548c admin \u7528\u6237\u540d\u767b\u5f55 Grafana\uff1a \u767b\u5f55\u540e\u8fdb\u5165 Grafana \u6dfb\u52a0\u4e00\u4e2a\u6570\u636e\u6e90\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u8981\u586b\u5199 gateway \u7684\u5730\u5740 http://loki-loki-distributed-gateway \uff1a \u4fdd\u5b58\u6570\u636e\u6e90\u540e\uff0c\u53ef\u4ee5\u8fdb\u5165 Explore \u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u5b9e\u65f6\u67e5\u770b gateway \u8fd9\u4e2a\u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u5982\u679c\u4f60\u80fd\u770b\u5230\u6700\u65b0\u7684\u65e5\u5fd7\u6570\u636e\u90a3\u8bf4\u660e\u6211\u4eec\u90e8\u7f72\u6210\u529f\u4e86\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki\uff0c\u8fd9\u79cd\u6a21\u5f0f\u7075\u6d3b\u6027\u975e\u5e38\u9ad8\uff0c\u53ef\u4ee5\u6839\u636e\u9700\u8981\u5bf9\u4e0d\u540c\u7684\u7ec4\u4ef6\u505a\u6269\u7f29\u5bb9\uff0c\u4f46\u662f\u8fd0\u7ef4\u6210\u672c\u4e5f\u4f1a\u589e\u52a0\u5f88\u591a\u3002","title":"\u5b89\u88c5 Grafana"},{"location":"3.k8s/7.logging/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F/#_4","text":"\u4e0a\u9762\u867d\u7136\u6211\u4eec\u5b8c\u6210\u4e86 Loki \u7684\u5fae\u670d\u52a1\u6a21\u5f0f\u90e8\u7f72\uff0c\u5f53\u5728\u6d77\u91cf\u65e5\u5fd7\u6570\u636e\u7684\u60c5\u51b5\u4e0b\u6211\u4eec\u53ef\u80fd\u9700\u8981\u542f\u7528\u7f13\u5b58\u6765\u63d0\u5347\u67e5\u8be2\u6027\u80fd\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684 grafana/loki-distributed \u8fd9\u4e2a Chart \u5305\u53ef\u4ee5\u4e3a Loki \u4f7f\u7528\u7684\u5404\u79cd\u7f13\u5b58\u914d\u7f6e Memcached \u5b9e\u4f8b\uff0c\u6240\u6709\u7f13\u5b58\u7684\u914d\u7f6e\u90fd\u76f8\u540c\uff0c\u4f46\u662f\u76ee\u524d\u8be5\u5305\u4e2d\u7684 Memcached \u7f13\u5b58\u65b9\u5f0f\u8fd8\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u4ee5 redis \u4e3a\u4f8b\u6765\u914d\u7f6e\u7f13\u5b58\u3002 \u9996\u5148\u5f53\u7136\u9700\u8981\u4e00\u4e2a\u53ef\u7528\u7684 redis \u670d\u52a1\uff0c\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u8d44\u6e90\u6e05\u5355\u90e8\u7f72 redis \u5e94\u7528\u3002 # loki-redis.yaml apiVersion: apps/v1 kind: Deployment metadata: name: redis namespace: logging spec: selector: matchLabels: app: redis template: metadata: labels: app: redis spec: containers: - name: redis image: redis:4 resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 6379 - name: redis-exporter # \u5b83\u53ea\u4f1a\u63d0\u4f9b\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u4e3b\u5e94\u7528\u7684metrics image: oliver006/redis_exporter:latest resources: requests: cpu: 100m memory: 100Mi ports: - containerPort: 9121 --- kind: Service apiVersion: v1 metadata: name: redis namespace: logging labels: app: redis spec: selector: app: redis ports: - name: redis port: 6379 targetPort: 6379 - name: prom port: 9121 targetPort: 9121 --- apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: redis namespace: logging spec: endpoints: - port: prom selector: matchLabels: app: redis \u90e8\u7f72\u5b8c\u6210\u540e\u63a5\u4e0b\u6765\u6211\u4eec\u4e3a Loki \u96c6\u7fa4\u6dfb\u52a0 redis \u7f13\u5b58\uff0c\u5b9a\u5236\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # cache-values.yaml loki: config: | auth_enabled: false server: http_listen_port: 3100 distributor: ring: kvstore: store: memberlist memberlist: join_members: - {{ include \"loki.fullname\" . }}-memberlist ingester: lifecycler: ring: kvstore: store: memberlist replication_factor: 1 chunk_idle_period: 30m chunk_block_size: 262144 chunk_retain_period: 1m max_transfer_retries: 0 wal: dir: /var/loki/wal limits_config: enforce_metric_name: false reject_old_samples: true reject_old_samples_max_age: 168h ingestion_burst_size_mb: 20 ingestion_rate_mb: 10 split_queries_by_interval: 24h schema_config: configs: - from: 2020-09-07 store: boltdb-shipper object_store: filesystem schema: v11 index: prefix: loki_index_ period: 24h storage_config: aws: access_key_id: myaccessKey bucketnames: loki-data endpoint: minio.logging.svc.cluster.local:9000 insecure: true s3forcepathstyle: true secret_access_key: mysecretKey boltdb_shipper: shared_store: filesystem active_index_directory: /var/loki/index cache_location: /var/loki/cache cache_ttl: 168h filesystem: directory: /var/loki/chunks index_queries_cache_config: redis: endpoint: redis:6379 expiration: 1h chunk_store_config: max_look_back_period: 0 chunk_cache_config: redis: endpoint: redis:6379 expiration: 1h write_dedupe_cache_config: redis: endpoint: redis:6379 expiration: 1h query_range: cache_results: true results_cache: cache: redis: endpoint: redis:6379 expiration: 1h frontend_worker: frontend_address: {{ include \"loki.queryFrontendFullname\" . }}:9095 frontend: log_queries_longer_than: 5s compress_responses: true ruler: storage: type: local local: directory: /etc/loki/rules ring: kvstore: store: memberlist rule_path: /tmp/loki/scratch alertmanager_url: http://alertmanager-main.monitoring.svc.cluster.local:9093 # alertmanager\u7684\u5730\u5740 external_url: http://192.168.0.106\uff1a31918 distributor: replicas: 2 ingester: # WAL\uff08replay\uff09 replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path querier: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path queryFrontend: replicas: 2 gateway: # nginx\u5bb9\u5668 -> \u8def\u7531\u65e5\u5fd7\u5199/\u8bfb\u7684\u8bf7\u6c42 nginxConfig: httpSnippet: |- client_max_body_size 100M; serverSnippet: |- client_max_body_size 100M; ruler: enabled: true kind: Deployment replicas: 1 persistence: enabled: true size: 1Gi storageClass: local-path # -- Directories containing rules files directories: tenant_no: rules1.txt: | groups: - name: nginx-rate rules: - alert: LokiNginxRate expr: sum(rate({app=\"nginx\"} |= \"error\" [1m])) by (job) / sum(rate({app=\"nginx\"}[1m])) by (job) > 0.01 for: 1m labels: severity: critical annotations: summary: loki nginx rate description: high request latency \u4e0a\u9762\u7684 values \u4e2d\u6211\u4eec\u4e3a Loki \u6dfb\u52a0\u4e86\u4e00\u4e9b\u7f13\u5b58\u914d\u7f6e\uff0c\u6838\u5fc3\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a ...... query_range: results_cache: cache: redis: endpoint: redis:6379 expiration: 1h cache_results: true storage_config: index_queries_cache_config: redis: endpoint: redis:6379 expiration: 1h chunk_store_config: chunk_cache_config: redis: endpoint: redis:6379 expiration: 1h write_dedupe_cache_config: redis: endpoint: redis:6379 expiration: 1h ...... \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u91cd\u65b0\u8986\u76d6 Loki \u5373\u53ef\uff1a $ helm upgrade --install loki -n logging -f ci/cache-values.yaml . \u5b89\u88c5\u5b8c\u6210\u540e\u603b\u4f53\u7684 Pod \u5982\u4e0b\u6240\u793a\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE grafana-55d8779dc6-mm5f2 1/1 Running 0 70m loki-loki-distributed-distributor-77f8f99dbb-7snns 1/1 Running 0 38m loki-loki-distributed-distributor-77f8f99dbb-rsn7l 1/1 Running 0 38m loki-loki-distributed-gateway-6f4cfd898c-p9xxf 1/1 Running 2 (4h9m ago) 3d1h loki-loki-distributed-ingester-0 1/1 Running 0 37m loki-loki-distributed-ingester-1 1/1 Running 0 38m loki-loki-distributed-querier-0 1/1 Running 0 38m loki-loki-distributed-querier-1 1/1 Running 0 38m loki-loki-distributed-query-frontend-78c4ccc99b-4t85w 1/1 Running 0 38m loki-loki-distributed-query-frontend-78c4ccc99b-cgh8d 1/1 Running 0 38m loki-loki-distributed-ruler-5654f8cf59-pjb8p 1/1 Running 0 38m minio-548656f786-mjd4c 1/1 Running 3 (4h10m ago) 6d22h promtail-ddz27 1/1 Running 1 (4h10m ago) 3d1h promtail-lzr6v 1/1 Running 1 (4h10m ago) 3d1h promtail-nldqx 1/1 Running 2 (4h4m ago) 3d1h redis-7fb8ff6779-m26m6 2/2 Running 0 30m \u6b63\u5e38\u73b0\u5728 Redis \u670d\u52a1\u5c31\u5df2\u7ecf\u518d\u4f7f\u7528\u4e86\uff0c\u4e0b\u56fe\u5c55\u793a\u4e86 redis \u7684\u8fd0\u884c\u72b6\u6001\uff0c\u53ef\u4ee5\u770b\u51fa\u538b\u529b\u4e5f\u5e76\u4e0d\u5927\u3002","title":"\u7f13\u5b58"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/","text":"\u642d\u5efa EFK \u65e5\u5fd7\u7cfb\u7edf \u00b6 \u642d\u5efa EFK \u65e5\u5fd7\u7cfb\u7edf \u00b6 \u524d\u9762\u5927\u5bb6\u4ecb\u7ecd\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u51e0\u79cd\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\uff0cKubernetes \u4e2d\u6bd4\u8f83\u6d41\u884c\u7684\u65e5\u5fd7\u6536\u96c6\u89e3\u51b3\u65b9\u6848\u662f Elasticsearch\u3001Fluentd \u548c Kibana\uff08EFK\uff09\u6280\u672f\u6808\uff0c\u4e5f\u662f\u5b98\u65b9\u73b0\u5728\u6bd4\u8f83\u63a8\u8350\u7684\u4e00\u79cd\u65b9\u6848\u3002 Elasticsearch \u662f\u4e00\u4e2a\u5b9e\u65f6\u7684\u3001\u5206\u5e03\u5f0f\u7684\u53ef\u6269\u5c55\u7684\u641c\u7d22\u5f15\u64ce\uff0c\u5141\u8bb8\u8fdb\u884c\u5168\u6587\u3001\u7ed3\u6784\u5316\u641c\u7d22\uff0c\u5b83\u901a\u5e38\u7528\u4e8e\u7d22\u5f15\u548c\u641c\u7d22\u5927\u91cf\u65e5\u5fd7\u6570\u636e\uff0c\u4e5f\u53ef\u7528\u4e8e\u641c\u7d22\u8bb8\u591a\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u6863\u3002 Elasticsearch \u901a\u5e38\u4e0e Kibana \u4e00\u8d77\u90e8\u7f72\uff0cKibana \u662f Elasticsearch \u7684\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6570\u636e\u53ef\u89c6\u5316 Dashboard\uff0cKibana \u5141\u8bb8\u4f60\u901a\u8fc7 web \u754c\u9762\u6765\u6d4f\u89c8 Elasticsearch \u65e5\u5fd7\u6570\u636e\u3002 Fluentd \u662f\u4e00\u4e2a\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u6536\u96c6\u5668\uff0c\u6211\u4eec\u5c06\u5728 Kubernetes \u96c6\u7fa4\u8282\u70b9\u4e0a\u5b89\u88c5 Fluentd\uff0c\u901a\u8fc7\u83b7\u53d6\u5bb9\u5668\u65e5\u5fd7\u6587\u4ef6\u3001\u8fc7\u6ee4\u548c\u8f6c\u6362\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u5c06\u6570\u636e\u4f20\u9012\u5230 Elasticsearch \u96c6\u7fa4\uff0c\u5728\u8be5\u96c6\u7fa4\u4e2d\u5bf9\u5176\u8fdb\u884c\u7d22\u5f15\u548c\u5b58\u50a8\u3002 \u6211\u4eec\u5148\u6765\u914d\u7f6e\u542f\u52a8\u4e00\u4e2a\u53ef\u6269\u5c55\u7684 Elasticsearch \u96c6\u7fa4\uff0c\u7136\u540e\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Kibana \u5e94\u7528\uff0c\u6700\u540e\u901a\u8fc7 DaemonSet \u6765\u8fd0\u884c Fluentd\uff0c\u4ee5\u4fbf\u5b83\u5728\u6bcf\u4e2a Kubernetes \u5de5\u4f5c\u8282\u70b9\u4e0a\u90fd\u53ef\u4ee5\u8fd0\u884c\u4e00\u4e2a Pod\u3002 \u5b89\u88c5 Elasticsearch \u96c6\u7fa4 \u00b6 \u5728\u521b\u5efa Elasticsearch \u96c6\u7fa4\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u6211\u4eec\u5c06\u5728\u5176\u4e2d\u5b89\u88c5\u6240\u6709\u65e5\u5fd7\u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\u3002 $ kubectl create ns logging \u73af\u5883\u51c6\u5907 \u00b6 ElasticSearch \u5b89\u88c5\u6709\u6700\u4f4e\u5b89\u88c5\u8981\u6c42\uff0c\u5982\u679c\u5b89\u88c5\u540e Pod \u65e0\u6cd5\u6b63\u5e38\u542f\u52a8\uff0c\u8bf7\u68c0\u67e5\u662f\u5426\u7b26\u5408\u6700\u4f4e\u8981\u6c42\u7684\u914d\u7f6e\uff0c\u8981\u6c42\u5982\u4e0b\uff1a \u8fd9\u91cc\u6211\u4eec\u8981\u5b89\u88c5\u7684 ES \u96c6\u7fa4\u73af\u5883\u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a NFS \u7c7b\u578b\u7684 StorageClass \u6765\u505a\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5f53\u7136\u5982\u679c\u4f60\u662f\u7ebf\u4e0a\u73af\u5883\u5efa\u8bae\u4f7f\u7528 Local PV \u6216\u8005 Ceph RBD \u4e4b\u7c7b\u7684\u5b58\u50a8\u6765\u6301\u4e45\u5316 Elasticsearch \u7684\u6570\u636e\u3002 \u6b64\u5916\u7531\u4e8e ElasticSearch 7.x \u7248\u672c\u9ed8\u8ba4\u5b89\u88c5\u4e86 X-Pack \u63d2\u4ef6\uff0c\u5e76\u4e14\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u9700\u8981\u6211\u4eec\u914d\u7f6e\u4e00\u4e9b\u5b89\u5168\u8bc1\u4e66\u6587\u4ef6\u3002 1\u3001\u751f\u6210\u8bc1\u4e66\u6587\u4ef6 # \u8fd0\u884c\u5bb9\u5668\u751f\u6210\u8bc1\u4e66\uff0ccontainerd\u4e0b\u9762\u7528nerdctl $ mkdir -p elastic-certs $ nerdctl run --name elastic-certs -v elastic-certs:/app -it -w /app elasticsearch:7.17.3 /bin/sh -c \\ \"elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass '' && \\ elasticsearch-certutil cert --name security-master --dns \\ security-master --ca /app/elastic-stack-ca.p12 --pass '' --ca-pass '' --out /app/elastic-certificates.p12\" # \u5220\u9664\u5bb9\u5668 $ nerdctl rm -f elastic-certs # \u5c06 pcks12 \u4e2d\u7684\u4fe1\u606f\u5206\u79bb\u51fa\u6765\uff0c\u5199\u5165\u6587\u4ef6 $ cd elastic-certs && openssl pkcs12 -nodes -passin pass:'' -in elastic-certificates.p12 -out elastic-certificate.pem \u9700\u8981\u6ce8\u610f nerdctl \u5982\u679c\u662f v0.20.0 \u7248\u672c\uff0c\u9700\u8981\u66f4\u65b0 CNI \u63d2\u4ef6\u7248\u672c\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u9519\u8bef FATA[0000] failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: process_linux.go:545: container init caused: Running hook #0:: error running hook: exit status 1, stdout: , stderr: time=\"2022-06-06T16:37:03+08:00\" level=fatal msg=\"failed to call cni.Setup: plugin type=\\\"bridge\\\" failed (add): incompatible CNI versions; config is \\\"1.0.0\\\", plugin supports [\\\"0.1.0\\\" \\\"0.2.0\\\" \\\"0.3.0\\\" \\\"0.3.1\\\" \\\"0.4.0\\\"]\" \uff0c\u5c06 CNI \u63d2\u4ef6\u4ece https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz \u4e0b\u8f7d\u4e0b\u6765\u8986\u76d6 /opt/cni/bin \u76ee\u5f55\u5373\u53ef\u3002 2\u3001\u6dfb\u52a0\u8bc1\u4e66\u5230 Kubernetes # \u6dfb\u52a0\u8bc1\u4e66 $ kubectl create secret -n logging generic elastic-certs --from-file=elastic-certificates.p12 # \u8bbe\u7f6e\u96c6\u7fa4\u7528\u6237\u540d\u5bc6\u7801 $ kubectl create secret -n logging generic elastic-auth --from-literal=username=elastic --from-literal=password=ydzsio321 \u5b89\u88c5 ES \u96c6\u7fa4 \u00b6 \u9996\u5148\u6dfb\u52a0 ELastic \u7684 Helm \u4ed3\u5e93\uff1a $ helm repo add elastic https://helm.elastic.co $ helm repo update ElaticSearch \u5b89\u88c5\u9700\u8981\u5b89\u88c5\u4e09\u6b21\uff0c\u5206\u522b\u5b89\u88c5 Master\u3001Data\u3001Client \u8282\u70b9\uff0cMaster \u8282\u70b9\u8d1f\u8d23\u96c6\u7fa4\u95f4\u7684\u7ba1\u7406\u5de5\u4f5c\uff1bData \u8282\u70b9\u8d1f\u8d23\u5b58\u50a8\u6570\u636e\uff1bClient \u8282\u70b9\u8d1f\u8d23\u4ee3\u7406 ElasticSearch Cluster \u96c6\u7fa4\uff0c\u8d1f\u8f7d\u5747\u8861\u3002 \u9996\u5148\u4f7f\u7528 helm pull \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a $ helm pull elastic/elasticsearch --untar --version 7.17.3 $ cd elasticsearch \u5728 Chart \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e Master \u8282\u70b9\u5b89\u88c5\u914d\u7f6e\u7684 values \u6587\u4ef6\uff1a # values-master.yaml ## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0 clusterName: \"elasticsearch\" ## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0 nodeGroup: \"master\" ## \u8bbe\u7f6e\u89d2\u8272 roles: master: \"true\" ingest: \"false\" data: \"false\" # ============\u955c\u50cf\u914d\u7f6e============ ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"elasticsearch\" imageTag: \"7.17.3\" imagePullPolicy: \"IfNotPresent\" ## \u526f\u672c\u6570 replicas: 3 # ============\u8d44\u6e90\u914d\u7f6e============ ## JVM \u914d\u7f6e\u53c2\u6570 esJavaOpts: \"-Xmx1g -Xms1g\" ## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u8981\u8bbe\u7f6e\u5927\u4e9b) resources: requests: cpu: \"2000m\" memory: \"2Gi\" limits: cpu: \"2000m\" memory: \"2Gi\" ## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e persistence: enabled: true ## \u5b58\u50a8\u6570\u636e\u5927\u5c0f\u914d\u7f6e volumeClaimTemplate: storageClassName: local-path accessModes: [\"ReadWriteOnce\"] resources: requests: storage: 5Gi # ============\u5b89\u5168\u914d\u7f6e============ ## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https protocol: http ## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs defaultMode: 0755 ## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml\u3001log4j2.properties ## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b ## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ============\u8c03\u5ea6\u914d\u7f6e============ ## \u8bbe\u7f6e\u8c03\u5ea6\u7b56\u7565 ## - hard\uff1a\u53ea\u6709\u5f53\u6709\u8db3\u591f\u7684\u8282\u70b9\u65f6 Pod \u624d\u4f1a\u88ab\u8c03\u5ea6\uff0c\u5e76\u4e14\u5b83\u4eec\u6c38\u8fdc\u4e0d\u4f1a\u51fa\u73b0\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a ## - soft\uff1a\u5c3d\u6700\u5927\u52aa\u529b\u8c03\u5ea6 antiAffinity: \"soft\" # tolerations: # - operator: \"Exists\" ##\u5bb9\u5fcd\u5168\u90e8\u6c61\u70b9 \u7136\u540e\u521b\u5efa\u7528\u4e8e Data \u8282\u70b9\u5b89\u88c5\u7684 values \u6587\u4ef6\uff1a # values-data.yaml # ============\u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0============ ## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0 clusterName: \"elasticsearch\" ## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0 nodeGroup: \"data\" ## \u8bbe\u7f6e\u89d2\u8272 roles: master: \"false\" ingest: \"true\" data: \"true\" # ============\u955c\u50cf\u914d\u7f6e============ ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"elasticsearch\" imageTag: \"7.17.3\" ## \u526f\u672c\u6570(\u5efa\u8bae\u8bbe\u7f6e\u4e3a3\uff0c\u6211\u8fd9\u91cc\u8d44\u6e90\u4e0d\u8db3\u53ea\u7528\u4e861\u4e2a\u526f\u672c) replicas: 3 # ============\u8d44\u6e90\u914d\u7f6e============ ## JVM \u914d\u7f6e\u53c2\u6570 esJavaOpts: \"-Xmx1g -Xms1g\" ## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u4e00\u5b9a\u8981\u8bbe\u7f6e\u5927\u4e9b) resources: requests: cpu: \"1000m\" memory: \"2Gi\" limits: cpu: \"1000m\" memory: \"2Gi\" ## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e persistence: enabled: true ## \u5b58\u50a8\u6570\u636e\u5927\u5c0f\u914d\u7f6e volumeClaimTemplate: storageClassName: local-path accessModes: [\"ReadWriteOnce\"] resources: requests: storage: 10Gi # ============\u5b89\u5168\u914d\u7f6e============ ## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https protocol: http ## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs ## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml ## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b ## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ============\u8c03\u5ea6\u914d\u7f6e============ ## \u8bbe\u7f6e\u8c03\u5ea6\u7b56\u7565 ## - hard\uff1a\u53ea\u6709\u5f53\u6709\u8db3\u591f\u7684\u8282\u70b9\u65f6 Pod \u624d\u4f1a\u88ab\u8c03\u5ea6\uff0c\u5e76\u4e14\u5b83\u4eec\u6c38\u8fdc\u4e0d\u4f1a\u51fa\u73b0\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a ## - soft\uff1a\u5c3d\u6700\u5927\u52aa\u529b\u8c03\u5ea6 antiAffinity: \"soft\" ## \u5bb9\u5fcd\u914d\u7f6e # tolerations: # - operator: \"Exists\" ##\u5bb9\u5fcd\u5168\u90e8\u6c61\u70b9 \u6700\u540e\u4e00\u4e2a\u662f\u7528\u4e8e\u521b\u5efa Client \u8282\u70b9\u7684 values \u6587\u4ef6\uff1a # values-client.yaml # ============\u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0============ ## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0 clusterName: \"elasticsearch\" ## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0 nodeGroup: \"client\" ## \u8bbe\u7f6e\u89d2\u8272 roles: master: \"false\" ingest: \"false\" data: \"false\" # ============\u955c\u50cf\u914d\u7f6e============ ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"elasticsearch\" imageTag: \"7.17.3\" ## \u526f\u672c\u6570 replicas: 1 # ============\u8d44\u6e90\u914d\u7f6e============ ## JVM \u914d\u7f6e\u53c2\u6570 esJavaOpts: \"-Xmx1g -Xms1g\" ## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u4e00\u5b9a\u8981\u8bbe\u7f6e\u5927\u4e9b) resources: requests: cpu: \"1000m\" memory: \"2Gi\" limits: cpu: \"1000m\" memory: \"2Gi\" ## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e persistence: enabled: false # ============\u5b89\u5168\u914d\u7f6e============ ## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https protocol: http ## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs ## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml ## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b ## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ============Service \u914d\u7f6e============ service: type: NodePort nodePort: \"30200\" \u73b0\u5728\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5\uff1a # \u5b89\u88c5 master \u8282\u70b9 $ helm upgrade --install es-master -f values-master.yaml --namespace logging . # \u5b89\u88c5 data \u8282\u70b9 $ helm upgrade --install es-data -f values-data.yaml --namespace logging . # \u5b89\u88c5 client \u8282\u70b9 $ helm upgrade --install es-client -f values-client.yaml --namespace logging . \u5728\u5b89\u88c5 Master \u8282\u70b9\u540e Pod \u542f\u52a8\u65f6\u5019\u4f1a\u629b\u51fa\u5f02\u5e38\uff0c\u5c31\u7eea\u63a2\u9488\u63a2\u6d3b\u5931\u8d25\uff0c\u8fd9\u662f\u4e2a\u6b63\u5e38\u73b0\u8c61\u3002\u5728\u6267\u884c\u5b89\u88c5 Data \u8282\u70b9\u540e Master \u8282\u70b9 Pod \u5c31\u4f1a\u6062\u590d\u6b63\u5e38\u3002 \u5b89\u88c5 Kibana \u00b6 Elasticsearch \u96c6\u7fa4\u5b89\u88c5\u5b8c\u6210\u540e\u63a5\u4e0b\u6765\u914d\u7f6e\u5b89\u88c5 Kibana \u4f7f\u7528 helm pull \u547d\u4ee4\u62c9\u53d6 Kibana Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull elastic/kibana --untar --version 7.17.3 $ cd kibana \u521b\u5efa\u7528\u4e8e\u5b89\u88c5 Kibana \u7684 values \u6587\u4ef6\uff1a # values-prod.yaml ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"kibana\" imageTag: \"7.17.3\" ## \u914d\u7f6e ElasticSearch \u5730\u5740 elasticsearchHosts: \"http://elasticsearch-client:9200\" # ============\u73af\u5883\u53d8\u91cf\u914d\u7f6e============ ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: \"ELASTICSEARCH_USERNAME\" valueFrom: secretKeyRef: name: elastic-auth key: username - name: \"ELASTICSEARCH_PASSWORD\" valueFrom: secretKeyRef: name: elastic-auth key: password # ============\u8d44\u6e90\u914d\u7f6e============ resources: requests: cpu: \"500m\" memory: \"1Gi\" limits: cpu: \"500m\" memory: \"1Gi\" # ============\u914d\u7f6e Kibana \u53c2\u6570============ ## kibana \u914d\u7f6e\u4e2d\u6dfb\u52a0\u8bed\u8a00\u914d\u7f6e\uff0c\u8bbe\u7f6e kibana \u4e3a\u4e2d\u6587 kibanaConfig: kibana.yml: | i18n.locale: \"zh-CN\" # ============Service \u914d\u7f6e============ service: type: NodePort nodePort: \"30601\" \u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a $ helm install kibana -f values-prod.yaml --namespace logging . \u4e0b\u9762\u662f\u5b89\u88c5\u5b8c\u6210\u540e\u7684 ES \u96c6\u7fa4\u548c Kibana \u8d44\u6e90\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE elasticsearch-client-0 1/1 Running 0 9m25s elasticsearch-data-0 1/1 Running 0 9m33s elasticsearch-master-0 1/1 Running 0 8m29s kibana-kibana-79b9878cd7-7l75v 1/1 Running 0 6m12s $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE elasticsearch-client NodePort 10.108.226.197 <none> 9200:30200/TCP,9300:32746/TCP 3m25s elasticsearch-client-headless ClusterIP None <none> 9200/TCP,9300/TCP 3m25s elasticsearch-data ClusterIP 10.104.121.49 <none> 9200/TCP,9300/TCP 3m33s elasticsearch-data-headless ClusterIP None <none> 9200/TCP,9300/TCP 3m33s elasticsearch-master ClusterIP 10.102.72.71 <none> 9200/TCP,9300/TCP 6m8s elasticsearch-master-headless ClusterIP None <none> 9200/TCP,9300/TCP 6m8s kibana-kibana NodePort 10.109.35.219 <none> 5601:30601/TCP 12s \u4e0a\u9762\u6211\u4eec\u5b89\u88c5 Kibana \u7684\u65f6\u5019\u6307\u5b9a\u4e86 30601 \u7684 NodePort \u7aef\u53e3\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4ece\u4efb\u610f\u8282\u70b9 http://IP:30601 \u6765\u8bbf\u95ee Kibana\u3002 \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f1a\u8df3\u8f6c\u5230\u767b\u5f55\u9875\u9762\uff0c\u8ba9\u6211\u4eec\u8f93\u51fa\u7528\u6237\u540d\u3001\u5bc6\u7801\uff0c\u8fd9\u91cc\u6211\u4eec\u8f93\u5165\u4e0a\u9762\u914d\u7f6e\u7684\u7528\u6237\u540d elastic \u3001\u5bc6\u7801 ydzsio321 \u8fdb\u884c\u767b\u5f55\u3002\u767b\u5f55\u6210\u529f\u540e\u8fdb\u5165\u5982\u4e0b\u6240\u793a\u7684 Kibana \u4e3b\u9875\uff1a \u90e8\u7f72 Fluentd \u00b6 Fluentd \u662f\u4e00\u4e2a\u9ad8\u6548\u7684\u65e5\u5fd7\u805a\u5408\u5668\uff0c\u662f\u7528 Ruby \u7f16\u5199\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u5f88\u597d\u5730\u6269\u5c55\u3002\u5bf9\u4e8e\u5927\u90e8\u5206\u4f01\u4e1a\u6765\u8bf4\uff0cFluentd \u8db3\u591f\u9ad8\u6548\u5e76\u4e14\u6d88\u8017\u7684\u8d44\u6e90\u76f8\u5bf9\u8f83\u5c11\uff0c\u53e6\u5916\u4e00\u4e2a\u5de5\u5177 Fluent-bit \u66f4\u8f7b\u91cf\u7ea7\uff0c\u5360\u7528\u8d44\u6e90\u66f4\u5c11\uff0c\u4f46\u662f\u63d2\u4ef6\u76f8\u5bf9 Fluentd \u6765\u8bf4\u4e0d\u591f\u4e30\u5bcc\uff0c\u6240\u4ee5\u6574\u4f53\u6765\u8bf4\uff0cFluentd \u66f4\u52a0\u6210\u719f\uff0c\u4f7f\u7528\u66f4\u52a0\u5e7f\u6cdb\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 Fluentd \u6765\u4f5c\u4e3a\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002 \u5de5\u4f5c\u539f\u7406 \u00b6 Fluentd \u901a\u8fc7\u4e00\u7ec4\u7ed9\u5b9a\u7684\u6570\u636e\u6e90\u6293\u53d6\u65e5\u5fd7\u6570\u636e\uff0c\u5904\u7406\u540e\uff08\u8f6c\u6362\u6210\u7ed3\u6784\u5316\u7684\u6570\u636e\u683c\u5f0f\uff09\u5c06\u5b83\u4eec\u8f6c\u53d1\u7ed9\u5176\u4ed6\u670d\u52a1\uff0c\u6bd4\u5982 Elasticsearch\u3001\u5bf9\u8c61\u5b58\u50a8\u7b49\u7b49\u3002Fluentd \u652f\u6301\u8d85\u8fc7 300 \u4e2a\u65e5\u5fd7\u5b58\u50a8\u548c\u5206\u6790\u670d\u52a1\uff0c\u6240\u4ee5\u5728\u8fd9\u65b9\u9762\u662f\u975e\u5e38\u7075\u6d3b\u7684\u3002\u4e3b\u8981\u8fd0\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a \u9996\u5148 Fluentd \u4ece\u591a\u4e2a\u65e5\u5fd7\u6e90\u83b7\u53d6\u6570\u636e \u7ed3\u6784\u5316\u5e76\u4e14\u6807\u8bb0\u8fd9\u4e9b\u6570\u636e \u7136\u540e\u6839\u636e\u5339\u914d\u7684\u6807\u7b7e\u5c06\u6570\u636e\u53d1\u9001\u5230\u591a\u4e2a\u76ee\u6807\u670d\u52a1\u53bb \u914d\u7f6e \u00b6 \u4e00\u822c\u6765\u8bf4\u6211\u4eec\u662f\u901a\u8fc7\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u544a\u8bc9 Fluentd \u5982\u4f55\u91c7\u96c6\u3001\u5904\u7406\u6570\u636e\u7684\uff0c\u4e0b\u9762\u7b80\u5355\u548c\u5927\u5bb6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u65b9\u6cd5\u3002 \u65e5\u5fd7\u6e90\u914d\u7f6e \u00b6 \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u6536\u96c6 Kubernetes \u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\uff0c\u5c31\u9700\u8981\u505a\u5982\u4e0b\u7684\u65e5\u5fd7\u6e90\u914d\u7f6e\uff1a <source> @id fluentd-containers.log @type tail # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\u3002 path /var/log/containers/*.log # \u6302\u8f7d\u7684\u5bbf\u4e3b\u673a\u5bb9\u5668\u65e5\u5fd7\u5730\u5740 pos_file /var/log/es-containers.log.pos tag raw.kubernetes.* # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e read_from_head true <parse> # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON @type multi_format # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6 <pattern> format json # JSON \u89e3\u6790\u5668 time_key time # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5 time_format %Y-%m-%dT%H:%M:%S.%NZ # \u65f6\u95f4\u683c\u5f0f </pattern> <pattern> format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z </pattern> </parse> </source> \u4e0a\u9762\u914d\u7f6e\u90e8\u5206\u53c2\u6570\u8bf4\u660e\u5982\u4e0b\uff1a id\uff1a\u8868\u793a\u5f15\u7528\u8be5\u65e5\u5fd7\u6e90\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u8be5\u6807\u8bc6\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u8def\u7531\u7ed3\u6784\u5316\u65e5\u5fd7\u6570\u636e type\uff1aFluentd \u5185\u7f6e\u7684\u6307\u4ee4\uff0c tail \u8868\u793a Fluentd \u4ece\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\u901a\u8fc7 tail \u4e0d\u65ad\u83b7\u53d6\u6570\u636e\uff0c\u53e6\u5916\u4e00\u4e2a\u662f http \u8868\u793a\u901a\u8fc7\u4e00\u4e2a GET \u8bf7\u6c42\u6765\u6536\u96c6\u6570\u636e\u3002 path\uff1a tail \u7c7b\u578b\u4e0b\u7684\u7279\u5b9a\u53c2\u6570\uff0c\u544a\u8bc9 Fluentd \u91c7\u96c6 /var/log/containers \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u65e5\u5fd7\uff0c\u8fd9\u662f docker \u5728 Kubernetes \u8282\u70b9\u4e0a\u7528\u6765\u5b58\u50a8\u8fd0\u884c\u5bb9\u5668 stdout \u8f93\u51fa\u65e5\u5fd7\u6570\u636e\u7684\u76ee\u5f55\u3002 pos_file\uff1a\u68c0\u67e5\u70b9\uff0c\u5982\u679c Fluentd \u7a0b\u5e8f\u91cd\u65b0\u542f\u52a8\u4e86\uff0c\u5b83\u5c06\u4f7f\u7528\u6b64\u6587\u4ef6\u4e2d\u7684\u4f4d\u7f6e\u6765\u6062\u590d\u65e5\u5fd7\u6570\u636e\u6536\u96c6\u3002 tag\uff1a\u7528\u6765\u5c06\u65e5\u5fd7\u6e90\u4e0e\u76ee\u6807\u6216\u8005\u8fc7\u6ee4\u5668\u5339\u914d\u7684\u81ea\u5b9a\u4e49\u5b57\u7b26\u4e32\uff0cFluentd \u5339\u914d\u6e90/\u76ee\u6807\u6807\u7b7e\u6765\u8def\u7531\u65e5\u5fd7\u6570\u636e\u3002 \u8def\u7531\u914d\u7f6e \u00b6 \u4e0a\u9762\u662f\u65e5\u5fd7\u6e90\u7684\u914d\u7f6e\uff0c\u63a5\u4e0b\u6765\u770b\u770b\u5982\u4f55\u5c06\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230 Elasticsearch\uff1a <match **> @id elasticsearch @type elasticsearch @log_level info include_tag_key true type_name fluentd host \"#{ENV['OUTPUT_HOST']}\" port \"#{ENV['OUTPUT_PORT']}\" logstash_format true <buffer> @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size \"#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}\" queue_limit_length \"#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}\" overflow_action block </buffer> </match> match\uff1a\u6807\u8bc6\u4e00\u4e2a\u76ee\u6807\u6807\u7b7e\uff0c\u540e\u9762\u662f\u4e00\u4e2a\u5339\u914d\u65e5\u5fd7\u6e90\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u60f3\u8981\u6355\u83b7\u6240\u6709\u7684\u65e5\u5fd7\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u7ed9 Elasticsearch\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u6210 ** \u3002 id\uff1a\u76ee\u6807\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\u7b26\u3002 type\uff1a\u652f\u6301\u7684\u8f93\u51fa\u63d2\u4ef6\u6807\u8bc6\u7b26\uff0c\u6211\u4eec\u8fd9\u91cc\u8981\u8f93\u51fa\u5230 Elasticsearch\uff0c\u6240\u4ee5\u914d\u7f6e\u6210 elasticsearch\uff0c\u8fd9\u662f Fluentd \u7684\u4e00\u4e2a\u5185\u7f6e\u63d2\u4ef6\u3002 log_level\uff1a\u6307\u5b9a\u8981\u6355\u83b7\u7684\u65e5\u5fd7\u7ea7\u522b\uff0c\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u6210 info \uff0c\u8868\u793a\u4efb\u4f55\u8be5\u7ea7\u522b\u6216\u8005\u8be5\u7ea7\u522b\u4ee5\u4e0a\uff08INFO\u3001WARNING\u3001ERROR\uff09\u7684\u65e5\u5fd7\u90fd\u5c06\u88ab\u8def\u7531\u5230 Elsasticsearch\u3002 host/port\uff1a\u5b9a\u4e49 Elasticsearch \u7684\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u8ba4\u8bc1\u4fe1\u606f\uff0c\u6211\u4eec\u7684 Elasticsearch \u4e0d\u9700\u8981\u8ba4\u8bc1\uff0c\u6240\u4ee5\u8fd9\u91cc\u76f4\u63a5\u6307\u5b9a host \u548c port \u5373\u53ef\u3002 logstash_format\uff1aElasticsearch \u670d\u52a1\u5bf9\u65e5\u5fd7\u6570\u636e\u6784\u5efa\u53cd\u5411\u7d22\u5f15\u8fdb\u884c\u641c\u7d22\uff0c\u5c06 logstash_format \u8bbe\u7f6e\u4e3a true \uff0cFluentd \u5c06\u4f1a\u4ee5 logstash \u683c\u5f0f\u6765\u8f6c\u53d1\u7ed3\u6784\u5316\u7684\u65e5\u5fd7\u6570\u636e\u3002 Buffer\uff1a Fluentd \u5141\u8bb8\u5728\u76ee\u6807\u4e0d\u53ef\u7528\u65f6\u8fdb\u884c\u7f13\u5b58\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u7f51\u7edc\u51fa\u73b0\u6545\u969c\u6216\u8005 Elasticsearch \u4e0d\u53ef\u7528\u7684\u65f6\u5019\u3002\u7f13\u51b2\u533a\u914d\u7f6e\u4e5f\u6709\u52a9\u4e8e\u964d\u4f4e\u78c1\u76d8\u7684 IO\u3002 \u8fc7\u6ee4 \u00b6 \u7531\u4e8e Kubernetes \u96c6\u7fa4\u4e2d\u5e94\u7528\u592a\u591a\uff0c\u4e5f\u8fd8\u6709\u5f88\u591a\u5386\u53f2\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53ea\u5c06\u67d0\u4e9b\u5e94\u7528\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\uff0c\u6bd4\u5982\u6211\u4eec\u53ea\u91c7\u96c6\u5177\u6709 logging=true \u8fd9\u4e2a Label \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u4f7f\u7528 filter\uff0c\u5982\u4e0b\u6240\u793a\uff1a # \u5220\u9664\u65e0\u7528\u7684\u5c5e\u6027 <filter kubernetes.**> @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash </filter> # \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7 <filter kubernetes.**> @id filter_log @type grep <regexp> key $.kubernetes.labels.logging pattern ^true$ </regexp> </filter> \u5b89\u88c5 \u00b6 \u8981\u6536\u96c6 Kubernetes \u96c6\u7fa4\u7684\u65e5\u5fd7\uff0c\u76f4\u63a5\u7528 DasemonSet \u63a7\u5236\u5668\u6765\u90e8\u7f72 Fluentd \u5e94\u7528\uff0c\u8fd9\u6837\uff0c\u5b83\u5c31\u53ef\u4ee5\u4ece Kubernetes \u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u59cb\u7ec8\u8fd0\u884c\u4e00\u4e2a Fluentd \u5bb9\u5668\u3002\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Helm \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff0c\u4e3a\u4e86\u80fd\u591f\u4e86\u89e3\u66f4\u591a\u5b9e\u73b0\u7ec6\u8282\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u624b\u52a8\u65b9\u6cd5\u6765\u8fdb\u884c\u5b89\u88c5\u3002 \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b98\u65b9\u7684\u5bf9\u4e8e Kubernetes \u96c6\u7fa4\u7684\u5b89\u88c5\u6587\u6863: https://docs.fluentd.org/container-deployment/kubernetes \u3002 \u9996\u5148\uff0c\u6211\u4eec\u901a\u8fc7 ConfigMap \u5bf9\u8c61\u6765\u6307\u5b9a Fluentd \u914d\u7f6e\u6587\u4ef6\uff0c\u65b0\u5efa fluentd-configmap.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a # fluentd-configmap.yaml kind: ConfigMap apiVersion: v1 metadata: name: fluentd-conf namespace: logging data: # \u5bb9\u5668\u65e5\u5fd7 containers.input.conf: |- <source> @id fluentd-containers.log @type tail # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7 path /var/log/containers/*.log # Docker \u5bb9\u5668\u65e5\u5fd7\u8def\u5f84 pos_file /var/log/es-containers.log.pos # \u8bb0\u5f55\u8bfb\u53d6\u7684\u4f4d\u7f6e tag raw.kubernetes.* # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e read_from_head true # \u4ece\u5934\u8bfb\u53d6 <parse> # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON # \u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u4ecb\u7ecd\u8fc7\u7684 multiline \u63d2\u4ef6\u5b9e\u73b0\u591a\u884c\u65e5\u5fd7 @type multi_format # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6 <pattern> format json # JSON\u89e3\u6790\u5668 time_key time # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5 time_format %Y-%m-%dT%H:%M:%S.%NZ # \u65f6\u95f4\u683c\u5f0f </pattern> <pattern> format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z </pattern> </parse> </source> # \u5728\u65e5\u5fd7\u8f93\u51fa\u4e2d\u68c0\u6d4b\u5f02\u5e38(\u591a\u884c\u65e5\u5fd7)\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u4e00\u6761\u65e5\u5fd7\u8f6c\u53d1 # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions <match raw.kubernetes.**> # \u5339\u914dtag\u4e3araw.kubernetes.**\u65e5\u5fd7\u4fe1\u606f @id raw.kubernetes @type detect_exceptions # \u4f7f\u7528detect-exceptions\u63d2\u4ef6\u5904\u7406\u5f02\u5e38\u6808\u4fe1\u606f remove_tag_prefix raw # \u79fb\u9664 raw \u524d\u7f00 message log multiline_flush_interval 5 </match> <filter **> # \u62fc\u63a5\u65e5\u5fd7 @id filter_concat @type concat # Fluentd Filter \u63d2\u4ef6\uff0c\u7528\u4e8e\u8fde\u63a5\u591a\u4e2a\u65e5\u5fd7\u4e2d\u5206\u9694\u7684\u591a\u884c\u65e5\u5fd7 key message multiline_end_regexp /\\n$/ # \u4ee5\u6362\u884c\u7b26\u201c\\n\u201d\u62fc\u63a5 separator \"\" </filter> # \u6dfb\u52a0 Kubernetes metadata \u6570\u636e <filter kubernetes.**> @id filter_kubernetes_metadata @type kubernetes_metadata </filter> # \u4fee\u590d ES \u4e2d\u7684 JSON \u5b57\u6bb5 # \u63d2\u4ef6\u5730\u5740\uff1ahttps://github.com/repeatedly/fluent-plugin-multi-format-parser <filter kubernetes.**> @id filter_parser @type parser # multi-format-parser\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6 key_name log # \u5728\u8981\u89e3\u6790\u7684\u65e5\u5fd7\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0 reserve_data true # \u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9 remove_key_name_field true # key_name \u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5 <parse> @type multi_format <pattern> format json </pattern> <pattern> format none </pattern> </parse> </filter> # \u5220\u9664\u4e00\u4e9b\u591a\u4f59\u7684\u5c5e\u6027 <filter kubernetes.**> @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash </filter> # \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7 <filter kubernetes.**> @id filter_log @type grep <regexp> key $.kubernetes.labels.logging pattern ^true$ </regexp> </filter> ###### \u76d1\u542c\u914d\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u65e5\u5fd7\u805a\u5408\u7528 ###### forward.input.conf: |- # \u76d1\u542c\u901a\u8fc7TCP\u53d1\u9001\u7684\u6d88\u606f <source> @id forward @type forward </source> output.conf: |- <match **> @id elasticsearch @type elasticsearch @log_level info include_tag_key true host elasticsearch-client port 9200 user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD password ydzsio321 logstash_format true logstash_prefix k8s request_timeout 30s <buffer> @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size 2M queue_limit_length 8 overflow_action block </buffer> </match> \u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u53ea\u914d\u7f6e\u4e86 docker \u5bb9\u5668\u65e5\u5fd7\u76ee\u5f55\uff0c\u6536\u96c6\u5230\u6570\u636e\u7ecf\u8fc7\u5904\u7406\u540e\u53d1\u9001\u5230 elasticsearch-client:9200 \u670d\u52a1\u3002 \u7136\u540e\u65b0\u5efa\u4e00\u4e2a fluentd-daemonset.yaml \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: v1 kind: ServiceAccount metadata: name: fluentd-es namespace: logging labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile rules: - apiGroups: - \"\" resources: - \"namespaces\" - \"pods\" verbs: - \"get\" - \"watch\" - \"list\" --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile subjects: - kind: ServiceAccount name: fluentd-es namespace: logging apiGroup: \"\" roleRef: kind: ClusterRole name: fluentd-es apiGroup: \"\" --- apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd namespace: logging labels: app: fluentd kubernetes.io/cluster-service: \"true\" spec: selector: matchLabels: app: fluentd template: metadata: labels: app: fluentd kubernetes.io/cluster-service: \"true\" spec: tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule serviceAccountName: fluentd-es containers: - name: fluentd image: quay.io/fluentd_elasticsearch/fluentd:v3.4.0 volumeMounts: - name: fluentconfig mountPath: /etc/fluent/config.d - name: varlog mountPath: /var/log volumes: - name: fluentconfig configMap: name: fluentd-conf - name: varlog hostPath: path: /var/log \u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 fluentd-config \u8fd9\u4e2a ConfigMap \u5bf9\u8c61\u901a\u8fc7 volumes \u6302\u8f7d\u5230\u4e86 Fluentd \u5bb9\u5668\u4e2d\uff0c\u53e6\u5916\u4e3a\u4e86\u80fd\u591f\u7075\u6d3b\u63a7\u5236\u54ea\u4e9b\u8282\u70b9\u7684\u65e5\u5fd7\u53ef\u4ee5\u88ab\u6536\u96c6\uff0c\u8fd8\u53ef\u4ee5\u6dfb\u52a0\u4e86\u4e00\u4e2a nodSelector \u5c5e\u6027\uff1a nodeSelector: beta.kubernetes.io/fluentd-ds-ready: \"true\" \u610f\u601d\u5c31\u662f\u8981\u60f3\u91c7\u96c6\u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u7ed9\u8282\u70b9\u6253\u4e0a\u4e0a\u9762\u7684\u6807\u7b7e\u3002 \u63d0\u793a \u5982\u679c\u4f60\u9700\u8981\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u7ed9\u5bf9\u5e94\u8282\u70b9\u6253\u4e0a\u6807\u7b7e\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a kubectl label nodes node\u540d beta.kubernetes.io/fluentd-ds-ready=true \u3002 \u53e6\u5916\u7531\u4e8e\u6211\u4eec\u7684\u96c6\u7fa4\u4f7f\u7528\u7684\u662f kubeadm \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b master \u8282\u70b9\u6709\u6c61\u70b9\uff0c\u6240\u4ee5\u5982\u679c\u8981\u60f3\u4e5f\u6536\u96c6 master \u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u6dfb\u52a0\u4e0a\u5bb9\u5fcd\uff1a tolerations: - operator: Exists \u5206\u522b\u521b\u5efa\u4e0a\u9762\u7684 ConfigMap \u5bf9\u8c61\u548c DaemonSet\uff1a $ kubectl create -f fluentd-configmap.yaml configmap \"fluentd-conf\" created $ kubectl create -f fluentd-daemonset.yaml serviceaccount \"fluentd-es\" created clusterrole.rbac.authorization.k8s.io \"fluentd-es\" created clusterrolebinding.rbac.authorization.k8s.io \"fluentd-es\" created daemonset.apps \"fluentd\" created \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b\u5bf9\u5e94\u7684 Pods \u5217\u8868\uff0c\u68c0\u67e5\u662f\u5426\u90e8\u7f72\u6210\u529f\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE elasticsearch-client-0 1/1 Running 0 64m elasticsearch-data-0 1/1 Running 0 65m elasticsearch-master-0 1/1 Running 0 73m fluentd-5rqbq 1/1 Running 0 60m fluentd-l6mgf 1/1 Running 0 60m fluentd-xmfpg 1/1 Running 0 60m kibana-66f97964b-mdspc 1/1 Running 0 63m Fluentd \u542f\u52a8\u6210\u529f\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u53d1\u9001\u65e5\u5fd7\u5230 ES \u4e86\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u8fc7\u6ee4\u4e86\u53ea\u91c7\u96c6\u5177\u6709 logging=true \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u6240\u4ee5\u73b0\u5728\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u4f1a\u88ab\u91c7\u96c6\u3002 \u4e0b\u9762\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u5e94\u7528\uff0c \u65b0\u5efa counter.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: v1 kind: Pod metadata: name: counter labels: logging: \"true\" # \u4e00\u5b9a\u8981\u5177\u6709\u8be5\u6807\u7b7e\u624d\u4f1a\u88ab\u91c7\u96c6 spec: containers: - name: count image: busybox args: [ /bin/sh, -c, 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done', ] \u8be5 Pod \u53ea\u662f\u7b80\u5355\u5c06\u65e5\u5fd7\u4fe1\u606f\u6253\u5370\u5230 stdout \uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4 Fluentd \u4f1a\u6536\u96c6\u5230\u8fd9\u4e2a\u65e5\u5fd7\u6570\u636e\uff0c\u5728 Kibana \u4e2d\u4e5f\u5c31\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u4f7f\u7528 kubectl \u5de5\u5177\u521b\u5efa\u8be5 Pod\uff1a $ kubectl create -f counter.yaml $ kubectl get pods NAME READY STATUS RESTARTS AGE counter 1/1 Running 0 9h Pod \u521b\u5efa\u5e76\u8fd0\u884c\u540e\uff0c\u56de\u5230 Kibana Dashboard \u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7\u6700\u4e0b\u9762\u7684 Management -> Stack Management \uff0c\u8fdb\u5165\u7ba1\u7406\u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7 Kibana \u4e0b\u9762\u7684 \u7d22\u5f15\u6a21\u5f0f \uff0c\u70b9\u51fb \u521b\u5efa\u7d22\u5f15\u6a21\u5f0f \u5f00\u59cb\u5bfc\u5165\u7d22\u5f15\u6570\u636e\uff1a \u5728\u8fd9\u91cc\u53ef\u4ee5\u914d\u7f6e\u6211\u4eec\u9700\u8981\u7684 Elasticsearch \u7d22\u5f15\uff0c\u524d\u9762 Fluentd \u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u4f7f\u7528\u7684\u662f logstash \u683c\u5f0f\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a k8s \u7684\u524d\u7f00\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981\u5728\u6587\u672c\u6846\u4e2d\u8f93\u5165 k8s-* \u5373\u53ef\u5339\u914d\u5230 Elasticsearch \u96c6\u7fa4\u4e2d\u91c7\u96c6\u7684 Kubernetes \u96c6\u7fa4\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u4e00\u6b65\uff0c\u8fdb\u5165\u4ee5\u4e0b\u9875\u9762\uff1a \u5728\u8be5\u9875\u9762\u4e2d\u914d\u7f6e\u4f7f\u7528\u54ea\u4e2a\u5b57\u6bb5\u6309\u65f6\u95f4\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u5728\u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9 @timestamp \u5b57\u6bb5\uff0c\u7136\u540e\u70b9\u51fb \u521b\u5efa\u7d22\u5f15\u6a21\u5f0f \uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u5de6\u4fa7\u5bfc\u822a\u83dc\u5355\u4e2d\u7684 Discover \uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76f4\u65b9\u56fe\u548c\u6700\u8fd1\u91c7\u96c6\u5230\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a \u73b0\u5728\u7684\u6570\u636e\u5c31\u662f\u4e0a\u9762 Counter \u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u679c\u8fd8\u6709\u5176\u4ed6\u7684\u5e94\u7528\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u7b5b\u9009\u8fc7\u6ee4\uff1a \u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u5143\u6570\u636e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u6bd4\u5982\u60a8\u53ef\u4ee5\u5355\u51fb\u4efb\u4f55\u65e5\u5fd7\u6761\u76ee\u4ee5\u67e5\u770b\u5176\u4ed6\u5143\u6570\u636e\uff0c\u5982\u5bb9\u5668\u540d\u79f0\uff0cKubernetes \u8282\u70b9\uff0c\u547d\u540d\u7a7a\u95f4\u7b49\u3002 \u5b89\u88c5 Kafka \u00b6 \u5bf9\u4e8e\u5927\u89c4\u6a21\u96c6\u7fa4\u6765\u8bf4\uff0c\u65e5\u5fd7\u6570\u636e\u91cf\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u5982\u679c\u76f4\u63a5\u901a\u8fc7 Fluentd \u5c06\u65e5\u5fd7\u6253\u5165 Elasticsearch\uff0c\u5bf9 ES \u6765\u8bf4\u538b\u529b\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e2d\u95f4\u52a0\u4e00\u5c42\u6d88\u606f\u4e2d\u95f4\u4ef6\u6765\u7f13\u89e3 ES \u7684\u538b\u529b\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u4f7f\u7528 Kafka\uff0c\u7136\u540e\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 kafka-connect-elasticsearch \u8fd9\u6837\u7684\u5de5\u5177\u5c06\u6570\u636e\u76f4\u63a5\u6253\u5165 ES\uff0c\u4e5f\u53ef\u4ee5\u5728\u52a0\u4e00\u5c42 Logstash \u53bb\u6d88\u8d39 Kafka \u7684\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7 Logstash \u628a\u6570\u636e\u5b58\u5165 ES\uff0c\u8fd9\u91cc\u6211\u4eec\u6765\u4f7f\u7528 Logstash \u8fd9\u79cd\u6a21\u5f0f\u6765\u5bf9\u65e5\u5fd7\u6536\u96c6\u8fdb\u884c\u4f18\u5316\u3002 \u9996\u5148\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 Kafka\uff0c\u540c\u6837\u8fd9\u91cc\u4f7f\u7528 Helm \u8fdb\u884c\u5b89\u88c5\uff1a $ helm repo add bitnami https://charts.bitnami.com/bitnami $ helm repo update \u9996\u5148\u4f7f\u7528 helm pull \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a $ helm pull bitnami/kafka --untar --version 17.2.3 $ cd kafka \u8fd9\u91cc\u9762\u6211\u4eec\u6307\u5b9a\u4f7f\u7528\u4e00\u4e2a StorageClass \u6765\u63d0\u4f9b\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5728 Chart \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 values \u6587\u4ef6\uff1a # values-prod.yaml ## @section Persistence parameters persistence: enabled: true storageClass: \"local-path\" accessModes: - ReadWriteOnce size: 8Gi mountPath: /bitnami/kafka # \u914d\u7f6ezk volumes zookeeper: enabled: true persistence: enabled: true storageClass: \"local-path\" accessModes: - ReadWriteOnce size: 8Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 kafka\uff1a $ helm upgrade --install kafka -f values-prod.yaml --namespace logging . Release \"kafka\" does not exist. Installing it now. NAME: kafka LAST DEPLOYED: Thu Jun 9 14:02:01 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: CHART NAME: kafka CHART VERSION: 17.2.3 APP VERSION: 3.2.0 ** Please be patient while the chart is being deployed ** Kafka can be accessed by consumers via port 9092 on the following DNS name from within your cluster: kafka.logging.svc.cluster.local Each Kafka broker can be accessed by producers via port 9092 on the following DNS name(s) from within your cluster: kafka-0.kafka-headless.logging.svc.cluster.local:9092 To create a pod that you can use as a Kafka client run the following commands: kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:3.2.0-debian-10-r4 --namespace logging --command -- sleep infinity kubectl exec --tty -i kafka-client --namespace logging -- bash PRODUCER: kafka-console-producer.sh \\ --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 \\ --topic test CONSUMER: kafka-console-consumer.sh \\ --bootstrap-server kafka.logging.svc.cluster.local:9092 \\ --topic test \\ --from-beginning \u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u63d0\u793a\u6765\u68c0\u67e5 Kafka \u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/instance=kafka kafka-0 1/1 Running 0 7m58s kafka-zookeeper-0 1/1 Running 0 7m58s \u7528\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a Kafka \u7684\u6d4b\u8bd5\u5ba2\u6237\u7aef Pod\uff1a $ kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:3.2.0-debian-10-r4 --namespace logging --command -- sleep infinity pod/kafka-client created \u7136\u540e\u542f\u52a8\u4e00\u4e2a\u7ec8\u7aef\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\u751f\u4ea7\u6d88\u606f\uff1a # \u751f\u4ea7\u8005 $ kubectl exec --tty -i kafka-client --namespace logging -- bash I have no name!@kafka-client:/$ kafka-console-producer.sh --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 --topic test >hello kafka on k8s > \u542f\u52a8\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\u6d88\u8d39\u6d88\u606f\uff1a # \u6d88\u8d39\u8005 $ kubectl exec --tty -i kafka-client --namespace logging -- bash I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic test --from-beginning hello kafka on k8s \u5982\u679c\u5728\u6d88\u8d39\u7aef\u770b\u5230\u4e86\u751f\u4ea7\u7684\u6d88\u606f\u6570\u636e\u8bc1\u660e\u6211\u4eec\u7684 Kafka \u5df2\u7ecf\u8fd0\u884c\u6210\u529f\u4e86\u3002 Fluentd \u914d\u7f6e Kafka \u00b6 \u73b0\u5728\u6709\u4e86 Kafka\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06 Fluentd \u7684\u65e5\u5fd7\u6570\u636e\u8f93\u51fa\u5230 Kafka \u4e86\uff0c\u53ea\u9700\u8981\u5c06 Fluentd \u914d\u7f6e\u4e2d\u7684 <match> \u66f4\u6539\u4e3a\u4f7f\u7528 Kafka \u63d2\u4ef6\u5373\u53ef\uff0c\u4f46\u662f\u5728 Fluentd \u4e2d\u8f93\u51fa\u5230 Kafka\uff0c\u9700\u8981\u4f7f\u7528\u5230 fluent-plugin-kafka \u63d2\u4ef6\uff0c\u6240\u4ee5\u9700\u8981\u6211\u4eec\u81ea\u5b9a\u4e49\u4e0b Docker \u955c\u50cf\uff0c\u6700\u7b80\u5355\u7684\u505a\u6cd5\u5c31\u662f\u5728\u4e0a\u9762 Fluentd \u955c\u50cf\u7684\u57fa\u7840\u4e0a\u65b0\u589e kafka \u63d2\u4ef6\u5373\u53ef\uff0cDockerfile \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a FROM quay.io/fluentd_elasticsearch/fluentd:v3.4.0 RUN echo \"source 'https://mirrors.tuna.tsinghua.edu.cn/rubygems/'\" > Gemfile && gem install bundler RUN gem install fluent-plugin-kafka -v 0.17.5 --no-document \u4f7f\u7528\u4e0a\u9762\u7684 Dockerfile \u6587\u4ef6\u6784\u5efa\u4e00\u4e2a Docker \u955c\u50cf\u5373\u53ef\uff0c\u6211\u8fd9\u91cc\u6784\u5efa\u8fc7\u540e\u7684\u955c\u50cf\u540d\u4e3a cnych/fluentd-kafka:v0.17.5 \u3002\u63a5\u4e0b\u6765\u66ff\u6362 Fluentd \u7684 Configmap \u5bf9\u8c61\u4e2d\u7684 <match> \u90e8\u5206\uff0c\u5982\u4e0b\u6240\u793a\uff1a # fluentd-configmap.yaml kind: ConfigMap apiVersion: v1 metadata: name: fluentd-conf namespace: logging data: ...... output.conf: |- <match **> @id kafka @type kafka2 @log_level info # list of seed brokers brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092 use_event_time true # topic settings topic_key k8slog default_topic messages # \u6ce8\u610f\uff0ckafka\u4e2d\u6d88\u8d39\u4f7f\u7528\u7684\u662f\u8fd9\u4e2atopic # buffer settings <buffer k8slog> @type file path /var/log/td-agent/buffer/td flush_interval 3s </buffer> # data type settings <format> @type json </format> # producer settings required_acks -1 compression_codec gzip </match> \u7136\u540e\u66ff\u6362\u8fd0\u884c\u7684 Fluentd \u955c\u50cf\uff1a # fluentd-daemonset.yaml image: cnych/fluentd-kafka:v0.17.5 \u76f4\u63a5\u66f4\u65b0 Fluentd \u7684 Configmap \u4e0e DaemonSet \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a $ kubectl apply -f fluentd-configmap.yaml $ kubectl apply -f fluentd-daemonset.yaml \u66f4\u65b0\u6210\u529f\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u6d4b\u8bd5 Kafka \u5ba2\u6237\u7aef\u6765\u9a8c\u8bc1\u662f\u5426\u6709\u65e5\u5fd7\u6570\u636e\uff1a $ kubectl exec --tty -i kafka-client --namespace logging -- bash I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic messages --from-beginning {\"stream\":\"stdout\",\"docker\":{},\"kubernetes\":{\"container_name\":\"count\",\"namespace_name\":\"default\",\"pod_name\":\"counter\",\"container_image\":\"busybox:latest\",\"host\":\"node1\",\"labels\":{\"logging\":\"true\"}},\"message\":\"43883: Tue Apr 27 12:16:30 UTC 2021\\n\"} ...... \u5b89\u88c5 Logstash \u00b6 \u867d\u7136\u6570\u636e\u4ece Kafka \u5230 Elasticsearch \u7684\u65b9\u5f0f\u591a\u79cd\u591a\u6837\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f7f\u7528 Kafka Connect Elasticsearch Connector \u6765\u5b9e\u73b0\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u66f4\u52a0\u6d41\u884c\u7684 `Logstash`` \u65b9\u6848\uff0c\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u65e5\u5fd7\u4ece Fluentd \u91c7\u96c6\u8f93\u51fa\u5230 Kafka \u4e2d\u53bb\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528 Logstash \u6765\u8fde\u63a5 Kafka \u4e0e Elasticsearch \u95f4\u7684\u65e5\u5fd7\u6570\u636e\u3002 \u9996\u5148\u4f7f\u7528 helm pull \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a $ helm pull elastic/logstash --untar --version 7.17.3 $ cd logstash \u540c\u6837\u5728 Chart \u6839\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 Values \u6587\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a # values-prod.yaml fullnameOverride: logstash persistence: enabled: true logstashConfig: logstash.yml: | http.host: 0.0.0.0 # \u5982\u679c\u542f\u7528\u4e86xpack\uff0c\u9700\u8981\u505a\u5982\u4e0b\u914d\u7f6e xpack.monitoring.enabled: true xpack.monitoring.elasticsearch.hosts: [\"http://elasticsearch-client:9200\"] xpack.monitoring.elasticsearch.username: \"elastic\" xpack.monitoring.elasticsearch.password: \"ydzsio321\" # \u8981\u6ce8\u610f\u4e0b\u683c\u5f0f logstashPipeline: logstash.conf: | input { kafka { bootstrap_servers => \"kafka-0.kafka-headless.logging.svc.cluster.local:9092\" codec => json consumer_threads => 3 topics => [\"messages\"] } } filter {} # \u8fc7\u6ee4\u914d\u7f6e\uff08\u6bd4\u5982\u53ef\u4ee5\u5220\u9664key\u3001\u6dfb\u52a0geoip\u7b49\u7b49\uff09 output { elasticsearch { hosts => [ \"elasticsearch-client:9200\" ] user => \"elastic\" password => \"ydzsio321\" index => \"logstash-k8s-%{+YYYY.MM.dd}\" } stdout { codec => rubydebug } } volumeClaimTemplate: accessModes: [\"ReadWriteOnce\"] storageClassName: nfs-storage resources: requests: storage: 1Gi \u5176\u4e2d\u6700\u91cd\u8981\u7684\u5c31\u662f\u901a\u8fc7 logstashPipeline \u914d\u7f6e logstash \u6570\u636e\u6d41\u7684\u5904\u7406\u914d\u7f6e\uff0c\u901a\u8fc7 input \u6307\u5b9a\u65e5\u5fd7\u6e90 kafka \u7684\u914d\u7f6e\uff0c\u901a\u8fc7 output \u8f93\u51fa\u5230 Elasticsearch\uff0c\u540c\u6837\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 Values \u6587\u4ef6\u5b89\u88c5 logstash \u5373\u53ef\uff1a $ helm upgrade --install logstash -f values-prod.yaml --namespace logging . Release \"logstash\" does not exist. Installing it now. NAME: logstash LAST DEPLOYED: Thu Jun 9 15:02:49 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: 1. Watch all cluster members come up. $ kubectl get pods --namespace=logging -l app=logstash -w \u5b89\u88c5\u542f\u52a8\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b logstash \u7684\u65e5\u5fd7\uff1a $ logstash kubectl get pods --namespace=logging -l app=logstash NAME READY STATUS RESTARTS AGE logstash-0 1/1 Running 0 2m8s $ kubectl logs -f logstash-0 -n logging ...... { \"@version\" => \"1\", \"stream\" => \"stdout\", \"@timestamp\" => 2022-06-09T07:09:16.889Z, \"message\" => \"4672: Thu Jun 9 07:09:15 UTC 2022\", \"kubernetes\" => { \"container_image\" => \"docker.io/library/busybox:latest\", \"container_name\" => \"count\", \"labels\" => { \"logging\" => \"true\" }, \"pod_name\" => \"counter\", \"namespace_name\" => \"default\", \"pod_ip\" => \"10.244.2.118\", \"host\" => \"node2\", \"namespace_labels\" => { \"kubernetes_io/metadata_name\" => \"default\" } }, \"docker\" => {} } \u7531\u4e8e\u6211\u4eec\u542f\u7528\u4e86 debug \u65e5\u5fd7\u8c03\u8bd5\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728 logstash \u7684\u65e5\u5fd7\u4e2d\u770b\u5230\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u6d88\u606f\uff0c\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684\u65e5\u5fd7\u6570\u636e\u5c31\u83b7\u53d6\u6210\u529f\u4e86\u3002 \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u767b\u5f55\u5230 Kibana \u53ef\u4ee5\u770b\u5230\u6709\u5982\u4e0b\u6240\u793a\u7684\u7d22\u5f15\u6570\u636e\u4e86\uff1a \u7136\u540e\u540c\u6837\u521b\u5efa\u7d22\u5f15\u6a21\u5f0f\uff0c\u5339\u914d\u4e0a\u9762\u7684\u7d22\u5f15\u5373\u53ef\uff1a \u521b\u5efa\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u524d\u5f80\u53d1\u73b0\u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\u4e86\uff1a \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86\u4e00\u4e2a\u4f7f\u7528 Fluentd+Kafka+Logstash+Elasticsearch+Kibana \u7684 Kubernetes \u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u6808\uff0c\u8fd9\u91cc\u6211\u4eec\u5b8c\u6574\u7684 Pod \u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE elasticsearch-client-0 1/1 Running 0 128m elasticsearch-data-0 1/1 Running 0 128m elasticsearch-master-0 1/1 Running 0 128m fluentd-6k52h 1/1 Running 0 61m fluentd-cw72c 1/1 Running 0 61m fluentd-dn4hs 1/1 Running 0 61m kafka-0 1/1 Running 3 134m kafka-client 1/1 Running 0 125m kafka-zookeeper-0 1/1 Running 0 134m kibana-kibana-66f97964b-qqjgg 1/1 Running 0 128m logstash-0 1/1 Running 0 13m \u5f53\u7136\u5728\u5b9e\u9645\u7684\u5de5\u4f5c\u9879\u76ee\u4e2d\u8fd8\u9700\u8981\u6211\u4eec\u6839\u636e\u5b9e\u9645\u7684\u4e1a\u52a1\u573a\u666f\u6765\u8fdb\u884c\u53c2\u6570\u6027\u80fd\u8c03\u4f18\u4ee5\u53ca\u9ad8\u53ef\u7528\u7b49\u8bbe\u7f6e\uff0c\u4ee5\u8fbe\u5230\u7cfb\u7edf\u7684\u6700\u4f18\u6027\u80fd\u3002 \u4e0a\u9762\u6211\u4eec\u5728\u914d\u7f6e logstash \u7684\u65f6\u5019\u662f\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230 \"logstash-k8s-%{+YYYY.MM.dd}\" \u8fd9\u4e2a\u7d22\u5f15\u6a21\u5f0f\u7684\uff0c\u53ef\u80fd\u6709\u7684\u573a\u666f\u4e0b\u53ea\u901a\u8fc7\u65e5\u671f\u53bb\u533a\u5206\u7d22\u5f15\u4e0d\u662f\u5f88\u5408\u7406\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u53bb\u4fee\u6539\u7d22\u5f15\u540d\u79f0\uff0c\u6bd4\u5982\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u670d\u52a1\u540d\u79f0\u6765\u8fdb\u884c\u533a\u5206\uff0c\u90a3\u4e48\u8fd9\u4e2a\u670d\u52a1\u540d\u79f0\u53ef\u4ee5\u600e\u4e48\u6765\u5b9a\u4e49\u5462\uff1f\u53ef\u4ee5\u662f Pod \u7684\u540d\u79f0\u6216\u8005\u901a\u8fc7 label \u6807\u7b7e\u53bb\u6307\u5b9a\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u53bb\u505a\u4e00\u4e2a\u89c4\u8303\uff0c\u8981\u6c42\u9700\u8981\u6536\u96c6\u65e5\u5fd7\u7684 Pod \u9664\u4e86\u9700\u8981\u6dfb\u52a0 logging: true \u8fd9\u4e2a\u6807\u7b7e\u4e4b\u5916\uff0c\u8fd8\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a logIndex: <\u7d22\u5f15\u540d> \u7684\u6807\u7b7e\u3002 \u6bd4\u5982\u91cd\u65b0\u66f4\u65b0\u6211\u4eec\u6d4b\u8bd5\u7684 counter \u5e94\u7528\uff1a apiVersion: v1 kind: Pod metadata: name: counter labels: logging: \"true\" # \u4e00\u5b9a\u8981\u5177\u6709\u8be5\u6807\u7b7e\u624d\u4f1a\u88ab\u91c7\u96c6 logIndex: \"test\" # \u6307\u5b9a\u7d22\u5f15\u540d\u79f0 spec: containers: - name: count image: busybox args: [ /bin/sh, -c, 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done', ] \u7136\u540e\u91cd\u65b0\u66f4\u65b0 logstash \u7684\u914d\u7f6e\uff0c\u4fee\u6539 values \u914d\u7f6e\uff1a # ...... logstashPipeline: logstash.conf: | input { kafka { bootstrap_servers => \"kafka-0.kafka-headless.logging.svc.cluster.local:9092\" codec => json consumer_threads => 3 topics => [\"messages\"] } } filter {} # \u8fc7\u6ee4\u914d\u7f6e\uff08\u6bd4\u5982\u53ef\u4ee5\u5220\u9664key\u3001\u6dfb\u52a0geoip\u7b49\u7b49\uff09 output { elasticsearch { hosts => [ \"elasticsearch-client:9200\" ] user => \"elastic\" password => \"ydzsio321\" index => \"k8s-%{[kubernetes][labels][logIndex]}-%{+YYYY.MM.dd}\" } stdout { codec => rubydebug } } # ...... \u4f7f\u7528\u4e0a\u9762\u7684 values \u503c\u66f4\u65b0 logstash\uff0c\u6b63\u5e38\u66f4\u65b0\u540e\u4e0a\u9762\u7684 counter \u8fd9\u4e2a Pod \u65e5\u5fd7\u4f1a\u8f93\u51fa\u5230\u4e00\u4e2a\u540d\u4e3a k8s-test-2022.06.09 \u7684\u7d22\u5f15\u53bb\u3002 \u8fd9\u6837\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86\u81ea\u5b9a\u4e49\u7d22\u5f15\u540d\u79f0\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Pod \u540d\u79f0\u3001\u5bb9\u5668\u540d\u79f0\u3001\u547d\u540d\u7a7a\u95f4\u540d\u79f0\u6765\u4f5c\u4e3a\u7d22\u5f15\u7684\u540d\u79f0\uff0c\u8fd9\u5b8c\u5168\u53d6\u51b3\u4e8e\u4f60\u81ea\u5df1\u7684\u9700\u6c42\u3002","title":"kubernetes EFK\u65e5\u5fd7\u7cfb\u7edf"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#efk","text":"","title":"\u642d\u5efa EFK \u65e5\u5fd7\u7cfb\u7edf"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#efk_1","text":"\u524d\u9762\u5927\u5bb6\u4ecb\u7ecd\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u51e0\u79cd\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\uff0cKubernetes \u4e2d\u6bd4\u8f83\u6d41\u884c\u7684\u65e5\u5fd7\u6536\u96c6\u89e3\u51b3\u65b9\u6848\u662f Elasticsearch\u3001Fluentd \u548c Kibana\uff08EFK\uff09\u6280\u672f\u6808\uff0c\u4e5f\u662f\u5b98\u65b9\u73b0\u5728\u6bd4\u8f83\u63a8\u8350\u7684\u4e00\u79cd\u65b9\u6848\u3002 Elasticsearch \u662f\u4e00\u4e2a\u5b9e\u65f6\u7684\u3001\u5206\u5e03\u5f0f\u7684\u53ef\u6269\u5c55\u7684\u641c\u7d22\u5f15\u64ce\uff0c\u5141\u8bb8\u8fdb\u884c\u5168\u6587\u3001\u7ed3\u6784\u5316\u641c\u7d22\uff0c\u5b83\u901a\u5e38\u7528\u4e8e\u7d22\u5f15\u548c\u641c\u7d22\u5927\u91cf\u65e5\u5fd7\u6570\u636e\uff0c\u4e5f\u53ef\u7528\u4e8e\u641c\u7d22\u8bb8\u591a\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u6863\u3002 Elasticsearch \u901a\u5e38\u4e0e Kibana \u4e00\u8d77\u90e8\u7f72\uff0cKibana \u662f Elasticsearch \u7684\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6570\u636e\u53ef\u89c6\u5316 Dashboard\uff0cKibana \u5141\u8bb8\u4f60\u901a\u8fc7 web \u754c\u9762\u6765\u6d4f\u89c8 Elasticsearch \u65e5\u5fd7\u6570\u636e\u3002 Fluentd \u662f\u4e00\u4e2a\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u6536\u96c6\u5668\uff0c\u6211\u4eec\u5c06\u5728 Kubernetes \u96c6\u7fa4\u8282\u70b9\u4e0a\u5b89\u88c5 Fluentd\uff0c\u901a\u8fc7\u83b7\u53d6\u5bb9\u5668\u65e5\u5fd7\u6587\u4ef6\u3001\u8fc7\u6ee4\u548c\u8f6c\u6362\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u5c06\u6570\u636e\u4f20\u9012\u5230 Elasticsearch \u96c6\u7fa4\uff0c\u5728\u8be5\u96c6\u7fa4\u4e2d\u5bf9\u5176\u8fdb\u884c\u7d22\u5f15\u548c\u5b58\u50a8\u3002 \u6211\u4eec\u5148\u6765\u914d\u7f6e\u542f\u52a8\u4e00\u4e2a\u53ef\u6269\u5c55\u7684 Elasticsearch \u96c6\u7fa4\uff0c\u7136\u540e\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Kibana \u5e94\u7528\uff0c\u6700\u540e\u901a\u8fc7 DaemonSet \u6765\u8fd0\u884c Fluentd\uff0c\u4ee5\u4fbf\u5b83\u5728\u6bcf\u4e2a Kubernetes \u5de5\u4f5c\u8282\u70b9\u4e0a\u90fd\u53ef\u4ee5\u8fd0\u884c\u4e00\u4e2a Pod\u3002","title":"\u642d\u5efa EFK \u65e5\u5fd7\u7cfb\u7edf"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#elasticsearch","text":"\u5728\u521b\u5efa Elasticsearch \u96c6\u7fa4\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u6211\u4eec\u5c06\u5728\u5176\u4e2d\u5b89\u88c5\u6240\u6709\u65e5\u5fd7\u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\u3002 $ kubectl create ns logging","title":"\u5b89\u88c5 Elasticsearch \u96c6\u7fa4"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_1","text":"ElasticSearch \u5b89\u88c5\u6709\u6700\u4f4e\u5b89\u88c5\u8981\u6c42\uff0c\u5982\u679c\u5b89\u88c5\u540e Pod \u65e0\u6cd5\u6b63\u5e38\u542f\u52a8\uff0c\u8bf7\u68c0\u67e5\u662f\u5426\u7b26\u5408\u6700\u4f4e\u8981\u6c42\u7684\u914d\u7f6e\uff0c\u8981\u6c42\u5982\u4e0b\uff1a \u8fd9\u91cc\u6211\u4eec\u8981\u5b89\u88c5\u7684 ES \u96c6\u7fa4\u73af\u5883\u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a NFS \u7c7b\u578b\u7684 StorageClass \u6765\u505a\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5f53\u7136\u5982\u679c\u4f60\u662f\u7ebf\u4e0a\u73af\u5883\u5efa\u8bae\u4f7f\u7528 Local PV \u6216\u8005 Ceph RBD \u4e4b\u7c7b\u7684\u5b58\u50a8\u6765\u6301\u4e45\u5316 Elasticsearch \u7684\u6570\u636e\u3002 \u6b64\u5916\u7531\u4e8e ElasticSearch 7.x \u7248\u672c\u9ed8\u8ba4\u5b89\u88c5\u4e86 X-Pack \u63d2\u4ef6\uff0c\u5e76\u4e14\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u9700\u8981\u6211\u4eec\u914d\u7f6e\u4e00\u4e9b\u5b89\u5168\u8bc1\u4e66\u6587\u4ef6\u3002 1\u3001\u751f\u6210\u8bc1\u4e66\u6587\u4ef6 # \u8fd0\u884c\u5bb9\u5668\u751f\u6210\u8bc1\u4e66\uff0ccontainerd\u4e0b\u9762\u7528nerdctl $ mkdir -p elastic-certs $ nerdctl run --name elastic-certs -v elastic-certs:/app -it -w /app elasticsearch:7.17.3 /bin/sh -c \\ \"elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass '' && \\ elasticsearch-certutil cert --name security-master --dns \\ security-master --ca /app/elastic-stack-ca.p12 --pass '' --ca-pass '' --out /app/elastic-certificates.p12\" # \u5220\u9664\u5bb9\u5668 $ nerdctl rm -f elastic-certs # \u5c06 pcks12 \u4e2d\u7684\u4fe1\u606f\u5206\u79bb\u51fa\u6765\uff0c\u5199\u5165\u6587\u4ef6 $ cd elastic-certs && openssl pkcs12 -nodes -passin pass:'' -in elastic-certificates.p12 -out elastic-certificate.pem \u9700\u8981\u6ce8\u610f nerdctl \u5982\u679c\u662f v0.20.0 \u7248\u672c\uff0c\u9700\u8981\u66f4\u65b0 CNI \u63d2\u4ef6\u7248\u672c\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u9519\u8bef FATA[0000] failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: process_linux.go:545: container init caused: Running hook #0:: error running hook: exit status 1, stdout: , stderr: time=\"2022-06-06T16:37:03+08:00\" level=fatal msg=\"failed to call cni.Setup: plugin type=\\\"bridge\\\" failed (add): incompatible CNI versions; config is \\\"1.0.0\\\", plugin supports [\\\"0.1.0\\\" \\\"0.2.0\\\" \\\"0.3.0\\\" \\\"0.3.1\\\" \\\"0.4.0\\\"]\" \uff0c\u5c06 CNI \u63d2\u4ef6\u4ece https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz \u4e0b\u8f7d\u4e0b\u6765\u8986\u76d6 /opt/cni/bin \u76ee\u5f55\u5373\u53ef\u3002 2\u3001\u6dfb\u52a0\u8bc1\u4e66\u5230 Kubernetes # \u6dfb\u52a0\u8bc1\u4e66 $ kubectl create secret -n logging generic elastic-certs --from-file=elastic-certificates.p12 # \u8bbe\u7f6e\u96c6\u7fa4\u7528\u6237\u540d\u5bc6\u7801 $ kubectl create secret -n logging generic elastic-auth --from-literal=username=elastic --from-literal=password=ydzsio321","title":"\u73af\u5883\u51c6\u5907"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#es","text":"\u9996\u5148\u6dfb\u52a0 ELastic \u7684 Helm \u4ed3\u5e93\uff1a $ helm repo add elastic https://helm.elastic.co $ helm repo update ElaticSearch \u5b89\u88c5\u9700\u8981\u5b89\u88c5\u4e09\u6b21\uff0c\u5206\u522b\u5b89\u88c5 Master\u3001Data\u3001Client \u8282\u70b9\uff0cMaster \u8282\u70b9\u8d1f\u8d23\u96c6\u7fa4\u95f4\u7684\u7ba1\u7406\u5de5\u4f5c\uff1bData \u8282\u70b9\u8d1f\u8d23\u5b58\u50a8\u6570\u636e\uff1bClient \u8282\u70b9\u8d1f\u8d23\u4ee3\u7406 ElasticSearch Cluster \u96c6\u7fa4\uff0c\u8d1f\u8f7d\u5747\u8861\u3002 \u9996\u5148\u4f7f\u7528 helm pull \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a $ helm pull elastic/elasticsearch --untar --version 7.17.3 $ cd elasticsearch \u5728 Chart \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e Master \u8282\u70b9\u5b89\u88c5\u914d\u7f6e\u7684 values \u6587\u4ef6\uff1a # values-master.yaml ## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0 clusterName: \"elasticsearch\" ## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0 nodeGroup: \"master\" ## \u8bbe\u7f6e\u89d2\u8272 roles: master: \"true\" ingest: \"false\" data: \"false\" # ============\u955c\u50cf\u914d\u7f6e============ ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"elasticsearch\" imageTag: \"7.17.3\" imagePullPolicy: \"IfNotPresent\" ## \u526f\u672c\u6570 replicas: 3 # ============\u8d44\u6e90\u914d\u7f6e============ ## JVM \u914d\u7f6e\u53c2\u6570 esJavaOpts: \"-Xmx1g -Xms1g\" ## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u8981\u8bbe\u7f6e\u5927\u4e9b) resources: requests: cpu: \"2000m\" memory: \"2Gi\" limits: cpu: \"2000m\" memory: \"2Gi\" ## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e persistence: enabled: true ## \u5b58\u50a8\u6570\u636e\u5927\u5c0f\u914d\u7f6e volumeClaimTemplate: storageClassName: local-path accessModes: [\"ReadWriteOnce\"] resources: requests: storage: 5Gi # ============\u5b89\u5168\u914d\u7f6e============ ## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https protocol: http ## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs defaultMode: 0755 ## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml\u3001log4j2.properties ## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b ## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ============\u8c03\u5ea6\u914d\u7f6e============ ## \u8bbe\u7f6e\u8c03\u5ea6\u7b56\u7565 ## - hard\uff1a\u53ea\u6709\u5f53\u6709\u8db3\u591f\u7684\u8282\u70b9\u65f6 Pod \u624d\u4f1a\u88ab\u8c03\u5ea6\uff0c\u5e76\u4e14\u5b83\u4eec\u6c38\u8fdc\u4e0d\u4f1a\u51fa\u73b0\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a ## - soft\uff1a\u5c3d\u6700\u5927\u52aa\u529b\u8c03\u5ea6 antiAffinity: \"soft\" # tolerations: # - operator: \"Exists\" ##\u5bb9\u5fcd\u5168\u90e8\u6c61\u70b9 \u7136\u540e\u521b\u5efa\u7528\u4e8e Data \u8282\u70b9\u5b89\u88c5\u7684 values \u6587\u4ef6\uff1a # values-data.yaml # ============\u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0============ ## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0 clusterName: \"elasticsearch\" ## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0 nodeGroup: \"data\" ## \u8bbe\u7f6e\u89d2\u8272 roles: master: \"false\" ingest: \"true\" data: \"true\" # ============\u955c\u50cf\u914d\u7f6e============ ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"elasticsearch\" imageTag: \"7.17.3\" ## \u526f\u672c\u6570(\u5efa\u8bae\u8bbe\u7f6e\u4e3a3\uff0c\u6211\u8fd9\u91cc\u8d44\u6e90\u4e0d\u8db3\u53ea\u7528\u4e861\u4e2a\u526f\u672c) replicas: 3 # ============\u8d44\u6e90\u914d\u7f6e============ ## JVM \u914d\u7f6e\u53c2\u6570 esJavaOpts: \"-Xmx1g -Xms1g\" ## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u4e00\u5b9a\u8981\u8bbe\u7f6e\u5927\u4e9b) resources: requests: cpu: \"1000m\" memory: \"2Gi\" limits: cpu: \"1000m\" memory: \"2Gi\" ## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e persistence: enabled: true ## \u5b58\u50a8\u6570\u636e\u5927\u5c0f\u914d\u7f6e volumeClaimTemplate: storageClassName: local-path accessModes: [\"ReadWriteOnce\"] resources: requests: storage: 10Gi # ============\u5b89\u5168\u914d\u7f6e============ ## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https protocol: http ## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs ## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml ## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b ## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ============\u8c03\u5ea6\u914d\u7f6e============ ## \u8bbe\u7f6e\u8c03\u5ea6\u7b56\u7565 ## - hard\uff1a\u53ea\u6709\u5f53\u6709\u8db3\u591f\u7684\u8282\u70b9\u65f6 Pod \u624d\u4f1a\u88ab\u8c03\u5ea6\uff0c\u5e76\u4e14\u5b83\u4eec\u6c38\u8fdc\u4e0d\u4f1a\u51fa\u73b0\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a ## - soft\uff1a\u5c3d\u6700\u5927\u52aa\u529b\u8c03\u5ea6 antiAffinity: \"soft\" ## \u5bb9\u5fcd\u914d\u7f6e # tolerations: # - operator: \"Exists\" ##\u5bb9\u5fcd\u5168\u90e8\u6c61\u70b9 \u6700\u540e\u4e00\u4e2a\u662f\u7528\u4e8e\u521b\u5efa Client \u8282\u70b9\u7684 values \u6587\u4ef6\uff1a # values-client.yaml # ============\u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0============ ## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0 clusterName: \"elasticsearch\" ## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0 nodeGroup: \"client\" ## \u8bbe\u7f6e\u89d2\u8272 roles: master: \"false\" ingest: \"false\" data: \"false\" # ============\u955c\u50cf\u914d\u7f6e============ ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"elasticsearch\" imageTag: \"7.17.3\" ## \u526f\u672c\u6570 replicas: 1 # ============\u8d44\u6e90\u914d\u7f6e============ ## JVM \u914d\u7f6e\u53c2\u6570 esJavaOpts: \"-Xmx1g -Xms1g\" ## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u4e00\u5b9a\u8981\u8bbe\u7f6e\u5927\u4e9b) resources: requests: cpu: \"1000m\" memory: \"2Gi\" limits: cpu: \"1000m\" memory: \"2Gi\" ## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e persistence: enabled: false # ============\u5b89\u5168\u914d\u7f6e============ ## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https protocol: http ## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66 secretMounts: - name: elastic-certs secretName: elastic-certs path: /usr/share/elasticsearch/config/certs ## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml ## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b ## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https esConfig: elasticsearch.yml: | xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.enabled: true # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12 ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: ELASTIC_USERNAME valueFrom: secretKeyRef: name: elastic-auth key: username - name: ELASTIC_PASSWORD valueFrom: secretKeyRef: name: elastic-auth key: password # ============Service \u914d\u7f6e============ service: type: NodePort nodePort: \"30200\" \u73b0\u5728\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5\uff1a # \u5b89\u88c5 master \u8282\u70b9 $ helm upgrade --install es-master -f values-master.yaml --namespace logging . # \u5b89\u88c5 data \u8282\u70b9 $ helm upgrade --install es-data -f values-data.yaml --namespace logging . # \u5b89\u88c5 client \u8282\u70b9 $ helm upgrade --install es-client -f values-client.yaml --namespace logging . \u5728\u5b89\u88c5 Master \u8282\u70b9\u540e Pod \u542f\u52a8\u65f6\u5019\u4f1a\u629b\u51fa\u5f02\u5e38\uff0c\u5c31\u7eea\u63a2\u9488\u63a2\u6d3b\u5931\u8d25\uff0c\u8fd9\u662f\u4e2a\u6b63\u5e38\u73b0\u8c61\u3002\u5728\u6267\u884c\u5b89\u88c5 Data \u8282\u70b9\u540e Master \u8282\u70b9 Pod \u5c31\u4f1a\u6062\u590d\u6b63\u5e38\u3002","title":"\u5b89\u88c5 ES \u96c6\u7fa4"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#kibana","text":"Elasticsearch \u96c6\u7fa4\u5b89\u88c5\u5b8c\u6210\u540e\u63a5\u4e0b\u6765\u914d\u7f6e\u5b89\u88c5 Kibana \u4f7f\u7528 helm pull \u547d\u4ee4\u62c9\u53d6 Kibana Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull elastic/kibana --untar --version 7.17.3 $ cd kibana \u521b\u5efa\u7528\u4e8e\u5b89\u88c5 Kibana \u7684 values \u6587\u4ef6\uff1a # values-prod.yaml ## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c image: \"kibana\" imageTag: \"7.17.3\" ## \u914d\u7f6e ElasticSearch \u5730\u5740 elasticsearchHosts: \"http://elasticsearch-client:9200\" # ============\u73af\u5883\u53d8\u91cf\u914d\u7f6e============ ## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6 extraEnvs: - name: \"ELASTICSEARCH_USERNAME\" valueFrom: secretKeyRef: name: elastic-auth key: username - name: \"ELASTICSEARCH_PASSWORD\" valueFrom: secretKeyRef: name: elastic-auth key: password # ============\u8d44\u6e90\u914d\u7f6e============ resources: requests: cpu: \"500m\" memory: \"1Gi\" limits: cpu: \"500m\" memory: \"1Gi\" # ============\u914d\u7f6e Kibana \u53c2\u6570============ ## kibana \u914d\u7f6e\u4e2d\u6dfb\u52a0\u8bed\u8a00\u914d\u7f6e\uff0c\u8bbe\u7f6e kibana \u4e3a\u4e2d\u6587 kibanaConfig: kibana.yml: | i18n.locale: \"zh-CN\" # ============Service \u914d\u7f6e============ service: type: NodePort nodePort: \"30601\" \u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a $ helm install kibana -f values-prod.yaml --namespace logging . \u4e0b\u9762\u662f\u5b89\u88c5\u5b8c\u6210\u540e\u7684 ES \u96c6\u7fa4\u548c Kibana \u8d44\u6e90\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE elasticsearch-client-0 1/1 Running 0 9m25s elasticsearch-data-0 1/1 Running 0 9m33s elasticsearch-master-0 1/1 Running 0 8m29s kibana-kibana-79b9878cd7-7l75v 1/1 Running 0 6m12s $ kubectl get svc -n logging NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE elasticsearch-client NodePort 10.108.226.197 <none> 9200:30200/TCP,9300:32746/TCP 3m25s elasticsearch-client-headless ClusterIP None <none> 9200/TCP,9300/TCP 3m25s elasticsearch-data ClusterIP 10.104.121.49 <none> 9200/TCP,9300/TCP 3m33s elasticsearch-data-headless ClusterIP None <none> 9200/TCP,9300/TCP 3m33s elasticsearch-master ClusterIP 10.102.72.71 <none> 9200/TCP,9300/TCP 6m8s elasticsearch-master-headless ClusterIP None <none> 9200/TCP,9300/TCP 6m8s kibana-kibana NodePort 10.109.35.219 <none> 5601:30601/TCP 12s \u4e0a\u9762\u6211\u4eec\u5b89\u88c5 Kibana \u7684\u65f6\u5019\u6307\u5b9a\u4e86 30601 \u7684 NodePort \u7aef\u53e3\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4ece\u4efb\u610f\u8282\u70b9 http://IP:30601 \u6765\u8bbf\u95ee Kibana\u3002 \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f1a\u8df3\u8f6c\u5230\u767b\u5f55\u9875\u9762\uff0c\u8ba9\u6211\u4eec\u8f93\u51fa\u7528\u6237\u540d\u3001\u5bc6\u7801\uff0c\u8fd9\u91cc\u6211\u4eec\u8f93\u5165\u4e0a\u9762\u914d\u7f6e\u7684\u7528\u6237\u540d elastic \u3001\u5bc6\u7801 ydzsio321 \u8fdb\u884c\u767b\u5f55\u3002\u767b\u5f55\u6210\u529f\u540e\u8fdb\u5165\u5982\u4e0b\u6240\u793a\u7684 Kibana \u4e3b\u9875\uff1a","title":"\u5b89\u88c5 Kibana"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#fluentd","text":"Fluentd \u662f\u4e00\u4e2a\u9ad8\u6548\u7684\u65e5\u5fd7\u805a\u5408\u5668\uff0c\u662f\u7528 Ruby \u7f16\u5199\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u5f88\u597d\u5730\u6269\u5c55\u3002\u5bf9\u4e8e\u5927\u90e8\u5206\u4f01\u4e1a\u6765\u8bf4\uff0cFluentd \u8db3\u591f\u9ad8\u6548\u5e76\u4e14\u6d88\u8017\u7684\u8d44\u6e90\u76f8\u5bf9\u8f83\u5c11\uff0c\u53e6\u5916\u4e00\u4e2a\u5de5\u5177 Fluent-bit \u66f4\u8f7b\u91cf\u7ea7\uff0c\u5360\u7528\u8d44\u6e90\u66f4\u5c11\uff0c\u4f46\u662f\u63d2\u4ef6\u76f8\u5bf9 Fluentd \u6765\u8bf4\u4e0d\u591f\u4e30\u5bcc\uff0c\u6240\u4ee5\u6574\u4f53\u6765\u8bf4\uff0cFluentd \u66f4\u52a0\u6210\u719f\uff0c\u4f7f\u7528\u66f4\u52a0\u5e7f\u6cdb\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 Fluentd \u6765\u4f5c\u4e3a\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002","title":"\u90e8\u7f72 Fluentd"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_2","text":"Fluentd \u901a\u8fc7\u4e00\u7ec4\u7ed9\u5b9a\u7684\u6570\u636e\u6e90\u6293\u53d6\u65e5\u5fd7\u6570\u636e\uff0c\u5904\u7406\u540e\uff08\u8f6c\u6362\u6210\u7ed3\u6784\u5316\u7684\u6570\u636e\u683c\u5f0f\uff09\u5c06\u5b83\u4eec\u8f6c\u53d1\u7ed9\u5176\u4ed6\u670d\u52a1\uff0c\u6bd4\u5982 Elasticsearch\u3001\u5bf9\u8c61\u5b58\u50a8\u7b49\u7b49\u3002Fluentd \u652f\u6301\u8d85\u8fc7 300 \u4e2a\u65e5\u5fd7\u5b58\u50a8\u548c\u5206\u6790\u670d\u52a1\uff0c\u6240\u4ee5\u5728\u8fd9\u65b9\u9762\u662f\u975e\u5e38\u7075\u6d3b\u7684\u3002\u4e3b\u8981\u8fd0\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a \u9996\u5148 Fluentd \u4ece\u591a\u4e2a\u65e5\u5fd7\u6e90\u83b7\u53d6\u6570\u636e \u7ed3\u6784\u5316\u5e76\u4e14\u6807\u8bb0\u8fd9\u4e9b\u6570\u636e \u7136\u540e\u6839\u636e\u5339\u914d\u7684\u6807\u7b7e\u5c06\u6570\u636e\u53d1\u9001\u5230\u591a\u4e2a\u76ee\u6807\u670d\u52a1\u53bb","title":"\u5de5\u4f5c\u539f\u7406"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_3","text":"\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u662f\u901a\u8fc7\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u544a\u8bc9 Fluentd \u5982\u4f55\u91c7\u96c6\u3001\u5904\u7406\u6570\u636e\u7684\uff0c\u4e0b\u9762\u7b80\u5355\u548c\u5927\u5bb6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u65b9\u6cd5\u3002","title":"\u914d\u7f6e"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_4","text":"\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u6536\u96c6 Kubernetes \u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\uff0c\u5c31\u9700\u8981\u505a\u5982\u4e0b\u7684\u65e5\u5fd7\u6e90\u914d\u7f6e\uff1a <source> @id fluentd-containers.log @type tail # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\u3002 path /var/log/containers/*.log # \u6302\u8f7d\u7684\u5bbf\u4e3b\u673a\u5bb9\u5668\u65e5\u5fd7\u5730\u5740 pos_file /var/log/es-containers.log.pos tag raw.kubernetes.* # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e read_from_head true <parse> # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON @type multi_format # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6 <pattern> format json # JSON \u89e3\u6790\u5668 time_key time # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5 time_format %Y-%m-%dT%H:%M:%S.%NZ # \u65f6\u95f4\u683c\u5f0f </pattern> <pattern> format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z </pattern> </parse> </source> \u4e0a\u9762\u914d\u7f6e\u90e8\u5206\u53c2\u6570\u8bf4\u660e\u5982\u4e0b\uff1a id\uff1a\u8868\u793a\u5f15\u7528\u8be5\u65e5\u5fd7\u6e90\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u8be5\u6807\u8bc6\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u8def\u7531\u7ed3\u6784\u5316\u65e5\u5fd7\u6570\u636e type\uff1aFluentd \u5185\u7f6e\u7684\u6307\u4ee4\uff0c tail \u8868\u793a Fluentd \u4ece\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\u901a\u8fc7 tail \u4e0d\u65ad\u83b7\u53d6\u6570\u636e\uff0c\u53e6\u5916\u4e00\u4e2a\u662f http \u8868\u793a\u901a\u8fc7\u4e00\u4e2a GET \u8bf7\u6c42\u6765\u6536\u96c6\u6570\u636e\u3002 path\uff1a tail \u7c7b\u578b\u4e0b\u7684\u7279\u5b9a\u53c2\u6570\uff0c\u544a\u8bc9 Fluentd \u91c7\u96c6 /var/log/containers \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u65e5\u5fd7\uff0c\u8fd9\u662f docker \u5728 Kubernetes \u8282\u70b9\u4e0a\u7528\u6765\u5b58\u50a8\u8fd0\u884c\u5bb9\u5668 stdout \u8f93\u51fa\u65e5\u5fd7\u6570\u636e\u7684\u76ee\u5f55\u3002 pos_file\uff1a\u68c0\u67e5\u70b9\uff0c\u5982\u679c Fluentd \u7a0b\u5e8f\u91cd\u65b0\u542f\u52a8\u4e86\uff0c\u5b83\u5c06\u4f7f\u7528\u6b64\u6587\u4ef6\u4e2d\u7684\u4f4d\u7f6e\u6765\u6062\u590d\u65e5\u5fd7\u6570\u636e\u6536\u96c6\u3002 tag\uff1a\u7528\u6765\u5c06\u65e5\u5fd7\u6e90\u4e0e\u76ee\u6807\u6216\u8005\u8fc7\u6ee4\u5668\u5339\u914d\u7684\u81ea\u5b9a\u4e49\u5b57\u7b26\u4e32\uff0cFluentd \u5339\u914d\u6e90/\u76ee\u6807\u6807\u7b7e\u6765\u8def\u7531\u65e5\u5fd7\u6570\u636e\u3002","title":"\u65e5\u5fd7\u6e90\u914d\u7f6e"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_5","text":"\u4e0a\u9762\u662f\u65e5\u5fd7\u6e90\u7684\u914d\u7f6e\uff0c\u63a5\u4e0b\u6765\u770b\u770b\u5982\u4f55\u5c06\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230 Elasticsearch\uff1a <match **> @id elasticsearch @type elasticsearch @log_level info include_tag_key true type_name fluentd host \"#{ENV['OUTPUT_HOST']}\" port \"#{ENV['OUTPUT_PORT']}\" logstash_format true <buffer> @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size \"#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}\" queue_limit_length \"#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}\" overflow_action block </buffer> </match> match\uff1a\u6807\u8bc6\u4e00\u4e2a\u76ee\u6807\u6807\u7b7e\uff0c\u540e\u9762\u662f\u4e00\u4e2a\u5339\u914d\u65e5\u5fd7\u6e90\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u60f3\u8981\u6355\u83b7\u6240\u6709\u7684\u65e5\u5fd7\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u7ed9 Elasticsearch\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u6210 ** \u3002 id\uff1a\u76ee\u6807\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\u7b26\u3002 type\uff1a\u652f\u6301\u7684\u8f93\u51fa\u63d2\u4ef6\u6807\u8bc6\u7b26\uff0c\u6211\u4eec\u8fd9\u91cc\u8981\u8f93\u51fa\u5230 Elasticsearch\uff0c\u6240\u4ee5\u914d\u7f6e\u6210 elasticsearch\uff0c\u8fd9\u662f Fluentd \u7684\u4e00\u4e2a\u5185\u7f6e\u63d2\u4ef6\u3002 log_level\uff1a\u6307\u5b9a\u8981\u6355\u83b7\u7684\u65e5\u5fd7\u7ea7\u522b\uff0c\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u6210 info \uff0c\u8868\u793a\u4efb\u4f55\u8be5\u7ea7\u522b\u6216\u8005\u8be5\u7ea7\u522b\u4ee5\u4e0a\uff08INFO\u3001WARNING\u3001ERROR\uff09\u7684\u65e5\u5fd7\u90fd\u5c06\u88ab\u8def\u7531\u5230 Elsasticsearch\u3002 host/port\uff1a\u5b9a\u4e49 Elasticsearch \u7684\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u8ba4\u8bc1\u4fe1\u606f\uff0c\u6211\u4eec\u7684 Elasticsearch \u4e0d\u9700\u8981\u8ba4\u8bc1\uff0c\u6240\u4ee5\u8fd9\u91cc\u76f4\u63a5\u6307\u5b9a host \u548c port \u5373\u53ef\u3002 logstash_format\uff1aElasticsearch \u670d\u52a1\u5bf9\u65e5\u5fd7\u6570\u636e\u6784\u5efa\u53cd\u5411\u7d22\u5f15\u8fdb\u884c\u641c\u7d22\uff0c\u5c06 logstash_format \u8bbe\u7f6e\u4e3a true \uff0cFluentd \u5c06\u4f1a\u4ee5 logstash \u683c\u5f0f\u6765\u8f6c\u53d1\u7ed3\u6784\u5316\u7684\u65e5\u5fd7\u6570\u636e\u3002 Buffer\uff1a Fluentd \u5141\u8bb8\u5728\u76ee\u6807\u4e0d\u53ef\u7528\u65f6\u8fdb\u884c\u7f13\u5b58\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u7f51\u7edc\u51fa\u73b0\u6545\u969c\u6216\u8005 Elasticsearch \u4e0d\u53ef\u7528\u7684\u65f6\u5019\u3002\u7f13\u51b2\u533a\u914d\u7f6e\u4e5f\u6709\u52a9\u4e8e\u964d\u4f4e\u78c1\u76d8\u7684 IO\u3002","title":"\u8def\u7531\u914d\u7f6e"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_6","text":"\u7531\u4e8e Kubernetes \u96c6\u7fa4\u4e2d\u5e94\u7528\u592a\u591a\uff0c\u4e5f\u8fd8\u6709\u5f88\u591a\u5386\u53f2\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53ea\u5c06\u67d0\u4e9b\u5e94\u7528\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\uff0c\u6bd4\u5982\u6211\u4eec\u53ea\u91c7\u96c6\u5177\u6709 logging=true \u8fd9\u4e2a Label \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u4f7f\u7528 filter\uff0c\u5982\u4e0b\u6240\u793a\uff1a # \u5220\u9664\u65e0\u7528\u7684\u5c5e\u6027 <filter kubernetes.**> @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash </filter> # \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7 <filter kubernetes.**> @id filter_log @type grep <regexp> key $.kubernetes.labels.logging pattern ^true$ </regexp> </filter>","title":"\u8fc7\u6ee4"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#_7","text":"\u8981\u6536\u96c6 Kubernetes \u96c6\u7fa4\u7684\u65e5\u5fd7\uff0c\u76f4\u63a5\u7528 DasemonSet \u63a7\u5236\u5668\u6765\u90e8\u7f72 Fluentd \u5e94\u7528\uff0c\u8fd9\u6837\uff0c\u5b83\u5c31\u53ef\u4ee5\u4ece Kubernetes \u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u59cb\u7ec8\u8fd0\u884c\u4e00\u4e2a Fluentd \u5bb9\u5668\u3002\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Helm \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff0c\u4e3a\u4e86\u80fd\u591f\u4e86\u89e3\u66f4\u591a\u5b9e\u73b0\u7ec6\u8282\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u624b\u52a8\u65b9\u6cd5\u6765\u8fdb\u884c\u5b89\u88c5\u3002 \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b98\u65b9\u7684\u5bf9\u4e8e Kubernetes \u96c6\u7fa4\u7684\u5b89\u88c5\u6587\u6863: https://docs.fluentd.org/container-deployment/kubernetes \u3002 \u9996\u5148\uff0c\u6211\u4eec\u901a\u8fc7 ConfigMap \u5bf9\u8c61\u6765\u6307\u5b9a Fluentd \u914d\u7f6e\u6587\u4ef6\uff0c\u65b0\u5efa fluentd-configmap.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a # fluentd-configmap.yaml kind: ConfigMap apiVersion: v1 metadata: name: fluentd-conf namespace: logging data: # \u5bb9\u5668\u65e5\u5fd7 containers.input.conf: |- <source> @id fluentd-containers.log @type tail # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7 path /var/log/containers/*.log # Docker \u5bb9\u5668\u65e5\u5fd7\u8def\u5f84 pos_file /var/log/es-containers.log.pos # \u8bb0\u5f55\u8bfb\u53d6\u7684\u4f4d\u7f6e tag raw.kubernetes.* # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e read_from_head true # \u4ece\u5934\u8bfb\u53d6 <parse> # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON # \u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u4ecb\u7ecd\u8fc7\u7684 multiline \u63d2\u4ef6\u5b9e\u73b0\u591a\u884c\u65e5\u5fd7 @type multi_format # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6 <pattern> format json # JSON\u89e3\u6790\u5668 time_key time # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5 time_format %Y-%m-%dT%H:%M:%S.%NZ # \u65f6\u95f4\u683c\u5f0f </pattern> <pattern> format /^(?<time>.+) (?<stream>stdout|stderr) [^ ]* (?<log>.*)$/ time_format %Y-%m-%dT%H:%M:%S.%N%:z </pattern> </parse> </source> # \u5728\u65e5\u5fd7\u8f93\u51fa\u4e2d\u68c0\u6d4b\u5f02\u5e38(\u591a\u884c\u65e5\u5fd7)\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u4e00\u6761\u65e5\u5fd7\u8f6c\u53d1 # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions <match raw.kubernetes.**> # \u5339\u914dtag\u4e3araw.kubernetes.**\u65e5\u5fd7\u4fe1\u606f @id raw.kubernetes @type detect_exceptions # \u4f7f\u7528detect-exceptions\u63d2\u4ef6\u5904\u7406\u5f02\u5e38\u6808\u4fe1\u606f remove_tag_prefix raw # \u79fb\u9664 raw \u524d\u7f00 message log multiline_flush_interval 5 </match> <filter **> # \u62fc\u63a5\u65e5\u5fd7 @id filter_concat @type concat # Fluentd Filter \u63d2\u4ef6\uff0c\u7528\u4e8e\u8fde\u63a5\u591a\u4e2a\u65e5\u5fd7\u4e2d\u5206\u9694\u7684\u591a\u884c\u65e5\u5fd7 key message multiline_end_regexp /\\n$/ # \u4ee5\u6362\u884c\u7b26\u201c\\n\u201d\u62fc\u63a5 separator \"\" </filter> # \u6dfb\u52a0 Kubernetes metadata \u6570\u636e <filter kubernetes.**> @id filter_kubernetes_metadata @type kubernetes_metadata </filter> # \u4fee\u590d ES \u4e2d\u7684 JSON \u5b57\u6bb5 # \u63d2\u4ef6\u5730\u5740\uff1ahttps://github.com/repeatedly/fluent-plugin-multi-format-parser <filter kubernetes.**> @id filter_parser @type parser # multi-format-parser\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6 key_name log # \u5728\u8981\u89e3\u6790\u7684\u65e5\u5fd7\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0 reserve_data true # \u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9 remove_key_name_field true # key_name \u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5 <parse> @type multi_format <pattern> format json </pattern> <pattern> format none </pattern> </parse> </filter> # \u5220\u9664\u4e00\u4e9b\u591a\u4f59\u7684\u5c5e\u6027 <filter kubernetes.**> @type record_transformer remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash </filter> # \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7 <filter kubernetes.**> @id filter_log @type grep <regexp> key $.kubernetes.labels.logging pattern ^true$ </regexp> </filter> ###### \u76d1\u542c\u914d\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u65e5\u5fd7\u805a\u5408\u7528 ###### forward.input.conf: |- # \u76d1\u542c\u901a\u8fc7TCP\u53d1\u9001\u7684\u6d88\u606f <source> @id forward @type forward </source> output.conf: |- <match **> @id elasticsearch @type elasticsearch @log_level info include_tag_key true host elasticsearch-client port 9200 user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD password ydzsio321 logstash_format true logstash_prefix k8s request_timeout 30s <buffer> @type file path /var/log/fluentd-buffers/kubernetes.system.buffer flush_mode interval retry_type exponential_backoff flush_thread_count 2 flush_interval 5s retry_forever retry_max_interval 30 chunk_limit_size 2M queue_limit_length 8 overflow_action block </buffer> </match> \u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u53ea\u914d\u7f6e\u4e86 docker \u5bb9\u5668\u65e5\u5fd7\u76ee\u5f55\uff0c\u6536\u96c6\u5230\u6570\u636e\u7ecf\u8fc7\u5904\u7406\u540e\u53d1\u9001\u5230 elasticsearch-client:9200 \u670d\u52a1\u3002 \u7136\u540e\u65b0\u5efa\u4e00\u4e2a fluentd-daemonset.yaml \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: v1 kind: ServiceAccount metadata: name: fluentd-es namespace: logging labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile rules: - apiGroups: - \"\" resources: - \"namespaces\" - \"pods\" verbs: - \"get\" - \"watch\" - \"list\" --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: fluentd-es labels: k8s-app: fluentd-es kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile subjects: - kind: ServiceAccount name: fluentd-es namespace: logging apiGroup: \"\" roleRef: kind: ClusterRole name: fluentd-es apiGroup: \"\" --- apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd namespace: logging labels: app: fluentd kubernetes.io/cluster-service: \"true\" spec: selector: matchLabels: app: fluentd template: metadata: labels: app: fluentd kubernetes.io/cluster-service: \"true\" spec: tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule serviceAccountName: fluentd-es containers: - name: fluentd image: quay.io/fluentd_elasticsearch/fluentd:v3.4.0 volumeMounts: - name: fluentconfig mountPath: /etc/fluent/config.d - name: varlog mountPath: /var/log volumes: - name: fluentconfig configMap: name: fluentd-conf - name: varlog hostPath: path: /var/log \u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 fluentd-config \u8fd9\u4e2a ConfigMap \u5bf9\u8c61\u901a\u8fc7 volumes \u6302\u8f7d\u5230\u4e86 Fluentd \u5bb9\u5668\u4e2d\uff0c\u53e6\u5916\u4e3a\u4e86\u80fd\u591f\u7075\u6d3b\u63a7\u5236\u54ea\u4e9b\u8282\u70b9\u7684\u65e5\u5fd7\u53ef\u4ee5\u88ab\u6536\u96c6\uff0c\u8fd8\u53ef\u4ee5\u6dfb\u52a0\u4e86\u4e00\u4e2a nodSelector \u5c5e\u6027\uff1a nodeSelector: beta.kubernetes.io/fluentd-ds-ready: \"true\" \u610f\u601d\u5c31\u662f\u8981\u60f3\u91c7\u96c6\u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u7ed9\u8282\u70b9\u6253\u4e0a\u4e0a\u9762\u7684\u6807\u7b7e\u3002 \u63d0\u793a \u5982\u679c\u4f60\u9700\u8981\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u7ed9\u5bf9\u5e94\u8282\u70b9\u6253\u4e0a\u6807\u7b7e\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a kubectl label nodes node\u540d beta.kubernetes.io/fluentd-ds-ready=true \u3002 \u53e6\u5916\u7531\u4e8e\u6211\u4eec\u7684\u96c6\u7fa4\u4f7f\u7528\u7684\u662f kubeadm \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b master \u8282\u70b9\u6709\u6c61\u70b9\uff0c\u6240\u4ee5\u5982\u679c\u8981\u60f3\u4e5f\u6536\u96c6 master \u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u6dfb\u52a0\u4e0a\u5bb9\u5fcd\uff1a tolerations: - operator: Exists \u5206\u522b\u521b\u5efa\u4e0a\u9762\u7684 ConfigMap \u5bf9\u8c61\u548c DaemonSet\uff1a $ kubectl create -f fluentd-configmap.yaml configmap \"fluentd-conf\" created $ kubectl create -f fluentd-daemonset.yaml serviceaccount \"fluentd-es\" created clusterrole.rbac.authorization.k8s.io \"fluentd-es\" created clusterrolebinding.rbac.authorization.k8s.io \"fluentd-es\" created daemonset.apps \"fluentd\" created \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b\u5bf9\u5e94\u7684 Pods \u5217\u8868\uff0c\u68c0\u67e5\u662f\u5426\u90e8\u7f72\u6210\u529f\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE elasticsearch-client-0 1/1 Running 0 64m elasticsearch-data-0 1/1 Running 0 65m elasticsearch-master-0 1/1 Running 0 73m fluentd-5rqbq 1/1 Running 0 60m fluentd-l6mgf 1/1 Running 0 60m fluentd-xmfpg 1/1 Running 0 60m kibana-66f97964b-mdspc 1/1 Running 0 63m Fluentd \u542f\u52a8\u6210\u529f\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u53d1\u9001\u65e5\u5fd7\u5230 ES \u4e86\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u8fc7\u6ee4\u4e86\u53ea\u91c7\u96c6\u5177\u6709 logging=true \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u6240\u4ee5\u73b0\u5728\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u4f1a\u88ab\u91c7\u96c6\u3002 \u4e0b\u9762\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u5e94\u7528\uff0c \u65b0\u5efa counter.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a apiVersion: v1 kind: Pod metadata: name: counter labels: logging: \"true\" # \u4e00\u5b9a\u8981\u5177\u6709\u8be5\u6807\u7b7e\u624d\u4f1a\u88ab\u91c7\u96c6 spec: containers: - name: count image: busybox args: [ /bin/sh, -c, 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done', ] \u8be5 Pod \u53ea\u662f\u7b80\u5355\u5c06\u65e5\u5fd7\u4fe1\u606f\u6253\u5370\u5230 stdout \uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4 Fluentd \u4f1a\u6536\u96c6\u5230\u8fd9\u4e2a\u65e5\u5fd7\u6570\u636e\uff0c\u5728 Kibana \u4e2d\u4e5f\u5c31\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u4f7f\u7528 kubectl \u5de5\u5177\u521b\u5efa\u8be5 Pod\uff1a $ kubectl create -f counter.yaml $ kubectl get pods NAME READY STATUS RESTARTS AGE counter 1/1 Running 0 9h Pod \u521b\u5efa\u5e76\u8fd0\u884c\u540e\uff0c\u56de\u5230 Kibana Dashboard \u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7\u6700\u4e0b\u9762\u7684 Management -> Stack Management \uff0c\u8fdb\u5165\u7ba1\u7406\u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7 Kibana \u4e0b\u9762\u7684 \u7d22\u5f15\u6a21\u5f0f \uff0c\u70b9\u51fb \u521b\u5efa\u7d22\u5f15\u6a21\u5f0f \u5f00\u59cb\u5bfc\u5165\u7d22\u5f15\u6570\u636e\uff1a \u5728\u8fd9\u91cc\u53ef\u4ee5\u914d\u7f6e\u6211\u4eec\u9700\u8981\u7684 Elasticsearch \u7d22\u5f15\uff0c\u524d\u9762 Fluentd \u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u4f7f\u7528\u7684\u662f logstash \u683c\u5f0f\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a k8s \u7684\u524d\u7f00\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981\u5728\u6587\u672c\u6846\u4e2d\u8f93\u5165 k8s-* \u5373\u53ef\u5339\u914d\u5230 Elasticsearch \u96c6\u7fa4\u4e2d\u91c7\u96c6\u7684 Kubernetes \u96c6\u7fa4\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u4e00\u6b65\uff0c\u8fdb\u5165\u4ee5\u4e0b\u9875\u9762\uff1a \u5728\u8be5\u9875\u9762\u4e2d\u914d\u7f6e\u4f7f\u7528\u54ea\u4e2a\u5b57\u6bb5\u6309\u65f6\u95f4\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u5728\u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9 @timestamp \u5b57\u6bb5\uff0c\u7136\u540e\u70b9\u51fb \u521b\u5efa\u7d22\u5f15\u6a21\u5f0f \uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u5de6\u4fa7\u5bfc\u822a\u83dc\u5355\u4e2d\u7684 Discover \uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76f4\u65b9\u56fe\u548c\u6700\u8fd1\u91c7\u96c6\u5230\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a \u73b0\u5728\u7684\u6570\u636e\u5c31\u662f\u4e0a\u9762 Counter \u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u679c\u8fd8\u6709\u5176\u4ed6\u7684\u5e94\u7528\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u7b5b\u9009\u8fc7\u6ee4\uff1a \u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u5143\u6570\u636e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u6bd4\u5982\u60a8\u53ef\u4ee5\u5355\u51fb\u4efb\u4f55\u65e5\u5fd7\u6761\u76ee\u4ee5\u67e5\u770b\u5176\u4ed6\u5143\u6570\u636e\uff0c\u5982\u5bb9\u5668\u540d\u79f0\uff0cKubernetes \u8282\u70b9\uff0c\u547d\u540d\u7a7a\u95f4\u7b49\u3002","title":"\u5b89\u88c5"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#kafka","text":"\u5bf9\u4e8e\u5927\u89c4\u6a21\u96c6\u7fa4\u6765\u8bf4\uff0c\u65e5\u5fd7\u6570\u636e\u91cf\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u5982\u679c\u76f4\u63a5\u901a\u8fc7 Fluentd \u5c06\u65e5\u5fd7\u6253\u5165 Elasticsearch\uff0c\u5bf9 ES \u6765\u8bf4\u538b\u529b\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e2d\u95f4\u52a0\u4e00\u5c42\u6d88\u606f\u4e2d\u95f4\u4ef6\u6765\u7f13\u89e3 ES \u7684\u538b\u529b\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u4f7f\u7528 Kafka\uff0c\u7136\u540e\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 kafka-connect-elasticsearch \u8fd9\u6837\u7684\u5de5\u5177\u5c06\u6570\u636e\u76f4\u63a5\u6253\u5165 ES\uff0c\u4e5f\u53ef\u4ee5\u5728\u52a0\u4e00\u5c42 Logstash \u53bb\u6d88\u8d39 Kafka \u7684\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7 Logstash \u628a\u6570\u636e\u5b58\u5165 ES\uff0c\u8fd9\u91cc\u6211\u4eec\u6765\u4f7f\u7528 Logstash \u8fd9\u79cd\u6a21\u5f0f\u6765\u5bf9\u65e5\u5fd7\u6536\u96c6\u8fdb\u884c\u4f18\u5316\u3002 \u9996\u5148\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 Kafka\uff0c\u540c\u6837\u8fd9\u91cc\u4f7f\u7528 Helm \u8fdb\u884c\u5b89\u88c5\uff1a $ helm repo add bitnami https://charts.bitnami.com/bitnami $ helm repo update \u9996\u5148\u4f7f\u7528 helm pull \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a $ helm pull bitnami/kafka --untar --version 17.2.3 $ cd kafka \u8fd9\u91cc\u9762\u6211\u4eec\u6307\u5b9a\u4f7f\u7528\u4e00\u4e2a StorageClass \u6765\u63d0\u4f9b\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5728 Chart \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 values \u6587\u4ef6\uff1a # values-prod.yaml ## @section Persistence parameters persistence: enabled: true storageClass: \"local-path\" accessModes: - ReadWriteOnce size: 8Gi mountPath: /bitnami/kafka # \u914d\u7f6ezk volumes zookeeper: enabled: true persistence: enabled: true storageClass: \"local-path\" accessModes: - ReadWriteOnce size: 8Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 kafka\uff1a $ helm upgrade --install kafka -f values-prod.yaml --namespace logging . Release \"kafka\" does not exist. Installing it now. NAME: kafka LAST DEPLOYED: Thu Jun 9 14:02:01 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: CHART NAME: kafka CHART VERSION: 17.2.3 APP VERSION: 3.2.0 ** Please be patient while the chart is being deployed ** Kafka can be accessed by consumers via port 9092 on the following DNS name from within your cluster: kafka.logging.svc.cluster.local Each Kafka broker can be accessed by producers via port 9092 on the following DNS name(s) from within your cluster: kafka-0.kafka-headless.logging.svc.cluster.local:9092 To create a pod that you can use as a Kafka client run the following commands: kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:3.2.0-debian-10-r4 --namespace logging --command -- sleep infinity kubectl exec --tty -i kafka-client --namespace logging -- bash PRODUCER: kafka-console-producer.sh \\ --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 \\ --topic test CONSUMER: kafka-console-consumer.sh \\ --bootstrap-server kafka.logging.svc.cluster.local:9092 \\ --topic test \\ --from-beginning \u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u63d0\u793a\u6765\u68c0\u67e5 Kafka \u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/instance=kafka kafka-0 1/1 Running 0 7m58s kafka-zookeeper-0 1/1 Running 0 7m58s \u7528\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a Kafka \u7684\u6d4b\u8bd5\u5ba2\u6237\u7aef Pod\uff1a $ kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:3.2.0-debian-10-r4 --namespace logging --command -- sleep infinity pod/kafka-client created \u7136\u540e\u542f\u52a8\u4e00\u4e2a\u7ec8\u7aef\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\u751f\u4ea7\u6d88\u606f\uff1a # \u751f\u4ea7\u8005 $ kubectl exec --tty -i kafka-client --namespace logging -- bash I have no name!@kafka-client:/$ kafka-console-producer.sh --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 --topic test >hello kafka on k8s > \u542f\u52a8\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\u6d88\u8d39\u6d88\u606f\uff1a # \u6d88\u8d39\u8005 $ kubectl exec --tty -i kafka-client --namespace logging -- bash I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic test --from-beginning hello kafka on k8s \u5982\u679c\u5728\u6d88\u8d39\u7aef\u770b\u5230\u4e86\u751f\u4ea7\u7684\u6d88\u606f\u6570\u636e\u8bc1\u660e\u6211\u4eec\u7684 Kafka \u5df2\u7ecf\u8fd0\u884c\u6210\u529f\u4e86\u3002","title":"\u5b89\u88c5 Kafka"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#fluentd-kafka","text":"\u73b0\u5728\u6709\u4e86 Kafka\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06 Fluentd \u7684\u65e5\u5fd7\u6570\u636e\u8f93\u51fa\u5230 Kafka \u4e86\uff0c\u53ea\u9700\u8981\u5c06 Fluentd \u914d\u7f6e\u4e2d\u7684 <match> \u66f4\u6539\u4e3a\u4f7f\u7528 Kafka \u63d2\u4ef6\u5373\u53ef\uff0c\u4f46\u662f\u5728 Fluentd \u4e2d\u8f93\u51fa\u5230 Kafka\uff0c\u9700\u8981\u4f7f\u7528\u5230 fluent-plugin-kafka \u63d2\u4ef6\uff0c\u6240\u4ee5\u9700\u8981\u6211\u4eec\u81ea\u5b9a\u4e49\u4e0b Docker \u955c\u50cf\uff0c\u6700\u7b80\u5355\u7684\u505a\u6cd5\u5c31\u662f\u5728\u4e0a\u9762 Fluentd \u955c\u50cf\u7684\u57fa\u7840\u4e0a\u65b0\u589e kafka \u63d2\u4ef6\u5373\u53ef\uff0cDockerfile \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a FROM quay.io/fluentd_elasticsearch/fluentd:v3.4.0 RUN echo \"source 'https://mirrors.tuna.tsinghua.edu.cn/rubygems/'\" > Gemfile && gem install bundler RUN gem install fluent-plugin-kafka -v 0.17.5 --no-document \u4f7f\u7528\u4e0a\u9762\u7684 Dockerfile \u6587\u4ef6\u6784\u5efa\u4e00\u4e2a Docker \u955c\u50cf\u5373\u53ef\uff0c\u6211\u8fd9\u91cc\u6784\u5efa\u8fc7\u540e\u7684\u955c\u50cf\u540d\u4e3a cnych/fluentd-kafka:v0.17.5 \u3002\u63a5\u4e0b\u6765\u66ff\u6362 Fluentd \u7684 Configmap \u5bf9\u8c61\u4e2d\u7684 <match> \u90e8\u5206\uff0c\u5982\u4e0b\u6240\u793a\uff1a # fluentd-configmap.yaml kind: ConfigMap apiVersion: v1 metadata: name: fluentd-conf namespace: logging data: ...... output.conf: |- <match **> @id kafka @type kafka2 @log_level info # list of seed brokers brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092 use_event_time true # topic settings topic_key k8slog default_topic messages # \u6ce8\u610f\uff0ckafka\u4e2d\u6d88\u8d39\u4f7f\u7528\u7684\u662f\u8fd9\u4e2atopic # buffer settings <buffer k8slog> @type file path /var/log/td-agent/buffer/td flush_interval 3s </buffer> # data type settings <format> @type json </format> # producer settings required_acks -1 compression_codec gzip </match> \u7136\u540e\u66ff\u6362\u8fd0\u884c\u7684 Fluentd \u955c\u50cf\uff1a # fluentd-daemonset.yaml image: cnych/fluentd-kafka:v0.17.5 \u76f4\u63a5\u66f4\u65b0 Fluentd \u7684 Configmap \u4e0e DaemonSet \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a $ kubectl apply -f fluentd-configmap.yaml $ kubectl apply -f fluentd-daemonset.yaml \u66f4\u65b0\u6210\u529f\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u6d4b\u8bd5 Kafka \u5ba2\u6237\u7aef\u6765\u9a8c\u8bc1\u662f\u5426\u6709\u65e5\u5fd7\u6570\u636e\uff1a $ kubectl exec --tty -i kafka-client --namespace logging -- bash I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic messages --from-beginning {\"stream\":\"stdout\",\"docker\":{},\"kubernetes\":{\"container_name\":\"count\",\"namespace_name\":\"default\",\"pod_name\":\"counter\",\"container_image\":\"busybox:latest\",\"host\":\"node1\",\"labels\":{\"logging\":\"true\"}},\"message\":\"43883: Tue Apr 27 12:16:30 UTC 2021\\n\"} ......","title":"Fluentd \u914d\u7f6e Kafka"},{"location":"3.k8s/7.logging/%E6%90%AD%E5%BB%BA-efk-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/#logstash","text":"\u867d\u7136\u6570\u636e\u4ece Kafka \u5230 Elasticsearch \u7684\u65b9\u5f0f\u591a\u79cd\u591a\u6837\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f7f\u7528 Kafka Connect Elasticsearch Connector \u6765\u5b9e\u73b0\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u66f4\u52a0\u6d41\u884c\u7684 `Logstash`` \u65b9\u6848\uff0c\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u65e5\u5fd7\u4ece Fluentd \u91c7\u96c6\u8f93\u51fa\u5230 Kafka \u4e2d\u53bb\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528 Logstash \u6765\u8fde\u63a5 Kafka \u4e0e Elasticsearch \u95f4\u7684\u65e5\u5fd7\u6570\u636e\u3002 \u9996\u5148\u4f7f\u7528 helm pull \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a $ helm pull elastic/logstash --untar --version 7.17.3 $ cd logstash \u540c\u6837\u5728 Chart \u6839\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 Values \u6587\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a # values-prod.yaml fullnameOverride: logstash persistence: enabled: true logstashConfig: logstash.yml: | http.host: 0.0.0.0 # \u5982\u679c\u542f\u7528\u4e86xpack\uff0c\u9700\u8981\u505a\u5982\u4e0b\u914d\u7f6e xpack.monitoring.enabled: true xpack.monitoring.elasticsearch.hosts: [\"http://elasticsearch-client:9200\"] xpack.monitoring.elasticsearch.username: \"elastic\" xpack.monitoring.elasticsearch.password: \"ydzsio321\" # \u8981\u6ce8\u610f\u4e0b\u683c\u5f0f logstashPipeline: logstash.conf: | input { kafka { bootstrap_servers => \"kafka-0.kafka-headless.logging.svc.cluster.local:9092\" codec => json consumer_threads => 3 topics => [\"messages\"] } } filter {} # \u8fc7\u6ee4\u914d\u7f6e\uff08\u6bd4\u5982\u53ef\u4ee5\u5220\u9664key\u3001\u6dfb\u52a0geoip\u7b49\u7b49\uff09 output { elasticsearch { hosts => [ \"elasticsearch-client:9200\" ] user => \"elastic\" password => \"ydzsio321\" index => \"logstash-k8s-%{+YYYY.MM.dd}\" } stdout { codec => rubydebug } } volumeClaimTemplate: accessModes: [\"ReadWriteOnce\"] storageClassName: nfs-storage resources: requests: storage: 1Gi \u5176\u4e2d\u6700\u91cd\u8981\u7684\u5c31\u662f\u901a\u8fc7 logstashPipeline \u914d\u7f6e logstash \u6570\u636e\u6d41\u7684\u5904\u7406\u914d\u7f6e\uff0c\u901a\u8fc7 input \u6307\u5b9a\u65e5\u5fd7\u6e90 kafka \u7684\u914d\u7f6e\uff0c\u901a\u8fc7 output \u8f93\u51fa\u5230 Elasticsearch\uff0c\u540c\u6837\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 Values \u6587\u4ef6\u5b89\u88c5 logstash \u5373\u53ef\uff1a $ helm upgrade --install logstash -f values-prod.yaml --namespace logging . Release \"logstash\" does not exist. Installing it now. NAME: logstash LAST DEPLOYED: Thu Jun 9 15:02:49 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: 1. Watch all cluster members come up. $ kubectl get pods --namespace=logging -l app=logstash -w \u5b89\u88c5\u542f\u52a8\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b logstash \u7684\u65e5\u5fd7\uff1a $ logstash kubectl get pods --namespace=logging -l app=logstash NAME READY STATUS RESTARTS AGE logstash-0 1/1 Running 0 2m8s $ kubectl logs -f logstash-0 -n logging ...... { \"@version\" => \"1\", \"stream\" => \"stdout\", \"@timestamp\" => 2022-06-09T07:09:16.889Z, \"message\" => \"4672: Thu Jun 9 07:09:15 UTC 2022\", \"kubernetes\" => { \"container_image\" => \"docker.io/library/busybox:latest\", \"container_name\" => \"count\", \"labels\" => { \"logging\" => \"true\" }, \"pod_name\" => \"counter\", \"namespace_name\" => \"default\", \"pod_ip\" => \"10.244.2.118\", \"host\" => \"node2\", \"namespace_labels\" => { \"kubernetes_io/metadata_name\" => \"default\" } }, \"docker\" => {} } \u7531\u4e8e\u6211\u4eec\u542f\u7528\u4e86 debug \u65e5\u5fd7\u8c03\u8bd5\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728 logstash \u7684\u65e5\u5fd7\u4e2d\u770b\u5230\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u6d88\u606f\uff0c\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684\u65e5\u5fd7\u6570\u636e\u5c31\u83b7\u53d6\u6210\u529f\u4e86\u3002 \u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u767b\u5f55\u5230 Kibana \u53ef\u4ee5\u770b\u5230\u6709\u5982\u4e0b\u6240\u793a\u7684\u7d22\u5f15\u6570\u636e\u4e86\uff1a \u7136\u540e\u540c\u6837\u521b\u5efa\u7d22\u5f15\u6a21\u5f0f\uff0c\u5339\u914d\u4e0a\u9762\u7684\u7d22\u5f15\u5373\u53ef\uff1a \u521b\u5efa\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u524d\u5f80\u53d1\u73b0\u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\u4e86\uff1a \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86\u4e00\u4e2a\u4f7f\u7528 Fluentd+Kafka+Logstash+Elasticsearch+Kibana \u7684 Kubernetes \u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u6808\uff0c\u8fd9\u91cc\u6211\u4eec\u5b8c\u6574\u7684 Pod \u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE elasticsearch-client-0 1/1 Running 0 128m elasticsearch-data-0 1/1 Running 0 128m elasticsearch-master-0 1/1 Running 0 128m fluentd-6k52h 1/1 Running 0 61m fluentd-cw72c 1/1 Running 0 61m fluentd-dn4hs 1/1 Running 0 61m kafka-0 1/1 Running 3 134m kafka-client 1/1 Running 0 125m kafka-zookeeper-0 1/1 Running 0 134m kibana-kibana-66f97964b-qqjgg 1/1 Running 0 128m logstash-0 1/1 Running 0 13m \u5f53\u7136\u5728\u5b9e\u9645\u7684\u5de5\u4f5c\u9879\u76ee\u4e2d\u8fd8\u9700\u8981\u6211\u4eec\u6839\u636e\u5b9e\u9645\u7684\u4e1a\u52a1\u573a\u666f\u6765\u8fdb\u884c\u53c2\u6570\u6027\u80fd\u8c03\u4f18\u4ee5\u53ca\u9ad8\u53ef\u7528\u7b49\u8bbe\u7f6e\uff0c\u4ee5\u8fbe\u5230\u7cfb\u7edf\u7684\u6700\u4f18\u6027\u80fd\u3002 \u4e0a\u9762\u6211\u4eec\u5728\u914d\u7f6e logstash \u7684\u65f6\u5019\u662f\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230 \"logstash-k8s-%{+YYYY.MM.dd}\" \u8fd9\u4e2a\u7d22\u5f15\u6a21\u5f0f\u7684\uff0c\u53ef\u80fd\u6709\u7684\u573a\u666f\u4e0b\u53ea\u901a\u8fc7\u65e5\u671f\u53bb\u533a\u5206\u7d22\u5f15\u4e0d\u662f\u5f88\u5408\u7406\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u53bb\u4fee\u6539\u7d22\u5f15\u540d\u79f0\uff0c\u6bd4\u5982\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u670d\u52a1\u540d\u79f0\u6765\u8fdb\u884c\u533a\u5206\uff0c\u90a3\u4e48\u8fd9\u4e2a\u670d\u52a1\u540d\u79f0\u53ef\u4ee5\u600e\u4e48\u6765\u5b9a\u4e49\u5462\uff1f\u53ef\u4ee5\u662f Pod \u7684\u540d\u79f0\u6216\u8005\u901a\u8fc7 label \u6807\u7b7e\u53bb\u6307\u5b9a\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u53bb\u505a\u4e00\u4e2a\u89c4\u8303\uff0c\u8981\u6c42\u9700\u8981\u6536\u96c6\u65e5\u5fd7\u7684 Pod \u9664\u4e86\u9700\u8981\u6dfb\u52a0 logging: true \u8fd9\u4e2a\u6807\u7b7e\u4e4b\u5916\uff0c\u8fd8\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a logIndex: <\u7d22\u5f15\u540d> \u7684\u6807\u7b7e\u3002 \u6bd4\u5982\u91cd\u65b0\u66f4\u65b0\u6211\u4eec\u6d4b\u8bd5\u7684 counter \u5e94\u7528\uff1a apiVersion: v1 kind: Pod metadata: name: counter labels: logging: \"true\" # \u4e00\u5b9a\u8981\u5177\u6709\u8be5\u6807\u7b7e\u624d\u4f1a\u88ab\u91c7\u96c6 logIndex: \"test\" # \u6307\u5b9a\u7d22\u5f15\u540d\u79f0 spec: containers: - name: count image: busybox args: [ /bin/sh, -c, 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done', ] \u7136\u540e\u91cd\u65b0\u66f4\u65b0 logstash \u7684\u914d\u7f6e\uff0c\u4fee\u6539 values \u914d\u7f6e\uff1a # ...... logstashPipeline: logstash.conf: | input { kafka { bootstrap_servers => \"kafka-0.kafka-headless.logging.svc.cluster.local:9092\" codec => json consumer_threads => 3 topics => [\"messages\"] } } filter {} # \u8fc7\u6ee4\u914d\u7f6e\uff08\u6bd4\u5982\u53ef\u4ee5\u5220\u9664key\u3001\u6dfb\u52a0geoip\u7b49\u7b49\uff09 output { elasticsearch { hosts => [ \"elasticsearch-client:9200\" ] user => \"elastic\" password => \"ydzsio321\" index => \"k8s-%{[kubernetes][labels][logIndex]}-%{+YYYY.MM.dd}\" } stdout { codec => rubydebug } } # ...... \u4f7f\u7528\u4e0a\u9762\u7684 values \u503c\u66f4\u65b0 logstash\uff0c\u6b63\u5e38\u66f4\u65b0\u540e\u4e0a\u9762\u7684 counter \u8fd9\u4e2a Pod \u65e5\u5fd7\u4f1a\u8f93\u51fa\u5230\u4e00\u4e2a\u540d\u4e3a k8s-test-2022.06.09 \u7684\u7d22\u5f15\u53bb\u3002 \u8fd9\u6837\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86\u81ea\u5b9a\u4e49\u7d22\u5f15\u540d\u79f0\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Pod \u540d\u79f0\u3001\u5bb9\u5668\u540d\u79f0\u3001\u547d\u540d\u7a7a\u95f4\u540d\u79f0\u6765\u4f5c\u4e3a\u7d22\u5f15\u7684\u540d\u79f0\uff0c\u8fd9\u5b8c\u5168\u53d6\u51b3\u4e8e\u4f60\u81ea\u5df1\u7684\u9700\u6c42\u3002","title":"\u5b89\u88c5 Logstash"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/","text":"\u65e5\u5fd7\u62a5\u8b66 \u00b6 \u65e5\u5fd7\u62a5\u8b66 \u00b6 \u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u4ee5\u53ca\u4e00\u4e2a\u6709\u8ffd\u6c42\u7684\u8fd0\u7ef4\u4eba\u5458\u6765\u8bf4\uff0c\u54ea\u6015\u662f\u6beb\u79d2\u7ea7\u522b\u7684\u5b95\u673a\u4e5f\u662f\u4e0d\u80fd\u5bb9\u5fcd\u7684\u3002\u5bf9\u57fa\u7840\u8bbe\u65bd\u53ca\u5e94\u7528\u8fdb\u884c\u9002\u5f53\u7684\u65e5\u5fd7\u8bb0\u5f55\u548c\u76d1\u63a7\u975e\u5e38\u6709\u52a9\u4e8e\u89e3\u51b3\u95ee\u9898\uff0c\u8fd8\u53ef\u4ee5\u5e2e\u52a9\u4f18\u5316\u6210\u672c\u548c\u8d44\u6e90\uff0c\u4ee5\u53ca\u5e2e\u52a9\u68c0\u6d4b\u4ee5\u540e\u53ef\u80fd\u4f1a\u53d1\u751f\u7684\u4e00\u4e9b\u95ee\u9898\u3002\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4f7f\u7528\u4e86 Prometheus \u6765\u8fdb\u884c\u76d1\u63a7\u62a5\u8b66\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u4f7f\u7528 Loki \u6536\u96c6\u65e5\u5fd7\u662f\u5426\u53ef\u4ee5\u6839\u636e\u91c7\u96c6\u7684\u65e5\u5fd7\u6765\u8fdb\u884c\u62a5\u8b66\u5462\uff1f\u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u800c\u4e14\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u6765\u5b9e\u73b0\uff1aPromtail \u4e2d\u7684 metrics \u9636\u6bb5\u548c Loki \u7684 ruler \u7ec4\u4ef6\u3002 \u6d4b\u8bd5\u5e94\u7528 \u00b6 \u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u7684 nginx \u5e94\u7528\u7528\u4e8e Loki \u65e5\u5fd7\u62a5\u8b66\uff1a # nginx-deploy.yaml apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx labels: app: nginx spec: ports: - name: nginx port: 80 protocol: TCP selector: app: nginx type: NodePort \u4e3a\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u6765\u66b4\u9732\u5e94\u7528\uff0c\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a $ kubectl apply -f nginx-deploy.yaml $ kubectl get pods NAME READY STATUS RESTARTS AGE nginx-5d59d67564-ll9xf 1/1 Running 0 16s $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 91d nginx NodePort 10.99.153.32 <none> 80:31313/TCP 22s \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u6765\u6a21\u62df\u6bcf\u9694 10s \u8bbf\u95ee Nginx \u5e94\u7528\uff1a $ while true; do curl --silent --output /dev/null --write-out '%{http_code}' http://192.168.0.106:31313; sleep 10; echo; done 200 200 metrics \u9636\u6bb5 \u00b6 \u524d\u9762\u6211\u4eec\u63d0\u5230\u5728 Promtail \u4e2d\u901a\u8fc7\u4e00\u7cfb\u5217 Pipeline \u6765\u5904\u7406\u65e5\u5fd7\uff0c\u5176\u4e2d\u5c31\u5305\u62ec\u4e00\u4e2a metrics \u7684\u9636\u6bb5\uff0c\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u9700\u6c42\u6765\u589e\u52a0\u4e00\u4e2a\u76d1\u63a7\u6307\u6807\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u7684\u57fa\u4e8e\u65e5\u5fd7\u7684\u76d1\u63a7\u62a5\u8b66\u7684\u6838\u5fc3\u70b9\uff0c\u901a\u8fc7\u7ed3\u6784\u5316\u65e5\u5fd7\uff0c\u589e\u52a0\u76d1\u63a7\u6307\u6807\uff0c\u7136\u540e\u4f7f\u7528 Prometheus \u7ed3\u5408 Alertmanager \u5b8c\u6210\u4e4b\u524d\u6211\u4eec\u975e\u5e38\u719f\u6089\u7684\u76d1\u63a7\u62a5\u8b66\u3002 \u9996\u5148\u6211\u4eec\u9700\u8981\u5b89\u88c5 Prometheus \u4e0e Alertmanager\uff0c\u53ef\u4ee5\u624b\u52a8\u5b89\u88c5\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Prometheus Operator \u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u53c2\u8003 \u76d1\u63a7\u62a5\u8b66 \u7ae0\u8282\u76f8\u5173\u5185\u5bb9\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u9009\u62e9\u4f7f\u7528 Prometheus Operator \u7684\u65b9\u5f0f\u3002 \u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86\u51e0\u79cd Loki \u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u4fdd\u7559\u4e0a\u8282\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki \u96c6\u7fa4\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u91cd\u65b0\u914d\u7f6e Promtail\uff0c\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a metrics \u5904\u7406\u9636\u6bb5\uff0c\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\u91cd\u65b0\u5b89\u88c5\u3002 # ci/metrics-values.yaml rbac: pspEnabled: false config: clients: - url: http://loki-loki-distributed-gateway/loki/api/v1/push snippets: pipelineStages: - cri: {} - match: selector: '{app=\"nginx\"}' stages: - regex: expression: \".*(?P<hits>GET /.*)\" - metrics: nginx_hits: type: Counter description: \"Total nginx requests\" source: hits config: action: inc serviceMonitor: enabled: true additionalLabels: app: prometheus-operator release: prometheus \u4e0a\u9762\u6700\u91cd\u8981\u7684\u90e8\u5206\u5c31\u662f\u4e3a Promtail \u6dfb\u52a0\u4e86 pipelineStages \u914d\u7f6e\uff0c\u7528\u4e8e\u5bf9\u65e5\u5fd7\u884c\u8fdb\u884c\u8f6c\u6362\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a match \u7684\u9636\u6bb5\uff0c\u4f1a\u53bb\u5339\u914d\u5177\u6709 app=nginx \u8fd9\u6837\u7684\u65e5\u5fd7\u6d41\u6570\u636e\uff0c\u7136\u540e\u4e0b\u4e00\u4e2a\u9636\u6bb5\u662f\u5229\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u8fc7\u6ee4\u51fa\u5305\u542b GET \u5173\u952e\u5b57\u7684\u65e5\u5fd7\u884c\u3002 \u5728 metrics \u6307\u6807\u9636\u6bb5\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a nginx_hits \u7684\u6307\u6807\uff0cPromtail \u901a\u8fc7\u5176 /metrics \u7aef\u70b9\u66b4\u9732\u8fd9\u4e2a\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u6570\u636e\u3002\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u7684\u662f\u4e00\u4e2a Counter \u7c7b\u578b\u7684\u6307\u6807\uff0c\u5f53\u4ece regex \u9636\u6bb5\u5339\u914d\u4e0a\u540e\uff0c\u8fd9\u4e2a\u8ba1\u6570\u5668\u5c31\u4f1a\u9012\u589e\u3002 \u4e3a\u4e86\u5728 Prometheus \u4e2d\u80fd\u591f\u8fd9\u4e2a\u6307\u6807\uff0c\u6211\u4eec\u901a\u8fc7 promtail.serviceMonitor.enable=true \u5f00\u542f\u4e86\u4e00\u4e2a ServiceMonitor\u3002\u63a5\u4e0b\u6765\u91cd\u65b0\u66f4\u65b0 Loki \u5e94\u7528\uff0c\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u5373\u53ef\uff1a $ helm upgrade --install loki -n logging -f ci/metrics-values.yaml . \u66f4\u65b0\u5b8c\u6210\u540e\u4f1a\u521b\u5efa\u4e00\u4e2a ServiceMonitor \u5bf9\u8c61\u7528\u4e8e\u53d1\u73b0 Promtail \u7684\u6307\u6807\u6570\u636e\uff1a $ kubectl get servicemonitor -n logging NAME AGE loki-promtail 10s \u5982\u679c\u4f60\u4f7f\u7528\u7684 Prometheus-Operator \u9ed8\u8ba4\u4e0d\u80fd\u53d1\u73b0 logging \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u6570\u636e\uff0c\u5219\u9700\u8981\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u4e00\u4e2a Role \u6743\u9650\uff1a apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: app.kubernetes.io/component: prometheus app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 2.26.0 name: prometheus-k8s namespace: logging rules: - apiGroups: - \"\" resources: - services - endpoints - pods verbs: - get - list - watch - apiGroups: - extensions resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: prometheus-k8s namespace: logging roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s subjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoring \u6b63\u5e38\u5728 Prometheus \u91cc\u9762\u5c31\u53ef\u4ee5\u770b\u5230 Promtail \u7684\u6293\u53d6\u76ee\u6807\u4e86\uff1a \u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f Prometheus Operator \u81ea\u5e26\u7684 Grafana\uff0c\u5219\u9700\u8981\u624b\u52a8\u6dfb\u52a0\u4e0a Loki \u7684\u6570\u636e\u6e90\uff0c\u524d\u9762\u5fae\u670d\u52a1\u6a21\u5f0f\u4e2d\u6211\u4eec\u5df2\u7ecf\u5728 Grafana \u4e2d\u914d\u7f6e\u4e86 Loki \u7684\u6570\u636e\u6e90\uff0c\u73b0\u5728\u5f53\u6211\u4eec\u8bbf\u95ee\u6d4b\u8bd5\u5e94\u7528\u7684\u65f6\u5019\uff0c\u5728 Loki \u4e2d\u662f\u53ef\u4ee5\u67e5\u770b\u5230\u65e5\u5fd7\u6570\u636e\u7684\uff1a \u800c\u4e14\u73b0\u5728\u5728 Prometheus \u4e2d\u8fd8\u53ef\u4ee5\u67e5\u8be2\u5230\u6211\u4eec\u5728 Promtail \u4e2d\u6dfb\u52a0\u7684 metrics \u6307\u6807\u6570\u636e\uff1a \u56e0\u4e3a\u73b0\u5728\u5df2\u7ecf\u6709\u76d1\u63a7\u6307\u6807\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u6765\u521b\u5efa\u62a5\u8b66\u89c4\u5219\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684 Prometheus Operator\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u4e00\u4e2a PrometheusRule \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a # nginx-prometheus-rule.yaml apiVersion: monitoring.coreos.com/v1 kind: PrometheusRule metadata: labels: prometheus: k8s role: alert-rules name: promtail-nginx-hits namespace: logging spec: groups: - name: nginx-hits rules: - alert: LokiNginxHits annotations: summary: nginx hits counter description: \"nginx_hits total insufficient count ({{ $value }}).\" expr: | sum(increase(promtail_custom_nginx_hits[1m])) > 2 for: 2m labels: severity: critical \u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e86\u540d\u4e3a nginx_hits \u7684\u62a5\u8b66\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u5728\u540c\u4e00\u4e2a\u5206\u7ec4\u4e2d\uff0c\u6bcf\u9694\u4e00\u5b9a\u7684\u65f6\u95f4\u95f4\u9694\u4f9d\u6b21\u6267\u884c\u3002\u89e6\u53d1\u62a5\u8b66\u7684\u9608\u503c\u901a\u8fc7 expr \u8868\u8fbe\u5f0f\u8fdb\u884c\u914d\u7f6e\u3002\u6211\u4eec\u8fd9\u91cc\u8868\u793a\u7684\u662f 1 \u5206\u949f\u4e4b\u5185\u65b0\u589e\u7684\u603b\u548c\u662f\u5426\u5927\u4e8e 2\uff0c\u5f53 expor \u8868\u8fbe\u5f0f\u7684\u6761\u4ef6\u6301\u7eed\u4e86 2 \u5206\u949f\u65f6\u95f4\u540e\uff0c\u62a5\u8b66\u5c31\u4f1a\u771f\u6b63\u88ab\u89e6\u53d1\uff0c\u62a5\u8b66\u771f\u6b63\u88ab\u89e6\u53d1\u4e4b\u524d\u4f1a\u4fdd\u6301\u4e3a Pending \u72b6\u6001\u3002 \u7136\u540e\u5177\u4f53\u60f3\u8981\u628a\u62a5\u8b66\u53d1\u9001\u5230\u4ec0\u4e48\u5730\u65b9\u53bb\uff0c\u53ef\u4ee5\u6839\u636e\u6807\u7b7e\u53bb\u914d\u7f6e receiver\uff0c\u6bd4\u5982\u53ef\u4ee5\u901a\u8fc7 WebHook \u6765\u63a5\u6536\u3002\u6211\u4eec\u5728 AlertManager \u4e2d\u4e5f\u662f\u53ef\u4ee5\u770b\u5230\u63a5\u6536\u5230\u7684\u62a5\u8b66\u4e8b\u4ef6\u7684\u3002 Ruler \u7ec4\u4ef6 \u00b6 \u4e0a\u9762\u7684\u65b9\u5f0f\u867d\u7136\u53ef\u4ee5\u5b9e\u73b0\u6211\u4eec\u7684\u65e5\u5fd7\u62a5\u8b66\u529f\u80fd\uff0c\u4f46\u662f\u8fd8\u662f\u4e0d\u591f\u76f4\u63a5\uff0c\u9700\u8981\u901a\u8fc7 Promtail \u53bb\u8fdb\u884c\u5904\u7406\uff0c\u90a3\u4e48\u6211\u4eec\u80fd\u5426\u76f4\u63a5\u901a\u8fc7 Loki \u6765\u5b9e\u73b0\u62a5\u8b66\u529f\u80fd\u5462\uff1f\u5176\u5b9e\u5728 Loki2.0 \u7248\u672c\u5c31\u63d0\u4f9b\u4e86\u62a5\u8b66\u529f\u80fd\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a Ruler \u7ec4\u4ef6\u53ef\u4ee5\u6301\u7eed\u67e5\u8be2\u4e00\u4e2a rules \u89c4\u5219\uff0c\u5e76\u5c06\u8d85\u8fc7\u9608\u503c\u7684\u4e8b\u4ef6\u63a8\u9001\u7ed9 AlertManager \u6216\u8005\u5176\u4ed6 Webhook \u670d\u52a1\uff0c\u8fd9\u4e5f\u5c31\u662f Loki \u81ea\u5e26\u7684\u62a5\u8b66\u529f\u80fd\u4e86\uff0c\u800c\u4e14\u662f\u517c\u5bb9 AlertManager \u7684\u3002 \u9996\u5148\u6211\u4eec\u9700\u8981\u5f00\u542f Loki Ruler \u7ec4\u4ef6\uff0c\u66f4\u65b0 loki-distributed \u5b89\u88c5\u7684 Values \u6587\u4ef6\uff0c\u5728\u524d\u9762\u5fae\u670d\u52a1\u6a21\u5f0f\u7684\u57fa\u7840\u4e0a\u589e\u52a0 ruler \u7ec4\u4ef6\u914d\u7f6e\uff1a # ci/alert-values.yaml loki: structuredConfig: ingester: max_transfer_retries: 0 chunk_idle_period: 1h chunk_target_size: 1536000 max_chunk_age: 1h storage_config: # \u5b58\u50a8\u7684\u914d\u7f6e\uff0c\u5b9a\u4e49\u5176\u4ed6\u7ec4\u4ef6\u53ef\u80fd\u7528\u5230\u7684\u5b58\u50a8 aws: # s3 / s3 \u517c\u5bb9\u7684\u5bf9\u8c61\u5b58\u50a8 endpoint: minio.logging.svc.cluster.local:9000 insecure: true bucketnames: loki-data access_key_id: myaccessKey secret_access_key: mysecretKey s3forcepathstyle: true boltdb_shipper: shared_store: s3 schema_config: configs: - from: 2022-06-21 store: boltdb-shipper # index object_store: s3 # chunks schema: v12 index: prefix: loki_index_ period: 24h ruler: storage: type: local local: directory: /etc/loki/rules ring: kvstore: store: memberlist rule_path: /tmp/loki/scratch alertmanager_url: http://alertmanager-main.monitoring.svc.cluster.local:9093 external_url: http:/192.168.0.106\uff1a31918 distributor: replicas: 2 ingester: # WAL\uff08replay\uff09 replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path querier: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path queryFrontend: replicas: 2 gateway: # nginx\u5bb9\u5668 -> \u8def\u7531\u65e5\u5fd7\u5199/\u8bfb\u7684\u8bf7\u6c42 nginxConfig: httpSnippet: |- client_max_body_size 100M; serverSnippet: |- client_max_body_size 100M; # Configuration for the ruler ruler: enabled: true kind: Deployment replicas: 1 persistence: enabled: true size: 1Gi storageClass: local-path # -- Directories containing rules files directories: tenant_no: rules1.txt: | groups: - name: nginx-rate rules: - alert: LokiNginxRate expr: sum(rate({app=\"nginx\"} |= \"error\" [1m])) by (job) / sum(rate({app=\"nginx\"}[1m])) by (job) > 0.01 for: 1m labels: severity: critical annotations: summary: loki nginx rate description: high request latency \u6211\u4eec\u9996\u5148\u901a\u8fc7 loki.structuredConfig.ruler \u5bf9 Ruler \u7ec4\u4ef6\u8fdb\u884c\u914d\u7f6e\uff0c\u6bd4\u5982\u6307\u5b9a Alertmanager \u7684\u5730\u5740\uff0c\u89c4\u5219\u5b58\u50a8\u65b9\u5f0f\u7b49\uff0c\u7136\u540e\u901a\u8fc7 ruler \u5c5e\u6027\u914d\u7f6e\u4e86\u7ec4\u4ef6\u7684\u76f8\u5173\u4fe1\u606f\u4ee5\u53ca\u62a5\u8b66\u89c4\u5219\uff0c\u91cd\u65b0\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 Loki\uff1a $ helm upgrade --install loki -n logging -f ci/alert-values.yaml . $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE grafana-55d8779dc6-gkgpf 1/1 Running 2 (66m ago) 3d21h loki-loki-distributed-distributor-56959cc548-xpv6d 1/1 Running 0 3m36s loki-loki-distributed-distributor-56959cc548-zjfsb 1/1 Running 0 2m52s loki-loki-distributed-gateway-6f4cfd898c-p9xxf 1/1 Running 0 21m loki-loki-distributed-ingester-0 1/1 Running 0 2m32s loki-loki-distributed-ingester-1 1/1 Running 0 3m34s loki-loki-distributed-querier-0 1/1 Running 0 2m48s loki-loki-distributed-querier-1 1/1 Running 0 3m29s loki-loki-distributed-query-frontend-5bcc7949d-brzg6 1/1 Running 0 3m30s loki-loki-distributed-query-frontend-5bcc7949d-g2wwd 1/1 Running 0 3m35s loki-loki-distributed-ruler-5d4b8cd889-m2vbd 1/1 Running 0 3m35s minio-548656f786-mjd4c 1/1 Running 2 (66m ago) 3d21h promtail-ddz27 1/1 Running 0 19m promtail-lzr6v 1/1 Running 0 20m promtail-nldqx 1/1 Running 0 20m Loki \u7684 rulers \u89c4\u5219\u548c\u7ed3\u6784\u4e0e Prometheus \u662f\u5b8c\u5168\u517c\u5bb9\uff0c\u552f\u4e00\u7684\u533a\u522b\u5728\u4e8e\u67e5\u8be2\u8bed\u53e5\uff08LogQL\uff09\u4e0d\u540c\uff0c\u5728 Loki \u4e2d\u6211\u4eec\u7528 LogQL \u6765\u67e5\u8be2\u65e5\u5fd7\uff0c\u4e00\u4e2a\u5178\u578b\u7684 rules \u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a groups: # \u7ec4\u540d\u79f0 - name: xxxx rules: # Alert\u540d\u79f0 - alert: xxxx # logQL\u67e5\u8be2\u8bed\u53e5 expr: xxxx # \u4ea7\u751f\u544a\u8b66\u7684\u6301\u7eed\u65f6\u95f4 pending. [ for: | default = 0s ] # \u81ea\u5b9a\u4e49\u544a\u8b66\u4e8b\u4ef6\u7684label labels: [ : ] # \u544a\u8b66\u65f6\u95f4\u7684\u6ce8\u91ca annotations: [ : ] \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u7684\u89c4\u5219 sum(rate({app=\"nginx\"} |= \"error\" [1m])) by (job) / sum(rate({app=\"nginx\"}[1m])) by (job) > 0.01 \u8868\u793a\u901a\u8fc7\u65e5\u5fd7\u67e5\u5230 nginx \u65e5\u5fd7\u7684\u9519\u8bef\u7387\u5927\u4e8e 1%\u5c31\u89e6\u53d1\u544a\u8b66\uff0c\u540c\u6837\u91cd\u65b0\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u66f4\u65b0 Loki\uff1a \u66f4\u65b0\u5b8c\u6210\u540e\u6211\u4eec\u67e5\u770b Ruler \u7ec4\u4ef6\u7684\u65e5\u5fd7\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u5173\u4e8e\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u62a5\u8b66\u89c4\u5219\u7684\u4fe1\u606f\uff1a $ kubectl logs -f loki-loki-distributed-ruler-5d4b8cd889-m2vbd -n logging ...... level=info ts=2022-06-25T10:10:07.445554993Z caller=metrics.go:122 component=ruler org_id=tenant_no latency=fast query=\"((sum by(job)(rate({app=\\\"nginx\\\"} |= \\\"error\\\"[1m])) / sum by(job)(rate({app=\\\"nginx\\\"}[1m]))) > 0.01)\" query_type=metric range_type=instant length=0s step=0s duration=25.306079ms status=200 limit=0 returned_lines=0 throughput=0B total_bytes=0B queue_time=0s subqueries=1 level=info ts=2022-06-25T10:11:03.196836972Z caller=pool.go:171 msg=\"removing stale client\" addr=10.244.2.165:9095 level=info ts=2022-06-25T10:11:07.423644116Z caller=metrics.go:122 component=ruler org_id=tenant_no latency=fast query=\"((sum by(job)(rate({app=\\\"nginx\\\"} |= \\\"error\\\"[1m])) / sum by(job)(rate({app=\\\"nginx\\\"}[1m]))) > 0.01)\" query_type=metric range_type=instant length=0s step=0s duration=3.234499ms status=200 limit=0 returned_lines=0 throughput=0B total_bytes=0B queue_time=0s subqueries=1 \u540c\u6837\u5728 1m \u4e4b\u5185\u5982\u679c\u6301\u7eed\u8d85\u8fc7\u9608\u503c\uff0c\u5219\u4f1a\u771f\u6b63\u89e6\u53d1\u62a5\u8b66\u89c4\u5219\uff0c\u89e6\u53d1\u540e\u6211\u4eec\u5728 Alertmanager \u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u62a5\u8b66\u4fe1\u606f\u4e86\uff1a \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Loki \u57fa\u4e8e\u65e5\u5fd7\u7684\u76d1\u63a7\u62a5\u8b66\u3002","title":"kubernetes \u65e5\u5fd7\u62a5\u8b66"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/#_1","text":"","title":"\u65e5\u5fd7\u62a5\u8b66"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/#_2","text":"\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u4ee5\u53ca\u4e00\u4e2a\u6709\u8ffd\u6c42\u7684\u8fd0\u7ef4\u4eba\u5458\u6765\u8bf4\uff0c\u54ea\u6015\u662f\u6beb\u79d2\u7ea7\u522b\u7684\u5b95\u673a\u4e5f\u662f\u4e0d\u80fd\u5bb9\u5fcd\u7684\u3002\u5bf9\u57fa\u7840\u8bbe\u65bd\u53ca\u5e94\u7528\u8fdb\u884c\u9002\u5f53\u7684\u65e5\u5fd7\u8bb0\u5f55\u548c\u76d1\u63a7\u975e\u5e38\u6709\u52a9\u4e8e\u89e3\u51b3\u95ee\u9898\uff0c\u8fd8\u53ef\u4ee5\u5e2e\u52a9\u4f18\u5316\u6210\u672c\u548c\u8d44\u6e90\uff0c\u4ee5\u53ca\u5e2e\u52a9\u68c0\u6d4b\u4ee5\u540e\u53ef\u80fd\u4f1a\u53d1\u751f\u7684\u4e00\u4e9b\u95ee\u9898\u3002\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4f7f\u7528\u4e86 Prometheus \u6765\u8fdb\u884c\u76d1\u63a7\u62a5\u8b66\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u4f7f\u7528 Loki \u6536\u96c6\u65e5\u5fd7\u662f\u5426\u53ef\u4ee5\u6839\u636e\u91c7\u96c6\u7684\u65e5\u5fd7\u6765\u8fdb\u884c\u62a5\u8b66\u5462\uff1f\u7b54\u6848\u662f\u80af\u5b9a\u7684\uff0c\u800c\u4e14\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u6765\u5b9e\u73b0\uff1aPromtail \u4e2d\u7684 metrics \u9636\u6bb5\u548c Loki \u7684 ruler \u7ec4\u4ef6\u3002","title":"\u65e5\u5fd7\u62a5\u8b66"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/#_3","text":"\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u7684 nginx \u5e94\u7528\u7528\u4e8e Loki \u65e5\u5fd7\u62a5\u8b66\uff1a # nginx-deploy.yaml apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: nginx labels: app: nginx spec: ports: - name: nginx port: 80 protocol: TCP selector: app: nginx type: NodePort \u4e3a\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u6765\u66b4\u9732\u5e94\u7528\uff0c\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a $ kubectl apply -f nginx-deploy.yaml $ kubectl get pods NAME READY STATUS RESTARTS AGE nginx-5d59d67564-ll9xf 1/1 Running 0 16s $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 <none> 443/TCP 91d nginx NodePort 10.99.153.32 <none> 80:31313/TCP 22s \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u6765\u6a21\u62df\u6bcf\u9694 10s \u8bbf\u95ee Nginx \u5e94\u7528\uff1a $ while true; do curl --silent --output /dev/null --write-out '%{http_code}' http://192.168.0.106:31313; sleep 10; echo; done 200 200","title":"\u6d4b\u8bd5\u5e94\u7528"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/#metrics","text":"\u524d\u9762\u6211\u4eec\u63d0\u5230\u5728 Promtail \u4e2d\u901a\u8fc7\u4e00\u7cfb\u5217 Pipeline \u6765\u5904\u7406\u65e5\u5fd7\uff0c\u5176\u4e2d\u5c31\u5305\u62ec\u4e00\u4e2a metrics \u7684\u9636\u6bb5\uff0c\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u9700\u6c42\u6765\u589e\u52a0\u4e00\u4e2a\u76d1\u63a7\u6307\u6807\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u7684\u57fa\u4e8e\u65e5\u5fd7\u7684\u76d1\u63a7\u62a5\u8b66\u7684\u6838\u5fc3\u70b9\uff0c\u901a\u8fc7\u7ed3\u6784\u5316\u65e5\u5fd7\uff0c\u589e\u52a0\u76d1\u63a7\u6307\u6807\uff0c\u7136\u540e\u4f7f\u7528 Prometheus \u7ed3\u5408 Alertmanager \u5b8c\u6210\u4e4b\u524d\u6211\u4eec\u975e\u5e38\u719f\u6089\u7684\u76d1\u63a7\u62a5\u8b66\u3002 \u9996\u5148\u6211\u4eec\u9700\u8981\u5b89\u88c5 Prometheus \u4e0e Alertmanager\uff0c\u53ef\u4ee5\u624b\u52a8\u5b89\u88c5\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Prometheus Operator \u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u53c2\u8003 \u76d1\u63a7\u62a5\u8b66 \u7ae0\u8282\u76f8\u5173\u5185\u5bb9\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u9009\u62e9\u4f7f\u7528 Prometheus Operator \u7684\u65b9\u5f0f\u3002 \u524d\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86\u51e0\u79cd Loki \u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u4fdd\u7559\u4e0a\u8282\u5fae\u670d\u52a1\u6a21\u5f0f\u7684 Loki \u96c6\u7fa4\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u91cd\u65b0\u914d\u7f6e Promtail\uff0c\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a metrics \u5904\u7406\u9636\u6bb5\uff0c\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\u91cd\u65b0\u5b89\u88c5\u3002 # ci/metrics-values.yaml rbac: pspEnabled: false config: clients: - url: http://loki-loki-distributed-gateway/loki/api/v1/push snippets: pipelineStages: - cri: {} - match: selector: '{app=\"nginx\"}' stages: - regex: expression: \".*(?P<hits>GET /.*)\" - metrics: nginx_hits: type: Counter description: \"Total nginx requests\" source: hits config: action: inc serviceMonitor: enabled: true additionalLabels: app: prometheus-operator release: prometheus \u4e0a\u9762\u6700\u91cd\u8981\u7684\u90e8\u5206\u5c31\u662f\u4e3a Promtail \u6dfb\u52a0\u4e86 pipelineStages \u914d\u7f6e\uff0c\u7528\u4e8e\u5bf9\u65e5\u5fd7\u884c\u8fdb\u884c\u8f6c\u6362\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a match \u7684\u9636\u6bb5\uff0c\u4f1a\u53bb\u5339\u914d\u5177\u6709 app=nginx \u8fd9\u6837\u7684\u65e5\u5fd7\u6d41\u6570\u636e\uff0c\u7136\u540e\u4e0b\u4e00\u4e2a\u9636\u6bb5\u662f\u5229\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u8fc7\u6ee4\u51fa\u5305\u542b GET \u5173\u952e\u5b57\u7684\u65e5\u5fd7\u884c\u3002 \u5728 metrics \u6307\u6807\u9636\u6bb5\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a nginx_hits \u7684\u6307\u6807\uff0cPromtail \u901a\u8fc7\u5176 /metrics \u7aef\u70b9\u66b4\u9732\u8fd9\u4e2a\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u6570\u636e\u3002\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u7684\u662f\u4e00\u4e2a Counter \u7c7b\u578b\u7684\u6307\u6807\uff0c\u5f53\u4ece regex \u9636\u6bb5\u5339\u914d\u4e0a\u540e\uff0c\u8fd9\u4e2a\u8ba1\u6570\u5668\u5c31\u4f1a\u9012\u589e\u3002 \u4e3a\u4e86\u5728 Prometheus \u4e2d\u80fd\u591f\u8fd9\u4e2a\u6307\u6807\uff0c\u6211\u4eec\u901a\u8fc7 promtail.serviceMonitor.enable=true \u5f00\u542f\u4e86\u4e00\u4e2a ServiceMonitor\u3002\u63a5\u4e0b\u6765\u91cd\u65b0\u66f4\u65b0 Loki \u5e94\u7528\uff0c\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u5373\u53ef\uff1a $ helm upgrade --install loki -n logging -f ci/metrics-values.yaml . \u66f4\u65b0\u5b8c\u6210\u540e\u4f1a\u521b\u5efa\u4e00\u4e2a ServiceMonitor \u5bf9\u8c61\u7528\u4e8e\u53d1\u73b0 Promtail \u7684\u6307\u6807\u6570\u636e\uff1a $ kubectl get servicemonitor -n logging NAME AGE loki-promtail 10s \u5982\u679c\u4f60\u4f7f\u7528\u7684 Prometheus-Operator \u9ed8\u8ba4\u4e0d\u80fd\u53d1\u73b0 logging \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u6570\u636e\uff0c\u5219\u9700\u8981\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u4e00\u4e2a Role \u6743\u9650\uff1a apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: labels: app.kubernetes.io/component: prometheus app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 2.26.0 name: prometheus-k8s namespace: logging rules: - apiGroups: - \"\" resources: - services - endpoints - pods verbs: - get - list - watch - apiGroups: - extensions resources: - ingresses verbs: - get - list - watch - apiGroups: - networking.k8s.io resources: - ingresses verbs: - get - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: prometheus-k8s namespace: logging roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: prometheus-k8s subjects: - kind: ServiceAccount name: prometheus-k8s namespace: monitoring \u6b63\u5e38\u5728 Prometheus \u91cc\u9762\u5c31\u53ef\u4ee5\u770b\u5230 Promtail \u7684\u6293\u53d6\u76ee\u6807\u4e86\uff1a \u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f Prometheus Operator \u81ea\u5e26\u7684 Grafana\uff0c\u5219\u9700\u8981\u624b\u52a8\u6dfb\u52a0\u4e0a Loki \u7684\u6570\u636e\u6e90\uff0c\u524d\u9762\u5fae\u670d\u52a1\u6a21\u5f0f\u4e2d\u6211\u4eec\u5df2\u7ecf\u5728 Grafana \u4e2d\u914d\u7f6e\u4e86 Loki \u7684\u6570\u636e\u6e90\uff0c\u73b0\u5728\u5f53\u6211\u4eec\u8bbf\u95ee\u6d4b\u8bd5\u5e94\u7528\u7684\u65f6\u5019\uff0c\u5728 Loki \u4e2d\u662f\u53ef\u4ee5\u67e5\u770b\u5230\u65e5\u5fd7\u6570\u636e\u7684\uff1a \u800c\u4e14\u73b0\u5728\u5728 Prometheus \u4e2d\u8fd8\u53ef\u4ee5\u67e5\u8be2\u5230\u6211\u4eec\u5728 Promtail \u4e2d\u6dfb\u52a0\u7684 metrics \u6307\u6807\u6570\u636e\uff1a \u56e0\u4e3a\u73b0\u5728\u5df2\u7ecf\u6709\u76d1\u63a7\u6307\u6807\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u53ef\u4ee5\u6839\u636e\u9700\u6c42\u6765\u521b\u5efa\u62a5\u8b66\u89c4\u5219\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684 Prometheus Operator\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u4e00\u4e2a PrometheusRule \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a # nginx-prometheus-rule.yaml apiVersion: monitoring.coreos.com/v1 kind: PrometheusRule metadata: labels: prometheus: k8s role: alert-rules name: promtail-nginx-hits namespace: logging spec: groups: - name: nginx-hits rules: - alert: LokiNginxHits annotations: summary: nginx hits counter description: \"nginx_hits total insufficient count ({{ $value }}).\" expr: | sum(increase(promtail_custom_nginx_hits[1m])) > 2 for: 2m labels: severity: critical \u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e86\u540d\u4e3a nginx_hits \u7684\u62a5\u8b66\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u5728\u540c\u4e00\u4e2a\u5206\u7ec4\u4e2d\uff0c\u6bcf\u9694\u4e00\u5b9a\u7684\u65f6\u95f4\u95f4\u9694\u4f9d\u6b21\u6267\u884c\u3002\u89e6\u53d1\u62a5\u8b66\u7684\u9608\u503c\u901a\u8fc7 expr \u8868\u8fbe\u5f0f\u8fdb\u884c\u914d\u7f6e\u3002\u6211\u4eec\u8fd9\u91cc\u8868\u793a\u7684\u662f 1 \u5206\u949f\u4e4b\u5185\u65b0\u589e\u7684\u603b\u548c\u662f\u5426\u5927\u4e8e 2\uff0c\u5f53 expor \u8868\u8fbe\u5f0f\u7684\u6761\u4ef6\u6301\u7eed\u4e86 2 \u5206\u949f\u65f6\u95f4\u540e\uff0c\u62a5\u8b66\u5c31\u4f1a\u771f\u6b63\u88ab\u89e6\u53d1\uff0c\u62a5\u8b66\u771f\u6b63\u88ab\u89e6\u53d1\u4e4b\u524d\u4f1a\u4fdd\u6301\u4e3a Pending \u72b6\u6001\u3002 \u7136\u540e\u5177\u4f53\u60f3\u8981\u628a\u62a5\u8b66\u53d1\u9001\u5230\u4ec0\u4e48\u5730\u65b9\u53bb\uff0c\u53ef\u4ee5\u6839\u636e\u6807\u7b7e\u53bb\u914d\u7f6e receiver\uff0c\u6bd4\u5982\u53ef\u4ee5\u901a\u8fc7 WebHook \u6765\u63a5\u6536\u3002\u6211\u4eec\u5728 AlertManager \u4e2d\u4e5f\u662f\u53ef\u4ee5\u770b\u5230\u63a5\u6536\u5230\u7684\u62a5\u8b66\u4e8b\u4ef6\u7684\u3002","title":"metrics \u9636\u6bb5"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%8A%A5%E8%AD%A6/#ruler","text":"\u4e0a\u9762\u7684\u65b9\u5f0f\u867d\u7136\u53ef\u4ee5\u5b9e\u73b0\u6211\u4eec\u7684\u65e5\u5fd7\u62a5\u8b66\u529f\u80fd\uff0c\u4f46\u662f\u8fd8\u662f\u4e0d\u591f\u76f4\u63a5\uff0c\u9700\u8981\u901a\u8fc7 Promtail \u53bb\u8fdb\u884c\u5904\u7406\uff0c\u90a3\u4e48\u6211\u4eec\u80fd\u5426\u76f4\u63a5\u901a\u8fc7 Loki \u6765\u5b9e\u73b0\u62a5\u8b66\u529f\u80fd\u5462\uff1f\u5176\u5b9e\u5728 Loki2.0 \u7248\u672c\u5c31\u63d0\u4f9b\u4e86\u62a5\u8b66\u529f\u80fd\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a Ruler \u7ec4\u4ef6\u53ef\u4ee5\u6301\u7eed\u67e5\u8be2\u4e00\u4e2a rules \u89c4\u5219\uff0c\u5e76\u5c06\u8d85\u8fc7\u9608\u503c\u7684\u4e8b\u4ef6\u63a8\u9001\u7ed9 AlertManager \u6216\u8005\u5176\u4ed6 Webhook \u670d\u52a1\uff0c\u8fd9\u4e5f\u5c31\u662f Loki \u81ea\u5e26\u7684\u62a5\u8b66\u529f\u80fd\u4e86\uff0c\u800c\u4e14\u662f\u517c\u5bb9 AlertManager \u7684\u3002 \u9996\u5148\u6211\u4eec\u9700\u8981\u5f00\u542f Loki Ruler \u7ec4\u4ef6\uff0c\u66f4\u65b0 loki-distributed \u5b89\u88c5\u7684 Values \u6587\u4ef6\uff0c\u5728\u524d\u9762\u5fae\u670d\u52a1\u6a21\u5f0f\u7684\u57fa\u7840\u4e0a\u589e\u52a0 ruler \u7ec4\u4ef6\u914d\u7f6e\uff1a # ci/alert-values.yaml loki: structuredConfig: ingester: max_transfer_retries: 0 chunk_idle_period: 1h chunk_target_size: 1536000 max_chunk_age: 1h storage_config: # \u5b58\u50a8\u7684\u914d\u7f6e\uff0c\u5b9a\u4e49\u5176\u4ed6\u7ec4\u4ef6\u53ef\u80fd\u7528\u5230\u7684\u5b58\u50a8 aws: # s3 / s3 \u517c\u5bb9\u7684\u5bf9\u8c61\u5b58\u50a8 endpoint: minio.logging.svc.cluster.local:9000 insecure: true bucketnames: loki-data access_key_id: myaccessKey secret_access_key: mysecretKey s3forcepathstyle: true boltdb_shipper: shared_store: s3 schema_config: configs: - from: 2022-06-21 store: boltdb-shipper # index object_store: s3 # chunks schema: v12 index: prefix: loki_index_ period: 24h ruler: storage: type: local local: directory: /etc/loki/rules ring: kvstore: store: memberlist rule_path: /tmp/loki/scratch alertmanager_url: http://alertmanager-main.monitoring.svc.cluster.local:9093 external_url: http:/192.168.0.106\uff1a31918 distributor: replicas: 2 ingester: # WAL\uff08replay\uff09 replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path querier: replicas: 2 persistence: enabled: true size: 1Gi storageClass: local-path queryFrontend: replicas: 2 gateway: # nginx\u5bb9\u5668 -> \u8def\u7531\u65e5\u5fd7\u5199/\u8bfb\u7684\u8bf7\u6c42 nginxConfig: httpSnippet: |- client_max_body_size 100M; serverSnippet: |- client_max_body_size 100M; # Configuration for the ruler ruler: enabled: true kind: Deployment replicas: 1 persistence: enabled: true size: 1Gi storageClass: local-path # -- Directories containing rules files directories: tenant_no: rules1.txt: | groups: - name: nginx-rate rules: - alert: LokiNginxRate expr: sum(rate({app=\"nginx\"} |= \"error\" [1m])) by (job) / sum(rate({app=\"nginx\"}[1m])) by (job) > 0.01 for: 1m labels: severity: critical annotations: summary: loki nginx rate description: high request latency \u6211\u4eec\u9996\u5148\u901a\u8fc7 loki.structuredConfig.ruler \u5bf9 Ruler \u7ec4\u4ef6\u8fdb\u884c\u914d\u7f6e\uff0c\u6bd4\u5982\u6307\u5b9a Alertmanager \u7684\u5730\u5740\uff0c\u89c4\u5219\u5b58\u50a8\u65b9\u5f0f\u7b49\uff0c\u7136\u540e\u901a\u8fc7 ruler \u5c5e\u6027\u914d\u7f6e\u4e86\u7ec4\u4ef6\u7684\u76f8\u5173\u4fe1\u606f\u4ee5\u53ca\u62a5\u8b66\u89c4\u5219\uff0c\u91cd\u65b0\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 Loki\uff1a $ helm upgrade --install loki -n logging -f ci/alert-values.yaml . $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE grafana-55d8779dc6-gkgpf 1/1 Running 2 (66m ago) 3d21h loki-loki-distributed-distributor-56959cc548-xpv6d 1/1 Running 0 3m36s loki-loki-distributed-distributor-56959cc548-zjfsb 1/1 Running 0 2m52s loki-loki-distributed-gateway-6f4cfd898c-p9xxf 1/1 Running 0 21m loki-loki-distributed-ingester-0 1/1 Running 0 2m32s loki-loki-distributed-ingester-1 1/1 Running 0 3m34s loki-loki-distributed-querier-0 1/1 Running 0 2m48s loki-loki-distributed-querier-1 1/1 Running 0 3m29s loki-loki-distributed-query-frontend-5bcc7949d-brzg6 1/1 Running 0 3m30s loki-loki-distributed-query-frontend-5bcc7949d-g2wwd 1/1 Running 0 3m35s loki-loki-distributed-ruler-5d4b8cd889-m2vbd 1/1 Running 0 3m35s minio-548656f786-mjd4c 1/1 Running 2 (66m ago) 3d21h promtail-ddz27 1/1 Running 0 19m promtail-lzr6v 1/1 Running 0 20m promtail-nldqx 1/1 Running 0 20m Loki \u7684 rulers \u89c4\u5219\u548c\u7ed3\u6784\u4e0e Prometheus \u662f\u5b8c\u5168\u517c\u5bb9\uff0c\u552f\u4e00\u7684\u533a\u522b\u5728\u4e8e\u67e5\u8be2\u8bed\u53e5\uff08LogQL\uff09\u4e0d\u540c\uff0c\u5728 Loki \u4e2d\u6211\u4eec\u7528 LogQL \u6765\u67e5\u8be2\u65e5\u5fd7\uff0c\u4e00\u4e2a\u5178\u578b\u7684 rules \u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a groups: # \u7ec4\u540d\u79f0 - name: xxxx rules: # Alert\u540d\u79f0 - alert: xxxx # logQL\u67e5\u8be2\u8bed\u53e5 expr: xxxx # \u4ea7\u751f\u544a\u8b66\u7684\u6301\u7eed\u65f6\u95f4 pending. [ for: | default = 0s ] # \u81ea\u5b9a\u4e49\u544a\u8b66\u4e8b\u4ef6\u7684label labels: [ : ] # \u544a\u8b66\u65f6\u95f4\u7684\u6ce8\u91ca annotations: [ : ] \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u7684\u89c4\u5219 sum(rate({app=\"nginx\"} |= \"error\" [1m])) by (job) / sum(rate({app=\"nginx\"}[1m])) by (job) > 0.01 \u8868\u793a\u901a\u8fc7\u65e5\u5fd7\u67e5\u5230 nginx \u65e5\u5fd7\u7684\u9519\u8bef\u7387\u5927\u4e8e 1%\u5c31\u89e6\u53d1\u544a\u8b66\uff0c\u540c\u6837\u91cd\u65b0\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u66f4\u65b0 Loki\uff1a \u66f4\u65b0\u5b8c\u6210\u540e\u6211\u4eec\u67e5\u770b Ruler \u7ec4\u4ef6\u7684\u65e5\u5fd7\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u5173\u4e8e\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u62a5\u8b66\u89c4\u5219\u7684\u4fe1\u606f\uff1a $ kubectl logs -f loki-loki-distributed-ruler-5d4b8cd889-m2vbd -n logging ...... level=info ts=2022-06-25T10:10:07.445554993Z caller=metrics.go:122 component=ruler org_id=tenant_no latency=fast query=\"((sum by(job)(rate({app=\\\"nginx\\\"} |= \\\"error\\\"[1m])) / sum by(job)(rate({app=\\\"nginx\\\"}[1m]))) > 0.01)\" query_type=metric range_type=instant length=0s step=0s duration=25.306079ms status=200 limit=0 returned_lines=0 throughput=0B total_bytes=0B queue_time=0s subqueries=1 level=info ts=2022-06-25T10:11:03.196836972Z caller=pool.go:171 msg=\"removing stale client\" addr=10.244.2.165:9095 level=info ts=2022-06-25T10:11:07.423644116Z caller=metrics.go:122 component=ruler org_id=tenant_no latency=fast query=\"((sum by(job)(rate({app=\\\"nginx\\\"} |= \\\"error\\\"[1m])) / sum by(job)(rate({app=\\\"nginx\\\"}[1m]))) > 0.01)\" query_type=metric range_type=instant length=0s step=0s duration=3.234499ms status=200 limit=0 returned_lines=0 throughput=0B total_bytes=0B queue_time=0s subqueries=1 \u540c\u6837\u5728 1m \u4e4b\u5185\u5982\u679c\u6301\u7eed\u8d85\u8fc7\u9608\u503c\uff0c\u5219\u4f1a\u771f\u6b63\u89e6\u53d1\u62a5\u8b66\u89c4\u5219\uff0c\u89e6\u53d1\u540e\u6211\u4eec\u5728 Alertmanager \u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u62a5\u8b66\u4fe1\u606f\u4e86\uff1a \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Loki \u57fa\u4e8e\u65e5\u5fd7\u7684\u76d1\u63a7\u62a5\u8b66\u3002","title":"Ruler \u7ec4\u4ef6"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/","text":"\u65e5\u5fd7\u6536\u96c6\u67b6\u6784 \u00b6 \u65e5\u5fd7\u6536\u96c6\u67b6\u6784 \u00b6 \u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u76d1\u63a7\u7cfb\u7edf\u7684\u642d\u5efa\uff0c\u9664\u4e86\u5bf9\u96c6\u7fa4\u7684\u76d1\u63a7\u62a5\u8b66\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u9879\u8fd0\u7ef4\u5de5\u4f5c\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u90a3\u5c31\u662f\u65e5\u5fd7\u7684\u6536\u96c6\u3002 \u5e94\u7528\u7a0b\u5e8f\u548c\u7cfb\u7edf\u65e5\u5fd7\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u96c6\u7fa4\u5185\u90e8\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u65e5\u5fd7\u5bf9\u4e8e\u6211\u4eec\u8c03\u8bd5\u95ee\u9898\u548c\u76d1\u89c6\u96c6\u7fa4\u60c5\u51b5\u4e5f\u662f\u975e\u5e38\u6709\u7528\u7684\u3002\u800c\u4e14\u5927\u90e8\u5206\u7684\u5e94\u7528\u90fd\u4f1a\u6709\u65e5\u5fd7\u8bb0\u5f55\uff0c\u5bf9\u4e8e\u4f20\u7edf\u7684\u5e94\u7528\u5927\u90e8\u5206\u90fd\u4f1a\u5199\u5165\u5230\u672c\u5730\u7684\u65e5\u5fd7\u6587\u4ef6\u4e4b\u4e2d\u3002\u5bf9\u4e8e\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u5219\u66f4\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5c06\u65e5\u5fd7\u4fe1\u606f\u5199\u5165\u5230 stdout \u548c stderr \u5373\u53ef\uff0c\u5bb9\u5668\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u4f1a\u628a\u8fd9\u4e9b\u65e5\u5fd7\u8f93\u51fa\u5230\u5bbf\u4e3b\u673a\u4e0a\u7684\u4e00\u4e2a JSON \u6587\u4ef6\u4e4b\u4e2d\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 docker logs \u6216\u8005 kubectl logs \u6765\u67e5\u770b\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u4fe1\u606f\u3002 \u4f46\u662f\uff0c\u901a\u5e38\u6765\u8bf4\u5bb9\u5668\u5f15\u64ce\u6216\u8fd0\u884c\u65f6\u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u8db3\u4ee5\u8bb0\u5f55\u5b8c\u6574\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u5bb9\u5668\u5d29\u6e83\u4e86\u3001Pod \u88ab\u9a71\u9010\u4e86\u6216\u8005\u8282\u70b9\u6302\u6389\u4e86\uff0c\u6211\u4eec\u4ecd\u7136\u4e5f\u5e0c\u671b\u8bbf\u95ee\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u65e5\u5fd7\u5e94\u8be5\u72ec\u7acb\u4e8e\u8282\u70b9\u3001Pod \u6216\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\uff0c\u8fd9\u79cd\u8bbe\u8ba1\u65b9\u5f0f\u88ab\u79f0\u4e3a cluster-level-logging \uff0c\u5373\u5b8c\u5168\u72ec\u7acb\u4e8e Kubernetes \u7cfb\u7edf\uff0c\u9700\u8981\u81ea\u5df1\u63d0\u4f9b\u5355\u72ec\u7684\u65e5\u5fd7\u540e\u7aef\u5b58\u50a8\u3001\u5206\u6790\u548c\u67e5\u8be2\u5de5\u5177\u3002 Kubernetes \u4e2d\u7684\u57fa\u672c\u65e5\u5fd7 \u00b6 \u4e0b\u9762\u8fd9\u4e2a\u793a\u4f8b\u662f Kubernetes \u4e2d\u7684\u4e00\u4e2a\u57fa\u672c\u65e5\u5fd7\u8bb0\u5f55\u7684\u793a\u4f8b\uff0c\u76f4\u63a5\u5c06\u6570\u636e\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa\u6d41\uff0c\u5982\u4e0b\uff1a apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: [ /bin/sh, -c, 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done', ] \u5c06\u4e0a\u9762\u6587\u4ef6\u4fdd\u5b58\u4e3a counter-pod.yaml\uff0c\u8be5 Pod \u6bcf\u79d2\u8f93\u51fa\u4e00\u4e9b\u6587\u672c\u4fe1\u606f\uff0c\u521b\u5efa\u8fd9\u4e2a Pod\uff1a $ kubectl apply -f counter-pod.yaml pod \"counter\" created \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u547d\u4ee4\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff1a $ kubectl logs counter 0: Thu Dec 27 15:47:04 UTC 2018 1: Thu Dec 27 15:47:05 UTC 2018 2: Thu Dec 27 15:47:06 UTC 2018 3: Thu Dec 27 15:47:07 UTC 2018 ...... Kubernetes \u65e5\u5fd7\u6536\u96c6 \u00b6 Kubernetes \u96c6\u7fa4\u672c\u8eab\u4e0d\u63d0\u4f9b\u65e5\u5fd7\u6536\u96c6\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4e00\u822c\u6765\u8bf4\u6709\u4e3b\u8981\u7684 3 \u79cd\u65b9\u6848\u6765\u505a\u65e5\u5fd7\u6536\u96c6\uff1a \u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a agent \u6765\u6536\u96c6\u65e5\u5fd7 \u5728 Pod \u4e2d\u5305\u542b\u4e00\u4e2a sidecar \u5bb9\u5668\u6765\u6536\u96c6\u5e94\u7528\u65e5\u5fd7 \u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c06\u65e5\u5fd7\u4fe1\u606f\u63a8\u9001\u5230\u91c7\u96c6\u540e\u7aef \u8282\u70b9\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406 \u00b6 \u901a\u8fc7\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 agent \u6765\u91c7\u96c6\u65e5\u5fd7\u6570\u636e\uff0c\u65e5\u5fd7\u91c7\u96c6 agent \u662f\u4e00\u79cd\u4e13\u7528\u5de5\u5177\uff0c\u7528\u4e8e\u5c06\u65e5\u5fd7\u6570\u636e\u63a8\u9001\u5230\u7edf\u4e00\u7684\u540e\u7aef\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u8fd9\u79cd agent \u7528\u4e00\u4e2a\u5bb9\u5668\u6765\u8fd0\u884c\uff0c\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8282\u70b9\u4e0a\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u5fd7\u6587\u4ef6\u6240\u5728\u76ee\u5f55\u3002 \u7531\u4e8e\u8fd9\u79cd agent \u5fc5\u987b\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u76f4\u63a5\u4f7f\u7528 DaemonSet \u63a7\u5236\u5668\u8fd0\u884c\u8be5\u5e94\u7528\u7a0b\u5e8f\u5373\u53ef\u3002\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 agent \u8fd9\u79cd\u65b9\u5f0f\u662f\u6700\u5e38\u89c1\u7684\u4e00\u79cd\u65b9\u6cd5\uff0c\u56e0\u4e3a\u5b83\u53ea\u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u4ee3\u7406\u7a0b\u5e8f\uff0c\u5e76\u4e0d\u9700\u8981\u5bf9\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u66f4\u6539\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6ca1\u6709\u4efb\u4f55\u4fb5\u5165\u6027\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u6cd5\u4e5f\u4ec5\u4ec5\u9002\u7528\u4e8e\u6536\u96c6\u8f93\u51fa\u5230 stdout \u548c stderr \u7684\u5e94\u7528\u7a0b\u5e8f\u65e5\u5fd7\u3002 \u4ee5 sidecar \u5bb9\u5668\u6536\u96c6\u65e5\u5fd7 \u00b6 \u6211\u4eec\u770b\u4e0a\u9762\u7684\u56fe\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u660e\u663e\u7684\u95ee\u9898\u5c31\u662f\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u90fd\u662f\u901a\u8fc7\u8f93\u51fa\u5230\u5bb9\u5668\u7684 stdout \u548c stderr \u91cc\u9762\u7684\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u4f1a\u5728\u672c\u5730\u7684\u5bb9\u5668\u5bf9\u5e94\u76ee\u5f55\u4e2d\u4fdd\u7559\u6210 JSON \u65e5\u5fd7\u6587\u4ef6\uff0c\u6240\u4ee5\u76f4\u63a5\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a agent \u5c31\u53ef\u4ee5\u91c7\u96c6\u5230\u65e5\u5fd7\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u662f\u8f93\u51fa\u5230\u5bb9\u5668\u4e2d\u7684\u67d0\u4e2a\u65e5\u5fd7\u6587\u4ef6\u7684\u8bdd\u5462\uff1f\u8fd9\u79cd\u65e5\u5fd7\u6570\u636e\u663e\u7136\u53ea\u901a\u8fc7\u4e0a\u9762\u7684\u65b9\u6848\u662f\u91c7\u96c6\u4e0d\u5230\u7684\u4e86\u3002 \u7528 sidecar \u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u65e5\u5fd7 \u00b6 \u5bf9\u4e8e\u4e0a\u9762\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 Pod \u4e2d\u542f\u52a8\u53e6\u5916\u4e00\u4e2a sidecar \u5bb9\u5668\uff0c\u76f4\u63a5\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u901a\u8fc7\u8fd9\u4e2a\u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u5230 stdout\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u901a\u8fc7\u4e0a\u9762\u7684\u8282\u70b9\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\u53c8\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002 \u7531\u4e8e\u8fd9\u4e2a sidecar \u5bb9\u5668\u7684\u4e3b\u8981\u903b\u8f91\u5c31\u662f\u5c06\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u91cd\u5b9a\u5411\u6253\u5370\uff0c\u6240\u4ee5\u80cc\u540e\u7684\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff0c\u5f00\u9500\u5f88\u5c0f\uff0c\u800c\u4e14\u7531\u4e8e\u8f93\u51fa\u5230\u4e86 stdout \u6216\u8005 stderr\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u6765\u67e5\u770b\u65e5\u5fd7\u4e86\u3002 \u4e0b\u9762\u7684\u793a\u4f8b\u662f\u5728 Pod \u4e2d\u5c06\u65e5\u5fd7\u8bb0\u5f55\u5728\u4e86\u5bb9\u5668\u7684\u4e24\u4e2a\u672c\u5730\u6587\u4ef6\u4e4b\u4e2d\uff1a apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts: - name: varlog mountPath: /var/log volumes: - name: varlog emptyDir: {} \u7531\u4e8e Pod \u4e2d\u5bb9\u5668\u7684\u7279\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u53e6\u5916\u4e00\u4e2a sidecar \u5bb9\u5668\u53bb\u83b7\u53d6\u5230\u53e6\u5916\u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u91cd\u5b9a\u5411\u5230\u81ea\u5df1\u7684 stdout \u6d41\u4e2d\uff0c\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u505a\u5982\u4e0b\u4fee\u6539\uff1a\uff08two-files-counter-pod-streaming-sidecar.yaml\uff09 apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts: - name: varlog mountPath: /var/log - name: count-log-1 image: busybox args: [/bin/sh, -c, \"tail -n+1 -f /var/log/1.log\"] volumeMounts: - name: varlog mountPath: /var/log - name: count-log-2 image: busybox args: [/bin/sh, -c, \"tail -n+1 -f /var/log/2.log\"] volumeMounts: - name: varlog mountPath: /var/log volumes: - name: varlog emptyDir: {} \u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a $ kubectl apply -f two-files-counter-pod-streaming-sidecar.yaml pod \"counter\" created \u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b\u65e5\u5fd7\u7684\u4fe1\u606f\uff1a $ kubectl logs counter count-log-1 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ... $ kubectl logs counter count-log-2 Mon Jan 1 00:00:00 UTC 2001 INFO 0 Mon Jan 1 00:00:01 UTC 2001 INFO 1 Mon Jan 1 00:00:02 UTC 2001 INFO 2 ... \u8fd9\u6837\u524d\u9762\u8282\u70b9\u4e0a\u7684\u65e5\u5fd7\u91c7\u96c6 agent \u5c31\u53ef\u4ee5\u81ea\u52a8\u83b7\u53d6\u8fd9\u4e9b\u65e5\u5fd7\u4fe1\u606f\uff0c\u800c\u4e0d\u9700\u8981\u5176\u4ed6\u914d\u7f6e\u3002 \u8fd9\u79cd\u65b9\u6cd5\u867d\u7136\u53ef\u4ee5\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u660e\u663e\u7684\u7f3a\u9677\uff0c\u5c31\u662f\u65e5\u5fd7\u4e0d\u4ec5\u4f1a\u5728\u539f\u5bb9\u5668\u6587\u4ef6\u4e2d\u4fdd\u7559\u4e0b\u6765\uff0c\u8fd8\u4f1a\u901a\u8fc7 stdout \u8f93\u51fa\u540e\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\uff0c\u8fd9\u6837\u65e0\u5f62\u4e2d\u5c31\u589e\u52a0\u4e86\u4e00\u500d\u78c1\u76d8\u7a7a\u95f4\u3002 \u4f7f\u7528 sidecar \u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6 agent \u00b6 \u5982\u679c\u4f60\u89c9\u5f97\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u91c7\u96c6\u7684\u4ee3\u7406\u4e0d\u591f\u7075\u6d3b\u7684\u8bdd\uff0c\u90a3\u4e48\u4f60\u4e5f\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u7684 sidecar \u5bb9\u5668\uff0c\u4e0d\u8fc7\u9700\u8981\u5355\u72ec\u914d\u7f6e\u548c\u5e94\u7528\u7a0b\u5e8f\u4e00\u8d77\u8fd0\u884c\u3002 \u4e0d\u8fc7\u8fd9\u6837\u867d\u7136\u66f4\u52a0\u7075\u6d3b\uff0c\u4f46\u662f\u5728 sidecar \u5bb9\u5668\u4e2d\u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u4f1a\u5bfc\u81f4\u5927\u91cf\u8d44\u6e90\u6d88\u8017\uff0c\u56e0\u4e3a\u4f60\u6709\u591a\u5c11\u4e2a\u8981\u91c7\u96c6\u7684 Pod\uff0c\u5c31\u9700\u8981\u8fd0\u884c\u591a\u5c11\u4e2a\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\uff0c\u53e6\u5916\u8fd8\u65e0\u6cd5\u4f7f\u7528 kubectl logs \u547d\u4ee4\u6765\u8bbf\u95ee\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u53d7 kubelet \u63a7\u5236\u3002 \u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684 Stackdriver\uff0c\u5b83\u4f7f\u7528 fluentd \u4f5c\u4e3a\u8bb0\u5f55\u5242\u3002\u4ee5\u4e0b\u662f\u4e24\u4e2a\u53ef\u7528\u4e8e\u5b9e\u73b0\u6b64\u65b9\u6cd5\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u7b2c\u4e00\u4e2a\u6587\u4ef6\u5305\u542b\u914d\u7f6e\u6d41\u5229\u7684 ConfigMap\u3002 \u4e0b\u9762\u662f Kubernetes \u5b98\u65b9\u7684\u4e00\u4e2a fluentd \u7684\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\uff0c\u4f7f\u7528 ConfigMap \u5bf9\u8c61\u6765\u4fdd\u5b58\uff1a apiVersion: v1 kind: ConfigMap metadata: name: fluentd-config data: fluentd.conf: | <source> type tail format none path /var/log/1.log pos_file /var/log/1.log.pos tag count.format1 </source> <source> type tail format none path /var/log/2.log pos_file /var/log/2.log.pos tag count.format2 </source> <match **> type google_cloud </match> \u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u914d\u7f6e\u6536\u96c6\u539f\u6587\u4ef6 /var/log/1.log \u548c /var/log/2.log \u7684\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7 google_cloud \u8fd9\u4e2a\u63d2\u4ef6\u5c06\u6570\u636e\u63a8\u9001\u5230 Stackdriver \u540e\u7aef\u53bb\u3002 \u4e0b\u9762\u662f\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8fd0\u884c\u4e00\u4e2a fluentd \u7684\u5bb9\u5668\u6765\u8bfb\u53d6\u65e5\u5fd7\u6570\u636e\uff1a apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts: - name: varlog mountPath: /var/log - name: count-agent image: k8s.gcr.io/fluentd-gcp:1.30 env: - name: FLUENTD_ARGS value: -c /etc/fluentd-config/fluentd.conf volumeMounts: - name: varlog mountPath: /var/log - name: config-volume mountPath: /etc/fluentd-config volumes: - name: varlog emptyDir: {} - name: config-volume configMap: name: fluentd-config \u4e0a\u9762\u7684 Pod \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5bb9\u5668 count-agent \u5c31\u4f1a\u5c06 count \u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\u7136\u540e\u4e0a\u4f20\u3002\u5f53\u7136\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u7684\u4efb\u4f55\u65e5\u5fd7\u91c7\u96c6\u5de5\u5177\u6765\u66ff\u6362 fluentd\uff0c\u6bd4\u5982 logstash\u3001fluent-bit \u7b49\u7b49\u3002 \u76f4\u63a5\u4ece\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u65e5\u5fd7 \u00b6 \u9664\u4e86\u4e0a\u9762\u7684\u51e0\u79cd\u65b9\u6848\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u53bb\u663e\u793a\u7684\u5c06\u65e5\u5fd7\u63a8\u9001\u5230\u65e5\u5fd7\u540e\u7aef\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u9700\u8981\u4ee3\u7801\u5c42\u9762\u7684\u5b9e\u73b0\uff0c\u4e5f\u8d85\u51fa\u4e86 Kubernetes \u672c\u8eab\u7684\u8303\u56f4\u3002\u4e0b\u8282\u8bfe\u6211\u4eec\u7ed9\u5927\u5bb6\u6f14\u793a\u4e0b\u5177\u4f53\u7684\u65e5\u5fd7\u6536\u96c6\u7684\u64cd\u4f5c\u65b9\u6cd5\u3002","title":"kubernete \u65e5\u5fd7\u67b6\u6784"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#_1","text":"","title":"\u65e5\u5fd7\u6536\u96c6\u67b6\u6784"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#_2","text":"\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 Kubernetes \u96c6\u7fa4\u4e2d\u76d1\u63a7\u7cfb\u7edf\u7684\u642d\u5efa\uff0c\u9664\u4e86\u5bf9\u96c6\u7fa4\u7684\u76d1\u63a7\u62a5\u8b66\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u9879\u8fd0\u7ef4\u5de5\u4f5c\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u90a3\u5c31\u662f\u65e5\u5fd7\u7684\u6536\u96c6\u3002 \u5e94\u7528\u7a0b\u5e8f\u548c\u7cfb\u7edf\u65e5\u5fd7\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u96c6\u7fa4\u5185\u90e8\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u65e5\u5fd7\u5bf9\u4e8e\u6211\u4eec\u8c03\u8bd5\u95ee\u9898\u548c\u76d1\u89c6\u96c6\u7fa4\u60c5\u51b5\u4e5f\u662f\u975e\u5e38\u6709\u7528\u7684\u3002\u800c\u4e14\u5927\u90e8\u5206\u7684\u5e94\u7528\u90fd\u4f1a\u6709\u65e5\u5fd7\u8bb0\u5f55\uff0c\u5bf9\u4e8e\u4f20\u7edf\u7684\u5e94\u7528\u5927\u90e8\u5206\u90fd\u4f1a\u5199\u5165\u5230\u672c\u5730\u7684\u65e5\u5fd7\u6587\u4ef6\u4e4b\u4e2d\u3002\u5bf9\u4e8e\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u5219\u66f4\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5c06\u65e5\u5fd7\u4fe1\u606f\u5199\u5165\u5230 stdout \u548c stderr \u5373\u53ef\uff0c\u5bb9\u5668\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u4f1a\u628a\u8fd9\u4e9b\u65e5\u5fd7\u8f93\u51fa\u5230\u5bbf\u4e3b\u673a\u4e0a\u7684\u4e00\u4e2a JSON \u6587\u4ef6\u4e4b\u4e2d\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 docker logs \u6216\u8005 kubectl logs \u6765\u67e5\u770b\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u4fe1\u606f\u3002 \u4f46\u662f\uff0c\u901a\u5e38\u6765\u8bf4\u5bb9\u5668\u5f15\u64ce\u6216\u8fd0\u884c\u65f6\u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u8db3\u4ee5\u8bb0\u5f55\u5b8c\u6574\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u5bb9\u5668\u5d29\u6e83\u4e86\u3001Pod \u88ab\u9a71\u9010\u4e86\u6216\u8005\u8282\u70b9\u6302\u6389\u4e86\uff0c\u6211\u4eec\u4ecd\u7136\u4e5f\u5e0c\u671b\u8bbf\u95ee\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u65e5\u5fd7\u5e94\u8be5\u72ec\u7acb\u4e8e\u8282\u70b9\u3001Pod \u6216\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\uff0c\u8fd9\u79cd\u8bbe\u8ba1\u65b9\u5f0f\u88ab\u79f0\u4e3a cluster-level-logging \uff0c\u5373\u5b8c\u5168\u72ec\u7acb\u4e8e Kubernetes \u7cfb\u7edf\uff0c\u9700\u8981\u81ea\u5df1\u63d0\u4f9b\u5355\u72ec\u7684\u65e5\u5fd7\u540e\u7aef\u5b58\u50a8\u3001\u5206\u6790\u548c\u67e5\u8be2\u5de5\u5177\u3002","title":"\u65e5\u5fd7\u6536\u96c6\u67b6\u6784"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#kubernetes","text":"\u4e0b\u9762\u8fd9\u4e2a\u793a\u4f8b\u662f Kubernetes \u4e2d\u7684\u4e00\u4e2a\u57fa\u672c\u65e5\u5fd7\u8bb0\u5f55\u7684\u793a\u4f8b\uff0c\u76f4\u63a5\u5c06\u6570\u636e\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa\u6d41\uff0c\u5982\u4e0b\uff1a apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: [ /bin/sh, -c, 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done', ] \u5c06\u4e0a\u9762\u6587\u4ef6\u4fdd\u5b58\u4e3a counter-pod.yaml\uff0c\u8be5 Pod \u6bcf\u79d2\u8f93\u51fa\u4e00\u4e9b\u6587\u672c\u4fe1\u606f\uff0c\u521b\u5efa\u8fd9\u4e2a Pod\uff1a $ kubectl apply -f counter-pod.yaml pod \"counter\" created \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u547d\u4ee4\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff1a $ kubectl logs counter 0: Thu Dec 27 15:47:04 UTC 2018 1: Thu Dec 27 15:47:05 UTC 2018 2: Thu Dec 27 15:47:06 UTC 2018 3: Thu Dec 27 15:47:07 UTC 2018 ......","title":"Kubernetes \u4e2d\u7684\u57fa\u672c\u65e5\u5fd7"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#kubernetes_1","text":"Kubernetes \u96c6\u7fa4\u672c\u8eab\u4e0d\u63d0\u4f9b\u65e5\u5fd7\u6536\u96c6\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4e00\u822c\u6765\u8bf4\u6709\u4e3b\u8981\u7684 3 \u79cd\u65b9\u6848\u6765\u505a\u65e5\u5fd7\u6536\u96c6\uff1a \u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a agent \u6765\u6536\u96c6\u65e5\u5fd7 \u5728 Pod \u4e2d\u5305\u542b\u4e00\u4e2a sidecar \u5bb9\u5668\u6765\u6536\u96c6\u5e94\u7528\u65e5\u5fd7 \u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c06\u65e5\u5fd7\u4fe1\u606f\u63a8\u9001\u5230\u91c7\u96c6\u540e\u7aef","title":"Kubernetes \u65e5\u5fd7\u6536\u96c6"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#_3","text":"\u901a\u8fc7\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 agent \u6765\u91c7\u96c6\u65e5\u5fd7\u6570\u636e\uff0c\u65e5\u5fd7\u91c7\u96c6 agent \u662f\u4e00\u79cd\u4e13\u7528\u5de5\u5177\uff0c\u7528\u4e8e\u5c06\u65e5\u5fd7\u6570\u636e\u63a8\u9001\u5230\u7edf\u4e00\u7684\u540e\u7aef\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u8fd9\u79cd agent \u7528\u4e00\u4e2a\u5bb9\u5668\u6765\u8fd0\u884c\uff0c\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8282\u70b9\u4e0a\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u5fd7\u6587\u4ef6\u6240\u5728\u76ee\u5f55\u3002 \u7531\u4e8e\u8fd9\u79cd agent \u5fc5\u987b\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u76f4\u63a5\u4f7f\u7528 DaemonSet \u63a7\u5236\u5668\u8fd0\u884c\u8be5\u5e94\u7528\u7a0b\u5e8f\u5373\u53ef\u3002\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 agent \u8fd9\u79cd\u65b9\u5f0f\u662f\u6700\u5e38\u89c1\u7684\u4e00\u79cd\u65b9\u6cd5\uff0c\u56e0\u4e3a\u5b83\u53ea\u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u4ee3\u7406\u7a0b\u5e8f\uff0c\u5e76\u4e0d\u9700\u8981\u5bf9\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u66f4\u6539\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6ca1\u6709\u4efb\u4f55\u4fb5\u5165\u6027\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u6cd5\u4e5f\u4ec5\u4ec5\u9002\u7528\u4e8e\u6536\u96c6\u8f93\u51fa\u5230 stdout \u548c stderr \u7684\u5e94\u7528\u7a0b\u5e8f\u65e5\u5fd7\u3002","title":"\u8282\u70b9\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#sidecar","text":"\u6211\u4eec\u770b\u4e0a\u9762\u7684\u56fe\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u660e\u663e\u7684\u95ee\u9898\u5c31\u662f\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u90fd\u662f\u901a\u8fc7\u8f93\u51fa\u5230\u5bb9\u5668\u7684 stdout \u548c stderr \u91cc\u9762\u7684\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u4f1a\u5728\u672c\u5730\u7684\u5bb9\u5668\u5bf9\u5e94\u76ee\u5f55\u4e2d\u4fdd\u7559\u6210 JSON \u65e5\u5fd7\u6587\u4ef6\uff0c\u6240\u4ee5\u76f4\u63a5\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a agent \u5c31\u53ef\u4ee5\u91c7\u96c6\u5230\u65e5\u5fd7\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u662f\u8f93\u51fa\u5230\u5bb9\u5668\u4e2d\u7684\u67d0\u4e2a\u65e5\u5fd7\u6587\u4ef6\u7684\u8bdd\u5462\uff1f\u8fd9\u79cd\u65e5\u5fd7\u6570\u636e\u663e\u7136\u53ea\u901a\u8fc7\u4e0a\u9762\u7684\u65b9\u6848\u662f\u91c7\u96c6\u4e0d\u5230\u7684\u4e86\u3002","title":"\u4ee5 sidecar \u5bb9\u5668\u6536\u96c6\u65e5\u5fd7"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#sidecar_1","text":"\u5bf9\u4e8e\u4e0a\u9762\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 Pod \u4e2d\u542f\u52a8\u53e6\u5916\u4e00\u4e2a sidecar \u5bb9\u5668\uff0c\u76f4\u63a5\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u901a\u8fc7\u8fd9\u4e2a\u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u5230 stdout\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u901a\u8fc7\u4e0a\u9762\u7684\u8282\u70b9\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\u53c8\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002 \u7531\u4e8e\u8fd9\u4e2a sidecar \u5bb9\u5668\u7684\u4e3b\u8981\u903b\u8f91\u5c31\u662f\u5c06\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u91cd\u5b9a\u5411\u6253\u5370\uff0c\u6240\u4ee5\u80cc\u540e\u7684\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff0c\u5f00\u9500\u5f88\u5c0f\uff0c\u800c\u4e14\u7531\u4e8e\u8f93\u51fa\u5230\u4e86 stdout \u6216\u8005 stderr\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u6765\u67e5\u770b\u65e5\u5fd7\u4e86\u3002 \u4e0b\u9762\u7684\u793a\u4f8b\u662f\u5728 Pod \u4e2d\u5c06\u65e5\u5fd7\u8bb0\u5f55\u5728\u4e86\u5bb9\u5668\u7684\u4e24\u4e2a\u672c\u5730\u6587\u4ef6\u4e4b\u4e2d\uff1a apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts: - name: varlog mountPath: /var/log volumes: - name: varlog emptyDir: {} \u7531\u4e8e Pod \u4e2d\u5bb9\u5668\u7684\u7279\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u53e6\u5916\u4e00\u4e2a sidecar \u5bb9\u5668\u53bb\u83b7\u53d6\u5230\u53e6\u5916\u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u91cd\u5b9a\u5411\u5230\u81ea\u5df1\u7684 stdout \u6d41\u4e2d\uff0c\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u505a\u5982\u4e0b\u4fee\u6539\uff1a\uff08two-files-counter-pod-streaming-sidecar.yaml\uff09 apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts: - name: varlog mountPath: /var/log - name: count-log-1 image: busybox args: [/bin/sh, -c, \"tail -n+1 -f /var/log/1.log\"] volumeMounts: - name: varlog mountPath: /var/log - name: count-log-2 image: busybox args: [/bin/sh, -c, \"tail -n+1 -f /var/log/2.log\"] volumeMounts: - name: varlog mountPath: /var/log volumes: - name: varlog emptyDir: {} \u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a $ kubectl apply -f two-files-counter-pod-streaming-sidecar.yaml pod \"counter\" created \u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b\u65e5\u5fd7\u7684\u4fe1\u606f\uff1a $ kubectl logs counter count-log-1 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ... $ kubectl logs counter count-log-2 Mon Jan 1 00:00:00 UTC 2001 INFO 0 Mon Jan 1 00:00:01 UTC 2001 INFO 1 Mon Jan 1 00:00:02 UTC 2001 INFO 2 ... \u8fd9\u6837\u524d\u9762\u8282\u70b9\u4e0a\u7684\u65e5\u5fd7\u91c7\u96c6 agent \u5c31\u53ef\u4ee5\u81ea\u52a8\u83b7\u53d6\u8fd9\u4e9b\u65e5\u5fd7\u4fe1\u606f\uff0c\u800c\u4e0d\u9700\u8981\u5176\u4ed6\u914d\u7f6e\u3002 \u8fd9\u79cd\u65b9\u6cd5\u867d\u7136\u53ef\u4ee5\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u660e\u663e\u7684\u7f3a\u9677\uff0c\u5c31\u662f\u65e5\u5fd7\u4e0d\u4ec5\u4f1a\u5728\u539f\u5bb9\u5668\u6587\u4ef6\u4e2d\u4fdd\u7559\u4e0b\u6765\uff0c\u8fd8\u4f1a\u901a\u8fc7 stdout \u8f93\u51fa\u540e\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\uff0c\u8fd9\u6837\u65e0\u5f62\u4e2d\u5c31\u589e\u52a0\u4e86\u4e00\u500d\u78c1\u76d8\u7a7a\u95f4\u3002","title":"\u7528 sidecar \u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u65e5\u5fd7"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#sidecar-agent","text":"\u5982\u679c\u4f60\u89c9\u5f97\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u91c7\u96c6\u7684\u4ee3\u7406\u4e0d\u591f\u7075\u6d3b\u7684\u8bdd\uff0c\u90a3\u4e48\u4f60\u4e5f\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u7684 sidecar \u5bb9\u5668\uff0c\u4e0d\u8fc7\u9700\u8981\u5355\u72ec\u914d\u7f6e\u548c\u5e94\u7528\u7a0b\u5e8f\u4e00\u8d77\u8fd0\u884c\u3002 \u4e0d\u8fc7\u8fd9\u6837\u867d\u7136\u66f4\u52a0\u7075\u6d3b\uff0c\u4f46\u662f\u5728 sidecar \u5bb9\u5668\u4e2d\u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u4f1a\u5bfc\u81f4\u5927\u91cf\u8d44\u6e90\u6d88\u8017\uff0c\u56e0\u4e3a\u4f60\u6709\u591a\u5c11\u4e2a\u8981\u91c7\u96c6\u7684 Pod\uff0c\u5c31\u9700\u8981\u8fd0\u884c\u591a\u5c11\u4e2a\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\uff0c\u53e6\u5916\u8fd8\u65e0\u6cd5\u4f7f\u7528 kubectl logs \u547d\u4ee4\u6765\u8bbf\u95ee\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u53d7 kubelet \u63a7\u5236\u3002 \u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684 Stackdriver\uff0c\u5b83\u4f7f\u7528 fluentd \u4f5c\u4e3a\u8bb0\u5f55\u5242\u3002\u4ee5\u4e0b\u662f\u4e24\u4e2a\u53ef\u7528\u4e8e\u5b9e\u73b0\u6b64\u65b9\u6cd5\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u7b2c\u4e00\u4e2a\u6587\u4ef6\u5305\u542b\u914d\u7f6e\u6d41\u5229\u7684 ConfigMap\u3002 \u4e0b\u9762\u662f Kubernetes \u5b98\u65b9\u7684\u4e00\u4e2a fluentd \u7684\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\uff0c\u4f7f\u7528 ConfigMap \u5bf9\u8c61\u6765\u4fdd\u5b58\uff1a apiVersion: v1 kind: ConfigMap metadata: name: fluentd-config data: fluentd.conf: | <source> type tail format none path /var/log/1.log pos_file /var/log/1.log.pos tag count.format1 </source> <source> type tail format none path /var/log/2.log pos_file /var/log/2.log.pos tag count.format2 </source> <match **> type google_cloud </match> \u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u914d\u7f6e\u6536\u96c6\u539f\u6587\u4ef6 /var/log/1.log \u548c /var/log/2.log \u7684\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7 google_cloud \u8fd9\u4e2a\u63d2\u4ef6\u5c06\u6570\u636e\u63a8\u9001\u5230 Stackdriver \u540e\u7aef\u53bb\u3002 \u4e0b\u9762\u662f\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8fd0\u884c\u4e00\u4e2a fluentd \u7684\u5bb9\u5668\u6765\u8bfb\u53d6\u65e5\u5fd7\u6570\u636e\uff1a apiVersion: v1 kind: Pod metadata: name: counter spec: containers: - name: count image: busybox args: - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts: - name: varlog mountPath: /var/log - name: count-agent image: k8s.gcr.io/fluentd-gcp:1.30 env: - name: FLUENTD_ARGS value: -c /etc/fluentd-config/fluentd.conf volumeMounts: - name: varlog mountPath: /var/log - name: config-volume mountPath: /etc/fluentd-config volumes: - name: varlog emptyDir: {} - name: config-volume configMap: name: fluentd-config \u4e0a\u9762\u7684 Pod \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5bb9\u5668 count-agent \u5c31\u4f1a\u5c06 count \u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\u7136\u540e\u4e0a\u4f20\u3002\u5f53\u7136\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u7684\u4efb\u4f55\u65e5\u5fd7\u91c7\u96c6\u5de5\u5177\u6765\u66ff\u6362 fluentd\uff0c\u6bd4\u5982 logstash\u3001fluent-bit \u7b49\u7b49\u3002","title":"\u4f7f\u7528 sidecar \u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6 agent"},{"location":"3.k8s/7.logging/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9E%B6%E6%9E%84/#_4","text":"\u9664\u4e86\u4e0a\u9762\u7684\u51e0\u79cd\u65b9\u6848\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u53bb\u663e\u793a\u7684\u5c06\u65e5\u5fd7\u63a8\u9001\u5230\u65e5\u5fd7\u540e\u7aef\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u9700\u8981\u4ee3\u7801\u5c42\u9762\u7684\u5b9e\u73b0\uff0c\u4e5f\u8d85\u51fa\u4e86 Kubernetes \u672c\u8eab\u7684\u8303\u56f4\u3002\u4e0b\u8282\u8bfe\u6211\u4eec\u7ed9\u5927\u5bb6\u6f14\u793a\u4e0b\u5177\u4f53\u7684\u65e5\u5fd7\u6536\u96c6\u7684\u64cd\u4f5c\u65b9\u6cd5\u3002","title":"\u76f4\u63a5\u4ece\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u65e5\u5fd7"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/","text":"\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f \u00b6 \u8bfb\u5199\u5206\u79bb\u6a21\u5f0f \u00b6 Loki \u7531\u591a\u4e2a\u5fae\u670d\u52a1\u7ec4\u4ef6\u6784\u5efa\u800c\u6210\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u53ef\u6c34\u5e73\u6269\u5c55\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u8fd0\u884c\uff0cLoki \u7684\u72ec\u7279\u8bbe\u8ba1\u53ef\u4ee5\u5c06\u6574\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u4ee3\u7801\u7f16\u8bd1\u6210\u5355\u4e2a\u4e8c\u8fdb\u5236\u6216 Docker \u6620\u50cf\uff0c\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u884c\u4e3a\u7531 -target \u547d\u4ee4\u884c\u6807\u5fd7\u63a7\u5236\u3002 \u5355\u4f53\u6a21\u5f0f \u00b6 \u6700\u7b80\u5355\u7684\u64cd\u4f5c\u6a21\u5f0f\u662f\u8bbe\u7f6e -target=all \uff0c\u8fd9\u662f\u9ed8\u8ba4\u7684\u65b9\u5f0f\uff0c\u4e0d\u9700\u8981\u6307\u5b9a\uff0c\u8fd9\u5c31\u662f\u5355\u4f53\u6a21\u5f0f\uff0c\u5b83\u4ee5\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u6216 Docker \u6620\u50cf\u7684\u5f62\u5f0f\u5728\u5355\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c Loki \u7684\u6240\u6709\u5fae\u670d\u52a1\u7ec4\u4ef6\u3002 \u5355\u4f53\u6a21\u5f0f\u5bf9\u4e8e\u5feb\u901f\u5f00\u59cb\u4f7f\u7528 Loki \u4ee5\u53ca\u6bcf\u5929\u6570\u636e\u91cf\u7ea6 100GB \u7684\u8bfb\u5199\u91cf\u975e\u5e38\u6709\u7528\u3002\u5c06\u5355\u4f53\u6a21\u5f0f\u90e8\u7f72\u6c34\u5e73\u6269\u5c55\u81f3\u66f4\u591a\u5b9e\u4f8b\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u5171\u4eab\u5bf9\u8c61\u5b58\u50a8\uff0c\u914d\u7f6e memberlist_config \u5c5e\u6027\u5728\u6240\u6709\u5b9e\u4f8b\u4e4b\u95f4\u5171\u4eab\u72b6\u6001\u3002 \u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 memberlist_config \u914d\u7f6e\u548c\u5171\u4eab\u5bf9\u8c61\u5b58\u50a8\u8fd0\u884c\u4e24\u4e2a Loki \u5b9e\u4f8b\u6765\u914d\u7f6e\u9ad8\u53ef\u7528\u6027\u3002\u4ee5\u5faa\u73af\u65b9\u5f0f\u5c06\u6d41\u91cf\u8def\u7531\u5230\u6240\u6709 Loki \u5b9e\u4f8b\u3002\u5e76\u884c\u67e5\u8be2\u53d7\u9650\u4e8e\u5b9e\u4f8b\u6570\u91cf\u548c\u5b9a\u4e49\u7684\u67e5\u8be2\u5e76\u884c\u5ea6\u3002 \u5355\u4f53\u6a21\u5f0f\u7684\u5b89\u88c5\u975e\u5e38\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528 grafana/loki-stack \u8fd9\u4e2a Helm Chart \u5305\u5b89\u88c5\u5373\u53ef\u3002 \u8bfb\u5199\u5206\u79bb\u6a21\u5f0f \u00b6 \u5982\u679c\u4f60\u6bcf\u5929\u7684\u65e5\u5fd7\u91cf\u8d85\u8fc7\u51e0\u767e GB\uff0c\u6216\u8005\u4f60\u60f3\u8fdb\u884c\u8bfb\u5199\u5206\u79bb\uff0cLoki \u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u53ef\u6269\u5c55\u90e8\u7f72\u6a21\u5f0f\u3002\u8fd9\u79cd\u90e8\u7f72\u6a21\u5f0f\u53ef\u4ee5\u6269\u5c55\u5230\u6bcf\u5929\u6570 TB \u751a\u81f3\u66f4\u591a\u7684\u65e5\u5fd7\u3002 \u5728\u8fd9\u79cd\u6a21\u5f0f\u4e0b\uff0cLoki \u7684\u7ec4\u4ef6\u5fae\u670d\u52a1\u88ab\u7ed1\u5b9a\u5230\u4e24\u4e2a\u76ee\u6807\u4e2d\uff1a -target=read \u548c -target=write \uff0cBoltDB compactor \u670d\u52a1\u5c06\u4f5c\u4e3a\u8bfb\u53d6\u76ee\u6807\u7684\u4e00\u90e8\u5206\u8fd0\u884c\u3002 \u5206\u79bb\u8bfb\u5199\u8def\u5f84\u6709\u4ee5\u4e0b\u4f18\u70b9\uff1a \u901a\u8fc7\u63d0\u4f9b\u4e13\u7528\u8282\u70b9\u63d0\u9ad8\u5199\u5165\u8def\u5f84\u7684\u53ef\u7528\u6027 \u53ef\u5355\u72ec\u6269\u5c55\u8bfb\u53d6\u8def\u5f84\u4ee5\u6309\u9700\u6dfb\u52a0/\u5220\u9664\u67e5\u8be2\u6027\u80fd \u8fd9\u79cd\u8bfb\u5199\u5206\u79bb\u7684\u6a21\u5f0f\u9700\u8981\u5728 Loki \u524d\u9762\u6709\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5b83\u5c06 /loki/api/v1/push \u6d41\u91cf\u8def\u7531\u5230\u5199\u5165\u8282\u70b9\uff0c\u6240\u6709\u5176\u4ed6\u8bf7\u6c42\u90fd\u8f6c\u5230\u8bfb\u53d6\u8282\u70b9\uff0c\u6d41\u91cf\u5e94\u8be5\u4ee5\u5faa\u73af\u65b9\u5f0f\u53d1\u9001\u3002 \u5b89\u88c5 \u00b6 \u6211\u4eec\u540c\u6837\u4f7f\u7528 Helm Chart \u8fdb\u884c\u5b89\u88c5\uff0c\u9996\u5148\u83b7\u53d6\u8bfb\u5199\u5206\u79bb\u6a21\u578b\u7684 Chart \u5305\uff1a $ helm repo add grafana https://grafana.github.io/helm-charts $ helm pull grafana/loki-simple-scalable --untar --version 1.4.1 $ cd loki-simple-scalable \u8be5 Chart \u5305\u652f\u6301\u4e0b\u8868\u4e2d\u663e\u793a\u7684\u7ec4\u4ef6\uff0cIngester\u3001distributor\u3001querier \u548c query-frontend \u90fd\u4f1a\u5b89\u88c5\uff0c\u5176\u4ed6\u7ec4\u4ef6\u662f\u53ef\u9009\u7684\u3002 Loki \u7ec4\u4ef6 \u662f\u5426\u53ef\u9009 \u662f\u5426\u9ed8\u8ba4\u5f00\u542f gateway \u2705 \u2705 write \u274e n/a read \u274e n/a \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 MinIO \u6765\u4f5c\u4e3a\u8fdc\u7a0b\u6570\u636e\u5b58\u50a8\uff0c\u5206\u522b\u914d\u7f6e\u8bfb\u548c\u5199\u7684 Loki \u5b9e\u4f8b\u526f\u672c\u6570\u4e3a 2\uff0c\u4e3a\u4e86\u5728 Loki \u524d\u9762\u6dfb\u52a0\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u9700\u8981\u5f00\u542f Gateway\uff0c\u5bf9\u5e94\u7684 Values \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a # ci/minio-values.yaml loki: commonConfig: path_prefix: /var/loki replication_factor: 2 authEnabled: false # Configuration for the write write: # -- Number of replicas for the write replicas: 3 affinity: | podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: labelSelector: matchLabels: {{- include \"loki.writeSelectorLabels\" . | nindent 12 }} topologyKey: kubernetes.io/hostname persistence: size: 1Gi storageClass: local-path # Configuration for the read node(s) read: # -- Number of replicas for the read replicas: 3 affinity: | podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: labelSelector: matchLabels: {{- include \"loki.readSelectorLabels\" . | nindent 12 }} topologyKey: kubernetes.io/hostname persistence: size: 1Gi storageClass: local-path # Configuration for the gateway gateway: # -- Specifies whether the gateway should be enabled enabled: true # ------------------------------------- # Configuration for `minio` child chart # ------------------------------------- minio: enabled: true accessKey: enterprise-logs secretKey: supersecret service: type: NodePort nodePort: 32000 buckets: - name: chunks policy: none purge: false - name: ruler policy: none purge: false - name: admin policy: none purge: false persistence: size: 1Gi storageClass: local-path resources: requests: cpu: 100m memory: 256Mi \u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684 Loki\uff1a $ helm upgrade --install loki -n logging -f ci/minio-values.yaml . Release \"loki\" does not exist. Installing it now. NAME: loki LAST DEPLOYED: Fri Jun 17 14:53:20 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Loki Chart version: 1.4.1 Loki version: 2.5.0 *********************************************************************** Installed components: * gateway * read * write This chart requires persistence and object storage to work correctly. Queries will not work unless you provide a `loki.config.common.storage` section with a valid object storage (and the default `filesystem` storage set to `null`), as well as a valid `loki.config.schema_config.configs` with an `object_store` that matches the common storage section. For example, to use MinIO as your object storage backend: loki: config: common: storage: filesystem: null s3: endpoint: minio.minio.svc.cluster.local:9000 insecure: true bucketnames: loki-data access_key_id: loki secret_access_key: supersecret s3forcepathstyle: true schema_config: configs: - from: \"2020-09-07\" store: boltdb-shipper object_store: s3 schema: v11 index: period: 24h prefix: loki_index_ \u5b89\u88c5\u5b8c\u6210\u540e\u67e5\u770b Pod \u72b6\u6001\u662f\u5426\u6b63\u5e38\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE loki-gateway-67f76958d7-bq46l 1/1 Running 0 91m loki-minio-87c9bc6f5-jxdcn 1/1 Running 0 70m loki-read-0 1/1 Running 0 81s loki-read-1 1/1 Running 0 81s loki-read-2 1/1 Running 0 81s loki-write-0 1/1 Running 0 81s loki-write-1 1/1 Running 0 81s loki-write-2 1/1 Running 0 81s \u53ef\u4ee5\u770b\u5230\u5206\u522b\u90e8\u7f72\u4e86\u4e24\u4e2a\u526f\u672c\u7684 write \u548c read \u7684 Loki\uff0c\u53e6\u5916\u8fd8\u6709\u4e00\u4e2a gateway \u7684 Pod\uff0cgateway \u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u4e2a nginx \u5e94\u7528\uff0c\u7528\u6765\u5c06 /loki/api/v1/push \u8bf7\u6c42\u8def\u7531\u5230 write \u8282\u70b9\u53bb\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b gateway \u7684\u914d\u7f6e\u6765\u9a8c\u8bc1\uff1a $ kubectl get cm -n logging loki-gateway -o yaml apiVersion: v1 data: nginx.conf: | worker_processes 5; ## Default: 1 error_log /dev/stderr; pid /tmp/nginx.pid; worker_rlimit_nofile 8192; events { worker_connections 4096; ## Default: 1024 } http { client_body_temp_path /tmp/client_temp; proxy_temp_path /tmp/proxy_temp_path; fastcgi_temp_path /tmp/fastcgi_temp; uwsgi_temp_path /tmp/uwsgi_temp; scgi_temp_path /tmp/scgi_temp; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] $status ' '\"$request\" $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /dev/stderr main; sendfile on; tcp_nopush on; resolver kube-dns.kube-system.svc.cluster.local; server { listen 8080; location = / { return 200 'OK'; auth_basic off; } location = /api/prom/push { # (1) proxy_pass http://loki-write.logging.svc.cluster.local:3100$request_uri; # (2) } location = /api/prom/tail { # (3) proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; # (4) proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } location ~ /api/prom/.* { proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/push { proxy_pass http://loki-write.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/tail { proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } location ~ /loki/api/.* { proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; } } } kind: ConfigMap metadata: annotations: meta.helm.sh/release-name: loki meta.helm.sh/release-namespace: logging creationTimestamp: \"2022-06-17T06:53:22Z\" labels: app.kubernetes.io/component: gateway app.kubernetes.io/instance: loki app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: loki app.kubernetes.io/version: 2.5.0 helm.sh/chart: loki-simple-scalable-1.4.1 name: loki-gateway namespace: logging resourceVersion: \"4968787\" uid: ba9ba1c0-8561-41cb-8b55-287f352b5ee8 \u4e0a\u9762\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684 Nginx \u914d\u7f6e\uff0c\u4ece\u914d\u7f6e\u53ef\u4ee5\u770b\u51fa\u4f1a\u628a\u8bf7\u6c42 /api/prom/push \u548c /loki/api/v1/push \u8fd9\u4e24\u4e2a Push API \u4ee3\u7406\u5230 http://loki-write.logging.svc.cluster.local:3100$request_uri; \uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u7684\u4e24\u4e2a loki-write \u8282\u70b9\uff0c\u800c\u8bfb\u53d6\u76f8\u5173\u7684\u63a5\u53e3\u88ab\u4ee3\u7406\u5230 loki-read \u8282\u70b9\uff0c\u7136\u540e loki-write \u542f\u52a8\u53c2\u6570\u914d\u7f6e -target=write \uff0c loki-read \u542f\u52a8\u53c2\u6570\u914d\u7f6e -target=read \uff0c\u8fd9\u6837\u53bb\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb\u3002\u4e0d\u8fc7\u8bfb\u5199\u7684\u5e94\u7528\u662f\u5171\u4eab\u540c\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u7684\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get cm -n logging loki -o yaml apiVersion: v1 data: config.yaml: | auth_enabled: false common: path_prefix: /var/loki replication_factor: 2 storage: s3: access_key_id: enterprise-logs bucketnames: chunks endpoint: loki-minio.logging.svc:9000 insecure: true s3forcepathstyle: true secret_access_key: supersecret limits_config: enforce_metric_name: false max_cache_freshness_per_query: 10m reject_old_samples: true reject_old_samples_max_age: 168h split_queries_by_interval: 15m memberlist: join_members: - loki-memberlist ruler: storage: s3: bucketnames: ruler schema_config: configs: - from: \"2022-06-17\" index: period: 24h prefix: loki_index_ object_store: s3 schema: v12 store: boltdb-shipper server: grpc_listen_port: 9095 http_listen_port: 3100 ...... \u5176\u4e2d common.storage.s3 \u6307\u5b9a\u7684\u662f MinIO \u7684\u76f8\u5173\u914d\u7f6e\uff0c\u901a\u8fc7 memberlist.join_members \u6765\u6307\u5b9a\u6210\u5458\uff0c\u5176\u5b9e\u5c31\u662f\u6240\u6709\u7684\u8bfb\u5199\u8282\u70b9\uff1a $ kubectl get svc loki-memberlist -n logging -o wide NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR loki-memberlist ClusterIP None <none> 7946/TCP 54m app.kubernetes.io/instance=loki,app.kubernetes.io/name=loki,app.kubernetes.io/part-of=memberlist $ kubectl get pods -n logging -l app.kubernetes.io/part-of=memberlist NAME READY STATUS RESTARTS AGE loki-read-0 1/1 Running 0 32s loki-read-1 1/1 Running 0 72s loki-read-2 1/1 Running 0 115s loki-write-0 1/1 Running 0 4s loki-write-1 1/1 Running 0 55s loki-write-2 1/1 Running 0 116s \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Loki \u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684\u90e8\u7f72\u3002 Promtail \u5199\u6570\u636e \u00b6 \u4e3a\u4e86\u9a8c\u8bc1\u5e94\u7528\u662f\u5426\u6b63\u5e38\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5b89\u88c5 Promtail \u548c Grafana \u6765\u8fdb\u884c\u6570\u636e\u7684\u8bfb\u5199\u3002 \u83b7\u53d6 promtail \u7684 Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull grafana/promtail --untar $ cd promtail \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/simple-values.yaml rbac: pspEnabled: false config: clients: - url: http://loki-gateway/loki/api/v1/push # \u6307\u5b9aLoki\u7684\u5730\u5740\uff0cwrite \u7684push\u5730\u5740\uff0cgateway\u7684\u5730\u5740 \u6ce8\u610f\u6211\u4eec\u9700\u8981\u5c06 Promtail \u4e2d\u914d\u7f6e\u7684 Loki \u5730\u5740\u4e3a http://loki-gateway/loki/api/v1/push \uff0c\u8fd9\u6837\u5c31\u662f Promtail \u5c06\u65e5\u5fd7\u6570\u636e\u9996\u5148\u53d1\u9001\u5230 Gateway \u4e0a\u9762\u53bb\uff0c\u7136\u540e Gateway \u6839\u636e\u6211\u4eec\u7684 Endpoints \u53bb\u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5 Promtail\uff1a $ helm upgrade --install promtail -n logging -f ci/simple-values.yaml . Release \"promtail\" does not exist. Installing it now. NAME: promtail LAST DEPLOYED: Fri Jun 17 16:01:08 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Promtail Chart version: 5.1.0 Promtail version: 2.5.0 *********************************************************************** Verify the application is working by running these commands: * kubectl --namespace logging port-forward daemonset/promtail 3101 * curl http://127.0.0.1:3101/metrics \u6b63\u5e38\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a promtail\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/name=promtail NAME READY STATUS RESTARTS AGE promtail-5r9hl 1/1 Running 0 2m25s promtail-85mk4 1/1 Running 0 2m25s promtail-qlfnv 1/1 Running 0 2m25s \u6b63\u5e38 promtail \u5c31\u5df2\u7ecf\u5728\u5f00\u59cb\u91c7\u96c6\u6240\u5728\u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\u4e86\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u6570\u636e Push \u7ed9 gateway\uff0cgateway \u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b gateway \u7684\u65e5\u5fd7\uff1a $ kubectl logs -f loki-gateway-67f76958d7-bq46l -n logging 10.244.1.170 - - [17/Jun/2022:08:09:03 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.1.170 - - [17/Jun/2022:08:09:04 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.2.205 - - [17/Jun/2022:08:09:05 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" ...... \u53ef\u4ee5\u770b\u5230 gateway \u73b0\u5728\u5728\u4e00\u76f4\u63a5\u63a5\u6536\u7740 /loki/api/v1/push \u7684\u8bf7\u6c42\uff0c\u4e5f\u5c31\u662f promtail \u53d1\u9001\u8fc7\u6765\u7684\uff0c\u6b63\u5e38\u6765\u8bf4\u73b0\u5728\u65e5\u5fd7\u6570\u636e\u5df2\u7ecf\u5206\u53d1\u7ed9 write \u8282\u70b9\u4e86\uff0cwrite \u8282\u70b9\u5c06\u6570\u636e\u5b58\u50a8\u5728\u4e86 minio \u4e2d\uff0c\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b minio \u4e2d\u5df2\u7ecf\u6709\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u524d\u9762\u5b89\u88c5\u7684\u65f6\u5019\u4e3a minio \u670d\u52a1\u6307\u5b9a\u4e86\u4e00\u4e2a 32000 \u7684 NodePort \u7aef\u53e3\uff1a \u767b\u5f55\u4fe1\u606f\u4e3a\uff1a accessKey: enterprise-logs secretKey: supersecret \u53ef\u4ee5\u770b\u5230 minio \u7684 chunks \u8fd9\u4e2a bucket \u4e2d\u5e76\u6ca1\u6709\u65e5\u5fd7\u6570\u636e\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 bucket \u9ed8\u8ba4\u53ea\u6709\u8bfb\u53d6\u7684\u6743\u9650\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u8be5 bucket \u4fee\u6539\u4e3a\u5177\u6709 \u8bfb\u5199 \u7684\u6743\u9650\uff1a \u6b63\u5e38\u4fee\u6539\u540e\u5c31\u6709\u4ea7\u751f\u4e00\u4e2a fake \u7684\u76ee\u5f55\u4e86\uff0c\u8fd9\u662f\u9ed8\u8ba4\u6ca1\u6709\u63d0\u4f9b\u591a\u79df\u6237\u7684\u6570\u636e\u76ee\u5f55\uff0c\u8be5\u76ee\u5f55\u4e0b\u9762\u5b58\u50a8\u7740\u65e5\u5fd7\u7684 chunk \u6570\u636e\uff1a \u8fd9\u662f Loki \u65e5\u5fd7\u7684\u5199\u5165\u7684\u8def\u5f84\u3002 Grafana \u8bfb\u6570\u636e \u00b6 \u4e0b\u9762\u6211\u4eec\u6765\u9a8c\u8bc1\u4e0b\u8bfb\u53d6\u8def\u5f84\uff0c\u5b89\u88c5 Grafana \u5bf9\u63a5 Loki\uff1a $ helm pull grafana/grafana --untar $ cd grafana \u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 values \u914d\u7f6e\u6587\u4ef6\uff1a # ci/simple-values.yaml service: type: NodePort nodePort: 32001 rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path accessModes: - ReadWriteOnce size: 1Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 Grafana\uff1a $ helm upgrade --install grafana -n logging -f ci/simple-values.yaml . Release \"grafana\" has been upgraded. Happy Helming! NAME: grafana LAST DEPLOYED: Fri Jun 17 17:00:24 2022 NAMESPACE: logging STATUS: deployed REVISION: 2 NOTES: 1. Get your 'admin' user password by running: kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo 2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster: grafana.logging.svc.cluster.local Get the Grafana URL to visit by running these commands in the same shell: export NODE_PORT=$(kubectl get --namespace logging -o jsonpath=\"{.spec.ports[0].nodePort}\" services grafana) export NODE_IP=$(kubectl get nodes --namespace logging -o jsonpath=\"{.items[0].status.addresses[0].address}\") echo http://$NODE_IP:$NODE_PORT 3. Login with the password from step 1 and the username: admin \u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u63d0\u793a\u4e2d\u7684\u547d\u4ee4\u83b7\u53d6\u767b\u5f55\u5bc6\u7801\uff1a $ kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo \u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u5bc6\u7801\u548c admin \u7528\u6237\u540d\u767b\u5f55 Grafana\uff1a \u767b\u5f55\u540e\u8fdb\u5165 Grafana \u6dfb\u52a0\u4e00\u4e2a\u6570\u636e\u6e90\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u8981\u586b\u5199 gateway \u7684\u5730\u5740 http://loki-gateway \uff1a \u4fdd\u5b58\u6570\u636e\u6e90\u540e\uff0c\u53ef\u4ee5\u8fdb\u5165 Explore \u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u5b9e\u65f6\u67e5\u770b gateway \u8fd9\u4e2a\u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u5982\u679c\u4f60\u80fd\u770b\u5230\u6700\u65b0\u7684\u65e5\u5fd7\u6570\u636e\u90a3\u8bf4\u660e\u6211\u4eec\u90e8\u7f72\u6210\u529f\u4e86\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684 Loki\uff0c\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u53ef\u4ee5\u5927\u5927\u63d0\u9ad8 Loki \u7684\u6027\u80fd\u548c\u5bb9\u91cf\uff0c\u5982\u679c\u8fd9\u79cd\u6a21\u5f0f\u8fd8\u4e0d\u80fd\u6ee1\u8db3\u4f60\u7684\u6570\u636e\u91cf\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528 \u5fae\u670d\u52a1\u6a21\u5f0f \u6765\u90e8\u7f72 Loki \u4e86\u3002","title":"kubernetes \u65e5\u5fd7\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/#_1","text":"","title":"\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/#_2","text":"Loki \u7531\u591a\u4e2a\u5fae\u670d\u52a1\u7ec4\u4ef6\u6784\u5efa\u800c\u6210\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u53ef\u6c34\u5e73\u6269\u5c55\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u8fd0\u884c\uff0cLoki \u7684\u72ec\u7279\u8bbe\u8ba1\u53ef\u4ee5\u5c06\u6574\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u4ee3\u7801\u7f16\u8bd1\u6210\u5355\u4e2a\u4e8c\u8fdb\u5236\u6216 Docker \u6620\u50cf\uff0c\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u884c\u4e3a\u7531 -target \u547d\u4ee4\u884c\u6807\u5fd7\u63a7\u5236\u3002","title":"\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/#_3","text":"\u6700\u7b80\u5355\u7684\u64cd\u4f5c\u6a21\u5f0f\u662f\u8bbe\u7f6e -target=all \uff0c\u8fd9\u662f\u9ed8\u8ba4\u7684\u65b9\u5f0f\uff0c\u4e0d\u9700\u8981\u6307\u5b9a\uff0c\u8fd9\u5c31\u662f\u5355\u4f53\u6a21\u5f0f\uff0c\u5b83\u4ee5\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u6216 Docker \u6620\u50cf\u7684\u5f62\u5f0f\u5728\u5355\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c Loki \u7684\u6240\u6709\u5fae\u670d\u52a1\u7ec4\u4ef6\u3002 \u5355\u4f53\u6a21\u5f0f\u5bf9\u4e8e\u5feb\u901f\u5f00\u59cb\u4f7f\u7528 Loki \u4ee5\u53ca\u6bcf\u5929\u6570\u636e\u91cf\u7ea6 100GB \u7684\u8bfb\u5199\u91cf\u975e\u5e38\u6709\u7528\u3002\u5c06\u5355\u4f53\u6a21\u5f0f\u90e8\u7f72\u6c34\u5e73\u6269\u5c55\u81f3\u66f4\u591a\u5b9e\u4f8b\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u5171\u4eab\u5bf9\u8c61\u5b58\u50a8\uff0c\u914d\u7f6e memberlist_config \u5c5e\u6027\u5728\u6240\u6709\u5b9e\u4f8b\u4e4b\u95f4\u5171\u4eab\u72b6\u6001\u3002 \u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 memberlist_config \u914d\u7f6e\u548c\u5171\u4eab\u5bf9\u8c61\u5b58\u50a8\u8fd0\u884c\u4e24\u4e2a Loki \u5b9e\u4f8b\u6765\u914d\u7f6e\u9ad8\u53ef\u7528\u6027\u3002\u4ee5\u5faa\u73af\u65b9\u5f0f\u5c06\u6d41\u91cf\u8def\u7531\u5230\u6240\u6709 Loki \u5b9e\u4f8b\u3002\u5e76\u884c\u67e5\u8be2\u53d7\u9650\u4e8e\u5b9e\u4f8b\u6570\u91cf\u548c\u5b9a\u4e49\u7684\u67e5\u8be2\u5e76\u884c\u5ea6\u3002 \u5355\u4f53\u6a21\u5f0f\u7684\u5b89\u88c5\u975e\u5e38\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528 grafana/loki-stack \u8fd9\u4e2a Helm Chart \u5305\u5b89\u88c5\u5373\u53ef\u3002","title":"\u5355\u4f53\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/#_4","text":"\u5982\u679c\u4f60\u6bcf\u5929\u7684\u65e5\u5fd7\u91cf\u8d85\u8fc7\u51e0\u767e GB\uff0c\u6216\u8005\u4f60\u60f3\u8fdb\u884c\u8bfb\u5199\u5206\u79bb\uff0cLoki \u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u53ef\u6269\u5c55\u90e8\u7f72\u6a21\u5f0f\u3002\u8fd9\u79cd\u90e8\u7f72\u6a21\u5f0f\u53ef\u4ee5\u6269\u5c55\u5230\u6bcf\u5929\u6570 TB \u751a\u81f3\u66f4\u591a\u7684\u65e5\u5fd7\u3002 \u5728\u8fd9\u79cd\u6a21\u5f0f\u4e0b\uff0cLoki \u7684\u7ec4\u4ef6\u5fae\u670d\u52a1\u88ab\u7ed1\u5b9a\u5230\u4e24\u4e2a\u76ee\u6807\u4e2d\uff1a -target=read \u548c -target=write \uff0cBoltDB compactor \u670d\u52a1\u5c06\u4f5c\u4e3a\u8bfb\u53d6\u76ee\u6807\u7684\u4e00\u90e8\u5206\u8fd0\u884c\u3002 \u5206\u79bb\u8bfb\u5199\u8def\u5f84\u6709\u4ee5\u4e0b\u4f18\u70b9\uff1a \u901a\u8fc7\u63d0\u4f9b\u4e13\u7528\u8282\u70b9\u63d0\u9ad8\u5199\u5165\u8def\u5f84\u7684\u53ef\u7528\u6027 \u53ef\u5355\u72ec\u6269\u5c55\u8bfb\u53d6\u8def\u5f84\u4ee5\u6309\u9700\u6dfb\u52a0/\u5220\u9664\u67e5\u8be2\u6027\u80fd \u8fd9\u79cd\u8bfb\u5199\u5206\u79bb\u7684\u6a21\u5f0f\u9700\u8981\u5728 Loki \u524d\u9762\u6709\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5b83\u5c06 /loki/api/v1/push \u6d41\u91cf\u8def\u7531\u5230\u5199\u5165\u8282\u70b9\uff0c\u6240\u6709\u5176\u4ed6\u8bf7\u6c42\u90fd\u8f6c\u5230\u8bfb\u53d6\u8282\u70b9\uff0c\u6d41\u91cf\u5e94\u8be5\u4ee5\u5faa\u73af\u65b9\u5f0f\u53d1\u9001\u3002","title":"\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/#_5","text":"\u6211\u4eec\u540c\u6837\u4f7f\u7528 Helm Chart \u8fdb\u884c\u5b89\u88c5\uff0c\u9996\u5148\u83b7\u53d6\u8bfb\u5199\u5206\u79bb\u6a21\u578b\u7684 Chart \u5305\uff1a $ helm repo add grafana https://grafana.github.io/helm-charts $ helm pull grafana/loki-simple-scalable --untar --version 1.4.1 $ cd loki-simple-scalable \u8be5 Chart \u5305\u652f\u6301\u4e0b\u8868\u4e2d\u663e\u793a\u7684\u7ec4\u4ef6\uff0cIngester\u3001distributor\u3001querier \u548c query-frontend \u90fd\u4f1a\u5b89\u88c5\uff0c\u5176\u4ed6\u7ec4\u4ef6\u662f\u53ef\u9009\u7684\u3002 Loki \u7ec4\u4ef6 \u662f\u5426\u53ef\u9009 \u662f\u5426\u9ed8\u8ba4\u5f00\u542f gateway \u2705 \u2705 write \u274e n/a read \u274e n/a \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 MinIO \u6765\u4f5c\u4e3a\u8fdc\u7a0b\u6570\u636e\u5b58\u50a8\uff0c\u5206\u522b\u914d\u7f6e\u8bfb\u548c\u5199\u7684 Loki \u5b9e\u4f8b\u526f\u672c\u6570\u4e3a 2\uff0c\u4e3a\u4e86\u5728 Loki \u524d\u9762\u6dfb\u52a0\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u9700\u8981\u5f00\u542f Gateway\uff0c\u5bf9\u5e94\u7684 Values \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a # ci/minio-values.yaml loki: commonConfig: path_prefix: /var/loki replication_factor: 2 authEnabled: false # Configuration for the write write: # -- Number of replicas for the write replicas: 3 affinity: | podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: labelSelector: matchLabels: {{- include \"loki.writeSelectorLabels\" . | nindent 12 }} topologyKey: kubernetes.io/hostname persistence: size: 1Gi storageClass: local-path # Configuration for the read node(s) read: # -- Number of replicas for the read replicas: 3 affinity: | podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: labelSelector: matchLabels: {{- include \"loki.readSelectorLabels\" . | nindent 12 }} topologyKey: kubernetes.io/hostname persistence: size: 1Gi storageClass: local-path # Configuration for the gateway gateway: # -- Specifies whether the gateway should be enabled enabled: true # ------------------------------------- # Configuration for `minio` child chart # ------------------------------------- minio: enabled: true accessKey: enterprise-logs secretKey: supersecret service: type: NodePort nodePort: 32000 buckets: - name: chunks policy: none purge: false - name: ruler policy: none purge: false - name: admin policy: none purge: false persistence: size: 1Gi storageClass: local-path resources: requests: cpu: 100m memory: 256Mi \u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684 Loki\uff1a $ helm upgrade --install loki -n logging -f ci/minio-values.yaml . Release \"loki\" does not exist. Installing it now. NAME: loki LAST DEPLOYED: Fri Jun 17 14:53:20 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Loki Chart version: 1.4.1 Loki version: 2.5.0 *********************************************************************** Installed components: * gateway * read * write This chart requires persistence and object storage to work correctly. Queries will not work unless you provide a `loki.config.common.storage` section with a valid object storage (and the default `filesystem` storage set to `null`), as well as a valid `loki.config.schema_config.configs` with an `object_store` that matches the common storage section. For example, to use MinIO as your object storage backend: loki: config: common: storage: filesystem: null s3: endpoint: minio.minio.svc.cluster.local:9000 insecure: true bucketnames: loki-data access_key_id: loki secret_access_key: supersecret s3forcepathstyle: true schema_config: configs: - from: \"2020-09-07\" store: boltdb-shipper object_store: s3 schema: v11 index: period: 24h prefix: loki_index_ \u5b89\u88c5\u5b8c\u6210\u540e\u67e5\u770b Pod \u72b6\u6001\u662f\u5426\u6b63\u5e38\uff1a $ kubectl get pods -n logging NAME READY STATUS RESTARTS AGE loki-gateway-67f76958d7-bq46l 1/1 Running 0 91m loki-minio-87c9bc6f5-jxdcn 1/1 Running 0 70m loki-read-0 1/1 Running 0 81s loki-read-1 1/1 Running 0 81s loki-read-2 1/1 Running 0 81s loki-write-0 1/1 Running 0 81s loki-write-1 1/1 Running 0 81s loki-write-2 1/1 Running 0 81s \u53ef\u4ee5\u770b\u5230\u5206\u522b\u90e8\u7f72\u4e86\u4e24\u4e2a\u526f\u672c\u7684 write \u548c read \u7684 Loki\uff0c\u53e6\u5916\u8fd8\u6709\u4e00\u4e2a gateway \u7684 Pod\uff0cgateway \u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u4e2a nginx \u5e94\u7528\uff0c\u7528\u6765\u5c06 /loki/api/v1/push \u8bf7\u6c42\u8def\u7531\u5230 write \u8282\u70b9\u53bb\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b gateway \u7684\u914d\u7f6e\u6765\u9a8c\u8bc1\uff1a $ kubectl get cm -n logging loki-gateway -o yaml apiVersion: v1 data: nginx.conf: | worker_processes 5; ## Default: 1 error_log /dev/stderr; pid /tmp/nginx.pid; worker_rlimit_nofile 8192; events { worker_connections 4096; ## Default: 1024 } http { client_body_temp_path /tmp/client_temp; proxy_temp_path /tmp/proxy_temp_path; fastcgi_temp_path /tmp/fastcgi_temp; uwsgi_temp_path /tmp/uwsgi_temp; scgi_temp_path /tmp/scgi_temp; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] $status ' '\"$request\" $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /dev/stderr main; sendfile on; tcp_nopush on; resolver kube-dns.kube-system.svc.cluster.local; server { listen 8080; location = / { return 200 'OK'; auth_basic off; } location = /api/prom/push { # (1) proxy_pass http://loki-write.logging.svc.cluster.local:3100$request_uri; # (2) } location = /api/prom/tail { # (3) proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; # (4) proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } location ~ /api/prom/.* { proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/push { proxy_pass http://loki-write.logging.svc.cluster.local:3100$request_uri; } location = /loki/api/v1/tail { proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } location ~ /loki/api/.* { proxy_pass http://loki-read.logging.svc.cluster.local:3100$request_uri; } } } kind: ConfigMap metadata: annotations: meta.helm.sh/release-name: loki meta.helm.sh/release-namespace: logging creationTimestamp: \"2022-06-17T06:53:22Z\" labels: app.kubernetes.io/component: gateway app.kubernetes.io/instance: loki app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: loki app.kubernetes.io/version: 2.5.0 helm.sh/chart: loki-simple-scalable-1.4.1 name: loki-gateway namespace: logging resourceVersion: \"4968787\" uid: ba9ba1c0-8561-41cb-8b55-287f352b5ee8 \u4e0a\u9762\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684 Nginx \u914d\u7f6e\uff0c\u4ece\u914d\u7f6e\u53ef\u4ee5\u770b\u51fa\u4f1a\u628a\u8bf7\u6c42 /api/prom/push \u548c /loki/api/v1/push \u8fd9\u4e24\u4e2a Push API \u4ee3\u7406\u5230 http://loki-write.logging.svc.cluster.local:3100$request_uri; \uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u7684\u4e24\u4e2a loki-write \u8282\u70b9\uff0c\u800c\u8bfb\u53d6\u76f8\u5173\u7684\u63a5\u53e3\u88ab\u4ee3\u7406\u5230 loki-read \u8282\u70b9\uff0c\u7136\u540e loki-write \u542f\u52a8\u53c2\u6570\u914d\u7f6e -target=write \uff0c loki-read \u542f\u52a8\u53c2\u6570\u914d\u7f6e -target=read \uff0c\u8fd9\u6837\u53bb\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb\u3002\u4e0d\u8fc7\u8bfb\u5199\u7684\u5e94\u7528\u662f\u5171\u4eab\u540c\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u7684\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ kubectl get cm -n logging loki -o yaml apiVersion: v1 data: config.yaml: | auth_enabled: false common: path_prefix: /var/loki replication_factor: 2 storage: s3: access_key_id: enterprise-logs bucketnames: chunks endpoint: loki-minio.logging.svc:9000 insecure: true s3forcepathstyle: true secret_access_key: supersecret limits_config: enforce_metric_name: false max_cache_freshness_per_query: 10m reject_old_samples: true reject_old_samples_max_age: 168h split_queries_by_interval: 15m memberlist: join_members: - loki-memberlist ruler: storage: s3: bucketnames: ruler schema_config: configs: - from: \"2022-06-17\" index: period: 24h prefix: loki_index_ object_store: s3 schema: v12 store: boltdb-shipper server: grpc_listen_port: 9095 http_listen_port: 3100 ...... \u5176\u4e2d common.storage.s3 \u6307\u5b9a\u7684\u662f MinIO \u7684\u76f8\u5173\u914d\u7f6e\uff0c\u901a\u8fc7 memberlist.join_members \u6765\u6307\u5b9a\u6210\u5458\uff0c\u5176\u5b9e\u5c31\u662f\u6240\u6709\u7684\u8bfb\u5199\u8282\u70b9\uff1a $ kubectl get svc loki-memberlist -n logging -o wide NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR loki-memberlist ClusterIP None <none> 7946/TCP 54m app.kubernetes.io/instance=loki,app.kubernetes.io/name=loki,app.kubernetes.io/part-of=memberlist $ kubectl get pods -n logging -l app.kubernetes.io/part-of=memberlist NAME READY STATUS RESTARTS AGE loki-read-0 1/1 Running 0 32s loki-read-1 1/1 Running 0 72s loki-read-2 1/1 Running 0 115s loki-write-0 1/1 Running 0 4s loki-write-1 1/1 Running 0 55s loki-write-2 1/1 Running 0 116s \u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Loki \u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684\u90e8\u7f72\u3002","title":"\u5b89\u88c5"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/#promtail","text":"\u4e3a\u4e86\u9a8c\u8bc1\u5e94\u7528\u662f\u5426\u6b63\u5e38\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5b89\u88c5 Promtail \u548c Grafana \u6765\u8fdb\u884c\u6570\u636e\u7684\u8bfb\u5199\u3002 \u83b7\u53d6 promtail \u7684 Chart \u5305\u5e76\u89e3\u538b\uff1a $ helm pull grafana/promtail --untar $ cd promtail \u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a # ci/simple-values.yaml rbac: pspEnabled: false config: clients: - url: http://loki-gateway/loki/api/v1/push # \u6307\u5b9aLoki\u7684\u5730\u5740\uff0cwrite \u7684push\u5730\u5740\uff0cgateway\u7684\u5730\u5740 \u6ce8\u610f\u6211\u4eec\u9700\u8981\u5c06 Promtail \u4e2d\u914d\u7f6e\u7684 Loki \u5730\u5740\u4e3a http://loki-gateway/loki/api/v1/push \uff0c\u8fd9\u6837\u5c31\u662f Promtail \u5c06\u65e5\u5fd7\u6570\u636e\u9996\u5148\u53d1\u9001\u5230 Gateway \u4e0a\u9762\u53bb\uff0c\u7136\u540e Gateway \u6839\u636e\u6211\u4eec\u7684 Endpoints \u53bb\u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5 Promtail\uff1a $ helm upgrade --install promtail -n logging -f ci/simple-values.yaml . Release \"promtail\" does not exist. Installing it now. NAME: promtail LAST DEPLOYED: Fri Jun 17 16:01:08 2022 NAMESPACE: logging STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: *********************************************************************** Welcome to Grafana Promtail Chart version: 5.1.0 Promtail version: 2.5.0 *********************************************************************** Verify the application is working by running these commands: * kubectl --namespace logging port-forward daemonset/promtail 3101 * curl http://127.0.0.1:3101/metrics \u6b63\u5e38\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a promtail\uff1a $ kubectl get pods -n logging -l app.kubernetes.io/name=promtail NAME READY STATUS RESTARTS AGE promtail-5r9hl 1/1 Running 0 2m25s promtail-85mk4 1/1 Running 0 2m25s promtail-qlfnv 1/1 Running 0 2m25s \u6b63\u5e38 promtail \u5c31\u5df2\u7ecf\u5728\u5f00\u59cb\u91c7\u96c6\u6240\u5728\u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\u4e86\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u6570\u636e Push \u7ed9 gateway\uff0cgateway \u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b gateway \u7684\u65e5\u5fd7\uff1a $ kubectl logs -f loki-gateway-67f76958d7-bq46l -n logging 10.244.1.170 - - [17/Jun/2022:08:09:03 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.1.170 - - [17/Jun/2022:08:09:04 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" 10.244.2.205 - - [17/Jun/2022:08:09:05 +0000] 204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\" ...... \u53ef\u4ee5\u770b\u5230 gateway \u73b0\u5728\u5728\u4e00\u76f4\u63a5\u63a5\u6536\u7740 /loki/api/v1/push \u7684\u8bf7\u6c42\uff0c\u4e5f\u5c31\u662f promtail \u53d1\u9001\u8fc7\u6765\u7684\uff0c\u6b63\u5e38\u6765\u8bf4\u73b0\u5728\u65e5\u5fd7\u6570\u636e\u5df2\u7ecf\u5206\u53d1\u7ed9 write \u8282\u70b9\u4e86\uff0cwrite \u8282\u70b9\u5c06\u6570\u636e\u5b58\u50a8\u5728\u4e86 minio \u4e2d\uff0c\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b minio \u4e2d\u5df2\u7ecf\u6709\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u524d\u9762\u5b89\u88c5\u7684\u65f6\u5019\u4e3a minio \u670d\u52a1\u6307\u5b9a\u4e86\u4e00\u4e2a 32000 \u7684 NodePort \u7aef\u53e3\uff1a \u767b\u5f55\u4fe1\u606f\u4e3a\uff1a accessKey: enterprise-logs secretKey: supersecret \u53ef\u4ee5\u770b\u5230 minio \u7684 chunks \u8fd9\u4e2a bucket \u4e2d\u5e76\u6ca1\u6709\u65e5\u5fd7\u6570\u636e\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 bucket \u9ed8\u8ba4\u53ea\u6709\u8bfb\u53d6\u7684\u6743\u9650\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u8be5 bucket \u4fee\u6539\u4e3a\u5177\u6709 \u8bfb\u5199 \u7684\u6743\u9650\uff1a \u6b63\u5e38\u4fee\u6539\u540e\u5c31\u6709\u4ea7\u751f\u4e00\u4e2a fake \u7684\u76ee\u5f55\u4e86\uff0c\u8fd9\u662f\u9ed8\u8ba4\u6ca1\u6709\u63d0\u4f9b\u591a\u79df\u6237\u7684\u6570\u636e\u76ee\u5f55\uff0c\u8be5\u76ee\u5f55\u4e0b\u9762\u5b58\u50a8\u7740\u65e5\u5fd7\u7684 chunk \u6570\u636e\uff1a \u8fd9\u662f Loki \u65e5\u5fd7\u7684\u5199\u5165\u7684\u8def\u5f84\u3002","title":"Promtail \u5199\u6570\u636e"},{"location":"3.k8s/7.logging/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A8%A1%E5%BC%8F/#grafana","text":"\u4e0b\u9762\u6211\u4eec\u6765\u9a8c\u8bc1\u4e0b\u8bfb\u53d6\u8def\u5f84\uff0c\u5b89\u88c5 Grafana \u5bf9\u63a5 Loki\uff1a $ helm pull grafana/grafana --untar $ cd grafana \u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 values \u914d\u7f6e\u6587\u4ef6\uff1a # ci/simple-values.yaml service: type: NodePort nodePort: 32001 rbac: pspEnabled: false persistence: enabled: true storageClassName: local-path accessModes: - ReadWriteOnce size: 1Gi \u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 Grafana\uff1a $ helm upgrade --install grafana -n logging -f ci/simple-values.yaml . Release \"grafana\" has been upgraded. Happy Helming! NAME: grafana LAST DEPLOYED: Fri Jun 17 17:00:24 2022 NAMESPACE: logging STATUS: deployed REVISION: 2 NOTES: 1. Get your 'admin' user password by running: kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo 2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster: grafana.logging.svc.cluster.local Get the Grafana URL to visit by running these commands in the same shell: export NODE_PORT=$(kubectl get --namespace logging -o jsonpath=\"{.spec.ports[0].nodePort}\" services grafana) export NODE_IP=$(kubectl get nodes --namespace logging -o jsonpath=\"{.items[0].status.addresses[0].address}\") echo http://$NODE_IP:$NODE_PORT 3. Login with the password from step 1 and the username: admin \u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u63d0\u793a\u4e2d\u7684\u547d\u4ee4\u83b7\u53d6\u767b\u5f55\u5bc6\u7801\uff1a $ kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo \u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u5bc6\u7801\u548c admin \u7528\u6237\u540d\u767b\u5f55 Grafana\uff1a \u767b\u5f55\u540e\u8fdb\u5165 Grafana \u6dfb\u52a0\u4e00\u4e2a\u6570\u636e\u6e90\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u8981\u586b\u5199 gateway \u7684\u5730\u5740 http://loki-gateway \uff1a \u4fdd\u5b58\u6570\u636e\u6e90\u540e\uff0c\u53ef\u4ee5\u8fdb\u5165 Explore \u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u5b9e\u65f6\u67e5\u770b gateway \u8fd9\u4e2a\u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a \u5982\u679c\u4f60\u80fd\u770b\u5230\u6700\u65b0\u7684\u65e5\u5fd7\u6570\u636e\u90a3\u8bf4\u660e\u6211\u4eec\u90e8\u7f72\u6210\u529f\u4e86\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684 Loki\uff0c\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u53ef\u4ee5\u5927\u5927\u63d0\u9ad8 Loki \u7684\u6027\u80fd\u548c\u5bb9\u91cf\uff0c\u5982\u679c\u8fd9\u79cd\u6a21\u5f0f\u8fd8\u4e0d\u80fd\u6ee1\u8db3\u4f60\u7684\u6570\u636e\u91cf\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528 \u5fae\u670d\u52a1\u6a21\u5f0f \u6765\u90e8\u7f72 Loki \u4e86\u3002","title":"Grafana \u8bfb\u6570\u636e"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","text":"\u914d\u7f6e\u6587\u4ef6 \u00b6 \u914d\u7f6e\u6587\u4ef6 \u00b6 Loki \u7684\u914d\u7f6e\u6587\u4ef6\u975e\u5e38\u590d\u6742\uff0c\u914d\u7f6e\u8d77\u6765\u6709\u4e00\u5b9a\u96be\u5ea6\uff0c\u6240\u4ee5\u6211\u4eec\u975e\u5e38\u6709\u5fc5\u8981\u5bf9 Loki \u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u4e13\u95e8\u7684\u5206\u6790\u3002Loki \u914d\u7f6e\u6587\u4ef6 loki.yaml \u652f\u6301\u7684\u5185\u5bb9\u548c\u9ed8\u8ba4\u503c\u6570\u636e\uff1a # \u7528\u9017\u53f7\u5206\u9694\u7ec4\u4ef6\u5217\u8868\u8fd0\u884c\uff0c\u9ed8\u8ba4\u7684\u503c all \u8fd0\u884c Loki \u5728\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e2d\u3002 # \u503c read \u662f\u4e00\u4e2a\u522b\u540d\uff0c\u7528\u4e8e\u4ec5\u5728\u540c\u4e00\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u4e0e\u8bfb\u53d6\u8def\u5f84\u76f8\u5173\u7684\u7ec4\u4ef6\uff0c\u5982 querier \u548c query-frontend\u3002 # \u503c write \u540c\u6837\u662f\u4e00\u4e2a\u522b\u540d\uff0c\u7528\u4e8e\u4ec5\u5728\u540c\u4e00\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u4e0e\u5199\u8def\u5f84\u76f8\u5173\u7684\u7ec4\u4ef6\uff0c\u5982 ingester \u548c distributor\u3002 # \u652f\u6301\u7684\u503c\u5305\u62ec\uff1aall, compactor, distributor, ingester, querier, query-scheduler, # ingester-querier, query-frontend, index-gateway, ruler, table-manager, read, write\u3002 # \u5f53\u4f7f\u7528 `-list-target` \u547d\u4ee4\u884c\u6807\u5fd7\u8fd0\u884c Loki \u65f6\uff0c\u53ef\u4ee5\u6253\u5370\u53ef\u7528\u76ee\u6807\u7684\u5b8c\u6574\u5217\u8868\u3002 [target: <string> | default = \"all\"] # \u901a\u8fc7 X-Scope-OrgID Header \u542f\u7528\u8eab\u4efd\u9a8c\u8bc1\uff0c\u5982\u679c\u4e3a true\uff0c\u8be5 Header \u5fc5\u987b\u5b58\u5728\u3002 # \u5982\u679c\u4e3a false\uff0cOrgID \u5c06\u59cb\u7ec8\u8bbe\u7f6e\u4e3a \"fake\"\u3002 [auth_enabled: <boolean> | default = true] [ballast_bytes: <int> | default = 0] # \u914d\u7f6e\u5df2\u542f\u52a8\u670d\u52a1\u7684 HTTP \u548c gRPC \u670d\u52a1\u5668\u901a\u4fe1\u3002 [server: <server>] # \u914d\u7f6e distributor\u3002 [distributor: <distributor>] # \u914d\u7f6e querier\uff0c\u4ec5\u5728\u8fd0\u884c\u6240\u6709\u6a21\u5757\u6216 querier \u65f6\u9002\u7528\u3002 [querier: <querier>] # query_scheduler \u5757\u914d\u7f6e Loki \u67e5\u8be2\u8c03\u5ea6\u7a0b\u5e8f\u3002 # \u914d\u7f6e\u540e\uff0c\u5b83\u5c06\u79df\u6237\u67e5\u8be2\u961f\u5217\u4e0e\u67e5\u8be2\u524d\u7aef\u5206\u79bb [query_scheduler: <query_scheduler>] # \u914d\u7f6e Loki query-frontend \u6a21\u5757 [frontend: <frontend>] # \u5728 Loki query-frontend \u914d\u7f6e\u67e5\u8be2\u5206\u5272\u548c\u7f13\u5b58\u3002 [query_range: <query_range>] # \u914d\u7f6e Loki ruler \u6a21\u5757 [ruler: <ruler>] # \u914d\u7f6e distributor \u5982\u4f55\u8fde\u63a5\u5230 ingester\u3002 # \u4ec5\u5728\u8fd0\u884c\u6240\u6709\u7ec4\u4ef6\u3001distributor \u6216 querier \u65f6\u9002\u7528\u3002 [ingester_client: <ingester_client>] # \u914d\u7f6e ingester \u4ee5\u53ca ingester \u5982\u4f55\u5c06\u81ea\u5df1\u6ce8\u518c\u5230 kv \u5b58\u50a8\u3002 [ingester: <ingester>] # \u914d\u7f6e Loki \u5b58\u50a8\u6570\u636e\u7684\u5730\u65b9 [storage_config: <storage_config>] # \u914d\u7f6e Loki \u5728\u6307\u5b9a\u7684\u5b58\u50a8\u4e2d\u5982\u4f55\u5b58\u50a8\u6570\u636e [chunk_store_config: <chunk_store_config>] # \u914d\u7f6e chunk \u7d22\u5f15 schema \u548c\u5b58\u50a8\u7684\u4f4d\u7f6e [schema_config: <schema_config>] # \u914d\u7f6e compactor \u7ec4\u4ef6\uff0c\u8be5\u7ec4\u4ef6\u538b\u7f29\u7d22\u5f15\u5206\u7247\u4ee5\u63d0\u9ad8\u6027\u80fd [compactor: <compactor>] # \u914d\u7f6e\u6bcf\u4e2a\u79df\u6237\u6216\u5168\u5c40\u7684\u9650\u5236 [limits_config: <limits_config>] # \u914d\u7f6e\u5728 Loki querier \u4e2d\u8fd0\u884c\u7684 worker - \u62fe\u53d6\u5e76\u6267\u884c\u67e5\u8be2\u524d\u7aef\u6392\u961f\u7684\u67e5\u8be2\u3002 [frontend_worker: <frontend_worker>] # \u914d\u7f6e\u7528\u4e8e\u4fdd\u7559\u7684 table manager\u3002 [table_manager: <table_manager>] # \u914d\u7f6e runtime config \u6a21\u5757\uff0c\u8d1f\u8d23\u91cd\u65b0\u52a0\u8f7d\u8fd0\u884c\u65f6\u914d\u7f6e\u6587\u4ef6\u3002 [runtime_config: <runtime_config>] # \u914d\u7f6e tracing [tracing: <tracing>] # \u591a\u4e2a\u6a21\u5757\u4e4b\u95f4\u5171\u4eab\u7684\u901a\u7528\u914d\u7f6e\u3002 # \u5982\u679c\u5728\u5176\u4ed6\u90e8\u5206\u4e2d\u7ed9\u51fa\u4e86\u66f4\u5177\u4f53\u7684\u914d\u7f6e\uff0c\u5219\u5c06\u5ffd\u7565\u6b64\u90e8\u5206\u4e2d\u7684\u76f8\u5173\u914d\u7f6e\u3002 [common: <common>] # \u4f7f\u7528\u60c5\u51b5\u62a5\u544a\u7684\u914d\u7f6e [analytics: <analytics>] \u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u4ecb\u7ecd\u51e0\u4e2a\u6838\u5fc3\u7684\u914d\u7f6e\u5757\u3002 common \u00b6 \u901a\u7528\u914d\u7f6e\u5757 common \u662f\u7531\u4e0d\u540c\u7ec4\u4ef6\u5171\u4eab\u7684\u516c\u5171\u5b9a\u4e49\uff0c\u8fd9\u6837\uff0c\u5c31\u4e0d\u5fc5\u5728\u591a\u4e2a\u5730\u65b9\u91cd\u590d\u914d\u7f6e\u4e86\uff0c\u4e0b\u9762\u662f\u8be5\u914d\u7f6e\u5757\u7684\u76f8\u5173\u5c5e\u6027\uff1a # \u4e0d\u540c Loki \u7ec4\u4ef6\u4f7f\u7528\u7684\u516c\u5171\u5b58\u50a8\u914d\u7f6e [storage: <storage>] # \u5b9a\u4e49\u540e\uff0c\u6307\u5b9a\u524d\u7f00\u5c06\u51fa\u73b0\u5728\u7aef\u70b9\u8def\u5f84\u7684\u524d\u9762 [path_prefix: <string>] # \u4f20\u5165\u7684\u6570\u636e\u5e94\u8be5\u88ab\u590d\u5236\u5230 ingester \u7ec4\u4ef6\u591a\u5c11\u6b21 [replication_factor: <int> | default = 3] # \u5982\u679c\u4e3a true\uff0c\u5219 ingester\u3001compactor \u548c query_scheduler \u7684 ring tokens \u5c06\u4fdd\u5b58\u5230 path_prefix \u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4e2d\u3002\u5982\u679c\u5c06\u5176\u8bbe\u7f6e\u4e3a true \u4e14 path_prefix \u524d\u7f00\u4e3a\u7a7a\uff0cLoki \u5c06\u51fa\u9519\u3002 [persist_tokens: <boolean>: default = false] # \u7528\u4e8e\u5185\u90e8\u67e5\u627e\u5730\u5740\u7684\u901a\u7528\u7684\u7f51\u7edc\u63a5\u53e3\u5217\u8868\u3002 # \u5982\u679c\u8bbe\u7f6e\u4e86\u66f4\u5177\u4f53\u7684 \"instance_interface_names\"\uff0c\u5219\u5ffd\u7565\u6b64\u9009\u9879\u3002 # \u5982\u679c\u5728\u516c\u5171\u7684 ring \u6a21\u5757\u4e0b\u914d\u7f6e\u4e86 \"instance_interface_names\"\uff0c\u5219\u8be5\u901a\u7528\u914d\u7f6e \"instance_interface_names\" \u53ea\u9002\u7528\u4e8e\u524d\u7aef\uff0c\u800c\u4e0d\u9002\u7528\u4e8e\u4e0e ring \u76f8\u5173\u7684\u7ec4\u4ef6\uff08\u6bd4\u5982\uff1adistributor\u3001ruler \u7b49\u7b49\uff09 [instance_interface_names: <list of string> | default = [<private network interfaces>]] # Loki \u7ec4\u4ef6\u7528\u4e8e\u66b4\u9732\u5176\u5730\u5740\u7684\u516c\u5171\u5730\u5740\u3002 # \u5982\u679c\u914d\u7f6e\u4e86\u66f4\u5177\u4f53\u7684 \"instance_addr\" \u5730\u5740\uff0c\u8be5\u914d\u7f6e\u4f1a\u88ab\u5ffd\u7565\u3002 # \u5982\u679c \"instance_addr\" \u5728\u516c\u5171 ring \u90e8\u5206\u4e0b\u914d\u7f6e\u4e86\uff0c\u5219\u8be5\u901a\u7528 \"instance_addr\" \u914d\u7f6e\u53ea\u9002\u7528\u4e8e\u524d\u7aef\uff0c\u800c\u4e0d\u9002\u7528\u4e8e\u4e0e ring \u76f8\u5173\u7684\u7ec4\u4ef6\uff08\u6bd4\u5982\uff1adistributor\u3001ruler \u7b49\u7b49\uff09\u3002 [instance_addr: <string>] # \u6240\u6709 Loki rings \u4f7f\u7528\u7684\u901a\u7528 ring \u914d\u7f6e\u3002 # \u5982\u679c\u6307\u5b9a\u4e86\u901a\u7528\u7684 ring \u73af\uff0c\u5219\u5176\u503c\u7528\u4e8e\u5b9a\u4e49\u4efb\u4f55\u672a\u5b9a\u4e49\u7684 ring \u503c\u3002 # \u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u671f\u671b distributor \u7684 ring \u73af\u4f7f\u7528\u516c\u5171\u90e8\u5206\u4e2d\u5b9a\u4e49\u7684 `heartbeat_period`\uff0c\u4f46\u524d\u63d0\u662f distributor \u7684 ring \u672c\u8eab\u6ca1\u6709\u914d\u7f6e `heartbeat_period`\u3002 [ring: <ring>] \u4e0a\u9762\u7684\u901a\u7528\u914d\u7f6e\u5757\u4e2d\u6709\u4e00\u4e2a storage \u7684\u914d\u7f6e\u9879\uff0c\u7528\u6765\u5b9a\u4e49 Loki \u4e0d\u540c\u7ec4\u4ef6\u4f7f\u7528\u7684\u516c\u5171\u5b58\u50a8\u914d\u7f6e\u3002\u5982\u679c\u5728\u914d\u7f6e\u6587\u4ef6\u7684\u5176\u4ed6\u4f4d\u7f6e\u63d0\u4f9b\u4e86\u5bf9\u8c61\u5b58\u50a8\u5ba2\u6237\u7aef\u7684\u4efb\u4f55\u7279\u5b9a\u914d\u7f6e\uff0c\u5219\u8be5\u7279\u5b9a\u914d\u7f6e\u5c06\u53d6\u4ee3\u901a\u7528\u5b58\u50a8\u914d\u7f6e\uff0c\u5bf9\u5e94\u7684\u5c5e\u6027\u5982\u4e0b\u6240\u793a\uff1a # azure \u914d\u7f6e [azure: <azure_storage_config>] # gcs \u914d\u7f6e [gcs: <gcs_storage_config>] # s3 \u914d\u7f6e [s3: <s3_storage_config>] # swift \u914d\u7f6e [swift: <swift_storage_config>] # \u914d\u7f6e\u4e00\u4e2a\uff08\u672c\u5730\uff09\u6587\u4ef6\u7cfb\u7edf [filesystem: <filesystem>] [hedging: <hedging_config>] storage_config \u00b6 Loki \u7684\u5b58\u50a8\u5f15\u64ce\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u5757\u91cc\u9762\u4e3b\u8981\u5b9a\u4e49\u7684\u662f\u5404\u7c7b\u5b58\u50a8\u7684\u4e00\u4e9b\u57fa\u672c\u4fe1\u606f\u3002\u5982\u4e0b\u6240\u793a\uff1a # \u5728 AWS \u4e2d\u7684 chunks \u5b58\u50a8\u7684\u914d\u7f6e\u3002\u5fc5\u9700\u7684\u9009\u9879\u53ea\u6709\u5728 aws \u51fa\u73b0\u65f6\u624d\u9700\u8981\u3002 aws: # S3 \u6216 S3 \u517c\u5bb9\u7684 endpoint URL \u5730\u5740\uff0c\u5e26\u6709\u7f16\u7801\u7684 Key \u548c Secret\u3002 # \u5982\u679c\u4ec5\u5c06 region \u914d\u7f6e\u4e3a\u4e3b\u673a\uff0c\u5219\u5c06\u63a8\u65ad\u51fa\u6b63\u786e\u7684\u7aef\u70b9\u3002 # CLI flag: -s3.url [s3: <string>] # \u8bbe\u7f6e\u4e3a true \u53ef\u5f3a\u5236\u8bf7\u6c42\u4f7f\u7528 path-style \u5bfb\u5740 # CLI flag: -s3.force-path-style [s3forcepathstyle: <boolean> | default = false] # \u4ee5\u9017\u53f7\u5206\u9694\u7684 buckets \u540d\u79f0\u5217\u8868\uff0c\u7528\u4e8e\u5747\u5300\u5206\u5e03 chunks\u3002 # \u5728 s3.url \u6807\u5fd7\u4e2d\u8986\u76d6\u4efb\u610f\u7684 buckets # CLI flag: -s3.buckets [bucketnames: <string> | default = \"\"] # \u8fde\u63a5\u7684 S3 Endpoint # CLI flag: -s3.endpoint [endpoint: <string> | default = \"\"] # AWS \u4f7f\u7528\u7684\u533a\u57df # CLI flag: -s3.region [region: <string> | default = \"\"] # AWS Access Key ID. # CLI flag: -s3.access-key-id [access_key_id: <string> | default = \"\"] # AWS Secret Access Key. # CLI flag: -s3.secret-access-key [secret_access_key: <string> | default = \"\"] # \u7981\u7528 https # CLI flag: -s3.insecure [insecure: <boolean> | default = false] # \u542f\u7528 AES256 AWS \u670d\u52a1\u5668\u7aef\u52a0\u5bc6 # CLI flag: -s3.sse-encryption [sse_encryption: <boolean> | default = false] # ... \u7701\u7565\u5176\u4ed6\u914d\u7f6e # \u914d\u7f6e DynamoDB \u8fde\u63a5 dynamodb: # DynamoDB URL \u5730\u5740 # CLI flag: -dynamodb.url dynamodb_url: <string> # ...... \u7701\u7565 dynamodb \u914d\u7f6e # \u5728 Bigtable \u4e2d\u914d\u7f6e\u5b58\u50a8\u7d22\u5f15\u3002\u53ea\u6709\u5728\u914d\u7f6e\u4e2d\u5b9a\u4e49\u4e86 bigtable \u65f6\uff0c\u624d\u9700\u8981\u5fc5\u586b\u5b57\u6bb5\u3002 bigtable: # BigTable project ID # CLI flag: -bigtable.project project: <string> # BigTable instance ID # CLI flag: -bigtable.instance instance: <string> # \u914d\u7f6e\u8fde\u63a5\u5230 Bigtable \u7684 gRPC \u5ba2\u6237\u7aef [grpc_client_config: <grpc_client_config>] # \u914d\u7f6e\u5b58\u50a8 chunks \u5728 GCS \u4e2d\uff0c\u53ea\u6709\u5728\u914d\u7f6e\u4e2d\u5b9a\u4e49\u4e86 gcs \u65f6\u624d\u9700\u8981\u8be5\u5b57\u6bb5 gcs: # \u8981\u653e\u5165 chunks \u7684 GCS \u5b58\u50a8\u6876\u7684\u540d\u79f0\u3002 # CLI flag: -gcs.bucketname bucket_name: <string> # GCS\u5ba2\u6237\u7aef\u7528\u4e8e\u6bcf\u4e2a PUT \u8bf7\u6c42\u7684\u7f13\u51b2\u533a\u5927\u5c0f\uff0c0\u8868\u793a\u7981\u7528 buffer\u3002 # to disable buffering. # CLI flag: -gcs.chunk-buffer-size [chunk_buffer_size: <int> | default = 0] # \u5bf9 GCS \u7684\u8bf7\u6c42\u8d85\u65f6\u7684\u65f6\u95f4\u3002 # CLI flag: -gcs.request-timeout [request_timeout: <duration> | default = 0s] # \u5728 Cassandra \u4e2d\u5b58\u50a8 chunks \u548c/\u6216 \u7d22\u5f15\u7684\u914d\u7f6e cassandra: # \u7528\u9017\u53f7\u5206\u9694\u7684 Cassandra \u5b9e\u4f8b\u7684\u4e3b\u673a\u540d\u6216 IPs # CLI flag: -cassandra.addresses addresses: <string> # cassandra \u7aef\u53e3 # CLI flag: -cassandra.port [port: <int> | default = 9042] # ...... \u7701\u7565 swift: # ...... \u7701\u7565 # \u5b58\u50a8\u7d22\u5f15\u5728 BoltDB \u4e2d\u7684\u914d\u7f6e\u3002 boltdb: # BoltDB \u7d22\u5f15\u6587\u4ef6\u8def\u5f84 # CLI flag: -boltdb.dir directory: <string> # \u5b58\u50a8 chunks \u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf filesystem: # chunks \u5b58\u50a8\u7684\u8def\u5f84 # CLI flag: -local.chunk-directory directory: <string> # \u4ee5 boltdb \u6587\u4ef6\u7684\u5f62\u5f0f\u5728\u5bf9\u8c61\u5b58\u50a8\uff08GCS/S3/Azure/Swift/Filesystem\uff09\u4e2d\u914d\u7f6e\u5b58\u50a8\u7d22\u5f15\u3002 boltdb_shipper: # ingesters \u5c06\u6570\u636e\u5199\u5165 boltdb \u6587\u4ef6\u7684\u76ee\u5f55\uff0c\u7136\u540e\u7531 shipper \u4e0a\u4f20\u5230\u914d\u7f6e\u7684\u5b58\u50a8\u4e2d # CLI flag: -boltdb.shipper.active-index-directory [active_index_directory: <string> | default = \"\"] # \u7528\u4e8e\u4fdd\u5b58 boltdb \u6587\u4ef6\u7684\u5171\u4eab\u5b58\u50a8\uff0c\u652f\u6301\u7684\u7c7b\u578b\u6709\uff1agcs\u3001s3\u3001azure\u3001filesystem # CLI flag: -boltdb.shipper.shared-store [shared_store: <string> | default = \"\"] # \u7528\u4e8e\u6062\u590d\u67e5\u8be2\u7684 boltDB \u6587\u4ef6\u7684\u7f13\u5b58\u4f4d\u7f6e # CLI flag: -boltdb.shipper.cache-location [cache_location: <string> | default = \"\"] # \u67e5\u8be2\u7f13\u5b58\u4e2d\u6062\u590d\u7684 boltDB \u6587\u4ef6\u7684 TTL # CLI flag: -boltdb.shipper.cache-ttl [cache_ttl: <duration> | default = 24h] # \u5c06\u4e0b\u8f7d\u7684\u6587\u4ef6\u4e0e\u5b58\u50a8\u91cd\u65b0\u540c\u6b65\u7684\u9891\u7387 # CLI flag: -boltdb.shipper.resync-interval [resync_interval: <duration> | default = 5m] # \u4e3a\u67e5\u8be2\u4fdd\u7559\u4e0b\u8f7d\u7d22\u5f15\u7684\u5929\u6570\uff0c\u4ec5\u9002\u7528\u4e8e\u4ee524\u5c0f\u65f6\u5468\u671f\u521b\u5efa\u7684\u8868\u3002 # CLI flag: -boltdb.shipper.query-ready-num-days [query_ready_num_days: <int> | default = 0] index_gateway_client: # Index Gateway gRPC \u670d\u52a1\u5730\u5740 # CLI flag: -boltdb.shipper.index-gateway-client.server-address [server_address: <string> | default = \"\"] # \u8fde\u63a5 Index Gateway gRPC \u670d\u52a1\u7684 gRPC \u5ba2\u6237\u7aef [grpc_client_config: <grpc_client_config>] # \u6d3b\u8dc3\u7d22\u5f15\u7684\u7f13\u5b58\u6709\u6548\u671f\uff0c\u4e0d\u5e94\u9ad8\u4e8e ingester \u8bbe\u7f6e\u4e2d\u7684 `chunk_idle_period`\u3002 # CLI flag: -store.index-cache-validity [index_cache_validity: <duration> | default = 5m] # \u6bcf\u6279\u83b7\u53d6\u7684\u6700\u5927 chunks \u6570\u3002 # CLI flag: -store.max-chunk-batch-size [max_chunk_batch_size: <int> | default = 50] # \u914d\u7f6e\u5982\u4f55\u6784\u5efa\u7d22\u5f15\u67e5\u8be2\u7684\u7f13\u5b58\u3002 index_queries_cache_config: <cache_config> distributor \u00b6 distributor \u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e distributor \u7ec4\u4ef6\uff0c\u8be5\u914d\u7f6e\u5757\u5bf9\u5e94\u7684\u5c5e\u6027\u6709\uff1a # \u914d\u7f6e distributors ring\uff0c\u5728\u542f\u7528 \"global\" \u6444\u53d6\u7387\u7b56\u7565\u65f6\u4f7f\u7528\u3002 ring: kvstore: # ring \u4f7f\u7528\u7684\u540e\u7aef\u5b58\u50a8\uff0c\u652f\u6301\u7684\u503c\u5305\u62ec\uff1aconsul\u3001etcd\u3001inmemory\u3001memberlist # memberlist \u4f7f\u7528\u7684\u662f gossip \u534f\u8bae\u6765\u8ba9\u96c6\u7fa4\u5185\u7684\u6240\u6709\u8282\u70b9\u8fbe\u5230\u6700\u7ec8\u4e00\u81f4\u6027\u7684 # CLI flag: -distributor.ring.store store: <string> # \u5b58\u50a8\u4e2d key \u7684\u524d\u7f00\uff0c \u5e94\u4ee5 `/` \u7ed3\u5c3e\u3002 # CLI flag: -distributor.ring.prefix [prefix: <string> | default = \"collectors/\"] # Consul \u5ba2\u6237\u7aef\u914d\u7f6e\uff0c\u53ea\u6709\u5f53 store \u914d\u7f6e\u4e3a `consul` \u7684\u65f6\u5019\u624d\u9002\u7528 # \u6b64\u5757\u914d\u7f6e\u7684 CLI \u6807\u5fd7\u524d\u7f00\u4e3a\uff1adistributor.ring [consul: <consul_config>] # ETCD v3 \u5ba2\u6237\u7aef\u914d\u7f6e\uff0c\u53ea\u6709\u5f53 store \u914d\u7f6e\u4e3a `etcd` \u7684\u65f6\u5019\u624d\u9002\u7528 # \u6b64\u5757\u914d\u7f6e\u7684 CLI \u6807\u5fd7\u524d\u7f00\u4e3a\uff1adistributor.ring [etcd: <etcd_config>] # \u5fc3\u8df3\u8d85\u65f6\uff0c\u5728\u6b64\u8d85\u65f6\u4e4b\u540e\uff0cring \u5185\u7684 distributor \u88ab\u89c6\u4e3a\u4e0d\u5065\u5eb7\uff0c0\u8868\u793anever # CLI flag: -distributor.ring.heartbeat-timeout [heartbeat_timeout: <duration> | default = 1m] ingester \u00b6 ingester \u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e loki ingester \u7ec4\u4ef6\uff0c\u8be5\u914d\u7f6e\u5757\u5bf9\u5e94\u7684\u5c5e\u6027\u6709\uff1a # \u914d\u7f6e ingester \u7684\u751f\u547d\u5468\u671f - \u5c06\u5982\u4f55\u8fd0\u884c\u4ee5\u53ca\u5728\u4f55\u5904\u6ce8\u518c\u4ee5\u8fdb\u884c\u53d1\u73b0\u3002 lifecycler: ring: kvstore: # ring \u4f7f\u7528\u7684\u540e\u7aef\u5b58\u50a8\uff0c\u652f\u6301\u7684\u503c\u5305\u62ec\uff1aconsul\u3001etcd\u3001inmemory\u3001memberlist # CLI flag: -ring.store [store: <string> | default = \"consul\"] # \u5b58\u50a8\u4e2d key \u7684\u524d\u7f00\uff0c \u5e94\u4ee5 `/` \u7ed3\u5c3e\u3002 # CLI flag: -ring.prefix [prefix: <string> | default = \"collectors/\"] # consul \u5ba2\u6237\u7aef\u914d\u7f6e # CLI flag: <no prefix> [consul: <consul_config>] # etcd \u5ba2\u6237\u7aef\u914d\u7f6e # CLI flag: <no prefix> [etcd: <etcd_config>] # \u5fc3\u8df3\ud83c\udfea\u540e\u5c06\u8df3\u8fc7 ingesters \u7684\u8bfb/\u5199\u64cd\u4f5c\u3002 # CLI flag: -ring.heartbeat-timeout [heartbeat_timeout: <duration> | default = 1m] # \u8981\u5199\u5165\u548c\u8bfb\u53d6\u7684 ingesters \u6570\u3002 # CLI flag: -distributor.replication-factor [replication_factor: <int> | default = 3] # lifecycler \u5c06\u751f\u6210\u5e76\u653e\u5165 ring \u4e2d\u7684 tokens \u6570 # \u5982\u679c\u5b83\u52a0\u5165 ring \u800c\u4e0d\u4ece\u53e6\u4e00\u4e2a lifecycler \u8f6c\u79fb token\u3002 # CLI flag: -ingester.num-tokens [num_tokens: <int> | default = 128] # \u5e95\u5c42 ring \u7684\u5fc3\u8df3\u5468\u671f # CLI flag: -ingester.heartbeat-period [heartbeat_period: <duration> | default = 5s] # \u5f53\u53e6\u4e00\u4e2a\u6210\u5458\u79bb\u5f00\u65f6\uff0c\u8981\u7b49\u5f85\u591a\u957f\u65f6\u95f4\u624d\u80fd\u4ece\u53e6\u5916\u6210\u5458\u5904\u58f0\u660e tokens \u548c chunks\u3002\u5c06\u5728\u5230\u671f\u540e\u81ea\u52a8\u52a0\u5165\u3002 # CLI flag: -ingester.join-after [join_after: <duration> | default = 0s] # \u751f\u6210\u540e\u89c2\u5bdf tokens \u4ee5\u89e3\u51b3\u51b2\u7a81\u3002\u5f53\u4f7f\u7528 gossip ring \u7684\u65f6\u5019\u975e\u5e38\u6709\u7528 # CLI flag: -ingester.observe-period [observe_period: <duration> | default = 0s] # \u51c6\u5907\u5c31\u7eea\u524d\u7684\u6700\u77ed\u7b49\u5f85\u65f6\u95f4\u3002\u8fd9\u662f\u4e3a\u4e86\u89e3\u51b3 ingesters \u9000\u51fa\u548c\u66f4\u65b0\u73af\u7684 race conditions\u3002 # CLI flag: -ingester.min-ready-duration [min_ready_duration: <duration> | default = 15s] # \u8981\u4ece\u4e2d\u8bfb\u53d6\u5730\u5740\u7684\u7f51\u7edc\u63a5\u53e3\u7684\u540d\u79f0\u3002 # CLI flag: -ingester.lifecycler.interface interface_names: - [<string> ... | default = [<private network interfaces>]] # \u9000\u51fa\u524d\u7684 sleep \u65f6\u95f4\uff0c\u4ee5\u786e\u4fdd\u6307\u6807\u88ab\u6b63\u5e38\u6293\u53d6\u3002 # CLI flag: -ingester.final-sleep [final_sleep: <duration> | default = 30s] # \u6700\u5927\u8f6c\u79fb chunks \u91cd\u8bd5\u6b21\u6570 # CLI flag: -ingester.max-transfer-retries [max_transfer_retries: <int> | default = 0] # flush \u64cd\u4f5c\u5e76\u53d1\u6570 # CLI flag: -ingester.concurrent-flushes [concurrent_flushes: <int> | default = 32] # ingester \u5e94\u591a\u4e45\u68c0\u67e5\u4e00\u6b21\u662f\u5426\u6709\u6570\u636e\u5835\u585e\u9700\u8981 flush # CLI flag: -ingester.flush-check-period [flush_check_period: <duration> | default = 30s] # flush\u88ab\u53d6\u6d88\u524d\u7684\u8d85\u65f6\u65f6\u95f4 # CLI flag: -ingester.flush-op-timeout [flush_op_timeout: <duration> | default = 10m] # flush chunk \u540e\uff0c\u5e94\u5728\u5185\u5b58\u4e2d\u4fdd\u7559\u591a\u957f\u65f6\u95f4\u3002 # CLI flag: -ingester.chunks-retain-period [chunk_retain_period: <duration> | default = 0s] # \u5982\u679c chunk \u6ca1\u6709\u8fbe\u5230\u6700\u5927\u5757\u5927\u5c0f\uff0c\u5219\u5728\u5237\u65b0\u4e4b\u524d\uff0cchunk \u5e94\u8be5\u5728\u5185\u5b58\u4e2d\u4fdd\u7559\u591a\u957f\u65f6\u95f4\uff0c\u5e76\u4e14\u6ca1\u6709\u66f4\u65b0\u3002 # \u8fd9\u610f\u5473\u7740\uff0c\u53ea\u8981 half-empty \u7684 chunks \u6ca1\u6709\u63a5\u6536\u5230\u8fdb\u4e00\u6b65\u7684\u5185\u5bb9\uff0c\u5b83\u4eec\u5728\u67d0\u4e2a\u65f6\u95f4\u6bb5\u4e4b\u540e\u4ecd\u5c06\u88ab\u5237\u65b0\u3002 # CLI flag: -ingester.chunks-idle-period [chunk_idle_period: <duration> | default = 30m] # \u4e00\u4e2a chunk block \u672a\u538b\u7f29\u7684\u5927\u5c0f # \u5f53\u8d85\u8fc7\u8be5\u9608\u503c\u540e\uff0chead block \u4f1a\u88ab\u88c1\u526a\u5e76\u538b\u7f29\u5230 chunk \u4e2d\u53bb\u3002 # CLI flag: -ingester.chunks-block-size [chunk_block_size: <int> | default = 262144] # chunks \u538b\u7f29\u540e\u7684\u5927\u5c0f # \u8fd9\u662f\u4e00\u4e2a\u7406\u60f3\u7684\u5927\u5c0f\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u786e\u5207\u7684\u5927\u5c0f\uff0c\u5982\u679c\u56e0\u4e3a\u5176\u4ed6\u539f\u56e0\uff08\u6bd4\u5982 chunk_idle_period\uff09\u88ab flush\uff0cchunks \u53ef\u80fd\u4f1a\u7a0d\u5fae\u5927\u4e00\u4e9b\u6216\u8005\u660e\u663e\u5c0f\u4e00\u4e9b\u3002 # \u503c\u4e3a0\u65f6\uff0c\u5c06\u521b\u5efa\u56fa\u5b9a10\u4e2ablocks\u7684\u5757\uff0c\u975e0\u503c\u5c06\u521b\u5efa\u5177\u6709\u53ef\u53d8 blocks \u7684\u5757\uff0c\u4ee5\u6ee1\u8db3\u76ee\u6807\u5927\u5c0f\u3002 # CLI flag: -ingester.chunk-target-size [chunk_target_size: <int> | default = 1572864] # chunks\u7684\u538b\u7f29\u7b97\u6cd5(\u652f\u6301\u7684\u503c: gzip, lz4, snappy) # \u6839\u636e\u9700\u6c42\u9009\u62e9\u5408\u9002\u7684\u7b97\u6cd5: # - `gzip` \u6700\u9ad8\u7684\u538b\u7f29\u7387\u4f46\u662f\u4e5f\u662f\u6700\u6162\u7684\u538b\u7f29\u901f\u5ea6 (144 kB/chunk) # - `lz4` \u6700\u5feb\u7684\u538b\u7f29\u901f\u5ea6 (188 kB/chunk) # - `snappy` \u5feb\u901f\u6d41\u884c\u7684\u538b\u7f29\u7b97\u6cd5 (272 kB/chunk) # CLI flag: -ingester.chunk-encoding [chunk_encoding: <string> | default = gzip] # \u7528\u4e8e\u540c\u6b65 ingesters \u4ee5\u540c\u65f6\u5207\u5272 chunks \u7684\u53c2\u6570\u3002 # \u540c\u6b65\u5468\u671f\u7528\u4e8e\u5c06\u4f20\u5165\u6761\u76ee\u6eda\u52a8\u5230\u65b0\u7684 chunk\uff0c\u5982\u679c chunk \u7684\u5229\u7528\u7387\u4e0d\u591f\u9ad8\uff08\u4f8b\u5982 \u5f53 sync_min_utilization \u88ab\u8bbe\u7f6e\u4e3a0.5\uff0c\u5c0f\u4e8e50%\uff09\uff0c\u90a3\u4e48 chunk \u7684\u6eda\u52a8\u5c31\u4e0d\u4f1a\u53d1\u751f\u3002 # CLI flag: -ingester.sync-period [sync_period: <duration> | default = 0] # \u6700\u5c0f\u7684\u540c\u6b65\u5229\u7528\u7387 # CLI flag: -ingester.sync-min-utilization [sync_min_utilization: <float> | Default = 0] # \u5f53 push \u5931\u8d25\u540e\uff0c\u6d41\u5c06\u5411\u7528\u6237\u62a5\u544a\u7684\u6700\u5927\u9519\u8bef\u6570\uff0c0\u8868\u793a\u6ca1\u9650\u5236\u3002 # CLI flag: -ingester.max-ignored-stream-errors [max_returned_stream_errors: <int> | default = 10] # \u5185\u5b58\u4e2d timeseries chunk \u7684\u6700\u5927\u6301\u7eed\u65f6\u95f4\u3002 # \u5982\u679c\u4e00\u4e2a timeseries \u8fd0\u884c\u65f6\u95f4\u8d85\u8fc7\u8be5\u503c\uff0c\u5f53\u524d chunk \u5c06\u5237\u65b0\u5230\u5b58\u50a8\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a\u65b0\u533a\u5757\u3002 # CLI flag: -ingester.max-chunk-age [max_chunk_age: <duration> | default = 2h] # \u8fc7\u53bb\u591a\u957f\u65f6\u95f4 ingester \u53ef\u4ee5\u67e5\u8be2\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u3002 # \u8fd9\u53ea\u9002\u7528\u4e8e\u4f7f\u7528 `filesystem` \u5b58\u50a8\u7684\u5171\u4eab ring \u8fd0\u884c\u7684\u591a\u4e2a Loki \u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u4e0d\u4f1a\u5728\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e4b\u95f4\u5171\u4eab\u3002 # \u5f53\u4f7f\u7528\u4efb\u4f55\u5171\u4eab\u5b58\u50a8\u6bd4\u5982S3\u3001GCS\u7684\u65f6\u5019\uff0c\u8be5\u503c\u5fc5\u987b\u8bbe\u7f6e\u4e3a0\u3002 # \u4f7f\u7528\u9664 `filesystem` \u4ee5\u5916\u7684\u4efb\u4f55\u5bf9\u8c61\u5b58\u50a8\u65f6\uff0c\u5c06\u5176\u914d\u7f6e\u4e3a\u975e\u96f6\u503c\u662f\u9519\u8bef\u7684\u3002 # \u4f7f\u7528\u503c -1 \u5141\u8bb8 ingester \u5728\u65f6\u95f4\u4e0a\u65e0\u9650\u8fdc\u5730\u67e5\u8be2\u5b58\u50a8\u3002 # CLI flag: -ingester.query-store-max-look-back-period [query_store_max_look_back_period: <duration> | default = 0] # \u5fd8\u8bb0 ingesters \u7684\u5fc3\u8df3\u65f6\u95f4\u6233\uff0c\u6bd4 `ring.kvstore.heartbeat_timeout` \u8fd8\u8981\u65e9\u3002 # \u8fd9\u76f8\u5f53\u4e8e\u5355\u51fbUI\u4e2d\u7684`/ring`\u3001`forget` \u6309\u94ae\uff1a # ingester \u5c06\u4f1a\u4ece ring \u4e2d\u79fb\u51fa\u6389\u3002 # \u5f53\u4f60\u786e\u5b9a\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\u4e0d\u4f1a\u8fd4\u56de\u65f6\uff0c\u8fd9\u662f\u4e00\u4e2a\u6709\u7528\u7684\u8bbe\u7f6e\u3002 # \u4e00\u4e2a\u793a\u4f8b\u662f\u5f53\u4e0d\u4f7f\u7528\u6709\u72b6\u6001\u96c6\u65f6\u3002 # \u4f7f\u7528 `memberlist.rejoin_interval` > 0 \u6765\u5904\u7406\u7f51\u7edc\u5206\u533a\u60c5\u51b5\u5f53\u4f7f\u7528\u6210\u5458\u5217\u8868\u65f6\u3002 # CLI flag: -ingester.autoforget-unhealthy [autoforget_unhealthy: <boolean> | default = false] # ingester WAL \u8bb0\u5f55\u4f20\u5165\u7684\u65e5\u5fd7\u548c\u5b58\u50a8\u4ed6\u4eec\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4e86\u4fdd\u8bc1\u5df2\u786e\u8ba4\u6570\u636e\u7684\u6301\u4e45\u6027\u5728\u8fdb\u7a0b\u5d29\u6e83\u7684\u60c5\u51b5\u4e0b\u3002 wal: # \u542f\u7528\u5bf9 WAL \u7684\u5199\u64cd\u4f5c\u3002 # CLI flag: -ingester.wal-enabled [enabled: <boolean> | default = true] # WAL \u6570\u636e\u76ee\u5f55 # CLI flag: -ingester.wal-dir [dir: <filename> | default = \"wal\"] # \u542f\u7528 WAL \u65f6\uff0c\u5e94\u5728\u5173\u673a\u65f6\u5c06 chunks \u5237\u65b0\u5230\u957f\u671f\u5b58\u50a8\u4e2d # CLI flag: -ingester.flush-on-shutdown [flush_on_shutdown: <boolean> | default = false] # checkpoints \u88ab\u521b\u5efa\u7684\u95f4\u9694 # CLI flag: ingester.checkpoint-duration [checkpoint_duration: <duration> | default = 5m] # WAL \u5728\u91cd\u653e\u671f\u95f4\u53ef\u80fd\u4f7f\u7528\u7684\u6700\u5927\u5185\u5b58\u5927\u5c0f\u3002 # \u8fbe\u5230\u540e\uff0c\u5728\u7ee7\u7eed\u4e4b\u524d\u5c06\u6570\u636e\u5237\u65b0\u5230\u5b58\u50a8\u4e2d\u53bb\u3002 # \u53ef\u4ee5\u4f7f\u7528\u7684\u5355\u4f4d\u540e\u7f00\u5305\u62ec\uff1aKB\u3001MB\u3001GB\u3002 [replay_memory_ceiling: <string> | default = 4GB] # ingesters \u4e2d\u7528\u4e8e\u8fdb\u7a0b\u5185\u5012\u6392\u7d22\u5f15\u7684\u5206\u7247\u3002 # \u8fd9\u5fc5\u987b\u88ab\u6240\u6709 schema \u4e2d\u7684 shard factors \u6574\u9664\uff0c\u5426\u5219 Loki \u5c06\u4e0d\u4f1a\u542f\u52a8\u3002 [index_shards: <int> | default = 32] querier \u00b6 querier \u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e querier \u7ec4\u4ef6\uff0c\u5305\u542b\u7684\u5c5e\u6027\u6709\uff1a # \u5728\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u671f\u95f4\u67e5\u8be2 ingesters \u6216\u5b58\u50a8\u7684\u8d85\u65f6\u65f6\u95f4\u3002 # CLI flag: -querier.query-timeout [query_timeout: <duration> | default = 1m] # \u4e3a\u5b9e\u65f6\u8ddf\u8e2a\u8bf7\u6c42\u63d0\u4f9b\u670d\u52a1\u7684\u6700\u957f\u6301\u7eed\u65f6\u95f4\u3002 # CLI flag: -querier.tail-max-duration [tail_max_duration: <duration> | default = 1h] # \u53d1\u9001\u8d85\u8fc7\u6700\u5c0f\u6210\u529f\u67e5\u8be2\u8bf7\u6c42\u4e4b\u524d\u7684\u7b49\u5f85\u65f6\u95f4\u3002 # CLI flag: -querier.extra-query-delay [extra_query_delay: <duration> | default = 0s] # \u6700\u5927\u56de\u6eaf\u671f\uff0c\u8d85\u8fc7\u8be5\u503c\uff0c\u67e5\u8be2\u4e0d\u4f1a\u53d1\u9001\u5230 ingester\u3002 # 0 \u610f\u5473\u7740\u6240\u6709\u7684 queries \u88ab\u53d1\u9001\u5230 ingester\u3002 # CLI flag: -querier.query-ingesters-within [query_ingesters_within: <duration> | default = 3h] # \u5141\u8bb8\u7684\u6700\u5927\u5e76\u53d1\u67e5\u8be2\u6570 # CLI flag: -querier.max-concurrent [max_concurrent: <int> | default = 10] # \u4ec5\u67e5\u8be2\u5b58\u50a8\u4e2d\u7684\u6570\u636e\uff0c\u4e0d\u5c1d\u8bd5\u67e5\u8be2\u4efb\u4f55 ingesters # CLI flag: -querier.query-store-only [query_store_only: <boolean> | default = false] # \u662f\u5426\u5141\u8bb8\u67e5\u8be2\u591a\u4e2a\u79df\u6237 # CLI flag: -querier.multi-tenant-queries-enabled [multi_tenant_queries_enabled: <boolean> | default = false] # LogQL \u5f15\u64ce\u914d\u7f6e\u9009\u9879 engine: # \u67e5\u8be2\u6267\u884c\u8d85\u65f6\u65f6\u95f4 # CLI flag: -querier.engine.timeout [timeout: <duration> | default = 3m] # \u67e5\u627e\u65e5\u5fd7\u884c\u7684\u6700\u957f\u65f6\u95f4\uff0c\u4ec5\u9002\u7528\u4e8e\u5373\u65f6\u65e5\u5fd7\u67e5\u8be2\u3002 # CLI flag: -querier.engine.max-lookback-period [max_look_back_period: <duration> | default = 30s] query_range \u00b6 \u7528\u4e8e\u5728 Loki \u67e5\u8be2\u524d\u7aef\u914d\u7f6e\u67e5\u8be2\u5206\u5272\u548c\u7f13\u5b58\u3002 # \u4e0d\u63a8\u8350: \u6309\u65e5\u62c6\u5206\u67e5\u8be2\u5e76\u884c\u6267\u884c\u3002 # \u7528 -querier.split-queries-by-interval \u4ee3\u66ff. # CLI flag: -querier.split-queries-by-day [split_queries_by_day: <boolean> | default = false] # \u5bf9\u4f20\u5165\u67e5\u8be2\u8fdb\u884c\u53d8\u66f4\uff0c\u4f7f\u5176\u5f00\u59cb\u548c\u7ed3\u675f\u4e0e\u5176\u6b65\u957f\u4fdd\u6301\u4e00\u81f4\u3002 # CLI flag: -querier.align-querier-with-step [align_queries_with_step: <boolean> | default = false] results_cache: # \u7f13\u5b58 cache: <cache_config> # \u7f13\u5b58\u67e5\u8be2\u7ed3\u679c # CLI flag: -querier.cache-results [cache_results: <boolean> | default = false] # \u5355\u4e2a\u8bf7\u6c42\u7684\u6700\u5927\u91cd\u8bd5\u6b21\u6570 # CLI flag: -querier.max-retries-per-request [max_retries: <int> | default = 5] # \u6839\u636e\u5b58\u50a8\u5206\u7247\u914d\u7f6e\u6267\u884c\u67e5\u8be2\u5e76\u884c\u5316\uff0c\u5e76\u67e5\u8be2AST\u3002\u6b64\u529f\u80fd\u4ec5\u7531 chunks \u5b58\u50a8\u5f15\u64ce\u652f\u6301\u3002 # CLI flag: -querier.parallelise-shardable-queries [parallelise_shardable_queries: <boolean> | default = true] schema_config \u00b6 \u8fd9\u91cc\u9762\u4e3b\u8981\u5b9a\u4e49\u7684\u662f Loki \u6570\u636e\u5b58\u50a8\u7684\u7b56\u7565\uff0c\u4ece\u9ed8\u8ba4\u7684\u914d\u7f6e\u91cc\u9762\u53ef\u4ee5\u5f97\u5230\u7684\u4fe1\u606f\u662f Loki \u91cc\u9762\u4fdd\u5b58\u7684\u662f2018\u5e744\u670815\u65e5\u4e4b\u540e\u7684\u6570\u636e\uff0c\u540c\u65f6\u539f\u59cb\u6587\u4ef6\uff08chunks\uff09\u5b58\u5728 filesystem \u4e2d\uff0cindex \u5b58\u5728 boltdb \u5f53\u4e2d\u4e14\u4fdd\u5b58\u7684\u5468\u671f\u662f168\u5c0f\u65f6\u3002 # \u7528\u4e8e chunk \u7d22\u5f15 schemas \u914d\u7f6e configs: - [<period_config>] \u5176\u4e2d\u5c31\u5305\u542b\u4e00\u4e2a period_config \u5217\u8868\uff0c\u8be5\u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e\u4ece\u7279\u5b9a\u7684\u65f6\u95f4\u6bb5\u5e94\u8be5\u4f7f\u7528\u54ea\u4e9b\u7d22\u5f15\u6a21\u5f0f\u3002 # \u5e94\u8be5\u521b\u5efa\u7d22\u5f15 buckets \u7684\u7b2c\u4e00\u5929\u7684\u65e5\u671f\u3002 # \u5982\u679c\u8fd9\u662f\u552f\u4e00\u7684 `period_config`\uff0c\u5219\u4f7f\u7528\u8fc7\u53bb\u7684\u65e5\u671f\uff0c\u5426\u5219\u5728\u5e0c\u671b\u6a21\u5f0f\u5207\u6362\u65f6\u4f7f\u7528\u65e5\u671f\u3002 # YYYY-MM-DD \u683c\u5f0f, \u4f8b\u5982: 2018-04-15. [from: <daytime>] # \u4e0b\u9762\u7684 store \u548c object_store \u4f1a\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e2a <storage_config> key\u3002 # \u7528\u4e8e\u7d22\u5f15\u7684\u5b58\u50a8\uff1aaws\u3001aws-dynamo\u3001gcp\u3001bigtable\u3001bigtable-hashed\u3001cassandra\u3001boltdb \u6216\u8005 boltdb-shipper\u3002 store: <string> # \u7528\u4e8e chunks \u7684\u5b58\u50a8\uff1aaws\u3001azure\u3001gcp\u3001bigtable\u3001gcs\u3001cassandra\u3001swift \u6216\u8005 filesystem # \u5982\u679c\u7701\u7565\uff0c\u5219\u9ed8\u8ba4\u4e3a\u4e0e store \u76f8\u540c\u7684\u503c\u3002 [object_store: <string>] # schema \u4f7f\u7528\u7684\u7248\u672c schema: <string> # \u914d\u7f6e\u7d22\u5f15\u5982\u4f55\u66f4\u65b0\u548c\u5b58\u50a8 index: # \u6240\u6709\u5468\u671f\u8868\u7684\u8868\u524d\u7f00\u3002 prefix: <string> # Table \u5468\u671f. [period: <duration> | default = 168h] # \u8981\u6dfb\u52a0\u5230\u6240\u6709\u7ba1\u7406\u7684\u8868\u4e2d\u7684\u6807\u7b7e\u3002 tags: [<string>: <string> ...] # \u914d\u7f6e chunks \u7684\u66f4\u65b0\u548c\u5b58\u50a8\u65b9\u5f0f\u3002 chunks: prefix: <string> [period: <duration> | default = 168h] tags: [<string>: <string> ...] # \u5c06\u521b\u5efa\u591a\u5c11\u4e2a\u5206\u7247\u3002\u4ec5\u5f53 schema \u4e3a v10 \u6216\u66f4\u9ad8\u7248\u672c\u65f6\u4f7f\u7528\u3002 [row_shards: <int> | default = 16] Loki \u5bf9\u4e8e\u6570\u636e\u5b58\u50a8\u7684\u76ee\u6807\u662f\u5411\u540e\u517c\u5bb9\uff0c\u901a\u8fc7\u4fee\u6539 Schema \u914d\u7f6e\u5141\u8bb8\u4ee5\u589e\u91cf\u65b9\u5f0f\u5347\u7ea7\u5230\u65b0\u7684\u5b58\u50a8\u6a21\u5f0f\u3002\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u5728 schema_config \u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 configs \u6761\u76ee\uff0c\u8981\u8bb0\u4f4f\u7684\u662f\u65b0\u52a0\u7684\u5b58\u50a8\u6a21\u5f0f\u8d77\u59cb\u65f6\u95f4\u5fc5\u987b\u662f\u5c06\u6765\u7684\u67d0\u4e2a\u65f6\u95f4\u70b9\uff0c\u8fd9\u6837 Table Manager \u5c31\u53ef\u4ee5\u5728\u4e4b\u524d\u521b\u5efa\u6240\u9700\u7684\u8868\uff0c\u5e76\u786e\u4fdd\u4e0d\u4f1a\u67e5\u8be2\u73b0\u6709\u6570\u636e\u3002\u5426\u5219\u5728\u67e5\u8be2\u65f6\u4f1a\u56e0\u4e22\u5931\u65e7\u7684\u65e5\u5fd7\u7d22\u5f15\u9020\u6210\u65e0\u6cd5\u68c0\u7d22\u3002\u4f8b\u5982\u6211\u4eec\u8981\u628a2022\u5e746\u670818\u65e5\u4e4b\u540e\u7684 Loki \u65e5\u5fd7\u5207\u6362\u5230 cassandra \u548c S3 \u4e0a\uff0c\u90a3\u4e48\u6309\u7167\u5982\u4e0b\u914d\u7f6e\u540e\uff0c\u91cd\u542f\u670d\u52a1\u5373\u53ef\u3002 schema_config: configs: - from: 2018-04-15 store: boltdb object_store: filesystem schema: v10 index: prefix: index_ period: 168h - from: 2022-06-18 store: cassandra object_store: aws schema: v11 index: prefix: index_ period: 720h chunks: prefix: chunks_ period: 720h storage_config: boltdb: directory: /data/loki/index filesystem: directory: /data/loki/chunks cassandra: username: cassandra password: cassandra addresses: cassandra auth: true keyspace: lokiindex aws: s3: s3://<accessKey>:<secretKey>@<s3_url>/<buckets> s3forcepathstyle: true \u4e0a\u9762\u7684\u914d\u7f6e\u610f\u601d\u5c31\u662f\u5bf9\u4e8e2022\u5e746\u670818\u65e5\u4e4b\u524d\u4fdd\u5b58\u7684\u6240\u6709\u6570\u636e\uff0cLoki \u4f7f\u7528 v10 \u7684 schema\uff0c\u5230\u70b9\u4e4b\u540e\u5c31\u91c7\u7528 v11 \u7684 schema \u7b56\u7565\u6765\u5b58\u50a8\u65e5\u5fd7\u3002 cache_config cache_config \u5757\u7528\u6765\u914d\u7f6e Loki \u5c06\u5982\u4f55\u7f13\u5b58 requests\u3001chunks \u548c\u7d22\u5f15\u5230\u4e00\u4e2a\u540e\u7aef\u7f13\u5b58\u5b58\u50a8\u4e2d\u53bb\u3002 # \u5f00\u542f\u5185\u5b58\u7f13\u5b58 # CLI flag: -<prefix>.cache.enable-fifocache [enable_fifocache: <boolean>] # \u7f13\u5b58\u7684\u9ed8\u8ba4\u6709\u6548\u671f\uff08\u9664\u975e\u91cd\u5199\uff09\u3002 # CLI flag: -<prefix>.default-validity [default_validity: <duration>] # \u5728\u4f7f\u7528 memcached \u65f6\u914d\u7f6e\u540e\u53f0\u7f13\u5b58 background: # \u6709\u591a\u5c11 goroutines \u7528\u6765\u5199\u56de memcached\u3002 # CLI flag: -<prefix>.background.write-back-concurrency [writeback_goroutines: <int> | default = 10] # \u540e\u53f0\u5199\u56de memcached \u9700\u8981\u7f13\u5b58\u591a\u5c11 chunks\u3002 # CLI flagL -<prefix>.background.write-back-buffer [writeback_buffer: <int> = 10000] # \u914d\u7f6e memcached memcached: # \u914d\u7f6e memcached \u4e2d\u7684 key \u6709\u6548\u671f # CLI flag: -<prefix>.memcached.expiration expiration: <duration> # \u914d\u7f6e\u6bcf\u4e2a\u6279\u5904\u7406\u8bf7\u6c42\u4e2d\u8981\u83b7\u53d6\u7684 keys \u6570\u91cf\u3002 # CLI flag: -<prefix>.memcached.batchsize batch_size: <int> | default = 1024 # \u5bf9 memcached \u7684\u6700\u5927\u6d3b\u52a8\u8bf7\u6c42\u6570\u3002 # CLI flag: -<prefix>.memcached.parallelism [parallelism: <int> | default = 100] # \u914d\u7f6e\u5982\u4f55\u8fde\u63a5\u5230\u4e00\u4e2a\u6216\u591a\u4e2a memcached \u670d\u52a1\u5668 memcached_client: # \u7f13\u5b58 chunks \u65f6\u7528\u4e8e memcached \u670d\u52a1\u7684\u4e3b\u673a\u540d\u3002 # \u5982\u679c\u4e3a\u7a7a\uff0c\u6ca1\u6709 memcached \u4f1a\u88ab\u4f7f\u7528\u3002\u5c06\u4f7f\u7528 SRV \u67e5\u627e\u3002 # CLI flag: -<prefix>.memcached.hostname [host: <string>] # \u7528\u4e8e\u53d1\u73b0 memcached \u670d\u52a1\u5668\u7684 SRV \u670d\u52a1\u3002 # CLI flag: -<prefix>.memcached.service [service: <string> | default = \"memcached\"] # (\u5b9e\u9a8c\u6027\u7684) DNS \u670d\u52a1\u53d1\u73b0\u5730\u5740\u5217\u8868(\u9017\u53f7\u5206\u9694) # https://cortexmetrics.io/docs/configuration/arguments/#dns-service-discovery # CLI flag: -<prefix>.memcached.addresses [addresses: <string> | default = \"\"] # memcached \u8bf7\u6c42\u8d85\u65f6\u65f6\u95f4 # CLI flag: -<prefix>.memcached.timeout [timeout: <duration> | default = 100ms] # memcached \u5ba2\u6237\u7aef\u6c60\u4e2d\u7684\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\u3002 # CLI flag: -<prefix>.memcached.max-idle-conns [max_idle_conns: <int> | default = 16] # \u8f6e\u8be2 memcached \u670d\u52a1\u5668\u7684 DNS \u7684\u65f6\u95f4\u95f4\u9694\u3002 # CLI flag: -<prefix>.memcached.update-interval [update_interval: <duration> | default = 1m] # \u662f\u5426\u4f7f\u7528\u4e00\u81f4\u54c8\u5e0c\u6765\u53d1\u73b0\u591a\u4e2a memcached \u670d\u52a1\u5668\u3002 # CLI flag: -<prefix>.memcached.consistent-hash [consistent_hash: <boolean> | default = true] # CLI flag: -<prefix>.memcached.max-item-size [max_item_size: <int> | default = 0] # ...... \u7701\u7565 redis: # \u7528\u4e8e\u7f13\u5b58\u7684 Redis Server \u6216 Cluster \u914d\u7f6e # CLI flag: -<prefix>.redis.endpoint [endpoint: <string>] # ...... \u7701\u7565 fifocache: # \u6700\u5927\u7f13\u5b58\u5927\u5c0f\uff08bytes\uff09 # CLI flag: -<prefix>.fifocache.max-size-bytes [max_size_bytes: <string> | default = \"1GB\"] # \u6700\u591a\u7f13\u5b58\u591a\u5c11 items # CLI flag: -<prefix>.fifocache.max-size-items [max_size_items: <int> | default = 0] # \u7f13\u5b58\u6709\u6548\u671f # The value of 0 disables auto-expiration. # CLI flag: -<prefix>.fifocache.ttl [ttl: <duration> | default = 1h] table_manager Table Manager \u662f Loki\u7684\u4e00\u4e2a\u7ec4\u4ef6\uff0c\u4e3b\u8981\u8d1f\u8d23\u5728\u5176\u65f6\u95f4\u6bb5\u5f00\u59cb\u4e4b\u524d\u521b\u5efa\u5468\u671f\u8868\uff0c\u5e76\u5728\u5176\u6570\u636e\u65f6\u95f4\u8303\u56f4\u8d85\u51fa\u4fdd\u7559\u671f\u9650\u65f6\u5c06\u5176\u5220\u9664\u3002\u5b83\u5f53\u524d\u652f\u6301\u7684\u540e\u7aef\u5305\u542b\u5982\u4e0b # \u7528\u4e8e\u8868\u5bb9\u91cf\u66f4\u65b0\u7684\u4e3b\u201c\u5173\u95ed\u5f00\u5173\u201d\uff0c\u4f8b\u5982\u6545\u969c\u6392\u9664\u65f6\u3002 # CLI flag: -table-manager.throughput-updates-disabled [throughput_updates_disabled: <boolean> | default = false] # \u7528\u4e8e\u8868\u4fdd\u7559\u5220\u9664\u7684\u4e3b\u5f00\u5173 # CLI flag: -table-manager.retention-deletes-enabled [retention_deletes_enabled: <boolean> | default = false] # \u5728\u5220\u9664\u8868\u4e4b\u524d\uff0c\u5b83\u4eec\u5c06\u4fdd\u7559\u591a\u957f\u65f6\u95f4\uff0c0s\u8868\u793a\u7981\u7528\u5220\u9664\u3002 # \u4fdd\u7559\u671f\u5fc5\u987b\u662f index / chunks \u8868 \"period\" \u7684\u500d\u6570\u3002 # CLI flag: -table-manager.retention-period [retention_period: <duration> | default = 0s] # \u8868\u7ba1\u7406\u5668\u8f6e\u8be2\u8868\u7684\u65f6\u95f4\u95f4\u9694\u3002 # CLI flag: -table-manager.poll-interval [poll_interval: <duration> | default = 2m] # \u5728\u9700\u8981\u521b\u5efa\u8868\u4e4b\u524d\u7684\u6301\u7eed\u65f6\u95f4\u3002 # CLI flag: -table-manager.periodic-table.grace-period [creation_grace_period: <duration> | default = 10m] # \u914d\u7f6e DynamoDB \u7d22\u5f15\u8868\u3002 # The CLI flags prefix for this block config is: table-manager.index-table index_tables_provisioning: <provision_config> # \u914d\u7f6e DynamoDB chunk \u8868\u3002 # The CLI flags prefix for this block config is: table-manager.chunk-table chunk_tables_provisioning: <provision_config> \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u539f\u59cb\u65e5\u5fd7\u6587\u4ef6\u9664\u4e86\u4f7f\u7528 filesystem \u7684\u5b58\u50a8\u6709\u5468\u671f\u5220\u9664\u65e7\u65e5\u5fd7\u6587\u4ef6\u5916\uff0cLoki \u7684\u5176\u4ed6 chunk \u5b58\u50a8\u5747\u4e0d\u4f1a\u5220\u9664\u65e7\u65e5\u5fd7\u6587\u4ef6 \uff0c\u5982\u679c\u4f60\u7684\u65e5\u5fd7\u539f\u59cb\u6587\u4ef6\u5b58\u50a8\u5728 S3 \u4e0a\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u627e\u5230\u65e7\u7684\u6587\u4ef6\u5220\u9664\uff0c\u8fd9\u4e2a\u52a8\u4f5c\u4ec5\u4ec5\u53ea\u4f1a\u5f71\u54cd\u6211\u4eec\u67e5\u8be2\u4e0d\u5230\u8fd9\u4e2a\u65f6\u95f4\u533a\u57df\u7684\u65e5\u5fd7\u5185\u5bb9\u3002\u5982\u679c\u4f60\u7684 Loki \u5b58\u50a8\u7528\u4e86 table-based \u7684\u5b58\u50a8\u670d\u52a1\uff0c\u90a3\u4e48\u65e5\u5fd7\u7684\u7559\u5b58\u7b56\u7565\u5c31\u4f1a\u53d7\u5230 Table Manager \u7684\u8282\u5236\uff0c\u5b83\u5f53\u524d\u652f\u6301\u7684\u540e\u7aef\u5305\u542b\u5982\u4e0b\uff1a Index \u65e5\u5fd7\u7d22\u5f15 Amazon DynamoDB Google Bigtable Apache Cassandra BoltDB (\u4e3b\u8981\u7528\u4e8e\u672c\u5730\u73af\u5883) Chunk \u65e5\u5fd7\u539f\u59cb\u6587\u4ef6 Amazon DynamoDB Google Bigtable Apache Cassandra Filesystem (\u4e3b\u8981\u7528\u4e8e\u672c\u5730\u73af\u5883) \u7531\u4e8e\u5177\u6709\u7834\u574f\u6027\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Table Manager \u529f\u80fd\u88ab\u7981\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u914d\u7f6e\u4e2d\u663e\u5f0f\u542f\u7528\u6570\u636e\u5220\u9664\u7b56\u7565\u5e76\u5c06\u5176\u4fdd\u7559\u671f\u8bbe\u7f6e\u4e3a\u5927\u4e8e0\u3002 table_manager: retention_deletes_enabled: true retention_period: 336h","title":"kubernetes \u65e5\u5fd7\u914d\u7f6e\u6587\u4ef6"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#_1","text":"","title":"\u914d\u7f6e\u6587\u4ef6"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#_2","text":"Loki \u7684\u914d\u7f6e\u6587\u4ef6\u975e\u5e38\u590d\u6742\uff0c\u914d\u7f6e\u8d77\u6765\u6709\u4e00\u5b9a\u96be\u5ea6\uff0c\u6240\u4ee5\u6211\u4eec\u975e\u5e38\u6709\u5fc5\u8981\u5bf9 Loki \u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u4e13\u95e8\u7684\u5206\u6790\u3002Loki \u914d\u7f6e\u6587\u4ef6 loki.yaml \u652f\u6301\u7684\u5185\u5bb9\u548c\u9ed8\u8ba4\u503c\u6570\u636e\uff1a # \u7528\u9017\u53f7\u5206\u9694\u7ec4\u4ef6\u5217\u8868\u8fd0\u884c\uff0c\u9ed8\u8ba4\u7684\u503c all \u8fd0\u884c Loki \u5728\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e2d\u3002 # \u503c read \u662f\u4e00\u4e2a\u522b\u540d\uff0c\u7528\u4e8e\u4ec5\u5728\u540c\u4e00\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u4e0e\u8bfb\u53d6\u8def\u5f84\u76f8\u5173\u7684\u7ec4\u4ef6\uff0c\u5982 querier \u548c query-frontend\u3002 # \u503c write \u540c\u6837\u662f\u4e00\u4e2a\u522b\u540d\uff0c\u7528\u4e8e\u4ec5\u5728\u540c\u4e00\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u4e0e\u5199\u8def\u5f84\u76f8\u5173\u7684\u7ec4\u4ef6\uff0c\u5982 ingester \u548c distributor\u3002 # \u652f\u6301\u7684\u503c\u5305\u62ec\uff1aall, compactor, distributor, ingester, querier, query-scheduler, # ingester-querier, query-frontend, index-gateway, ruler, table-manager, read, write\u3002 # \u5f53\u4f7f\u7528 `-list-target` \u547d\u4ee4\u884c\u6807\u5fd7\u8fd0\u884c Loki \u65f6\uff0c\u53ef\u4ee5\u6253\u5370\u53ef\u7528\u76ee\u6807\u7684\u5b8c\u6574\u5217\u8868\u3002 [target: <string> | default = \"all\"] # \u901a\u8fc7 X-Scope-OrgID Header \u542f\u7528\u8eab\u4efd\u9a8c\u8bc1\uff0c\u5982\u679c\u4e3a true\uff0c\u8be5 Header \u5fc5\u987b\u5b58\u5728\u3002 # \u5982\u679c\u4e3a false\uff0cOrgID \u5c06\u59cb\u7ec8\u8bbe\u7f6e\u4e3a \"fake\"\u3002 [auth_enabled: <boolean> | default = true] [ballast_bytes: <int> | default = 0] # \u914d\u7f6e\u5df2\u542f\u52a8\u670d\u52a1\u7684 HTTP \u548c gRPC \u670d\u52a1\u5668\u901a\u4fe1\u3002 [server: <server>] # \u914d\u7f6e distributor\u3002 [distributor: <distributor>] # \u914d\u7f6e querier\uff0c\u4ec5\u5728\u8fd0\u884c\u6240\u6709\u6a21\u5757\u6216 querier \u65f6\u9002\u7528\u3002 [querier: <querier>] # query_scheduler \u5757\u914d\u7f6e Loki \u67e5\u8be2\u8c03\u5ea6\u7a0b\u5e8f\u3002 # \u914d\u7f6e\u540e\uff0c\u5b83\u5c06\u79df\u6237\u67e5\u8be2\u961f\u5217\u4e0e\u67e5\u8be2\u524d\u7aef\u5206\u79bb [query_scheduler: <query_scheduler>] # \u914d\u7f6e Loki query-frontend \u6a21\u5757 [frontend: <frontend>] # \u5728 Loki query-frontend \u914d\u7f6e\u67e5\u8be2\u5206\u5272\u548c\u7f13\u5b58\u3002 [query_range: <query_range>] # \u914d\u7f6e Loki ruler \u6a21\u5757 [ruler: <ruler>] # \u914d\u7f6e distributor \u5982\u4f55\u8fde\u63a5\u5230 ingester\u3002 # \u4ec5\u5728\u8fd0\u884c\u6240\u6709\u7ec4\u4ef6\u3001distributor \u6216 querier \u65f6\u9002\u7528\u3002 [ingester_client: <ingester_client>] # \u914d\u7f6e ingester \u4ee5\u53ca ingester \u5982\u4f55\u5c06\u81ea\u5df1\u6ce8\u518c\u5230 kv \u5b58\u50a8\u3002 [ingester: <ingester>] # \u914d\u7f6e Loki \u5b58\u50a8\u6570\u636e\u7684\u5730\u65b9 [storage_config: <storage_config>] # \u914d\u7f6e Loki \u5728\u6307\u5b9a\u7684\u5b58\u50a8\u4e2d\u5982\u4f55\u5b58\u50a8\u6570\u636e [chunk_store_config: <chunk_store_config>] # \u914d\u7f6e chunk \u7d22\u5f15 schema \u548c\u5b58\u50a8\u7684\u4f4d\u7f6e [schema_config: <schema_config>] # \u914d\u7f6e compactor \u7ec4\u4ef6\uff0c\u8be5\u7ec4\u4ef6\u538b\u7f29\u7d22\u5f15\u5206\u7247\u4ee5\u63d0\u9ad8\u6027\u80fd [compactor: <compactor>] # \u914d\u7f6e\u6bcf\u4e2a\u79df\u6237\u6216\u5168\u5c40\u7684\u9650\u5236 [limits_config: <limits_config>] # \u914d\u7f6e\u5728 Loki querier \u4e2d\u8fd0\u884c\u7684 worker - \u62fe\u53d6\u5e76\u6267\u884c\u67e5\u8be2\u524d\u7aef\u6392\u961f\u7684\u67e5\u8be2\u3002 [frontend_worker: <frontend_worker>] # \u914d\u7f6e\u7528\u4e8e\u4fdd\u7559\u7684 table manager\u3002 [table_manager: <table_manager>] # \u914d\u7f6e runtime config \u6a21\u5757\uff0c\u8d1f\u8d23\u91cd\u65b0\u52a0\u8f7d\u8fd0\u884c\u65f6\u914d\u7f6e\u6587\u4ef6\u3002 [runtime_config: <runtime_config>] # \u914d\u7f6e tracing [tracing: <tracing>] # \u591a\u4e2a\u6a21\u5757\u4e4b\u95f4\u5171\u4eab\u7684\u901a\u7528\u914d\u7f6e\u3002 # \u5982\u679c\u5728\u5176\u4ed6\u90e8\u5206\u4e2d\u7ed9\u51fa\u4e86\u66f4\u5177\u4f53\u7684\u914d\u7f6e\uff0c\u5219\u5c06\u5ffd\u7565\u6b64\u90e8\u5206\u4e2d\u7684\u76f8\u5173\u914d\u7f6e\u3002 [common: <common>] # \u4f7f\u7528\u60c5\u51b5\u62a5\u544a\u7684\u914d\u7f6e [analytics: <analytics>] \u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u4ecb\u7ecd\u51e0\u4e2a\u6838\u5fc3\u7684\u914d\u7f6e\u5757\u3002","title":"\u914d\u7f6e\u6587\u4ef6"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#common","text":"\u901a\u7528\u914d\u7f6e\u5757 common \u662f\u7531\u4e0d\u540c\u7ec4\u4ef6\u5171\u4eab\u7684\u516c\u5171\u5b9a\u4e49\uff0c\u8fd9\u6837\uff0c\u5c31\u4e0d\u5fc5\u5728\u591a\u4e2a\u5730\u65b9\u91cd\u590d\u914d\u7f6e\u4e86\uff0c\u4e0b\u9762\u662f\u8be5\u914d\u7f6e\u5757\u7684\u76f8\u5173\u5c5e\u6027\uff1a # \u4e0d\u540c Loki \u7ec4\u4ef6\u4f7f\u7528\u7684\u516c\u5171\u5b58\u50a8\u914d\u7f6e [storage: <storage>] # \u5b9a\u4e49\u540e\uff0c\u6307\u5b9a\u524d\u7f00\u5c06\u51fa\u73b0\u5728\u7aef\u70b9\u8def\u5f84\u7684\u524d\u9762 [path_prefix: <string>] # \u4f20\u5165\u7684\u6570\u636e\u5e94\u8be5\u88ab\u590d\u5236\u5230 ingester \u7ec4\u4ef6\u591a\u5c11\u6b21 [replication_factor: <int> | default = 3] # \u5982\u679c\u4e3a true\uff0c\u5219 ingester\u3001compactor \u548c query_scheduler \u7684 ring tokens \u5c06\u4fdd\u5b58\u5230 path_prefix \u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4e2d\u3002\u5982\u679c\u5c06\u5176\u8bbe\u7f6e\u4e3a true \u4e14 path_prefix \u524d\u7f00\u4e3a\u7a7a\uff0cLoki \u5c06\u51fa\u9519\u3002 [persist_tokens: <boolean>: default = false] # \u7528\u4e8e\u5185\u90e8\u67e5\u627e\u5730\u5740\u7684\u901a\u7528\u7684\u7f51\u7edc\u63a5\u53e3\u5217\u8868\u3002 # \u5982\u679c\u8bbe\u7f6e\u4e86\u66f4\u5177\u4f53\u7684 \"instance_interface_names\"\uff0c\u5219\u5ffd\u7565\u6b64\u9009\u9879\u3002 # \u5982\u679c\u5728\u516c\u5171\u7684 ring \u6a21\u5757\u4e0b\u914d\u7f6e\u4e86 \"instance_interface_names\"\uff0c\u5219\u8be5\u901a\u7528\u914d\u7f6e \"instance_interface_names\" \u53ea\u9002\u7528\u4e8e\u524d\u7aef\uff0c\u800c\u4e0d\u9002\u7528\u4e8e\u4e0e ring \u76f8\u5173\u7684\u7ec4\u4ef6\uff08\u6bd4\u5982\uff1adistributor\u3001ruler \u7b49\u7b49\uff09 [instance_interface_names: <list of string> | default = [<private network interfaces>]] # Loki \u7ec4\u4ef6\u7528\u4e8e\u66b4\u9732\u5176\u5730\u5740\u7684\u516c\u5171\u5730\u5740\u3002 # \u5982\u679c\u914d\u7f6e\u4e86\u66f4\u5177\u4f53\u7684 \"instance_addr\" \u5730\u5740\uff0c\u8be5\u914d\u7f6e\u4f1a\u88ab\u5ffd\u7565\u3002 # \u5982\u679c \"instance_addr\" \u5728\u516c\u5171 ring \u90e8\u5206\u4e0b\u914d\u7f6e\u4e86\uff0c\u5219\u8be5\u901a\u7528 \"instance_addr\" \u914d\u7f6e\u53ea\u9002\u7528\u4e8e\u524d\u7aef\uff0c\u800c\u4e0d\u9002\u7528\u4e8e\u4e0e ring \u76f8\u5173\u7684\u7ec4\u4ef6\uff08\u6bd4\u5982\uff1adistributor\u3001ruler \u7b49\u7b49\uff09\u3002 [instance_addr: <string>] # \u6240\u6709 Loki rings \u4f7f\u7528\u7684\u901a\u7528 ring \u914d\u7f6e\u3002 # \u5982\u679c\u6307\u5b9a\u4e86\u901a\u7528\u7684 ring \u73af\uff0c\u5219\u5176\u503c\u7528\u4e8e\u5b9a\u4e49\u4efb\u4f55\u672a\u5b9a\u4e49\u7684 ring \u503c\u3002 # \u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u671f\u671b distributor \u7684 ring \u73af\u4f7f\u7528\u516c\u5171\u90e8\u5206\u4e2d\u5b9a\u4e49\u7684 `heartbeat_period`\uff0c\u4f46\u524d\u63d0\u662f distributor \u7684 ring \u672c\u8eab\u6ca1\u6709\u914d\u7f6e `heartbeat_period`\u3002 [ring: <ring>] \u4e0a\u9762\u7684\u901a\u7528\u914d\u7f6e\u5757\u4e2d\u6709\u4e00\u4e2a storage \u7684\u914d\u7f6e\u9879\uff0c\u7528\u6765\u5b9a\u4e49 Loki \u4e0d\u540c\u7ec4\u4ef6\u4f7f\u7528\u7684\u516c\u5171\u5b58\u50a8\u914d\u7f6e\u3002\u5982\u679c\u5728\u914d\u7f6e\u6587\u4ef6\u7684\u5176\u4ed6\u4f4d\u7f6e\u63d0\u4f9b\u4e86\u5bf9\u8c61\u5b58\u50a8\u5ba2\u6237\u7aef\u7684\u4efb\u4f55\u7279\u5b9a\u914d\u7f6e\uff0c\u5219\u8be5\u7279\u5b9a\u914d\u7f6e\u5c06\u53d6\u4ee3\u901a\u7528\u5b58\u50a8\u914d\u7f6e\uff0c\u5bf9\u5e94\u7684\u5c5e\u6027\u5982\u4e0b\u6240\u793a\uff1a # azure \u914d\u7f6e [azure: <azure_storage_config>] # gcs \u914d\u7f6e [gcs: <gcs_storage_config>] # s3 \u914d\u7f6e [s3: <s3_storage_config>] # swift \u914d\u7f6e [swift: <swift_storage_config>] # \u914d\u7f6e\u4e00\u4e2a\uff08\u672c\u5730\uff09\u6587\u4ef6\u7cfb\u7edf [filesystem: <filesystem>] [hedging: <hedging_config>]","title":"common"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#storage_config","text":"Loki \u7684\u5b58\u50a8\u5f15\u64ce\u914d\u7f6e\uff0c\u8fd9\u4e2a\u914d\u7f6e\u5757\u91cc\u9762\u4e3b\u8981\u5b9a\u4e49\u7684\u662f\u5404\u7c7b\u5b58\u50a8\u7684\u4e00\u4e9b\u57fa\u672c\u4fe1\u606f\u3002\u5982\u4e0b\u6240\u793a\uff1a # \u5728 AWS \u4e2d\u7684 chunks \u5b58\u50a8\u7684\u914d\u7f6e\u3002\u5fc5\u9700\u7684\u9009\u9879\u53ea\u6709\u5728 aws \u51fa\u73b0\u65f6\u624d\u9700\u8981\u3002 aws: # S3 \u6216 S3 \u517c\u5bb9\u7684 endpoint URL \u5730\u5740\uff0c\u5e26\u6709\u7f16\u7801\u7684 Key \u548c Secret\u3002 # \u5982\u679c\u4ec5\u5c06 region \u914d\u7f6e\u4e3a\u4e3b\u673a\uff0c\u5219\u5c06\u63a8\u65ad\u51fa\u6b63\u786e\u7684\u7aef\u70b9\u3002 # CLI flag: -s3.url [s3: <string>] # \u8bbe\u7f6e\u4e3a true \u53ef\u5f3a\u5236\u8bf7\u6c42\u4f7f\u7528 path-style \u5bfb\u5740 # CLI flag: -s3.force-path-style [s3forcepathstyle: <boolean> | default = false] # \u4ee5\u9017\u53f7\u5206\u9694\u7684 buckets \u540d\u79f0\u5217\u8868\uff0c\u7528\u4e8e\u5747\u5300\u5206\u5e03 chunks\u3002 # \u5728 s3.url \u6807\u5fd7\u4e2d\u8986\u76d6\u4efb\u610f\u7684 buckets # CLI flag: -s3.buckets [bucketnames: <string> | default = \"\"] # \u8fde\u63a5\u7684 S3 Endpoint # CLI flag: -s3.endpoint [endpoint: <string> | default = \"\"] # AWS \u4f7f\u7528\u7684\u533a\u57df # CLI flag: -s3.region [region: <string> | default = \"\"] # AWS Access Key ID. # CLI flag: -s3.access-key-id [access_key_id: <string> | default = \"\"] # AWS Secret Access Key. # CLI flag: -s3.secret-access-key [secret_access_key: <string> | default = \"\"] # \u7981\u7528 https # CLI flag: -s3.insecure [insecure: <boolean> | default = false] # \u542f\u7528 AES256 AWS \u670d\u52a1\u5668\u7aef\u52a0\u5bc6 # CLI flag: -s3.sse-encryption [sse_encryption: <boolean> | default = false] # ... \u7701\u7565\u5176\u4ed6\u914d\u7f6e # \u914d\u7f6e DynamoDB \u8fde\u63a5 dynamodb: # DynamoDB URL \u5730\u5740 # CLI flag: -dynamodb.url dynamodb_url: <string> # ...... \u7701\u7565 dynamodb \u914d\u7f6e # \u5728 Bigtable \u4e2d\u914d\u7f6e\u5b58\u50a8\u7d22\u5f15\u3002\u53ea\u6709\u5728\u914d\u7f6e\u4e2d\u5b9a\u4e49\u4e86 bigtable \u65f6\uff0c\u624d\u9700\u8981\u5fc5\u586b\u5b57\u6bb5\u3002 bigtable: # BigTable project ID # CLI flag: -bigtable.project project: <string> # BigTable instance ID # CLI flag: -bigtable.instance instance: <string> # \u914d\u7f6e\u8fde\u63a5\u5230 Bigtable \u7684 gRPC \u5ba2\u6237\u7aef [grpc_client_config: <grpc_client_config>] # \u914d\u7f6e\u5b58\u50a8 chunks \u5728 GCS \u4e2d\uff0c\u53ea\u6709\u5728\u914d\u7f6e\u4e2d\u5b9a\u4e49\u4e86 gcs \u65f6\u624d\u9700\u8981\u8be5\u5b57\u6bb5 gcs: # \u8981\u653e\u5165 chunks \u7684 GCS \u5b58\u50a8\u6876\u7684\u540d\u79f0\u3002 # CLI flag: -gcs.bucketname bucket_name: <string> # GCS\u5ba2\u6237\u7aef\u7528\u4e8e\u6bcf\u4e2a PUT \u8bf7\u6c42\u7684\u7f13\u51b2\u533a\u5927\u5c0f\uff0c0\u8868\u793a\u7981\u7528 buffer\u3002 # to disable buffering. # CLI flag: -gcs.chunk-buffer-size [chunk_buffer_size: <int> | default = 0] # \u5bf9 GCS \u7684\u8bf7\u6c42\u8d85\u65f6\u7684\u65f6\u95f4\u3002 # CLI flag: -gcs.request-timeout [request_timeout: <duration> | default = 0s] # \u5728 Cassandra \u4e2d\u5b58\u50a8 chunks \u548c/\u6216 \u7d22\u5f15\u7684\u914d\u7f6e cassandra: # \u7528\u9017\u53f7\u5206\u9694\u7684 Cassandra \u5b9e\u4f8b\u7684\u4e3b\u673a\u540d\u6216 IPs # CLI flag: -cassandra.addresses addresses: <string> # cassandra \u7aef\u53e3 # CLI flag: -cassandra.port [port: <int> | default = 9042] # ...... \u7701\u7565 swift: # ...... \u7701\u7565 # \u5b58\u50a8\u7d22\u5f15\u5728 BoltDB \u4e2d\u7684\u914d\u7f6e\u3002 boltdb: # BoltDB \u7d22\u5f15\u6587\u4ef6\u8def\u5f84 # CLI flag: -boltdb.dir directory: <string> # \u5b58\u50a8 chunks \u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf filesystem: # chunks \u5b58\u50a8\u7684\u8def\u5f84 # CLI flag: -local.chunk-directory directory: <string> # \u4ee5 boltdb \u6587\u4ef6\u7684\u5f62\u5f0f\u5728\u5bf9\u8c61\u5b58\u50a8\uff08GCS/S3/Azure/Swift/Filesystem\uff09\u4e2d\u914d\u7f6e\u5b58\u50a8\u7d22\u5f15\u3002 boltdb_shipper: # ingesters \u5c06\u6570\u636e\u5199\u5165 boltdb \u6587\u4ef6\u7684\u76ee\u5f55\uff0c\u7136\u540e\u7531 shipper \u4e0a\u4f20\u5230\u914d\u7f6e\u7684\u5b58\u50a8\u4e2d # CLI flag: -boltdb.shipper.active-index-directory [active_index_directory: <string> | default = \"\"] # \u7528\u4e8e\u4fdd\u5b58 boltdb \u6587\u4ef6\u7684\u5171\u4eab\u5b58\u50a8\uff0c\u652f\u6301\u7684\u7c7b\u578b\u6709\uff1agcs\u3001s3\u3001azure\u3001filesystem # CLI flag: -boltdb.shipper.shared-store [shared_store: <string> | default = \"\"] # \u7528\u4e8e\u6062\u590d\u67e5\u8be2\u7684 boltDB \u6587\u4ef6\u7684\u7f13\u5b58\u4f4d\u7f6e # CLI flag: -boltdb.shipper.cache-location [cache_location: <string> | default = \"\"] # \u67e5\u8be2\u7f13\u5b58\u4e2d\u6062\u590d\u7684 boltDB \u6587\u4ef6\u7684 TTL # CLI flag: -boltdb.shipper.cache-ttl [cache_ttl: <duration> | default = 24h] # \u5c06\u4e0b\u8f7d\u7684\u6587\u4ef6\u4e0e\u5b58\u50a8\u91cd\u65b0\u540c\u6b65\u7684\u9891\u7387 # CLI flag: -boltdb.shipper.resync-interval [resync_interval: <duration> | default = 5m] # \u4e3a\u67e5\u8be2\u4fdd\u7559\u4e0b\u8f7d\u7d22\u5f15\u7684\u5929\u6570\uff0c\u4ec5\u9002\u7528\u4e8e\u4ee524\u5c0f\u65f6\u5468\u671f\u521b\u5efa\u7684\u8868\u3002 # CLI flag: -boltdb.shipper.query-ready-num-days [query_ready_num_days: <int> | default = 0] index_gateway_client: # Index Gateway gRPC \u670d\u52a1\u5730\u5740 # CLI flag: -boltdb.shipper.index-gateway-client.server-address [server_address: <string> | default = \"\"] # \u8fde\u63a5 Index Gateway gRPC \u670d\u52a1\u7684 gRPC \u5ba2\u6237\u7aef [grpc_client_config: <grpc_client_config>] # \u6d3b\u8dc3\u7d22\u5f15\u7684\u7f13\u5b58\u6709\u6548\u671f\uff0c\u4e0d\u5e94\u9ad8\u4e8e ingester \u8bbe\u7f6e\u4e2d\u7684 `chunk_idle_period`\u3002 # CLI flag: -store.index-cache-validity [index_cache_validity: <duration> | default = 5m] # \u6bcf\u6279\u83b7\u53d6\u7684\u6700\u5927 chunks \u6570\u3002 # CLI flag: -store.max-chunk-batch-size [max_chunk_batch_size: <int> | default = 50] # \u914d\u7f6e\u5982\u4f55\u6784\u5efa\u7d22\u5f15\u67e5\u8be2\u7684\u7f13\u5b58\u3002 index_queries_cache_config: <cache_config>","title":"storage_config"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#distributor","text":"distributor \u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e distributor \u7ec4\u4ef6\uff0c\u8be5\u914d\u7f6e\u5757\u5bf9\u5e94\u7684\u5c5e\u6027\u6709\uff1a # \u914d\u7f6e distributors ring\uff0c\u5728\u542f\u7528 \"global\" \u6444\u53d6\u7387\u7b56\u7565\u65f6\u4f7f\u7528\u3002 ring: kvstore: # ring \u4f7f\u7528\u7684\u540e\u7aef\u5b58\u50a8\uff0c\u652f\u6301\u7684\u503c\u5305\u62ec\uff1aconsul\u3001etcd\u3001inmemory\u3001memberlist # memberlist \u4f7f\u7528\u7684\u662f gossip \u534f\u8bae\u6765\u8ba9\u96c6\u7fa4\u5185\u7684\u6240\u6709\u8282\u70b9\u8fbe\u5230\u6700\u7ec8\u4e00\u81f4\u6027\u7684 # CLI flag: -distributor.ring.store store: <string> # \u5b58\u50a8\u4e2d key \u7684\u524d\u7f00\uff0c \u5e94\u4ee5 `/` \u7ed3\u5c3e\u3002 # CLI flag: -distributor.ring.prefix [prefix: <string> | default = \"collectors/\"] # Consul \u5ba2\u6237\u7aef\u914d\u7f6e\uff0c\u53ea\u6709\u5f53 store \u914d\u7f6e\u4e3a `consul` \u7684\u65f6\u5019\u624d\u9002\u7528 # \u6b64\u5757\u914d\u7f6e\u7684 CLI \u6807\u5fd7\u524d\u7f00\u4e3a\uff1adistributor.ring [consul: <consul_config>] # ETCD v3 \u5ba2\u6237\u7aef\u914d\u7f6e\uff0c\u53ea\u6709\u5f53 store \u914d\u7f6e\u4e3a `etcd` \u7684\u65f6\u5019\u624d\u9002\u7528 # \u6b64\u5757\u914d\u7f6e\u7684 CLI \u6807\u5fd7\u524d\u7f00\u4e3a\uff1adistributor.ring [etcd: <etcd_config>] # \u5fc3\u8df3\u8d85\u65f6\uff0c\u5728\u6b64\u8d85\u65f6\u4e4b\u540e\uff0cring \u5185\u7684 distributor \u88ab\u89c6\u4e3a\u4e0d\u5065\u5eb7\uff0c0\u8868\u793anever # CLI flag: -distributor.ring.heartbeat-timeout [heartbeat_timeout: <duration> | default = 1m]","title":"distributor"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#ingester","text":"ingester \u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e loki ingester \u7ec4\u4ef6\uff0c\u8be5\u914d\u7f6e\u5757\u5bf9\u5e94\u7684\u5c5e\u6027\u6709\uff1a # \u914d\u7f6e ingester \u7684\u751f\u547d\u5468\u671f - \u5c06\u5982\u4f55\u8fd0\u884c\u4ee5\u53ca\u5728\u4f55\u5904\u6ce8\u518c\u4ee5\u8fdb\u884c\u53d1\u73b0\u3002 lifecycler: ring: kvstore: # ring \u4f7f\u7528\u7684\u540e\u7aef\u5b58\u50a8\uff0c\u652f\u6301\u7684\u503c\u5305\u62ec\uff1aconsul\u3001etcd\u3001inmemory\u3001memberlist # CLI flag: -ring.store [store: <string> | default = \"consul\"] # \u5b58\u50a8\u4e2d key \u7684\u524d\u7f00\uff0c \u5e94\u4ee5 `/` \u7ed3\u5c3e\u3002 # CLI flag: -ring.prefix [prefix: <string> | default = \"collectors/\"] # consul \u5ba2\u6237\u7aef\u914d\u7f6e # CLI flag: <no prefix> [consul: <consul_config>] # etcd \u5ba2\u6237\u7aef\u914d\u7f6e # CLI flag: <no prefix> [etcd: <etcd_config>] # \u5fc3\u8df3\ud83c\udfea\u540e\u5c06\u8df3\u8fc7 ingesters \u7684\u8bfb/\u5199\u64cd\u4f5c\u3002 # CLI flag: -ring.heartbeat-timeout [heartbeat_timeout: <duration> | default = 1m] # \u8981\u5199\u5165\u548c\u8bfb\u53d6\u7684 ingesters \u6570\u3002 # CLI flag: -distributor.replication-factor [replication_factor: <int> | default = 3] # lifecycler \u5c06\u751f\u6210\u5e76\u653e\u5165 ring \u4e2d\u7684 tokens \u6570 # \u5982\u679c\u5b83\u52a0\u5165 ring \u800c\u4e0d\u4ece\u53e6\u4e00\u4e2a lifecycler \u8f6c\u79fb token\u3002 # CLI flag: -ingester.num-tokens [num_tokens: <int> | default = 128] # \u5e95\u5c42 ring \u7684\u5fc3\u8df3\u5468\u671f # CLI flag: -ingester.heartbeat-period [heartbeat_period: <duration> | default = 5s] # \u5f53\u53e6\u4e00\u4e2a\u6210\u5458\u79bb\u5f00\u65f6\uff0c\u8981\u7b49\u5f85\u591a\u957f\u65f6\u95f4\u624d\u80fd\u4ece\u53e6\u5916\u6210\u5458\u5904\u58f0\u660e tokens \u548c chunks\u3002\u5c06\u5728\u5230\u671f\u540e\u81ea\u52a8\u52a0\u5165\u3002 # CLI flag: -ingester.join-after [join_after: <duration> | default = 0s] # \u751f\u6210\u540e\u89c2\u5bdf tokens \u4ee5\u89e3\u51b3\u51b2\u7a81\u3002\u5f53\u4f7f\u7528 gossip ring \u7684\u65f6\u5019\u975e\u5e38\u6709\u7528 # CLI flag: -ingester.observe-period [observe_period: <duration> | default = 0s] # \u51c6\u5907\u5c31\u7eea\u524d\u7684\u6700\u77ed\u7b49\u5f85\u65f6\u95f4\u3002\u8fd9\u662f\u4e3a\u4e86\u89e3\u51b3 ingesters \u9000\u51fa\u548c\u66f4\u65b0\u73af\u7684 race conditions\u3002 # CLI flag: -ingester.min-ready-duration [min_ready_duration: <duration> | default = 15s] # \u8981\u4ece\u4e2d\u8bfb\u53d6\u5730\u5740\u7684\u7f51\u7edc\u63a5\u53e3\u7684\u540d\u79f0\u3002 # CLI flag: -ingester.lifecycler.interface interface_names: - [<string> ... | default = [<private network interfaces>]] # \u9000\u51fa\u524d\u7684 sleep \u65f6\u95f4\uff0c\u4ee5\u786e\u4fdd\u6307\u6807\u88ab\u6b63\u5e38\u6293\u53d6\u3002 # CLI flag: -ingester.final-sleep [final_sleep: <duration> | default = 30s] # \u6700\u5927\u8f6c\u79fb chunks \u91cd\u8bd5\u6b21\u6570 # CLI flag: -ingester.max-transfer-retries [max_transfer_retries: <int> | default = 0] # flush \u64cd\u4f5c\u5e76\u53d1\u6570 # CLI flag: -ingester.concurrent-flushes [concurrent_flushes: <int> | default = 32] # ingester \u5e94\u591a\u4e45\u68c0\u67e5\u4e00\u6b21\u662f\u5426\u6709\u6570\u636e\u5835\u585e\u9700\u8981 flush # CLI flag: -ingester.flush-check-period [flush_check_period: <duration> | default = 30s] # flush\u88ab\u53d6\u6d88\u524d\u7684\u8d85\u65f6\u65f6\u95f4 # CLI flag: -ingester.flush-op-timeout [flush_op_timeout: <duration> | default = 10m] # flush chunk \u540e\uff0c\u5e94\u5728\u5185\u5b58\u4e2d\u4fdd\u7559\u591a\u957f\u65f6\u95f4\u3002 # CLI flag: -ingester.chunks-retain-period [chunk_retain_period: <duration> | default = 0s] # \u5982\u679c chunk \u6ca1\u6709\u8fbe\u5230\u6700\u5927\u5757\u5927\u5c0f\uff0c\u5219\u5728\u5237\u65b0\u4e4b\u524d\uff0cchunk \u5e94\u8be5\u5728\u5185\u5b58\u4e2d\u4fdd\u7559\u591a\u957f\u65f6\u95f4\uff0c\u5e76\u4e14\u6ca1\u6709\u66f4\u65b0\u3002 # \u8fd9\u610f\u5473\u7740\uff0c\u53ea\u8981 half-empty \u7684 chunks \u6ca1\u6709\u63a5\u6536\u5230\u8fdb\u4e00\u6b65\u7684\u5185\u5bb9\uff0c\u5b83\u4eec\u5728\u67d0\u4e2a\u65f6\u95f4\u6bb5\u4e4b\u540e\u4ecd\u5c06\u88ab\u5237\u65b0\u3002 # CLI flag: -ingester.chunks-idle-period [chunk_idle_period: <duration> | default = 30m] # \u4e00\u4e2a chunk block \u672a\u538b\u7f29\u7684\u5927\u5c0f # \u5f53\u8d85\u8fc7\u8be5\u9608\u503c\u540e\uff0chead block \u4f1a\u88ab\u88c1\u526a\u5e76\u538b\u7f29\u5230 chunk \u4e2d\u53bb\u3002 # CLI flag: -ingester.chunks-block-size [chunk_block_size: <int> | default = 262144] # chunks \u538b\u7f29\u540e\u7684\u5927\u5c0f # \u8fd9\u662f\u4e00\u4e2a\u7406\u60f3\u7684\u5927\u5c0f\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u786e\u5207\u7684\u5927\u5c0f\uff0c\u5982\u679c\u56e0\u4e3a\u5176\u4ed6\u539f\u56e0\uff08\u6bd4\u5982 chunk_idle_period\uff09\u88ab flush\uff0cchunks \u53ef\u80fd\u4f1a\u7a0d\u5fae\u5927\u4e00\u4e9b\u6216\u8005\u660e\u663e\u5c0f\u4e00\u4e9b\u3002 # \u503c\u4e3a0\u65f6\uff0c\u5c06\u521b\u5efa\u56fa\u5b9a10\u4e2ablocks\u7684\u5757\uff0c\u975e0\u503c\u5c06\u521b\u5efa\u5177\u6709\u53ef\u53d8 blocks \u7684\u5757\uff0c\u4ee5\u6ee1\u8db3\u76ee\u6807\u5927\u5c0f\u3002 # CLI flag: -ingester.chunk-target-size [chunk_target_size: <int> | default = 1572864] # chunks\u7684\u538b\u7f29\u7b97\u6cd5(\u652f\u6301\u7684\u503c: gzip, lz4, snappy) # \u6839\u636e\u9700\u6c42\u9009\u62e9\u5408\u9002\u7684\u7b97\u6cd5: # - `gzip` \u6700\u9ad8\u7684\u538b\u7f29\u7387\u4f46\u662f\u4e5f\u662f\u6700\u6162\u7684\u538b\u7f29\u901f\u5ea6 (144 kB/chunk) # - `lz4` \u6700\u5feb\u7684\u538b\u7f29\u901f\u5ea6 (188 kB/chunk) # - `snappy` \u5feb\u901f\u6d41\u884c\u7684\u538b\u7f29\u7b97\u6cd5 (272 kB/chunk) # CLI flag: -ingester.chunk-encoding [chunk_encoding: <string> | default = gzip] # \u7528\u4e8e\u540c\u6b65 ingesters \u4ee5\u540c\u65f6\u5207\u5272 chunks \u7684\u53c2\u6570\u3002 # \u540c\u6b65\u5468\u671f\u7528\u4e8e\u5c06\u4f20\u5165\u6761\u76ee\u6eda\u52a8\u5230\u65b0\u7684 chunk\uff0c\u5982\u679c chunk \u7684\u5229\u7528\u7387\u4e0d\u591f\u9ad8\uff08\u4f8b\u5982 \u5f53 sync_min_utilization \u88ab\u8bbe\u7f6e\u4e3a0.5\uff0c\u5c0f\u4e8e50%\uff09\uff0c\u90a3\u4e48 chunk \u7684\u6eda\u52a8\u5c31\u4e0d\u4f1a\u53d1\u751f\u3002 # CLI flag: -ingester.sync-period [sync_period: <duration> | default = 0] # \u6700\u5c0f\u7684\u540c\u6b65\u5229\u7528\u7387 # CLI flag: -ingester.sync-min-utilization [sync_min_utilization: <float> | Default = 0] # \u5f53 push \u5931\u8d25\u540e\uff0c\u6d41\u5c06\u5411\u7528\u6237\u62a5\u544a\u7684\u6700\u5927\u9519\u8bef\u6570\uff0c0\u8868\u793a\u6ca1\u9650\u5236\u3002 # CLI flag: -ingester.max-ignored-stream-errors [max_returned_stream_errors: <int> | default = 10] # \u5185\u5b58\u4e2d timeseries chunk \u7684\u6700\u5927\u6301\u7eed\u65f6\u95f4\u3002 # \u5982\u679c\u4e00\u4e2a timeseries \u8fd0\u884c\u65f6\u95f4\u8d85\u8fc7\u8be5\u503c\uff0c\u5f53\u524d chunk \u5c06\u5237\u65b0\u5230\u5b58\u50a8\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a\u65b0\u533a\u5757\u3002 # CLI flag: -ingester.max-chunk-age [max_chunk_age: <duration> | default = 2h] # \u8fc7\u53bb\u591a\u957f\u65f6\u95f4 ingester \u53ef\u4ee5\u67e5\u8be2\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u3002 # \u8fd9\u53ea\u9002\u7528\u4e8e\u4f7f\u7528 `filesystem` \u5b58\u50a8\u7684\u5171\u4eab ring \u8fd0\u884c\u7684\u591a\u4e2a Loki \u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u4e0d\u4f1a\u5728\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e4b\u95f4\u5171\u4eab\u3002 # \u5f53\u4f7f\u7528\u4efb\u4f55\u5171\u4eab\u5b58\u50a8\u6bd4\u5982S3\u3001GCS\u7684\u65f6\u5019\uff0c\u8be5\u503c\u5fc5\u987b\u8bbe\u7f6e\u4e3a0\u3002 # \u4f7f\u7528\u9664 `filesystem` \u4ee5\u5916\u7684\u4efb\u4f55\u5bf9\u8c61\u5b58\u50a8\u65f6\uff0c\u5c06\u5176\u914d\u7f6e\u4e3a\u975e\u96f6\u503c\u662f\u9519\u8bef\u7684\u3002 # \u4f7f\u7528\u503c -1 \u5141\u8bb8 ingester \u5728\u65f6\u95f4\u4e0a\u65e0\u9650\u8fdc\u5730\u67e5\u8be2\u5b58\u50a8\u3002 # CLI flag: -ingester.query-store-max-look-back-period [query_store_max_look_back_period: <duration> | default = 0] # \u5fd8\u8bb0 ingesters \u7684\u5fc3\u8df3\u65f6\u95f4\u6233\uff0c\u6bd4 `ring.kvstore.heartbeat_timeout` \u8fd8\u8981\u65e9\u3002 # \u8fd9\u76f8\u5f53\u4e8e\u5355\u51fbUI\u4e2d\u7684`/ring`\u3001`forget` \u6309\u94ae\uff1a # ingester \u5c06\u4f1a\u4ece ring \u4e2d\u79fb\u51fa\u6389\u3002 # \u5f53\u4f60\u786e\u5b9a\u4e0d\u5065\u5eb7\u7684\u8282\u70b9\u4e0d\u4f1a\u8fd4\u56de\u65f6\uff0c\u8fd9\u662f\u4e00\u4e2a\u6709\u7528\u7684\u8bbe\u7f6e\u3002 # \u4e00\u4e2a\u793a\u4f8b\u662f\u5f53\u4e0d\u4f7f\u7528\u6709\u72b6\u6001\u96c6\u65f6\u3002 # \u4f7f\u7528 `memberlist.rejoin_interval` > 0 \u6765\u5904\u7406\u7f51\u7edc\u5206\u533a\u60c5\u51b5\u5f53\u4f7f\u7528\u6210\u5458\u5217\u8868\u65f6\u3002 # CLI flag: -ingester.autoforget-unhealthy [autoforget_unhealthy: <boolean> | default = false] # ingester WAL \u8bb0\u5f55\u4f20\u5165\u7684\u65e5\u5fd7\u548c\u5b58\u50a8\u4ed6\u4eec\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4e86\u4fdd\u8bc1\u5df2\u786e\u8ba4\u6570\u636e\u7684\u6301\u4e45\u6027\u5728\u8fdb\u7a0b\u5d29\u6e83\u7684\u60c5\u51b5\u4e0b\u3002 wal: # \u542f\u7528\u5bf9 WAL \u7684\u5199\u64cd\u4f5c\u3002 # CLI flag: -ingester.wal-enabled [enabled: <boolean> | default = true] # WAL \u6570\u636e\u76ee\u5f55 # CLI flag: -ingester.wal-dir [dir: <filename> | default = \"wal\"] # \u542f\u7528 WAL \u65f6\uff0c\u5e94\u5728\u5173\u673a\u65f6\u5c06 chunks \u5237\u65b0\u5230\u957f\u671f\u5b58\u50a8\u4e2d # CLI flag: -ingester.flush-on-shutdown [flush_on_shutdown: <boolean> | default = false] # checkpoints \u88ab\u521b\u5efa\u7684\u95f4\u9694 # CLI flag: ingester.checkpoint-duration [checkpoint_duration: <duration> | default = 5m] # WAL \u5728\u91cd\u653e\u671f\u95f4\u53ef\u80fd\u4f7f\u7528\u7684\u6700\u5927\u5185\u5b58\u5927\u5c0f\u3002 # \u8fbe\u5230\u540e\uff0c\u5728\u7ee7\u7eed\u4e4b\u524d\u5c06\u6570\u636e\u5237\u65b0\u5230\u5b58\u50a8\u4e2d\u53bb\u3002 # \u53ef\u4ee5\u4f7f\u7528\u7684\u5355\u4f4d\u540e\u7f00\u5305\u62ec\uff1aKB\u3001MB\u3001GB\u3002 [replay_memory_ceiling: <string> | default = 4GB] # ingesters \u4e2d\u7528\u4e8e\u8fdb\u7a0b\u5185\u5012\u6392\u7d22\u5f15\u7684\u5206\u7247\u3002 # \u8fd9\u5fc5\u987b\u88ab\u6240\u6709 schema \u4e2d\u7684 shard factors \u6574\u9664\uff0c\u5426\u5219 Loki \u5c06\u4e0d\u4f1a\u542f\u52a8\u3002 [index_shards: <int> | default = 32]","title":"ingester"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#querier","text":"querier \u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e querier \u7ec4\u4ef6\uff0c\u5305\u542b\u7684\u5c5e\u6027\u6709\uff1a # \u5728\u6267\u884c\u67e5\u8be2\u8bf7\u6c42\u671f\u95f4\u67e5\u8be2 ingesters \u6216\u5b58\u50a8\u7684\u8d85\u65f6\u65f6\u95f4\u3002 # CLI flag: -querier.query-timeout [query_timeout: <duration> | default = 1m] # \u4e3a\u5b9e\u65f6\u8ddf\u8e2a\u8bf7\u6c42\u63d0\u4f9b\u670d\u52a1\u7684\u6700\u957f\u6301\u7eed\u65f6\u95f4\u3002 # CLI flag: -querier.tail-max-duration [tail_max_duration: <duration> | default = 1h] # \u53d1\u9001\u8d85\u8fc7\u6700\u5c0f\u6210\u529f\u67e5\u8be2\u8bf7\u6c42\u4e4b\u524d\u7684\u7b49\u5f85\u65f6\u95f4\u3002 # CLI flag: -querier.extra-query-delay [extra_query_delay: <duration> | default = 0s] # \u6700\u5927\u56de\u6eaf\u671f\uff0c\u8d85\u8fc7\u8be5\u503c\uff0c\u67e5\u8be2\u4e0d\u4f1a\u53d1\u9001\u5230 ingester\u3002 # 0 \u610f\u5473\u7740\u6240\u6709\u7684 queries \u88ab\u53d1\u9001\u5230 ingester\u3002 # CLI flag: -querier.query-ingesters-within [query_ingesters_within: <duration> | default = 3h] # \u5141\u8bb8\u7684\u6700\u5927\u5e76\u53d1\u67e5\u8be2\u6570 # CLI flag: -querier.max-concurrent [max_concurrent: <int> | default = 10] # \u4ec5\u67e5\u8be2\u5b58\u50a8\u4e2d\u7684\u6570\u636e\uff0c\u4e0d\u5c1d\u8bd5\u67e5\u8be2\u4efb\u4f55 ingesters # CLI flag: -querier.query-store-only [query_store_only: <boolean> | default = false] # \u662f\u5426\u5141\u8bb8\u67e5\u8be2\u591a\u4e2a\u79df\u6237 # CLI flag: -querier.multi-tenant-queries-enabled [multi_tenant_queries_enabled: <boolean> | default = false] # LogQL \u5f15\u64ce\u914d\u7f6e\u9009\u9879 engine: # \u67e5\u8be2\u6267\u884c\u8d85\u65f6\u65f6\u95f4 # CLI flag: -querier.engine.timeout [timeout: <duration> | default = 3m] # \u67e5\u627e\u65e5\u5fd7\u884c\u7684\u6700\u957f\u65f6\u95f4\uff0c\u4ec5\u9002\u7528\u4e8e\u5373\u65f6\u65e5\u5fd7\u67e5\u8be2\u3002 # CLI flag: -querier.engine.max-lookback-period [max_look_back_period: <duration> | default = 30s]","title":"querier"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#query_range","text":"\u7528\u4e8e\u5728 Loki \u67e5\u8be2\u524d\u7aef\u914d\u7f6e\u67e5\u8be2\u5206\u5272\u548c\u7f13\u5b58\u3002 # \u4e0d\u63a8\u8350: \u6309\u65e5\u62c6\u5206\u67e5\u8be2\u5e76\u884c\u6267\u884c\u3002 # \u7528 -querier.split-queries-by-interval \u4ee3\u66ff. # CLI flag: -querier.split-queries-by-day [split_queries_by_day: <boolean> | default = false] # \u5bf9\u4f20\u5165\u67e5\u8be2\u8fdb\u884c\u53d8\u66f4\uff0c\u4f7f\u5176\u5f00\u59cb\u548c\u7ed3\u675f\u4e0e\u5176\u6b65\u957f\u4fdd\u6301\u4e00\u81f4\u3002 # CLI flag: -querier.align-querier-with-step [align_queries_with_step: <boolean> | default = false] results_cache: # \u7f13\u5b58 cache: <cache_config> # \u7f13\u5b58\u67e5\u8be2\u7ed3\u679c # CLI flag: -querier.cache-results [cache_results: <boolean> | default = false] # \u5355\u4e2a\u8bf7\u6c42\u7684\u6700\u5927\u91cd\u8bd5\u6b21\u6570 # CLI flag: -querier.max-retries-per-request [max_retries: <int> | default = 5] # \u6839\u636e\u5b58\u50a8\u5206\u7247\u914d\u7f6e\u6267\u884c\u67e5\u8be2\u5e76\u884c\u5316\uff0c\u5e76\u67e5\u8be2AST\u3002\u6b64\u529f\u80fd\u4ec5\u7531 chunks \u5b58\u50a8\u5f15\u64ce\u652f\u6301\u3002 # CLI flag: -querier.parallelise-shardable-queries [parallelise_shardable_queries: <boolean> | default = true]","title":"query_range"},{"location":"3.k8s/7.logging/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/#schema_config","text":"\u8fd9\u91cc\u9762\u4e3b\u8981\u5b9a\u4e49\u7684\u662f Loki \u6570\u636e\u5b58\u50a8\u7684\u7b56\u7565\uff0c\u4ece\u9ed8\u8ba4\u7684\u914d\u7f6e\u91cc\u9762\u53ef\u4ee5\u5f97\u5230\u7684\u4fe1\u606f\u662f Loki \u91cc\u9762\u4fdd\u5b58\u7684\u662f2018\u5e744\u670815\u65e5\u4e4b\u540e\u7684\u6570\u636e\uff0c\u540c\u65f6\u539f\u59cb\u6587\u4ef6\uff08chunks\uff09\u5b58\u5728 filesystem \u4e2d\uff0cindex \u5b58\u5728 boltdb \u5f53\u4e2d\u4e14\u4fdd\u5b58\u7684\u5468\u671f\u662f168\u5c0f\u65f6\u3002 # \u7528\u4e8e chunk \u7d22\u5f15 schemas \u914d\u7f6e configs: - [<period_config>] \u5176\u4e2d\u5c31\u5305\u542b\u4e00\u4e2a period_config \u5217\u8868\uff0c\u8be5\u914d\u7f6e\u5757\u7528\u4e8e\u914d\u7f6e\u4ece\u7279\u5b9a\u7684\u65f6\u95f4\u6bb5\u5e94\u8be5\u4f7f\u7528\u54ea\u4e9b\u7d22\u5f15\u6a21\u5f0f\u3002 # \u5e94\u8be5\u521b\u5efa\u7d22\u5f15 buckets \u7684\u7b2c\u4e00\u5929\u7684\u65e5\u671f\u3002 # \u5982\u679c\u8fd9\u662f\u552f\u4e00\u7684 `period_config`\uff0c\u5219\u4f7f\u7528\u8fc7\u53bb\u7684\u65e5\u671f\uff0c\u5426\u5219\u5728\u5e0c\u671b\u6a21\u5f0f\u5207\u6362\u65f6\u4f7f\u7528\u65e5\u671f\u3002 # YYYY-MM-DD \u683c\u5f0f, \u4f8b\u5982: 2018-04-15. [from: <daytime>] # \u4e0b\u9762\u7684 store \u548c object_store \u4f1a\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e2a <storage_config> key\u3002 # \u7528\u4e8e\u7d22\u5f15\u7684\u5b58\u50a8\uff1aaws\u3001aws-dynamo\u3001gcp\u3001bigtable\u3001bigtable-hashed\u3001cassandra\u3001boltdb \u6216\u8005 boltdb-shipper\u3002 store: <string> # \u7528\u4e8e chunks \u7684\u5b58\u50a8\uff1aaws\u3001azure\u3001gcp\u3001bigtable\u3001gcs\u3001cassandra\u3001swift \u6216\u8005 filesystem # \u5982\u679c\u7701\u7565\uff0c\u5219\u9ed8\u8ba4\u4e3a\u4e0e store \u76f8\u540c\u7684\u503c\u3002 [object_store: <string>] # schema \u4f7f\u7528\u7684\u7248\u672c schema: <string> # \u914d\u7f6e\u7d22\u5f15\u5982\u4f55\u66f4\u65b0\u548c\u5b58\u50a8 index: # \u6240\u6709\u5468\u671f\u8868\u7684\u8868\u524d\u7f00\u3002 prefix: <string> # Table \u5468\u671f. [period: <duration> | default = 168h] # \u8981\u6dfb\u52a0\u5230\u6240\u6709\u7ba1\u7406\u7684\u8868\u4e2d\u7684\u6807\u7b7e\u3002 tags: [<string>: <string> ...] # \u914d\u7f6e chunks \u7684\u66f4\u65b0\u548c\u5b58\u50a8\u65b9\u5f0f\u3002 chunks: prefix: <string> [period: <duration> | default = 168h] tags: [<string>: <string> ...] # \u5c06\u521b\u5efa\u591a\u5c11\u4e2a\u5206\u7247\u3002\u4ec5\u5f53 schema \u4e3a v10 \u6216\u66f4\u9ad8\u7248\u672c\u65f6\u4f7f\u7528\u3002 [row_shards: <int> | default = 16] Loki \u5bf9\u4e8e\u6570\u636e\u5b58\u50a8\u7684\u76ee\u6807\u662f\u5411\u540e\u517c\u5bb9\uff0c\u901a\u8fc7\u4fee\u6539 Schema \u914d\u7f6e\u5141\u8bb8\u4ee5\u589e\u91cf\u65b9\u5f0f\u5347\u7ea7\u5230\u65b0\u7684\u5b58\u50a8\u6a21\u5f0f\u3002\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u5728 schema_config \u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 configs \u6761\u76ee\uff0c\u8981\u8bb0\u4f4f\u7684\u662f\u65b0\u52a0\u7684\u5b58\u50a8\u6a21\u5f0f\u8d77\u59cb\u65f6\u95f4\u5fc5\u987b\u662f\u5c06\u6765\u7684\u67d0\u4e2a\u65f6\u95f4\u70b9\uff0c\u8fd9\u6837 Table Manager \u5c31\u53ef\u4ee5\u5728\u4e4b\u524d\u521b\u5efa\u6240\u9700\u7684\u8868\uff0c\u5e76\u786e\u4fdd\u4e0d\u4f1a\u67e5\u8be2\u73b0\u6709\u6570\u636e\u3002\u5426\u5219\u5728\u67e5\u8be2\u65f6\u4f1a\u56e0\u4e22\u5931\u65e7\u7684\u65e5\u5fd7\u7d22\u5f15\u9020\u6210\u65e0\u6cd5\u68c0\u7d22\u3002\u4f8b\u5982\u6211\u4eec\u8981\u628a2022\u5e746\u670818\u65e5\u4e4b\u540e\u7684 Loki \u65e5\u5fd7\u5207\u6362\u5230 cassandra \u548c S3 \u4e0a\uff0c\u90a3\u4e48\u6309\u7167\u5982\u4e0b\u914d\u7f6e\u540e\uff0c\u91cd\u542f\u670d\u52a1\u5373\u53ef\u3002 schema_config: configs: - from: 2018-04-15 store: boltdb object_store: filesystem schema: v10 index: prefix: index_ period: 168h - from: 2022-06-18 store: cassandra object_store: aws schema: v11 index: prefix: index_ period: 720h chunks: prefix: chunks_ period: 720h storage_config: boltdb: directory: /data/loki/index filesystem: directory: /data/loki/chunks cassandra: username: cassandra password: cassandra addresses: cassandra auth: true keyspace: lokiindex aws: s3: s3://<accessKey>:<secretKey>@<s3_url>/<buckets> s3forcepathstyle: true \u4e0a\u9762\u7684\u914d\u7f6e\u610f\u601d\u5c31\u662f\u5bf9\u4e8e2022\u5e746\u670818\u65e5\u4e4b\u524d\u4fdd\u5b58\u7684\u6240\u6709\u6570\u636e\uff0cLoki \u4f7f\u7528 v10 \u7684 schema\uff0c\u5230\u70b9\u4e4b\u540e\u5c31\u91c7\u7528 v11 \u7684 schema \u7b56\u7565\u6765\u5b58\u50a8\u65e5\u5fd7\u3002 cache_config cache_config \u5757\u7528\u6765\u914d\u7f6e Loki \u5c06\u5982\u4f55\u7f13\u5b58 requests\u3001chunks \u548c\u7d22\u5f15\u5230\u4e00\u4e2a\u540e\u7aef\u7f13\u5b58\u5b58\u50a8\u4e2d\u53bb\u3002 # \u5f00\u542f\u5185\u5b58\u7f13\u5b58 # CLI flag: -<prefix>.cache.enable-fifocache [enable_fifocache: <boolean>] # \u7f13\u5b58\u7684\u9ed8\u8ba4\u6709\u6548\u671f\uff08\u9664\u975e\u91cd\u5199\uff09\u3002 # CLI flag: -<prefix>.default-validity [default_validity: <duration>] # \u5728\u4f7f\u7528 memcached \u65f6\u914d\u7f6e\u540e\u53f0\u7f13\u5b58 background: # \u6709\u591a\u5c11 goroutines \u7528\u6765\u5199\u56de memcached\u3002 # CLI flag: -<prefix>.background.write-back-concurrency [writeback_goroutines: <int> | default = 10] # \u540e\u53f0\u5199\u56de memcached \u9700\u8981\u7f13\u5b58\u591a\u5c11 chunks\u3002 # CLI flagL -<prefix>.background.write-back-buffer [writeback_buffer: <int> = 10000] # \u914d\u7f6e memcached memcached: # \u914d\u7f6e memcached \u4e2d\u7684 key \u6709\u6548\u671f # CLI flag: -<prefix>.memcached.expiration expiration: <duration> # \u914d\u7f6e\u6bcf\u4e2a\u6279\u5904\u7406\u8bf7\u6c42\u4e2d\u8981\u83b7\u53d6\u7684 keys \u6570\u91cf\u3002 # CLI flag: -<prefix>.memcached.batchsize batch_size: <int> | default = 1024 # \u5bf9 memcached \u7684\u6700\u5927\u6d3b\u52a8\u8bf7\u6c42\u6570\u3002 # CLI flag: -<prefix>.memcached.parallelism [parallelism: <int> | default = 100] # \u914d\u7f6e\u5982\u4f55\u8fde\u63a5\u5230\u4e00\u4e2a\u6216\u591a\u4e2a memcached \u670d\u52a1\u5668 memcached_client: # \u7f13\u5b58 chunks \u65f6\u7528\u4e8e memcached \u670d\u52a1\u7684\u4e3b\u673a\u540d\u3002 # \u5982\u679c\u4e3a\u7a7a\uff0c\u6ca1\u6709 memcached \u4f1a\u88ab\u4f7f\u7528\u3002\u5c06\u4f7f\u7528 SRV \u67e5\u627e\u3002 # CLI flag: -<prefix>.memcached.hostname [host: <string>] # \u7528\u4e8e\u53d1\u73b0 memcached \u670d\u52a1\u5668\u7684 SRV \u670d\u52a1\u3002 # CLI flag: -<prefix>.memcached.service [service: <string> | default = \"memcached\"] # (\u5b9e\u9a8c\u6027\u7684) DNS \u670d\u52a1\u53d1\u73b0\u5730\u5740\u5217\u8868(\u9017\u53f7\u5206\u9694) # https://cortexmetrics.io/docs/configuration/arguments/#dns-service-discovery # CLI flag: -<prefix>.memcached.addresses [addresses: <string> | default = \"\"] # memcached \u8bf7\u6c42\u8d85\u65f6\u65f6\u95f4 # CLI flag: -<prefix>.memcached.timeout [timeout: <duration> | default = 100ms] # memcached \u5ba2\u6237\u7aef\u6c60\u4e2d\u7684\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\u3002 # CLI flag: -<prefix>.memcached.max-idle-conns [max_idle_conns: <int> | default = 16] # \u8f6e\u8be2 memcached \u670d\u52a1\u5668\u7684 DNS \u7684\u65f6\u95f4\u95f4\u9694\u3002 # CLI flag: -<prefix>.memcached.update-interval [update_interval: <duration> | default = 1m] # \u662f\u5426\u4f7f\u7528\u4e00\u81f4\u54c8\u5e0c\u6765\u53d1\u73b0\u591a\u4e2a memcached \u670d\u52a1\u5668\u3002 # CLI flag: -<prefix>.memcached.consistent-hash [consistent_hash: <boolean> | default = true] # CLI flag: -<prefix>.memcached.max-item-size [max_item_size: <int> | default = 0] # ...... \u7701\u7565 redis: # \u7528\u4e8e\u7f13\u5b58\u7684 Redis Server \u6216 Cluster \u914d\u7f6e # CLI flag: -<prefix>.redis.endpoint [endpoint: <string>] # ...... \u7701\u7565 fifocache: # \u6700\u5927\u7f13\u5b58\u5927\u5c0f\uff08bytes\uff09 # CLI flag: -<prefix>.fifocache.max-size-bytes [max_size_bytes: <string> | default = \"1GB\"] # \u6700\u591a\u7f13\u5b58\u591a\u5c11 items # CLI flag: -<prefix>.fifocache.max-size-items [max_size_items: <int> | default = 0] # \u7f13\u5b58\u6709\u6548\u671f # The value of 0 disables auto-expiration. # CLI flag: -<prefix>.fifocache.ttl [ttl: <duration> | default = 1h] table_manager Table Manager \u662f Loki\u7684\u4e00\u4e2a\u7ec4\u4ef6\uff0c\u4e3b\u8981\u8d1f\u8d23\u5728\u5176\u65f6\u95f4\u6bb5\u5f00\u59cb\u4e4b\u524d\u521b\u5efa\u5468\u671f\u8868\uff0c\u5e76\u5728\u5176\u6570\u636e\u65f6\u95f4\u8303\u56f4\u8d85\u51fa\u4fdd\u7559\u671f\u9650\u65f6\u5c06\u5176\u5220\u9664\u3002\u5b83\u5f53\u524d\u652f\u6301\u7684\u540e\u7aef\u5305\u542b\u5982\u4e0b # \u7528\u4e8e\u8868\u5bb9\u91cf\u66f4\u65b0\u7684\u4e3b\u201c\u5173\u95ed\u5f00\u5173\u201d\uff0c\u4f8b\u5982\u6545\u969c\u6392\u9664\u65f6\u3002 # CLI flag: -table-manager.throughput-updates-disabled [throughput_updates_disabled: <boolean> | default = false] # \u7528\u4e8e\u8868\u4fdd\u7559\u5220\u9664\u7684\u4e3b\u5f00\u5173 # CLI flag: -table-manager.retention-deletes-enabled [retention_deletes_enabled: <boolean> | default = false] # \u5728\u5220\u9664\u8868\u4e4b\u524d\uff0c\u5b83\u4eec\u5c06\u4fdd\u7559\u591a\u957f\u65f6\u95f4\uff0c0s\u8868\u793a\u7981\u7528\u5220\u9664\u3002 # \u4fdd\u7559\u671f\u5fc5\u987b\u662f index / chunks \u8868 \"period\" \u7684\u500d\u6570\u3002 # CLI flag: -table-manager.retention-period [retention_period: <duration> | default = 0s] # \u8868\u7ba1\u7406\u5668\u8f6e\u8be2\u8868\u7684\u65f6\u95f4\u95f4\u9694\u3002 # CLI flag: -table-manager.poll-interval [poll_interval: <duration> | default = 2m] # \u5728\u9700\u8981\u521b\u5efa\u8868\u4e4b\u524d\u7684\u6301\u7eed\u65f6\u95f4\u3002 # CLI flag: -table-manager.periodic-table.grace-period [creation_grace_period: <duration> | default = 10m] # \u914d\u7f6e DynamoDB \u7d22\u5f15\u8868\u3002 # The CLI flags prefix for this block config is: table-manager.index-table index_tables_provisioning: <provision_config> # \u914d\u7f6e DynamoDB chunk \u8868\u3002 # The CLI flags prefix for this block config is: table-manager.chunk-table chunk_tables_provisioning: <provision_config> \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u539f\u59cb\u65e5\u5fd7\u6587\u4ef6\u9664\u4e86\u4f7f\u7528 filesystem \u7684\u5b58\u50a8\u6709\u5468\u671f\u5220\u9664\u65e7\u65e5\u5fd7\u6587\u4ef6\u5916\uff0cLoki \u7684\u5176\u4ed6 chunk \u5b58\u50a8\u5747\u4e0d\u4f1a\u5220\u9664\u65e7\u65e5\u5fd7\u6587\u4ef6 \uff0c\u5982\u679c\u4f60\u7684\u65e5\u5fd7\u539f\u59cb\u6587\u4ef6\u5b58\u50a8\u5728 S3 \u4e0a\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u627e\u5230\u65e7\u7684\u6587\u4ef6\u5220\u9664\uff0c\u8fd9\u4e2a\u52a8\u4f5c\u4ec5\u4ec5\u53ea\u4f1a\u5f71\u54cd\u6211\u4eec\u67e5\u8be2\u4e0d\u5230\u8fd9\u4e2a\u65f6\u95f4\u533a\u57df\u7684\u65e5\u5fd7\u5185\u5bb9\u3002\u5982\u679c\u4f60\u7684 Loki \u5b58\u50a8\u7528\u4e86 table-based \u7684\u5b58\u50a8\u670d\u52a1\uff0c\u90a3\u4e48\u65e5\u5fd7\u7684\u7559\u5b58\u7b56\u7565\u5c31\u4f1a\u53d7\u5230 Table Manager \u7684\u8282\u5236\uff0c\u5b83\u5f53\u524d\u652f\u6301\u7684\u540e\u7aef\u5305\u542b\u5982\u4e0b\uff1a Index \u65e5\u5fd7\u7d22\u5f15 Amazon DynamoDB Google Bigtable Apache Cassandra BoltDB (\u4e3b\u8981\u7528\u4e8e\u672c\u5730\u73af\u5883) Chunk \u65e5\u5fd7\u539f\u59cb\u6587\u4ef6 Amazon DynamoDB Google Bigtable Apache Cassandra Filesystem (\u4e3b\u8981\u7528\u4e8e\u672c\u5730\u73af\u5883) \u7531\u4e8e\u5177\u6709\u7834\u574f\u6027\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Table Manager \u529f\u80fd\u88ab\u7981\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u914d\u7f6e\u4e2d\u663e\u5f0f\u542f\u7528\u6570\u636e\u5220\u9664\u7b56\u7565\u5e76\u5c06\u5176\u4fdd\u7559\u671f\u8bbe\u7f6e\u4e3a\u5927\u4e8e0\u3002 table_manager: retention_deletes_enabled: true retention_period: 336h","title":"schema_config"},{"location":"3.k8s/base/k8s-limit-docs/","text":"\u5728 Kubernetes (K8s) \u4e2d\uff0c\u53ef\u4ee5\u5bf9 Pod \u548c Container \u8bbe\u7f6e\u8d44\u6e90\u9650\u5236\uff0c\u5305\u62ec CPU \u548c\u5185\u5b58\u3002\u8fd9\u6837\u53ef\u4ee5\u9632\u6b62\u67d0\u4e2a Pod \u6216 Container \u5360\u7528\u8fc7\u591a\u7684\u8d44\u6e90\uff0c\u5f71\u54cd\u5230\u5176\u4ed6\u7684 Pod \u6216 Container\u3002 \u5bf9\u4e8e CPU\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u7684\u8d44\u6e90\u5305\u62ec requests \u548c limits \uff1a requests \uff1a\u8fd9\u662f Pod \u542f\u52a8\u6240\u9700\u8981\u7684\u6700\u5c0f CPU \u8d44\u6e90\u3002Kubernetes \u4f1a\u786e\u4fdd Pod \u81f3\u5c11\u83b7\u5f97\u8fd9\u4e48\u591a\u7684 CPU \u8d44\u6e90\u3002 limits \uff1a\u8fd9\u662f Pod \u53ef\u4ee5\u4f7f\u7528\u7684\u6700\u5927 CPU \u8d44\u6e90\u3002Pod \u7684 CPU \u4f7f\u7528\u91cf\u4e0d\u4f1a\u8d85\u8fc7\u8fd9\u4e2a\u503c\u3002 \u5bf9\u4e8e\u5185\u5b58\uff0c\u4e5f\u53ef\u4ee5\u8bbe\u7f6e requests \u548c limits \uff1a requests \uff1a\u8fd9\u662f Pod \u542f\u52a8\u6240\u9700\u8981\u7684\u6700\u5c0f\u5185\u5b58\u8d44\u6e90\u3002Kubernetes \u4f1a\u786e\u4fdd Pod \u81f3\u5c11\u83b7\u5f97\u8fd9\u4e48\u591a\u7684\u5185\u5b58\u8d44\u6e90\u3002 limits \uff1a\u8fd9\u662f Pod \u53ef\u4ee5\u4f7f\u7528\u7684\u6700\u5927\u5185\u5b58\u8d44\u6e90\u3002\u5982\u679c Pod \u7684\u5185\u5b58\u4f7f\u7528\u91cf\u8d85\u8fc7\u8fd9\u4e2a\u503c\uff0c\u90a3\u4e48 Pod \u53ef\u80fd\u4f1a\u88ab\u7cfb\u7edf OOM Killer \u6740\u6389\u3002 \u4ee5\u4e0b\u662f\u4e00\u4e2a\u8bbe\u7f6e\u4e86\u8d44\u6e90\u9650\u5236\u7684 Pod \u5b9a\u4e49\u793a\u4f8b\uff1a apiVersion : v1 kind : Pod metadata : name : resource-demo spec : containers : - name : resource-demo-container image : nginx resources : limits : memory : \"200Mi\" cpu : \"500m\" ports : - containerPort : 8080 \u5728\u8fd9\u4e2a\u793a\u4f8b\u4e2d\uff0c resource-demo-container \u8fd9\u4e2a Container \u7684 CPU \u4f7f\u7528\u91cf\u4e0d\u4f1a\u8d85\u8fc7 500m\uff08\u5373\u534a\u4e2a CPU \u6838\u5fc3\u7684\u4f7f\u7528\u91cf\uff09\uff0c\u5185\u5b58\u4f7f\u7528\u91cf\u4e0d\u4f1a\u8d85\u8fc7 200Mi\u3002\u5982\u679c Container \u7684 CPU \u6216\u5185\u5b58\u4f7f\u7528\u91cf\u8d85\u8fc7\u4e86\u8fd9\u4e9b\u503c\uff0cKubernetes \u4f1a\u91c7\u53d6\u76f8\u5e94\u7684\u63aa\u65bd\uff0c\u4f8b\u5982\u9650\u5236 CPU \u4f7f\u7528\u91cf\uff0c\u6216\u8005\u6740\u6389\u5185\u5b58\u4f7f\u7528\u8fc7\u591a\u7684 Pod\u3002 \u6ce8\u610f\uff0c\u8bbe\u7f6e\u8d44\u6e90\u9650\u5236\u65f6\uff0c\u9700\u8981\u8003\u8651\u5230 Pod \u7684\u5b9e\u9645\u9700\u6c42\uff0c\u907f\u514d\u8bbe\u7f6e\u8fc7\u5c0f\u5bfc\u81f4 Pod \u65e0\u6cd5\u6b63\u5e38\u8fd0\u884c\uff0c\u4e5f\u907f\u514d\u8bbe\u7f6e\u8fc7\u5927\u5bfc\u81f4\u8d44\u6e90\u6d6a\u8d39\u3002 CPU \u4ee5\u6838\u5fc3\u4e3a\u5355\u4f4d\uff0cmemory \u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\u30021\u6838\u5fc3=1000\u6beb\u6838 requests \u4e3akubernetes scheduler\u6267\u884cpod\u8c03\u5ea6\u65f6\uff0cnode\u8282\u70b9\u81f3\u5c11\u9700\u8981\u62e5\u6709\u7684\u8d44\u6e90\u3002 limit \u4e3apod\u8fd0\u884c\u6210\u529f\u4e4b\u540e\u6700\u591a\u53ef\u4ee5\u4f7f\u7528\u7684\u8d44\u6e90\u4e0a\u7ebf \u4f8b\u5b501: \u4ee5\u4e0b\u662f\u4e00\u4e2a\u9488\u5bf9\u5185\u5b58\u8d44\u6e90\u9650\u5236\u7684yaml apiVersion: apps/v1 kind: Deployment metadata: name: limit-test-deployment spec: replicas: 1 selector: matchLabels: #rs or deployment app: limit-test-pod # matchExpressions: # - {key: app, operator: In, values: [ng-deploy-80,ng-rs-81]} template: metadata: labels: app: limit-test-pod spec: containers: - name: limit-test-container image: lorel/docker-stress-ng resources: limits: memory: \"512Mi\" requests: memory: \"100Mi\" #command: [\"stress\"] args: [\"--vm\", \"2\", \"--vm-bytes\", \"256M\"] #nodeSelector: # env: group1 \u4f8b\u5b502: \u4ee5\u4e0b\u662f\u4e00\u4e2a\u9488\u5bf9\u5185\u5b58\u548cCPU\u8d44\u6e90\u9650\u5236\u7684yaml apiVersion: apps/v1 kind: Deployment metadata: name: limit-test-deployment spec: replicas: 1 selector: matchLabels: #rs or deployment app: limit-test-pod # matchExpressions: # - {key: app, operator: In, values: [ng-deploy-80,ng-rs-81]} template: metadata: labels: app: limit-test-pod spec: containers: - name: limit-test-container image: lorel/docker-stress-ng resources: limits: cpu: \"1.2\" memory: \"512Mi\" requests: memory: \"100Mi\" cpu: \"500m\" #command: [\"stress\"] args: [\"--vm\", \"2\", \"--vm-bytes\", \"256M\"] #nodeSelector: # env: group1 \u4e00\u822c\u901a\u5e38\u6765\u8bf4\uff0climits\u4e0erequest\u4e3a\u76f8\u540c\u5927\u5c0f\uff0c\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u73af\u5883\u6765\u4fee\u6539\u3002","title":"kubernetes \u8d44\u6e90\u9650\u5236"},{"location":"3.k8s/base/k8s-overview/","text":"k8s \u7b80\u4ecb \u00b6 \u5f00\u6e90\u5bb9\u5668\u5316\u7f16\u6392\u5f15\u64ce\uff0c\u4e13\u7528\u4e8e\u7ba1\u7406\u5bb9\u5668\u5316\u5e94\u7528\u548c\u670d\u52a1\u96c6\u7fa4\u3002 \u6838\u5fc3\u7ec4\u4ef6\u4ecb\u7ecd \u00b6 \u63a7\u5236\u5e73\u9762\u7ec4\u4ef6 \u00b6 kube-apiserver: \u5b98\u65b9\u89e3\u91ca: API \u670d\u52a1\u5668\u662f Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\uff0c \u8be5\u7ec4\u4ef6\u8d1f\u8d23\u516c\u5f00\u4e86 Kubernetes API\uff0c\u8d1f\u8d23\u5904\u7406\u63a5\u53d7\u8bf7\u6c42\u7684\u5de5\u4f5c\u3002 API \u670d\u52a1\u5668\u662f Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u524d\u7aef\u3002 Kubernetes API \u670d\u52a1\u5668\u7684\u4e3b\u8981\u5b9e\u73b0\u662f kube-apiserver\u3002 kube-apiserver \u8bbe\u8ba1\u4e0a\u8003\u8651\u4e86\u6c34\u5e73\u6269\u7f29\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b83\u53ef\u901a\u8fc7\u90e8\u7f72\u591a\u4e2a\u5b9e\u4f8b\u6765\u8fdb\u884c\u6269\u7f29\u3002 \u4f60\u53ef\u4ee5\u8fd0\u884c kube-apiserver \u7684\u591a\u4e2a\u5b9e\u4f8b\uff0c\u5e76\u5728\u8fd9\u4e9b\u5b9e\u4f8b\u4e4b\u95f4\u5e73\u8861\u6d41\u91cf\u3002 \u4e2a\u4eba\u7406\u89e3: k8s\u7684\u8bbf\u95ee\u5165\u53e3\uff0c\u5982\u679c\u60f3\u64cd\u4f5c\u5bb9\u5668\uff0c\u5fc5\u987b\u8981\u901a\u8fc7api-server\u624d\u53ef\u4ee5\u3002k8s\u96c6\u7fa4\u6240\u6709\u7684node\u90fd\u8981\u4e0eapi-server\u8fdb\u884c\u901a\u4fe1\uff0c\u6240\u4ee5node\u7684\u6570\u91cf\u8d8a\u591a\u7ed9api-server\u7684\u538b\u529b\u5c31\u4f1a\u8d8a\u5927\u3002\u6240\u4ee5\u4e00\u822ck8s-master\u90fd\u662f\u96c6\u7fa4\u6765\u9ad8\u53ef\u7528\u7684\uff0c\u901a\u5e38\u6765\u8bf4\u90fd\u662f\u4e09\u4e2a\u8282\u70b9\u3002 kube-scheduler: \u5b98\u65b9\u89e3\u91ca: \u662f\u8d1f\u8d23\u8d44\u6e90\u8c03\u5ea6\u7684\u8fdb\u7a0b\uff0c\u76d1\u89c6\u65b0\u521b\u5efa\u4e14\u6ca1\u6709\u5206\u914d\u5230Node\u7684Pod\uff0c\u4e3aPod \u9009\u62e9\u4e00\u4e2aNode\uff1b \u8c03\u5ea6\u51b3\u7b56\u8003\u8651\u7684\u56e0\u7d20\u5305\u62ec\u5355\u4e2a Pod \u53ca Pods \u96c6\u5408\u7684\u8d44\u6e90\u9700\u6c42\u3001 \u8f6f\u786c\u4ef6\u53ca\u7b56\u7565\u7ea6\u675f\u3001 \u4eb2\u548c\u6027\u53ca\u53cd\u4eb2\u548c\u6027\u89c4\u8303\u3001\u6570\u636e\u4f4d\u7f6e\u3001\u5de5\u4f5c\u8d1f\u8f7d\u95f4\u7684\u5e72\u6270\u53ca\u6700\u540e\u65f6\u9650 . \u4e2a\u4eba\u7406\u89e3: \u7ba1\u7406\u5458\u53d1\u9001\u521b\u5efa\u4e00\u4e2a\u5bb9\u5668\u7684\u6307\u4ee4\u5230api-server\uff0capi-server\u6536\u5230\u8fd9\u4e2a\u6307\u4ee4\u5c31\u5b58\u50a8\u5728etcd\u4e2d\uff0ckube-scheduler\u4f1a\u76d1\u542capi-server\u770b\u770b\u6709\u6ca1\u6709pod\u7684\u64cd\u4f5c\u4e8b\u4ef6\uff0c\u5982\u679c\u6ca1\u6709\u4e0b\u6b21\u63a5\u7740\u67e5\u8be2\uff0c\u5982\u679c\u6709\u7684\u8bdd\uff0ckube-scheduler\u4f1a\u901a\u8fc7api-server\u62ff\u5230etcd\u8fd9\u4e2a\u4e8b\u4ef6\u3002\u7136\u540ekube-scheduler\u4f1a\u6839\u636enode\u7684\u8d44\u6e90\u5229\u7528\u7387\u6765\u8fdb\u884c\u8c03\u5ea6\u3002\u8c03\u5ea6\u4e4b\u540ekube-scheduler\u4f1a\u628a\u7ed3\u679c\u8fd4\u56de\u7ed9api-server\uff0capi-server\u518d\u628a\u7ed3\u679c\u5199\u5230etcd\u3002 kube-controller-manager: \u5b98\u65b9\u89e3\u91ca: \u8fd0\u884c\u7ba1\u7406\u63a7\u5236\u5668\uff0c\u662f\u96c6\u7fa4\u4e2d\u5904\u7406\u5e38\u89c4\u4efb\u52a1\u7684\u540e\u53f0\u8fdb\u7a0b\uff0c\u662fKubernetes \u91cc\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u7684\u81ea\u52a8\u5316\u63a7\u5236\u4e2d\u5fc3\u3002\u903b\u8f91\u4e0a\uff0c\u6bcf\u4e2a\u63a7\u5236\u5668\u662f\u4e00\u4e2a\u5355\u72ec\u7684\u8fdb\u7a0b\uff0c\u4f46\u4e3a\u4e86\u964d\u4f4e\u590d\u6742\u6027\uff0c\u5b83\u4eec\u90fd\u88ab\u7f16\u8bd1\u6210\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u5728\u5355\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u3002\u8fd9\u4e9b\u63a7\u5236\u5668\u4e3b\u8981\u5305\u62ec\u3002 \u8282\u70b9\u63a7\u5236\u5668\uff08Node Controller\uff09\uff1a\u8d1f\u8d23\u5728Node\u8282\u70b9\u51fa\u73b0\u6545\u969c\u65f6\u53ca\u65f6\u53d1\u73b0\u548c\u54cd\u5e94\uff1b \u590d\u5236\u63a7\u5236\u5668\uff08Replication Controller\uff09\uff1a\u8d1f\u8d23\u7ef4\u62a4\u6b63\u786e\u6570\u91cf\u7684Pod\uff1b \u7aef\u70b9\u63a7\u5236\u5668\uff08Endpoints Controller\uff09\uff1a\u586b\u5145\u7aef\u70b9\u5bf9\u8c61\uff08\u5373\u8fde\u63a5Services\u548cPods\uff09\uff1b \u670d\u52a1\u5e10\u6237\u548c\u4ee4\u724c\u63a7\u5236\u5668\uff08Service Account & Token Controllers\uff09\uff1a\u4e3a\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u9ed8\u8ba4\u5e10\u6237\u548cAPI\u8bbf\u95ee\u4ee4\u724c\u3002 \u4e2a\u4eba\u7406\u89e3: etcd: \u5b98\u65b9\u89e3\u91ca: \u662fKubernetes \u63d0\u4f9b\u7684\u9ed8\u8ba4\u5b58\u50a8\uff0c\u6240\u6709\u96c6\u7fa4\u6570\u636e\u90fd\u4fdd\u5b58\u5728Etcd\u4e2d\uff0c\u4f7f\u7528\u65f6\u5efa\u8bae\u4e3aEtcd \u6570\u636e\u63d0\u4f9b\u5907\u4efd\u8ba1\u5212\uff1b \u4e2a\u4eba\u7406\u89e3: \u4e00\u5806\u63a7\u5236\u5668\uff08\u526f\u672c\u63a7\u5236\u5668\uff0c\u8282\u70b9\u63a7\u5236\u5668\uff0c\u547d\u4ee4\u7a7a\u95f4\u63a7\u5236\u5668\uff0c\u670d\u52a1\u5668\u8d26\u53f7\u63a7\u5236\u5668\u7b49\uff09\uff0c\u63a7\u5236\u5668\u505a\u4e3a\u96c6\u7fa4\u5185\u90e8\u7ba1\u7406\u63a7\u5236\u4e2d\u5fc3\uff0c\u8d1f\u8d23\u96c6\u7fa4\u5185\u7684node\u3001pod\u3001\u670d\u52a1\u7aef\u70b9\u3001\u547d\u540d\u7a7a\u95f4\u3001\u670d\u52a1\u5668\u8d26\u53f7\uff0c\u8d44\u6e90\u5b9a\u989d\u7684\u7ba1\u7406\uff0c\u5f53\u67d0\u4e2anode\u610f\u5916\u5b95\u673a\uff0cController-manager\u4f1a\u81ea\u52a8\u53d1\u73b0\u5e76\u6267\u884c\u81ea\u52a8\u6062\u590d\u6d41\u7a0b\u3002\u786e\u4fdd\u96c6\u7fa4\u4e2dpod\u7684\u526f\u672c\u59cb\u7ec8\u4fdd\u6301\u9884\u671f\u5de5\u4f5c\u7684\u72b6\u6001\u3002 Node \u7ec4\u4ef6 \u00b6 kubelet\uff1a \u5b98\u65b9\u89e3\u91ca: \u8d1f\u8d23Pod\u5bf9\u5e94\u5bb9\u5668\u7684\u521b\u5efa\u3001\u8d77\u505c\u7b49\u4efb\u52a1\uff0c\u540c\u65f6\u4e0eMaster \u8282\u70b9\u5bc6\u5207\u534f\u4f5c\uff0c\u5b9e\u73b0\u96c6\u7fa4\u7ba1\u7406\u7684\u57fa\u672c\u529f\u80fd\u3002 \u4e2a\u4eba\u7406\u89e3: kubelet\u662f\u7ef4\u62a4node\u4e0apod\u7684\u72b6\u6001\uff0c\u5982\u679cpod\u6302\u4e86\uff0c\u4ed6\u4f1a\u5c06\u4e8b\u4ef6\u53d1\u9001\u7ed9api-server\uff0capi-server\u5c06\u4e8b\u4ef6\u5199\u5165etcd\uff0ckube-scheduler\u6216\u8005Controller-manager\u4f1a\u62ff\u5230api-server\u4e0a\u7684\u4e8b\u4ef6\uff0c\u5bf9pod\u8fdb\u884c\u91cd\u5efa\u7b49\u64cd\u4f5c\u3002 kube-proxy\uff1a \u5b98\u65b9\u89e3\u91ca: \u5b98\u7f51\u89e3\u91ca\uff1a\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u7f51\u7edc\u4ee3\u7406\uff0c \u5b9e\u73b0 Kubernetes \u670d\u52a1\uff08Service\uff09 \u6982\u5ff5\u7684\u4e00\u90e8\u5206 \u4e2a\u4eba\u7406\u89e3: \u4e2a\u4eba\u7406\u89e3\uff1a\u7ef4\u62a4\u5f53\u524d\u4e3b\u673a\u7684\u7f51\u7edc\u89c4\u5219 \u5176\u4ed6\u7ec4\u4ef6 \u00b6 helm install mysql presslabs/mysql-operator \\ -f 1-config.yaml \\ -n infra helm install mysql-operator bitpoke/mysql-operator \\ -f 1-config.yaml \\ -n infra","title":"kubernetes \u7b80\u4ecb"},{"location":"3.k8s/base/k8s-overview/#k8s","text":"\u5f00\u6e90\u5bb9\u5668\u5316\u7f16\u6392\u5f15\u64ce\uff0c\u4e13\u7528\u4e8e\u7ba1\u7406\u5bb9\u5668\u5316\u5e94\u7528\u548c\u670d\u52a1\u96c6\u7fa4\u3002","title":"k8s \u7b80\u4ecb"},{"location":"3.k8s/base/k8s-overview/#_1","text":"","title":"\u6838\u5fc3\u7ec4\u4ef6\u4ecb\u7ecd"},{"location":"3.k8s/base/k8s-overview/#_2","text":"kube-apiserver: \u5b98\u65b9\u89e3\u91ca: API \u670d\u52a1\u5668\u662f Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u7ec4\u4ef6\uff0c \u8be5\u7ec4\u4ef6\u8d1f\u8d23\u516c\u5f00\u4e86 Kubernetes API\uff0c\u8d1f\u8d23\u5904\u7406\u63a5\u53d7\u8bf7\u6c42\u7684\u5de5\u4f5c\u3002 API \u670d\u52a1\u5668\u662f Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u524d\u7aef\u3002 Kubernetes API \u670d\u52a1\u5668\u7684\u4e3b\u8981\u5b9e\u73b0\u662f kube-apiserver\u3002 kube-apiserver \u8bbe\u8ba1\u4e0a\u8003\u8651\u4e86\u6c34\u5e73\u6269\u7f29\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b83\u53ef\u901a\u8fc7\u90e8\u7f72\u591a\u4e2a\u5b9e\u4f8b\u6765\u8fdb\u884c\u6269\u7f29\u3002 \u4f60\u53ef\u4ee5\u8fd0\u884c kube-apiserver \u7684\u591a\u4e2a\u5b9e\u4f8b\uff0c\u5e76\u5728\u8fd9\u4e9b\u5b9e\u4f8b\u4e4b\u95f4\u5e73\u8861\u6d41\u91cf\u3002 \u4e2a\u4eba\u7406\u89e3: k8s\u7684\u8bbf\u95ee\u5165\u53e3\uff0c\u5982\u679c\u60f3\u64cd\u4f5c\u5bb9\u5668\uff0c\u5fc5\u987b\u8981\u901a\u8fc7api-server\u624d\u53ef\u4ee5\u3002k8s\u96c6\u7fa4\u6240\u6709\u7684node\u90fd\u8981\u4e0eapi-server\u8fdb\u884c\u901a\u4fe1\uff0c\u6240\u4ee5node\u7684\u6570\u91cf\u8d8a\u591a\u7ed9api-server\u7684\u538b\u529b\u5c31\u4f1a\u8d8a\u5927\u3002\u6240\u4ee5\u4e00\u822ck8s-master\u90fd\u662f\u96c6\u7fa4\u6765\u9ad8\u53ef\u7528\u7684\uff0c\u901a\u5e38\u6765\u8bf4\u90fd\u662f\u4e09\u4e2a\u8282\u70b9\u3002 kube-scheduler: \u5b98\u65b9\u89e3\u91ca: \u662f\u8d1f\u8d23\u8d44\u6e90\u8c03\u5ea6\u7684\u8fdb\u7a0b\uff0c\u76d1\u89c6\u65b0\u521b\u5efa\u4e14\u6ca1\u6709\u5206\u914d\u5230Node\u7684Pod\uff0c\u4e3aPod \u9009\u62e9\u4e00\u4e2aNode\uff1b \u8c03\u5ea6\u51b3\u7b56\u8003\u8651\u7684\u56e0\u7d20\u5305\u62ec\u5355\u4e2a Pod \u53ca Pods \u96c6\u5408\u7684\u8d44\u6e90\u9700\u6c42\u3001 \u8f6f\u786c\u4ef6\u53ca\u7b56\u7565\u7ea6\u675f\u3001 \u4eb2\u548c\u6027\u53ca\u53cd\u4eb2\u548c\u6027\u89c4\u8303\u3001\u6570\u636e\u4f4d\u7f6e\u3001\u5de5\u4f5c\u8d1f\u8f7d\u95f4\u7684\u5e72\u6270\u53ca\u6700\u540e\u65f6\u9650 . \u4e2a\u4eba\u7406\u89e3: \u7ba1\u7406\u5458\u53d1\u9001\u521b\u5efa\u4e00\u4e2a\u5bb9\u5668\u7684\u6307\u4ee4\u5230api-server\uff0capi-server\u6536\u5230\u8fd9\u4e2a\u6307\u4ee4\u5c31\u5b58\u50a8\u5728etcd\u4e2d\uff0ckube-scheduler\u4f1a\u76d1\u542capi-server\u770b\u770b\u6709\u6ca1\u6709pod\u7684\u64cd\u4f5c\u4e8b\u4ef6\uff0c\u5982\u679c\u6ca1\u6709\u4e0b\u6b21\u63a5\u7740\u67e5\u8be2\uff0c\u5982\u679c\u6709\u7684\u8bdd\uff0ckube-scheduler\u4f1a\u901a\u8fc7api-server\u62ff\u5230etcd\u8fd9\u4e2a\u4e8b\u4ef6\u3002\u7136\u540ekube-scheduler\u4f1a\u6839\u636enode\u7684\u8d44\u6e90\u5229\u7528\u7387\u6765\u8fdb\u884c\u8c03\u5ea6\u3002\u8c03\u5ea6\u4e4b\u540ekube-scheduler\u4f1a\u628a\u7ed3\u679c\u8fd4\u56de\u7ed9api-server\uff0capi-server\u518d\u628a\u7ed3\u679c\u5199\u5230etcd\u3002 kube-controller-manager: \u5b98\u65b9\u89e3\u91ca: \u8fd0\u884c\u7ba1\u7406\u63a7\u5236\u5668\uff0c\u662f\u96c6\u7fa4\u4e2d\u5904\u7406\u5e38\u89c4\u4efb\u52a1\u7684\u540e\u53f0\u8fdb\u7a0b\uff0c\u662fKubernetes \u91cc\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u7684\u81ea\u52a8\u5316\u63a7\u5236\u4e2d\u5fc3\u3002\u903b\u8f91\u4e0a\uff0c\u6bcf\u4e2a\u63a7\u5236\u5668\u662f\u4e00\u4e2a\u5355\u72ec\u7684\u8fdb\u7a0b\uff0c\u4f46\u4e3a\u4e86\u964d\u4f4e\u590d\u6742\u6027\uff0c\u5b83\u4eec\u90fd\u88ab\u7f16\u8bd1\u6210\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u5728\u5355\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u3002\u8fd9\u4e9b\u63a7\u5236\u5668\u4e3b\u8981\u5305\u62ec\u3002 \u8282\u70b9\u63a7\u5236\u5668\uff08Node Controller\uff09\uff1a\u8d1f\u8d23\u5728Node\u8282\u70b9\u51fa\u73b0\u6545\u969c\u65f6\u53ca\u65f6\u53d1\u73b0\u548c\u54cd\u5e94\uff1b \u590d\u5236\u63a7\u5236\u5668\uff08Replication Controller\uff09\uff1a\u8d1f\u8d23\u7ef4\u62a4\u6b63\u786e\u6570\u91cf\u7684Pod\uff1b \u7aef\u70b9\u63a7\u5236\u5668\uff08Endpoints Controller\uff09\uff1a\u586b\u5145\u7aef\u70b9\u5bf9\u8c61\uff08\u5373\u8fde\u63a5Services\u548cPods\uff09\uff1b \u670d\u52a1\u5e10\u6237\u548c\u4ee4\u724c\u63a7\u5236\u5668\uff08Service Account & Token Controllers\uff09\uff1a\u4e3a\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u9ed8\u8ba4\u5e10\u6237\u548cAPI\u8bbf\u95ee\u4ee4\u724c\u3002 \u4e2a\u4eba\u7406\u89e3: etcd: \u5b98\u65b9\u89e3\u91ca: \u662fKubernetes \u63d0\u4f9b\u7684\u9ed8\u8ba4\u5b58\u50a8\uff0c\u6240\u6709\u96c6\u7fa4\u6570\u636e\u90fd\u4fdd\u5b58\u5728Etcd\u4e2d\uff0c\u4f7f\u7528\u65f6\u5efa\u8bae\u4e3aEtcd \u6570\u636e\u63d0\u4f9b\u5907\u4efd\u8ba1\u5212\uff1b \u4e2a\u4eba\u7406\u89e3: \u4e00\u5806\u63a7\u5236\u5668\uff08\u526f\u672c\u63a7\u5236\u5668\uff0c\u8282\u70b9\u63a7\u5236\u5668\uff0c\u547d\u4ee4\u7a7a\u95f4\u63a7\u5236\u5668\uff0c\u670d\u52a1\u5668\u8d26\u53f7\u63a7\u5236\u5668\u7b49\uff09\uff0c\u63a7\u5236\u5668\u505a\u4e3a\u96c6\u7fa4\u5185\u90e8\u7ba1\u7406\u63a7\u5236\u4e2d\u5fc3\uff0c\u8d1f\u8d23\u96c6\u7fa4\u5185\u7684node\u3001pod\u3001\u670d\u52a1\u7aef\u70b9\u3001\u547d\u540d\u7a7a\u95f4\u3001\u670d\u52a1\u5668\u8d26\u53f7\uff0c\u8d44\u6e90\u5b9a\u989d\u7684\u7ba1\u7406\uff0c\u5f53\u67d0\u4e2anode\u610f\u5916\u5b95\u673a\uff0cController-manager\u4f1a\u81ea\u52a8\u53d1\u73b0\u5e76\u6267\u884c\u81ea\u52a8\u6062\u590d\u6d41\u7a0b\u3002\u786e\u4fdd\u96c6\u7fa4\u4e2dpod\u7684\u526f\u672c\u59cb\u7ec8\u4fdd\u6301\u9884\u671f\u5de5\u4f5c\u7684\u72b6\u6001\u3002","title":"\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6"},{"location":"3.k8s/base/k8s-overview/#node","text":"kubelet\uff1a \u5b98\u65b9\u89e3\u91ca: \u8d1f\u8d23Pod\u5bf9\u5e94\u5bb9\u5668\u7684\u521b\u5efa\u3001\u8d77\u505c\u7b49\u4efb\u52a1\uff0c\u540c\u65f6\u4e0eMaster \u8282\u70b9\u5bc6\u5207\u534f\u4f5c\uff0c\u5b9e\u73b0\u96c6\u7fa4\u7ba1\u7406\u7684\u57fa\u672c\u529f\u80fd\u3002 \u4e2a\u4eba\u7406\u89e3: kubelet\u662f\u7ef4\u62a4node\u4e0apod\u7684\u72b6\u6001\uff0c\u5982\u679cpod\u6302\u4e86\uff0c\u4ed6\u4f1a\u5c06\u4e8b\u4ef6\u53d1\u9001\u7ed9api-server\uff0capi-server\u5c06\u4e8b\u4ef6\u5199\u5165etcd\uff0ckube-scheduler\u6216\u8005Controller-manager\u4f1a\u62ff\u5230api-server\u4e0a\u7684\u4e8b\u4ef6\uff0c\u5bf9pod\u8fdb\u884c\u91cd\u5efa\u7b49\u64cd\u4f5c\u3002 kube-proxy\uff1a \u5b98\u65b9\u89e3\u91ca: \u5b98\u7f51\u89e3\u91ca\uff1a\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u7f51\u7edc\u4ee3\u7406\uff0c \u5b9e\u73b0 Kubernetes \u670d\u52a1\uff08Service\uff09 \u6982\u5ff5\u7684\u4e00\u90e8\u5206 \u4e2a\u4eba\u7406\u89e3: \u4e2a\u4eba\u7406\u89e3\uff1a\u7ef4\u62a4\u5f53\u524d\u4e3b\u673a\u7684\u7f51\u7edc\u89c4\u5219","title":"Node \u7ec4\u4ef6"},{"location":"3.k8s/base/k8s-overview/#_3","text":"helm install mysql presslabs/mysql-operator \\ -f 1-config.yaml \\ -n infra helm install mysql-operator bitpoke/mysql-operator \\ -f 1-config.yaml \\ -n infra","title":"\u5176\u4ed6\u7ec4\u4ef6"},{"location":"3.k8s/controller/StatefulSet/","text":"","title":"StatefulSet"},{"location":"3.k8s/controller/deployment/","text":"","title":"Deployment"},{"location":"3.k8s/controller/rs/","text":"","title":"Rs"},{"location":"3.k8s/mysql-operator/0-mysql-docs/","text":"\u6280\u80fd\u76ee\u6807 \u00b6 \u7406\u89e3\u6570\u636e\u5e93\u7684\u57fa\u672c\u6982\u5ff5 \u638c\u63e1 MySQL \u7684\u5b89\u88c5\u65b9\u6cd5 \u4f1a\u64cd\u4f5c MySQL \u6570\u636e\u5e93 21 \u4e16\u7eaa\uff0c\u4eba\u7c7b\u8fc8\u5165\u4e86\u201c\u4fe1\u606f\u7206\u70b8\u65f6\u4ee3\u201d\uff0c\u5927\u91cf\u7684\u6570\u636e\u3001\u4fe1\u606f\u5728\u4e0d\u65ad\u4ea7\u751f\uff0c\u4f34\u968f\u800c\u6765\u7684 \u5c31\u662f\u5982\u4f55\u5b89\u5168\u3001\u6709\u6548\u5730\u5b58\u50a8\u3001\u68c0\u7d22\u548c\u7ba1\u7406\u5b83\u4eec\u3002\u5bf9\u6570\u636e\u7684\u6709\u6548\u5b58\u50a8\u3001\u9ad8\u6548\u8bbf\u95ee\u3001\u65b9\u4fbf\u5171\u4eab\u548c \u5b89\u5168\u63a7\u5236\u5df2\u7ecf\u6210\u4e3a\u4fe1\u606f\u65f6\u4ee3\u4e9f\u5f85\u89e3\u51b3\u7684\u95ee\u9898\u3002 1.1 \u6570\u636e\u5e93\u7b80\u4ecb \u00b6 1.1.1 \u4f7f\u7528\u6570\u636e\u5e93\u7684\u5fc5\u8981\u6027 \u00b6 \u4f7f\u7528\u6570\u636e\u5e93\u53ef\u4ee5\u9ad8\u6548\u4e14\u6761\u7406\u5206\u660e\u5730\u5b58\u50a8\u6570\u636e\uff0c\u4f7f\u4eba\u4eec\u80fd\u591f\u66f4\u52a0\u8fc5\u901f\u3001\u65b9\u4fbf\u5730\u7ba1\u7406\u6570\u636e\u3002 \u6570\u636e\u5e93\u5177\u6709\u4ee5\u4e0b\u7279\u70b9\u3002 \u53ef\u4ee5\u7ed3\u6784\u5316\u5b58\u50a8\u5927\u91cf\u7684\u6570\u636e\u4fe1\u606f\uff0c\u65b9\u4fbf\u7528\u6237\u8fdb\u884c\u6709\u6548\u7684\u68c0\u7d22\u548c\u8bbf\u95ee\u3002 \u53ef\u4ee5\u6709\u6548\u5730\u4fdd\u6301\u6570\u636e\u4fe1\u606f\u7684\u4e00\u81f4\u6027\u3001\u5b8c\u6574\u6027\uff0c\u964d\u4f4e\u6570\u636e\u5197\u4f59\u3002 \u53ef\u4ee5\u6ee1\u8db3\u5e94\u7528\u7684\u5171\u4eab\u548c\u5b89\u5168\u65b9\u9762\u7684\u8981\u6c42\u3002 \u6570\u636e\u5e93\u6280\u672f\u662f\u8ba1\u7b97\u673a\u79d1\u5b66\u7684\u6838\u5fc3\u6280\u672f\u4e4b\u4e00\uff0c\u5177\u6709\u5b8c\u5907\u7684\u7406\u8bba\u57fa\u7840\u3002\u5bf9\u6570\u636e\u5e93\u57fa\u672c\u6982\u5ff5\u7684 \u638c\u63e1\uff0c\u5c06\u6709\u52a9\u4e8e\u5bf9\u6570\u636e\u5e93\u7684\u7406\u89e3\u3002 1.1.2 \u6570\u636e\u5e93\u7684\u57fa\u672c\u6982\u5ff5 \u00b6 1\uff0e\u6570\u636e \u00b6 \u63cf\u8ff0\u4e8b\u7269\u7684\u7b26\u53f7\u8bb0\u5f55\u79f0\u4e3a\u6570\u636e\uff08Data\uff09\u3002\u6570\u5b57\u3001\u6587\u5b57\u3001\u56fe\u5f62\u3001\u56fe\u50cf\u3001\u58f0\u97f3\u3001\u6863\u6848\u8bb0\u5f55\u7b49 \u90fd\u662f\u6570\u636e\u3002 \u5728\u6570\u636e\u5e93\u4e2d\uff0c\u6570\u636e\u662f\u4ee5\u201c\u8bb0\u5f55\u201d\u7684\u5f62\u5f0f\u6309\u7167\u7edf\u4e00\u7684\u683c\u5f0f\u8fdb\u884c\u5b58\u50a8\u7684\uff0c\u800c\u4e0d\u662f\u6742\u4e71\u65e0\u7ae0\u7684\u3002 \u76f8\u540c\u683c\u5f0f\u548c\u7c7b\u578b\u7684\u6570\u636e\u7edf\u4e00\u5b58\u653e\u5728\u4e00\u8d77\uff0c\u800c\u4e0d\u4f1a\u628a\u201c\u4eba\u201d\u548c\u201c\u4e66\u201d\u6df7\u5728\u4e00\u8d77\u5b58\u50a8\u3002\u8fd9\u6837\uff0c\u6570 \u636e\u7684\u5b58\u50a8\u5c31\u80fd\u591f\u4e95\u7136\u6709\u5e8f\u3002 \u5982\u56fe 1.1 \u4e2d\u5b58\u50a8\u7684\u4e00\u884c\u6570\u636e\uff0c\u5728\u6570\u636e\u5e93\u4e2d\u79f0\u4e3a\u4e00\u6761\u201c\u8bb0\u5f55\u201d\uff08Record\uff09\u3002\u6bcf\u6761\u8bb0\u5f55\u4e2d \u7684\u6bcf\u4e00\u4e2a\u8f93\u5165\u9879\u79f0\u4e3a\u201c\u5217\u201d\u3002\u56fe 1.1 \u4e2d\u7f16\u53f7\u3001\u59d3\u540d\u3001\u6027\u522b\u3001\u5e74\u9f84\u3001\u6c11\u65cf\u3001\u4e13\u4e1a\u90fd\u662f\u5217\u540d\u3002 2\uff0e\u6570\u636e\u5e93\u548c\u6570\u636e\u5e93\u8868 \u00b6 \u4e0d\u540c\u7684\u8bb0\u5f55\u7ec4\u7ec7\u5728\u4e00\u8d77\uff0c\u5c31\u5f62\u6210\u4e86\u6570\u636e\u5e93\uff08Database\uff0cDB\uff09\u7684\u201c\u8868\u201d\uff08Table\uff09\u3002\u4e5f\u53ef \u4ee5\u8bf4\uff0c\u8868\u662f\u7528\u6765\u5b58\u50a8\u5177\u4f53\u6570\u636e\u7684\uff0c\u5982\u56fe 1.1 \u6240\u793a\u3002\u90a3\u4e48\u6570\u636e\u5e93\u548c\u8868\u5b58\u5728\u4ec0\u4e48\u5173\u7cfb\u5462\uff1f\u7b80\u5355\u5730 \u8bf4\uff0c\u6570\u636e\u5e93\u5c31\u662f\u8868\u7684\u96c6\u5408\u3002\u5b83\u662f\u4ee5\u4e00\u5b9a\u7684\u7ec4\u7ec7\u65b9\u5f0f\u5b58\u50a8\u7684\u76f8\u4e92\u6709\u5173\u7684\u6570\u636e\u96c6\u5408\u3002\u4f8b\u5982\uff0c\u5173\u7cfb \u6570\u636e\u5e93\u7684\u8868\u7531\u8bb0\u5f55\u7ec4\u6210\uff0c\u8bb0\u5f55\u7531\u5b57\u6bb5\u7ec4\u6210\uff0c\u5b57\u6bb5\u7531\u5b57\u7b26\u6216\u6570\u5b57\u7ec4\u6210\u3002\u5b83\u53ef\u4ee5\u4f9b\u5404\u79cd\u7528\u6237\u5171\u4eab\uff0c \u5177\u6709\u6700\u5c0f\u5197\u4f59\u5ea6\u548c\u8f83\u9ad8\u7684\u6570\u636e\u72ec\u7acb\u6027\uff0c\u5b83\u662f\u7edf\u4e00\u7ba1\u7406\u7684\u76f8\u5173\u6570\u636e\u7684\u96c6\u5408\u3002 \u901a\u5e38\uff0c\u6570\u636e\u5e93\u5e76\u4e0d\u662f\u7b80\u5355\u5730\u5b58\u50a8\u8fd9\u4e9b\u6570\u636e\u7684\uff0c\u8fd8\u8981\u8868\u793a\u5b83\u4eec\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u4f8b\u5982\uff0c\u4e66\u548c\u4eba \u662f\u5b58\u5728\u8054\u7cfb\u7684\uff0c\u4e66\u7684\u4f5c\u8005\u53ef\u80fd\u5c31\u662f\u67d0\u4e2a\u4eba\uff0c\u56e0\u6b64\u9700\u8981\u5efa\u7acb\u4e66\u4e0e\u4eba\u7684\u201c\u5173\u7cfb\u201d\u3002\u8fd9\u79cd\u5173\u7cfb\u4e5f\u9700 \u8981\u7528\u6570\u636e\u5e93\u6765\u8868\u793a\uff0c\u56e0\u6b64\u5173\u7cfb\u7684\u63cf\u8ff0\u4e5f\u662f\u6570\u636e\u5e93\u7684\u4e00\u90e8\u5206\u3002 3\uff0e\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u548c\u6570\u636e\u5e93\u7cfb\u7edf \u00b6 \u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff08Database Management System\uff0cDBMS\uff09\u662f\u5b9e\u73b0\u5bf9\u6570\u636e\u5e93\u8d44\u6e90\u6709\u6548\u7ec4\u7ec7\u3001 \u7ba1\u7406\u548c\u5b58\u53d6\u7684\u7cfb\u7edf\u8f6f\u4ef6\u3002\u5b83\u5728\u64cd\u4f5c\u7cfb\u7edf\u7684\u652f\u6301\u4e0b\uff0c\u652f\u6301\u7528\u6237\u5bf9\u6570\u636e\u5e93\u7684\u5404\u9879\u64cd\u4f5c\u3002DBMS \u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u529f\u80fd\u3002 \u6570\u636e\u5e93\u7684\u5efa\u7acb\u548c\u7ef4\u62a4\u529f\u80fd\uff1a\u5305\u62ec\u5efa\u7acb\u6570\u636e\u5e93\u7684\u7ed3\u6784\u548c\u6570\u636e\u7684\u5f55\u5165\u4e0e\u8f6c\u6362\u3001\u6570\u636e\u5e93\u7684 \u8f6c\u50a8\u4e0e\u6062\u590d\u3001\u6570\u636e\u5e93\u7684\u91cd\u7ec4\u4e0e\u6027\u80fd\u76d1\u89c6\u7b49\u529f\u80fd\u3002 \u6570\u636e\u5b9a\u4e49\u529f\u80fd\uff1a\u5305\u62ec\u5b9a\u4e49\u5168\u5c40\u6570\u636e\u7ed3\u6784\u3001\u5c40\u90e8\u903b\u8f91\u6570\u636e\u7ed3\u6784\u3001\u5b58\u50a8\u7ed3\u6784\u3001\u4fdd\u5bc6\u6a21\u5f0f \u53ca\u4fe1\u606f\u683c\u5f0f\u7b49\u529f\u80fd\u3002\u4fdd\u8bc1\u5b58\u50a8\u5728\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u6b63\u786e\u3001\u6709\u6548\u548c\u76f8\u5bb9\uff0c\u4ee5\u9632\u6b62\u4e0d\u5408\u8bed \u4e49\u7684\u9519\u8bef\u6570\u636e\u88ab\u8f93\u5165\u6216\u8f93\u51fa\u3002 \u6570\u636e\u64cd\u7eb5\u529f\u80fd\uff1a\u5305\u62ec\u6570\u636e\u67e5\u8be2\u7edf\u8ba1\u548c\u6570\u636e\u66f4\u65b0\u4e24\u4e2a\u65b9\u9762\u3002 \u6570\u636e\u5e93\u7684\u8fd0\u884c\u7ba1\u7406\u529f\u80fd\uff1a\u8fd9\u662f\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u5305\u62ec\u5e76\u53d1\u63a7\u5236\u3001\u5b58\u53d6\u63a7 \u5236\u3001\u6570\u636e\u5e93\u5185\u90e8\u7ef4\u62a4\u7b49\u529f\u80fd\u3002 \u901a\u4fe1\u529f\u80fd\uff1aDBMS \u4e0e\u5176\u4ed6\u8f6f\u4ef6\u7cfb\u7edf\u4e4b\u95f4\u7684\u901a\u4fe1,\u5982 Access \u80fd\u4e0e\u5176\u4ed6 Office \u7ec4\u4ef6\u8fdb\u884c \u6570\u636e\u4ea4\u6362\u3002 \u6570\u636e\u5e93\u7cfb\u7edf\uff08Database System\uff0cDBS\uff09\u662f\u4e00\u4e2a\u4eba-\u673a\u7cfb\u7edf\uff0c\u4e00\u822c\u7531\u786c\u4ef6\u3001\u64cd\u4f5c\u7cfb\u7edf\u3001\u6570 \u636e\u5e93\u3001DBMS\u3001\u5e94\u7528\u8f6f\u4ef6\u548c\u6570\u636e\u5e93\u7528\u6237\uff08\u5305\u62ec\u6570\u636e\u5e93\u7ba1\u7406\u5458\uff09\u7ec4\u6210\u3002\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 DBMS \u64cd\u4f5c \u6570\u636e\u5e93\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5e94\u7528\u7a0b\u5e8f\u64cd\u4f5c\u6570\u636e\u5e93\u3002 \u5e94\u7528\u7a0b\u5e8f\u662f\u5229\u7528 DBMS \u4e3a\u89e3\u51b3\u67d0\u4e2a\u5177\u4f53\u7684\u7ba1\u7406\u6216\u6570\u636e\u5904\u7406\u7684\u4efb\u52a1\u800c\u7f16\u5236\u7684\u4e00\u7cfb\u5217\u547d\u4ee4\u7684 \u6709\u5e8f\u96c6\u5408\u3002\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u6bd4\u8f83\u5b8c\u5584\uff0c\u80fd\u591f\u63d0\u4f9b\u53cb\u597d\u7684\u4eba\u673a\u754c\u9762\uff0c\u5e76\u7f16\u8bd1\u6210\u53ef\u6267\u884c\u6587\u4ef6\u53d1\u884c\uff0c \u4f7f\u5f97\u666e\u901a\u7528\u6237\u4e0d\u9700\u8981\u5177\u5907\u8ba1\u7b97\u673a\u7684\u4e13\u4e1a\u77e5\u8bc6\uff0c\u5728\u8f83\u77ed\u65f6\u95f4\u5c31\u5b66\u4f1a\u4f7f\u7528\uff0c\u90a3\u4e48\u5c31\u79f0\u4e3a\u6570\u636e\u5e93\u5e94 \u7528\u8f6f\u4ef6\u3002 \u6570\u636e\u5e93\u4ea7\u54c1 \u00b6 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf RDBMS\uff1a - \u5546\u4e1a\uff1aOracle\uff08Oracle->Oracle Enterprise Linux\uff09\uff0cDB2\uff08IBM->AIX\uff09\u3001SQL Server\uff08\u5fae\u8f6f\uff09\u3001Sybase\uff0cInfomix - \u5f00\u6e90\uff1aMySQL\uff08MariaDB\uff09\uff0cPostgreSQL\uff08Apple\uff09\uff0cEnterpriseDB \u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93 NoSQL\uff08Not Only SQL\uff09\uff1a - MongoDB\uff0cRedis\uff0cMemcached\u3001HBase\u3001InfluxDB MySQL\u7248\u672c: - Community Edtion \u793e\u533a\u7248\uff08CE\uff09\uff0c\u514d\u8d39\uff0c\u7531\u793e\u533a\u4eba\u5458\u7ef4\u62a4\uff0c\u6d4b\u8bd5\u53ca\u66f4\u65b0 - Enterprise Edtion \u4f01\u4e1a\u7248\uff08EE\uff09\uff0c\u6536\u8d39\uff0cMySQL\u5b98\u65b9\u7ef4\u62a4\u56e2\u961f\u4eba\u5458\u7ef4\u62a4\uff0c\u6d4b\u8bd5\u53ca\u66f4\u65b0 MySQL\u4ea7\u54c1\u7b80\u4ecb \u00b6 MySQL\u662f\u4e00\u4e2a\u771f\u6b63\u7684\u591a\u7ebf\u7a0b\uff0c\u591a\u7528\u6237\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08RDBMS\uff09\u670d\u52a1\u7ba1\u7406\u8f6f\u4ef6\uff0c\u51ed\u501f\u5176\u67e5\u8be2\u901f\u5ea6\u5feb\uff0c\u9ad8\u6027\u80fd\uff0c\u9ad8\u53ef\u9760\u548c\u6613\u4e8e\u4f7f\u7528\u7b49\u7279\u6027\uff0c\u6210\u4e3a\u670d\u52a1\u5668\u9886\u57df\u4e2d\u6700\u53d7\u6b22\u8fce\u7684\u5f00\u6e90\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\u3002\u57282008\u4e4b\u524d\uff0cMySQL\u9879\u76ee\u7531MySQL AB\u7684\u521b\u59cb\u4eba\u9ea6\u514b\u5c14\u00b7\u7ef4\u5fb7\u7ebd\u65af\u4e3b\u5bfc\u5f00\u53d1\uff0c\u53d1\u5e03\u4e0e\u652f\u6301\uff0cSUN\u57282008\u5e74\u4ee510\u4ebf\u7f8e\u5143\u6536\u8d2d\u4e86MySQL AB\u3002\u7b2c\u4e8c\u5e744\u6708\u4efdOracle\u7532\u9aa8\u6587\u5ba3\u5e03\u5c06\u4ee574\u4ebf\u7f8e\u5143\u5e76\u8d2dSUN\u516c\u53f8\u3002\u76ee\u524dMySQL\u9879\u76ee\u7531Oracle\u516c\u53f8\u8d1f\u8d23\u8fd0\u8425\u548c\u7ef4\u62a4\u3002 MySQL\u4e0eMariaDB\u5173\u8054 \u00b6 MariaDB\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u662fMySQL\u7684\u4e00\u4e2a\u5206\u652f\uff0c\u4e3b\u8981\u7531\u5f00\u6e90\u793e\u533a\u5728\u7ef4\u62a4\uff0c\u91c7\u7528GPL\u6388\u6743\u8bb8\u53ef\u3002\u5f00\u53d1\u8fd9\u4e2a\u5206\u652f\u7684\u539f\u56e0\u4e4b\u4e00\uff1a\u7532\u9aa8\u6587\u516c\u53f8\u6536\u8d2d\u4e86MySQL\u540e\uff0c\u6709\u5c06MySQL\u95ed\u6e90\u7684\u6f5c\u5728\u98ce\u9669\uff0c\u56e0\u6b64\u793e\u533a\u91c7\u7528\u5206\u652f\u7684\u65b9\u5f0f\u6765\u907f\u5f00\u8fd9\u4e2a\u98ce\u9669\u3002MariaDB\u7684\u76ee\u7684\u662f\u5b8c\u5168\u517c\u5bb9MySQL\uff0c\u5305\u62ecAPI\u548c\u547d\u4ee4\u884c\uff0c\u4f7f\u4e4b\u80fd\u8f7b\u677e\u6210\u4e3aMySQL\u7684\u4ee3\u66ff\u54c1\u3002 MariaDB\u540d\u79f0\u6765\u81ea\u9ea6\u514b\u5c14\u00b7\u7ef4\u5fb7\u7ebd\u65af\u7684\u5973\u513f\u739b\u4e3d\u4e9a\uff08\u82f1\u8bed\uff1aMaria\uff09\u7684\u540d\u5b57\u3002 MariaDB\u76f4\u52305.5\u7248\u672c\uff0c\u5747\u4f9d\u7167MySQL\u7684\u7248\u672c\u53d1\u5c55\u3002\u56e0\u6b64\uff0c\u4f7f\u7528MariaDB5.5\u7684\u4eba\u4f1a\u4eceMySQL5.5\u4e2d\u4e86\u89e3\u5230MariaDB\u7684\u6240\u6709\u529f\u80fd\u3002\u4ece2012\u5e7411\u670812\u65e5\u8d77\u53d1\u5e03\u768410.0.0\u7248\u5f00\u59cb\uff0c\u4e0d\u518d\u4f9d\u7167MySQL\u7684\u7248\u53f7\u300210.0.x\u7248\u4ee55.5\u7248\u4e3a\u57fa\u7840\uff0c\u52a0\u4e0a\u79fb\u690d\u81eaMySQL 5.6\u7248\u7684\u529f\u80fd\u548c\u81ea\u884c\u5f00\u53d1\u7684\u65b0\u529f\u80fd\u3002CentOS7\u7cfb\u5217Linux\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u91c7\u7528MariaDB\u66ff\u4ee3\u4e86MySQL\u6570\u636e\u5e93\u4ea7\u54c1\u3002","title":"0 mysql docs"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#_1","text":"\u7406\u89e3\u6570\u636e\u5e93\u7684\u57fa\u672c\u6982\u5ff5 \u638c\u63e1 MySQL \u7684\u5b89\u88c5\u65b9\u6cd5 \u4f1a\u64cd\u4f5c MySQL \u6570\u636e\u5e93 21 \u4e16\u7eaa\uff0c\u4eba\u7c7b\u8fc8\u5165\u4e86\u201c\u4fe1\u606f\u7206\u70b8\u65f6\u4ee3\u201d\uff0c\u5927\u91cf\u7684\u6570\u636e\u3001\u4fe1\u606f\u5728\u4e0d\u65ad\u4ea7\u751f\uff0c\u4f34\u968f\u800c\u6765\u7684 \u5c31\u662f\u5982\u4f55\u5b89\u5168\u3001\u6709\u6548\u5730\u5b58\u50a8\u3001\u68c0\u7d22\u548c\u7ba1\u7406\u5b83\u4eec\u3002\u5bf9\u6570\u636e\u7684\u6709\u6548\u5b58\u50a8\u3001\u9ad8\u6548\u8bbf\u95ee\u3001\u65b9\u4fbf\u5171\u4eab\u548c \u5b89\u5168\u63a7\u5236\u5df2\u7ecf\u6210\u4e3a\u4fe1\u606f\u65f6\u4ee3\u4e9f\u5f85\u89e3\u51b3\u7684\u95ee\u9898\u3002","title":"\u6280\u80fd\u76ee\u6807"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#11","text":"","title":"1.1 \u6570\u636e\u5e93\u7b80\u4ecb"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#111","text":"\u4f7f\u7528\u6570\u636e\u5e93\u53ef\u4ee5\u9ad8\u6548\u4e14\u6761\u7406\u5206\u660e\u5730\u5b58\u50a8\u6570\u636e\uff0c\u4f7f\u4eba\u4eec\u80fd\u591f\u66f4\u52a0\u8fc5\u901f\u3001\u65b9\u4fbf\u5730\u7ba1\u7406\u6570\u636e\u3002 \u6570\u636e\u5e93\u5177\u6709\u4ee5\u4e0b\u7279\u70b9\u3002 \u53ef\u4ee5\u7ed3\u6784\u5316\u5b58\u50a8\u5927\u91cf\u7684\u6570\u636e\u4fe1\u606f\uff0c\u65b9\u4fbf\u7528\u6237\u8fdb\u884c\u6709\u6548\u7684\u68c0\u7d22\u548c\u8bbf\u95ee\u3002 \u53ef\u4ee5\u6709\u6548\u5730\u4fdd\u6301\u6570\u636e\u4fe1\u606f\u7684\u4e00\u81f4\u6027\u3001\u5b8c\u6574\u6027\uff0c\u964d\u4f4e\u6570\u636e\u5197\u4f59\u3002 \u53ef\u4ee5\u6ee1\u8db3\u5e94\u7528\u7684\u5171\u4eab\u548c\u5b89\u5168\u65b9\u9762\u7684\u8981\u6c42\u3002 \u6570\u636e\u5e93\u6280\u672f\u662f\u8ba1\u7b97\u673a\u79d1\u5b66\u7684\u6838\u5fc3\u6280\u672f\u4e4b\u4e00\uff0c\u5177\u6709\u5b8c\u5907\u7684\u7406\u8bba\u57fa\u7840\u3002\u5bf9\u6570\u636e\u5e93\u57fa\u672c\u6982\u5ff5\u7684 \u638c\u63e1\uff0c\u5c06\u6709\u52a9\u4e8e\u5bf9\u6570\u636e\u5e93\u7684\u7406\u89e3\u3002","title":"1.1.1 \u4f7f\u7528\u6570\u636e\u5e93\u7684\u5fc5\u8981\u6027"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#112","text":"","title":"1.1.2 \u6570\u636e\u5e93\u7684\u57fa\u672c\u6982\u5ff5"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#1","text":"\u63cf\u8ff0\u4e8b\u7269\u7684\u7b26\u53f7\u8bb0\u5f55\u79f0\u4e3a\u6570\u636e\uff08Data\uff09\u3002\u6570\u5b57\u3001\u6587\u5b57\u3001\u56fe\u5f62\u3001\u56fe\u50cf\u3001\u58f0\u97f3\u3001\u6863\u6848\u8bb0\u5f55\u7b49 \u90fd\u662f\u6570\u636e\u3002 \u5728\u6570\u636e\u5e93\u4e2d\uff0c\u6570\u636e\u662f\u4ee5\u201c\u8bb0\u5f55\u201d\u7684\u5f62\u5f0f\u6309\u7167\u7edf\u4e00\u7684\u683c\u5f0f\u8fdb\u884c\u5b58\u50a8\u7684\uff0c\u800c\u4e0d\u662f\u6742\u4e71\u65e0\u7ae0\u7684\u3002 \u76f8\u540c\u683c\u5f0f\u548c\u7c7b\u578b\u7684\u6570\u636e\u7edf\u4e00\u5b58\u653e\u5728\u4e00\u8d77\uff0c\u800c\u4e0d\u4f1a\u628a\u201c\u4eba\u201d\u548c\u201c\u4e66\u201d\u6df7\u5728\u4e00\u8d77\u5b58\u50a8\u3002\u8fd9\u6837\uff0c\u6570 \u636e\u7684\u5b58\u50a8\u5c31\u80fd\u591f\u4e95\u7136\u6709\u5e8f\u3002 \u5982\u56fe 1.1 \u4e2d\u5b58\u50a8\u7684\u4e00\u884c\u6570\u636e\uff0c\u5728\u6570\u636e\u5e93\u4e2d\u79f0\u4e3a\u4e00\u6761\u201c\u8bb0\u5f55\u201d\uff08Record\uff09\u3002\u6bcf\u6761\u8bb0\u5f55\u4e2d \u7684\u6bcf\u4e00\u4e2a\u8f93\u5165\u9879\u79f0\u4e3a\u201c\u5217\u201d\u3002\u56fe 1.1 \u4e2d\u7f16\u53f7\u3001\u59d3\u540d\u3001\u6027\u522b\u3001\u5e74\u9f84\u3001\u6c11\u65cf\u3001\u4e13\u4e1a\u90fd\u662f\u5217\u540d\u3002","title":"1\uff0e\u6570\u636e"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#2","text":"\u4e0d\u540c\u7684\u8bb0\u5f55\u7ec4\u7ec7\u5728\u4e00\u8d77\uff0c\u5c31\u5f62\u6210\u4e86\u6570\u636e\u5e93\uff08Database\uff0cDB\uff09\u7684\u201c\u8868\u201d\uff08Table\uff09\u3002\u4e5f\u53ef \u4ee5\u8bf4\uff0c\u8868\u662f\u7528\u6765\u5b58\u50a8\u5177\u4f53\u6570\u636e\u7684\uff0c\u5982\u56fe 1.1 \u6240\u793a\u3002\u90a3\u4e48\u6570\u636e\u5e93\u548c\u8868\u5b58\u5728\u4ec0\u4e48\u5173\u7cfb\u5462\uff1f\u7b80\u5355\u5730 \u8bf4\uff0c\u6570\u636e\u5e93\u5c31\u662f\u8868\u7684\u96c6\u5408\u3002\u5b83\u662f\u4ee5\u4e00\u5b9a\u7684\u7ec4\u7ec7\u65b9\u5f0f\u5b58\u50a8\u7684\u76f8\u4e92\u6709\u5173\u7684\u6570\u636e\u96c6\u5408\u3002\u4f8b\u5982\uff0c\u5173\u7cfb \u6570\u636e\u5e93\u7684\u8868\u7531\u8bb0\u5f55\u7ec4\u6210\uff0c\u8bb0\u5f55\u7531\u5b57\u6bb5\u7ec4\u6210\uff0c\u5b57\u6bb5\u7531\u5b57\u7b26\u6216\u6570\u5b57\u7ec4\u6210\u3002\u5b83\u53ef\u4ee5\u4f9b\u5404\u79cd\u7528\u6237\u5171\u4eab\uff0c \u5177\u6709\u6700\u5c0f\u5197\u4f59\u5ea6\u548c\u8f83\u9ad8\u7684\u6570\u636e\u72ec\u7acb\u6027\uff0c\u5b83\u662f\u7edf\u4e00\u7ba1\u7406\u7684\u76f8\u5173\u6570\u636e\u7684\u96c6\u5408\u3002 \u901a\u5e38\uff0c\u6570\u636e\u5e93\u5e76\u4e0d\u662f\u7b80\u5355\u5730\u5b58\u50a8\u8fd9\u4e9b\u6570\u636e\u7684\uff0c\u8fd8\u8981\u8868\u793a\u5b83\u4eec\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u4f8b\u5982\uff0c\u4e66\u548c\u4eba \u662f\u5b58\u5728\u8054\u7cfb\u7684\uff0c\u4e66\u7684\u4f5c\u8005\u53ef\u80fd\u5c31\u662f\u67d0\u4e2a\u4eba\uff0c\u56e0\u6b64\u9700\u8981\u5efa\u7acb\u4e66\u4e0e\u4eba\u7684\u201c\u5173\u7cfb\u201d\u3002\u8fd9\u79cd\u5173\u7cfb\u4e5f\u9700 \u8981\u7528\u6570\u636e\u5e93\u6765\u8868\u793a\uff0c\u56e0\u6b64\u5173\u7cfb\u7684\u63cf\u8ff0\u4e5f\u662f\u6570\u636e\u5e93\u7684\u4e00\u90e8\u5206\u3002","title":"2\uff0e\u6570\u636e\u5e93\u548c\u6570\u636e\u5e93\u8868"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#3","text":"\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff08Database Management System\uff0cDBMS\uff09\u662f\u5b9e\u73b0\u5bf9\u6570\u636e\u5e93\u8d44\u6e90\u6709\u6548\u7ec4\u7ec7\u3001 \u7ba1\u7406\u548c\u5b58\u53d6\u7684\u7cfb\u7edf\u8f6f\u4ef6\u3002\u5b83\u5728\u64cd\u4f5c\u7cfb\u7edf\u7684\u652f\u6301\u4e0b\uff0c\u652f\u6301\u7528\u6237\u5bf9\u6570\u636e\u5e93\u7684\u5404\u9879\u64cd\u4f5c\u3002DBMS \u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u529f\u80fd\u3002 \u6570\u636e\u5e93\u7684\u5efa\u7acb\u548c\u7ef4\u62a4\u529f\u80fd\uff1a\u5305\u62ec\u5efa\u7acb\u6570\u636e\u5e93\u7684\u7ed3\u6784\u548c\u6570\u636e\u7684\u5f55\u5165\u4e0e\u8f6c\u6362\u3001\u6570\u636e\u5e93\u7684 \u8f6c\u50a8\u4e0e\u6062\u590d\u3001\u6570\u636e\u5e93\u7684\u91cd\u7ec4\u4e0e\u6027\u80fd\u76d1\u89c6\u7b49\u529f\u80fd\u3002 \u6570\u636e\u5b9a\u4e49\u529f\u80fd\uff1a\u5305\u62ec\u5b9a\u4e49\u5168\u5c40\u6570\u636e\u7ed3\u6784\u3001\u5c40\u90e8\u903b\u8f91\u6570\u636e\u7ed3\u6784\u3001\u5b58\u50a8\u7ed3\u6784\u3001\u4fdd\u5bc6\u6a21\u5f0f \u53ca\u4fe1\u606f\u683c\u5f0f\u7b49\u529f\u80fd\u3002\u4fdd\u8bc1\u5b58\u50a8\u5728\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u6b63\u786e\u3001\u6709\u6548\u548c\u76f8\u5bb9\uff0c\u4ee5\u9632\u6b62\u4e0d\u5408\u8bed \u4e49\u7684\u9519\u8bef\u6570\u636e\u88ab\u8f93\u5165\u6216\u8f93\u51fa\u3002 \u6570\u636e\u64cd\u7eb5\u529f\u80fd\uff1a\u5305\u62ec\u6570\u636e\u67e5\u8be2\u7edf\u8ba1\u548c\u6570\u636e\u66f4\u65b0\u4e24\u4e2a\u65b9\u9762\u3002 \u6570\u636e\u5e93\u7684\u8fd0\u884c\u7ba1\u7406\u529f\u80fd\uff1a\u8fd9\u662f\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u5305\u62ec\u5e76\u53d1\u63a7\u5236\u3001\u5b58\u53d6\u63a7 \u5236\u3001\u6570\u636e\u5e93\u5185\u90e8\u7ef4\u62a4\u7b49\u529f\u80fd\u3002 \u901a\u4fe1\u529f\u80fd\uff1aDBMS \u4e0e\u5176\u4ed6\u8f6f\u4ef6\u7cfb\u7edf\u4e4b\u95f4\u7684\u901a\u4fe1,\u5982 Access \u80fd\u4e0e\u5176\u4ed6 Office \u7ec4\u4ef6\u8fdb\u884c \u6570\u636e\u4ea4\u6362\u3002 \u6570\u636e\u5e93\u7cfb\u7edf\uff08Database System\uff0cDBS\uff09\u662f\u4e00\u4e2a\u4eba-\u673a\u7cfb\u7edf\uff0c\u4e00\u822c\u7531\u786c\u4ef6\u3001\u64cd\u4f5c\u7cfb\u7edf\u3001\u6570 \u636e\u5e93\u3001DBMS\u3001\u5e94\u7528\u8f6f\u4ef6\u548c\u6570\u636e\u5e93\u7528\u6237\uff08\u5305\u62ec\u6570\u636e\u5e93\u7ba1\u7406\u5458\uff09\u7ec4\u6210\u3002\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 DBMS \u64cd\u4f5c \u6570\u636e\u5e93\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5e94\u7528\u7a0b\u5e8f\u64cd\u4f5c\u6570\u636e\u5e93\u3002 \u5e94\u7528\u7a0b\u5e8f\u662f\u5229\u7528 DBMS \u4e3a\u89e3\u51b3\u67d0\u4e2a\u5177\u4f53\u7684\u7ba1\u7406\u6216\u6570\u636e\u5904\u7406\u7684\u4efb\u52a1\u800c\u7f16\u5236\u7684\u4e00\u7cfb\u5217\u547d\u4ee4\u7684 \u6709\u5e8f\u96c6\u5408\u3002\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u6bd4\u8f83\u5b8c\u5584\uff0c\u80fd\u591f\u63d0\u4f9b\u53cb\u597d\u7684\u4eba\u673a\u754c\u9762\uff0c\u5e76\u7f16\u8bd1\u6210\u53ef\u6267\u884c\u6587\u4ef6\u53d1\u884c\uff0c \u4f7f\u5f97\u666e\u901a\u7528\u6237\u4e0d\u9700\u8981\u5177\u5907\u8ba1\u7b97\u673a\u7684\u4e13\u4e1a\u77e5\u8bc6\uff0c\u5728\u8f83\u77ed\u65f6\u95f4\u5c31\u5b66\u4f1a\u4f7f\u7528\uff0c\u90a3\u4e48\u5c31\u79f0\u4e3a\u6570\u636e\u5e93\u5e94 \u7528\u8f6f\u4ef6\u3002","title":"3\uff0e\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u548c\u6570\u636e\u5e93\u7cfb\u7edf"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#_2","text":"\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf RDBMS\uff1a - \u5546\u4e1a\uff1aOracle\uff08Oracle->Oracle Enterprise Linux\uff09\uff0cDB2\uff08IBM->AIX\uff09\u3001SQL Server\uff08\u5fae\u8f6f\uff09\u3001Sybase\uff0cInfomix - \u5f00\u6e90\uff1aMySQL\uff08MariaDB\uff09\uff0cPostgreSQL\uff08Apple\uff09\uff0cEnterpriseDB \u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93 NoSQL\uff08Not Only SQL\uff09\uff1a - MongoDB\uff0cRedis\uff0cMemcached\u3001HBase\u3001InfluxDB MySQL\u7248\u672c: - Community Edtion \u793e\u533a\u7248\uff08CE\uff09\uff0c\u514d\u8d39\uff0c\u7531\u793e\u533a\u4eba\u5458\u7ef4\u62a4\uff0c\u6d4b\u8bd5\u53ca\u66f4\u65b0 - Enterprise Edtion \u4f01\u4e1a\u7248\uff08EE\uff09\uff0c\u6536\u8d39\uff0cMySQL\u5b98\u65b9\u7ef4\u62a4\u56e2\u961f\u4eba\u5458\u7ef4\u62a4\uff0c\u6d4b\u8bd5\u53ca\u66f4\u65b0","title":"\u6570\u636e\u5e93\u4ea7\u54c1"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#mysql","text":"MySQL\u662f\u4e00\u4e2a\u771f\u6b63\u7684\u591a\u7ebf\u7a0b\uff0c\u591a\u7528\u6237\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08RDBMS\uff09\u670d\u52a1\u7ba1\u7406\u8f6f\u4ef6\uff0c\u51ed\u501f\u5176\u67e5\u8be2\u901f\u5ea6\u5feb\uff0c\u9ad8\u6027\u80fd\uff0c\u9ad8\u53ef\u9760\u548c\u6613\u4e8e\u4f7f\u7528\u7b49\u7279\u6027\uff0c\u6210\u4e3a\u670d\u52a1\u5668\u9886\u57df\u4e2d\u6700\u53d7\u6b22\u8fce\u7684\u5f00\u6e90\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\u3002\u57282008\u4e4b\u524d\uff0cMySQL\u9879\u76ee\u7531MySQL AB\u7684\u521b\u59cb\u4eba\u9ea6\u514b\u5c14\u00b7\u7ef4\u5fb7\u7ebd\u65af\u4e3b\u5bfc\u5f00\u53d1\uff0c\u53d1\u5e03\u4e0e\u652f\u6301\uff0cSUN\u57282008\u5e74\u4ee510\u4ebf\u7f8e\u5143\u6536\u8d2d\u4e86MySQL AB\u3002\u7b2c\u4e8c\u5e744\u6708\u4efdOracle\u7532\u9aa8\u6587\u5ba3\u5e03\u5c06\u4ee574\u4ebf\u7f8e\u5143\u5e76\u8d2dSUN\u516c\u53f8\u3002\u76ee\u524dMySQL\u9879\u76ee\u7531Oracle\u516c\u53f8\u8d1f\u8d23\u8fd0\u8425\u548c\u7ef4\u62a4\u3002","title":"MySQL\u4ea7\u54c1\u7b80\u4ecb"},{"location":"3.k8s/mysql-operator/0-mysql-docs/#mysqlmariadb","text":"MariaDB\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u662fMySQL\u7684\u4e00\u4e2a\u5206\u652f\uff0c\u4e3b\u8981\u7531\u5f00\u6e90\u793e\u533a\u5728\u7ef4\u62a4\uff0c\u91c7\u7528GPL\u6388\u6743\u8bb8\u53ef\u3002\u5f00\u53d1\u8fd9\u4e2a\u5206\u652f\u7684\u539f\u56e0\u4e4b\u4e00\uff1a\u7532\u9aa8\u6587\u516c\u53f8\u6536\u8d2d\u4e86MySQL\u540e\uff0c\u6709\u5c06MySQL\u95ed\u6e90\u7684\u6f5c\u5728\u98ce\u9669\uff0c\u56e0\u6b64\u793e\u533a\u91c7\u7528\u5206\u652f\u7684\u65b9\u5f0f\u6765\u907f\u5f00\u8fd9\u4e2a\u98ce\u9669\u3002MariaDB\u7684\u76ee\u7684\u662f\u5b8c\u5168\u517c\u5bb9MySQL\uff0c\u5305\u62ecAPI\u548c\u547d\u4ee4\u884c\uff0c\u4f7f\u4e4b\u80fd\u8f7b\u677e\u6210\u4e3aMySQL\u7684\u4ee3\u66ff\u54c1\u3002 MariaDB\u540d\u79f0\u6765\u81ea\u9ea6\u514b\u5c14\u00b7\u7ef4\u5fb7\u7ebd\u65af\u7684\u5973\u513f\u739b\u4e3d\u4e9a\uff08\u82f1\u8bed\uff1aMaria\uff09\u7684\u540d\u5b57\u3002 MariaDB\u76f4\u52305.5\u7248\u672c\uff0c\u5747\u4f9d\u7167MySQL\u7684\u7248\u672c\u53d1\u5c55\u3002\u56e0\u6b64\uff0c\u4f7f\u7528MariaDB5.5\u7684\u4eba\u4f1a\u4eceMySQL5.5\u4e2d\u4e86\u89e3\u5230MariaDB\u7684\u6240\u6709\u529f\u80fd\u3002\u4ece2012\u5e7411\u670812\u65e5\u8d77\u53d1\u5e03\u768410.0.0\u7248\u5f00\u59cb\uff0c\u4e0d\u518d\u4f9d\u7167MySQL\u7684\u7248\u53f7\u300210.0.x\u7248\u4ee55.5\u7248\u4e3a\u57fa\u7840\uff0c\u52a0\u4e0a\u79fb\u690d\u81eaMySQL 5.6\u7248\u7684\u529f\u80fd\u548c\u81ea\u884c\u5f00\u53d1\u7684\u65b0\u529f\u80fd\u3002CentOS7\u7cfb\u5217Linux\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u91c7\u7528MariaDB\u66ff\u4ee3\u4e86MySQL\u6570\u636e\u5e93\u4ea7\u54c1\u3002","title":"MySQL\u4e0eMariaDB\u5173\u8054"},{"location":"3.k8s/mysql-operator/1-install-mysql-operator/","text":"Mysql-operator \u5b89\u88c5\u90e8\u7f72 \u00b6 \u73af\u5883\u8981\u6c42 \u5b89\u88c5Helm\u5305\u7ba1\u7406\u5de5\u5177 \u5b89\u88c5rook-ceph\u4f5c\u4e3a\u540e\u7aef\u5b58\u50a8 \u5b89\u88c5operator \u5b89\u88c5mysql\u670d\u52a1 \u5b89\u88c5 \u00b6 Helm\u548crook-ceph\u8fd9\u91cc\u5c31\u4e0d\u8fdb\u884c\u6f14\u793a\u5b89\u88c5\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e4b\u524d\u7684\u6587\u7ae0\u6765\u5b89\u88c5 **\u5b89\u88c5operator ** \u00b6 github\u4e0a\u6709\u4e00\u4e2a\u9879\u76ee\u53ef\u4ee5\u5e2e\u6211\u4eec\u5feb\u901f\u7684\u6765\u5b89\u88c5 mysql \u4f18\u52bf: \u5feb\u901f\u90e8\u7f72Mysql\u670d\u52a1 \u89e3\u51b3\u4e86\u76d1\u63a7\u3001\u53ef\u7528\u6027\u3001\u53ef\u6269\u5c55\u6027\u548c\u5907\u4efd\u95ee\u9898 \u901a\u8fc7storageClass\u6765\u89e3\u51b3\u5b58\u50a8\u95ee\u9898 \u5f00\u7bb1\u5373\u7528\u7684\u5907\u4efd\uff08\u8ba1\u5212\u548c\u6309\u9700\uff09\u548c\u65f6\u95f4\u70b9\u6062\u590d \u6dfb\u52a0chart\u5730\u5740 \u00b6 helm repo add bitpoke https://helm-charts.bitpoke.io helm repo update \u5b89\u88c5mysql-operator \u00b6 $ helm install mysql-operator bitpoke/mysql-operator \\ -f 1 -config.yaml \\ -n infra WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/beiyiwangdejiyi/.kube/config WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/beiyiwangdejiyi/.kube/config NAME: mysql-operator LAST DEPLOYED: Thu Aug 25 10 :24:53 2022 NAMESPACE: infra STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: You can create a new cluster by issuing: cat <<EOF | kubectl apply -f- apiVersion: mysql.presslabs.org/v1alpha1 kind: MysqlCluster metadata: name: my-cluster spec: replicas: 1 secretName: my-cluster-secret --- apiVersion: v1 kind: Secret metadata: name: my-cluster-secret type: Opaque data: ROOT_PASSWORD: $(echo -n \"not-so-secure\" | base64) EOF \u8fd9\u4e2a1-config.yaml\u6587\u4ef6\u662f\u7ed9operator\u6765\u4f7f\u7528\u7684\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86storageClass\u548c\u5bb9\u91cf $ cat 1 -config.yaml orchestrator: persistence: enabled: true storageClass: \"rook-ceph-block\" accessMode: \"ReadWriteOnce\" size: 10Gi \u9a8c\u8bc1\uff1a $ k get pod NAME READY STATUS RESTARTS AGE mysql-operator-0 2 /2 Running 2 ( 6m46s ago ) 6m47s \u8fd9\u65f6\uff0cmysql-operator\u5c31\u5b89\u88c5\u597d\u4e86\uff0c\u7b2c\u4e8c\u6b65\u5c31\u5b89\u88c5Mysql **\u5b89\u88c5mysql ** \u00b6 $ k apply -f 2 -openbayes-mysql.yaml secret/openbayes-db-secret created mysqlcluster.mysql.presslabs.org/openbayes created","title":"Mysql-operator \u5b89\u88c5\u90e8\u7f72"},{"location":"3.k8s/mysql-operator/1-install-mysql-operator/#mysql-operator","text":"\u73af\u5883\u8981\u6c42 \u5b89\u88c5Helm\u5305\u7ba1\u7406\u5de5\u5177 \u5b89\u88c5rook-ceph\u4f5c\u4e3a\u540e\u7aef\u5b58\u50a8 \u5b89\u88c5operator \u5b89\u88c5mysql\u670d\u52a1","title":"Mysql-operator \u5b89\u88c5\u90e8\u7f72"},{"location":"3.k8s/mysql-operator/1-install-mysql-operator/#_1","text":"Helm\u548crook-ceph\u8fd9\u91cc\u5c31\u4e0d\u8fdb\u884c\u6f14\u793a\u5b89\u88c5\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e4b\u524d\u7684\u6587\u7ae0\u6765\u5b89\u88c5","title":"\u5b89\u88c5"},{"location":"3.k8s/mysql-operator/1-install-mysql-operator/#operator","text":"github\u4e0a\u6709\u4e00\u4e2a\u9879\u76ee\u53ef\u4ee5\u5e2e\u6211\u4eec\u5feb\u901f\u7684\u6765\u5b89\u88c5 mysql \u4f18\u52bf: \u5feb\u901f\u90e8\u7f72Mysql\u670d\u52a1 \u89e3\u51b3\u4e86\u76d1\u63a7\u3001\u53ef\u7528\u6027\u3001\u53ef\u6269\u5c55\u6027\u548c\u5907\u4efd\u95ee\u9898 \u901a\u8fc7storageClass\u6765\u89e3\u51b3\u5b58\u50a8\u95ee\u9898 \u5f00\u7bb1\u5373\u7528\u7684\u5907\u4efd\uff08\u8ba1\u5212\u548c\u6309\u9700\uff09\u548c\u65f6\u95f4\u70b9\u6062\u590d","title":"**\u5b89\u88c5operator **"},{"location":"3.k8s/mysql-operator/1-install-mysql-operator/#chart","text":"helm repo add bitpoke https://helm-charts.bitpoke.io helm repo update","title":"\u6dfb\u52a0chart\u5730\u5740"},{"location":"3.k8s/mysql-operator/1-install-mysql-operator/#mysql-operator_1","text":"$ helm install mysql-operator bitpoke/mysql-operator \\ -f 1 -config.yaml \\ -n infra WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /Users/beiyiwangdejiyi/.kube/config WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /Users/beiyiwangdejiyi/.kube/config NAME: mysql-operator LAST DEPLOYED: Thu Aug 25 10 :24:53 2022 NAMESPACE: infra STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: You can create a new cluster by issuing: cat <<EOF | kubectl apply -f- apiVersion: mysql.presslabs.org/v1alpha1 kind: MysqlCluster metadata: name: my-cluster spec: replicas: 1 secretName: my-cluster-secret --- apiVersion: v1 kind: Secret metadata: name: my-cluster-secret type: Opaque data: ROOT_PASSWORD: $(echo -n \"not-so-secure\" | base64) EOF \u8fd9\u4e2a1-config.yaml\u6587\u4ef6\u662f\u7ed9operator\u6765\u4f7f\u7528\u7684\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86storageClass\u548c\u5bb9\u91cf $ cat 1 -config.yaml orchestrator: persistence: enabled: true storageClass: \"rook-ceph-block\" accessMode: \"ReadWriteOnce\" size: 10Gi \u9a8c\u8bc1\uff1a $ k get pod NAME READY STATUS RESTARTS AGE mysql-operator-0 2 /2 Running 2 ( 6m46s ago ) 6m47s \u8fd9\u65f6\uff0cmysql-operator\u5c31\u5b89\u88c5\u597d\u4e86\uff0c\u7b2c\u4e8c\u6b65\u5c31\u5b89\u88c5Mysql","title":"\u5b89\u88c5mysql-operator"},{"location":"3.k8s/mysql-operator/1-install-mysql-operator/#mysql","text":"$ k apply -f 2 -openbayes-mysql.yaml secret/openbayes-db-secret created mysqlcluster.mysql.presslabs.org/openbayes created","title":"**\u5b89\u88c5mysql **"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/","text":"MySQL\u5b8c\u5168\u5907\u4efd\u4e0e\u6062\u590d \u00b6 \u968f\u7740\u81ea\u52a8\u5316\u529e\u516c\u4e0e\u7535\u5b50\u5546\u52a1\u7684\u4e0d\u65ad\u6269\u5c55\uff0c\u4f01\u4e1a\u5bf9\u4e8e\u4fe1\u606f\u7cfb\u7edf\u7684\u4f9d\u8d56\u6027\u8d8a\u6765\u8d8a\u91cd\u8981\uff0c\u800c\u6570\u636e\u5e93\u5728\u4fe1\u606f\u7cfb\u7edf\u4e2d\u62c5\u4efb\u7740\u975e\u5e38\u91cd\u8981\u7684\u89d2\u8272\u3002\u5c24\u5176\u4e00\u4e9b\u5bf9\u6570\u636e\u5e93\u53ef\u9760\u6027\u8981\u6c42\u975e\u5e38\u9ad8\u7684\u884c\u4e1a\uff0c\u4f8b\u5982\u94f6\u884c\uff0c\u8bc1\u5238\uff0c\u7535\u4fe1\u7b49\uff0c\u5982\u679c\u53d1\u751f\u610f\u5916\u5b95\u673a\u6216\u6570\u636e\u4e22\u5931\uff0c\u5176\u635f\u5931\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002\u4e3a\u6b64\u6570\u636e\u5e93\u7ba1\u7406\u5458\u5fc5\u987b\u9488\u5bf9\u5177\u4f53\u7684\u4e1a\u52a1\u8981\u6c42\u5b9a\u5236\u8be6\u7ec6\u7684\u6570\u636e\u5e93\u5907\u4efd\u4e0e\u707e\u96be\u6062\u590d\u7684\u7b56\u7565\uff0c\u5e76\u901a\u8fc7\u6a21\u62df\u6545\u969c\u5bf9\u6bcf\u79cd\u53ef\u80fd\u7684\u60c5\u51b5\u8fdb\u884c\u4e25\u683c\u7684\u6d4b\u8bd5\u3002\u800c\u4fdd\u969c\u6570\u636e\u7684\u53ef\u9760\u6027\u3002 \u4e00\u3001\u6570\u636e\u5907\u4efd\u7684\u91cd\u8981\u6027 \u00b6 \u5907\u4efd\u7684\u4e3b\u8981\u76ee\u7684\u662f\u707e\u96be\u6062\u590d\uff0c\u5907\u4efd\u8fd8\u53ef\u4ee5\u6d4b\u8bd5\u5e94\u7528\uff0c\u56de\u6eda\u6570\u636e\u4fee\u6539\uff0c\u67e5\u8be2\u5386\u53f2\u6570\u636e\uff0c\u5ba1\u8ba1\u7b49\u3002\u6211\u4eec\u5c06\u4ece\u751f\u4ea7\u8fd0\u7ef4\u7684\u89d2\u5ea6\u4e86\u89e3\u5907\u4efd\u6062\u590d\u7684\u5206\u7c7b\u4e0e\u65b9\u6cd5\u3002 \u5728\u4f01\u4e1a\u4e2d\u6570\u636e\u7684\u4ef7\u503c\u81f3\u5173\u91cd\u8981\uff0c\u6570\u636e\u4fdd\u969c\u4e86\u4f01\u4e1a\u4e1a\u52a1\u7684\u8fd0\u884c\uff0c\u56e0\u6b64\u6570\u636e\u7684\u5b89\u5168\u6027\u53ca\u53ef\u9760\u6027\u662f\u8fd0\u7ef4\u7684\u91cd\u4e2d\u4e4b\u91cd\uff0c\u4efb\u4f55\u6570\u636e\u7684\u4e22\u5931\u90fd\u6709\u53ef\u80fd\u4f1a\u5bf9\u4f01\u4e1a\u4ea7\u751f\u4e25\u91cd\u7684\u540e\u679c\u3002\u9020\u6210\u6570\u636e\u4e22\u5931\u7684\u539f\u56e0\u5982\u4e0b\uff1a \u7a0b\u5e8f\u9519\u8bef \u4eba\u4e3a\u9519\u8bef \u6570\u636e\u6cc4\u9732 \u8fd0\u7b97\u5931\u8d25 \u78c1\u76d8\u6545\u969c \u707e\u96be\uff08\u5982\u706b\u707e\u3001\u5730\u9707\uff09 \u4e8c\u3001\u6570\u636e\u5e93\u5907\u4efd\u7684\u7c7b\u578b \u00b6 2.1 \u4ece\u7269\u7406\u4e0e\u903b\u8f91\u7684\u89d2\u5ea6 \u00b6 \u5907\u4efd\u53ef\u4ee5\u5206\u4e3a\u7269\u7406\u5907\u4efd\u548c\u903b\u8f91\u5907\u4efd\u3002 \u7269\u7406\u5907\u4efd \uff1a\u5bf9\u6570\u636e\u5e93\u64cd\u4f5c\u7cfb\u7edf\u7684\u7269\u7406\u6587\u4ef6\uff08\u5982\u6570\u636e\u6587\u4ef6\u3001\u65e5\u5fd7\u6587\u4ef6\u7b49\uff09\u7684\u5907\u4efd\u3002\u7269\u7406\u5907\u4efd\u53c8\u53ef\u5206\u4e3a\u8131\u673a\u5907\u4efd\uff08\u51b7\u5907\u4efd\uff09\u548c\u8054\u673a\u5907\u4efd\uff08\u70ed\u5907\u4efd\uff09\u3002\u8fd9\u79cd\u7c7b\u578b\u7684\u5907\u4efd\u9002\u7528\u4e8e\u51fa\u73b0\u95ee\u9898\u65f6\u9700\u8981\u5feb\u901f\u6062\u590d\u7684\u5927\u578b\u91cd\u8981\u6570\u636e\u5e93\u3002 \u51b7\u5907\u4efd\uff1a\u662f\u5728\u5173\u95ed\u6570\u636e\u5e93\u7684\u65f6\u5019\u8fdb\u884c\u7684 \u70ed\u5907\u4efd\uff1a\u6570\u636e\u5e93\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\uff0c\u8fd9\u79cd\u5907\u4efd\u65b9\u6cd5\u4f9d\u8d56\u4e8e\u6570\u636e\u5e93\u7684\u65e5\u5fd7\u6587\u4ef6 \u6e29\u5907\u4efd\uff1a\u6570\u636e\u5e93\u9501\u5b9a\u8868\u683c\uff08\u4e0d\u53ef\u5199\u5165\u4f46\u53ef\u8bfb\uff09\u7684\u72b6\u6001\u4e0b\u8fdb\u884c\u7684 \u903b\u8f91\u5907\u4efd \uff1a\u5bf9\u6570\u636e\u5e93\u903b\u8f91\u7ec4\u4ef6\uff08\u5982\u8868\u7b49\u6570\u636e\u5e93\u5bf9\u8c61\uff09\u7684\u5907\u4efd\uff0c\u8868\u793a\u4e3a\u903b\u8f91\u6570\u636e\u5e93\u7ed3\u6784\uff08create database\u3001create table\u7b49\u8bed\u53e5\uff09\u548c\u5185\u5bb9\uff08insert\u8bed\u53e5\u6216\u5206\u5272\u6587\u672c\u6587\u4ef6\uff09\u7684\u4fe1\u606f\u3002\u8fd9\u79cd\u7c7b\u578b\u7684\u5907\u4efd\u9002\u7528\u4e8e\u53ef\u4ee5\u7f16\u8f91\u6570\u636e\u503c\u6216\u8868\u7ed3\u6784\u8f83\u5c0f\u7684\u6570\u636e\u91cf\uff0c\u6216\u8005\u5728\u4e0d\u540c\u673a\u5668\u4f53\u7cfb\u7ed3\u6784\u4e0a\u91cd\u65b0\u521b\u5efa\u6570\u636e\u3002 2.2 \u4ece\u6570\u636e\u5e93\u7684\u5907\u4efd\u7b56\u7565\u89d2\u5ea6 \u00b6 \u5907\u4efd\u53ef\u5206\u4e3a\u5b8c\u5168\u5907\u4efd\u3001\u5dee\u5f02\u5907\u4efd\u548c\u589e\u91cf\u5907\u4efd \u5b8c\u5168\u5907\u4efd \uff1a\u6bcf\u6b21\u5bf9\u6570\u636e\u8fdb\u884c\u5b8c\u6574\u7684\u5907\u4efd\uff0c\u5373\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u7684\u5907\u4efd\u3001\u6570\u636e\u5e93\u7ed3\u6784\u548c\u6587\u4ef6\u7ed3\u6784\u7684\u5907\u4efd\uff0c\u4fdd\u5b58\u7684\u662f\u5907\u4efd\u5b8c\u6210\u65f6\u523b\u7684\u6570\u636e\u5e93\u72b6\u6001\uff0c\u662f\u5dee\u5f02\u5907\u4efd\u4e0e\u589e\u91cf\u5907\u4efd\u7684\u57fa\u7840\u3002 \u4f18\u70b9\uff1a\u5907\u4efd\u4e0e\u6062\u590d\u64cd\u4f5c\u7b80\u5355\u65b9\u4fbf \u7f3a\u70b9\uff1a\u6570\u636e\u5b58\u5728\u5927\u91cf\u7684\u91cd\u590d\uff1b\u5360\u7528\u5927\u91cf\u7684\u7a7a\u95f4\uff1b\u5907\u4efd\u4e0e\u6062\u590d\u65f6\u95f4\u957f \u5dee\u5f02\u5907\u4efd \uff1a\u5907\u4efd\u90a3\u4e9b\u81ea\u4ece\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u4e4b\u540e\u88ab\u4fee\u6539\u8fc7\u7684\u6240\u6709\u6587\u4ef6\uff0c\u5907\u4efd\u7684\u65f6\u95f4\u8d77\u70b9\u662f\u4ece\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u8d77\uff0c\u5907\u4efd\u6570\u636e\u91cf\u4f1a\u8d8a\u6765\u8d8a\u5927\u3002\u6062\u590d\u6570\u636e\u65f6\uff0c\u53ea\u9700\u6062\u590d\u4e0a\u6b21\u7684\u5b8c\u5168\u5907\u4efd\u4e0e\u6700\u8fd1\u7684\u4e00\u6b21\u5dee\u5f02\u5907\u4efd\u3002 \u589e\u91cf\u5907\u4efd \uff1a\u53ea\u6709\u90a3\u4e9b\u5728\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u6216\u8005\u589e\u91cf\u5907\u4efd\u540e\u88ab\u4fee\u6539\u7684\u6587\u4ef6\u624d\u4f1a\u88ab\u5907\u4efd\u3002\u4ee5\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u6216\u4e0a\u6b21\u7684\u589e\u91cf\u5907\u4efd\u7684\u65f6\u95f4\u4e3a\u65f6\u95f4\u70b9\uff0c\u4ec5\u5907\u4efd\u8fd9\u4e4b\u95f4\u7684\u6570\u636e\u53d8\u5316\uff0c\u56e0\u800c\u5907\u4efd\u7684\u6570\u636e\u91cf\u5c0f\uff0c\u5360\u7528\u7a7a\u95f4\u5c0f\uff0c\u5907\u4efd\u901f\u5ea6\u5feb\u3002\u4f46\u6062\u590d\u65f6\uff0c\u9700\u8981\u4ece\u4e0a\u4e00\u6b21\u7684\u5b8c\u6574\u5907\u4efd\u8d77\u5230\u6700\u540e\u4e00\u6b21\u589e\u91cf\u5907\u4efd\u4f9d\u6b21\u6062\u590d\uff0c\u5982\u4e2d\u95f4\u67d0\u6b21\u7684\u5907\u4efd\u6570\u636e\u635f\u574f\uff0c\u5c06\u5bfc\u81f4\u6570\u636e\u7684\u4e22\u5931\u3002 2.3 \u5e38\u89c1\u7684\u5907\u4efd\u65b9\u6cd5 \u00b6 MySQL\u6570\u636e\u5e93\u7684\u5907\u4efd\u53ef\u4ee5\u91c7\u7528\u5f88\u591a\u79cd\u65b9\u5f0f\uff0c\u5982\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\uff08\u7269\u7406\u51b7\u5907\u4efd\uff09\uff0c\u4e13\u7528\u5907\u4efd\u5de5\u5177\uff08mysqldump\uff09\uff0c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u589e\u91cf\u5907\u4efd\uff0c\u7b2c\u4e09\u65b9\u5de5\u5177\u5907\u4efd\u7b49\u3002 \u7269\u7406\u5907\u4efd \uff1a\u7269\u7406\u51b7\u5907\u4efd\u65f6\u9700\u8981\u5728\u6570\u636e\u5e93\u5904\u4e8e\u5173\u95ed\u72b6\u6001\u4e0b\uff0c\u80fd\u591f\u8f83\u597d\u7684\u4fdd\u8bc1\u6570\u636e\u5e93\u7684\u5b8c\u6574\u6027\u3002\u7269\u7406\u51b7\u5907\u4efd\u4ee5\u7528\u4e8e\u975e\u6838\u5fc3\u4e1a\u52a1\uff0c\u8fd9\u7c7b\u4e1a\u52a1\u90fd\u5141\u8bb8\u4e2d\u65ad\uff0c\u7269\u7406\u51b7\u5907\u4efd\u7684\u7279\u70b9\u5c31\u662f\u901f\u5ea6\u5feb\uff0c\u6062\u590d\u65f6\u4e5f\u662f\u6700\u4e3a\u7b80\u5355\u7684\uff0c\u901a\u8fc7\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\u5939\uff08/usr/local/mysql/data\uff09\u6765\u5b9e\u73b0\u5907\u4efd\u3002 \u4e13\u7528\u5907\u4efd\u5de5\u5177mysqldump\u6216mysqlhotcopy \uff1amysqldump\u548cmysqlhotcopy\u90fd\u53ef\u4ee5\u505a\u5907\u4efd\u3002mysqldump\u662f\u5ba2\u6237\u7aef\u5e38\u7528\u903b\u8f91\u5907\u4efd\u7a0b\u5e8f\uff0c\u80fd\u591f\u4ea7\u751f\u4e00\u7ec4\u88ab\u6267\u884c\u4ee5\u518d\u73b0\u539f\u59cb\u6570\u636e\u5e93\u5bf9\u8c61\u5b9a\u4e49\u548c\u8868\u6570\u636e\u7684SQL\u8bed\u53e5\u3002\u5b83\u53ef\u4ee5\u8f6c\u50a8\u4e00\u4e2a\u5230\u591a\u4e2aMySQL\u6570\u636e\u5e93\uff0c\u5176\u8fdb\u884c\u5907\u4efd\u6216\u4f20\u8f93\u5230\u8fdc\u7a0bSQL\u670d\u52a1\u5668\u3002mysqldump\u66f4\u4e3a\u901a\u7528\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u5907\u4efd\u5404\u79cd\u8868\u3002mysqlhotcopy\u4ec5\u9002\u7528\u4e8e\u67d0\u4e9b\u5b58\u50a8\u5f15\u64ce\u3002mysqlhotcopy\u662f\u7531Tim Bunce\u6700\u521d\u7f16\u5199\u548c\u8d21\u732e\u7684Perl\u811a\u672c\u3002mysqlhotcopy\u4ec5\u7528\u4e8e\u5907\u4efdMyISAM\u548cARCHIVE\u6570\u636e\u8868\u3002\u53ea\u80fd\u8fd0\u884c\u5728Unix\u6216Linux\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u3002 \u901a\u8fc7\u542f\u7528\u4e8c\u8fdb\u5236\uff08binary log\uff0cbinlog\uff09\u65e5\u5fd7\u8fdb\u884c\u589e\u91cf\u5907\u4efd \uff1aMySQL\u652f\u6301\u589e\u91cf\u5907\u4efd\uff0c\u8fdb\u884c\u589e\u91cf\u5907\u4efd\u65f6\u5fc5\u987b\u542f\u7528\u4e8c\u8fdb\u5236\u65e5\u5fd7\u3002\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u4e3a\u7528\u6237\u63d0\u4f9b\u590d\u5236\u3002\u5bf9\u6267\u884c\u5907\u4efd\u70b9\u540e\u8fdb\u884c\u7684\u6570\u636e\u5e93\u66f4\u6539\u6240\u9700\u7684\u4fe1\u606f\u8fdb\u884c\u5907\u4efd\u3002\u5982\u679c\u8fdb\u884c\u589e\u91cf\u5907\u4efd\uff08\u5305\u542b\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u6216\u589e\u91cf\u5907\u4efd\u4ee5\u6765\u53d1\u751f\u7684\u6570\u636e\u4fee\u6539\uff09\uff0c\u9700\u8981\u5237\u65b0\u4e8c\u8fdb\u5236\u65e5\u5fd7\u3002 \u901a\u8fc7\u7b2c\u4e09\u65b9\u5de5\u5177\u5907\u4efd \uff1aPercona XtraBackup\u662f\u4e00\u4e2a\u514d\u8d39\u7684MySQL\u70ed\u5907\u4efd\u8f6f\u4ef6\uff0c\u652f\u6301\u5728\u7ebf\u5907\u4efdInnodb\u548cXtraDB\uff0c\u4e5f\u53ef\u4ee5\u652f\u6301MySQL\u8868\u5907\u4efd\uff0c\u4e0d\u8fc7MyISAM\u8868\u7684\u5907\u4efd\u8981\u5728\u8868\u9501\u7684\u60c5\u51b5\u8fdb\u884c\u3002 Percona XtraBackup\u4e3b\u8981\u7684\u5de5\u5177\uff1axtrabackup\u3001innobackupex\u3001xbstream xtrabackup\uff1a\u662f\u4e00\u4e2a\u7f16\u8bd1\u4e86\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u53ea\u80fd\u5907\u4efdInnodb/Xtradb\u6570\u636e\u6587\u4ef6 innobackupex\uff1a\u662f\u4e00\u4e2a\u5c01\u88c5\u4e86xtrabackup\u7684Perl\u811a\u672c\uff0c\u9664\u4e86\u53ef\u4ee5\u5907\u4efdInnodb/Xtradb\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u5907\u4efdMyISAM\u3002 xbstream\uff1a\u662f\u4e00\u4e2a\u65b0\u7ec4\u4ef6\uff0c\u80fd\u591f\u5141\u8bb8\u5c06\u6587\u4ef6\u683c\u5f0f\u8f6c\u6362\u6210xbstream\u683c\u5f0f\u6216\u4ecexbstream\u683c\u5f0f\u8f6c\u5230\u6587\u4ef6\u683c\u5f0f\u3002 xtrabackup\u5de5\u5177\u53ef\u4ee5\u5355\u72ec\u4f7f\u7528\uff0c\u4f46\u63a8\u8350\u4f7f\u7528innobackupx\u6765\u8fdb\u884c\u5907\u4efd\uff0c\u56e0\u4e3a\u5176\u672c\u8eab\u5df2\u7ecf\u5305\u542b\u4e86xtrabackup\u7684\u6240\u6709\u529f\u80fd\u3002 2.4 XtraBackup\u7684\u5907\u4efd\u4e0e\u6062\u590d \u00b6 XtraBackup \u662f\u57fa\u4e8eInnodb\u7684\u707e\u96be\u6062\u590d\u529f\u80fd\u8fdb\u884c\u8bbe\u8ba1\u7684\u3002\u5907\u4efd\u5de5\u5177\u590d\u5236Innodb\u7684\u6570\u636e\u6587\u4ef6\uff0c\u7531\u4e8e\u4e0d\u9501\u8868\uff0c\u8fd9\u6837\u590d\u5236\u51fa\u6765\u7684\u6570\u636e\u5c06\u4e0d\u4e00\u81f4\u3002\u4f46\u662f\uff0cInnodb\u7ef4\u62a4\u4e86\u4e00\u4e2a\u91cd\u8981\u7684\u91cd\u505a\u65e5\u5fd7\uff0c\u5305\u542bInnodb\u6570\u636e\u7684\u6240\u6709\u6539\u52a8\u60c5\u51b5\u3002\u5728XtraBackup\u5907\u4efdInnodb\u7684\u6570\u636e\u540c\u65f6\uff0cXtraBackup\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u7ebf\u7a0b\u7528\u6765\u76d1\u63a7\u91cd\u505a\u65e5\u5fd7\uff0c\u4e00\u65e6\u65e5\u5fd7\u53d1\u751f\u53d8\u5316\uff0c\u5c31\u628a\u53d1\u751f\u53d8\u5316\u7684\u65e5\u5fd7\u6570\u636e\u590d\u5236\u8d70\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u5229\u7528\u91cd\u505a\u65e5\u5fd7\u505a\u707e\u96be\u6062\u590d\u3002 \u4ee5\u4e0a\u662f\u5907\u4efd\u8fc7\u7a0b\u3002\u5982\u679c\u6211\u4eec\u9700\u8981\u6062\u590d\u6570\u636e\uff0c\u5219\u5728\u51c6\u5907\u9636\u6bb5\uff0cXtraBackup\u5c31\u9700\u8981\u4f7f\u7528\u4e4b\u524d\u590d\u5236\u7684\u91cd\u505a\u65e5\u5fd7\u5bf9\u5907\u4efd\u51fa\u6765\u7684Innodb\u6570\u636e\u6587\u4ef6\u8fdb\u884c\u707e\u96be\u6062\u590d\u3002\u6b64\u9636\u6bb5\u5b8c\u6210\u4e4b\u540e\uff0c\u6570\u636e\u5e93\u5c31\u53ef\u4ee5\u8fdb\u884c\u91cd\u5efa\u8fd8\u539f\u4e86\u3002Percona XtraBackup\u5bf9MyISAM\u7684\u590d\u5236\u662f\u6309\u987a\u5e8f\u8fdb\u884c\u7684\uff0c\u5148\u9501\u5b9a\u8868\uff0c\u7136\u540e\u590d\u5236\uff0c\u518d\u89e3\u9501\u8868\u3002 \u6e29\u99a8\u63d0\u793a \u6570\u636e\u5e93\u5907\u4efd\u7b56\u7565\u601d\u8003\uff1f 1.\u516c\u53f8\u6570\u636e\u5e93\u7684\u603b\u6570\u636e\u91cf\u591a\u5927\uff1f 25~30G 2.\u6bcf\u5929\u589e\u957f\u91cf\u591a\u5927\uff1f50M 3.\u5907\u4efd\u7684\u7b56\u7565\uff1f 4.\u5907\u4efd\u6570\u636e\u91cf\uff1f 5.\u5907\u4efd\u7684\u65f6\u957f\uff1f \u4e09\u3001MySQL\u5b8c\u5168\u5907\u4efd\u64cd\u4f5c \u00b6 MySQL\u6570\u636e\u5e93\u7684\u5b8c\u5168\u5907\u4efd\u53ef\u4ee5\u91c7\u7528\u591a\u79cd\u65b9\u5f0f\uff0c\u7269\u7406\u51b7\u5907\u4efd\u4e00\u822c\u7528tar\u547d\u4ee4\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\u5939\uff08\u6570\u636e\u76ee\u5f55\uff09\uff0c\u800c\u5728\u5907\u4efd\u524d\u9700\u8981\u5148\u505c\u5e93\u3002 1\u3001\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\u5939 \u00b6 \u6e90\u7801\u5305\u7684\u4f4d\u7f6e/usr/local/mysql/data/\uff0crpm\u5305\u7684\u4f4d\u7f6e /var/lib/mysql/ [root@localhost ~]# /etc/init.d/mysqld start Starting MySQL............... SUCCESS! [root@localhost ~]# netstat -lnpt | grep :3306 tcp6 0 0 :::3306 :::* LISTEN 1630/mysqld [root@localhost ~]# mysql -u root -p123456 mysql> create database auth; Query OK, 1 row affected (0.00 sec) mysql> use auth; Database changed mysql> create table user(name char(10) not null,ID int(48)); Query OK, 0 rows affected (0.04 sec) mysql> insert into user values('crushlinux','123'); Query OK, 1 row affected (0.01 sec) mysql> select * from user; +------------+------+ | name | ID | +------------+------+ | crushlinux | 123 | +------------+------+ 1 row in set (0.00 sec) mysql> exit Bye \u505c\u6b62\u6570\u636e\u5e93\uff0c\u8fdb\u884c\u5907\u4efd\u3002 [root@localhost ~]# /etc/init.d/mysqld stop Shutting down MySQL.. SUCCESS! [root@localhost ~]# mkdir backup [root@localhost ~]# tar zcf backup/mysql_all-$(date +%F).tar.gz /usr/local/mysql/data/ tar: Removing leading `/' from member names [root@localhost ~]# ls -l backup/ \u603b\u7528\u91cf 728 -rw-r--r-- 1 root root 742476 12\u6708 14 23:31 mysql_all-2018-12-14.tar.gz \u6a21\u62df\u4e22\u5931: [root@localhost ~]# /etc/init.d/mysqld start Starting MySQL.. SUCCESS! [root@localhost ~]# mysql -uroot -p123456 mysql> drop database auth; Query OK, 1 row affected (0.02 sec) \u6062\u590d\u6570\u636e: [root@localhost ~]# /etc/init.d/mysqld stop Shutting down MySQL.. SUCCESS! [root@localhost ~]# mkdir restore [root@localhost ~]# tar xf backup/mysql_all-2020-04-23.tar.gz -C restore/ [root@localhost ~]# rm -rf /usr/local/mysql/data/* [root@localhost ~]# mv restore/usr/local/mysql/data/* /usr/local/mysql/data/ [root@localhost ~]# /etc/init.d/mysqld start Starting MySQL. SUCCESS! [root@localhost ~]# mysql -uroot -p123456 -e 'select * from auth.user;' mysql: [Warning] Using a password on the command line interface can be insecure. +------------+------+ | name | ID | +------------+------+ | crushlinux | 123 | +------------+------+ 2\u3001\u4f7f\u7528\u4e13\u7528\u5907\u4efd\u5de5\u5177mysqldump \u00b6 MySQL\u81ea\u5e26\u7684\u5907\u4efd\u5de5\u5177mysqldump\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5bf9MySQL\u8fdb\u884c\u5907\u4efd\u3002\u901a\u8fc7\u8be5\u547d\u4ee4\u5de5\u5177\u53ef\u4ee5\u5c06\u6570\u636e\u5e93\u3001\u6570\u636e\u8868\u6216\u5168\u90e8\u7684\u5e93\u5bfc\u51fa\u4e3aSQL\u811a\u672c\uff0c\u4fbf\u4e8e\u8be5\u547d\u4ee4\u5728\u4e0d\u540c\u7248\u672c\u7684MySQL\u670d\u52a1\u5668\u4e0a\u4f7f\u7528\u3002\u4f8b\u5982\uff0c\u5f53\u9700\u8981\u5347\u7ea7MySQL\u670d\u52a1\u5668\u65f6\uff0c\u53ef\u4ee5\u5148\u4f7f\u7528mysqldump\u547d\u4ee4\u5c06\u539f\u6709\u5e93\u4fe1\u606f\u5230\u5bfc\u51fa\uff0c\u7136\u540e\u76f4\u63a5\u5728\u5347\u7ea7\u540e\u7684MySQL\u670d\u52a1\u5668\u4e2d\u5bfc\u5165\u5373\u53ef\u3002 1. \u5bf9\u5355\u4e2a\u5e93\u8fdb\u884c\u5b8c\u5168\u5907\u4efd \u00b6 \u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p[\u5bc6\u7801] [\u9009\u9879] --databases [\u6570\u636e\u5e93\u540d] > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 --databases auth > backup/auth-$(date +%Y%m%d).sql mysqldump: [Warning] Using a password on the command line interface can be insecure. [root@localhost ~]# cat backup/auth-20181214.sql 2. \u5bf9\u591a\u4e2a\u5e93\u8fdb\u884c\u5b8c\u5168\u5907\u4efd \u00b6 \u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] [\u9009\u9879] --databases \u5e93\u540d1 [\u5e93\u540d2]\u2026 > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 --databases mysql auth > backup/mysql+auth-$(date +%Y%m%d).sql [root@localhost ~]# cat backup/mysql+auth-20181214.sql 3. \u5bf9\u6240\u6709\u5e93\u8fdb\u884c\u5b8c\u5168\u5907\u4efd \u00b6 \u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] [\u9009\u9879] --opt --all-databases > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 --opt --all-databases > backup/mysql_all.$(date +%Y%m%d).sql [root@localhost ~]# cat backup/mysql_all.20181214.sql //--opt \u52a0\u5feb\u5907\u4efd\u901f\u5ea6\uff0c\u5f53\u5907\u4efd\u6570\u636e\u91cf\u5927\u65f6\u4f7f\u7528 [root@localhost ~]# cat backup/mysql_all.20160505.sql 4. \u5bf9\u8868\u8fdb\u884c\u5b8c\u5168\u5907\u4efd \u00b6 \u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] [\u9009\u9879] \u6570\u636e\u5e93\u540d \u8868\u540d > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 auth user > backup/auth_user-$(date +%Y%m%d).sql [root@localhost ~]# cat backup/auth_user-20181214.sql 5. \u5bf9\u8868\u7ed3\u6784\u7684\u5907\u4efd \u00b6 \u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] -d \u6570\u636e\u5e93\u540d \u8868\u540d > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 -d mysql user > backup/desc_mysql_user-$(date +%Y%m%d).sql [root@localhost ~]# cat backup/desc_mysql_user-20181214.sql \u56db\u3001\u6062\u590d\u6570\u636e\u5e93 \u00b6 1. \u4f7f\u7528source\u547d\u4ee4 \u00b6 \u767b\u5f55\u5230MySQL\u6570\u636e\u5e93\uff0c\u6267\u884csource \u5907\u4efdsql\u811a\u672c\u8def\u5f84 \u793a\u4f8b\uff1a [root@localhost ~]# mysql -uroot -p123456 mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ 6 rows in set (0.00 sec) mysql> drop database auth; Query OK, 1 row affected (0.12 sec) mysql> source backup/auth.20181214.sql mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ 6 rows in set (0.00 sec) 2. \u4f7f\u7528mysql\u547d\u4ee4 \u00b6 \u683c\u5f0f\uff1a mysql -u\u7528\u6237\u540d -p [\u5bc6\u7801] < \u5e93\u5907\u4efd\u811a\u672c\u7684\u8def\u5f84 mysql -u\u7528\u6237\u540d -p [\u5bc6\u7801] \u5e93\u540d < \u8868\u5907\u4efd\u811a\u672c\u7684\u8def\u5f84 \u793a\u4f8b\uff1a [root@localhost ~]# mysql -uroot -p123456 -e 'show databases;' +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ [root@localhost ~]# mysql -uroot -p123456 -e 'drop database auth;' [root@localhost ~]# mysql -uroot -p123456 < backup/auth.20181214.sql [root@localhost ~]# mysql -uroot -p123456 -e 'show databases;' +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ [root@localhost ~]# mysql -uroot -p123456 -e 'drop table auth.user;' [root@localhost ~]# mysql -uroot -p123456 auth < backup/auth_user-20181214.sql [root@localhost ~]# mysql -uroot -p123456 -e 'select * from auth.user;' +------------+------+ | name | ID | +------------+------+ | crushlinux | 123 | +------------+------+ \u4e94\u3001MySQL\u5907\u4efd\u601d\u8def \u00b6 1\u3001\u5b9a\u671f\u5b9e\u65bd\u5907\u4efd\uff0c\u5236\u5b9a\u5907\u4efd\u8ba1\u5212\u6216\u7b56\u7565\uff0c\u5e76\u4e25\u683c\u9075\u5b88\u3002 2\u3001\u9664\u4e86\u8fdb\u884c\u5b8c\u5168\u5907\u4efd\uff0c\u5f00\u542fMySQL\u670d\u52a1\u5668\u7684binlog\u65e5\u5fd7\u529f\u80fd\u662f\u5f88\u91cd\u8981\u7684\uff08\u5b8c\u5168\u5907\u4efd\u52a0\u4e0a\u65e5\u5fd7\uff0c\u53ef\u4ee5\u5bf9MySQL\u8fdb\u884c\u6700\u5927\u5316\u8fd8\u539f\uff09\u3002 3\u3001\u4f7f\u7528\u7edf\u4e00\u548c\u6613\u7406\u89e3\u7684\u5907\u4efd\u540d\u79f0\uff0c\u63a8\u8350\u4f7f\u7528\u5e93\u540d\u6216\u8005\u8868\u540d\u52a0\u4e0a\u65f6\u95f4\u7684\u547d\u540d\u89c4\u5219\uff0c\u5982mysql_user-20181214.sql\uff0c\u4e0d\u8981\u4f7f\u7528backup1\u6216\u8005abc\u4e4b\u7c7b\u6ca1\u6709\u610f\u4e49\u7684\u540d\u5b57\u3002 \u516d\u3001MySQL\u5b8c\u5168\u5907\u4efd\u6848\u4f8b \u00b6 \u9700\u6c42\u63cf\u8ff0\uff1a \u7528\u6237\u4fe1\u606f\u6570\u636e\u5e93\u4e3aclient\uff0c\u7528\u6237\u8d44\u8d39\u6570\u636e\u8868\u4e3auser_info\uff0c\u8868\u7ed3\u6784\u5982\u4e0b\u6240\u793a\u3002\u8bf7\u4e3a\u8be5\u516c\u53f8\u5236\u5b9a\u5408\u7406\u7684\u5907\u4efd\u7b56\u7565\uff0c\u4f9d\u636e\u6240\u5236\u5b9a\u7684\u7b56\u7565\u5907\u4efd\u6570\u636e\uff0c\u6a21\u62df\u6570\u636e\u4e22\u5931\u8fdb\u884c\u6570\u636e\u6062\u590d\u3002 \u521b\u5efa\u6570\u636e\u53ca\u8868\uff0c\u5f55\u5165\u6570\u636e\uff1a [root@localhost ~]# mysql -uroot -p123456 mysql> show variables like 'character_set_%'; //\u67e5\u770b\u5b57\u7b26\u96c6\u662f\u5426\u652f\u6301\u4e2d\u6587 +--------------------------+----------------------------------+ | Variable_name | Value | +--------------------------+----------------------------------+ | character_set_client | utf8 | | character_set_connection | utf8 | | character_set_database | latin1 | | character_set_filesystem | binary | | character_set_results | utf8 | | character_set_server | latin1 | | character_set_system | utf8 | | character_sets_dir | /usr/local/mysql/share/charsets/ | +--------------------------+----------------------------------+ 8 rows in set (0.01 sec) [root@localhost ~]# vim /etc/my.cnf [mysqld] character_set_server=utf8 [root@localhost ~]# /etc/init.d/mysqld restart mysql> show variables like 'character_set_%'; +--------------------------+----------------------------------+ | Variable_name | Value | +--------------------------+----------------------------------+ | character_set_client | utf8 | | character_set_connection | utf8 | | character_set_database | utf8 | | character_set_filesystem | binary | | character_set_results | utf8 | | character_set_server | utf8 | | character_set_system | utf8 | | character_sets_dir | /usr/local/mysql/share/charsets/ | +--------------------------+----------------------------------+ 8 rows in set (0.01 sec) mysql> create database client; Query OK, 1 row affected (0.00 sec) mysql> use client; Database changed create table user_info(\u8eab\u4efd\u8bc1 int(20),\u59d3\u540d char(20),\u6027\u522b char(2),\u7528\u6237ID\u53f7 int(110),\u8d44\u8d39 int(10)) DEFAULT CHARSET=utf8; insert into user_info values('000000001','\u5b59\u7a7a\u6b66','\u7537','011','100'); insert into user_info values('000000002','\u84dd\u51cc','\u5973','012','98'); insert into user_info values('000000003','\u59dc\u7eb9','\u5973','013','12'); insert into user_info values('000000004','\u5173\u56ed','\u7537','014','38'); insert into user_info values('000000004','\u7f57\u4e2d\u6606','\u7537','015','39'); mysql> select * from user_info; +-----------+-----------+--------+-------------+--------+ | \u8eab\u4efd\u8bc1 | \u59d3\u540d | \u6027\u522b | \u7528\u6237ID\u53f7 | \u8d44\u8d39 | +-----------+-----------+--------+-------------+--------+ | 1 | \u5b59\u7a7a\u6b66 | \u7537 | 11 | 100 | | 2 | \u84dd\u51cc | \u5973 | 12 | 98 | | 3 | \u59dc\u7eb9 | \u5973 | 13 | 12 | | 4 | \u5173\u56ed | \u7537 | 14 | 38 | | 4 | \u7f57\u4e2d\u6606 | \u7537 | 15 | 39 | +-----------+-----------+--------+-------------+--------+ 5 rows in set (0.00 sec) \u5b8c\u6574\u5907\u4efdclient.user_info\u8868\uff1a [root@localhost ~]# mysqldump -uroot -p123456 client user_info > backup/client.user_info-$(date +%Y%m%d).sql \u6a21\u62df\u6570\u636e\u4e22\u5931\u6062\u590d\u6570\u636e\uff1a [root@localhost ~]# mysql -uroot -p123456 -e 'drop table client.user_info;' [root@localhost ~]# mysql -uroot -p123456 -e 'use client; show tables;' [root@localhost ~]# mysql -uroot -p123456 client < backup/client.user_info-20181214.sql [root@localhost ~]# mysql -uroot -p123456 -e 'select * from client.user_info;' +-----------+-----------+--------+-------------+--------+ | \u8eab\u4efd\u8bc1 | \u59d3\u540d | \u6027\u522b | \u7528\u6237ID\u53f7 | \u8d44\u8d39 | +-----------+-----------+--------+-------------+--------+ | 1 | \u5b59\u7a7a\u6b66 | \u7537 | 11 | 100 | | 2 | \u84dd\u51cc | \u5973 | 12 | 98 | | 3 | \u59dc\u7eb9 | \u5973 | 13 | 12 | | 4 | \u5173\u56ed | \u7537 | 14 | 38 | | 4 | \u7f57\u4e2d\u6606 | \u7537 | 15 | 39 | +-----------+-----------+--------+-------------+--------+ \u5b9a\u671f\u5907\u4efd\u6570\u636e\uff1a [root@localhost ~]# which mysqldump /usr/local/mysql/bin/mysqldump [root@localhost ~]# vim /opt/bak_client.sh #!/bin/bash # \u5907\u4efdclient.user_info\u8868 \u811a\u672c /usr/local/mysql/bin/mysqldump -uroot -p123456 client user_info >backup/client.user_info-$(date +%Y%m%d).sql [root@localhost ~]# chmod +x /opt/bak_client.sh [root@localhost ~]# crontab -e 0 0 * * * /opt/bak_client.sh //\u6bcf\u59290:00\u5907\u4efd \u53c2\u8003\u6587\u7ae0 \u00b6 https://satya-dba.blogspot.com/2021/09/percona-xtrabackup-installation.html xtrabackup \u89e3\u538bucloud\u6570\u636e\u5e93\u6587\u7ae0","title":"2 mysql backup docs"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#mysql","text":"\u968f\u7740\u81ea\u52a8\u5316\u529e\u516c\u4e0e\u7535\u5b50\u5546\u52a1\u7684\u4e0d\u65ad\u6269\u5c55\uff0c\u4f01\u4e1a\u5bf9\u4e8e\u4fe1\u606f\u7cfb\u7edf\u7684\u4f9d\u8d56\u6027\u8d8a\u6765\u8d8a\u91cd\u8981\uff0c\u800c\u6570\u636e\u5e93\u5728\u4fe1\u606f\u7cfb\u7edf\u4e2d\u62c5\u4efb\u7740\u975e\u5e38\u91cd\u8981\u7684\u89d2\u8272\u3002\u5c24\u5176\u4e00\u4e9b\u5bf9\u6570\u636e\u5e93\u53ef\u9760\u6027\u8981\u6c42\u975e\u5e38\u9ad8\u7684\u884c\u4e1a\uff0c\u4f8b\u5982\u94f6\u884c\uff0c\u8bc1\u5238\uff0c\u7535\u4fe1\u7b49\uff0c\u5982\u679c\u53d1\u751f\u610f\u5916\u5b95\u673a\u6216\u6570\u636e\u4e22\u5931\uff0c\u5176\u635f\u5931\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002\u4e3a\u6b64\u6570\u636e\u5e93\u7ba1\u7406\u5458\u5fc5\u987b\u9488\u5bf9\u5177\u4f53\u7684\u4e1a\u52a1\u8981\u6c42\u5b9a\u5236\u8be6\u7ec6\u7684\u6570\u636e\u5e93\u5907\u4efd\u4e0e\u707e\u96be\u6062\u590d\u7684\u7b56\u7565\uff0c\u5e76\u901a\u8fc7\u6a21\u62df\u6545\u969c\u5bf9\u6bcf\u79cd\u53ef\u80fd\u7684\u60c5\u51b5\u8fdb\u884c\u4e25\u683c\u7684\u6d4b\u8bd5\u3002\u800c\u4fdd\u969c\u6570\u636e\u7684\u53ef\u9760\u6027\u3002","title":"MySQL\u5b8c\u5168\u5907\u4efd\u4e0e\u6062\u590d"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#_1","text":"\u5907\u4efd\u7684\u4e3b\u8981\u76ee\u7684\u662f\u707e\u96be\u6062\u590d\uff0c\u5907\u4efd\u8fd8\u53ef\u4ee5\u6d4b\u8bd5\u5e94\u7528\uff0c\u56de\u6eda\u6570\u636e\u4fee\u6539\uff0c\u67e5\u8be2\u5386\u53f2\u6570\u636e\uff0c\u5ba1\u8ba1\u7b49\u3002\u6211\u4eec\u5c06\u4ece\u751f\u4ea7\u8fd0\u7ef4\u7684\u89d2\u5ea6\u4e86\u89e3\u5907\u4efd\u6062\u590d\u7684\u5206\u7c7b\u4e0e\u65b9\u6cd5\u3002 \u5728\u4f01\u4e1a\u4e2d\u6570\u636e\u7684\u4ef7\u503c\u81f3\u5173\u91cd\u8981\uff0c\u6570\u636e\u4fdd\u969c\u4e86\u4f01\u4e1a\u4e1a\u52a1\u7684\u8fd0\u884c\uff0c\u56e0\u6b64\u6570\u636e\u7684\u5b89\u5168\u6027\u53ca\u53ef\u9760\u6027\u662f\u8fd0\u7ef4\u7684\u91cd\u4e2d\u4e4b\u91cd\uff0c\u4efb\u4f55\u6570\u636e\u7684\u4e22\u5931\u90fd\u6709\u53ef\u80fd\u4f1a\u5bf9\u4f01\u4e1a\u4ea7\u751f\u4e25\u91cd\u7684\u540e\u679c\u3002\u9020\u6210\u6570\u636e\u4e22\u5931\u7684\u539f\u56e0\u5982\u4e0b\uff1a \u7a0b\u5e8f\u9519\u8bef \u4eba\u4e3a\u9519\u8bef \u6570\u636e\u6cc4\u9732 \u8fd0\u7b97\u5931\u8d25 \u78c1\u76d8\u6545\u969c \u707e\u96be\uff08\u5982\u706b\u707e\u3001\u5730\u9707\uff09","title":"\u4e00\u3001\u6570\u636e\u5907\u4efd\u7684\u91cd\u8981\u6027"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#_2","text":"","title":"\u4e8c\u3001\u6570\u636e\u5e93\u5907\u4efd\u7684\u7c7b\u578b"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#21","text":"\u5907\u4efd\u53ef\u4ee5\u5206\u4e3a\u7269\u7406\u5907\u4efd\u548c\u903b\u8f91\u5907\u4efd\u3002 \u7269\u7406\u5907\u4efd \uff1a\u5bf9\u6570\u636e\u5e93\u64cd\u4f5c\u7cfb\u7edf\u7684\u7269\u7406\u6587\u4ef6\uff08\u5982\u6570\u636e\u6587\u4ef6\u3001\u65e5\u5fd7\u6587\u4ef6\u7b49\uff09\u7684\u5907\u4efd\u3002\u7269\u7406\u5907\u4efd\u53c8\u53ef\u5206\u4e3a\u8131\u673a\u5907\u4efd\uff08\u51b7\u5907\u4efd\uff09\u548c\u8054\u673a\u5907\u4efd\uff08\u70ed\u5907\u4efd\uff09\u3002\u8fd9\u79cd\u7c7b\u578b\u7684\u5907\u4efd\u9002\u7528\u4e8e\u51fa\u73b0\u95ee\u9898\u65f6\u9700\u8981\u5feb\u901f\u6062\u590d\u7684\u5927\u578b\u91cd\u8981\u6570\u636e\u5e93\u3002 \u51b7\u5907\u4efd\uff1a\u662f\u5728\u5173\u95ed\u6570\u636e\u5e93\u7684\u65f6\u5019\u8fdb\u884c\u7684 \u70ed\u5907\u4efd\uff1a\u6570\u636e\u5e93\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\uff0c\u8fd9\u79cd\u5907\u4efd\u65b9\u6cd5\u4f9d\u8d56\u4e8e\u6570\u636e\u5e93\u7684\u65e5\u5fd7\u6587\u4ef6 \u6e29\u5907\u4efd\uff1a\u6570\u636e\u5e93\u9501\u5b9a\u8868\u683c\uff08\u4e0d\u53ef\u5199\u5165\u4f46\u53ef\u8bfb\uff09\u7684\u72b6\u6001\u4e0b\u8fdb\u884c\u7684 \u903b\u8f91\u5907\u4efd \uff1a\u5bf9\u6570\u636e\u5e93\u903b\u8f91\u7ec4\u4ef6\uff08\u5982\u8868\u7b49\u6570\u636e\u5e93\u5bf9\u8c61\uff09\u7684\u5907\u4efd\uff0c\u8868\u793a\u4e3a\u903b\u8f91\u6570\u636e\u5e93\u7ed3\u6784\uff08create database\u3001create table\u7b49\u8bed\u53e5\uff09\u548c\u5185\u5bb9\uff08insert\u8bed\u53e5\u6216\u5206\u5272\u6587\u672c\u6587\u4ef6\uff09\u7684\u4fe1\u606f\u3002\u8fd9\u79cd\u7c7b\u578b\u7684\u5907\u4efd\u9002\u7528\u4e8e\u53ef\u4ee5\u7f16\u8f91\u6570\u636e\u503c\u6216\u8868\u7ed3\u6784\u8f83\u5c0f\u7684\u6570\u636e\u91cf\uff0c\u6216\u8005\u5728\u4e0d\u540c\u673a\u5668\u4f53\u7cfb\u7ed3\u6784\u4e0a\u91cd\u65b0\u521b\u5efa\u6570\u636e\u3002","title":"2.1 \u4ece\u7269\u7406\u4e0e\u903b\u8f91\u7684\u89d2\u5ea6"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#22","text":"\u5907\u4efd\u53ef\u5206\u4e3a\u5b8c\u5168\u5907\u4efd\u3001\u5dee\u5f02\u5907\u4efd\u548c\u589e\u91cf\u5907\u4efd \u5b8c\u5168\u5907\u4efd \uff1a\u6bcf\u6b21\u5bf9\u6570\u636e\u8fdb\u884c\u5b8c\u6574\u7684\u5907\u4efd\uff0c\u5373\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u7684\u5907\u4efd\u3001\u6570\u636e\u5e93\u7ed3\u6784\u548c\u6587\u4ef6\u7ed3\u6784\u7684\u5907\u4efd\uff0c\u4fdd\u5b58\u7684\u662f\u5907\u4efd\u5b8c\u6210\u65f6\u523b\u7684\u6570\u636e\u5e93\u72b6\u6001\uff0c\u662f\u5dee\u5f02\u5907\u4efd\u4e0e\u589e\u91cf\u5907\u4efd\u7684\u57fa\u7840\u3002 \u4f18\u70b9\uff1a\u5907\u4efd\u4e0e\u6062\u590d\u64cd\u4f5c\u7b80\u5355\u65b9\u4fbf \u7f3a\u70b9\uff1a\u6570\u636e\u5b58\u5728\u5927\u91cf\u7684\u91cd\u590d\uff1b\u5360\u7528\u5927\u91cf\u7684\u7a7a\u95f4\uff1b\u5907\u4efd\u4e0e\u6062\u590d\u65f6\u95f4\u957f \u5dee\u5f02\u5907\u4efd \uff1a\u5907\u4efd\u90a3\u4e9b\u81ea\u4ece\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u4e4b\u540e\u88ab\u4fee\u6539\u8fc7\u7684\u6240\u6709\u6587\u4ef6\uff0c\u5907\u4efd\u7684\u65f6\u95f4\u8d77\u70b9\u662f\u4ece\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u8d77\uff0c\u5907\u4efd\u6570\u636e\u91cf\u4f1a\u8d8a\u6765\u8d8a\u5927\u3002\u6062\u590d\u6570\u636e\u65f6\uff0c\u53ea\u9700\u6062\u590d\u4e0a\u6b21\u7684\u5b8c\u5168\u5907\u4efd\u4e0e\u6700\u8fd1\u7684\u4e00\u6b21\u5dee\u5f02\u5907\u4efd\u3002 \u589e\u91cf\u5907\u4efd \uff1a\u53ea\u6709\u90a3\u4e9b\u5728\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u6216\u8005\u589e\u91cf\u5907\u4efd\u540e\u88ab\u4fee\u6539\u7684\u6587\u4ef6\u624d\u4f1a\u88ab\u5907\u4efd\u3002\u4ee5\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u6216\u4e0a\u6b21\u7684\u589e\u91cf\u5907\u4efd\u7684\u65f6\u95f4\u4e3a\u65f6\u95f4\u70b9\uff0c\u4ec5\u5907\u4efd\u8fd9\u4e4b\u95f4\u7684\u6570\u636e\u53d8\u5316\uff0c\u56e0\u800c\u5907\u4efd\u7684\u6570\u636e\u91cf\u5c0f\uff0c\u5360\u7528\u7a7a\u95f4\u5c0f\uff0c\u5907\u4efd\u901f\u5ea6\u5feb\u3002\u4f46\u6062\u590d\u65f6\uff0c\u9700\u8981\u4ece\u4e0a\u4e00\u6b21\u7684\u5b8c\u6574\u5907\u4efd\u8d77\u5230\u6700\u540e\u4e00\u6b21\u589e\u91cf\u5907\u4efd\u4f9d\u6b21\u6062\u590d\uff0c\u5982\u4e2d\u95f4\u67d0\u6b21\u7684\u5907\u4efd\u6570\u636e\u635f\u574f\uff0c\u5c06\u5bfc\u81f4\u6570\u636e\u7684\u4e22\u5931\u3002","title":"2.2 \u4ece\u6570\u636e\u5e93\u7684\u5907\u4efd\u7b56\u7565\u89d2\u5ea6"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#23","text":"MySQL\u6570\u636e\u5e93\u7684\u5907\u4efd\u53ef\u4ee5\u91c7\u7528\u5f88\u591a\u79cd\u65b9\u5f0f\uff0c\u5982\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\uff08\u7269\u7406\u51b7\u5907\u4efd\uff09\uff0c\u4e13\u7528\u5907\u4efd\u5de5\u5177\uff08mysqldump\uff09\uff0c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u589e\u91cf\u5907\u4efd\uff0c\u7b2c\u4e09\u65b9\u5de5\u5177\u5907\u4efd\u7b49\u3002 \u7269\u7406\u5907\u4efd \uff1a\u7269\u7406\u51b7\u5907\u4efd\u65f6\u9700\u8981\u5728\u6570\u636e\u5e93\u5904\u4e8e\u5173\u95ed\u72b6\u6001\u4e0b\uff0c\u80fd\u591f\u8f83\u597d\u7684\u4fdd\u8bc1\u6570\u636e\u5e93\u7684\u5b8c\u6574\u6027\u3002\u7269\u7406\u51b7\u5907\u4efd\u4ee5\u7528\u4e8e\u975e\u6838\u5fc3\u4e1a\u52a1\uff0c\u8fd9\u7c7b\u4e1a\u52a1\u90fd\u5141\u8bb8\u4e2d\u65ad\uff0c\u7269\u7406\u51b7\u5907\u4efd\u7684\u7279\u70b9\u5c31\u662f\u901f\u5ea6\u5feb\uff0c\u6062\u590d\u65f6\u4e5f\u662f\u6700\u4e3a\u7b80\u5355\u7684\uff0c\u901a\u8fc7\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\u5939\uff08/usr/local/mysql/data\uff09\u6765\u5b9e\u73b0\u5907\u4efd\u3002 \u4e13\u7528\u5907\u4efd\u5de5\u5177mysqldump\u6216mysqlhotcopy \uff1amysqldump\u548cmysqlhotcopy\u90fd\u53ef\u4ee5\u505a\u5907\u4efd\u3002mysqldump\u662f\u5ba2\u6237\u7aef\u5e38\u7528\u903b\u8f91\u5907\u4efd\u7a0b\u5e8f\uff0c\u80fd\u591f\u4ea7\u751f\u4e00\u7ec4\u88ab\u6267\u884c\u4ee5\u518d\u73b0\u539f\u59cb\u6570\u636e\u5e93\u5bf9\u8c61\u5b9a\u4e49\u548c\u8868\u6570\u636e\u7684SQL\u8bed\u53e5\u3002\u5b83\u53ef\u4ee5\u8f6c\u50a8\u4e00\u4e2a\u5230\u591a\u4e2aMySQL\u6570\u636e\u5e93\uff0c\u5176\u8fdb\u884c\u5907\u4efd\u6216\u4f20\u8f93\u5230\u8fdc\u7a0bSQL\u670d\u52a1\u5668\u3002mysqldump\u66f4\u4e3a\u901a\u7528\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u5907\u4efd\u5404\u79cd\u8868\u3002mysqlhotcopy\u4ec5\u9002\u7528\u4e8e\u67d0\u4e9b\u5b58\u50a8\u5f15\u64ce\u3002mysqlhotcopy\u662f\u7531Tim Bunce\u6700\u521d\u7f16\u5199\u548c\u8d21\u732e\u7684Perl\u811a\u672c\u3002mysqlhotcopy\u4ec5\u7528\u4e8e\u5907\u4efdMyISAM\u548cARCHIVE\u6570\u636e\u8868\u3002\u53ea\u80fd\u8fd0\u884c\u5728Unix\u6216Linux\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u3002 \u901a\u8fc7\u542f\u7528\u4e8c\u8fdb\u5236\uff08binary log\uff0cbinlog\uff09\u65e5\u5fd7\u8fdb\u884c\u589e\u91cf\u5907\u4efd \uff1aMySQL\u652f\u6301\u589e\u91cf\u5907\u4efd\uff0c\u8fdb\u884c\u589e\u91cf\u5907\u4efd\u65f6\u5fc5\u987b\u542f\u7528\u4e8c\u8fdb\u5236\u65e5\u5fd7\u3002\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u4e3a\u7528\u6237\u63d0\u4f9b\u590d\u5236\u3002\u5bf9\u6267\u884c\u5907\u4efd\u70b9\u540e\u8fdb\u884c\u7684\u6570\u636e\u5e93\u66f4\u6539\u6240\u9700\u7684\u4fe1\u606f\u8fdb\u884c\u5907\u4efd\u3002\u5982\u679c\u8fdb\u884c\u589e\u91cf\u5907\u4efd\uff08\u5305\u542b\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u6216\u589e\u91cf\u5907\u4efd\u4ee5\u6765\u53d1\u751f\u7684\u6570\u636e\u4fee\u6539\uff09\uff0c\u9700\u8981\u5237\u65b0\u4e8c\u8fdb\u5236\u65e5\u5fd7\u3002 \u901a\u8fc7\u7b2c\u4e09\u65b9\u5de5\u5177\u5907\u4efd \uff1aPercona XtraBackup\u662f\u4e00\u4e2a\u514d\u8d39\u7684MySQL\u70ed\u5907\u4efd\u8f6f\u4ef6\uff0c\u652f\u6301\u5728\u7ebf\u5907\u4efdInnodb\u548cXtraDB\uff0c\u4e5f\u53ef\u4ee5\u652f\u6301MySQL\u8868\u5907\u4efd\uff0c\u4e0d\u8fc7MyISAM\u8868\u7684\u5907\u4efd\u8981\u5728\u8868\u9501\u7684\u60c5\u51b5\u8fdb\u884c\u3002 Percona XtraBackup\u4e3b\u8981\u7684\u5de5\u5177\uff1axtrabackup\u3001innobackupex\u3001xbstream xtrabackup\uff1a\u662f\u4e00\u4e2a\u7f16\u8bd1\u4e86\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u53ea\u80fd\u5907\u4efdInnodb/Xtradb\u6570\u636e\u6587\u4ef6 innobackupex\uff1a\u662f\u4e00\u4e2a\u5c01\u88c5\u4e86xtrabackup\u7684Perl\u811a\u672c\uff0c\u9664\u4e86\u53ef\u4ee5\u5907\u4efdInnodb/Xtradb\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u5907\u4efdMyISAM\u3002 xbstream\uff1a\u662f\u4e00\u4e2a\u65b0\u7ec4\u4ef6\uff0c\u80fd\u591f\u5141\u8bb8\u5c06\u6587\u4ef6\u683c\u5f0f\u8f6c\u6362\u6210xbstream\u683c\u5f0f\u6216\u4ecexbstream\u683c\u5f0f\u8f6c\u5230\u6587\u4ef6\u683c\u5f0f\u3002 xtrabackup\u5de5\u5177\u53ef\u4ee5\u5355\u72ec\u4f7f\u7528\uff0c\u4f46\u63a8\u8350\u4f7f\u7528innobackupx\u6765\u8fdb\u884c\u5907\u4efd\uff0c\u56e0\u4e3a\u5176\u672c\u8eab\u5df2\u7ecf\u5305\u542b\u4e86xtrabackup\u7684\u6240\u6709\u529f\u80fd\u3002","title":"2.3 \u5e38\u89c1\u7684\u5907\u4efd\u65b9\u6cd5"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#24-xtrabackup","text":"XtraBackup \u662f\u57fa\u4e8eInnodb\u7684\u707e\u96be\u6062\u590d\u529f\u80fd\u8fdb\u884c\u8bbe\u8ba1\u7684\u3002\u5907\u4efd\u5de5\u5177\u590d\u5236Innodb\u7684\u6570\u636e\u6587\u4ef6\uff0c\u7531\u4e8e\u4e0d\u9501\u8868\uff0c\u8fd9\u6837\u590d\u5236\u51fa\u6765\u7684\u6570\u636e\u5c06\u4e0d\u4e00\u81f4\u3002\u4f46\u662f\uff0cInnodb\u7ef4\u62a4\u4e86\u4e00\u4e2a\u91cd\u8981\u7684\u91cd\u505a\u65e5\u5fd7\uff0c\u5305\u542bInnodb\u6570\u636e\u7684\u6240\u6709\u6539\u52a8\u60c5\u51b5\u3002\u5728XtraBackup\u5907\u4efdInnodb\u7684\u6570\u636e\u540c\u65f6\uff0cXtraBackup\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u7ebf\u7a0b\u7528\u6765\u76d1\u63a7\u91cd\u505a\u65e5\u5fd7\uff0c\u4e00\u65e6\u65e5\u5fd7\u53d1\u751f\u53d8\u5316\uff0c\u5c31\u628a\u53d1\u751f\u53d8\u5316\u7684\u65e5\u5fd7\u6570\u636e\u590d\u5236\u8d70\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u5229\u7528\u91cd\u505a\u65e5\u5fd7\u505a\u707e\u96be\u6062\u590d\u3002 \u4ee5\u4e0a\u662f\u5907\u4efd\u8fc7\u7a0b\u3002\u5982\u679c\u6211\u4eec\u9700\u8981\u6062\u590d\u6570\u636e\uff0c\u5219\u5728\u51c6\u5907\u9636\u6bb5\uff0cXtraBackup\u5c31\u9700\u8981\u4f7f\u7528\u4e4b\u524d\u590d\u5236\u7684\u91cd\u505a\u65e5\u5fd7\u5bf9\u5907\u4efd\u51fa\u6765\u7684Innodb\u6570\u636e\u6587\u4ef6\u8fdb\u884c\u707e\u96be\u6062\u590d\u3002\u6b64\u9636\u6bb5\u5b8c\u6210\u4e4b\u540e\uff0c\u6570\u636e\u5e93\u5c31\u53ef\u4ee5\u8fdb\u884c\u91cd\u5efa\u8fd8\u539f\u4e86\u3002Percona XtraBackup\u5bf9MyISAM\u7684\u590d\u5236\u662f\u6309\u987a\u5e8f\u8fdb\u884c\u7684\uff0c\u5148\u9501\u5b9a\u8868\uff0c\u7136\u540e\u590d\u5236\uff0c\u518d\u89e3\u9501\u8868\u3002 \u6e29\u99a8\u63d0\u793a \u6570\u636e\u5e93\u5907\u4efd\u7b56\u7565\u601d\u8003\uff1f 1.\u516c\u53f8\u6570\u636e\u5e93\u7684\u603b\u6570\u636e\u91cf\u591a\u5927\uff1f 25~30G 2.\u6bcf\u5929\u589e\u957f\u91cf\u591a\u5927\uff1f50M 3.\u5907\u4efd\u7684\u7b56\u7565\uff1f 4.\u5907\u4efd\u6570\u636e\u91cf\uff1f 5.\u5907\u4efd\u7684\u65f6\u957f\uff1f","title":"2.4 XtraBackup\u7684\u5907\u4efd\u4e0e\u6062\u590d"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#mysql_1","text":"MySQL\u6570\u636e\u5e93\u7684\u5b8c\u5168\u5907\u4efd\u53ef\u4ee5\u91c7\u7528\u591a\u79cd\u65b9\u5f0f\uff0c\u7269\u7406\u51b7\u5907\u4efd\u4e00\u822c\u7528tar\u547d\u4ee4\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\u5939\uff08\u6570\u636e\u76ee\u5f55\uff09\uff0c\u800c\u5728\u5907\u4efd\u524d\u9700\u8981\u5148\u505c\u5e93\u3002","title":"\u4e09\u3001MySQL\u5b8c\u5168\u5907\u4efd\u64cd\u4f5c"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#1","text":"\u6e90\u7801\u5305\u7684\u4f4d\u7f6e/usr/local/mysql/data/\uff0crpm\u5305\u7684\u4f4d\u7f6e /var/lib/mysql/ [root@localhost ~]# /etc/init.d/mysqld start Starting MySQL............... SUCCESS! [root@localhost ~]# netstat -lnpt | grep :3306 tcp6 0 0 :::3306 :::* LISTEN 1630/mysqld [root@localhost ~]# mysql -u root -p123456 mysql> create database auth; Query OK, 1 row affected (0.00 sec) mysql> use auth; Database changed mysql> create table user(name char(10) not null,ID int(48)); Query OK, 0 rows affected (0.04 sec) mysql> insert into user values('crushlinux','123'); Query OK, 1 row affected (0.01 sec) mysql> select * from user; +------------+------+ | name | ID | +------------+------+ | crushlinux | 123 | +------------+------+ 1 row in set (0.00 sec) mysql> exit Bye \u505c\u6b62\u6570\u636e\u5e93\uff0c\u8fdb\u884c\u5907\u4efd\u3002 [root@localhost ~]# /etc/init.d/mysqld stop Shutting down MySQL.. SUCCESS! [root@localhost ~]# mkdir backup [root@localhost ~]# tar zcf backup/mysql_all-$(date +%F).tar.gz /usr/local/mysql/data/ tar: Removing leading `/' from member names [root@localhost ~]# ls -l backup/ \u603b\u7528\u91cf 728 -rw-r--r-- 1 root root 742476 12\u6708 14 23:31 mysql_all-2018-12-14.tar.gz \u6a21\u62df\u4e22\u5931: [root@localhost ~]# /etc/init.d/mysqld start Starting MySQL.. SUCCESS! [root@localhost ~]# mysql -uroot -p123456 mysql> drop database auth; Query OK, 1 row affected (0.02 sec) \u6062\u590d\u6570\u636e: [root@localhost ~]# /etc/init.d/mysqld stop Shutting down MySQL.. SUCCESS! [root@localhost ~]# mkdir restore [root@localhost ~]# tar xf backup/mysql_all-2020-04-23.tar.gz -C restore/ [root@localhost ~]# rm -rf /usr/local/mysql/data/* [root@localhost ~]# mv restore/usr/local/mysql/data/* /usr/local/mysql/data/ [root@localhost ~]# /etc/init.d/mysqld start Starting MySQL. SUCCESS! [root@localhost ~]# mysql -uroot -p123456 -e 'select * from auth.user;' mysql: [Warning] Using a password on the command line interface can be insecure. +------------+------+ | name | ID | +------------+------+ | crushlinux | 123 | +------------+------+","title":"1\u3001\u76f4\u63a5\u6253\u5305\u6570\u636e\u5e93\u6587\u4ef6\u5939"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#2mysqldump","text":"MySQL\u81ea\u5e26\u7684\u5907\u4efd\u5de5\u5177mysqldump\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5bf9MySQL\u8fdb\u884c\u5907\u4efd\u3002\u901a\u8fc7\u8be5\u547d\u4ee4\u5de5\u5177\u53ef\u4ee5\u5c06\u6570\u636e\u5e93\u3001\u6570\u636e\u8868\u6216\u5168\u90e8\u7684\u5e93\u5bfc\u51fa\u4e3aSQL\u811a\u672c\uff0c\u4fbf\u4e8e\u8be5\u547d\u4ee4\u5728\u4e0d\u540c\u7248\u672c\u7684MySQL\u670d\u52a1\u5668\u4e0a\u4f7f\u7528\u3002\u4f8b\u5982\uff0c\u5f53\u9700\u8981\u5347\u7ea7MySQL\u670d\u52a1\u5668\u65f6\uff0c\u53ef\u4ee5\u5148\u4f7f\u7528mysqldump\u547d\u4ee4\u5c06\u539f\u6709\u5e93\u4fe1\u606f\u5230\u5bfc\u51fa\uff0c\u7136\u540e\u76f4\u63a5\u5728\u5347\u7ea7\u540e\u7684MySQL\u670d\u52a1\u5668\u4e2d\u5bfc\u5165\u5373\u53ef\u3002","title":"2\u3001\u4f7f\u7528\u4e13\u7528\u5907\u4efd\u5de5\u5177mysqldump"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#1_1","text":"\u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p[\u5bc6\u7801] [\u9009\u9879] --databases [\u6570\u636e\u5e93\u540d] > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 --databases auth > backup/auth-$(date +%Y%m%d).sql mysqldump: [Warning] Using a password on the command line interface can be insecure. [root@localhost ~]# cat backup/auth-20181214.sql","title":"1. \u5bf9\u5355\u4e2a\u5e93\u8fdb\u884c\u5b8c\u5168\u5907\u4efd"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#2","text":"\u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] [\u9009\u9879] --databases \u5e93\u540d1 [\u5e93\u540d2]\u2026 > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 --databases mysql auth > backup/mysql+auth-$(date +%Y%m%d).sql [root@localhost ~]# cat backup/mysql+auth-20181214.sql","title":"2. \u5bf9\u591a\u4e2a\u5e93\u8fdb\u884c\u5b8c\u5168\u5907\u4efd"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#3","text":"\u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] [\u9009\u9879] --opt --all-databases > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 --opt --all-databases > backup/mysql_all.$(date +%Y%m%d).sql [root@localhost ~]# cat backup/mysql_all.20181214.sql //--opt \u52a0\u5feb\u5907\u4efd\u901f\u5ea6\uff0c\u5f53\u5907\u4efd\u6570\u636e\u91cf\u5927\u65f6\u4f7f\u7528 [root@localhost ~]# cat backup/mysql_all.20160505.sql","title":"3. \u5bf9\u6240\u6709\u5e93\u8fdb\u884c\u5b8c\u5168\u5907\u4efd"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#4","text":"\u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] [\u9009\u9879] \u6570\u636e\u5e93\u540d \u8868\u540d > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 auth user > backup/auth_user-$(date +%Y%m%d).sql [root@localhost ~]# cat backup/auth_user-20181214.sql","title":"4. \u5bf9\u8868\u8fdb\u884c\u5b8c\u5168\u5907\u4efd"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#5","text":"\u683c\u5f0f\uff1a mysqldump -u\u7528\u6237\u540d -p [\u5bc6\u7801] -d \u6570\u636e\u5e93\u540d \u8868\u540d > /\u5907\u4efd\u8def\u5f84/\u5907\u4efd\u6587\u4ef6\u540d \u793a\u4f8b\uff1a [root@localhost ~]# mysqldump -uroot -p123456 -d mysql user > backup/desc_mysql_user-$(date +%Y%m%d).sql [root@localhost ~]# cat backup/desc_mysql_user-20181214.sql","title":"5. \u5bf9\u8868\u7ed3\u6784\u7684\u5907\u4efd"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#_3","text":"","title":"\u56db\u3001\u6062\u590d\u6570\u636e\u5e93"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#1-source","text":"\u767b\u5f55\u5230MySQL\u6570\u636e\u5e93\uff0c\u6267\u884csource \u5907\u4efdsql\u811a\u672c\u8def\u5f84 \u793a\u4f8b\uff1a [root@localhost ~]# mysql -uroot -p123456 mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ 6 rows in set (0.00 sec) mysql> drop database auth; Query OK, 1 row affected (0.12 sec) mysql> source backup/auth.20181214.sql mysql> show databases; +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ 6 rows in set (0.00 sec)","title":"1. \u4f7f\u7528source\u547d\u4ee4"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#2-mysql","text":"\u683c\u5f0f\uff1a mysql -u\u7528\u6237\u540d -p [\u5bc6\u7801] < \u5e93\u5907\u4efd\u811a\u672c\u7684\u8def\u5f84 mysql -u\u7528\u6237\u540d -p [\u5bc6\u7801] \u5e93\u540d < \u8868\u5907\u4efd\u811a\u672c\u7684\u8def\u5f84 \u793a\u4f8b\uff1a [root@localhost ~]# mysql -uroot -p123456 -e 'show databases;' +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ [root@localhost ~]# mysql -uroot -p123456 -e 'drop database auth;' [root@localhost ~]# mysql -uroot -p123456 < backup/auth.20181214.sql [root@localhost ~]# mysql -uroot -p123456 -e 'show databases;' +--------------------+ | Database | +--------------------+ | information_schema | | auth | | mysql | | performance_schema | | test | | usr | +--------------------+ [root@localhost ~]# mysql -uroot -p123456 -e 'drop table auth.user;' [root@localhost ~]# mysql -uroot -p123456 auth < backup/auth_user-20181214.sql [root@localhost ~]# mysql -uroot -p123456 -e 'select * from auth.user;' +------------+------+ | name | ID | +------------+------+ | crushlinux | 123 | +------------+------+","title":"2. \u4f7f\u7528mysql\u547d\u4ee4"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#mysql_2","text":"1\u3001\u5b9a\u671f\u5b9e\u65bd\u5907\u4efd\uff0c\u5236\u5b9a\u5907\u4efd\u8ba1\u5212\u6216\u7b56\u7565\uff0c\u5e76\u4e25\u683c\u9075\u5b88\u3002 2\u3001\u9664\u4e86\u8fdb\u884c\u5b8c\u5168\u5907\u4efd\uff0c\u5f00\u542fMySQL\u670d\u52a1\u5668\u7684binlog\u65e5\u5fd7\u529f\u80fd\u662f\u5f88\u91cd\u8981\u7684\uff08\u5b8c\u5168\u5907\u4efd\u52a0\u4e0a\u65e5\u5fd7\uff0c\u53ef\u4ee5\u5bf9MySQL\u8fdb\u884c\u6700\u5927\u5316\u8fd8\u539f\uff09\u3002 3\u3001\u4f7f\u7528\u7edf\u4e00\u548c\u6613\u7406\u89e3\u7684\u5907\u4efd\u540d\u79f0\uff0c\u63a8\u8350\u4f7f\u7528\u5e93\u540d\u6216\u8005\u8868\u540d\u52a0\u4e0a\u65f6\u95f4\u7684\u547d\u540d\u89c4\u5219\uff0c\u5982mysql_user-20181214.sql\uff0c\u4e0d\u8981\u4f7f\u7528backup1\u6216\u8005abc\u4e4b\u7c7b\u6ca1\u6709\u610f\u4e49\u7684\u540d\u5b57\u3002","title":"\u4e94\u3001MySQL\u5907\u4efd\u601d\u8def"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#mysql_3","text":"\u9700\u6c42\u63cf\u8ff0\uff1a \u7528\u6237\u4fe1\u606f\u6570\u636e\u5e93\u4e3aclient\uff0c\u7528\u6237\u8d44\u8d39\u6570\u636e\u8868\u4e3auser_info\uff0c\u8868\u7ed3\u6784\u5982\u4e0b\u6240\u793a\u3002\u8bf7\u4e3a\u8be5\u516c\u53f8\u5236\u5b9a\u5408\u7406\u7684\u5907\u4efd\u7b56\u7565\uff0c\u4f9d\u636e\u6240\u5236\u5b9a\u7684\u7b56\u7565\u5907\u4efd\u6570\u636e\uff0c\u6a21\u62df\u6570\u636e\u4e22\u5931\u8fdb\u884c\u6570\u636e\u6062\u590d\u3002 \u521b\u5efa\u6570\u636e\u53ca\u8868\uff0c\u5f55\u5165\u6570\u636e\uff1a [root@localhost ~]# mysql -uroot -p123456 mysql> show variables like 'character_set_%'; //\u67e5\u770b\u5b57\u7b26\u96c6\u662f\u5426\u652f\u6301\u4e2d\u6587 +--------------------------+----------------------------------+ | Variable_name | Value | +--------------------------+----------------------------------+ | character_set_client | utf8 | | character_set_connection | utf8 | | character_set_database | latin1 | | character_set_filesystem | binary | | character_set_results | utf8 | | character_set_server | latin1 | | character_set_system | utf8 | | character_sets_dir | /usr/local/mysql/share/charsets/ | +--------------------------+----------------------------------+ 8 rows in set (0.01 sec) [root@localhost ~]# vim /etc/my.cnf [mysqld] character_set_server=utf8 [root@localhost ~]# /etc/init.d/mysqld restart mysql> show variables like 'character_set_%'; +--------------------------+----------------------------------+ | Variable_name | Value | +--------------------------+----------------------------------+ | character_set_client | utf8 | | character_set_connection | utf8 | | character_set_database | utf8 | | character_set_filesystem | binary | | character_set_results | utf8 | | character_set_server | utf8 | | character_set_system | utf8 | | character_sets_dir | /usr/local/mysql/share/charsets/ | +--------------------------+----------------------------------+ 8 rows in set (0.01 sec) mysql> create database client; Query OK, 1 row affected (0.00 sec) mysql> use client; Database changed create table user_info(\u8eab\u4efd\u8bc1 int(20),\u59d3\u540d char(20),\u6027\u522b char(2),\u7528\u6237ID\u53f7 int(110),\u8d44\u8d39 int(10)) DEFAULT CHARSET=utf8; insert into user_info values('000000001','\u5b59\u7a7a\u6b66','\u7537','011','100'); insert into user_info values('000000002','\u84dd\u51cc','\u5973','012','98'); insert into user_info values('000000003','\u59dc\u7eb9','\u5973','013','12'); insert into user_info values('000000004','\u5173\u56ed','\u7537','014','38'); insert into user_info values('000000004','\u7f57\u4e2d\u6606','\u7537','015','39'); mysql> select * from user_info; +-----------+-----------+--------+-------------+--------+ | \u8eab\u4efd\u8bc1 | \u59d3\u540d | \u6027\u522b | \u7528\u6237ID\u53f7 | \u8d44\u8d39 | +-----------+-----------+--------+-------------+--------+ | 1 | \u5b59\u7a7a\u6b66 | \u7537 | 11 | 100 | | 2 | \u84dd\u51cc | \u5973 | 12 | 98 | | 3 | \u59dc\u7eb9 | \u5973 | 13 | 12 | | 4 | \u5173\u56ed | \u7537 | 14 | 38 | | 4 | \u7f57\u4e2d\u6606 | \u7537 | 15 | 39 | +-----------+-----------+--------+-------------+--------+ 5 rows in set (0.00 sec) \u5b8c\u6574\u5907\u4efdclient.user_info\u8868\uff1a [root@localhost ~]# mysqldump -uroot -p123456 client user_info > backup/client.user_info-$(date +%Y%m%d).sql \u6a21\u62df\u6570\u636e\u4e22\u5931\u6062\u590d\u6570\u636e\uff1a [root@localhost ~]# mysql -uroot -p123456 -e 'drop table client.user_info;' [root@localhost ~]# mysql -uroot -p123456 -e 'use client; show tables;' [root@localhost ~]# mysql -uroot -p123456 client < backup/client.user_info-20181214.sql [root@localhost ~]# mysql -uroot -p123456 -e 'select * from client.user_info;' +-----------+-----------+--------+-------------+--------+ | \u8eab\u4efd\u8bc1 | \u59d3\u540d | \u6027\u522b | \u7528\u6237ID\u53f7 | \u8d44\u8d39 | +-----------+-----------+--------+-------------+--------+ | 1 | \u5b59\u7a7a\u6b66 | \u7537 | 11 | 100 | | 2 | \u84dd\u51cc | \u5973 | 12 | 98 | | 3 | \u59dc\u7eb9 | \u5973 | 13 | 12 | | 4 | \u5173\u56ed | \u7537 | 14 | 38 | | 4 | \u7f57\u4e2d\u6606 | \u7537 | 15 | 39 | +-----------+-----------+--------+-------------+--------+ \u5b9a\u671f\u5907\u4efd\u6570\u636e\uff1a [root@localhost ~]# which mysqldump /usr/local/mysql/bin/mysqldump [root@localhost ~]# vim /opt/bak_client.sh #!/bin/bash # \u5907\u4efdclient.user_info\u8868 \u811a\u672c /usr/local/mysql/bin/mysqldump -uroot -p123456 client user_info >backup/client.user_info-$(date +%Y%m%d).sql [root@localhost ~]# chmod +x /opt/bak_client.sh [root@localhost ~]# crontab -e 0 0 * * * /opt/bak_client.sh //\u6bcf\u59290:00\u5907\u4efd","title":"\u516d\u3001MySQL\u5b8c\u5168\u5907\u4efd\u6848\u4f8b"},{"location":"3.k8s/mysql-operator/2-mysql-backup-docs/#_4","text":"https://satya-dba.blogspot.com/2021/09/percona-xtrabackup-installation.html xtrabackup \u89e3\u538bucloud\u6570\u636e\u5e93\u6587\u7ae0","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"3.k8s/mysql-operator/3-mysql-backup-error-docs/","text":"\u524d\u8a00 \u00b6 \u6211\u4eec\u672c\u5730\u73af\u5883\u9047\u5230\u4e00\u6b21ceph\u96c6\u7fa4\u6302\u4e86\uff0c\u5bfc\u81f4\u6574\u4e2a\u73af\u5883\u7684\u6570\u636e\u4e22\u5931\uff0c\u5f53\u7136mysql\u6570\u636e\u4e5f\u4e22\u4e86\u3002\u6211\u4eec\u7684\u5f00\u59cb\u5e0c\u671b\u6211\u4eec\u5c06\u7ebf\u4e0a\u7684\u6570\u636e\u6062\u590d\u5230\u672c\u5730\u3002\u4e3a\u6b64\u8bb0\u5f55\u4e00\u4e0b\u6062\u590d\u6570\u636e\u9047\u5230\u7684\u4e00\u4e9b\u5934\u5927\u7684\u95ee\u9898\u3002 **\u6062\u590d\u6b65\u9aa4: ** \u9996\u5148\u9700\u8981\u4e0b\u8f7d\u4e0b\u6765\u6570\u636e\u5e93\u7684\u5907\u4efd\u6570\u636e\uff0c\u4f46\u662f\u6211\u53d1\u73b0\u5982\u679c\u4eceucloud\u5c06\u5907\u4efd\u6587\u4ef6\u4e0b\u8f7d\u89e3\u538b\u8fd8\u539f\u540e\u65e0\u6cd5\u542f\u52a8\u6570\u636e\u5e93 \u5373\u4f7f\u8fd8\u539f\u6210\u529f\uff0c show tables; \u65e0\u6cd5\u67e5\u770b\u4efb\u4f55\u8868 \u5c1d\u8bd5\u4f7f\u7528mysqldump \u6765\u5907\u4efd\u6574\u4e2a\u5e93\uff0c\u7136\u540e\u8fdb\u884c\u8fd8\u539f(\u4f46\u662f\u51fa\u73b0\u4e86\u4e00\u4e2a\u95ee\u9898)\uff0c Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don't want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. mysqldump: Error 2020: Got packet bigger than max_allowed_packet bytes when dumping table job_metrics at row: 87 \u5728\u5f53\u524d /etc/mysql/conf.d/ \u76ee\u5f55\u4e0b cat mysqldump.cnf [mysqldump] quick quote-names max_allowed_packet = 16G # \u672c\u8eab\u7684\u5355\u4f4d\u662fM\uff0c\u8be5\u6210G\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 \u8fd8\u539f: source /backup-path/xxx.sql \u6587\u7ae0\u53c2\u8003 \u00b6 https://www.starcto.com/mysql/315.html","title":"3 mysql backup error docs"},{"location":"3.k8s/mysql-operator/3-mysql-backup-error-docs/#_1","text":"\u6211\u4eec\u672c\u5730\u73af\u5883\u9047\u5230\u4e00\u6b21ceph\u96c6\u7fa4\u6302\u4e86\uff0c\u5bfc\u81f4\u6574\u4e2a\u73af\u5883\u7684\u6570\u636e\u4e22\u5931\uff0c\u5f53\u7136mysql\u6570\u636e\u4e5f\u4e22\u4e86\u3002\u6211\u4eec\u7684\u5f00\u59cb\u5e0c\u671b\u6211\u4eec\u5c06\u7ebf\u4e0a\u7684\u6570\u636e\u6062\u590d\u5230\u672c\u5730\u3002\u4e3a\u6b64\u8bb0\u5f55\u4e00\u4e0b\u6062\u590d\u6570\u636e\u9047\u5230\u7684\u4e00\u4e9b\u5934\u5927\u7684\u95ee\u9898\u3002 **\u6062\u590d\u6b65\u9aa4: ** \u9996\u5148\u9700\u8981\u4e0b\u8f7d\u4e0b\u6765\u6570\u636e\u5e93\u7684\u5907\u4efd\u6570\u636e\uff0c\u4f46\u662f\u6211\u53d1\u73b0\u5982\u679c\u4eceucloud\u5c06\u5907\u4efd\u6587\u4ef6\u4e0b\u8f7d\u89e3\u538b\u8fd8\u539f\u540e\u65e0\u6cd5\u542f\u52a8\u6570\u636e\u5e93 \u5373\u4f7f\u8fd8\u539f\u6210\u529f\uff0c show tables; \u65e0\u6cd5\u67e5\u770b\u4efb\u4f55\u8868 \u5c1d\u8bd5\u4f7f\u7528mysqldump \u6765\u5907\u4efd\u6574\u4e2a\u5e93\uff0c\u7136\u540e\u8fdb\u884c\u8fd8\u539f(\u4f46\u662f\u51fa\u73b0\u4e86\u4e00\u4e2a\u95ee\u9898)\uff0c Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don't want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. mysqldump: Error 2020: Got packet bigger than max_allowed_packet bytes when dumping table job_metrics at row: 87 \u5728\u5f53\u524d /etc/mysql/conf.d/ \u76ee\u5f55\u4e0b cat mysqldump.cnf [mysqldump] quick quote-names max_allowed_packet = 16G # \u672c\u8eab\u7684\u5355\u4f4d\u662fM\uff0c\u8be5\u6210G\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 \u8fd8\u539f: source /backup-path/xxx.sql","title":"\u524d\u8a00"},{"location":"3.k8s/mysql-operator/3-mysql-backup-error-docs/#_2","text":"https://www.starcto.com/mysql/315.html","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"3.k8s/other/k8s-ca-docs/","text":"\u5229\u7528kubeadm\u90e8\u7f72\u7684k8s\u96c6\u7fa4\uff0c\u6bcf\u8fc7\u4e00\u5e74\u8bc1\u4e66\u5c31\u4f1a\u8fc7\u671f\uff0c\u4e3a\u4e86\u89e3\u51b3\u8bc1\u4e66\u8fc7\u671f\u7684\u95ee\u9898\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u89e3\u51b3: \u4e3b\u8981\u9488\u5bf9\u7684k8s v1.15\u4e4b\u524d\u7684\u7248\u672c\u548cv1.15\u4e4b\u540e\u7684\u7248\u672c \u66f4\u65b0\u8bc1\u4e66 \u00b6 \u4f7f\u7528 kubeadm \u5b89\u88c5 kubernetes \u96c6\u7fa4\u975e\u5e38\u65b9\u4fbf\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u6bd4\u8f83\u70e6\u4eba\u7684\u95ee\u9898\u5c31\u662f\u9ed8\u8ba4\u7684\u8bc1\u4e66\u6709\u6548\u671f\u53ea\u6709\u4e00\u5e74\u65f6\u95f4\uff0c\u6240\u4ee5\u9700\u8981\u8003\u8651\u8bc1\u4e66\u5347\u7ea7\u7684\u95ee\u9898\uff0c\u672c\u6587\u7684\u6f14\u793a\u96c6\u7fa4\u7248\u672c\u4e3a v1.16.2 \u7248\u672c\uff0c\u4e0d\u4fdd\u8bc1\u4e0b\u9762\u7684\u64cd\u4f5c\u5bf9\u5176\u4ed6\u7248\u672c\u4e5f\u9002\u7528\uff0c\u5728\u64cd\u4f5c\u4e4b\u524d\u4e00\u5b9a\u8981\u5148\u5bf9\u8bc1\u4e66\u76ee\u5f55\u8fdb\u884c\u5907\u4efd\uff0c\u9632\u6b62\u64cd\u4f5c\u9519\u8bef\u8fdb\u884c\u56de\u6eda\u3002\u672c\u6587\u4e3b\u8981\u4ecb\u7ecd\u4e24\u79cd\u65b9\u5f0f\u6765\u66f4\u65b0\u96c6\u7fa4\u8bc1\u4e66\u3002 \u624b\u52a8\u66f4\u65b0\u8bc1\u4e66 \u00b6 \u7531 kubeadm \u751f\u6210\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u9ed8\u8ba4\u53ea\u6709\u4e00\u5e74\u6709\u6548\u671f\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 check-expiration \u547d\u4ee4\u6765\u68c0\u67e5\u8bc1\u4e66\u662f\u5426\u8fc7\u671f\uff1a $ kubeadm alpha certs check-expiration CERTIFICATE EXPIRES RESIDUAL TIME EXTERNALLY MANAGED admin.conf Nov 07, 2020 11:59 UTC 73d no apiserver Nov 07, 2020 11:59 UTC 73d no apiserver-etcd-client Nov 07, 2020 11:59 UTC 73d no apiserver-kubelet-client Nov 07, 2020 11:59 UTC 73d no controller-manager.conf Nov 07, 2020 11:59 UTC 73d no etcd-healthcheck-client Nov 07, 2020 11:59 UTC 73d no etcd-peer Nov 07, 2020 11:59 UTC 73d no etcd-server Nov 07, 2020 11:59 UTC 73d no front-proxy-client Nov 07, 2020 11:59 UTC 73d no scheduler.conf Nov 07, 2020 11:59 UTC 73d no \u8be5\u547d\u4ee4\u663e\u793a /etc/kubernetes/pki \u6587\u4ef6\u5939\u4e2d\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u4ee5\u53ca kubeadm \u4f7f\u7528\u7684 KUBECONFIG \u6587\u4ef6\u4e2d\u5d4c\u5165\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u7684\u5230\u671f\u65f6\u95f4/\u5269\u4f59\u65f6\u95f4\u3002 \u6e29\u99a8\u63d0\u793a \u5f88\u660e\u663e\u8fd8\u5269\u4f5973\u5929\u5c31\u8fc7\u671f\u4e86\uff0ckubeadm \u4e0d\u80fd\u7ba1\u7406\u7531\u5916\u90e8 CA \u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u5982\u679c\u662f\u5916\u90e8\u5f97\u8bc1\u4e66\uff0c\u9700\u8981\u81ea\u5df1\u624b\u52a8\u53bb\u7ba1\u7406\u8bc1\u4e66\u7684\u66f4\u65b0 \u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6267\u884c kubeadm alpha certs renew all \u7136\u540e\u9700\u8981\u5c06 /etc/kubernetes/manifests/ \u632a\u8d70\uff0c\u6bd4\u5982\u91cd\u547d\u540d\u4e3a manifests.1 20 \u79d2\u4ee5\u4e0a\uff0c\u7b49\u5f85 static pod \u5168\u90e8\u90fd\u5173\u95ed\u4e86\uff0c\u7136\u540e\u91cd\u547d\u540d\u56de\u6765\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u5c31\u662f\u5f3a\u8feb\u6240\u6709\u7684 static pod \u91cd\u542f\uff0c\u5b98\u7f51\u6587\u6863\u5c31\u662f\u8fd9\u4e48\u5efa\u8bae\u64cd\u4f5c\u7684 \u5c31\u66f4\u65b0\u5b8c\u6210\u4e86\u3002\u5982\u679c\u8003\u8651\u539f\u6765\u8bc1\u4e66\u5907\u4efd\uff0c\u5c31\u9700\u8981\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\u3002 $ mkdir /etc/kubernetes.bak $ cp -r /etc/kubernetes/pki/ /etc/kubernetes.bak $ cp /etc/kubernetes/*.conf /etc/kubernetes.bak $ cp -r /var/lib/etcd /var/lib/etcd.bak //\u5907\u4efdetcd \u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u8bc1\u4e66\u5c31\u4e00\u952e\u66f4\u65b0\u5b8c\u6210\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u67e5\u770b\u4e0a\u9762\u7684\u8bc1\u4e66\u53ef\u4ee5\u770b\u5230\u8fc7\u671f\u65f6\u95f4\u5df2\u7ecf\u662f\u4e00\u5e74\u540e\u7684\u65f6\u95f4\u4e86\u3002 $ kubeadm alpha certs check-expiration CERTIFICATE EXPIRES RESIDUAL TIME EXTERNALLY MANAGED admin.conf Aug 26, 2021 03:47 UTC 364d no apiserver Aug 26, 2021 03:47 UTC 364d no apiserver-etcd-client Aug 26, 2021 03:47 UTC 364d no apiserver-kubelet-client Aug 26, 2021 03:47 UTC 364d no controller-manager.conf Aug 26, 2021 03:47 UTC 364d no etcd-healthcheck-client Aug 26, 2021 03:47 UTC 364d no etcd-peer Aug 26, 2021 03:47 UTC 364d no etcd-server Aug 26, 2021 03:47 UTC 364d no front-proxy-client Aug 26, 2021 03:47 UTC 364d no scheduler.conf Aug 26, 2021 03:47 UTC 364d no \u4ee5\u4e0a\u5c31\u662f\u8bc1\u4e66\u66f4\u65b0\u7684\u65b9\u6cd5\uff0c\u5982\u679c\u662fv15\u4ee5\u4e0a\u7684\u7248\u672c\u3002\u53ef\u4ee5\u901a\u8fc7\u6267\u884c kubeadm certs check-expiration \u6765\u67e5\u770b\u8bc1\u4e66\u662f\u5426\u8fc7\u671f\u3002\u53ea\u4e0d\u8fc7\u66f4\u65b0\u7684\u547d\u4ee4\u6539\u4e3a\u4e86 kubeadm certs renew all .","title":"kubernetes \u5904\u7406k8s\u8bc1\u4e66\u8fc7\u671f"},{"location":"3.k8s/other/k8s-ca-docs/#_1","text":"\u4f7f\u7528 kubeadm \u5b89\u88c5 kubernetes \u96c6\u7fa4\u975e\u5e38\u65b9\u4fbf\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u6bd4\u8f83\u70e6\u4eba\u7684\u95ee\u9898\u5c31\u662f\u9ed8\u8ba4\u7684\u8bc1\u4e66\u6709\u6548\u671f\u53ea\u6709\u4e00\u5e74\u65f6\u95f4\uff0c\u6240\u4ee5\u9700\u8981\u8003\u8651\u8bc1\u4e66\u5347\u7ea7\u7684\u95ee\u9898\uff0c\u672c\u6587\u7684\u6f14\u793a\u96c6\u7fa4\u7248\u672c\u4e3a v1.16.2 \u7248\u672c\uff0c\u4e0d\u4fdd\u8bc1\u4e0b\u9762\u7684\u64cd\u4f5c\u5bf9\u5176\u4ed6\u7248\u672c\u4e5f\u9002\u7528\uff0c\u5728\u64cd\u4f5c\u4e4b\u524d\u4e00\u5b9a\u8981\u5148\u5bf9\u8bc1\u4e66\u76ee\u5f55\u8fdb\u884c\u5907\u4efd\uff0c\u9632\u6b62\u64cd\u4f5c\u9519\u8bef\u8fdb\u884c\u56de\u6eda\u3002\u672c\u6587\u4e3b\u8981\u4ecb\u7ecd\u4e24\u79cd\u65b9\u5f0f\u6765\u66f4\u65b0\u96c6\u7fa4\u8bc1\u4e66\u3002","title":"\u66f4\u65b0\u8bc1\u4e66"},{"location":"3.k8s/other/k8s-ca-docs/#_2","text":"\u7531 kubeadm \u751f\u6210\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u9ed8\u8ba4\u53ea\u6709\u4e00\u5e74\u6709\u6548\u671f\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 check-expiration \u547d\u4ee4\u6765\u68c0\u67e5\u8bc1\u4e66\u662f\u5426\u8fc7\u671f\uff1a $ kubeadm alpha certs check-expiration CERTIFICATE EXPIRES RESIDUAL TIME EXTERNALLY MANAGED admin.conf Nov 07, 2020 11:59 UTC 73d no apiserver Nov 07, 2020 11:59 UTC 73d no apiserver-etcd-client Nov 07, 2020 11:59 UTC 73d no apiserver-kubelet-client Nov 07, 2020 11:59 UTC 73d no controller-manager.conf Nov 07, 2020 11:59 UTC 73d no etcd-healthcheck-client Nov 07, 2020 11:59 UTC 73d no etcd-peer Nov 07, 2020 11:59 UTC 73d no etcd-server Nov 07, 2020 11:59 UTC 73d no front-proxy-client Nov 07, 2020 11:59 UTC 73d no scheduler.conf Nov 07, 2020 11:59 UTC 73d no \u8be5\u547d\u4ee4\u663e\u793a /etc/kubernetes/pki \u6587\u4ef6\u5939\u4e2d\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u4ee5\u53ca kubeadm \u4f7f\u7528\u7684 KUBECONFIG \u6587\u4ef6\u4e2d\u5d4c\u5165\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u7684\u5230\u671f\u65f6\u95f4/\u5269\u4f59\u65f6\u95f4\u3002 \u6e29\u99a8\u63d0\u793a \u5f88\u660e\u663e\u8fd8\u5269\u4f5973\u5929\u5c31\u8fc7\u671f\u4e86\uff0ckubeadm \u4e0d\u80fd\u7ba1\u7406\u7531\u5916\u90e8 CA \u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u5982\u679c\u662f\u5916\u90e8\u5f97\u8bc1\u4e66\uff0c\u9700\u8981\u81ea\u5df1\u624b\u52a8\u53bb\u7ba1\u7406\u8bc1\u4e66\u7684\u66f4\u65b0 \u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6267\u884c kubeadm alpha certs renew all \u7136\u540e\u9700\u8981\u5c06 /etc/kubernetes/manifests/ \u632a\u8d70\uff0c\u6bd4\u5982\u91cd\u547d\u540d\u4e3a manifests.1 20 \u79d2\u4ee5\u4e0a\uff0c\u7b49\u5f85 static pod \u5168\u90e8\u90fd\u5173\u95ed\u4e86\uff0c\u7136\u540e\u91cd\u547d\u540d\u56de\u6765\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u5c31\u662f\u5f3a\u8feb\u6240\u6709\u7684 static pod \u91cd\u542f\uff0c\u5b98\u7f51\u6587\u6863\u5c31\u662f\u8fd9\u4e48\u5efa\u8bae\u64cd\u4f5c\u7684 \u5c31\u66f4\u65b0\u5b8c\u6210\u4e86\u3002\u5982\u679c\u8003\u8651\u539f\u6765\u8bc1\u4e66\u5907\u4efd\uff0c\u5c31\u9700\u8981\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\u3002 $ mkdir /etc/kubernetes.bak $ cp -r /etc/kubernetes/pki/ /etc/kubernetes.bak $ cp /etc/kubernetes/*.conf /etc/kubernetes.bak $ cp -r /var/lib/etcd /var/lib/etcd.bak //\u5907\u4efdetcd \u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u8bc1\u4e66\u5c31\u4e00\u952e\u66f4\u65b0\u5b8c\u6210\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u67e5\u770b\u4e0a\u9762\u7684\u8bc1\u4e66\u53ef\u4ee5\u770b\u5230\u8fc7\u671f\u65f6\u95f4\u5df2\u7ecf\u662f\u4e00\u5e74\u540e\u7684\u65f6\u95f4\u4e86\u3002 $ kubeadm alpha certs check-expiration CERTIFICATE EXPIRES RESIDUAL TIME EXTERNALLY MANAGED admin.conf Aug 26, 2021 03:47 UTC 364d no apiserver Aug 26, 2021 03:47 UTC 364d no apiserver-etcd-client Aug 26, 2021 03:47 UTC 364d no apiserver-kubelet-client Aug 26, 2021 03:47 UTC 364d no controller-manager.conf Aug 26, 2021 03:47 UTC 364d no etcd-healthcheck-client Aug 26, 2021 03:47 UTC 364d no etcd-peer Aug 26, 2021 03:47 UTC 364d no etcd-server Aug 26, 2021 03:47 UTC 364d no front-proxy-client Aug 26, 2021 03:47 UTC 364d no scheduler.conf Aug 26, 2021 03:47 UTC 364d no \u4ee5\u4e0a\u5c31\u662f\u8bc1\u4e66\u66f4\u65b0\u7684\u65b9\u6cd5\uff0c\u5982\u679c\u662fv15\u4ee5\u4e0a\u7684\u7248\u672c\u3002\u53ef\u4ee5\u901a\u8fc7\u6267\u884c kubeadm certs check-expiration \u6765\u67e5\u770b\u8bc1\u4e66\u662f\u5426\u8fc7\u671f\u3002\u53ea\u4e0d\u8fc7\u66f4\u65b0\u7684\u547d\u4ee4\u6539\u4e3a\u4e86 kubeadm certs renew all .","title":"\u624b\u52a8\u66f4\u65b0\u8bc1\u4e66"},{"location":"3.k8s/ui/rancher-update-docs/","text":"\u8fd9\u4e00\u7ae0\u7684\u5185\u5bb9\u4e3b\u8981\u6765\u8bb2\u8bb2rancher\u5982\u4f55\u5347\u7ea7\uff0c\u6211\u4eec\u73af\u5883\u4e2dk8s\u7684\u7248\u672c\u8f83\u9ad8\uff0c\u6240\u4ee5\u56e0\u6b64\u9700\u8981\u5bf9rancher\u7248\u672c\u5347\u7ea7\u4f7f\u7528gitops\u3002 \u5907\u4efd\u4e00\u4e0b\u65e7\u7684values\u6587\u4ef6 $ helm get values rancher > rancher-values.yanl $ cat rancher-values.yaml USER-SUPPLIED VALUES: hostname: rancher.openbayes.com ingress: tls: source: letsEncrypt letsEncrypt: email: dev@openbayes.com \u5907\u4efdrancher-webhook\u7684values\u6587\u4ef6 $ helm get values rancher-webhook > rancher-webhook-values.yaml $ cat rancher-webhook-values.yaml USER-SUPPLIED VALUES: capi: enabled: true global: cattle: systemDefaultRegistry: \"\" mcm: enabled: true Rancher \u5347\u7ea7 helm upgrade --install rancher rancher-stable/rancher \\ --namespace cattle-system -f rancher-values.yaml --version 2.7.5 \u53c2\u8003\u6587\u7ae0 \u00b6 \u5b98\u65b9\u5347\u7ea7\u6587\u6863 rancher \u7248\u672c\u517c\u5bb9\u6027\u6587\u7ae0","title":"kubernetes Rancher \u5347\u7ea7"},{"location":"3.k8s/ui/rancher-update-docs/#_1","text":"\u5b98\u65b9\u5347\u7ea7\u6587\u6863 rancher \u7248\u672c\u517c\u5bb9\u6027\u6587\u7ae0","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"3.k8s/yaml/yaml/","text":"\u8d44\u6e90\u6e05\u5355 \u00b6 YAML \u662f \"YAML Ain't a Markup Language\"\uff08YAML \u4e0d\u662f\u4e00\u79cd\u6807\u8bb0\u8bed\u8a00\uff09\u7684\u9012\u5f52\u7f29\u5199\u3002AML \u7684\u8bed\u6cd5\u548c\u5176\u4ed6\u9ad8\u7ea7\u8bed\u8a00\u7c7b\u4f3c\uff0c\u5e76\u4e14\u53ef\u4ee5\u7b80\u5355\u8868\u8fbe\u6e05\u5355\u3001\u6563\u5217\u8868\uff0c\u6807\u91cf\u7b49\u6570\u636e\u5f62\u6001\u3002\u5b83\u4f7f\u7528\u7a7a\u767d\u7b26\u53f7\u7f29\u8fdb\u548c\u5927\u91cf\u4f9d\u8d56\u5916\u89c2\u7684\u7279\u8272\uff0c\u7279\u522b\u9002\u5408\u7528\u6765\u8868\u8fbe\u6216\u7f16\u8f91\u6570\u636e\u7ed3\u6784\u3001\u5404\u79cd\u914d\u7f6e\u6587\u4ef6\u3001\u503e\u5370\u8c03\u8bd5\u5185\u5bb9\u3001\u6587\u4ef6\u5927\u7eb2\uff08\u4f8b\u5982\uff1a\u8bb8\u591a\u7535\u5b50\u90ae\u4ef6\u6807\u9898\u683c\u5f0f\u548cYAML\u975e\u5e38\u63a5\u8fd1\uff09\u3002 YAML \u7684\u914d\u7f6e\u6587\u4ef6\u540e\u7f00\u4e3a .yml\uff0c\u5982\uff1arunoob.yml \u3002 \u57fa\u672c\u8bed\u6cd5\uff1a \u5927\u5c0f\u5199\u654f\u611f \u4f7f\u7528\u7f29\u8fdb\u8868\u793a\u5c42\u7ea7\u5173\u7cfb \u7f29\u8fdb\u4e0d\u5141\u8bb8\u4f7f\u7528tab\uff0c\u53ea\u5141\u8bb8\u7a7a\u683c \u7f29\u8fdb\u7684\u7a7a\u683c\u6570\u4e0d\u91cd\u8981\uff0c\u53ea\u8981\u76f8\u540c\u5c42\u7ea7\u7684\u5143\u7d20\u5de6\u5bf9\u9f50\u5373\u53ef '#'\u8868\u793a\u6ce8\u91ca \u8d44\u6e90\u6e05\u5355\u89e3\u8bfb \u00b6 apiVersion : v1 #\u7248\u672c\u53f7\uff0c\u4f8b\u5982v1 kind : Pod #\u8d44\u6e90\u7c7b\u578b\uff0c\u5982Pod metadata : #\u5143\u6570\u636e name : string # Pod\u540d\u5b57 namespace : string # Pod\u6240\u5c5e\u7684\u547d\u540d\u7a7a\u95f4 labels : #\u81ea\u5b9a\u4e49\u6807\u7b7e - name : string #\u81ea\u5b9a\u4e49\u6807\u7b7e\u540d\u5b57 annotations : #\u81ea\u5b9a\u4e49\u6ce8\u91ca\u5217\u8868 - name : string spec : # Pod\u4e2d\u5bb9\u5668\u7684\u8be6\u7ec6\u5b9a\u4e49 containers : # Pod\u4e2d\u5bb9\u5668\u5217\u8868 - name : string #\u5bb9\u5668\u540d\u79f0 image : string #\u5bb9\u5668\u7684\u955c\u50cf\u540d\u79f0 imagePullPolicy : [ Always | Never | IfNotPresent ] #\u83b7\u53d6\u955c\u50cf\u7684\u7b56\u7565 Alawys\u8868\u793a\u4e0b\u8f7d\u955c\u50cf IfnotPresent\u8868\u793a\u4f18\u5148\u4f7f\u7528\u672c\u5730\u955c\u50cf\uff0c\u5426\u5219\u4e0b\u8f7d\u955c\u50cf\uff0cNerver\u8868\u793a\u4ec5\u4f7f\u7528\u672c\u5730\u955c\u50cf command : [ string ] #\u5bb9\u5668\u7684\u542f\u52a8\u547d\u4ee4\u5217\u8868\uff0c\u5982\u4e0d\u6307\u5b9a\uff0c\u4f7f\u7528\u6253\u5305\u65f6\u4f7f\u7528\u7684\u542f\u52a8\u547d\u4ee4 args : [ string ] #\u5bb9\u5668\u7684\u542f\u52a8\u547d\u4ee4\u53c2\u6570\u5217\u8868 workingDir : string #\u5bb9\u5668\u7684\u5de5\u4f5c\u76ee\u5f55 volumeMounts : #\u6302\u8f7d\u5230\u5bb9\u5668\u5185\u90e8\u7684\u5b58\u50a8\u5377\u914d\u7f6e - name : string #\u5f15\u7528pod\u5b9a\u4e49\u7684\u5171\u4eab\u5b58\u50a8\u5377\u7684\u540d\u79f0\uff0c\u9700\u7528volumes[]\u90e8\u5206\u5b9a\u4e49\u7684\u7684\u5377\u540d mountPath : string #\u5b58\u50a8\u5377\u5728\u5bb9\u5668\u5185mount\u7684\u7edd\u5bf9\u8def\u5f84\uff0c\u5e94\u5c11\u4e8e512\u5b57\u7b26 readOnly : boolean #\u662f\u5426\u4e3a\u53ea\u8bfb\u6a21\u5f0f ports : # \u9700\u8981\u66b4\u9732\u7684\u7aef\u53e3\u5e93\u53f7 - name : string # \u7aef\u53e3\u53f7\u540d\u79f0 containerPort : int #\u5bb9\u5668\u9700\u8981\u76d1\u542c\u7684\u7aef\u53e3\u53f7 hostPort : int #\u5bb9\u5668\u6240\u5728\u4e3b\u673a\u9700\u8981\u76d1\u542c\u7684\u7aef\u53e3\u53f7\uff0c\u9ed8\u8ba4\u4e0eContainer\u76f8\u540c protocol : string #\u7aef\u53e3\u534f\u8bae\uff0c\u652f\u6301TCP\u548cUDP\uff0c\u9ed8\u8ba4TCP env : #\u5bb9\u5668\u8fd0\u884c\u524d\u9700\u8bbe\u7f6e\u7684\u73af\u5883\u53d8\u91cf\u5217\u8868 - name : string #\u73af\u5883\u53d8\u91cf\u540d\u79f0 value : string #\u73af\u5883\u53d8\u91cf\u7684\u503c resources : #\u8d44\u6e90\u9650\u5236\u548c\u8bf7\u6c42\u7684\u8bbe\u7f6e limits : #\u8d44\u6e90\u9650\u5236\u7684\u8bbe\u7f6e cpu : string #cpu\u7684\u9650\u5236\uff0c\u5355\u4f4d\u4e3acore\u6570 memory : string #\u5185\u5b58\u9650\u5236\uff0c\u5355\u4f4d\u53ef\u4ee5\u4e3aMib/Gib requests : #\u8d44\u6e90\u8bf7\u6c42\u7684\u8bbe\u7f6e cpu : string #cpu\u8bf7\u6c42\uff0c\u5bb9\u5668\u542f\u52a8\u7684\u521d\u59cb\u53ef\u7528\u6570\u91cf memory : string #\u5185\u5b58\u8bf7\u6c42\uff0c\u5bb9\u5668\u542f\u52a8\u7684\u521d\u59cb\u53ef\u7528\u5185\u5b58 livenessProbe : #\u5bf9Pod\u5185\u4e2a\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u7684\u8bbe\u7f6e\uff0c\u5f53\u63a2\u6d4b\u65e0\u54cd\u5e94\u51e0\u6b21\u540e\u5c06\u81ea\u52a8\u91cd\u542f\u8be5\u5bb9\u5668\uff0c\u68c0\u67e5\u65b9\u6cd5\u6709exec\u3001httpGet\u548ctcpSocket\uff0c\u5bf9\u4e00\u4e2a\u5bb9\u5668\u53ea\u9700\u8bbe\u7f6e\u5176\u4e2d\u4e00\u79cd\u65b9\u6cd5\u5373\u53ef exec : #\u5bf9Pod\u5bb9\u5668\u5185\u68c0\u67e5\u65b9\u5f0f\u8bbe\u7f6e\u4e3aexec\u65b9\u5f0f command : [ string ] #exec\u65b9\u5f0f\u9700\u8981\u5236\u5b9a\u7684\u547d\u4ee4\u6216\u811a\u672c httpGet : #\u5bf9Pod\u5185\u4e2a\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u65b9\u6cd5\u8bbe\u7f6e\u4e3aHttpGet\uff0c\u9700\u8981\u5236\u5b9aPath\u3001port path : string port : number host : string scheme : string HttpHeaders : - name : string value : string tcpSocket : #\u5bf9Pod\u5185\u4e2a\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\u8bbe\u7f6e\u4e3atcpSocket\u65b9\u5f0f port : number initialDelaySeconds : 0 #\u5bb9\u5668\u542f\u52a8\u5b8c\u6210\u540e\u9996\u6b21\u63a2\u6d4b\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\u4e3a\u79d2 timeoutSeconds : 0 #\u5bf9\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u63a2\u6d4b\u7b49\u5f85\u54cd\u5e94\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u5355\u4f4d\u79d2\uff0c\u9ed8\u8ba41\u79d2 periodSeconds : 0 #\u5bf9\u5bb9\u5668\u76d1\u63a7\u68c0\u67e5\u7684\u5b9a\u671f\u63a2\u6d4b\u65f6\u95f4\u8bbe\u7f6e\uff0c\u5355\u4f4d\u79d2\uff0c\u9ed8\u8ba410\u79d2\u4e00\u6b21 successThreshold : 0 failureThreshold : 0 securityContext : privileged:false restartPolicy : [ Always | Never | OnFailure ] #Pod\u7684\u91cd\u542f\u7b56\u7565\uff0cAlways\u8868\u793a\u4e00\u65e6\u4e0d\u7ba1\u4ee5\u4f55\u79cd\u65b9\u5f0f\u7ec8\u6b62\u8fd0\u884c\uff0ckubelet\u90fd\u5c06\u91cd\u542f\uff0cOnFailure\u8868\u793a\u53ea\u6709Pod\u4ee5\u975e0\u9000\u51fa\u7801\u9000\u51fa\u624d\u91cd\u542f\uff0cNerver\u8868\u793a\u4e0d\u518d\u91cd\u542f\u8be5Pod nodeSelector : obeject #\u8bbe\u7f6eNodeSelector\u8868\u793a\u5c06\u8be5Pod\u8c03\u5ea6\u5230\u5305\u542b\u8fd9\u4e2alabel\u7684node\u4e0a\uff0c\u4ee5key\uff1avalue\u7684\u683c\u5f0f\u6307\u5b9a imagePullSecrets : #Pull\u955c\u50cf\u65f6\u4f7f\u7528\u7684secret\u540d\u79f0\uff0c\u4ee5key\uff1asecretkey\u683c\u5f0f\u6307\u5b9a - name : string hostNetwork:false #\u662f\u5426\u4f7f\u7528\u4e3b\u673a\u7f51\u7edc\u6a21\u5f0f\uff0c\u9ed8\u8ba4\u4e3afalse\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u8868\u793a\u4f7f\u7528\u5bbf\u4e3b\u673a\u7f51\u7edc volumes : #\u5728\u8be5pod\u4e0a\u5b9a\u4e49\u5171\u4eab\u5b58\u50a8\u5377\u5217\u8868 - name : string #\u5171\u4eab\u5b58\u50a8\u5377\u540d\u79f0 \uff08volumes\u7c7b\u578b\u6709\u5f88\u591a\u79cd\uff09 emptyDir : {} #\u7c7b\u578b\u4e3aemtyDir\u7684\u5b58\u50a8\u5377\uff0c\u4e0ePod\u540c\u751f\u547d\u5468\u671f\u7684\u4e00\u4e2a\u4e34\u65f6\u76ee\u5f55\u3002\u4e3a\u7a7a\u503c hostPath : string #\u7c7b\u578b\u4e3ahostPath\u7684\u5b58\u50a8\u5377\uff0c\u8868\u793a\u6302\u8f7dPod\u6240\u5728\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55 path : string #Pod\u6240\u5728\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55\uff0c\u5c06\u88ab\u7528\u4e8e\u540c\u671f\u4e2dmount\u7684\u76ee\u5f55 secret : #\u7c7b\u578b\u4e3asecret\u7684\u5b58\u50a8\u5377\uff0c\u6302\u8f7d\u96c6\u7fa4\u4e0e\u5b9a\u4e49\u7684secre\u5bf9\u8c61\u5230\u5bb9\u5668\u5185\u90e8 scretname : string items : - key : string path : string configMap : #\u7c7b\u578b\u4e3aconfigMap\u7684\u5b58\u50a8\u5377\uff0c\u6302\u8f7d\u9884\u5b9a\u4e49\u7684configMap\u5bf9\u8c61\u5230\u5bb9\u5668\u5185\u90e8 name : string items : - key : string path : string API\u548ckubernetes\u7684\u5bf9\u5e94\u5173\u7cfb rancher\u751f\u4ea7\u6848\u4f8bYaml \u00b6 ####\u542f\u52a8docker#### eval PROJECT_ID='$'$k8s_group if [ $ms_group == 'center' ] then replicas=1 else replicas=1 fi /opt/rancher/rancher context switch $PROJECT_ID cat <<EOF | /opt/rancher/rancher kubectl apply -f - apiVersion : apps/v1 # \u8868\u793aapi\u7248\u672c\uff0cv1 kind : Deployment # kind\u8868\u793a\u8d44\u6e90\u7c7b\u578b\uff0c\u8fd9\u91cc\u662fDeployment metadata : # \u5143\u6570\u636e labels : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name name : $server_name # \u670d\u52a1\u540d namespace : $name_space # \u547d\u540d\u7a7a\u95f4 spec : replicas : $replicas Pod\u4e2d\u5bb9\u5668\u7684\u8be6\u7ec6\u5b9a\u4e49 selector : matchLabels : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name template : metadata : labels : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name spec : imagePullSecrets : - name : old-harbor # \u955c\u50cf \u4ed3\u5e93\u540d restartPolicy : Always containers : - image : $harbor_addr/$name_space/$image_name:$image_tag # \u5bb9\u5668\u7684\u955c\u50cf\u540d imagePullPolicy : Always readinessProbe : failureThreshold : 60 initialDelaySeconds : 5 periodSeconds : 5 successThreshold : 1 tcpSocket : port : $NodePort # \u7aef\u53e3\u66b4\u9732\u65b9\u5f0f timeoutSeconds : 1 livenessProbe : failureThreshold : 3 initialDelaySeconds : 300 periodSeconds : 2 successThreshold : 1 tcpSocket : port : $NodePort timeoutSeconds : 1 env : - name : CSProjFile value : $csproj_file - name : FOR_GODS_SAKE_PLEASE_REDEPLOY value : \"`date +%s`\" name : $server_name ports : - containerPort : $NodePort resources : requests : memory : $memory args : [ \"bash\" , \"-c\" , \"dotnet /opt/$csproj_file/$csproj_file.dll --serviceName $server_name \\ --webApiServiceAddress http://0.0.0.0:$NodePort --zkConfigServer $zk_configserver \\ --zkAppRole $zk_approle --runScope $run_scope --msGroup $ms_group \\ --KPversion 2 --psapp v2 --ser protobuf \\ --zkTimeOut 15000 --mcTimeOut 30000 --Cors *.xxxxx.net \\ --trace kafka --webApiHelp off $other_parameters\" ] # localtime volumeMounts : - mountPath : /etc/localtime name : localtime readOnly : true volumes : - hostPath : path : /etc/localtime type : \"\" name : localtime --- apiVersion : v1 kind : Service metadata : name : $server_name namespace : $name_space spec : type : NodePort ports : - name : default nodePort : $NodePort port : $NodePort protocol : TCP targetPort : $NodePort selector : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name EOF ** jenkins\u4f20\u6570** \u00b6 \u8fd9\u91ccJenkins\u4f5c\u4e3a\u4e0a\u7ea7\u9879\u76ee\uff0c\u5b9a\u4e49\u53d8\u91cf\u4e3a\u4e0b\u7ea7\u9879\u76ee\u4f20\u9012\u53c2\u6570 image_name = accountwebapiserver name_space = webapi server_name = account csproj_file = AccountWebAPIServer zk_approle = Common-AccountWebApi Controller = account run_scope = Core991 ms_group = $ms_group zk_configserver = w1.confandsa.zk.group.hex.com:2181,w2.confandsa.zk.group.hex.com:2181,w3.confandsa.zk.group.hex.com:2181 image_tag = $image_tag memory = 1Gi maxmemory = 2 .2Gi NodePort = 32037 k8s_group = $k8s_group other_parameters = --UrlPrefix tms-zw4 \u7b2c\u4e00\u4e2a\u7b80\u5355\u7684\u5bb9\u5668\u5316\u793a\u4f8b\uff1a \u00b6 $ cat nginx-deploy.yaml apiVersion : apps/v1 kind : Deployment metadata : name : nginx-yyds namespace : web spec : selector : matchLabels : app : nginx replicas : 2 template : metadata : labels : app : nginx spec : containers : - name : nginx image : nginx:latest ports : - containerPort : 80 \u8fd0\u884cYaml\u6587\u4ef6 k apply -f nginx-deploy.yaml \u67e5\u770bpod\u7684\u72b6\u6001 $ k get pod NAME READY STATUS RESTARTS AGE nginx-yyds-585449566-76hgr 1 /1 Running 0 47m nginx-yyds-585449566-vzwkw 1 /1 Running 0 47m \u5e38\u7528\u7684\u7ba1\u7406\u547d\u4ee4\uff1a \u00b6 \u67e5\u770b\u63a7\u5236\u5668 $ k get deploy NAME READY UP-TO-DATE AVAILABLE AGE nginx-yyds 2 /2 2 2 51m \u67e5\u770bpod\u7684\u8be6\u7ec6\u4fe1\u606f $ k get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-yyds-585449566-76hgr 1 /1 Running 0 53m 10 .42.2.130 node1 <none> <none> nginx-yyds-585449566-vzwkw 1 /1 Running 0 53m 10 .42.1.127 node0 <none> <none \u901a\u8fc7\u6807\u7b7e\u6765\u67e5\u627epod $ k get pod -l app = nginx NAME READY STATUS RESTARTS AGE nginx-yyds-585449566-76hgr 1 /1 Running 0 56m nginx-yyds-585449566-vzwkw 1 /1 Running 0 56m $ k describe pod nginx-yyds-585449566-76hgr Name: nginx-yyds-585449566-76hgr Namespace: web Priority: 0 Node: node1/192.168.0.151 Start Time: Tue, 23 Aug 2022 15 :46:16 +0800 Labels: app = nginx pod-template-hash = 585449566 Annotations: <none> Status: Running IP: 10 .42.2.130 IPs: IP: 10 .42.2.130 Controlled By: ReplicaSet/nginx-yyds-585449566 Containers: nginx: Container ID: docker://7994248f600aa93444272eff8092938c866a5648db1126545d28635d41251b51 Image: nginx:latest Image ID: docker-pullable://nginx@sha256:dc29f133a33a1d6311807f3b88134000ce67318a40517b1060b929b84b0bbea0 Port: 80 /TCP Host Port: 0 /TCP State: Running Started: Tue, 23 Aug 2022 15 :48:42 +0800 Ready: True Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rf7j8 ( ro ) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: kube-api-access-rf7j8: Type: Projected ( a volume that contains injected data from multiple sources ) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op = Exists for 300s node.kubernetes.io/unreachable:NoExecute op = Exists for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 58m default-scheduler Successfully assigned web/nginx-yyds-585449566-76hgr to node1 Normal Pulling 58m kubelet Pulling image \"nginx:latest\" Normal Pulled 55m kubelet Successfully pulled image \"nginx:latest\" in 2m24.557367751s Normal Created 55m kubelet Created container nginx Normal Started 55m kubelet Started container nginx \u901a\u8fc7explain\u6765\u67e5\u770bYaml\u6587\u4ef6\u5199\u6cd5 $ k explain","title":"kubernetes \u8d44\u6e90\u6e05\u5355"},{"location":"3.k8s/yaml/yaml/#_1","text":"YAML \u662f \"YAML Ain't a Markup Language\"\uff08YAML \u4e0d\u662f\u4e00\u79cd\u6807\u8bb0\u8bed\u8a00\uff09\u7684\u9012\u5f52\u7f29\u5199\u3002AML \u7684\u8bed\u6cd5\u548c\u5176\u4ed6\u9ad8\u7ea7\u8bed\u8a00\u7c7b\u4f3c\uff0c\u5e76\u4e14\u53ef\u4ee5\u7b80\u5355\u8868\u8fbe\u6e05\u5355\u3001\u6563\u5217\u8868\uff0c\u6807\u91cf\u7b49\u6570\u636e\u5f62\u6001\u3002\u5b83\u4f7f\u7528\u7a7a\u767d\u7b26\u53f7\u7f29\u8fdb\u548c\u5927\u91cf\u4f9d\u8d56\u5916\u89c2\u7684\u7279\u8272\uff0c\u7279\u522b\u9002\u5408\u7528\u6765\u8868\u8fbe\u6216\u7f16\u8f91\u6570\u636e\u7ed3\u6784\u3001\u5404\u79cd\u914d\u7f6e\u6587\u4ef6\u3001\u503e\u5370\u8c03\u8bd5\u5185\u5bb9\u3001\u6587\u4ef6\u5927\u7eb2\uff08\u4f8b\u5982\uff1a\u8bb8\u591a\u7535\u5b50\u90ae\u4ef6\u6807\u9898\u683c\u5f0f\u548cYAML\u975e\u5e38\u63a5\u8fd1\uff09\u3002 YAML \u7684\u914d\u7f6e\u6587\u4ef6\u540e\u7f00\u4e3a .yml\uff0c\u5982\uff1arunoob.yml \u3002 \u57fa\u672c\u8bed\u6cd5\uff1a \u5927\u5c0f\u5199\u654f\u611f \u4f7f\u7528\u7f29\u8fdb\u8868\u793a\u5c42\u7ea7\u5173\u7cfb \u7f29\u8fdb\u4e0d\u5141\u8bb8\u4f7f\u7528tab\uff0c\u53ea\u5141\u8bb8\u7a7a\u683c \u7f29\u8fdb\u7684\u7a7a\u683c\u6570\u4e0d\u91cd\u8981\uff0c\u53ea\u8981\u76f8\u540c\u5c42\u7ea7\u7684\u5143\u7d20\u5de6\u5bf9\u9f50\u5373\u53ef '#'\u8868\u793a\u6ce8\u91ca","title":"\u8d44\u6e90\u6e05\u5355"},{"location":"3.k8s/yaml/yaml/#_2","text":"apiVersion : v1 #\u7248\u672c\u53f7\uff0c\u4f8b\u5982v1 kind : Pod #\u8d44\u6e90\u7c7b\u578b\uff0c\u5982Pod metadata : #\u5143\u6570\u636e name : string # Pod\u540d\u5b57 namespace : string # Pod\u6240\u5c5e\u7684\u547d\u540d\u7a7a\u95f4 labels : #\u81ea\u5b9a\u4e49\u6807\u7b7e - name : string #\u81ea\u5b9a\u4e49\u6807\u7b7e\u540d\u5b57 annotations : #\u81ea\u5b9a\u4e49\u6ce8\u91ca\u5217\u8868 - name : string spec : # Pod\u4e2d\u5bb9\u5668\u7684\u8be6\u7ec6\u5b9a\u4e49 containers : # Pod\u4e2d\u5bb9\u5668\u5217\u8868 - name : string #\u5bb9\u5668\u540d\u79f0 image : string #\u5bb9\u5668\u7684\u955c\u50cf\u540d\u79f0 imagePullPolicy : [ Always | Never | IfNotPresent ] #\u83b7\u53d6\u955c\u50cf\u7684\u7b56\u7565 Alawys\u8868\u793a\u4e0b\u8f7d\u955c\u50cf IfnotPresent\u8868\u793a\u4f18\u5148\u4f7f\u7528\u672c\u5730\u955c\u50cf\uff0c\u5426\u5219\u4e0b\u8f7d\u955c\u50cf\uff0cNerver\u8868\u793a\u4ec5\u4f7f\u7528\u672c\u5730\u955c\u50cf command : [ string ] #\u5bb9\u5668\u7684\u542f\u52a8\u547d\u4ee4\u5217\u8868\uff0c\u5982\u4e0d\u6307\u5b9a\uff0c\u4f7f\u7528\u6253\u5305\u65f6\u4f7f\u7528\u7684\u542f\u52a8\u547d\u4ee4 args : [ string ] #\u5bb9\u5668\u7684\u542f\u52a8\u547d\u4ee4\u53c2\u6570\u5217\u8868 workingDir : string #\u5bb9\u5668\u7684\u5de5\u4f5c\u76ee\u5f55 volumeMounts : #\u6302\u8f7d\u5230\u5bb9\u5668\u5185\u90e8\u7684\u5b58\u50a8\u5377\u914d\u7f6e - name : string #\u5f15\u7528pod\u5b9a\u4e49\u7684\u5171\u4eab\u5b58\u50a8\u5377\u7684\u540d\u79f0\uff0c\u9700\u7528volumes[]\u90e8\u5206\u5b9a\u4e49\u7684\u7684\u5377\u540d mountPath : string #\u5b58\u50a8\u5377\u5728\u5bb9\u5668\u5185mount\u7684\u7edd\u5bf9\u8def\u5f84\uff0c\u5e94\u5c11\u4e8e512\u5b57\u7b26 readOnly : boolean #\u662f\u5426\u4e3a\u53ea\u8bfb\u6a21\u5f0f ports : # \u9700\u8981\u66b4\u9732\u7684\u7aef\u53e3\u5e93\u53f7 - name : string # \u7aef\u53e3\u53f7\u540d\u79f0 containerPort : int #\u5bb9\u5668\u9700\u8981\u76d1\u542c\u7684\u7aef\u53e3\u53f7 hostPort : int #\u5bb9\u5668\u6240\u5728\u4e3b\u673a\u9700\u8981\u76d1\u542c\u7684\u7aef\u53e3\u53f7\uff0c\u9ed8\u8ba4\u4e0eContainer\u76f8\u540c protocol : string #\u7aef\u53e3\u534f\u8bae\uff0c\u652f\u6301TCP\u548cUDP\uff0c\u9ed8\u8ba4TCP env : #\u5bb9\u5668\u8fd0\u884c\u524d\u9700\u8bbe\u7f6e\u7684\u73af\u5883\u53d8\u91cf\u5217\u8868 - name : string #\u73af\u5883\u53d8\u91cf\u540d\u79f0 value : string #\u73af\u5883\u53d8\u91cf\u7684\u503c resources : #\u8d44\u6e90\u9650\u5236\u548c\u8bf7\u6c42\u7684\u8bbe\u7f6e limits : #\u8d44\u6e90\u9650\u5236\u7684\u8bbe\u7f6e cpu : string #cpu\u7684\u9650\u5236\uff0c\u5355\u4f4d\u4e3acore\u6570 memory : string #\u5185\u5b58\u9650\u5236\uff0c\u5355\u4f4d\u53ef\u4ee5\u4e3aMib/Gib requests : #\u8d44\u6e90\u8bf7\u6c42\u7684\u8bbe\u7f6e cpu : string #cpu\u8bf7\u6c42\uff0c\u5bb9\u5668\u542f\u52a8\u7684\u521d\u59cb\u53ef\u7528\u6570\u91cf memory : string #\u5185\u5b58\u8bf7\u6c42\uff0c\u5bb9\u5668\u542f\u52a8\u7684\u521d\u59cb\u53ef\u7528\u5185\u5b58 livenessProbe : #\u5bf9Pod\u5185\u4e2a\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u7684\u8bbe\u7f6e\uff0c\u5f53\u63a2\u6d4b\u65e0\u54cd\u5e94\u51e0\u6b21\u540e\u5c06\u81ea\u52a8\u91cd\u542f\u8be5\u5bb9\u5668\uff0c\u68c0\u67e5\u65b9\u6cd5\u6709exec\u3001httpGet\u548ctcpSocket\uff0c\u5bf9\u4e00\u4e2a\u5bb9\u5668\u53ea\u9700\u8bbe\u7f6e\u5176\u4e2d\u4e00\u79cd\u65b9\u6cd5\u5373\u53ef exec : #\u5bf9Pod\u5bb9\u5668\u5185\u68c0\u67e5\u65b9\u5f0f\u8bbe\u7f6e\u4e3aexec\u65b9\u5f0f command : [ string ] #exec\u65b9\u5f0f\u9700\u8981\u5236\u5b9a\u7684\u547d\u4ee4\u6216\u811a\u672c httpGet : #\u5bf9Pod\u5185\u4e2a\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u65b9\u6cd5\u8bbe\u7f6e\u4e3aHttpGet\uff0c\u9700\u8981\u5236\u5b9aPath\u3001port path : string port : number host : string scheme : string HttpHeaders : - name : string value : string tcpSocket : #\u5bf9Pod\u5185\u4e2a\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u65b9\u5f0f\u8bbe\u7f6e\u4e3atcpSocket\u65b9\u5f0f port : number initialDelaySeconds : 0 #\u5bb9\u5668\u542f\u52a8\u5b8c\u6210\u540e\u9996\u6b21\u63a2\u6d4b\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\u4e3a\u79d2 timeoutSeconds : 0 #\u5bf9\u5bb9\u5668\u5065\u5eb7\u68c0\u67e5\u63a2\u6d4b\u7b49\u5f85\u54cd\u5e94\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u5355\u4f4d\u79d2\uff0c\u9ed8\u8ba41\u79d2 periodSeconds : 0 #\u5bf9\u5bb9\u5668\u76d1\u63a7\u68c0\u67e5\u7684\u5b9a\u671f\u63a2\u6d4b\u65f6\u95f4\u8bbe\u7f6e\uff0c\u5355\u4f4d\u79d2\uff0c\u9ed8\u8ba410\u79d2\u4e00\u6b21 successThreshold : 0 failureThreshold : 0 securityContext : privileged:false restartPolicy : [ Always | Never | OnFailure ] #Pod\u7684\u91cd\u542f\u7b56\u7565\uff0cAlways\u8868\u793a\u4e00\u65e6\u4e0d\u7ba1\u4ee5\u4f55\u79cd\u65b9\u5f0f\u7ec8\u6b62\u8fd0\u884c\uff0ckubelet\u90fd\u5c06\u91cd\u542f\uff0cOnFailure\u8868\u793a\u53ea\u6709Pod\u4ee5\u975e0\u9000\u51fa\u7801\u9000\u51fa\u624d\u91cd\u542f\uff0cNerver\u8868\u793a\u4e0d\u518d\u91cd\u542f\u8be5Pod nodeSelector : obeject #\u8bbe\u7f6eNodeSelector\u8868\u793a\u5c06\u8be5Pod\u8c03\u5ea6\u5230\u5305\u542b\u8fd9\u4e2alabel\u7684node\u4e0a\uff0c\u4ee5key\uff1avalue\u7684\u683c\u5f0f\u6307\u5b9a imagePullSecrets : #Pull\u955c\u50cf\u65f6\u4f7f\u7528\u7684secret\u540d\u79f0\uff0c\u4ee5key\uff1asecretkey\u683c\u5f0f\u6307\u5b9a - name : string hostNetwork:false #\u662f\u5426\u4f7f\u7528\u4e3b\u673a\u7f51\u7edc\u6a21\u5f0f\uff0c\u9ed8\u8ba4\u4e3afalse\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u8868\u793a\u4f7f\u7528\u5bbf\u4e3b\u673a\u7f51\u7edc volumes : #\u5728\u8be5pod\u4e0a\u5b9a\u4e49\u5171\u4eab\u5b58\u50a8\u5377\u5217\u8868 - name : string #\u5171\u4eab\u5b58\u50a8\u5377\u540d\u79f0 \uff08volumes\u7c7b\u578b\u6709\u5f88\u591a\u79cd\uff09 emptyDir : {} #\u7c7b\u578b\u4e3aemtyDir\u7684\u5b58\u50a8\u5377\uff0c\u4e0ePod\u540c\u751f\u547d\u5468\u671f\u7684\u4e00\u4e2a\u4e34\u65f6\u76ee\u5f55\u3002\u4e3a\u7a7a\u503c hostPath : string #\u7c7b\u578b\u4e3ahostPath\u7684\u5b58\u50a8\u5377\uff0c\u8868\u793a\u6302\u8f7dPod\u6240\u5728\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55 path : string #Pod\u6240\u5728\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55\uff0c\u5c06\u88ab\u7528\u4e8e\u540c\u671f\u4e2dmount\u7684\u76ee\u5f55 secret : #\u7c7b\u578b\u4e3asecret\u7684\u5b58\u50a8\u5377\uff0c\u6302\u8f7d\u96c6\u7fa4\u4e0e\u5b9a\u4e49\u7684secre\u5bf9\u8c61\u5230\u5bb9\u5668\u5185\u90e8 scretname : string items : - key : string path : string configMap : #\u7c7b\u578b\u4e3aconfigMap\u7684\u5b58\u50a8\u5377\uff0c\u6302\u8f7d\u9884\u5b9a\u4e49\u7684configMap\u5bf9\u8c61\u5230\u5bb9\u5668\u5185\u90e8 name : string items : - key : string path : string API\u548ckubernetes\u7684\u5bf9\u5e94\u5173\u7cfb","title":"\u8d44\u6e90\u6e05\u5355\u89e3\u8bfb"},{"location":"3.k8s/yaml/yaml/#rancheryaml","text":"####\u542f\u52a8docker#### eval PROJECT_ID='$'$k8s_group if [ $ms_group == 'center' ] then replicas=1 else replicas=1 fi /opt/rancher/rancher context switch $PROJECT_ID cat <<EOF | /opt/rancher/rancher kubectl apply -f - apiVersion : apps/v1 # \u8868\u793aapi\u7248\u672c\uff0cv1 kind : Deployment # kind\u8868\u793a\u8d44\u6e90\u7c7b\u578b\uff0c\u8fd9\u91cc\u662fDeployment metadata : # \u5143\u6570\u636e labels : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name name : $server_name # \u670d\u52a1\u540d namespace : $name_space # \u547d\u540d\u7a7a\u95f4 spec : replicas : $replicas Pod\u4e2d\u5bb9\u5668\u7684\u8be6\u7ec6\u5b9a\u4e49 selector : matchLabels : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name template : metadata : labels : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name spec : imagePullSecrets : - name : old-harbor # \u955c\u50cf \u4ed3\u5e93\u540d restartPolicy : Always containers : - image : $harbor_addr/$name_space/$image_name:$image_tag # \u5bb9\u5668\u7684\u955c\u50cf\u540d imagePullPolicy : Always readinessProbe : failureThreshold : 60 initialDelaySeconds : 5 periodSeconds : 5 successThreshold : 1 tcpSocket : port : $NodePort # \u7aef\u53e3\u66b4\u9732\u65b9\u5f0f timeoutSeconds : 1 livenessProbe : failureThreshold : 3 initialDelaySeconds : 300 periodSeconds : 2 successThreshold : 1 tcpSocket : port : $NodePort timeoutSeconds : 1 env : - name : CSProjFile value : $csproj_file - name : FOR_GODS_SAKE_PLEASE_REDEPLOY value : \"`date +%s`\" name : $server_name ports : - containerPort : $NodePort resources : requests : memory : $memory args : [ \"bash\" , \"-c\" , \"dotnet /opt/$csproj_file/$csproj_file.dll --serviceName $server_name \\ --webApiServiceAddress http://0.0.0.0:$NodePort --zkConfigServer $zk_configserver \\ --zkAppRole $zk_approle --runScope $run_scope --msGroup $ms_group \\ --KPversion 2 --psapp v2 --ser protobuf \\ --zkTimeOut 15000 --mcTimeOut 30000 --Cors *.xxxxx.net \\ --trace kafka --webApiHelp off $other_parameters\" ] # localtime volumeMounts : - mountPath : /etc/localtime name : localtime readOnly : true volumes : - hostPath : path : /etc/localtime type : \"\" name : localtime --- apiVersion : v1 kind : Service metadata : name : $server_name namespace : $name_space spec : type : NodePort ports : - name : default nodePort : $NodePort port : $NodePort protocol : TCP targetPort : $NodePort selector : workload.user.cattle.io/workloadselector : deployment-$name_space-$server_name EOF","title":"rancher\u751f\u4ea7\u6848\u4f8bYaml"},{"location":"3.k8s/yaml/yaml/#jenkins","text":"\u8fd9\u91ccJenkins\u4f5c\u4e3a\u4e0a\u7ea7\u9879\u76ee\uff0c\u5b9a\u4e49\u53d8\u91cf\u4e3a\u4e0b\u7ea7\u9879\u76ee\u4f20\u9012\u53c2\u6570 image_name = accountwebapiserver name_space = webapi server_name = account csproj_file = AccountWebAPIServer zk_approle = Common-AccountWebApi Controller = account run_scope = Core991 ms_group = $ms_group zk_configserver = w1.confandsa.zk.group.hex.com:2181,w2.confandsa.zk.group.hex.com:2181,w3.confandsa.zk.group.hex.com:2181 image_tag = $image_tag memory = 1Gi maxmemory = 2 .2Gi NodePort = 32037 k8s_group = $k8s_group other_parameters = --UrlPrefix tms-zw4","title":"** jenkins\u4f20\u6570**"},{"location":"3.k8s/yaml/yaml/#_3","text":"$ cat nginx-deploy.yaml apiVersion : apps/v1 kind : Deployment metadata : name : nginx-yyds namespace : web spec : selector : matchLabels : app : nginx replicas : 2 template : metadata : labels : app : nginx spec : containers : - name : nginx image : nginx:latest ports : - containerPort : 80 \u8fd0\u884cYaml\u6587\u4ef6 k apply -f nginx-deploy.yaml \u67e5\u770bpod\u7684\u72b6\u6001 $ k get pod NAME READY STATUS RESTARTS AGE nginx-yyds-585449566-76hgr 1 /1 Running 0 47m nginx-yyds-585449566-vzwkw 1 /1 Running 0 47m","title":"\u7b2c\u4e00\u4e2a\u7b80\u5355\u7684\u5bb9\u5668\u5316\u793a\u4f8b\uff1a"},{"location":"3.k8s/yaml/yaml/#_4","text":"\u67e5\u770b\u63a7\u5236\u5668 $ k get deploy NAME READY UP-TO-DATE AVAILABLE AGE nginx-yyds 2 /2 2 2 51m \u67e5\u770bpod\u7684\u8be6\u7ec6\u4fe1\u606f $ k get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-yyds-585449566-76hgr 1 /1 Running 0 53m 10 .42.2.130 node1 <none> <none> nginx-yyds-585449566-vzwkw 1 /1 Running 0 53m 10 .42.1.127 node0 <none> <none \u901a\u8fc7\u6807\u7b7e\u6765\u67e5\u627epod $ k get pod -l app = nginx NAME READY STATUS RESTARTS AGE nginx-yyds-585449566-76hgr 1 /1 Running 0 56m nginx-yyds-585449566-vzwkw 1 /1 Running 0 56m $ k describe pod nginx-yyds-585449566-76hgr Name: nginx-yyds-585449566-76hgr Namespace: web Priority: 0 Node: node1/192.168.0.151 Start Time: Tue, 23 Aug 2022 15 :46:16 +0800 Labels: app = nginx pod-template-hash = 585449566 Annotations: <none> Status: Running IP: 10 .42.2.130 IPs: IP: 10 .42.2.130 Controlled By: ReplicaSet/nginx-yyds-585449566 Containers: nginx: Container ID: docker://7994248f600aa93444272eff8092938c866a5648db1126545d28635d41251b51 Image: nginx:latest Image ID: docker-pullable://nginx@sha256:dc29f133a33a1d6311807f3b88134000ce67318a40517b1060b929b84b0bbea0 Port: 80 /TCP Host Port: 0 /TCP State: Running Started: Tue, 23 Aug 2022 15 :48:42 +0800 Ready: True Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rf7j8 ( ro ) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: kube-api-access-rf7j8: Type: Projected ( a volume that contains injected data from multiple sources ) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op = Exists for 300s node.kubernetes.io/unreachable:NoExecute op = Exists for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 58m default-scheduler Successfully assigned web/nginx-yyds-585449566-76hgr to node1 Normal Pulling 58m kubelet Pulling image \"nginx:latest\" Normal Pulled 55m kubelet Successfully pulled image \"nginx:latest\" in 2m24.557367751s Normal Created 55m kubelet Created container nginx Normal Started 55m kubelet Started container nginx \u901a\u8fc7explain\u6765\u67e5\u770bYaml\u6587\u4ef6\u5199\u6cd5 $ k explain","title":"\u5e38\u7528\u7684\u7ba1\u7406\u547d\u4ee4\uff1a"},{"location":"5.Storage/5-dev-docs/","text":"\u95ee\u9898\u63cf\u8ff0 \u00b6 dev \u73af\u5883\u56e0\u4e3a\u78c1\u76d8\u51fa\u73b0\u95ee\u9898\u5bfc\u81f4\u5b58\u50a8\u4e0d\u53ef\u7528,\u63d0\u51fa\u4e0d\u53ef\u7528\u78c1\u76d8,\u52a0\u5165\u65b0\u78c1\u76d8\u65e0\u6cd5\u52a0\u5165 \u95ee\u9898\u539f\u56e0 \u00b6 \u78c1\u76d8\u574f\u6389\u5177\u4f53\u4e0d\u6e05\u695a\u539f\u56e0,\u65b0\u52a0\u5165 osd \u65e0\u6cd5\u52a0\u5165 rook-ceph \u4e3b\u8981\u539f\u56e0\u6709\u4ee5\u4e0b\u51e0\u4e2a: \u4f7f\u7528 ceph \u539f\u751f\u65b9\u5f0f\u624b\u52a8\u8e22\u51fa osd,\u6709\u4e9b\u4fe1\u606f\u6b8b\u7559. \u62a5\u9519\u663e\u793a: stderr: Error EEXIST: entity osd.6 exists but key does not match operator \u65e0\u6cd5\u52a0\u5165 osd,\u4f46\u662f\u88f8\u8bbe\u5907\u5df2\u7ecf\u5b58\u5728 ceph \u76f8\u5173\u7684\u4fe1\u606f. \u4ece\u56fe\u53ef\u4ee5\u770b\u5230vdd\u5df2\u7ecf\u5b58\u5728 ceph \u76f8\u5173\u7684\u4fe1\u606f,\u4f46\u662f vgs \u5374\u6ca1\u6709\u4ed6\u7684\u8bb0\u5f55,\u4e5f\u6ca1\u6709 osd \u7684 deployment rook-ceph \u62a5\u7a7a\u95f4\u4e0d\u8db3 pg 25 unknown \u89e3\u51b3\u65b9\u6cd5 \u00b6 \u5c06\u6709\u95ee\u9898\u7684 osd-6 \u8e22\u51fa\u53bb rook-ceph \u96c6\u7fa4\u4e2d. \u65b9\u5f0f\u4e00 : ( \u5229\u7528 rook \u63d0\u4f9b\u7684\u811a\u672c\u6765\u5220\u9664,\u63a8\u8350! ) \u811a\u672c\u5730\u5740: https://github.com/rook/rook/blob/v1.6.11/cluster/examples/kubernetes/ceph/osd-purge.yaml \u65b9\u5f0f\u4e8c : \u4f7f\u7528 ceph \u539f\u751f\u65b9\u5f0f\u5220\u9664 [ root@node-1 ceph ] # kubectl scale deploy rook-ceph-osd-1 --relicas=0 [ root@node-1 ceph ] # ceph osd out osd.6 [ root@node-1 ceph ] # ceph osd purge 6 [ root@node-1 ceph ] # ceph osd tree //\u786e\u8ba4\u662f\u5426\u5df2\u7ecf\u5220\u9664 [ root@node-1 ceph ] # ceph auth del osd.6 //\u6ce8\u610f\u53ef\u80fd\u5c31\u662f\u8fd9\u6b65\u9aa4\u6ca1\u6709\u505a\u4ece\u800c\u5bfc\u81f4\u96c6\u7fa4\u52a0\u4e0d\u8fdb\u53bb\u65b0 osd \u6e05\u7406\u78c1\u76d8\u5df2\u7ecf\u88ab ceph \u6807\u8bb0\u4e09\u4e2a osd \u56e0\u4e3a\u914d\u7f6e Ceph \u5b58\u50a8,\u9700\u8981\u88f8\u8bbe\u5907\u6216\u8005\u6ca1\u6709\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbe\u5907,\u5df2\u7ecf\u88ab ceph \u6807\u8bb0\u4e5f\u53ef\u80fd operator \u4f1a\u52a0\u5165 osd \u5931\u8d25,\u6240\u4ee5\u9700\u8981\u6e05\u7406 \u65b9\u5f0f\u4e00: [ root@node-1 ceph ] # dmsetup ls //\u7528\u8fd9\u6761\u547d\u4ee4\u67e5\u51fa\u88ab ceph \u6807\u8bb0\u7684\u8bbe\u5907 [ root@node-1 ceph ] # dmsetup remove vg--test-vg--lv [ root@node-1 ceph ] # sgdisk -Z /dev/vdd \u65b9\u5f0f\u4e8c: DISK = \"/dev/sdX\" # Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean) sgdisk --zap-all $DISK # Wipe a large portion of the beginning of the disk to remove more LVM metadata that may be present dd if = /dev/zero of = \" $DISK \" bs = 1M count = 100 oflag = direct,dsync # SSDs may be better cleaned with blkdiscard instead of dd blkdiscard $DISK # Inform the OS of partition table changes partprobe $DISK \u5220\u9664deploy [root@node-1 ceph]# kubectl delete deployments.apps rook-ceph-osd-6 //\u5220\u9664 osd \u7684 deploy roo-ceph \u7a7a\u95f4\u4e0d\u8db3 \u5c06\u540d\u79f0\u4e3a rook \u8fd9\u4e2a pool \u5220\u9664\u6765\u89e3\u51b3\u7684\u8fd9\u4e2a\u95ee\u9898(\u8fd9\u4e2a pool \u4e0d\u5728\u4f7f\u7528) ceph osd pool delete rook rook --yes-i-really-really-mean-it //\u5220\u9664\u9700\u8c28\u614e \u5982\u679c\u4e0d\u6e05\u695a\u662f\u5177\u4f53\u90a3\u5757\u8bbe\u5907\u51fa\u73b0\u4e86\u95ee\u9898,\u53ef\u4ee5\u901a\u8fc7\u5b98\u65b9\u63d0\u4f9b\u7684\u811a\u672c\u6765\u8fc7\u6ee4\u51fa\u6765 # Get OSD Pods # This uses the example/default cluster name \"rook\" OSD_PODS = $( kubectl get pods --all-namespaces -l \\ app = rook-ceph-osd,rook_cluster = rook-ceph -o jsonpath = '{.items[*].metadata.name}' ) # Find node and drive associations from OSD pods for pod in $( echo ${ OSD_PODS } ) do echo \"Pod: ${ pod } \" echo \"Node: $( kubectl -n rook-ceph get pod ${ pod } -o jsonpath = '{.spec.nodeName}' ) \" kubectl -n rook-ceph exec ${ pod } -- sh -c '\\ for i in /var/lib/ceph/osd/ceph-*; do [ -f ${i}/ready ] || continue echo -ne \"-$(basename ${i}) \" echo $(lsblk -n -o NAME,SIZE ${i}/block 2> /dev/null || \\ findmnt -n -v -o SOURCE,SIZE -T ${i}) $(cat ${i}/type) done | sort -V echo' done \u4fee\u590dpg unknown PG # \u5217\u51fa\u72b6\u6001\u4e3a unkown \u7684 PG, \u7b2c\u4e00\u5217\u4e3a pgid $ ceph pg dump | grep unknown # \u5f3a\u5236\u91cd\u5efa PG\uff0c\u6ce8\uff1a\u4f1a\u4e22\u5931\u6570\u636e\uff0c\u614e\u91cd\u4f7f\u7528 $ ceph osd force-create-pg <pgid> \u6587\u7ae0\u53c2\u8003: https://www.linuxcool.com/dmsetup","title":"ceph \u5b58\u50a8\u4fee\u590d"},{"location":"5.Storage/5-dev-docs/#_1","text":"dev \u73af\u5883\u56e0\u4e3a\u78c1\u76d8\u51fa\u73b0\u95ee\u9898\u5bfc\u81f4\u5b58\u50a8\u4e0d\u53ef\u7528,\u63d0\u51fa\u4e0d\u53ef\u7528\u78c1\u76d8,\u52a0\u5165\u65b0\u78c1\u76d8\u65e0\u6cd5\u52a0\u5165","title":"\u95ee\u9898\u63cf\u8ff0"},{"location":"5.Storage/5-dev-docs/#_2","text":"\u78c1\u76d8\u574f\u6389\u5177\u4f53\u4e0d\u6e05\u695a\u539f\u56e0,\u65b0\u52a0\u5165 osd \u65e0\u6cd5\u52a0\u5165 rook-ceph \u4e3b\u8981\u539f\u56e0\u6709\u4ee5\u4e0b\u51e0\u4e2a: \u4f7f\u7528 ceph \u539f\u751f\u65b9\u5f0f\u624b\u52a8\u8e22\u51fa osd,\u6709\u4e9b\u4fe1\u606f\u6b8b\u7559. \u62a5\u9519\u663e\u793a: stderr: Error EEXIST: entity osd.6 exists but key does not match operator \u65e0\u6cd5\u52a0\u5165 osd,\u4f46\u662f\u88f8\u8bbe\u5907\u5df2\u7ecf\u5b58\u5728 ceph \u76f8\u5173\u7684\u4fe1\u606f. \u4ece\u56fe\u53ef\u4ee5\u770b\u5230vdd\u5df2\u7ecf\u5b58\u5728 ceph \u76f8\u5173\u7684\u4fe1\u606f,\u4f46\u662f vgs \u5374\u6ca1\u6709\u4ed6\u7684\u8bb0\u5f55,\u4e5f\u6ca1\u6709 osd \u7684 deployment rook-ceph \u62a5\u7a7a\u95f4\u4e0d\u8db3 pg 25 unknown","title":"\u95ee\u9898\u539f\u56e0"},{"location":"5.Storage/5-dev-docs/#_3","text":"\u5c06\u6709\u95ee\u9898\u7684 osd-6 \u8e22\u51fa\u53bb rook-ceph \u96c6\u7fa4\u4e2d. \u65b9\u5f0f\u4e00 : ( \u5229\u7528 rook \u63d0\u4f9b\u7684\u811a\u672c\u6765\u5220\u9664,\u63a8\u8350! ) \u811a\u672c\u5730\u5740: https://github.com/rook/rook/blob/v1.6.11/cluster/examples/kubernetes/ceph/osd-purge.yaml \u65b9\u5f0f\u4e8c : \u4f7f\u7528 ceph \u539f\u751f\u65b9\u5f0f\u5220\u9664 [ root@node-1 ceph ] # kubectl scale deploy rook-ceph-osd-1 --relicas=0 [ root@node-1 ceph ] # ceph osd out osd.6 [ root@node-1 ceph ] # ceph osd purge 6 [ root@node-1 ceph ] # ceph osd tree //\u786e\u8ba4\u662f\u5426\u5df2\u7ecf\u5220\u9664 [ root@node-1 ceph ] # ceph auth del osd.6 //\u6ce8\u610f\u53ef\u80fd\u5c31\u662f\u8fd9\u6b65\u9aa4\u6ca1\u6709\u505a\u4ece\u800c\u5bfc\u81f4\u96c6\u7fa4\u52a0\u4e0d\u8fdb\u53bb\u65b0 osd \u6e05\u7406\u78c1\u76d8\u5df2\u7ecf\u88ab ceph \u6807\u8bb0\u4e09\u4e2a osd \u56e0\u4e3a\u914d\u7f6e Ceph \u5b58\u50a8,\u9700\u8981\u88f8\u8bbe\u5907\u6216\u8005\u6ca1\u6709\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbe\u5907,\u5df2\u7ecf\u88ab ceph \u6807\u8bb0\u4e5f\u53ef\u80fd operator \u4f1a\u52a0\u5165 osd \u5931\u8d25,\u6240\u4ee5\u9700\u8981\u6e05\u7406 \u65b9\u5f0f\u4e00: [ root@node-1 ceph ] # dmsetup ls //\u7528\u8fd9\u6761\u547d\u4ee4\u67e5\u51fa\u88ab ceph \u6807\u8bb0\u7684\u8bbe\u5907 [ root@node-1 ceph ] # dmsetup remove vg--test-vg--lv [ root@node-1 ceph ] # sgdisk -Z /dev/vdd \u65b9\u5f0f\u4e8c: DISK = \"/dev/sdX\" # Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean) sgdisk --zap-all $DISK # Wipe a large portion of the beginning of the disk to remove more LVM metadata that may be present dd if = /dev/zero of = \" $DISK \" bs = 1M count = 100 oflag = direct,dsync # SSDs may be better cleaned with blkdiscard instead of dd blkdiscard $DISK # Inform the OS of partition table changes partprobe $DISK \u5220\u9664deploy [root@node-1 ceph]# kubectl delete deployments.apps rook-ceph-osd-6 //\u5220\u9664 osd \u7684 deploy roo-ceph \u7a7a\u95f4\u4e0d\u8db3 \u5c06\u540d\u79f0\u4e3a rook \u8fd9\u4e2a pool \u5220\u9664\u6765\u89e3\u51b3\u7684\u8fd9\u4e2a\u95ee\u9898(\u8fd9\u4e2a pool \u4e0d\u5728\u4f7f\u7528) ceph osd pool delete rook rook --yes-i-really-really-mean-it //\u5220\u9664\u9700\u8c28\u614e \u5982\u679c\u4e0d\u6e05\u695a\u662f\u5177\u4f53\u90a3\u5757\u8bbe\u5907\u51fa\u73b0\u4e86\u95ee\u9898,\u53ef\u4ee5\u901a\u8fc7\u5b98\u65b9\u63d0\u4f9b\u7684\u811a\u672c\u6765\u8fc7\u6ee4\u51fa\u6765 # Get OSD Pods # This uses the example/default cluster name \"rook\" OSD_PODS = $( kubectl get pods --all-namespaces -l \\ app = rook-ceph-osd,rook_cluster = rook-ceph -o jsonpath = '{.items[*].metadata.name}' ) # Find node and drive associations from OSD pods for pod in $( echo ${ OSD_PODS } ) do echo \"Pod: ${ pod } \" echo \"Node: $( kubectl -n rook-ceph get pod ${ pod } -o jsonpath = '{.spec.nodeName}' ) \" kubectl -n rook-ceph exec ${ pod } -- sh -c '\\ for i in /var/lib/ceph/osd/ceph-*; do [ -f ${i}/ready ] || continue echo -ne \"-$(basename ${i}) \" echo $(lsblk -n -o NAME,SIZE ${i}/block 2> /dev/null || \\ findmnt -n -v -o SOURCE,SIZE -T ${i}) $(cat ${i}/type) done | sort -V echo' done \u4fee\u590dpg unknown PG # \u5217\u51fa\u72b6\u6001\u4e3a unkown \u7684 PG, \u7b2c\u4e00\u5217\u4e3a pgid $ ceph pg dump | grep unknown # \u5f3a\u5236\u91cd\u5efa PG\uff0c\u6ce8\uff1a\u4f1a\u4e22\u5931\u6570\u636e\uff0c\u614e\u91cd\u4f7f\u7528 $ ceph osd force-create-pg <pgid> \u6587\u7ae0\u53c2\u8003: https://www.linuxcool.com/dmsetup","title":"\u89e3\u51b3\u65b9\u6cd5"},{"location":"5.Storage/6-ceph-crush-docs/","text":"\u8c03\u6574CRUSH\u7ed3\u6784 \u00b6 crushmap\u662fCeph\u51b3\u5b9a\u6570\u636e\u5206\u5e03\u7684\u65b9\u5f0f\uff0c\u4e00\u628a\u91c7\u7528\u9ed8\u8ba4\u7684crushmap\u5373\u53ef\uff0c\u6709\u4e9b\u573a\u666f\u9700\u8981\u505a\u8c03\u6574\uff0c\u5982: \u6570\u636e\u5206\u5e03: \u5982SSD+HDD\u878d\u5408\u73af\u5883\uff0c\u9700\u8981\u5c06SSD\u8d44\u6e90\u6c60\u548cHDD\u8d44\u6e90\u6c60\u5206\u5f00\uff0c\u7ed9\u4e24\u79cd\u4e0d\u540c\u7684\u4e1a\u52a1\u6df7\u5408\u4f7f\u7528 \u6743\u91cd\u5206\u914d: OSD\u9ed8\u8ba4\u4f1a\u6839\u636e\u5bb9\u91cf\u5206\u914d\u5bf9\u5e94\u7684weight,\u4f46\u6570\u636e\u4e0d\u662f\u7edd\u5bf9\u7684\u5e73\u5747\uff0c\u5bb9\u91cf\u4e0d\u5e73\u5747\u7684\u65f6\u5019\u53ef\u4ee5\u8c03\u6574 OSD\u4eb2\u548c\u529b: \u8c03\u6574OSD\u6570\u636e\u4e3b\u5199\u7684\u4eb2\u548c\u529b\u673a\u5236 \u5982\u67d0\u4e2aOSD\u5229\u7528\u7387\u8fc7\u9ad8\uff0c\u8fbe\u523085%\u7684\u65f6\u5019\u4f1a\u63d0\u793anearfull\uff0c\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u6269\u5bb9OSD\u5230\u96c6\u7fa4\u4e2d\uff0c\u5982\u679c\u5176\u4ed6\u7684OSD\u5229\u7528\u7387\u4e0d\u9ad8\uff0c\u5219\u53ef\u4ee5\u6839\u636e\u9700\u8981\u8c03\u6574OSD\u7684\u6743\u91cd\uff0c\u89e6\u53d1\u6570\u636e\u7684\u91cd\u65b0\u5206\u5e03\uff0c\u5982\u4e0b: ceph osd crush reweight osd.3 0.8 \u8c03\u6574\u4e4b\u540e\uff0c\u4f1a\u81ea\u52a8\u7684\u505a\u6570\u636e\u7684rebalance \u5b9a\u5236OSD\u7f51\u7edc \u00b6 Ceph \u63d0\u4f9b\u4e86\u4e24\u4e2a\u4e0d\u540c\u7684\u7f51\u7edc\uff0c\u7528\u4e8e\u4e0d\u540c\u7684\u529f\u80fd: public network \u4e1a\u52a1\u7f51\u7edc\uff0c\u7528\u4e8e\u8fde\u63a5Ceph\u96c6\u7fa4\u5efa\u7acb\u6570\u636e\u901a\u9053 cluster network \u6570\u636e\u7f51\u7edc\uff0c\u7528\u4e8eCeph\u5185\u90e8\u7684\u5fc3\u8df3\uff0c\u6570\u636e\u540c\u6b65 \u9ed8\u8ba4\u8fd9\u4e24\u4e2a\u7f51\u7edc\u52a0\u6210\u5728\u4e00\u8d77\uff0c\u5982\u679c\u6709\u4e24\u5f20\u4e0d\u540c\u7684\u7f51\u5361\uff0c\u53ef\u4ee5\u5c06\u5176\u8fdb\u884c\u5206\u5f00\uff0c\u9996\u5148\u9700\u8981\u5c06\u7f51\u7edc\u8bbe\u7f6e\u4e3ahostNetwork\uff0chostNetwork \u610f\u5473\u7740\u5bb9\u5668\u7f51\u7edc\u548c\u5bbf\u4e3b\u673a\u7f51\u7edc\u4f4d\u4e8e\u540c\u4e00\u4e2a\u7f51\u7edc\u7c7b\u578b\uff0c\u8fd9\u4e2a\u8c03\u6574\u53ea\u80fd\u5728rook\u521d\u59cb\u5316\u96c6\u7fa4\u7684\u65f6\u5019\u505a\u8c03\u6574\uff0c\u914d\u7f6e\u4f4d\u4e8ecluster.yaml\u6587\u4ef6 network: provider: host \u8c03\u6574\u6545\u969c\u57df \u00b6 Ceph \u652f\u6301\u8bbe\u7f6e\u8d44\u6e90\u6c60\u7684\u6545\u969c\u57df\uff0c\u4f55\u4e3a\u6545\u969c\u57df\uff1f\u6545\u969c\u57df\u662f\u6307\u5f53\u51fa\u73b0\u5f02\u5e38\u65f6\u80fd\u5bb9\u5fcd\u7684\u8303\u56f4\uff0cCeph\u652f\u6301\u591a\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u6545\u969c\u57df\uff0c\u5e38\u89c1\u7684\u6545\u969c\u57df\u6709: datacenter : \u6570\u636e\u4e2d\u5fc3\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u6570\u636e\u4e2d\u5fc3 rack : \u673a\u67b6\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u6570\u636e\u673a\u67dc host : \u5bbf\u4e3b\u673a\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u5bbf\u4e3b\u673a\uff0c\u9ed8\u8ba4\u89c4\u5219 osd : \u78c1\u76d8\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u78c1\u76d8\u4e0a \u521b\u5efapool\u7684\u65f6\u5019\u53ef\u4ee5\u5b9a\u4e49pool\u6240\u4f7f\u7528\u7684\u6545\u969c\u57df\uff0c\u5982\u4e0b\u521b\u5efa\u4e00\u4e2apool\u6240\u4f7f\u7528\u7684\u6545\u969c\u57df\u4e3aosd apiVersion : ceph.rook.io/v1 kind : CephBlockPool metadata : name : happylau-pool namespace : rook-ceph spec : failureDomain : osd replicated : size : 3 requireSafeReplicaSize : true \u521b\u5efa\u4e4b\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u6821\u9a8c ceph osd pool get happylau-pool crush_rule ceph osd crush rule dump happylau-pool \u5e38\u89c1\u6545\u969c\u6392\u67e5 \u00b6 Rook\u5c06Ceph\u76f8\u5173\u7684\u7ec4\u4ef6\u8fd0\u884c\u5728kubernetes\u4e4b\u4e0a\uff0c\u56e0\u6b64\u7ef4\u62a4Ceph\u7684\u65f6\u5019\u9700\u8981\u540c\u65f6\u7ef4\u62a4kubernetes\u96c6\u7fa4\u548cCeph\u96c6\u7fa4\uff0c\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u72b6\u6001\u6b63\u5e38\uff0c\u901a\u5e38Ceph\u4f9d\u8d56\u4e8ekubernetes\uff0c\u7136\u800ckubernetes\u72b6\u6001\u6b63\u5e38\u5e76\u4e0d\u5b8c\u5168\u7b49\u540c\u4e8eCeph\u6b63\u5e38\uff0cCeph\u5305\u542b\u6709\u5185\u7f6e\u7684\u72b6\u6001\u7ef4\u62a4\u65b9\u6cd5 1\u3001\u5bf9\u4e8ekubernetes\u800c\u8a00\uff0c\u9700\u8981\u786e\u4fdd\u76f8\u5173\u7684pods\u72b6\u6001\u5904\u4e8e\u6b63\u5e38\u72b6\u6001 $ kubectl get pods -n rook-ceph \u5982\u679c\u67d0\u4e2apods\u5f02\u5e38\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7describe\u67e5\u770b\u5176kubernetes\u7684\u4e8b\u4ef6\u548clogs\u67e5\u770b\u5bb9\u5668\u5185\u90e8\u7684\u8fd0\u884c\u65e5\u5fd7\uff0c\u4ece\u800c\u7aa5\u63a2\u5230\u5bb9\u5668\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\u3002 $ kubectl logs pod-xxx -n rook-ceph -c pod-xxx 2\u3001\u5bf9\u4e8eCeph\u7684\u72b6\u6001\u6765\u8bf4\uff0cCeph\u63d0\u4f9b\u4e86\u5f88\u591a\u547d\u4ee4\u68c0\u8f66\u7684\u5de5\u5177\uff0c\u5982\u67e5\u770b\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001\u7684 ceph -s \u548c\u8be6\u7ec6\u7684 ceph health detail $ ceph -s cluster: id: 860fd586-3f2e-4bd7-8497-4f900de9cd32 health: HEALTH_WARN 11 pool ( s ) have no replicas configured OSD count 1 < osd_pool_default_size 3 services: mon: 3 daemons, quorum a,b,c ( age 2d ) mgr: b ( active, since 2d ) , standbys: a mds: 1 /1 daemons up osd: 1 osds: 1 up ( since 2d ) , 1 in ( since 11w ) rgw: 2 daemons active ( 1 hosts, 1 zones ) data: volumes: 1 /1 healthy pools: 11 pools, 168 pgs objects: 95 .32k objects, 22 GiB usage: 23 GiB used, 931 GiB / 954 GiB avail pgs: 168 active+clean io: client: 6 .0 KiB/s rd, 22 KiB/s wr, 4 op/s rd, 7 op/s wr $ ceph health detail HEALTH_WARN 11 pool ( s ) have no replicas configured ; OSD count 1 < osd_pool_default_size 3 [ WRN ] POOL_NO_REDUNDANCY: 11 pool ( s ) have no replicas configured pool 'replicapool' has no replicas configured pool 'myfs-metadata' has no replicas configured pool 'myfs-replicated' has no replicas configured pool 'my-store.rgw.otp' has no replicas configured pool 'my-store.rgw.log' has no replicas configured pool 'my-store.rgw.meta' has no replicas configured pool 'my-store.rgw.control' has no replicas configured pool 'my-store.rgw.buckets.non-ec' has no replicas configured pool 'my-store.rgw.buckets.index' has no replicas configured pool '.rgw.root' has no replicas configured pool 'my-store.rgw.buckets.data' has no replicas configured [ WRN ] TOO_FEW_OSDS: OSD count 1 < osd_pool_default_size 3 Ceph \u96c6\u7fa4\u5065\u5eb7\u72b6\u51b5\u8b66\u544a\u8868\u793a\u4f60\u7684\u96c6\u7fa4\u4e2d\u7684\u5b58\u50a8\u6c60\u6ca1\u6709\u914d\u7f6e\u526f\u672c\uff0c\u4e14 OSD\uff08\u5bf9\u8c61\u5b58\u50a8\u8bbe\u5907\uff09\u7684\u6570\u91cf\u5c11\u4e8e\u9ed8\u8ba4\u7684 osd_pool_default_size\uff08\u9ed8\u8ba4\u503c\u4e3a3\uff09\u3002 \u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u7684\u98ce\u9669\uff0c\u56e0\u4e3a\u6ca1\u6709\u526f\u672c\u53ef\u4ee5\u5728\u4e00\u4e2a OSD \u5931\u8d25\u65f6\u63d0\u4f9b\u5907\u4efd\u3002 \u521d\u6b21\u4e4b\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86\u5f88\u591aOSD\u5f97\u8ffd\u6602\u4f53\u554a\u67e5\u770b\u76f8\u5173\u7684\u5de5\u5177 $ ceph osd tree # \u67e5\u770bosd\u7684\u76ee\u5f55\u6811\u7ed3\u6784 ID CLASS WEIGHT TYPE NAME STATUS REWEIGHT PRI-AFF -1 0 .93149 root default -3 0 .93149 host m1-pre 0 ssd 0 .93149 osd.0 up 1 .00000 1 .00000 $ ceph osd df # \u67e5\u770bosd\u7684\u78c1\u76d8\u5229\u7528\u7387 ID CLASS WEIGHT REWEIGHT SIZE RAW USE DATA OMAP META AVAIL %USE VAR PGS STATUS 0 ssd 0 .93149 1 .00000 954 GiB 23 GiB 22 GiB 168 MiB 763 MiB 931 GiB 2 .42 1 .00 168 up TOTAL 954 GiB 23 GiB 22 GiB 168 MiB 763 MiB 931 GiB 2 .42 MIN/MAX VAR: 1 .00/1.00 STDDEV: 0 $ ceph osd status # \u67e5\u770bosd\u96c6\u7fa4\u72b6\u6001 ID HOST USED AVAIL WR OPS WR DATA RD OPS RD DATA STATE 0 m1.pre 23 .1G 930G 6 41 .8k 5 2457 exists,up $ ceph osd utilization # \u67e5\u770bosd\u7684\u5229\u7528\u7387 avg 168 stddev 0 ( expected baseline 0 ) min osd.0 with 168 pgs ( 1 * mean ) max osd.0 with 168 pgs ( 1 * mean ) Ceph\u53c2\u8003\u6587\u6863 \u00b6 \u5b98\u65b9\u6392\u9664\u6587\u6863\u53c2\u8003\u5730\u5740","title":"ceph \u9ad8\u7ea7\u53c2\u6570"},{"location":"5.Storage/6-ceph-crush-docs/#crush","text":"crushmap\u662fCeph\u51b3\u5b9a\u6570\u636e\u5206\u5e03\u7684\u65b9\u5f0f\uff0c\u4e00\u628a\u91c7\u7528\u9ed8\u8ba4\u7684crushmap\u5373\u53ef\uff0c\u6709\u4e9b\u573a\u666f\u9700\u8981\u505a\u8c03\u6574\uff0c\u5982: \u6570\u636e\u5206\u5e03: \u5982SSD+HDD\u878d\u5408\u73af\u5883\uff0c\u9700\u8981\u5c06SSD\u8d44\u6e90\u6c60\u548cHDD\u8d44\u6e90\u6c60\u5206\u5f00\uff0c\u7ed9\u4e24\u79cd\u4e0d\u540c\u7684\u4e1a\u52a1\u6df7\u5408\u4f7f\u7528 \u6743\u91cd\u5206\u914d: OSD\u9ed8\u8ba4\u4f1a\u6839\u636e\u5bb9\u91cf\u5206\u914d\u5bf9\u5e94\u7684weight,\u4f46\u6570\u636e\u4e0d\u662f\u7edd\u5bf9\u7684\u5e73\u5747\uff0c\u5bb9\u91cf\u4e0d\u5e73\u5747\u7684\u65f6\u5019\u53ef\u4ee5\u8c03\u6574 OSD\u4eb2\u548c\u529b: \u8c03\u6574OSD\u6570\u636e\u4e3b\u5199\u7684\u4eb2\u548c\u529b\u673a\u5236 \u5982\u67d0\u4e2aOSD\u5229\u7528\u7387\u8fc7\u9ad8\uff0c\u8fbe\u523085%\u7684\u65f6\u5019\u4f1a\u63d0\u793anearfull\uff0c\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u6269\u5bb9OSD\u5230\u96c6\u7fa4\u4e2d\uff0c\u5982\u679c\u5176\u4ed6\u7684OSD\u5229\u7528\u7387\u4e0d\u9ad8\uff0c\u5219\u53ef\u4ee5\u6839\u636e\u9700\u8981\u8c03\u6574OSD\u7684\u6743\u91cd\uff0c\u89e6\u53d1\u6570\u636e\u7684\u91cd\u65b0\u5206\u5e03\uff0c\u5982\u4e0b: ceph osd crush reweight osd.3 0.8 \u8c03\u6574\u4e4b\u540e\uff0c\u4f1a\u81ea\u52a8\u7684\u505a\u6570\u636e\u7684rebalance","title":"\u8c03\u6574CRUSH\u7ed3\u6784"},{"location":"5.Storage/6-ceph-crush-docs/#osd","text":"Ceph \u63d0\u4f9b\u4e86\u4e24\u4e2a\u4e0d\u540c\u7684\u7f51\u7edc\uff0c\u7528\u4e8e\u4e0d\u540c\u7684\u529f\u80fd: public network \u4e1a\u52a1\u7f51\u7edc\uff0c\u7528\u4e8e\u8fde\u63a5Ceph\u96c6\u7fa4\u5efa\u7acb\u6570\u636e\u901a\u9053 cluster network \u6570\u636e\u7f51\u7edc\uff0c\u7528\u4e8eCeph\u5185\u90e8\u7684\u5fc3\u8df3\uff0c\u6570\u636e\u540c\u6b65 \u9ed8\u8ba4\u8fd9\u4e24\u4e2a\u7f51\u7edc\u52a0\u6210\u5728\u4e00\u8d77\uff0c\u5982\u679c\u6709\u4e24\u5f20\u4e0d\u540c\u7684\u7f51\u5361\uff0c\u53ef\u4ee5\u5c06\u5176\u8fdb\u884c\u5206\u5f00\uff0c\u9996\u5148\u9700\u8981\u5c06\u7f51\u7edc\u8bbe\u7f6e\u4e3ahostNetwork\uff0chostNetwork \u610f\u5473\u7740\u5bb9\u5668\u7f51\u7edc\u548c\u5bbf\u4e3b\u673a\u7f51\u7edc\u4f4d\u4e8e\u540c\u4e00\u4e2a\u7f51\u7edc\u7c7b\u578b\uff0c\u8fd9\u4e2a\u8c03\u6574\u53ea\u80fd\u5728rook\u521d\u59cb\u5316\u96c6\u7fa4\u7684\u65f6\u5019\u505a\u8c03\u6574\uff0c\u914d\u7f6e\u4f4d\u4e8ecluster.yaml\u6587\u4ef6 network: provider: host","title":"\u5b9a\u5236OSD\u7f51\u7edc"},{"location":"5.Storage/6-ceph-crush-docs/#_1","text":"Ceph \u652f\u6301\u8bbe\u7f6e\u8d44\u6e90\u6c60\u7684\u6545\u969c\u57df\uff0c\u4f55\u4e3a\u6545\u969c\u57df\uff1f\u6545\u969c\u57df\u662f\u6307\u5f53\u51fa\u73b0\u5f02\u5e38\u65f6\u80fd\u5bb9\u5fcd\u7684\u8303\u56f4\uff0cCeph\u652f\u6301\u591a\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u6545\u969c\u57df\uff0c\u5e38\u89c1\u7684\u6545\u969c\u57df\u6709: datacenter : \u6570\u636e\u4e2d\u5fc3\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u6570\u636e\u4e2d\u5fc3 rack : \u673a\u67b6\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u6570\u636e\u673a\u67dc host : \u5bbf\u4e3b\u673a\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u5bbf\u4e3b\u673a\uff0c\u9ed8\u8ba4\u89c4\u5219 osd : \u78c1\u76d8\u7ea7\u522b\uff0c\u5982\u4e09\u4e2a\u526f\u672c\uff0c\u5206\u522b\u843d\u5728\u4e09\u4e2a\u4e0d\u540c\u7684\u78c1\u76d8\u4e0a \u521b\u5efapool\u7684\u65f6\u5019\u53ef\u4ee5\u5b9a\u4e49pool\u6240\u4f7f\u7528\u7684\u6545\u969c\u57df\uff0c\u5982\u4e0b\u521b\u5efa\u4e00\u4e2apool\u6240\u4f7f\u7528\u7684\u6545\u969c\u57df\u4e3aosd apiVersion : ceph.rook.io/v1 kind : CephBlockPool metadata : name : happylau-pool namespace : rook-ceph spec : failureDomain : osd replicated : size : 3 requireSafeReplicaSize : true \u521b\u5efa\u4e4b\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u6821\u9a8c ceph osd pool get happylau-pool crush_rule ceph osd crush rule dump happylau-pool","title":"\u8c03\u6574\u6545\u969c\u57df"},{"location":"5.Storage/6-ceph-crush-docs/#_2","text":"Rook\u5c06Ceph\u76f8\u5173\u7684\u7ec4\u4ef6\u8fd0\u884c\u5728kubernetes\u4e4b\u4e0a\uff0c\u56e0\u6b64\u7ef4\u62a4Ceph\u7684\u65f6\u5019\u9700\u8981\u540c\u65f6\u7ef4\u62a4kubernetes\u96c6\u7fa4\u548cCeph\u96c6\u7fa4\uff0c\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u72b6\u6001\u6b63\u5e38\uff0c\u901a\u5e38Ceph\u4f9d\u8d56\u4e8ekubernetes\uff0c\u7136\u800ckubernetes\u72b6\u6001\u6b63\u5e38\u5e76\u4e0d\u5b8c\u5168\u7b49\u540c\u4e8eCeph\u6b63\u5e38\uff0cCeph\u5305\u542b\u6709\u5185\u7f6e\u7684\u72b6\u6001\u7ef4\u62a4\u65b9\u6cd5 1\u3001\u5bf9\u4e8ekubernetes\u800c\u8a00\uff0c\u9700\u8981\u786e\u4fdd\u76f8\u5173\u7684pods\u72b6\u6001\u5904\u4e8e\u6b63\u5e38\u72b6\u6001 $ kubectl get pods -n rook-ceph \u5982\u679c\u67d0\u4e2apods\u5f02\u5e38\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7describe\u67e5\u770b\u5176kubernetes\u7684\u4e8b\u4ef6\u548clogs\u67e5\u770b\u5bb9\u5668\u5185\u90e8\u7684\u8fd0\u884c\u65e5\u5fd7\uff0c\u4ece\u800c\u7aa5\u63a2\u5230\u5bb9\u5668\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\u3002 $ kubectl logs pod-xxx -n rook-ceph -c pod-xxx 2\u3001\u5bf9\u4e8eCeph\u7684\u72b6\u6001\u6765\u8bf4\uff0cCeph\u63d0\u4f9b\u4e86\u5f88\u591a\u547d\u4ee4\u68c0\u8f66\u7684\u5de5\u5177\uff0c\u5982\u67e5\u770b\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001\u7684 ceph -s \u548c\u8be6\u7ec6\u7684 ceph health detail $ ceph -s cluster: id: 860fd586-3f2e-4bd7-8497-4f900de9cd32 health: HEALTH_WARN 11 pool ( s ) have no replicas configured OSD count 1 < osd_pool_default_size 3 services: mon: 3 daemons, quorum a,b,c ( age 2d ) mgr: b ( active, since 2d ) , standbys: a mds: 1 /1 daemons up osd: 1 osds: 1 up ( since 2d ) , 1 in ( since 11w ) rgw: 2 daemons active ( 1 hosts, 1 zones ) data: volumes: 1 /1 healthy pools: 11 pools, 168 pgs objects: 95 .32k objects, 22 GiB usage: 23 GiB used, 931 GiB / 954 GiB avail pgs: 168 active+clean io: client: 6 .0 KiB/s rd, 22 KiB/s wr, 4 op/s rd, 7 op/s wr $ ceph health detail HEALTH_WARN 11 pool ( s ) have no replicas configured ; OSD count 1 < osd_pool_default_size 3 [ WRN ] POOL_NO_REDUNDANCY: 11 pool ( s ) have no replicas configured pool 'replicapool' has no replicas configured pool 'myfs-metadata' has no replicas configured pool 'myfs-replicated' has no replicas configured pool 'my-store.rgw.otp' has no replicas configured pool 'my-store.rgw.log' has no replicas configured pool 'my-store.rgw.meta' has no replicas configured pool 'my-store.rgw.control' has no replicas configured pool 'my-store.rgw.buckets.non-ec' has no replicas configured pool 'my-store.rgw.buckets.index' has no replicas configured pool '.rgw.root' has no replicas configured pool 'my-store.rgw.buckets.data' has no replicas configured [ WRN ] TOO_FEW_OSDS: OSD count 1 < osd_pool_default_size 3 Ceph \u96c6\u7fa4\u5065\u5eb7\u72b6\u51b5\u8b66\u544a\u8868\u793a\u4f60\u7684\u96c6\u7fa4\u4e2d\u7684\u5b58\u50a8\u6c60\u6ca1\u6709\u914d\u7f6e\u526f\u672c\uff0c\u4e14 OSD\uff08\u5bf9\u8c61\u5b58\u50a8\u8bbe\u5907\uff09\u7684\u6570\u91cf\u5c11\u4e8e\u9ed8\u8ba4\u7684 osd_pool_default_size\uff08\u9ed8\u8ba4\u503c\u4e3a3\uff09\u3002 \u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u7684\u98ce\u9669\uff0c\u56e0\u4e3a\u6ca1\u6709\u526f\u672c\u53ef\u4ee5\u5728\u4e00\u4e2a OSD \u5931\u8d25\u65f6\u63d0\u4f9b\u5907\u4efd\u3002 \u521d\u6b21\u4e4b\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86\u5f88\u591aOSD\u5f97\u8ffd\u6602\u4f53\u554a\u67e5\u770b\u76f8\u5173\u7684\u5de5\u5177 $ ceph osd tree # \u67e5\u770bosd\u7684\u76ee\u5f55\u6811\u7ed3\u6784 ID CLASS WEIGHT TYPE NAME STATUS REWEIGHT PRI-AFF -1 0 .93149 root default -3 0 .93149 host m1-pre 0 ssd 0 .93149 osd.0 up 1 .00000 1 .00000 $ ceph osd df # \u67e5\u770bosd\u7684\u78c1\u76d8\u5229\u7528\u7387 ID CLASS WEIGHT REWEIGHT SIZE RAW USE DATA OMAP META AVAIL %USE VAR PGS STATUS 0 ssd 0 .93149 1 .00000 954 GiB 23 GiB 22 GiB 168 MiB 763 MiB 931 GiB 2 .42 1 .00 168 up TOTAL 954 GiB 23 GiB 22 GiB 168 MiB 763 MiB 931 GiB 2 .42 MIN/MAX VAR: 1 .00/1.00 STDDEV: 0 $ ceph osd status # \u67e5\u770bosd\u96c6\u7fa4\u72b6\u6001 ID HOST USED AVAIL WR OPS WR DATA RD OPS RD DATA STATE 0 m1.pre 23 .1G 930G 6 41 .8k 5 2457 exists,up $ ceph osd utilization # \u67e5\u770bosd\u7684\u5229\u7528\u7387 avg 168 stddev 0 ( expected baseline 0 ) min osd.0 with 168 pgs ( 1 * mean ) max osd.0 with 168 pgs ( 1 * mean )","title":"\u5e38\u89c1\u6545\u969c\u6392\u67e5"},{"location":"5.Storage/6-ceph-crush-docs/#ceph","text":"\u5b98\u65b9\u6392\u9664\u6587\u6863\u53c2\u8003\u5730\u5740","title":"Ceph\u53c2\u8003\u6587\u6863"},{"location":"5.Storage/Juicefs/","text":"Juicefs \u5b58\u50a8\u4ecb\u7ecd \u00b6 JuiceFS \u662f\u4e00\u6b3e\u9762\u5411\u4e91\u539f\u751f\u8bbe\u8ba1\u7684\u9ad8\u6027\u80fd\u5206\u5e03\u5f0f\u6587\u4ef6\u7cfb\u7edf\uff0c\u5728 Apache 2.0 \u5f00\u6e90\u534f\u8bae\u4e0b\u53d1\u5e03\u3002\u63d0\u4f9b\u5b8c\u5907\u7684 POSIX \u517c\u5bb9\u6027\uff0c\u53ef\u5c06\u51e0\u4e4e\u6240\u6709\u5bf9\u8c61\u5b58\u50a8\u63a5\u5165\u672c\u5730\u4f5c\u4e3a\u6d77\u91cf\u672c\u5730\u78c1\u76d8\u4f7f\u7528\uff0c\u4ea6\u53ef\u540c\u65f6\u5728\u8de8\u5e73\u53f0\u3001\u8de8\u5730\u533a\u7684\u4e0d\u540c\u4e3b\u673a\u4e0a\u6302\u8f7d\u8bfb\u5199\u3002 JuiceFS \u91c7\u7528\u300c\u6570\u636e\u300d\u4e0e\u300c\u5143\u6570\u636e\u300d\u5206\u79bb\u5b58\u50a8\u7684\u67b6\u6784\uff0c\u4ece\u800c\u5b9e\u73b0\u6587\u4ef6\u7cfb\u7edf\u7684\u5206\u5e03\u5f0f\u8bbe\u8ba1\u3002\u6587\u4ef6\u6570\u636e\u672c\u8eab\u4f1a\u88ab\u5207\u5206\u4fdd\u5b58\u5728 \u5bf9\u8c61\u5b58\u50a8 \uff08\u4f8b\u5982 Amazon S3\uff09\uff0c\u800c\u5143\u6570\u636e\u5219\u53ef\u4ee5\u4fdd\u5b58\u5728 Redis\u3001MySQL\u3001TiKV\u3001SQLite \u7b49\u591a\u79cd \u6570\u636e\u5e93 \u4e2d\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u573a\u666f\u4e0e\u6027\u80fd\u8981\u6c42\u8fdb\u884c\u9009\u62e9\u3002 JuiceFS \u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684 API\uff0c\u9002\u7528\u4e8e\u5404\u79cd\u5f62\u5f0f\u6570\u636e\u7684\u7ba1\u7406\u3001\u5206\u6790\u3001\u5f52\u6863\u3001\u5907\u4efd\uff0c\u53ef\u4ee5\u5728\u4e0d\u4fee\u6539\u4ee3\u7801\u7684\u524d\u63d0\u4e0b\u65e0\u7f1d\u5bf9\u63a5\u5927\u6570\u636e\u3001\u673a\u5668\u5b66\u4e60\u3001\u4eba\u5de5\u667a\u80fd\u7b49\u5e94\u7528\u5e73\u53f0\uff0c\u4e3a\u5176\u63d0\u4f9b\u6d77\u91cf\u3001\u5f39\u6027\u3001\u4f4e\u4ef7\u7684\u9ad8\u6027\u80fd\u5b58\u50a8\u3002\u8fd0\u7ef4\u4eba\u5458\u4e0d\u7528\u518d\u4e3a\u53ef\u7528\u6027\u3001\u707e\u96be\u6062\u590d\u3001\u76d1\u63a7\u3001\u6269\u5bb9\u7b49\u5de5\u4f5c\u70e6\u607c\uff0c\u4e13\u6ce8\u4e8e\u4e1a\u52a1\u5f00\u53d1\uff0c\u63d0\u5347\u7814\u53d1\u6548\u7387\u3002\u540c\u65f6\u8fd0\u7ef4\u7ec6\u8282\u7684\u7b80\u5316\uff0c\u5bf9 DevOps \u6781\u5176\u53cb\u597d\u3002 \u6838\u5fc3\u7279\u6027 \u00b6 POSIX \u517c\u5bb9 \uff1a\u50cf\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e00\u6837\u4f7f\u7528\uff0c\u65e0\u7f1d\u5bf9\u63a5\u5df2\u6709\u5e94\u7528\uff0c\u65e0\u4e1a\u52a1\u4fb5\u5165\u6027\uff1b HDFS \u517c\u5bb9 \uff1a\u5b8c\u6574\u517c\u5bb9 HDFS API \uff0c\u63d0\u4f9b\u66f4\u5f3a\u7684\u5143\u6570\u636e\u6027\u80fd\uff1b S3 \u517c\u5bb9 \uff1a\u63d0\u4f9b S3 \u7f51\u5173 \u5b9e\u73b0 S3 \u534f\u8bae\u517c\u5bb9\u7684\u8bbf\u95ee\u63a5\u53e3\uff1b \u4e91\u539f\u751f \uff1a\u901a\u8fc7 Kubernetes CSI \u9a71\u52a8 \u8f7b\u677e\u5730\u5728 Kubernetes \u4e2d\u4f7f\u7528 JuiceFS\uff1b \u5206\u5e03\u5f0f\u8bbe\u8ba1 \uff1a\u540c\u4e00\u6587\u4ef6\u7cfb\u7edf\u53ef\u5728\u4e0a\u5343\u53f0\u670d\u52a1\u5668\u540c\u65f6\u6302\u8f7d\uff0c\u9ad8\u6027\u80fd\u5e76\u53d1\u8bfb\u5199\uff0c\u5171\u4eab\u6570\u636e\uff1b \u5f3a\u4e00\u81f4\u6027 \uff1a\u786e\u8ba4\u7684\u6587\u4ef6\u4fee\u6539\u4f1a\u5728\u6240\u6709\u670d\u52a1\u5668\u4e0a\u7acb\u5373\u53ef\u89c1\uff0c\u4fdd\u8bc1\u5f3a\u4e00\u81f4\u6027\uff1b \u5f3a\u608d\u6027\u80fd \uff1a\u6beb\u79d2\u7ea7\u5ef6\u8fdf\uff0c\u8fd1\u4e4e\u65e0\u9650\u7684\u541e\u5410\u91cf\uff08\u53d6\u51b3\u4e8e\u5bf9\u8c61\u5b58\u50a8\u89c4\u6a21\uff09\uff0c\u67e5\u770b \u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c \uff1b \u6570\u636e\u5b89\u5168 \uff1a\u652f\u6301\u4f20\u8f93\u4e2d\u52a0\u5bc6\uff08encryption in transit\uff09\u548c\u9759\u6001\u52a0\u5bc6\uff08encryption at rest\uff09\uff0c \u67e5\u770b\u8be6\u60c5 \uff1b \u6587\u4ef6\u9501 \uff1a\u652f\u6301 BSD \u9501\uff08flock\uff09\u548c POSIX \u9501\uff08fcntl\uff09\uff1b \u6570\u636e\u538b\u7f29 \uff1a\u652f\u6301 LZ4 \u548c Zstandard \u538b\u7f29\u7b97\u6cd5\uff0c\u8282\u7701\u5b58\u50a8\u7a7a\u95f4\u3002 \u5e94\u7528\u573a\u666f \u00b6 JuiceFS \u4e3a\u6d77\u91cf\u6570\u636e\u5b58\u50a8\u8bbe\u8ba1\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u5f88\u591a\u5206\u5e03\u5f0f\u6587\u4ef6\u7cfb\u7edf\u548c\u7f51\u7edc\u6587\u4ef6\u7cfb\u7edf\u7684\u66ff\u4ee3\uff0c\u7279\u522b\u662f\u4ee5\u4e0b\u573a\u666f\uff1a \u5927\u6570\u636e\u5206\u6790\uff1aHDFS \u517c\u5bb9\uff1b\u4e0e\u4e3b\u6d41\u8ba1\u7b97\u5f15\u64ce\uff08Spark\u3001Presto\u3001Hive \u7b49\uff09\u65e0\u7f1d\u8854\u63a5\uff1b\u65e0\u9650\u6269\u5c55\u7684\u5b58\u50a8\u7a7a\u95f4\uff1b\u8fd0\u7ef4\u6210\u672c\u51e0\u4e4e\u4e3a 0\uff1b\u6027\u80fd\u8fdc\u597d\u4e8e\u76f4\u63a5\u5bf9\u63a5\u5bf9\u8c61\u5b58\u50a8\u3002 \u673a\u5668\u5b66\u4e60\uff1aPOSIX \u517c\u5bb9\uff0c\u53ef\u4ee5\u652f\u6301\u6240\u6709\u673a\u5668\u5b66\u4e60\u3001\u6df1\u5ea6\u5b66\u4e60\u6846\u67b6\uff1b\u65b9\u4fbf\u7684\u6587\u4ef6\u5171\u4eab\u8fd8\u80fd\u63d0\u5347\u56e2\u961f\u7ba1\u7406\u3001\u4f7f\u7528\u6570\u636e\u6548\u7387\u3002 Kubernetes\uff1aJuiceFS \u652f\u6301 Kubernetes CSI\uff1b\u4e3a\u5bb9\u5668\u63d0\u4f9b\u89e3\u8026\u7684\u6587\u4ef6\u5b58\u50a8\uff0c\u4ee4\u5e94\u7528\u670d\u52a1\u53ef\u4ee5\u65e0\u72b6\u6001\u5316\uff1b\u65b9\u4fbf\u5730\u5728\u5bb9\u5668\u95f4\u5171\u4eab\u6570\u636e\u3002 \u5171\u4eab\u5de5\u4f5c\u533a\uff1a\u53ef\u4ee5\u5728\u4efb\u610f\u4e3b\u673a\u6302\u8f7d\uff1b\u6ca1\u6709\u5ba2\u6237\u7aef\u5e76\u53d1\u8bfb\u5199\u9650\u5236\uff1bPOSIX \u517c\u5bb9\u5df2\u6709\u7684\u6570\u636e\u6d41\u548c\u811a\u672c\u64cd\u4f5c\u3002 \u6570\u636e\u5907\u4efd\uff1a\u5728\u65e0\u9650\u5e73\u6ed1\u6269\u5c55\u7684\u5b58\u50a8\u7a7a\u95f4\u5907\u4efd\u5404\u79cd\u6570\u636e\uff0c\u7ed3\u5408\u5171\u4eab\u6302\u8f7d\u529f\u80fd\uff0c\u53ef\u4ee5\u5c06\u591a\u4e3b\u673a\u6570\u636e\u6c47\u603b\u81f3\u4e00\u5904\uff0c\u505a\u7edf\u4e00\u5907\u4efd\u3002 \u6280\u672f\u67b6\u6784 \u00b6 JuiceFS \u6587\u4ef6\u7cfb\u7edf\u7531\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a JuiceFS \u5ba2\u6237\u7aef\uff08Client\uff09 \uff1a\u6240\u6709\u6587\u4ef6\u8bfb\u5199\uff0c\u4ee5\u53ca\u788e\u7247\u5408\u5e76\u3001\u56de\u6536\u7ad9\u6587\u4ef6\u8fc7\u671f\u5220\u9664\u7b49\u540e\u53f0\u4efb\u52a1\uff0c\u5747\u5728\u5ba2\u6237\u7aef\u4e2d\u53d1\u751f\u3002\u5ba2\u6237\u7aef\u9700\u8981\u540c\u65f6\u4e0e\u5bf9\u8c61\u5b58\u50a8\u548c\u5143\u6570\u636e\u5f15\u64ce\u6253\u4ea4\u9053\u3002\u5ba2\u6237\u7aef\u652f\u6301\u591a\u79cd\u63a5\u5165\u65b9\u5f0f\uff1a \u901a\u8fc7 FUSE \uff0cJuiceFS \u6587\u4ef6\u7cfb\u7edf\u80fd\u591f\u4ee5 POSIX \u517c\u5bb9\u7684\u65b9\u5f0f\u6302\u8f7d\u5230\u670d\u52a1\u5668\uff0c\u5c06\u6d77\u91cf\u4e91\u7aef\u5b58\u50a8\u76f4\u63a5\u5f53\u505a\u672c\u5730\u5b58\u50a8\u6765\u4f7f\u7528\u3002 \u901a\u8fc7 Hadoop Java SDK \uff0cJuiceFS \u6587\u4ef6\u7cfb\u7edf\u80fd\u591f\u76f4\u63a5\u66ff\u4ee3 HDFS\uff0c\u4e3a Hadoop \u63d0\u4f9b\u4f4e\u6210\u672c\u7684\u6d77\u91cf\u5b58\u50a8\u3002 \u901a\u8fc7 Kubernetes CSI \u9a71\u52a8 \uff0cJuiceFS \u6587\u4ef6\u7cfb\u7edf\u80fd\u591f\u76f4\u63a5\u4e3a Kubernetes \u63d0\u4f9b\u6d77\u91cf\u5b58\u50a8\u3002 \u901a\u8fc7 S3 \u7f51\u5173 \uff0c\u4f7f\u7528 S3 \u4f5c\u4e3a\u5b58\u50a8\u5c42\u7684\u5e94\u7528\u53ef\u76f4\u63a5\u63a5\u5165\uff0c\u540c\u65f6\u53ef\u4f7f\u7528 AWS CLI\u3001s3cmd\u3001MinIO client \u7b49\u5de5\u5177\u8bbf\u95ee JuiceFS \u6587\u4ef6\u7cfb\u7edf\u3002 \u901a\u8fc7 WebDAV \u670d\u52a1 \uff0c\u4ee5 HTTP \u534f\u8bae\uff0c\u4ee5\u7c7b\u4f3c RESTful API \u7684\u65b9\u5f0f\u63a5\u5165 JuiceFS \u5e76\u76f4\u63a5\u64cd\u4f5c\u5176\u4e2d\u7684\u6587\u4ef6\u3002 \u6570\u636e\u5b58\u50a8\uff08Data Storage\uff09 \uff1a\u6587\u4ef6\u5c06\u4f1a\u88ab\u5207\u5206\u4e0a\u4f20\u81f3\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002JuiceFS \u652f\u6301\u51e0\u4e4e\u6240\u6709\u7684\u516c\u6709\u4e91\u5bf9\u8c61\u5b58\u50a8\uff0c\u540c\u65f6\u4e5f\u652f\u6301 OpenStack Swift\u3001Ceph\u3001MinIO \u7b49\u79c1\u6709\u5316\u7684\u5bf9\u8c61\u5b58\u50a8\u3002 \u5143\u6570\u636e\u5f15\u64ce\uff08Metadata Engine\uff09 \uff1a\u7528\u4e8e\u5b58\u50a8\u6587\u4ef6\u5143\u6570\u636e\uff08metadata\uff09\uff0c\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5e38\u89c4\u6587\u4ef6\u7cfb\u7edf\u7684\u5143\u6570\u636e\uff1a\u6587\u4ef6\u540d\u3001\u6587\u4ef6\u5927\u5c0f\u3001\u6743\u9650\u4fe1\u606f\u3001\u521b\u5efa\u4fee\u6539\u65f6\u95f4\u3001\u76ee\u5f55\u7ed3\u6784\u3001\u6587\u4ef6\u5c5e\u6027\u3001\u7b26\u53f7\u94fe\u63a5\u3001\u6587\u4ef6\u9501\u7b49\u3002 \u6587\u4ef6\u6570\u636e\u7684\u7d22\u5f15\uff1a\u6587\u4ef6\u7684\u6570\u636e\u5206\u914d\u548c\u5f15\u7528\u8ba1\u6570\u3001\u5ba2\u6237\u7aef\u4f1a\u8bdd\u7b49\u3002 \u73af\u5883\u90e8\u7f72 \u00b6 \u73af\u5883\u8981\u6c42 \u8fd9\u91cc\u505a dome \u5b9e\u9a8c,\u6240\u4ee5\u53ef\u7528 k3s \u4f5c\u4e3a\u5b9e\u9a8c\u73af\u5883,\u5229\u7528k3s\u81ea\u5e26\u7684local-path,\u4f5c\u4e3a redis-cluster\u7684\u5757\u5b58\u50a8,\u540e\u7aef\u4f7f\u7528 minio \u4f5c\u4e3a juicefs \u5bf9\u63a5\u7684s3\u5b58\u50a8 \u90e8\u7f72\u65b9\u5f0f: \u65b9\u5f0f\u4e00: \u5728 K3s \u4e0a\u4f7f\u7528 JuiceFS (\u6d4b\u8bd5\u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f,\u6bd4\u8f83\u7b80\u5355) \u65b9\u5f0f\u4e8c: \u5b98\u65b9\u63a8\u8350helm\u65b9\u5f0f\u90e8\u7f72 (\u751f\u4ea7\u73af\u5883\u5f3a\u70c8\u63a8\u8350\u8fd9\u79cd) \u4f18\u5316\u65b9\u6cd5: \u53ef\u4ee5\u53c2\u8003\u6211\u5199\u7684\u4e00\u4e2a pr \u5bf9\u5df2\u7ecf\u5b89\u88c5\u7684 juicefs \u8fdb\u884c\u4f18\u5316 Juicefs\u5347\u7ea7 \u00b6 \u53ef\u4ee5\u53c2\u8003 juicefs \u5b98\u65b9\u63a8\u8350 helm \u65b9\u5f0f\u6765\u5347\u7ea7,\u6587\u7ae0\u53c2\u8003:https://juicefs.com/docs/zh/csi/upgrade-csi-driver helm repo update helm upgrade juicefs-csi-driver juicefs/juicefs-csi-driver -n kube-system -f ./values.yaml \u6211\u662f\u4ece 1.1 beta \u7248\u672c\u5347\u7ea7,\u5176\u4e2d values \u4e2d\u53ea\u9700\u8981\u4fee\u6539\u4e00\u4e2a\u955c\u50cf\u7248\u672c\u5373\u53ef. image: repository: juicedata/juicefs-csi-driver tag: \"v0.22.0\" # \u4fee\u6539\u4e3a\u6700\u65b0\u7248\u5373\u53ef pullPolicy: \"\" \u6587\u7ae0\u53c2\u8003: \u00b6 juicefs \u5b98\u65b9\u6587\u6863 redis cluster \u6587\u7ae0 minio \u5b98\u65b9\u6587\u6863 juicefs \u5347\u7ea7\u6587\u6863","title":"Juicefs\u5b58\u50a8\u65b9\u6848"},{"location":"5.Storage/Juicefs/#juicefs","text":"JuiceFS \u662f\u4e00\u6b3e\u9762\u5411\u4e91\u539f\u751f\u8bbe\u8ba1\u7684\u9ad8\u6027\u80fd\u5206\u5e03\u5f0f\u6587\u4ef6\u7cfb\u7edf\uff0c\u5728 Apache 2.0 \u5f00\u6e90\u534f\u8bae\u4e0b\u53d1\u5e03\u3002\u63d0\u4f9b\u5b8c\u5907\u7684 POSIX \u517c\u5bb9\u6027\uff0c\u53ef\u5c06\u51e0\u4e4e\u6240\u6709\u5bf9\u8c61\u5b58\u50a8\u63a5\u5165\u672c\u5730\u4f5c\u4e3a\u6d77\u91cf\u672c\u5730\u78c1\u76d8\u4f7f\u7528\uff0c\u4ea6\u53ef\u540c\u65f6\u5728\u8de8\u5e73\u53f0\u3001\u8de8\u5730\u533a\u7684\u4e0d\u540c\u4e3b\u673a\u4e0a\u6302\u8f7d\u8bfb\u5199\u3002 JuiceFS \u91c7\u7528\u300c\u6570\u636e\u300d\u4e0e\u300c\u5143\u6570\u636e\u300d\u5206\u79bb\u5b58\u50a8\u7684\u67b6\u6784\uff0c\u4ece\u800c\u5b9e\u73b0\u6587\u4ef6\u7cfb\u7edf\u7684\u5206\u5e03\u5f0f\u8bbe\u8ba1\u3002\u6587\u4ef6\u6570\u636e\u672c\u8eab\u4f1a\u88ab\u5207\u5206\u4fdd\u5b58\u5728 \u5bf9\u8c61\u5b58\u50a8 \uff08\u4f8b\u5982 Amazon S3\uff09\uff0c\u800c\u5143\u6570\u636e\u5219\u53ef\u4ee5\u4fdd\u5b58\u5728 Redis\u3001MySQL\u3001TiKV\u3001SQLite \u7b49\u591a\u79cd \u6570\u636e\u5e93 \u4e2d\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u573a\u666f\u4e0e\u6027\u80fd\u8981\u6c42\u8fdb\u884c\u9009\u62e9\u3002 JuiceFS \u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684 API\uff0c\u9002\u7528\u4e8e\u5404\u79cd\u5f62\u5f0f\u6570\u636e\u7684\u7ba1\u7406\u3001\u5206\u6790\u3001\u5f52\u6863\u3001\u5907\u4efd\uff0c\u53ef\u4ee5\u5728\u4e0d\u4fee\u6539\u4ee3\u7801\u7684\u524d\u63d0\u4e0b\u65e0\u7f1d\u5bf9\u63a5\u5927\u6570\u636e\u3001\u673a\u5668\u5b66\u4e60\u3001\u4eba\u5de5\u667a\u80fd\u7b49\u5e94\u7528\u5e73\u53f0\uff0c\u4e3a\u5176\u63d0\u4f9b\u6d77\u91cf\u3001\u5f39\u6027\u3001\u4f4e\u4ef7\u7684\u9ad8\u6027\u80fd\u5b58\u50a8\u3002\u8fd0\u7ef4\u4eba\u5458\u4e0d\u7528\u518d\u4e3a\u53ef\u7528\u6027\u3001\u707e\u96be\u6062\u590d\u3001\u76d1\u63a7\u3001\u6269\u5bb9\u7b49\u5de5\u4f5c\u70e6\u607c\uff0c\u4e13\u6ce8\u4e8e\u4e1a\u52a1\u5f00\u53d1\uff0c\u63d0\u5347\u7814\u53d1\u6548\u7387\u3002\u540c\u65f6\u8fd0\u7ef4\u7ec6\u8282\u7684\u7b80\u5316\uff0c\u5bf9 DevOps \u6781\u5176\u53cb\u597d\u3002","title":"Juicefs \u5b58\u50a8\u4ecb\u7ecd"},{"location":"5.Storage/Juicefs/#_1","text":"POSIX \u517c\u5bb9 \uff1a\u50cf\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e00\u6837\u4f7f\u7528\uff0c\u65e0\u7f1d\u5bf9\u63a5\u5df2\u6709\u5e94\u7528\uff0c\u65e0\u4e1a\u52a1\u4fb5\u5165\u6027\uff1b HDFS \u517c\u5bb9 \uff1a\u5b8c\u6574\u517c\u5bb9 HDFS API \uff0c\u63d0\u4f9b\u66f4\u5f3a\u7684\u5143\u6570\u636e\u6027\u80fd\uff1b S3 \u517c\u5bb9 \uff1a\u63d0\u4f9b S3 \u7f51\u5173 \u5b9e\u73b0 S3 \u534f\u8bae\u517c\u5bb9\u7684\u8bbf\u95ee\u63a5\u53e3\uff1b \u4e91\u539f\u751f \uff1a\u901a\u8fc7 Kubernetes CSI \u9a71\u52a8 \u8f7b\u677e\u5730\u5728 Kubernetes \u4e2d\u4f7f\u7528 JuiceFS\uff1b \u5206\u5e03\u5f0f\u8bbe\u8ba1 \uff1a\u540c\u4e00\u6587\u4ef6\u7cfb\u7edf\u53ef\u5728\u4e0a\u5343\u53f0\u670d\u52a1\u5668\u540c\u65f6\u6302\u8f7d\uff0c\u9ad8\u6027\u80fd\u5e76\u53d1\u8bfb\u5199\uff0c\u5171\u4eab\u6570\u636e\uff1b \u5f3a\u4e00\u81f4\u6027 \uff1a\u786e\u8ba4\u7684\u6587\u4ef6\u4fee\u6539\u4f1a\u5728\u6240\u6709\u670d\u52a1\u5668\u4e0a\u7acb\u5373\u53ef\u89c1\uff0c\u4fdd\u8bc1\u5f3a\u4e00\u81f4\u6027\uff1b \u5f3a\u608d\u6027\u80fd \uff1a\u6beb\u79d2\u7ea7\u5ef6\u8fdf\uff0c\u8fd1\u4e4e\u65e0\u9650\u7684\u541e\u5410\u91cf\uff08\u53d6\u51b3\u4e8e\u5bf9\u8c61\u5b58\u50a8\u89c4\u6a21\uff09\uff0c\u67e5\u770b \u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c \uff1b \u6570\u636e\u5b89\u5168 \uff1a\u652f\u6301\u4f20\u8f93\u4e2d\u52a0\u5bc6\uff08encryption in transit\uff09\u548c\u9759\u6001\u52a0\u5bc6\uff08encryption at rest\uff09\uff0c \u67e5\u770b\u8be6\u60c5 \uff1b \u6587\u4ef6\u9501 \uff1a\u652f\u6301 BSD \u9501\uff08flock\uff09\u548c POSIX \u9501\uff08fcntl\uff09\uff1b \u6570\u636e\u538b\u7f29 \uff1a\u652f\u6301 LZ4 \u548c Zstandard \u538b\u7f29\u7b97\u6cd5\uff0c\u8282\u7701\u5b58\u50a8\u7a7a\u95f4\u3002","title":"\u6838\u5fc3\u7279\u6027"},{"location":"5.Storage/Juicefs/#_2","text":"JuiceFS \u4e3a\u6d77\u91cf\u6570\u636e\u5b58\u50a8\u8bbe\u8ba1\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u5f88\u591a\u5206\u5e03\u5f0f\u6587\u4ef6\u7cfb\u7edf\u548c\u7f51\u7edc\u6587\u4ef6\u7cfb\u7edf\u7684\u66ff\u4ee3\uff0c\u7279\u522b\u662f\u4ee5\u4e0b\u573a\u666f\uff1a \u5927\u6570\u636e\u5206\u6790\uff1aHDFS \u517c\u5bb9\uff1b\u4e0e\u4e3b\u6d41\u8ba1\u7b97\u5f15\u64ce\uff08Spark\u3001Presto\u3001Hive \u7b49\uff09\u65e0\u7f1d\u8854\u63a5\uff1b\u65e0\u9650\u6269\u5c55\u7684\u5b58\u50a8\u7a7a\u95f4\uff1b\u8fd0\u7ef4\u6210\u672c\u51e0\u4e4e\u4e3a 0\uff1b\u6027\u80fd\u8fdc\u597d\u4e8e\u76f4\u63a5\u5bf9\u63a5\u5bf9\u8c61\u5b58\u50a8\u3002 \u673a\u5668\u5b66\u4e60\uff1aPOSIX \u517c\u5bb9\uff0c\u53ef\u4ee5\u652f\u6301\u6240\u6709\u673a\u5668\u5b66\u4e60\u3001\u6df1\u5ea6\u5b66\u4e60\u6846\u67b6\uff1b\u65b9\u4fbf\u7684\u6587\u4ef6\u5171\u4eab\u8fd8\u80fd\u63d0\u5347\u56e2\u961f\u7ba1\u7406\u3001\u4f7f\u7528\u6570\u636e\u6548\u7387\u3002 Kubernetes\uff1aJuiceFS \u652f\u6301 Kubernetes CSI\uff1b\u4e3a\u5bb9\u5668\u63d0\u4f9b\u89e3\u8026\u7684\u6587\u4ef6\u5b58\u50a8\uff0c\u4ee4\u5e94\u7528\u670d\u52a1\u53ef\u4ee5\u65e0\u72b6\u6001\u5316\uff1b\u65b9\u4fbf\u5730\u5728\u5bb9\u5668\u95f4\u5171\u4eab\u6570\u636e\u3002 \u5171\u4eab\u5de5\u4f5c\u533a\uff1a\u53ef\u4ee5\u5728\u4efb\u610f\u4e3b\u673a\u6302\u8f7d\uff1b\u6ca1\u6709\u5ba2\u6237\u7aef\u5e76\u53d1\u8bfb\u5199\u9650\u5236\uff1bPOSIX \u517c\u5bb9\u5df2\u6709\u7684\u6570\u636e\u6d41\u548c\u811a\u672c\u64cd\u4f5c\u3002 \u6570\u636e\u5907\u4efd\uff1a\u5728\u65e0\u9650\u5e73\u6ed1\u6269\u5c55\u7684\u5b58\u50a8\u7a7a\u95f4\u5907\u4efd\u5404\u79cd\u6570\u636e\uff0c\u7ed3\u5408\u5171\u4eab\u6302\u8f7d\u529f\u80fd\uff0c\u53ef\u4ee5\u5c06\u591a\u4e3b\u673a\u6570\u636e\u6c47\u603b\u81f3\u4e00\u5904\uff0c\u505a\u7edf\u4e00\u5907\u4efd\u3002","title":"\u5e94\u7528\u573a\u666f"},{"location":"5.Storage/Juicefs/#_3","text":"JuiceFS \u6587\u4ef6\u7cfb\u7edf\u7531\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a JuiceFS \u5ba2\u6237\u7aef\uff08Client\uff09 \uff1a\u6240\u6709\u6587\u4ef6\u8bfb\u5199\uff0c\u4ee5\u53ca\u788e\u7247\u5408\u5e76\u3001\u56de\u6536\u7ad9\u6587\u4ef6\u8fc7\u671f\u5220\u9664\u7b49\u540e\u53f0\u4efb\u52a1\uff0c\u5747\u5728\u5ba2\u6237\u7aef\u4e2d\u53d1\u751f\u3002\u5ba2\u6237\u7aef\u9700\u8981\u540c\u65f6\u4e0e\u5bf9\u8c61\u5b58\u50a8\u548c\u5143\u6570\u636e\u5f15\u64ce\u6253\u4ea4\u9053\u3002\u5ba2\u6237\u7aef\u652f\u6301\u591a\u79cd\u63a5\u5165\u65b9\u5f0f\uff1a \u901a\u8fc7 FUSE \uff0cJuiceFS \u6587\u4ef6\u7cfb\u7edf\u80fd\u591f\u4ee5 POSIX \u517c\u5bb9\u7684\u65b9\u5f0f\u6302\u8f7d\u5230\u670d\u52a1\u5668\uff0c\u5c06\u6d77\u91cf\u4e91\u7aef\u5b58\u50a8\u76f4\u63a5\u5f53\u505a\u672c\u5730\u5b58\u50a8\u6765\u4f7f\u7528\u3002 \u901a\u8fc7 Hadoop Java SDK \uff0cJuiceFS \u6587\u4ef6\u7cfb\u7edf\u80fd\u591f\u76f4\u63a5\u66ff\u4ee3 HDFS\uff0c\u4e3a Hadoop \u63d0\u4f9b\u4f4e\u6210\u672c\u7684\u6d77\u91cf\u5b58\u50a8\u3002 \u901a\u8fc7 Kubernetes CSI \u9a71\u52a8 \uff0cJuiceFS \u6587\u4ef6\u7cfb\u7edf\u80fd\u591f\u76f4\u63a5\u4e3a Kubernetes \u63d0\u4f9b\u6d77\u91cf\u5b58\u50a8\u3002 \u901a\u8fc7 S3 \u7f51\u5173 \uff0c\u4f7f\u7528 S3 \u4f5c\u4e3a\u5b58\u50a8\u5c42\u7684\u5e94\u7528\u53ef\u76f4\u63a5\u63a5\u5165\uff0c\u540c\u65f6\u53ef\u4f7f\u7528 AWS CLI\u3001s3cmd\u3001MinIO client \u7b49\u5de5\u5177\u8bbf\u95ee JuiceFS \u6587\u4ef6\u7cfb\u7edf\u3002 \u901a\u8fc7 WebDAV \u670d\u52a1 \uff0c\u4ee5 HTTP \u534f\u8bae\uff0c\u4ee5\u7c7b\u4f3c RESTful API \u7684\u65b9\u5f0f\u63a5\u5165 JuiceFS \u5e76\u76f4\u63a5\u64cd\u4f5c\u5176\u4e2d\u7684\u6587\u4ef6\u3002 \u6570\u636e\u5b58\u50a8\uff08Data Storage\uff09 \uff1a\u6587\u4ef6\u5c06\u4f1a\u88ab\u5207\u5206\u4e0a\u4f20\u81f3\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002JuiceFS \u652f\u6301\u51e0\u4e4e\u6240\u6709\u7684\u516c\u6709\u4e91\u5bf9\u8c61\u5b58\u50a8\uff0c\u540c\u65f6\u4e5f\u652f\u6301 OpenStack Swift\u3001Ceph\u3001MinIO \u7b49\u79c1\u6709\u5316\u7684\u5bf9\u8c61\u5b58\u50a8\u3002 \u5143\u6570\u636e\u5f15\u64ce\uff08Metadata Engine\uff09 \uff1a\u7528\u4e8e\u5b58\u50a8\u6587\u4ef6\u5143\u6570\u636e\uff08metadata\uff09\uff0c\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5e38\u89c4\u6587\u4ef6\u7cfb\u7edf\u7684\u5143\u6570\u636e\uff1a\u6587\u4ef6\u540d\u3001\u6587\u4ef6\u5927\u5c0f\u3001\u6743\u9650\u4fe1\u606f\u3001\u521b\u5efa\u4fee\u6539\u65f6\u95f4\u3001\u76ee\u5f55\u7ed3\u6784\u3001\u6587\u4ef6\u5c5e\u6027\u3001\u7b26\u53f7\u94fe\u63a5\u3001\u6587\u4ef6\u9501\u7b49\u3002 \u6587\u4ef6\u6570\u636e\u7684\u7d22\u5f15\uff1a\u6587\u4ef6\u7684\u6570\u636e\u5206\u914d\u548c\u5f15\u7528\u8ba1\u6570\u3001\u5ba2\u6237\u7aef\u4f1a\u8bdd\u7b49\u3002","title":"\u6280\u672f\u67b6\u6784"},{"location":"5.Storage/Juicefs/#_4","text":"\u73af\u5883\u8981\u6c42 \u8fd9\u91cc\u505a dome \u5b9e\u9a8c,\u6240\u4ee5\u53ef\u7528 k3s \u4f5c\u4e3a\u5b9e\u9a8c\u73af\u5883,\u5229\u7528k3s\u81ea\u5e26\u7684local-path,\u4f5c\u4e3a redis-cluster\u7684\u5757\u5b58\u50a8,\u540e\u7aef\u4f7f\u7528 minio \u4f5c\u4e3a juicefs \u5bf9\u63a5\u7684s3\u5b58\u50a8 \u90e8\u7f72\u65b9\u5f0f: \u65b9\u5f0f\u4e00: \u5728 K3s \u4e0a\u4f7f\u7528 JuiceFS (\u6d4b\u8bd5\u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f,\u6bd4\u8f83\u7b80\u5355) \u65b9\u5f0f\u4e8c: \u5b98\u65b9\u63a8\u8350helm\u65b9\u5f0f\u90e8\u7f72 (\u751f\u4ea7\u73af\u5883\u5f3a\u70c8\u63a8\u8350\u8fd9\u79cd) \u4f18\u5316\u65b9\u6cd5: \u53ef\u4ee5\u53c2\u8003\u6211\u5199\u7684\u4e00\u4e2a pr \u5bf9\u5df2\u7ecf\u5b89\u88c5\u7684 juicefs \u8fdb\u884c\u4f18\u5316","title":"\u73af\u5883\u90e8\u7f72"},{"location":"5.Storage/Juicefs/#juicefs_1","text":"\u53ef\u4ee5\u53c2\u8003 juicefs \u5b98\u65b9\u63a8\u8350 helm \u65b9\u5f0f\u6765\u5347\u7ea7,\u6587\u7ae0\u53c2\u8003:https://juicefs.com/docs/zh/csi/upgrade-csi-driver helm repo update helm upgrade juicefs-csi-driver juicefs/juicefs-csi-driver -n kube-system -f ./values.yaml \u6211\u662f\u4ece 1.1 beta \u7248\u672c\u5347\u7ea7,\u5176\u4e2d values \u4e2d\u53ea\u9700\u8981\u4fee\u6539\u4e00\u4e2a\u955c\u50cf\u7248\u672c\u5373\u53ef. image: repository: juicedata/juicefs-csi-driver tag: \"v0.22.0\" # \u4fee\u6539\u4e3a\u6700\u65b0\u7248\u5373\u53ef pullPolicy: \"\"","title":"Juicefs\u5347\u7ea7"},{"location":"5.Storage/Juicefs/#_5","text":"juicefs \u5b98\u65b9\u6587\u6863 redis cluster \u6587\u7ae0 minio \u5b98\u65b9\u6587\u6863 juicefs \u5347\u7ea7\u6587\u6863","title":"\u6587\u7ae0\u53c2\u8003:"},{"location":"5.Storage/ceph-base/","text":"","title":"ceph \u57fa\u7840"},{"location":"5.Storage/ceph-bucket/","text":"\u5bf9\u8c61\u5b58\u50a8 \u00b6 \u67e5\u770bbucket root@rbd-demo-c5fc7f94-whscz:~# s3cmd ls 2023-08-12 17:18 s3://ceph-bkt-a0842637-c874-4dc7-b0d5-639d6aa825a2","title":"ceph \u5bf9\u8c61\u5b58\u50a8"},{"location":"5.Storage/ceph-bucket/#_1","text":"\u67e5\u770bbucket root@rbd-demo-c5fc7f94-whscz:~# s3cmd ls 2023-08-12 17:18 s3://ceph-bkt-a0842637-c874-4dc7-b0d5-639d6aa825a2","title":"\u5bf9\u8c61\u5b58\u50a8"},{"location":"5.Storage/ceph-cli-docs/","text":"\u524d\u8a00 \u00b6 Ceph\u662f\u4e00\u79cd\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u7528\u4e8e\u5b58\u50a8\u548c\u7ba1\u7406\u6d77\u91cf\u6570\u636e\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u5e38\u7528\u7684ceph\u547d\u4ee4\u6848\u4f8b\uff1a Ceph \u76f8\u5173\u547d\u4ee4 \u00b6 \u64cd\u4f5c \u547d\u4ee4 \u67e5\u770b cluster \u72b6\u6001 ceph -s \u67e5\u770b\u6240\u6709 pool ceph osd lspools \u5220\u9664 pool ceph osd pool delete {pool-name} [{pool-name} --yes-i-really-really-mean-it] \u8bbe\u7f6e pool \u526f\u672c\u6570\u91cf ceph osd pool set .mgr size 1 --yes-i-really-mean-it \u67e5\u770b pool \u526f\u672c\u6570\u91cf ceph osd pool get <pool-name> size \u67e5\u770b ceph \u96c6\u7fa4\u4e2d\u6bcf\u4e2a pool \u7684\u526f\u672c\u6570\u91cf ceph osd pool ls detail \u67e5\u770b ceph \u7ec4\u4ef6\u7248\u672c ceph versions \u67e5\u770b pool \u4f7f\u7528\u7387 ceph df \u67e5\u770b\u96c6\u7fa4\u5b58\u50a8\u72b6\u6001\u8be6\u60c5 ceph df detail \u67e5\u770b OSD \u7684\u72b6\u6001 ceph osd stat \u67e5\u770b OSD \u7684\u8be6\u7ec6\u72b6\u6001 ceph osd dump \u67e5\u770b mon \u8282\u70b9\u72b6\u6001 ceph mon stat \u67e5\u770b mon \u8282\u70b9\u7684 dump \u4fe1\u606f ceph mon dump \u505c\u6b62\u6216\u91cd\u542f Ceph \u96c6\u7fa4 ceph osd set noout ceph osd unset noout \u67e5\u770b cephfs \u670d\u52a1\u72b6\u6001 ceph mds stat \u4fee\u590d PG \u547d\u4ee4 ceph pg dump | grep unknown ceph osd force-create-pg <pgid> \u67e5\u770b PG \u72b6\u6001 ceph pg stat OSD \u76f8\u5173\u547d\u4ee4 \u00b6 \u64cd\u4f5c \u547d\u4ee4 \u67e5\u770b OSD \u5217\u8868 ceph osd tree \u67e5\u770b PG \u72b6\u6001 ceph pg stat \u67e5\u770b\u7279\u5b9a PG \u72b6\u6001 ceph pg <pg-id> query \u67e5\u770b\u6570\u636e\u7edf\u8ba1\u4fe1\u606f ceph df \u67e5\u770b\u96c6\u7fa4\u72b6\u6001\u6458\u8981 ceph status \u67e5\u770b\u96c6\u7fa4\u76d1\u89c6\u5668\u72b6\u6001 ceph mon stat \u67e5\u770b\u7279\u5b9a OSD \u72b6\u6001 ceph osd status <osd-id>","title":"ceph \u547d\u4ee4\u7528\u6cd5"},{"location":"5.Storage/ceph-cli-docs/#_1","text":"Ceph\u662f\u4e00\u79cd\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u7528\u4e8e\u5b58\u50a8\u548c\u7ba1\u7406\u6d77\u91cf\u6570\u636e\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u5e38\u7528\u7684ceph\u547d\u4ee4\u6848\u4f8b\uff1a","title":"\u524d\u8a00"},{"location":"5.Storage/ceph-cli-docs/#ceph","text":"\u64cd\u4f5c \u547d\u4ee4 \u67e5\u770b cluster \u72b6\u6001 ceph -s \u67e5\u770b\u6240\u6709 pool ceph osd lspools \u5220\u9664 pool ceph osd pool delete {pool-name} [{pool-name} --yes-i-really-really-mean-it] \u8bbe\u7f6e pool \u526f\u672c\u6570\u91cf ceph osd pool set .mgr size 1 --yes-i-really-mean-it \u67e5\u770b pool \u526f\u672c\u6570\u91cf ceph osd pool get <pool-name> size \u67e5\u770b ceph \u96c6\u7fa4\u4e2d\u6bcf\u4e2a pool \u7684\u526f\u672c\u6570\u91cf ceph osd pool ls detail \u67e5\u770b ceph \u7ec4\u4ef6\u7248\u672c ceph versions \u67e5\u770b pool \u4f7f\u7528\u7387 ceph df \u67e5\u770b\u96c6\u7fa4\u5b58\u50a8\u72b6\u6001\u8be6\u60c5 ceph df detail \u67e5\u770b OSD \u7684\u72b6\u6001 ceph osd stat \u67e5\u770b OSD \u7684\u8be6\u7ec6\u72b6\u6001 ceph osd dump \u67e5\u770b mon \u8282\u70b9\u72b6\u6001 ceph mon stat \u67e5\u770b mon \u8282\u70b9\u7684 dump \u4fe1\u606f ceph mon dump \u505c\u6b62\u6216\u91cd\u542f Ceph \u96c6\u7fa4 ceph osd set noout ceph osd unset noout \u67e5\u770b cephfs \u670d\u52a1\u72b6\u6001 ceph mds stat \u4fee\u590d PG \u547d\u4ee4 ceph pg dump | grep unknown ceph osd force-create-pg <pgid> \u67e5\u770b PG \u72b6\u6001 ceph pg stat","title":"Ceph \u76f8\u5173\u547d\u4ee4"},{"location":"5.Storage/ceph-cli-docs/#osd","text":"\u64cd\u4f5c \u547d\u4ee4 \u67e5\u770b OSD \u5217\u8868 ceph osd tree \u67e5\u770b PG \u72b6\u6001 ceph pg stat \u67e5\u770b\u7279\u5b9a PG \u72b6\u6001 ceph pg <pg-id> query \u67e5\u770b\u6570\u636e\u7edf\u8ba1\u4fe1\u606f ceph df \u67e5\u770b\u96c6\u7fa4\u72b6\u6001\u6458\u8981 ceph status \u67e5\u770b\u96c6\u7fa4\u76d1\u89c6\u5668\u72b6\u6001 ceph mon stat \u67e5\u770b\u7279\u5b9a OSD \u72b6\u6001 ceph osd status <osd-id>","title":"OSD \u76f8\u5173\u547d\u4ee4"},{"location":"5.Storage/ceph-error/","text":"mgr pool \u526f\u672c\u8c03\u6574 \u00b6 ceph \u96c6\u7fa4\u9ed8\u8ba4\u5b89\u88c5\u597d\u6709 .mgr \u8fd9\u6837\u7684\u4e00\u4e2a\u6c60,\u800c\u4ed6\u9ed8\u8ba4\u7684\u526f\u672c\u662f\u4e09\u4e2a,\u6240\u4ee5\u4f1a\u5728\u6709\u4e9b\u573a\u666f\u4e0d\u9002\u7528 ceph osd pool set .mgr size 1 --yes-i-really-mean-it ceph \u5b58\u50a8pool\u65e0\u6cd5\u521b\u5efa \u00b6 \u62a5\u9519\u63d0\u793a: Warning ReconcileFailed 28s (x14 over 73s) rook-ceph-block-pool-controller failed to reconcile CephBlockPool \"rook-ceph/replicapool\". invalid pool CR \"replicapool\" spec: error pool size is 1 and requireSafeReplicaSize is true, must be false \u5728\u6211\u4eec\u4f7f\u7528ceph\u96c6\u7fa4\u521b\u5efapool\u65f6\uff0c\u6709\u65f6\u5019\u53ef\u80fd\u4f1a\u5bf9\u526f\u672c\u7684\u6570\u91cf\u505a\u4e00\u4e9b\u8c03\u6574\uff0c\u4f8b\u5982\u5c063\u8c03\u6574\u4e3a1\uff08\u4f46\u662f\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u7684\u62a5\u9519\uff09 \u89e3\u51b3\u65b9\u6cd5: \u8fd9\u4e2a\u9519\u8bef\u662f\u7531\u4e8e\u5c06\u526f\u672c\u8c03\u6574\u4e3a1\uff0c\u9700\u8981\u5c06 requireSafeReplicaSize \u6539\u6210 false \u8fd9\u6837\u624d\u80fd\u6b63\u786e\u7684\u521b\u5efapool \u4fee\u590dunknown PG \u00b6 # \u5217\u51fa\u72b6\u6001\u4e3a unkown \u7684 PG, \u7b2c\u4e00\u5217\u4e3a pgid $ ceph pg dump | grep unknown # \u5f3a\u5236\u91cd\u5efa PG\uff0c\u6ce8\uff1a\u4f1a\u4e22\u5931\u6570\u636e\uff0c\u614e\u91cd\u4f7f\u7528 $ ceph osd force-create-pg <pgid>","title":"ceph \u9519\u8bef\u6307\u5357"},{"location":"5.Storage/ceph-error/#mgr-pool","text":"ceph \u96c6\u7fa4\u9ed8\u8ba4\u5b89\u88c5\u597d\u6709 .mgr \u8fd9\u6837\u7684\u4e00\u4e2a\u6c60,\u800c\u4ed6\u9ed8\u8ba4\u7684\u526f\u672c\u662f\u4e09\u4e2a,\u6240\u4ee5\u4f1a\u5728\u6709\u4e9b\u573a\u666f\u4e0d\u9002\u7528 ceph osd pool set .mgr size 1 --yes-i-really-mean-it","title":"mgr pool \u526f\u672c\u8c03\u6574"},{"location":"5.Storage/ceph-error/#ceph-pool","text":"\u62a5\u9519\u63d0\u793a: Warning ReconcileFailed 28s (x14 over 73s) rook-ceph-block-pool-controller failed to reconcile CephBlockPool \"rook-ceph/replicapool\". invalid pool CR \"replicapool\" spec: error pool size is 1 and requireSafeReplicaSize is true, must be false \u5728\u6211\u4eec\u4f7f\u7528ceph\u96c6\u7fa4\u521b\u5efapool\u65f6\uff0c\u6709\u65f6\u5019\u53ef\u80fd\u4f1a\u5bf9\u526f\u672c\u7684\u6570\u91cf\u505a\u4e00\u4e9b\u8c03\u6574\uff0c\u4f8b\u5982\u5c063\u8c03\u6574\u4e3a1\uff08\u4f46\u662f\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u7684\u62a5\u9519\uff09 \u89e3\u51b3\u65b9\u6cd5: \u8fd9\u4e2a\u9519\u8bef\u662f\u7531\u4e8e\u5c06\u526f\u672c\u8c03\u6574\u4e3a1\uff0c\u9700\u8981\u5c06 requireSafeReplicaSize \u6539\u6210 false \u8fd9\u6837\u624d\u80fd\u6b63\u786e\u7684\u521b\u5efapool","title":"ceph \u5b58\u50a8pool\u65e0\u6cd5\u521b\u5efa"},{"location":"5.Storage/ceph-error/#unknown-pg","text":"# \u5217\u51fa\u72b6\u6001\u4e3a unkown \u7684 PG, \u7b2c\u4e00\u5217\u4e3a pgid $ ceph pg dump | grep unknown # \u5f3a\u5236\u91cd\u5efa PG\uff0c\u6ce8\uff1a\u4f1a\u4e22\u5931\u6570\u636e\uff0c\u614e\u91cd\u4f7f\u7528 $ ceph osd force-create-pg <pgid>","title":"\u4fee\u590dunknown PG"},{"location":"5.Storage/ceph-tools/","text":"\u5916\u90e8\u73af\u5883\u8bbf\u95ee\u96c6\u7fa4 \u00b6 \u6211\u4eec\u5728\u5f88\u591a\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u5728\u5916\u90e8\u73af\u5883\u6765\u8bbf\u95ee\u6211\u4eec\u7684ceph\u96c6\u7fa4\uff0c\u4f8b\u5982\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6pod\uff0c\u6216\u8005\u5bbf\u4e3b\u673a\u3002 \u5982\u679c\u60f3\u8bbf\u95ee\u5206\u4e3a\u4e24\u4e2a\u6b65\u9aa4: \u5bfc\u5165ceph\u914d\u7f6e(\u8fd9\u4e2aceph\u7684\u914d\u7f6etoolbox pod\u4e2d\u5c31\u80fd\u627e\u7684\u5230) \u5b89\u88c5ceph-common cli \u5de5\u5177 1.\u4ecetoolbox\u4e2d\u83b7\u53d6ceph\u914d\u7f6e bash-4.4$ cat /etc/ceph/ ceph.conf keyring bash-4.4$ cat /etc/ceph/ceph.conf # ceph \u914d\u7f6e\u6587\u4ef6 [global] mon_host = 10.97.15.89:6789,10.97.9.169:6789,10.97.2.200:6789 [client.admin] keyring = /etc/ceph/keyring # ceph \u8ba4\u8bc1\u6587\u4ef6 bash-4.4$ cat /etc/ceph/keyring [client.admin] key = AQBGEdZk3xCOGBAAAHw7ddjuvvEZwNeqab7d4Q== 2.\u5b89\u88c5ceph-common [pre] root@m1:~# sudo apt install ceph-common","title":"ceph \u5916\u90e8\u73af\u5883\u8fde\u63a5\u96c6\u7fa4"},{"location":"5.Storage/ceph-tools/#_1","text":"\u6211\u4eec\u5728\u5f88\u591a\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u5728\u5916\u90e8\u73af\u5883\u6765\u8bbf\u95ee\u6211\u4eec\u7684ceph\u96c6\u7fa4\uff0c\u4f8b\u5982\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6pod\uff0c\u6216\u8005\u5bbf\u4e3b\u673a\u3002 \u5982\u679c\u60f3\u8bbf\u95ee\u5206\u4e3a\u4e24\u4e2a\u6b65\u9aa4: \u5bfc\u5165ceph\u914d\u7f6e(\u8fd9\u4e2aceph\u7684\u914d\u7f6etoolbox pod\u4e2d\u5c31\u80fd\u627e\u7684\u5230) \u5b89\u88c5ceph-common cli \u5de5\u5177 1.\u4ecetoolbox\u4e2d\u83b7\u53d6ceph\u914d\u7f6e bash-4.4$ cat /etc/ceph/ ceph.conf keyring bash-4.4$ cat /etc/ceph/ceph.conf # ceph \u914d\u7f6e\u6587\u4ef6 [global] mon_host = 10.97.15.89:6789,10.97.9.169:6789,10.97.2.200:6789 [client.admin] keyring = /etc/ceph/keyring # ceph \u8ba4\u8bc1\u6587\u4ef6 bash-4.4$ cat /etc/ceph/keyring [client.admin] key = AQBGEdZk3xCOGBAAAHw7ddjuvvEZwNeqab7d4Q== 2.\u5b89\u88c5ceph-common [pre] root@m1:~# sudo apt install ceph-common","title":"\u5916\u90e8\u73af\u5883\u8bbf\u95ee\u96c6\u7fa4"},{"location":"5.Storage/cephfs-docs/","text":"","title":"ceph \u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528"},{"location":"5.Storage/clean-ceph-docs/","text":"\u6709\u5f88\u591a\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u6e05\u7406\u6574\u4e2aceph\u96c6\u7fa4\u73af\u5883\uff0c\u5305\u62ec\u4e00\u4e9bcrd\u8d44\u6e90\uff0cnamespace\uff0c\u4ee5\u53ca /var/lib/rook \u4e0b\u7684\u5185\u5bb9\uff0c\u5f53\u7136\u5728\u6e05\u7406\u5b8c\u6574\u4e2arook-ceph\u4e4b\u540e\uff0c\u8fd8\u9700\u8981\u5bf9osd \u5df2\u7ecf\u6e05\u7406\u3002 \u5173\u4e8e\u6e05\u7406\u7684\u65b9\u6cd5: (\u5b98\u7f51\u6709\u4e00\u7bc7\u6587\u7ae0\u6765\u8bf4\u660e) \u5b98\u65b9\u6e05\u7406rook-ceph\u96c6\u7fa4 \u9488\u5bf9osd\uff0c\u5b98\u65b9\u4e5f\u7ed9\u51fa\u4e86\u4e00\u4e2ashell\u811a\u672c\uff0c\u4f46\u662f\u8fd9\u4e2a\u811a\u672c\u53ea\u80fd\u6e05\u7406\u5355\u4e2a\u78c1\u76d8\uff0c\u5bf9\u6b64\u53ef\u4ee5\u5bf9\u8fd9\u4e2a\u811a\u672c\u505a\u4e00\u4e9b\u4fee\u6539; \u9488\u5bf9\u6240\u4ee5nvme\u7684\u78c1\u76d8\u5c31\u8fc7\u6ee4\u51fa\u6765\uff0c\u5faa\u73af\u7684\u6e05\u7406\u3002 $ cat clear-nvme-osd.sh #!/bin/bash # Get a list of all NVMe devices devices=$(nvme list | awk '{print $1}' | grep -E '^/dev/nvme') # Loop over each device for DISK in $devices do echo \"Processing $DISK\" # Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean) sgdisk --zap-all $DISK # Wipe a large portion of the beginning of the disk to remove more LVM metadata that may be present dd if=/dev/zero of=\"$DISK\" bs=1M count=100 oflag=direct,dsync # SSDs may be better cleaned with blkdiscard instead of dd blkdiscard $DISK # Inform the OS of partition table changes partprobe $DISK done","title":"ceph \u96c6\u7fa4\u6e05\u7406"},{"location":"5.Storage/disk-ssd-docs/","text":"\u5b58\u50a8\u7684\u5206\u7c7b: \u00b6 \u5b58\u50a8\u5206\u7c7b \u00b6 \u5355\u673a\u5b58\u50a8: SCSI/IDE/SATA//SAS/USB/PCI-E/SSD/M.2 NVME \u534f\u8bae(\u63d0\u5347\u6027\u80fd) SATA/IDE: SATA ssd: https://item.jd.com/49620677951.html#crumb-wrap nvme ssd: https://item.jd.com/10070004737561.html M.2 : \u7f51\u7edc\u5b58\u50a8: NFS Samba \u56fa\u6001\u5b58\u50a8 \u00b6 \u8fd9\u6b21\u8fc1\u79fb\u673a\u623f,\u8ba9\u6211\u4e86\u89e3\u5230\u771f\u591a\u786c\u76d8\u7684\u76f8\u5173\u77e5\u8bc6,\u4e4b\u524d\u4e00\u76f4\u4f7f\u7528\u7684\u666e\u901a\u673a\u68b0\u76d8,\u4e00\u76f4\u5bf9\u56fa\u6001 ssd \u6b20\u7f3a\u4e86\u89e3,\u8fd9\u6b21\u4e5f\u5927\u6982\u4e86\u89e3\u5230\u4e86\u51e0\u79cd. \u5e38\u89c1\u56fa\u6001\u7c7b\u578b: SATA SSD\uff1a\u8fd9\u79cd SSD \u4f7f\u7528 SATA\uff08Serial ATA\uff09\u63a5\u53e3\u8fde\u63a5\u5230\u8ba1\u7b97\u673a\u4e0a\u3002\u867d\u7136 SATA SSD \u7684\u901f\u5ea6\u6bd4 NVMe SSD \u6162\uff0c\u4f46\u5b83\u4eec\u901a\u5e38\u66f4\u4fbf\u5b9c\uff0c\u4e14\u517c\u5bb9\u6027\u66f4\u597d\u3002 NVMe SSD\uff1aNVMe\uff08Non-Volatile Memory Express\uff09\u662f\u4e00\u79cd\u4e13\u4e3a SSD \u8bbe\u8ba1\u7684\u63a5\u53e3\u534f\u8bae\uff0c\u80fd\u5145\u5206\u5229\u7528 SSD \u7684\u9ad8\u901f\u6027\u80fd\u3002NVMe SSD \u901a\u5e38\u8fde\u63a5\u5230\u4e3b\u677f\u7684 PCIe \u63d2\u69fd\u4e0a\uff0c\u5176\u6570\u636e\u4f20\u8f93\u901f\u5ea6\u8fdc\u8d85 SATA \u63a5\u53e3\u7684 SSD M.2 SSD\uff1aM.2 \u662f\u4e00\u79cd\u5f62\u72b6\u548c\u5c3a\u5bf8\u7684\u89c4\u683c\uff0c\u53ef\u4ee5\u652f\u6301 SATA \u6216 NVMe \u63a5\u53e3\u3002M.2 SSD \u53ef\u4ee5\u975e\u5e38\u5c0f\u5de7\uff0c\u9002\u5408\u5728\u7b14\u8bb0\u672c\u7535\u8111\u548c\u5c0f\u578b\u8ba1\u7b97\u673a\u4e2d\u4f7f\u7528\u3002 U.2 SSD\uff1aU.2 SSD \u662f\u4e00\u79cd\u4f01\u4e1a\u7ea7 SSD\uff0c\u4e3b\u8981\u7528\u4e8e\u6570\u636e\u4e2d\u5fc3\u3002U.2 \u63a5\u53e3\u652f\u6301 NVMe \u534f\u8bae\uff0c\u53ef\u4ee5\u63d0\u4f9b\u9ad8\u901f\u7684\u6570\u636e\u4f20\u8f93\u3002 \u4ee5\u4e0a\u7684\u56db\u79cd\u8fd9\u6b21\u90fd\u7528\u5230\u4e86, SATA \u76d8\u8fd9\u79cd\u78c1\u76d8\u662f\u6211\u4eec\u5e73\u65f6\u6700\u5e38\u7528\u7684\u4e00\u79cd\uff0c\u51e0\u4e4e\u53f0\u5f0f\u673a\u90fd\u662f\u652f\u6301SATA\u63a5\u53e3\u7684\u3002 https://github.com/barry-boy/note-k8s/issues/58 M.2 \u4ed6\u7684\u6837\u5b50\u5f88\u50cf\u5185\u5b58\u6761,\u4e00\u822c\u60c5\u51b5\u7528\u5728\u7b14\u8bb0\u672c\u4e2d,\u6216\u8005\u670d\u52a1\u5668\u7684\u5185\u90e8,\u5982\u56fe\u6240\u793a: NVMe SSD \uff0c\u8fd9\u79cdnvme\u7684\u76d8\u4e5f\u662f\u5f88\u5e38\u89c1\u7684\uff0c\u8fd9\u4e2a\u9700\u8981\u5b89\u88c5linux\u5b89\u88c5 nvme-tools \u5c31\u53ef\u4ee5\u4f7f\u7528 nvme list \u6765\u67e5\u770b\u4e86 U.2 SSD,\u8fd9\u79cd\u76d8\u4e00\u822c\u9700\u8981\u670d\u52a1\u5668\u63a5\u53e3\u652f\u6301\u624d\u80fd\u591f\u4f7f\u7528\u3002\u4e00\u822c\u8fd9\u79cd\u76d8\u6bd4\u8f83\u6602\u8d35\u3002 \u78c1\u76d8\u7ba1\u7406 \u00b6 \u67e5\u770b\u786c\u76d8\u7684\u8be6\u7ec6\u4fe1\u606f [ wlcb ] root@stor1:/home/openbayes# smartctl -a /dev/nvme9n1 smartctl 7 .2 2020 -12-30 r5155 [ x86_64-linux-5.15.0-79-generic ] ( local build ) Copyright ( C ) 2002 -20, Bruce Allen, Christian Franke, www.smartmontools.org === START OF INFORMATION SECTION === Model Number: WUS4BB076D7P3E3 # \u8fd9\u662f\u786c\u76d8\u7684\u578b\u53f7 Serial Number: A06460A4 # \u8fd9\u662f\u786c\u76d8\u7684\u5e8f\u5217\u53f7 Firmware Version: R1110012 # \u8fd9\u662f\u786c\u76d8\u7684\u56fa\u4ef6\u7248\u672c PCI Vendor/Subsystem ID: 0x1b96 IEEE OUI Identifier: 0x0014ee Total NVM Capacity: 7 ,681,501,126,656 [ 7 .68 TB ] # \u8fd9\u662f\u786c\u76d8\u7684\u603b\u5bb9\u91cf Unallocated NVM Capacity: 0 Controller ID: 0 NVMe Version: 1 .3 Number of Namespaces: 1 Namespace 1 Size/Capacity: 7 ,681,501,126,656 [ 7 .68 TB ] Namespace 1 Formatted LBA Size: 4096 # \u8fd9\u662f\u547d\u540d\u7a7a\u95f4 1 \u7684\u683c\u5f0f\u5316 LBA \u5927\u5c0f Namespace 1 IEEE EUI-64: 0014ee 8300ecf800 Local Time is: Wed Nov 1 17 :21:54 2023 CST Firmware Updates ( 0x19 ) : 4 Slots, Slot 1 R/O, no Reset required Optional Admin Commands ( 0x001f ) : Security Format Frmw_DL NS_Mngmt Self_Test Optional NVM Commands ( 0x005e ) : Wr_Unc DS_Mngmt Wr_Zero Sav/Sel_Feat Timestmp Log Page Attributes ( 0x03 ) : S/H_per_NS Cmd_Eff_Lg Warning Comp. Temp. Threshold: 70 Celsius # \u8fd9\u662f\u786c\u76d8\u7684\u8b66\u544a\u6e29\u5ea6\u9608\u503c Critical Comp. Temp. Threshold: 80 Celsius # \u8fd9\u662f\u786c\u76d8\u7684\u4e34\u754c\u6e29\u5ea6\u9608\u503c Namespace 1 Features ( 0x02 ) : NA_Fields Supported Power States St Op Max Active Idle RL RT WL WT Ent_Lat Ex_Lat 0 + 12 .00W - - 0 0 0 0 50 50 1 + 11 .00W - - 1 1 1 1 50 50 2 + 10 .00W - - 2 2 2 2 50 50 3 + 9 .00W - - 3 3 3 3 50 50 4 + 8 .00W - - 4 4 4 4 50 50 Supported LBA Sizes ( NSID 0x1 ) Id Fmt Data Metadt Rel_Perf 0 + 4096 0 0 1 - 512 0 0 === START OF SMART DATA SECTION === SMART overall-health self-assessment test result: PASSED # \u8fd9\u662f\u786c\u76d8\u7684\u81ea\u6211\u8bc4\u4f30\u5065\u5eb7\u68c0\u67e5\u7ed3\u679c SMART/Health Information ( NVMe Log 0x02 ) Critical Warning: 0x00 Temperature: 41 Celsius # \u8fd9\u662f\u786c\u76d8\u7684\u5f53\u524d\u6e29\u5ea6 Available Spare: 100 % # \u8fd9\u662f\u786c\u76d8\u7684\u53ef\u7528\u5907\u7528\u5bb9\u91cf\u7684\u767e\u5206\u6bd4 Available Spare Threshold: 10 % Percentage Used: 0 % # \u8fd9\u662f\u786c\u76d8\u5df2\u4f7f\u7528\u7684\u767e\u5206\u6bd4 Data Units Read: 15 ,426,092 [ 7 .89 TB ] # \u8fd9\u662f\u5df2\u8bfb\u53d6\u7684\u6570\u636e\u5355\u5143\u6570\u91cf Data Units Written: 27 ,113,736 [ 13 .8 TB ] # \u8fd9\u662f\u5df2\u5199\u5165\u7684\u6570\u636e\u5355\u5143\u6570\u91cf Host Read Commands: 104 ,197,470 Host Write Commands: 1 ,044,097,133 Controller Busy Time: 7 ,011 Power Cycles: 17 Power On Hours: 1 ,037 # \u8fd9\u662f\u786c\u76d8\u7684\u8fd0\u884c\u65f6\u95f4 Unsafe Shutdowns: 11 # \u8fd9\u662f\u4e0d\u5b89\u5168\u5173\u95ed\u7684\u6b21\u6570 Media and Data Integrity Errors: 0 Error Information Log Entries: 110 # \u8fd9\u662f\u9519\u8bef\u4fe1\u606f\u65e5\u5fd7\u6761\u76ee\u7684\u6570\u91cf Warning Comp. Temperature Time: 0 Critical Comp. Temperature Time: 0 Temperature Sensor 1 : 39 Celsius # \u8fd9\u662f\u6e29\u5ea6\u4f20\u611f\u56681\u7684\u8bfb\u6570 Error Information ( NVMe Log 0x01, 16 of 256 entries ) Num ErrCount SQId CmdId Status PELoc LBA NSID VS 0 110 0 0xf01b 0xc004 0x028 0 0 - 1 109 0 0x2014 0xc004 0x029 0 0 -","title":"\u5b58\u50a8\u5206\u7c7b"},{"location":"5.Storage/disk-ssd-docs/#_1","text":"","title":"\u5b58\u50a8\u7684\u5206\u7c7b:"},{"location":"5.Storage/disk-ssd-docs/#_2","text":"\u5355\u673a\u5b58\u50a8: SCSI/IDE/SATA//SAS/USB/PCI-E/SSD/M.2 NVME \u534f\u8bae(\u63d0\u5347\u6027\u80fd) SATA/IDE: SATA ssd: https://item.jd.com/49620677951.html#crumb-wrap nvme ssd: https://item.jd.com/10070004737561.html M.2 : \u7f51\u7edc\u5b58\u50a8: NFS Samba","title":"\u5b58\u50a8\u5206\u7c7b"},{"location":"5.Storage/disk-ssd-docs/#_3","text":"\u8fd9\u6b21\u8fc1\u79fb\u673a\u623f,\u8ba9\u6211\u4e86\u89e3\u5230\u771f\u591a\u786c\u76d8\u7684\u76f8\u5173\u77e5\u8bc6,\u4e4b\u524d\u4e00\u76f4\u4f7f\u7528\u7684\u666e\u901a\u673a\u68b0\u76d8,\u4e00\u76f4\u5bf9\u56fa\u6001 ssd \u6b20\u7f3a\u4e86\u89e3,\u8fd9\u6b21\u4e5f\u5927\u6982\u4e86\u89e3\u5230\u4e86\u51e0\u79cd. \u5e38\u89c1\u56fa\u6001\u7c7b\u578b: SATA SSD\uff1a\u8fd9\u79cd SSD \u4f7f\u7528 SATA\uff08Serial ATA\uff09\u63a5\u53e3\u8fde\u63a5\u5230\u8ba1\u7b97\u673a\u4e0a\u3002\u867d\u7136 SATA SSD \u7684\u901f\u5ea6\u6bd4 NVMe SSD \u6162\uff0c\u4f46\u5b83\u4eec\u901a\u5e38\u66f4\u4fbf\u5b9c\uff0c\u4e14\u517c\u5bb9\u6027\u66f4\u597d\u3002 NVMe SSD\uff1aNVMe\uff08Non-Volatile Memory Express\uff09\u662f\u4e00\u79cd\u4e13\u4e3a SSD \u8bbe\u8ba1\u7684\u63a5\u53e3\u534f\u8bae\uff0c\u80fd\u5145\u5206\u5229\u7528 SSD \u7684\u9ad8\u901f\u6027\u80fd\u3002NVMe SSD \u901a\u5e38\u8fde\u63a5\u5230\u4e3b\u677f\u7684 PCIe \u63d2\u69fd\u4e0a\uff0c\u5176\u6570\u636e\u4f20\u8f93\u901f\u5ea6\u8fdc\u8d85 SATA \u63a5\u53e3\u7684 SSD M.2 SSD\uff1aM.2 \u662f\u4e00\u79cd\u5f62\u72b6\u548c\u5c3a\u5bf8\u7684\u89c4\u683c\uff0c\u53ef\u4ee5\u652f\u6301 SATA \u6216 NVMe \u63a5\u53e3\u3002M.2 SSD \u53ef\u4ee5\u975e\u5e38\u5c0f\u5de7\uff0c\u9002\u5408\u5728\u7b14\u8bb0\u672c\u7535\u8111\u548c\u5c0f\u578b\u8ba1\u7b97\u673a\u4e2d\u4f7f\u7528\u3002 U.2 SSD\uff1aU.2 SSD \u662f\u4e00\u79cd\u4f01\u4e1a\u7ea7 SSD\uff0c\u4e3b\u8981\u7528\u4e8e\u6570\u636e\u4e2d\u5fc3\u3002U.2 \u63a5\u53e3\u652f\u6301 NVMe \u534f\u8bae\uff0c\u53ef\u4ee5\u63d0\u4f9b\u9ad8\u901f\u7684\u6570\u636e\u4f20\u8f93\u3002 \u4ee5\u4e0a\u7684\u56db\u79cd\u8fd9\u6b21\u90fd\u7528\u5230\u4e86, SATA \u76d8\u8fd9\u79cd\u78c1\u76d8\u662f\u6211\u4eec\u5e73\u65f6\u6700\u5e38\u7528\u7684\u4e00\u79cd\uff0c\u51e0\u4e4e\u53f0\u5f0f\u673a\u90fd\u662f\u652f\u6301SATA\u63a5\u53e3\u7684\u3002 https://github.com/barry-boy/note-k8s/issues/58 M.2 \u4ed6\u7684\u6837\u5b50\u5f88\u50cf\u5185\u5b58\u6761,\u4e00\u822c\u60c5\u51b5\u7528\u5728\u7b14\u8bb0\u672c\u4e2d,\u6216\u8005\u670d\u52a1\u5668\u7684\u5185\u90e8,\u5982\u56fe\u6240\u793a: NVMe SSD \uff0c\u8fd9\u79cdnvme\u7684\u76d8\u4e5f\u662f\u5f88\u5e38\u89c1\u7684\uff0c\u8fd9\u4e2a\u9700\u8981\u5b89\u88c5linux\u5b89\u88c5 nvme-tools \u5c31\u53ef\u4ee5\u4f7f\u7528 nvme list \u6765\u67e5\u770b\u4e86 U.2 SSD,\u8fd9\u79cd\u76d8\u4e00\u822c\u9700\u8981\u670d\u52a1\u5668\u63a5\u53e3\u652f\u6301\u624d\u80fd\u591f\u4f7f\u7528\u3002\u4e00\u822c\u8fd9\u79cd\u76d8\u6bd4\u8f83\u6602\u8d35\u3002","title":"\u56fa\u6001\u5b58\u50a8"},{"location":"5.Storage/disk-ssd-docs/#_4","text":"\u67e5\u770b\u786c\u76d8\u7684\u8be6\u7ec6\u4fe1\u606f [ wlcb ] root@stor1:/home/openbayes# smartctl -a /dev/nvme9n1 smartctl 7 .2 2020 -12-30 r5155 [ x86_64-linux-5.15.0-79-generic ] ( local build ) Copyright ( C ) 2002 -20, Bruce Allen, Christian Franke, www.smartmontools.org === START OF INFORMATION SECTION === Model Number: WUS4BB076D7P3E3 # \u8fd9\u662f\u786c\u76d8\u7684\u578b\u53f7 Serial Number: A06460A4 # \u8fd9\u662f\u786c\u76d8\u7684\u5e8f\u5217\u53f7 Firmware Version: R1110012 # \u8fd9\u662f\u786c\u76d8\u7684\u56fa\u4ef6\u7248\u672c PCI Vendor/Subsystem ID: 0x1b96 IEEE OUI Identifier: 0x0014ee Total NVM Capacity: 7 ,681,501,126,656 [ 7 .68 TB ] # \u8fd9\u662f\u786c\u76d8\u7684\u603b\u5bb9\u91cf Unallocated NVM Capacity: 0 Controller ID: 0 NVMe Version: 1 .3 Number of Namespaces: 1 Namespace 1 Size/Capacity: 7 ,681,501,126,656 [ 7 .68 TB ] Namespace 1 Formatted LBA Size: 4096 # \u8fd9\u662f\u547d\u540d\u7a7a\u95f4 1 \u7684\u683c\u5f0f\u5316 LBA \u5927\u5c0f Namespace 1 IEEE EUI-64: 0014ee 8300ecf800 Local Time is: Wed Nov 1 17 :21:54 2023 CST Firmware Updates ( 0x19 ) : 4 Slots, Slot 1 R/O, no Reset required Optional Admin Commands ( 0x001f ) : Security Format Frmw_DL NS_Mngmt Self_Test Optional NVM Commands ( 0x005e ) : Wr_Unc DS_Mngmt Wr_Zero Sav/Sel_Feat Timestmp Log Page Attributes ( 0x03 ) : S/H_per_NS Cmd_Eff_Lg Warning Comp. Temp. Threshold: 70 Celsius # \u8fd9\u662f\u786c\u76d8\u7684\u8b66\u544a\u6e29\u5ea6\u9608\u503c Critical Comp. Temp. Threshold: 80 Celsius # \u8fd9\u662f\u786c\u76d8\u7684\u4e34\u754c\u6e29\u5ea6\u9608\u503c Namespace 1 Features ( 0x02 ) : NA_Fields Supported Power States St Op Max Active Idle RL RT WL WT Ent_Lat Ex_Lat 0 + 12 .00W - - 0 0 0 0 50 50 1 + 11 .00W - - 1 1 1 1 50 50 2 + 10 .00W - - 2 2 2 2 50 50 3 + 9 .00W - - 3 3 3 3 50 50 4 + 8 .00W - - 4 4 4 4 50 50 Supported LBA Sizes ( NSID 0x1 ) Id Fmt Data Metadt Rel_Perf 0 + 4096 0 0 1 - 512 0 0 === START OF SMART DATA SECTION === SMART overall-health self-assessment test result: PASSED # \u8fd9\u662f\u786c\u76d8\u7684\u81ea\u6211\u8bc4\u4f30\u5065\u5eb7\u68c0\u67e5\u7ed3\u679c SMART/Health Information ( NVMe Log 0x02 ) Critical Warning: 0x00 Temperature: 41 Celsius # \u8fd9\u662f\u786c\u76d8\u7684\u5f53\u524d\u6e29\u5ea6 Available Spare: 100 % # \u8fd9\u662f\u786c\u76d8\u7684\u53ef\u7528\u5907\u7528\u5bb9\u91cf\u7684\u767e\u5206\u6bd4 Available Spare Threshold: 10 % Percentage Used: 0 % # \u8fd9\u662f\u786c\u76d8\u5df2\u4f7f\u7528\u7684\u767e\u5206\u6bd4 Data Units Read: 15 ,426,092 [ 7 .89 TB ] # \u8fd9\u662f\u5df2\u8bfb\u53d6\u7684\u6570\u636e\u5355\u5143\u6570\u91cf Data Units Written: 27 ,113,736 [ 13 .8 TB ] # \u8fd9\u662f\u5df2\u5199\u5165\u7684\u6570\u636e\u5355\u5143\u6570\u91cf Host Read Commands: 104 ,197,470 Host Write Commands: 1 ,044,097,133 Controller Busy Time: 7 ,011 Power Cycles: 17 Power On Hours: 1 ,037 # \u8fd9\u662f\u786c\u76d8\u7684\u8fd0\u884c\u65f6\u95f4 Unsafe Shutdowns: 11 # \u8fd9\u662f\u4e0d\u5b89\u5168\u5173\u95ed\u7684\u6b21\u6570 Media and Data Integrity Errors: 0 Error Information Log Entries: 110 # \u8fd9\u662f\u9519\u8bef\u4fe1\u606f\u65e5\u5fd7\u6761\u76ee\u7684\u6570\u91cf Warning Comp. Temperature Time: 0 Critical Comp. Temperature Time: 0 Temperature Sensor 1 : 39 Celsius # \u8fd9\u662f\u6e29\u5ea6\u4f20\u611f\u56681\u7684\u8bfb\u6570 Error Information ( NVMe Log 0x01, 16 of 256 entries ) Num ErrCount SQId CmdId Status PELoc LBA NSID VS 0 110 0 0xf01b 0xc004 0x028 0 0 - 1 109 0 0x2014 0xc004 0x029 0 0 -","title":"\u78c1\u76d8\u7ba1\u7406"},{"location":"5.Storage/expand-docs/","text":"\u5bb9\u5668\u7684\u5bb9\u91cf\u7684\u4e0d\u2f9c\u7684\u65f6\u5019\u9700\u8981\u5bf9\u5bb9\u5668\u7684\u5b58\u50a8\u7a7a\u95f4\u8fdb\u2f8f\u6269\u5bb9\uff0cRook\u9ed8\u8ba4\u63d0\u4f9b\u4e86\u4e24\u79cd\u9a71\u52a8\uff1a RBD Cephfs \u65b9\u6cd5\u4e00\uff1a \u00b6 \u8fd9\u4e24\u79cd\u9a71\u52a8\u901a\u8fc7StorageClass\u5b58\u50a8\u4f9b\u7ed9\u8005\u4e3a\u5bb9\u5668\u63d0\u4f9b\u5b58\u50a8\u7a7a\u95f4\uff0c\u540c\u65f6\u5df2\u7ecf\u2f83\u52a8\u6269\u5bb9\u7684\u80fd\u2f12\uff0c \u5176\u6d41\u7a0b\u4e3a\uff1a \u5ba2\u6237\u7aef\u901a\u8fc7PVC\u58f0\u660e\u7684\u2f45\u5f0f\u5411\u2014>StorageClass\u7533\u8bf7\u6269\u5bb9\u5bb9\u91cf\u7a7a\u95f4\u2014>\u901a\u8fc7\u9a71\u52a8\u8c03\u6574PV\u7684\u5bb9\u91cf\u2014>\u8c03\u6574\u5e95\u5c42\u7684RBD\u955c\u50cf\u5757\u5bb9\u91cf\uff0c\u6700\u7ec8\u8fbe\u5230\u5bb9\u91cf\u7684\u6269\u5c55\uff0c\u5982\u4e0b\u662f\u64cd\u4f5c\u8fc7\u7a0b\uff1a $ k edit pvc rbd-pvc -o yaml apiVersion : v1 kind : PersistentVolumeClaim metadata : annotations : kubectl.kubernetes.io/last-applied-configuration : | {\"apiVersion\":\"v1\",\"kind\":\"PersistentVolumeClaim\",\"metadata\":{\"annotations\":{},\"name\":\"rbd-pvc\",\"namespace\":\"default\"},\"spec\":{\"accessModes\":[\"ReadWriteOnce\"],\"resources\":{\"requests\":{\"storage\":\"50Gi\"}},\"storageClassName\":\"rook-ceph-block\"}} pv.kubernetes.io/bind-completed : \"yes\" pv.kubernetes.io/bound-by-controller : \"yes\" volume.beta.kubernetes.io/storage-provisioner : rook-ceph.rbd.csi.ceph.com volume.kubernetes.io/storage-provisioner : rook-ceph.rbd.csi.ceph.com creationTimestamp : \"2023-08-13T07:58:39Z\" finalizers : - kubernetes.io/pvc-protection name : rbd-pvc namespace : default resourceVersion : \"48095065\" uid : f34132d1-5a98-489d-9707-0d3f9ae9962a spec : accessModes : - ReadWriteOnce resources : requests : storage : 100Gi # \u6269\u5bb9\u540e\u7684\u5927\u5c0f storageClassName : rook-ceph-block volumeMode : Filesystem volumeName : pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a status : accessModes : - ReadWriteOnce capacity : storage : 50Gi phase : Bound $ k get pv pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a # \u6211\u4eec\u67e5\u770b pv\u53d1\u73b0\u4ee5\u540e\u6269\u5bb9\u6210\u529f NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a 100Gi RWO Delete Bound default/rbd-pvc rook-ceph-block 78d \u67e5\u770breplicapool\u4e2d\u6240\u6709\u7684\u5757 bash-4.4$ rbd ls -p replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be csi-vol-d3ab89af-5069-11ee-bfc4-4e736d2f91be \u67e5\u770bpv\u7684\u8be6\u7ec6\u4fe1\u606f $ k get pv pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a -o yaml apiVersion : v1 kind : PersistentVolume metadata : annotations : pv.kubernetes.io/provisioned-by : rook-ceph.rbd.csi.ceph.com volume.kubernetes.io/provisioner-deletion-secret-name : rook-csi-rbd-provisioner volume.kubernetes.io/provisioner-deletion-secret-namespace : rook-ceph creationTimestamp : \"2023-08-13T07:58:39Z\" finalizers : - kubernetes.io/pv-protection name : pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a resourceVersion : \"48095069\" uid : 44395629-b052-4790-8519-05c2a4a0a59d spec : accessModes : - ReadWriteOnce capacity : storage : 100Gi claimRef : apiVersion : v1 kind : PersistentVolumeClaim name : rbd-pvc namespace : default resourceVersion : \"7723736\" uid : f34132d1-5a98-489d-9707-0d3f9ae9962a csi : controllerExpandSecretRef : name : rook-csi-rbd-provisioner namespace : rook-ceph driver : rook-ceph.rbd.csi.ceph.com fsType : ext4 nodeStageSecretRef : name : rook-csi-rbd-node namespace : rook-ceph volumeAttributes : clusterID : rook-ceph imageFeatures : layering imageFormat : \"2\" imageName : csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 # pv \u5bf9\u5e94\u7684RBD\u5757 journalPool : replicapool # RBD \u6240\u5728\u7684pool pool : replicapool storage.kubernetes.io/csiProvisionerIdentity : 1691750730674-8081-rook-ceph.rbd.csi.ceph.com volumeHandle : 0001-0009-rook-ceph-0000000000000001-36c61ced-39af-11ee-821b-2e922eb2eef2 persistentVolumeReclaimPolicy : Delete storageClassName : rook-ceph-block volumeMode : Filesystem status : phase : Bound \u67e5\u770b\u5757\u6240\u5728pool\u7684\u8be6\u7ec6\u4fe1\u606f bash-4.4$ rbd -p replicapool info csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 rbd image 'csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2': size 100 GiB in 25600 objects order 22 (4 MiB objects) snapshot_count: 0 id: 1b8e31cc42074 block_name_prefix: rbd_data.1b8e31cc42074 format: 2 features: layering op_features: flags: create_timestamp: Sun Aug 13 07:58:39 2023 access_timestamp: Sun Aug 13 07:58:39 2023 modify_timestamp: Sun Aug 13 07:58:39 2023 \u65b9\u6cd5\u4e8c\uff1a \u00b6 RBD\u5757\u6269\u5bb9\u539f\u7406 PVC\u2014>PV\u2014>RBD\u5757\u2014>\u2f42\u4ef6\u7cfb\u7edf\u6269\u5bb9 1\u3001\u6269\u5bb9RBD\u955c\u50cf\u5757\u5bb9\u91cf\u2f24\u2f29 bash-4.4$ rbd -p replicapool resize csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 --size 110G # \u8c03\u6574\u5927\u5c0f Resizing image: 100% complete...done. bash-4.4$ rbd -p replicapool info csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 # \u67e5\u770b\u53d1\u73b0\u4e00\u6269\u5bb9\u6210\u529f rbd image 'csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2': size 110 GiB in 28160 objects order 22 (4 MiB objects) snapshot_count: 0 id: 1b8e31cc42074 block_name_prefix: rbd_data.1b8e31cc42074 format: 2 features: layering op_features: flags: create_timestamp: Sun Aug 13 07:58:39 2023 access_timestamp: Sun Aug 13 07:58:39 2023 modify_timestamp: Sun Aug 13 07:58:39 2023 2\u3001\u767b\u9646\u5bb9\u5668\u6240\u5728\u5bbf\u4e3b\u673a\uff0c\u6269\u5bb9\u2f42\u4ef6\u7cfb\u7edf\u7684\u5bb9\u91cf [ pre ] root@m1:~# rbd device list id pool namespace image snap device 0 replicapool csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be - /dev/rbd0 1 replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 - /dev/rbd1 [ pre ] root@m1:~# [ pre ] root@m1:~# [ pre ] root@m1:~# rbd device list | grep csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 1 replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 - /dev/rbd1 [ pre ] root@m1:~# resize2fs /dev/rbd1 resize2fs 1 .45.5 ( 07 -Jan-2020 ) Filesystem at /dev/rbd1 is mounted on /var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a/globalmount/0001-0009-rook-ceph-0000000000000001-36c61ced-39af-11ee-821b-2e922eb2eef2 ; on-line resizing required old_desc_blocks = 13 , new_desc_blocks = 14 The filesystem on /dev/rbd1 is now 28835840 ( 4k ) blocks long. [ pre ] root@m1:~# df -h | grep rbd1 # \u8fd9\u65f6\u6211\u4eec\u53d1\u73b0\u5df2\u7ecf\u6269\u5bb9\u6210\u529f /dev/rbd1 108G 3 .1G 105G 3 % /var/lib/kubelet/pods/6e0c06a7-4a42-492e-b3c5-9d9756d530f9/volumes/kubernetes.io~csi/pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a/mount \u6700\u540e\u6211\u4eec\u786e\u8ba4\u4e00\u4e0b\u53d1\u73b0\u6210\u529f\u6269\u5bb9","title":"ceph \u5b58\u50a8\u6269\u5bb9"},{"location":"5.Storage/expand-docs/#_1","text":"\u8fd9\u4e24\u79cd\u9a71\u52a8\u901a\u8fc7StorageClass\u5b58\u50a8\u4f9b\u7ed9\u8005\u4e3a\u5bb9\u5668\u63d0\u4f9b\u5b58\u50a8\u7a7a\u95f4\uff0c\u540c\u65f6\u5df2\u7ecf\u2f83\u52a8\u6269\u5bb9\u7684\u80fd\u2f12\uff0c \u5176\u6d41\u7a0b\u4e3a\uff1a \u5ba2\u6237\u7aef\u901a\u8fc7PVC\u58f0\u660e\u7684\u2f45\u5f0f\u5411\u2014>StorageClass\u7533\u8bf7\u6269\u5bb9\u5bb9\u91cf\u7a7a\u95f4\u2014>\u901a\u8fc7\u9a71\u52a8\u8c03\u6574PV\u7684\u5bb9\u91cf\u2014>\u8c03\u6574\u5e95\u5c42\u7684RBD\u955c\u50cf\u5757\u5bb9\u91cf\uff0c\u6700\u7ec8\u8fbe\u5230\u5bb9\u91cf\u7684\u6269\u5c55\uff0c\u5982\u4e0b\u662f\u64cd\u4f5c\u8fc7\u7a0b\uff1a $ k edit pvc rbd-pvc -o yaml apiVersion : v1 kind : PersistentVolumeClaim metadata : annotations : kubectl.kubernetes.io/last-applied-configuration : | {\"apiVersion\":\"v1\",\"kind\":\"PersistentVolumeClaim\",\"metadata\":{\"annotations\":{},\"name\":\"rbd-pvc\",\"namespace\":\"default\"},\"spec\":{\"accessModes\":[\"ReadWriteOnce\"],\"resources\":{\"requests\":{\"storage\":\"50Gi\"}},\"storageClassName\":\"rook-ceph-block\"}} pv.kubernetes.io/bind-completed : \"yes\" pv.kubernetes.io/bound-by-controller : \"yes\" volume.beta.kubernetes.io/storage-provisioner : rook-ceph.rbd.csi.ceph.com volume.kubernetes.io/storage-provisioner : rook-ceph.rbd.csi.ceph.com creationTimestamp : \"2023-08-13T07:58:39Z\" finalizers : - kubernetes.io/pvc-protection name : rbd-pvc namespace : default resourceVersion : \"48095065\" uid : f34132d1-5a98-489d-9707-0d3f9ae9962a spec : accessModes : - ReadWriteOnce resources : requests : storage : 100Gi # \u6269\u5bb9\u540e\u7684\u5927\u5c0f storageClassName : rook-ceph-block volumeMode : Filesystem volumeName : pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a status : accessModes : - ReadWriteOnce capacity : storage : 50Gi phase : Bound $ k get pv pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a # \u6211\u4eec\u67e5\u770b pv\u53d1\u73b0\u4ee5\u540e\u6269\u5bb9\u6210\u529f NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a 100Gi RWO Delete Bound default/rbd-pvc rook-ceph-block 78d \u67e5\u770breplicapool\u4e2d\u6240\u6709\u7684\u5757 bash-4.4$ rbd ls -p replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be csi-vol-d3ab89af-5069-11ee-bfc4-4e736d2f91be \u67e5\u770bpv\u7684\u8be6\u7ec6\u4fe1\u606f $ k get pv pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a -o yaml apiVersion : v1 kind : PersistentVolume metadata : annotations : pv.kubernetes.io/provisioned-by : rook-ceph.rbd.csi.ceph.com volume.kubernetes.io/provisioner-deletion-secret-name : rook-csi-rbd-provisioner volume.kubernetes.io/provisioner-deletion-secret-namespace : rook-ceph creationTimestamp : \"2023-08-13T07:58:39Z\" finalizers : - kubernetes.io/pv-protection name : pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a resourceVersion : \"48095069\" uid : 44395629-b052-4790-8519-05c2a4a0a59d spec : accessModes : - ReadWriteOnce capacity : storage : 100Gi claimRef : apiVersion : v1 kind : PersistentVolumeClaim name : rbd-pvc namespace : default resourceVersion : \"7723736\" uid : f34132d1-5a98-489d-9707-0d3f9ae9962a csi : controllerExpandSecretRef : name : rook-csi-rbd-provisioner namespace : rook-ceph driver : rook-ceph.rbd.csi.ceph.com fsType : ext4 nodeStageSecretRef : name : rook-csi-rbd-node namespace : rook-ceph volumeAttributes : clusterID : rook-ceph imageFeatures : layering imageFormat : \"2\" imageName : csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 # pv \u5bf9\u5e94\u7684RBD\u5757 journalPool : replicapool # RBD \u6240\u5728\u7684pool pool : replicapool storage.kubernetes.io/csiProvisionerIdentity : 1691750730674-8081-rook-ceph.rbd.csi.ceph.com volumeHandle : 0001-0009-rook-ceph-0000000000000001-36c61ced-39af-11ee-821b-2e922eb2eef2 persistentVolumeReclaimPolicy : Delete storageClassName : rook-ceph-block volumeMode : Filesystem status : phase : Bound \u67e5\u770b\u5757\u6240\u5728pool\u7684\u8be6\u7ec6\u4fe1\u606f bash-4.4$ rbd -p replicapool info csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 rbd image 'csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2': size 100 GiB in 25600 objects order 22 (4 MiB objects) snapshot_count: 0 id: 1b8e31cc42074 block_name_prefix: rbd_data.1b8e31cc42074 format: 2 features: layering op_features: flags: create_timestamp: Sun Aug 13 07:58:39 2023 access_timestamp: Sun Aug 13 07:58:39 2023 modify_timestamp: Sun Aug 13 07:58:39 2023","title":"\u65b9\u6cd5\u4e00\uff1a"},{"location":"5.Storage/expand-docs/#_2","text":"RBD\u5757\u6269\u5bb9\u539f\u7406 PVC\u2014>PV\u2014>RBD\u5757\u2014>\u2f42\u4ef6\u7cfb\u7edf\u6269\u5bb9 1\u3001\u6269\u5bb9RBD\u955c\u50cf\u5757\u5bb9\u91cf\u2f24\u2f29 bash-4.4$ rbd -p replicapool resize csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 --size 110G # \u8c03\u6574\u5927\u5c0f Resizing image: 100% complete...done. bash-4.4$ rbd -p replicapool info csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 # \u67e5\u770b\u53d1\u73b0\u4e00\u6269\u5bb9\u6210\u529f rbd image 'csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2': size 110 GiB in 28160 objects order 22 (4 MiB objects) snapshot_count: 0 id: 1b8e31cc42074 block_name_prefix: rbd_data.1b8e31cc42074 format: 2 features: layering op_features: flags: create_timestamp: Sun Aug 13 07:58:39 2023 access_timestamp: Sun Aug 13 07:58:39 2023 modify_timestamp: Sun Aug 13 07:58:39 2023 2\u3001\u767b\u9646\u5bb9\u5668\u6240\u5728\u5bbf\u4e3b\u673a\uff0c\u6269\u5bb9\u2f42\u4ef6\u7cfb\u7edf\u7684\u5bb9\u91cf [ pre ] root@m1:~# rbd device list id pool namespace image snap device 0 replicapool csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be - /dev/rbd0 1 replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 - /dev/rbd1 [ pre ] root@m1:~# [ pre ] root@m1:~# [ pre ] root@m1:~# rbd device list | grep csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 1 replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 - /dev/rbd1 [ pre ] root@m1:~# resize2fs /dev/rbd1 resize2fs 1 .45.5 ( 07 -Jan-2020 ) Filesystem at /dev/rbd1 is mounted on /var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a/globalmount/0001-0009-rook-ceph-0000000000000001-36c61ced-39af-11ee-821b-2e922eb2eef2 ; on-line resizing required old_desc_blocks = 13 , new_desc_blocks = 14 The filesystem on /dev/rbd1 is now 28835840 ( 4k ) blocks long. [ pre ] root@m1:~# df -h | grep rbd1 # \u8fd9\u65f6\u6211\u4eec\u53d1\u73b0\u5df2\u7ecf\u6269\u5bb9\u6210\u529f /dev/rbd1 108G 3 .1G 105G 3 % /var/lib/kubelet/pods/6e0c06a7-4a42-492e-b3c5-9d9756d530f9/volumes/kubernetes.io~csi/pvc-f34132d1-5a98-489d-9707-0d3f9ae9962a/mount \u6700\u540e\u6211\u4eec\u786e\u8ba4\u4e00\u4e0b\u53d1\u73b0\u6210\u529f\u6269\u5bb9","title":"\u65b9\u6cd5\u4e8c\uff1a"},{"location":"5.Storage/fio-benchmark/","text":"","title":"Fio benchmark"},{"location":"5.Storage/gcluster/","text":"\u5206\u5e03\u5f0f\u5377: (\u6570\u636e\u662f\u5b8c\u6574\u7684\uff0c\u4f8b\u59825\u4e2a\u6587\u4ef6\u4f1a\u5206\u6563\u6765\u5b58) \u6ca1\u6709\u5197\u4f59\u529f\u80fd\uff0c\u6709\u7684\u80fd\u8bfb\uff0c\u6709\u7684\u4e0d\u80fd \u6761\u5e26\u5377:\uff08\u6570\u636e\u662f\u4e00\u534a\uff0c\u5982\u679c\u673a\u5668\u635f\u574f\u5bfc\u81f4\u673a\u5668\u4f1a\u51fa\u95ee\u9898\uff09 \u5168\u90e8\u635f\u574f \u590d\u5236\u5377: \uff08\u5982\u679c\u662f\u4e24\u4e2a\u5b58\u50a8\uff0c\u6570\u636e\u90fd\u662f\u4e00\u6837\u7684\uff0c\u526f\u672c\uff09 \u5206\u5e03\u5f0f\u6761\u5e26: \u65e2\u6709\u5206\u5e03\u5f0f\u7684\u7279\u70b9\uff0c\u4e5f\u6709\u6761\u5e26\u7684\u7279\u70b9 \u574f\u4e00\u90e8\u5206 \u5206\u5e03\u5f0f\u590d\u5236: \u65e2\u6709\u5206\u5e03\u5f0f\u7684\u7279\u70b9\uff0c\u4e5f\u6709\u590d\u5236\u7684\u7279\u70b9 gcluster \u6700\u7ec8\u53ea\u80fd\u7528\u590d\u5236\u5377\uff0c\u6216\u8005\u662f\u5206\u5e03\u5f0f\u590d\u5236 ceph \u63a8\u8350\u4f7f\u7528rgw juicefs \u5143\u6570\u636e--redis,tidb","title":"Gcluster"},{"location":"5.Storage/juicefs-demo/","text":"juicefs \u4ecb\u7ecd \u00b6 1.1 \u4ec0\u4e48\u662f juicefs 1.2 juicefs \u67b6\u6784 1.3 \u8bfb\u5199\u6d41\u7a0b\u4ecb\u7ecd 1.4 \u6280\u672f\u5bf9\u6bd4 juicefs \u6838\u5fc3\u7279\u6027 \u00b6 1.5 \u7f13\u5b58\u7279\u6027\u4ecb\u7ecd 1.6 \u5b58\u50a8\u914d\u989d 1.7 \u76ee\u5f55\u7528\u91cf\u7edf\u8ba1 1.8 \u514b\u9686\u6587\u4ef6\u6216\u76ee\u5f55 \u51c6\u5907\u5de5\u4f5c \u00b6 \u4ec0\u4e48\u662f k3s \u90e8\u7f72k3s\u73af\u5883 \u90e8\u7f72 redis \u54e8\u5175\u96c6\u7fa4 minio \u4ecb\u7ecd \u90e8\u7f72\u5355\u8282\u70b9 minio \u5feb\u901f\u542f\u52a8\u4e00\u4e2a juicefs \u73af\u5883 \u00b6 \u5728 k3s \u4e2d\u8fd0\u884c\u4e00\u4e2a juicefs demo \u793a\u4f8b \u5728 k8s \u4e2d\u8fd0\u884cjuicefs \u00b6 \u5143\u6570\u636e\u6280\u672f\u9009\u578b,\u540e\u7aef\u5b58\u50a8\u9009\u578b\u4ecb\u7ecd helm \u5de5\u5177\u5b89\u88c5 CSI \u9a71\u52a8\u5b89\u88c5","title":"juicefs \u4ecb\u7ecd"},{"location":"5.Storage/juicefs-demo/#juicefs","text":"1.1 \u4ec0\u4e48\u662f juicefs 1.2 juicefs \u67b6\u6784 1.3 \u8bfb\u5199\u6d41\u7a0b\u4ecb\u7ecd 1.4 \u6280\u672f\u5bf9\u6bd4","title":"juicefs \u4ecb\u7ecd"},{"location":"5.Storage/juicefs-demo/#juicefs_1","text":"1.5 \u7f13\u5b58\u7279\u6027\u4ecb\u7ecd 1.6 \u5b58\u50a8\u914d\u989d 1.7 \u76ee\u5f55\u7528\u91cf\u7edf\u8ba1 1.8 \u514b\u9686\u6587\u4ef6\u6216\u76ee\u5f55","title":"juicefs \u6838\u5fc3\u7279\u6027"},{"location":"5.Storage/juicefs-demo/#_1","text":"\u4ec0\u4e48\u662f k3s \u90e8\u7f72k3s\u73af\u5883 \u90e8\u7f72 redis \u54e8\u5175\u96c6\u7fa4 minio \u4ecb\u7ecd \u90e8\u7f72\u5355\u8282\u70b9 minio","title":"\u51c6\u5907\u5de5\u4f5c"},{"location":"5.Storage/juicefs-demo/#juicefs_2","text":"\u5728 k3s \u4e2d\u8fd0\u884c\u4e00\u4e2a juicefs demo \u793a\u4f8b","title":"\u5feb\u901f\u542f\u52a8\u4e00\u4e2a juicefs \u73af\u5883"},{"location":"5.Storage/juicefs-demo/#k8s-juicefs","text":"\u5143\u6570\u636e\u6280\u672f\u9009\u578b,\u540e\u7aef\u5b58\u50a8\u9009\u578b\u4ecb\u7ecd helm \u5de5\u5177\u5b89\u88c5 CSI \u9a71\u52a8\u5b89\u88c5","title":"\u5728 k8s \u4e2d\u8fd0\u884cjuicefs"},{"location":"5.Storage/juicefs-update/","text":"\u524d\u8a00 \u00b6 \u6211\u81ea\u5df1\u6709\u4e00\u4e2ademo\u73af\u5883\uff0c\u4e0a\u9762\u5b89\u88c5\u4e86\u4e00\u4e2ajuicefs,\u6700\u8fd1\u6b63\u5f0f\u7248\u53d1\u5e03\u4e86\uff0c\u6240\u4ee5\u8981\u5bf9\u7ebf\u4e0a\u73af\u5883\u5347\u7ea7\u3002JuiceFS \u7684\u5ba2\u6237\u7aef\u53ea\u6709\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u5347\u7ea7\u65f6\u53ea\u9700\u8981\u7528\u65b0\u7248\u672c\u8f6f\u4ef6\u66ff\u6362\u65e7\u7248\u5373\u53ef\u3002 \u9996\u5148\u8981\u5bf9 values \u4e2d juicefs-csi-driver \u955c\u50cf\u7248\u672c\u5347\u7ea7 v0.22.0 \u5347\u7ea7\u6240\u6709\u5ba2\u6237\u7aef\u8f6f\u4ef6\u5230 v1.1 \u7248\u672c \u62d2\u7edd v1.1 \u4e4b\u524d\u7684\u7248\u672c\u518d\u6b21\u8fde\u63a5\uff1a juicefs config META-URL --min-client-version 1.1.0-A \u91cd\u542f\u670d\u52a1 \u786e\u4fdd\u6240\u6709\u5728\u7ebf\u5ba2\u6237\u7aef\u7248\u672c\u90fd\u5728 v1.1 \u6216\u4ee5\u4e0a\uff1a juicefs status META-URL | grep -w Version \u542f\u7528\u65b0\u7279\u6027\uff0c\u5177\u4f53\u53c2\u89c1\u76ee\u5f55\u7528\u91cf\u7edf\u8ba1\u548c\u76ee\u5f55\u914d\u989d \u6e29\u99a8\u63d0\u793a JuiceFS \u5728 v1.1\uff08\u5177\u4f53\u800c\u8a00\uff0c\u662f v1.1.0-beta2\uff09\u7248\u672c\u4e2d\u65b0\u589e\u4e86\u76ee\u5f55\u7528\u91cf\u7edf\u8ba1\u548c\u76ee\u5f55\u914d\u989d\u4e24\u4e2a\u529f\u80fd\uff0c\u4e14\u76ee\u5f55\u914d\u989d\u4f9d\u8d56\u4e8e\u7528\u91cf\u7edf\u8ba1\u3002\u8fd9\u4e24\u9879\u529f\u80fd\u5728\u65e7\u7248\u672c\u5ba2\u6237\u7aef\u4e2d\u6ca1\u6709\uff0c\u5f53\u5b83\u4eec\u88ab\u5f00\u542f\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u65e7\u5ba2\u6237\u7aef\u5199\u5165\u4f1a\u5bfc\u81f4\u7edf\u8ba1\u6570\u503c\u51fa\u73b0\u8f83\u5927\u504f\u5dee\u3002\u5728\u5347\u7ea7\u5230 v1.1 \u65f6\uff0c\u82e5\u60a8\u4e0d\u6253\u7b97\u542f\u7528\u8fd9\u4e24\u9879\u65b0\u529f\u80fd\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u65b0\u7248\u672c\u5ba2\u6237\u7aef\u66ff\u6362\u5347\u7ea7\uff0c\u65e0\u9700\u989d\u5916\u64cd\u4f5c\u3002\u82e5\u60a8\u6253\u7b97\u4f7f\u7528\uff0c\u5219\u5efa\u8bae\u60a8\u5728\u5347\u7ea7\u524d\u4e86\u89e3\u4ee5\u4e0b\u5185\u5bb9\u3002 \u9ed8\u8ba4\u914d\u7f6e(\u76ee\u524d\u8fd9\u4e24\u9879\u529f\u80fd\u7684\u9ed8\u8ba4\u914d\u7f6e\u4e3a\uff1a) \u65b0\u521b\u5efa\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f1a\u81ea\u52a8\u542f\u7528 \u5df2\u6709\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u5747\u4e0d\u542f\u7528 \u76ee\u5f55\u7528\u91cf\u7edf\u8ba1\u53ef\u4ee5\u901a\u8fc7 juicefs config \u547d\u4ee4\u5355\u72ec\u5f00\u542f \u8bbe\u7f6e\u76ee\u5f55\u914d\u989d\u65f6\uff0c\u7528\u91cf\u7edf\u8ba1\u4f1a\u81ea\u52a8\u5f00\u542f \u53ef\u4ee5\u76f4\u63a5\u5347\u7ea7\uff1a # \u9ed8\u8ba4\u5b89\u88c5\u5230 /usr/local/bin curl -sSL https://d.juicefs.com/install | sh - \u53c2\u8003\u6587\u7ae0 \u00b6 https://juicefs.com/docs/zh/community/release_notes#juicefs-v10 https://juicefs.com/docs/zh/csi/upgrade-csi-driver","title":"Juicefs\u7248\u672c\u5347\u7ea7"},{"location":"5.Storage/juicefs-update/#_1","text":"\u6211\u81ea\u5df1\u6709\u4e00\u4e2ademo\u73af\u5883\uff0c\u4e0a\u9762\u5b89\u88c5\u4e86\u4e00\u4e2ajuicefs,\u6700\u8fd1\u6b63\u5f0f\u7248\u53d1\u5e03\u4e86\uff0c\u6240\u4ee5\u8981\u5bf9\u7ebf\u4e0a\u73af\u5883\u5347\u7ea7\u3002JuiceFS \u7684\u5ba2\u6237\u7aef\u53ea\u6709\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u5347\u7ea7\u65f6\u53ea\u9700\u8981\u7528\u65b0\u7248\u672c\u8f6f\u4ef6\u66ff\u6362\u65e7\u7248\u5373\u53ef\u3002 \u9996\u5148\u8981\u5bf9 values \u4e2d juicefs-csi-driver \u955c\u50cf\u7248\u672c\u5347\u7ea7 v0.22.0 \u5347\u7ea7\u6240\u6709\u5ba2\u6237\u7aef\u8f6f\u4ef6\u5230 v1.1 \u7248\u672c \u62d2\u7edd v1.1 \u4e4b\u524d\u7684\u7248\u672c\u518d\u6b21\u8fde\u63a5\uff1a juicefs config META-URL --min-client-version 1.1.0-A \u91cd\u542f\u670d\u52a1 \u786e\u4fdd\u6240\u6709\u5728\u7ebf\u5ba2\u6237\u7aef\u7248\u672c\u90fd\u5728 v1.1 \u6216\u4ee5\u4e0a\uff1a juicefs status META-URL | grep -w Version \u542f\u7528\u65b0\u7279\u6027\uff0c\u5177\u4f53\u53c2\u89c1\u76ee\u5f55\u7528\u91cf\u7edf\u8ba1\u548c\u76ee\u5f55\u914d\u989d \u6e29\u99a8\u63d0\u793a JuiceFS \u5728 v1.1\uff08\u5177\u4f53\u800c\u8a00\uff0c\u662f v1.1.0-beta2\uff09\u7248\u672c\u4e2d\u65b0\u589e\u4e86\u76ee\u5f55\u7528\u91cf\u7edf\u8ba1\u548c\u76ee\u5f55\u914d\u989d\u4e24\u4e2a\u529f\u80fd\uff0c\u4e14\u76ee\u5f55\u914d\u989d\u4f9d\u8d56\u4e8e\u7528\u91cf\u7edf\u8ba1\u3002\u8fd9\u4e24\u9879\u529f\u80fd\u5728\u65e7\u7248\u672c\u5ba2\u6237\u7aef\u4e2d\u6ca1\u6709\uff0c\u5f53\u5b83\u4eec\u88ab\u5f00\u542f\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u65e7\u5ba2\u6237\u7aef\u5199\u5165\u4f1a\u5bfc\u81f4\u7edf\u8ba1\u6570\u503c\u51fa\u73b0\u8f83\u5927\u504f\u5dee\u3002\u5728\u5347\u7ea7\u5230 v1.1 \u65f6\uff0c\u82e5\u60a8\u4e0d\u6253\u7b97\u542f\u7528\u8fd9\u4e24\u9879\u65b0\u529f\u80fd\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u65b0\u7248\u672c\u5ba2\u6237\u7aef\u66ff\u6362\u5347\u7ea7\uff0c\u65e0\u9700\u989d\u5916\u64cd\u4f5c\u3002\u82e5\u60a8\u6253\u7b97\u4f7f\u7528\uff0c\u5219\u5efa\u8bae\u60a8\u5728\u5347\u7ea7\u524d\u4e86\u89e3\u4ee5\u4e0b\u5185\u5bb9\u3002 \u9ed8\u8ba4\u914d\u7f6e(\u76ee\u524d\u8fd9\u4e24\u9879\u529f\u80fd\u7684\u9ed8\u8ba4\u914d\u7f6e\u4e3a\uff1a) \u65b0\u521b\u5efa\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f1a\u81ea\u52a8\u542f\u7528 \u5df2\u6709\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u5747\u4e0d\u542f\u7528 \u76ee\u5f55\u7528\u91cf\u7edf\u8ba1\u53ef\u4ee5\u901a\u8fc7 juicefs config \u547d\u4ee4\u5355\u72ec\u5f00\u542f \u8bbe\u7f6e\u76ee\u5f55\u914d\u989d\u65f6\uff0c\u7528\u91cf\u7edf\u8ba1\u4f1a\u81ea\u52a8\u5f00\u542f \u53ef\u4ee5\u76f4\u63a5\u5347\u7ea7\uff1a # \u9ed8\u8ba4\u5b89\u88c5\u5230 /usr/local/bin curl -sSL https://d.juicefs.com/install | sh -","title":"\u524d\u8a00"},{"location":"5.Storage/juicefs-update/#_2","text":"https://juicefs.com/docs/zh/community/release_notes#juicefs-v10 https://juicefs.com/docs/zh/csi/upgrade-csi-driver","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"5.Storage/osd/","text":"osd \u6027\u80fd\u6d4b\u8bd5 \u00b6 \u73af\u5883\u8981\u6c42 \u51c6\u5907\u4e00\u4e2ak8s\u96c6\u7fa4 \u51c6\u5907\u4e00\u4e2aceph\u96c6\u7fa4 \u673a\u68b0\u78c1\u76d8\u6d4b\u8bd5 \u00b6 \u80cc\u666f \u6d4b\u8bd5\u673a\u68b0\u78c1\u76d8\u66f4\u6362\u56fa\u6001\u78c1\u76d8\u540e\uff0cosd\u7684\u8bfb\u5199\u901f\u5ea6 \u65b9\u6cd5\u4e00\uff1aFio \u538b\u529b\u6d4b\u8bd5 \u00b6 \u53c2\u6570\u8bf4\u660e\uff1a \u00b6 fio -filename = /data/fio.img -direct = 1 -iodepth 32 -thread -rw = randwrite -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest filename : \u538b\u6d4b\u7684\u6587\u4ef6\uff08\u6302\u5728ceph\u7684\u76ee\u5f55\u4e0b\uff09 -iodepth : \u961f\u5217\u6df1\u5ea6 -size : \u6307\u5b9a\u5199\u591a\u5927\u7684\u6570\u636e rw : I/O\u6a21\u5f0f\uff0c\u968f\u673a\u8bfb\u5199\uff0c\u987a\u5e8f\u8bfb\u5199\u7b49\u7b49 bs : I/O block\u5927\u5c0f \u793a\u4f8b\uff1a \u00b6 4K\u968f\u673a\u5199-iops fio -filename = /data/fio.img -direct = 1 -iodepth 32 -thread -rw = randwrite -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = randwrite, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads mytest: Laying out IO file ( 1 file / 200MiB ) Jobs: 6 ( f = 6 ) : [ w ( 6 )][ 100 .0% ][ w = 15 .0MiB/s ][ w = 4089 IOPS ][ eta 00m:00s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 96930 : Mon Aug 1 14 :34:37 2022 write: IOPS = 4104 , BW = 16 .0MiB/s ( 16 .8MB/s )( 963MiB/60054msec ) ; 0 zone resets slat ( nsec ) : min = 1755 , max = 48814k, avg = 10925 .38, stdev = 316419 .53 clat ( msec ) : min = 5 , max = 191 , avg = 46 .76, stdev = 13 .55 lat ( msec ) : min = 5 , max = 191 , avg = 46 .77, stdev = 13 .54 clat percentiles ( msec ) : | 1 .00th =[ 25 ] , 5 .00th =[ 29 ] , 10 .00th =[ 31 ] , 20 .00th =[ 33 ] , | 30 .00th =[ 37 ] , 40 .00th =[ 44 ] , 50 .00th =[ 49 ] , 60 .00th =[ 53 ] , | 70 .00th =[ 55 ] , 80 .00th =[ 58 ] , 90 .00th =[ 61 ] , 95 .00th =[ 64 ] , | 99 .00th =[ 85 ] , 99 .50th =[ 96 ] , 99 .90th =[ 130 ] , 99 .95th =[ 142 ] , | 99 .99th =[ 163 ] bw ( KiB/s ) : min = 14912 , max = 19106 , per = 100 .00%, avg = 16419 .87, stdev = 80 .74, samples = 720 iops : min = 3728 , max = 4776 , avg = 4104 .83, stdev = 20 .18, samples = 720 lat ( msec ) : 10 = 0 .04%, 20 = 0 .38%, 50 = 53 .46%, 100 = 45 .67%, 250 = 0 .45% cpu : usr = 0 .19%, sys = 0 .71%, ctx = 182573 , majf = 1 , minf = 11 IO depths : 1 = 0 .1%, 2 = 0 .1%, 4 = 0 .1%, 8 = 0 .1%, 16 = 0 .1%, 32 = 99 .9%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .1%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,246515,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : WRITE: bw = 16 .0MiB/s ( 16 .8MB/s ) , 16 .0MiB/s-16.0MiB/s ( 16 .8MB/s-16.8MB/s ) , io = 963MiB ( 1010MB ) , run = 60054 -60054msec Disk stats ( read/write ) : rbd0: ios = 4 /245332, merge = 0 /637, ticks = 81 /11412705, in_queue = 10919116 , util = 57 .39% 4k\u968f\u673a\u8bfb-iops [ ucloud ] root@master0:~# fio -filename = /data/fio2.img -direct = 1 -iodepth 32 -thread -rw = randread -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = randread, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads mytest: Laying out IO file ( 1 file / 200MiB ) Jobs: 6 ( f = 6 ) : [ r ( 6 )][ 88 .9% ][ r = 200MiB/s ][ r = 51 .2k IOPS ][ eta 00m:01s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 101153 : Mon Aug 1 14 :40:36 2022 read: IOPS = 36 .1k, BW = 141MiB/s ( 148MB/s )( 1200MiB/8508msec ) slat ( nsec ) : min = 1151 , max = 14537k, avg = 19572 .33, stdev = 101622 .30 clat ( nsec ) : min = 455 , max = 79415k, avg = 5280191 .11, stdev = 7133988 .93 lat ( usec ) : min = 64 , max = 79418 , avg = 5299 .94, stdev = 7130 .13 clat percentiles ( usec ) : | 1 .00th =[ 363 ] , 5 .00th =[ 865 ] , 10 .00th =[ 1237 ] , 20 .00th =[ 1778 ] , | 30 .00th =[ 2245 ] , 40 .00th =[ 2704 ] , 50 .00th =[ 3163 ] , 60 .00th =[ 3720 ] , | 70 .00th =[ 4490 ] , 80 .00th =[ 5866 ] , 90 .00th =[ 10290 ] , 95 .00th =[ 19268 ] , | 99 .00th =[ 40109 ] , 99 .50th =[ 44303 ] , 99 .90th =[ 52167 ] , 99 .95th =[ 56361 ] , | 99 .99th =[ 65274 ] bw ( KiB/s ) : min = 45752 , max = 234048 , per = 98 .88%, avg = 142805 .42, stdev = 12299 .59, samples = 98 iops : min = 11438 , max = 58512 , avg = 35701 .11, stdev = 3074 .86, samples = 98 lat ( nsec ) : 500 = 0 .01% lat ( usec ) : 20 = 0 .01%, 50 = 0 .01%, 100 = 0 .03%, 250 = 0 .38%, 500 = 1 .39% lat ( usec ) : 750 = 2 .05%, 1000 = 2 .80% lat ( msec ) : 2 = 18 .03%, 4 = 39 .21%, 10 = 25 .81%, 20 = 5 .53%, 50 = 4 .61% lat ( msec ) : 100 = 0 .14% cpu : usr = 1 .03%, sys = 3 .66%, ctx = 239175 , majf = 0 , minf = 198 IO depths : 1 = 0 .1%, 2 = 0 .1%, 4 = 0 .1%, 8 = 0 .1%, 16 = 0 .1%, 32 = 99 .9%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .1%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 307200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : READ: bw = 141MiB/s ( 148MB/s ) , 141MiB/s-141MiB/s ( 148MB/s-148MB/s ) , io = 1200MiB ( 1258MB ) , run = 8508 -8508msec Disk stats ( read/write ) : rbd0: ios = 298435 /0, merge = 1141 /0, ticks = 1470086 /0, in_queue = 887248 , util = 98 .83% 4k\u968f\u673a\u8bfb\u5199-iops [ ucloud ] root@master0:~# fio -filename = /data/fio3.img -direct = 1 -iodepth 32 -thread -rw = randrw -rwmixread = 70 -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = randrw, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads Jobs: 6 ( f = 6 ) : [ m ( 6 )][ 100 .0% ][ r = 26 .7MiB/s,w = 11 .6MiB/s ][ r = 6835 ,w = 2976 IOPS ][ eta 00m:00s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 104592 : Mon Aug 1 14 :45:40 2022 read: IOPS = 6434 , BW = 25 .1MiB/s ( 26 .4MB/s )( 838MiB/33355msec ) slat ( nsec ) : min = 1268 , max = 512155 , avg = 5128 .49, stdev = 4908 .50 clat ( usec ) : min = 108 , max = 237284 , avg = 17218 .47, stdev = 13454 .22 lat ( usec ) : min = 112 , max = 237286 , avg = 17223 .74, stdev = 13454 .22 clat percentiles ( usec ) : | 1 .00th =[ 857 ] , 5 .00th =[ 1696 ] , 10 .00th =[ 2507 ] , 20 .00th =[ 4293 ] , | 30 .00th =[ 6980 ] , 40 .00th =[ 12256 ] , 50 .00th =[ 17695 ] , 60 .00th =[ 20579 ] , | 70 .00th =[ 22938 ] , 80 .00th =[ 25560 ] , 90 .00th =[ 31589 ] , 95 .00th =[ 41157 ] , | 99 .00th =[ 55313 ] , 99 .50th =[ 64226 ] , 99 .90th =[ 94897 ] , 99 .95th =[ 154141 ] , | 99 .99th =[ 227541 ] bw ( KiB/s ) : min = 18128 , max = 31360 , per = 99 .94%, avg = 25724 .41, stdev = 445 .55, samples = 396 iops : min = 4532 , max = 7840 , avg = 6430 .97, stdev = 111 .38, samples = 396 write: IOPS = 2775 , BW = 10 .8MiB/s ( 11 .4MB/s )( 362MiB/33355msec ) ; 0 zone resets slat ( nsec ) : min = 1519 , max = 586139 , avg = 5581 .99, stdev = 5697 .03 clat ( usec ) : min = 735 , max = 234047 , avg = 29153 .24, stdev = 13547 .74 lat ( usec ) : min = 740 , max = 234050 , avg = 29158 .97, stdev = 13547 .75 clat percentiles ( msec ) : | 1 .00th =[ 5 ] , 5 .00th =[ 14 ] , 10 .00th =[ 19 ] , 20 .00th =[ 21 ] , | 30 .00th =[ 23 ] , 40 .00th =[ 24 ] , 50 .00th =[ 26 ] , 60 .00th =[ 28 ] , | 70 .00th =[ 33 ] , 80 .00th =[ 40 ] , 90 .00th =[ 46 ] , 95 .00th =[ 52 ] , | 99 .00th =[ 67 ] , 99 .50th =[ 77 ] , 99 .90th =[ 153 ] , 99 .95th =[ 215 ] , | 99 .99th =[ 230 ] bw ( KiB/s ) : min = 7264 , max = 13640 , per = 99 .93%, avg = 11092 .62, stdev = 204 .64, samples = 396 iops : min = 1816 , max = 3410 , avg = 2773 .11, stdev = 51 .15, samples = 396 lat ( usec ) : 250 = 0 .01%, 500 = 0 .12%, 750 = 0 .35%, 1000 = 0 .56% lat ( msec ) : 2 = 3 .77%, 4 = 8 .37%, 10 = 13 .38%, 20 = 18 .51%, 50 = 52 .05% lat ( msec ) : 100 = 2 .75%, 250 = 0 .11% cpu : usr = 0 .42%, sys = 1 .37%, ctx = 262129 , majf = 1 , minf = 6 IO depths : 1 = 0 .1%, 2 = 0 .1%, 4 = 0 .1%, 8 = 0 .1%, 16 = 0 .1%, 32 = 99 .9%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .1%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 214635 ,92565,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : READ: bw = 25 .1MiB/s ( 26 .4MB/s ) , 25 .1MiB/s-25.1MiB/s ( 26 .4MB/s-26.4MB/s ) , io = 838MiB ( 879MB ) , run = 33355 -33355msec WRITE: bw = 10 .8MiB/s ( 11 .4MB/s ) , 10 .8MiB/s-10.8MiB/s ( 11 .4MB/s-11.4MB/s ) , io = 362MiB ( 379MB ) , run = 33355 -33355msec Disk stats ( read/write ) : rbd0: ios = 212275 /91760, merge = 1000 /200, ticks = 3650146 /2659754, in_queue = 5701392 , util = 86 .01% 1M\u987a\u5e8f\u5199-\u541e\u5410 [ ucloud ] root@master0:~# fio -filename = /data/fio4.img -direct = 1 -iodepth 32 -thread -rw = write -ioengine = libaio -bs = 1M -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = write, bs =( R ) 1024KiB-1024KiB, ( W ) 1024KiB-1024KiB, ( T ) 1024KiB-1024KiB, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads Jobs: 3 ( f = 3 ) : [ _ ( 2 ) ,W ( 2 ) ,_ ( 1 ) ,W ( 1 )][ 90 .0% ][ w = 177MiB/s ][ w = 177 IOPS ][ eta 00m:01s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 107996 : Mon Aug 1 14 :51:00 2022 write: IOPS = 131 , BW = 131MiB/s ( 138MB/s )( 1200MiB/9131msec ) ; 0 zone resets slat ( usec ) : min = 41 , max = 13194 , avg = 208 .41, stdev = 756 .44 clat ( msec ) : min = 20 , max = 3855 , avg = 1392 .05, stdev = 816 .66 lat ( msec ) : min = 20 , max = 3855 , avg = 1392 .26, stdev = 816 .65 clat percentiles ( msec ) : | 1 .00th =[ 284 ] , 5 .00th =[ 351 ] , 10 .00th =[ 435 ] , 20 .00th =[ 625 ] , | 30 .00th =[ 885 ] , 40 .00th =[ 1099 ] , 50 .00th =[ 1234 ] , 60 .00th =[ 1418 ] , | 70 .00th =[ 1620 ] , 80 .00th =[ 1938 ] , 90 .00th =[ 2769 ] , 95 .00th =[ 2903 ] , | 99 .00th =[ 3608 ] , 99 .50th =[ 3675 ] , 99 .90th =[ 3809 ] , 99 .95th =[ 3842 ] , | 99 .99th =[ 3842 ] bw ( KiB/s ) : min = 24554 , max = 273468 , per = 99 .58%, avg = 134013 .71, stdev = 11587 .87, samples = 93 iops : min = 22 , max = 267 , avg = 130 .28, stdev = 11 .35, samples = 93 lat ( msec ) : 50 = 0 .25%, 250 = 0 .33%, 500 = 13 .33%, 750 = 11 .50%, 1000 = 10 .08% lat ( msec ) : 2000 = 44 .92%, > = 2000 = 19 .58% cpu : usr = 0 .18%, sys = 0 .09%, ctx = 792 , majf = 1 , minf = 6 IO depths : 1 = 0 .5%, 2 = 1 .0%, 4 = 2 .0%, 8 = 4 .0%, 16 = 8 .0%, 32 = 84 .5%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 99 .4%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .6%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,1200,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : WRITE: bw = 131MiB/s ( 138MB/s ) , 131MiB/s-131MiB/s ( 138MB/s-138MB/s ) , io = 1200MiB ( 1258MB ) , run = 9131 -9131msec Disk stats ( read/write ) : rbd0: ios = 0 /887, merge = 0 /280, ticks = 0 /1112233, in_queue = 1110460 , util = 16 .67% \u65b9\u6cd5\u4e8c\uff1aRBD bench \u538b\u529b\u6d4b\u8bd5 \u00b6 \u53c2\u6570\u8bf4\u660e\uff1a \u00b6 [ ucloud ] root@master0:~# rbd help bench usage : rbd bench [--pool <pool>] [--namespace <namespace>] [--image <image>] [--io-size <io-size>] [--io-threads <io-threads>] [--io-total <io-total>] [--io-pattern <io-pattern>] [--rw-mix-read <rw-mix-read>] --io-type <io-type> <image-spec> Simple benchmark. Positional arguments <image-spec> image specification (example : [ <pool-name>/ [ <namespace>/ ]] <image-name>) Optional arguments -p [ --pool ] arg pool name # \u6307\u5b9apool\u7684\u540d\u79f0 --namespace arg namespace name # \u6307\u5b9anamespace --image arg image name --io-size arg IO size (in B/K/M/G/T) [default : 4K] # \u6307\u5b9aIO\u5927\u5c0f --io-threads arg ios in flight [default : 16] # \u6307\u5b9a\u5e76\u53d1 --io-total arg total size for IO (in B/K/M/G/T) [default : 1G] # \u6570\u636e\u7684\u5927\u5c0f --io-pattern arg IO pattern (rand, seq, or full-seq) [default : seq] # iops\uff08rand\u4e3a\u968f\u673a\uff0cseq\u987a\u5e8f\uff09 --rw-mix-read arg read proportion in readwrite (<= 100) [default : 50] # --rw-mix-read \u6df7\u5408\u8bfb\u5199\u8bfb\u7684\u5360\u6bd4 --io-type arg IO type (read, write, or readwrite(rw)) # \u7c7b\u578b\uff0c\u8981\u4ee5\u4ec0\u4e48\u65b9\u5f0f\u538b\u6d4b\uff0c\u8bfb\u6216\u8005\u5199 \u793a\u4f8b\uff1a \u00b6 \u6e29\u99a8\u63d0\u793a \u538b\u6d4b\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7iostat -x 1 \u5bf9\u78c1\u76d8\u8fdb\u884c\u76d1\u63a7 - ceph osd perf \u53ef\u4ee5\u4f7f\u7528\u8be5\u547d\u4ee4\u67e5\u770bosd\u5ef6\u8fdf\u60c5\u51b5 4K\u968f\u673a\u5199 rbd bench rook/rook-rbd.img --io-size 4K --io-threads 16 --io-total 1G --io-pattern rand --io-type write bench type write io_size 4096 io_threads 16 bytes 1073741824 pattern random SEC OPS OPS/SEC BYTES/SEC 1 5536 5574 .28 22 MiB/s 2 9664 4849 .68 19 MiB/s 3 13776 4603 .46 18 MiB/s 4 17968 4500 .49 18 MiB/s ...... 64 261440 3935 .99 15 MiB/s elapsed: 64 ops: 262144 ops/sec: 4064 .99 bytes/sec: 16 MiB/s # \u6d4b\u8bd5\u51fa\u5f53\u524d\u7684iops\u4e3a4064.99 4K\u968f\u673a\u8bfb [ ucloud ] root@master0:~# rbd bench rook/rook-rbd.img --io-size 4K --io-threads 16 --io-total 1G --io-pattern rand --io-type read bench type read io_size 4096 io_threads 16 bytes 1073741824 pattern random SEC OPS OPS/SEC BYTES/SEC 1 26816 26939 .7 105 MiB/s 2 53728 26925 .8 105 MiB/s 3 81648 27257 .6 106 MiB/s 4 90896 22569 .9 88 MiB/s 5 115328 23087 .2 90 MiB/s 6 142416 23119 .9 90 MiB/s 7 170048 23263 .9 91 MiB/s 8 197104 23091 .1 90 MiB/s 9 225264 27046 .6 106 MiB/s 10 253360 27606 .3 108 MiB/s elapsed: 10 ops: 262144 ops/sec: 25391 .6 bytes/sec: 99 MiB/s # \u6d4b\u8bd5\u51fa\u5f53\u524d\u7684iops\u4e3a25391.6 4K\u968f\u673a\u6df7\u5408\u8bfb\u5199 [ ucloud ] root@master0:~# rbd bench rook/rook-rbd.img --io-size 4K --io-threads 16 --io-total 1G --io-pattern rand --io-type readwrite --rw-mix-read 70 bench type readwrite read:write = 70 :30 io_size 4096 io_threads 16 bytes 1073741824 pattern random SEC OPS OPS/SEC BYTES/SEC 1 12144 12208 .8 48 MiB/s 2 23488 11775 .5 46 MiB/s 3 34624 11562 45 MiB/s 4 45552 11403 .4 45 MiB/s 5 56528 11317 .8 44 MiB/s 6 67664 11104 43 MiB/s 7 78976 11097 .6 43 MiB/s 8 89872 11049 .6 43 MiB/s 9 101216 11132 .8 43 MiB/s 10 112608 11216 44 MiB/s ..... elapsed: 23 ops: 262144 ops/sec: 11012 .6 bytes/sec: 43 MiB/s read_ops: 183730 read_ops/sec: 7718 .43 read_bytes/sec: 30 MiB/s write_ops: 78414 write_ops/sec: 3294 .14 write_bytes/sec: 13 MiB/s 1M\u987a\u5e8f\u5199\uff08\u6d4b\u541e\u5410\u91cf\uff09 [ ucloud ] root@master0:~# rbd bench rook/rook-rbd.img --io-size 1M --io-threads 16 --io-total 200M --io-pattern seq --io-type write bench type write io_size 1048576 io_threads 16 bytes 209715200 pattern sequential SEC OPS OPS/SEC BYTES/SEC 1 160 175 .298 175 MiB/s elapsed: 1 ops: 200 ops/sec: 136 .986 bytes/sec: 137 MiB/s https://bench.sh/","title":"ceph \u6027\u80fd\u6d4b\u8bd5"},{"location":"5.Storage/osd/#osd","text":"\u73af\u5883\u8981\u6c42 \u51c6\u5907\u4e00\u4e2ak8s\u96c6\u7fa4 \u51c6\u5907\u4e00\u4e2aceph\u96c6\u7fa4","title":"osd \u6027\u80fd\u6d4b\u8bd5"},{"location":"5.Storage/osd/#_1","text":"\u80cc\u666f \u6d4b\u8bd5\u673a\u68b0\u78c1\u76d8\u66f4\u6362\u56fa\u6001\u78c1\u76d8\u540e\uff0cosd\u7684\u8bfb\u5199\u901f\u5ea6","title":"\u673a\u68b0\u78c1\u76d8\u6d4b\u8bd5"},{"location":"5.Storage/osd/#fio","text":"","title":"\u65b9\u6cd5\u4e00\uff1aFio \u538b\u529b\u6d4b\u8bd5"},{"location":"5.Storage/osd/#_2","text":"fio -filename = /data/fio.img -direct = 1 -iodepth 32 -thread -rw = randwrite -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest filename : \u538b\u6d4b\u7684\u6587\u4ef6\uff08\u6302\u5728ceph\u7684\u76ee\u5f55\u4e0b\uff09 -iodepth : \u961f\u5217\u6df1\u5ea6 -size : \u6307\u5b9a\u5199\u591a\u5927\u7684\u6570\u636e rw : I/O\u6a21\u5f0f\uff0c\u968f\u673a\u8bfb\u5199\uff0c\u987a\u5e8f\u8bfb\u5199\u7b49\u7b49 bs : I/O block\u5927\u5c0f","title":"\u53c2\u6570\u8bf4\u660e\uff1a"},{"location":"5.Storage/osd/#_3","text":"4K\u968f\u673a\u5199-iops fio -filename = /data/fio.img -direct = 1 -iodepth 32 -thread -rw = randwrite -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = randwrite, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads mytest: Laying out IO file ( 1 file / 200MiB ) Jobs: 6 ( f = 6 ) : [ w ( 6 )][ 100 .0% ][ w = 15 .0MiB/s ][ w = 4089 IOPS ][ eta 00m:00s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 96930 : Mon Aug 1 14 :34:37 2022 write: IOPS = 4104 , BW = 16 .0MiB/s ( 16 .8MB/s )( 963MiB/60054msec ) ; 0 zone resets slat ( nsec ) : min = 1755 , max = 48814k, avg = 10925 .38, stdev = 316419 .53 clat ( msec ) : min = 5 , max = 191 , avg = 46 .76, stdev = 13 .55 lat ( msec ) : min = 5 , max = 191 , avg = 46 .77, stdev = 13 .54 clat percentiles ( msec ) : | 1 .00th =[ 25 ] , 5 .00th =[ 29 ] , 10 .00th =[ 31 ] , 20 .00th =[ 33 ] , | 30 .00th =[ 37 ] , 40 .00th =[ 44 ] , 50 .00th =[ 49 ] , 60 .00th =[ 53 ] , | 70 .00th =[ 55 ] , 80 .00th =[ 58 ] , 90 .00th =[ 61 ] , 95 .00th =[ 64 ] , | 99 .00th =[ 85 ] , 99 .50th =[ 96 ] , 99 .90th =[ 130 ] , 99 .95th =[ 142 ] , | 99 .99th =[ 163 ] bw ( KiB/s ) : min = 14912 , max = 19106 , per = 100 .00%, avg = 16419 .87, stdev = 80 .74, samples = 720 iops : min = 3728 , max = 4776 , avg = 4104 .83, stdev = 20 .18, samples = 720 lat ( msec ) : 10 = 0 .04%, 20 = 0 .38%, 50 = 53 .46%, 100 = 45 .67%, 250 = 0 .45% cpu : usr = 0 .19%, sys = 0 .71%, ctx = 182573 , majf = 1 , minf = 11 IO depths : 1 = 0 .1%, 2 = 0 .1%, 4 = 0 .1%, 8 = 0 .1%, 16 = 0 .1%, 32 = 99 .9%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .1%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,246515,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : WRITE: bw = 16 .0MiB/s ( 16 .8MB/s ) , 16 .0MiB/s-16.0MiB/s ( 16 .8MB/s-16.8MB/s ) , io = 963MiB ( 1010MB ) , run = 60054 -60054msec Disk stats ( read/write ) : rbd0: ios = 4 /245332, merge = 0 /637, ticks = 81 /11412705, in_queue = 10919116 , util = 57 .39% 4k\u968f\u673a\u8bfb-iops [ ucloud ] root@master0:~# fio -filename = /data/fio2.img -direct = 1 -iodepth 32 -thread -rw = randread -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = randread, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads mytest: Laying out IO file ( 1 file / 200MiB ) Jobs: 6 ( f = 6 ) : [ r ( 6 )][ 88 .9% ][ r = 200MiB/s ][ r = 51 .2k IOPS ][ eta 00m:01s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 101153 : Mon Aug 1 14 :40:36 2022 read: IOPS = 36 .1k, BW = 141MiB/s ( 148MB/s )( 1200MiB/8508msec ) slat ( nsec ) : min = 1151 , max = 14537k, avg = 19572 .33, stdev = 101622 .30 clat ( nsec ) : min = 455 , max = 79415k, avg = 5280191 .11, stdev = 7133988 .93 lat ( usec ) : min = 64 , max = 79418 , avg = 5299 .94, stdev = 7130 .13 clat percentiles ( usec ) : | 1 .00th =[ 363 ] , 5 .00th =[ 865 ] , 10 .00th =[ 1237 ] , 20 .00th =[ 1778 ] , | 30 .00th =[ 2245 ] , 40 .00th =[ 2704 ] , 50 .00th =[ 3163 ] , 60 .00th =[ 3720 ] , | 70 .00th =[ 4490 ] , 80 .00th =[ 5866 ] , 90 .00th =[ 10290 ] , 95 .00th =[ 19268 ] , | 99 .00th =[ 40109 ] , 99 .50th =[ 44303 ] , 99 .90th =[ 52167 ] , 99 .95th =[ 56361 ] , | 99 .99th =[ 65274 ] bw ( KiB/s ) : min = 45752 , max = 234048 , per = 98 .88%, avg = 142805 .42, stdev = 12299 .59, samples = 98 iops : min = 11438 , max = 58512 , avg = 35701 .11, stdev = 3074 .86, samples = 98 lat ( nsec ) : 500 = 0 .01% lat ( usec ) : 20 = 0 .01%, 50 = 0 .01%, 100 = 0 .03%, 250 = 0 .38%, 500 = 1 .39% lat ( usec ) : 750 = 2 .05%, 1000 = 2 .80% lat ( msec ) : 2 = 18 .03%, 4 = 39 .21%, 10 = 25 .81%, 20 = 5 .53%, 50 = 4 .61% lat ( msec ) : 100 = 0 .14% cpu : usr = 1 .03%, sys = 3 .66%, ctx = 239175 , majf = 0 , minf = 198 IO depths : 1 = 0 .1%, 2 = 0 .1%, 4 = 0 .1%, 8 = 0 .1%, 16 = 0 .1%, 32 = 99 .9%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .1%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 307200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : READ: bw = 141MiB/s ( 148MB/s ) , 141MiB/s-141MiB/s ( 148MB/s-148MB/s ) , io = 1200MiB ( 1258MB ) , run = 8508 -8508msec Disk stats ( read/write ) : rbd0: ios = 298435 /0, merge = 1141 /0, ticks = 1470086 /0, in_queue = 887248 , util = 98 .83% 4k\u968f\u673a\u8bfb\u5199-iops [ ucloud ] root@master0:~# fio -filename = /data/fio3.img -direct = 1 -iodepth 32 -thread -rw = randrw -rwmixread = 70 -ioengine = libaio -bs = 4k -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = randrw, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads Jobs: 6 ( f = 6 ) : [ m ( 6 )][ 100 .0% ][ r = 26 .7MiB/s,w = 11 .6MiB/s ][ r = 6835 ,w = 2976 IOPS ][ eta 00m:00s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 104592 : Mon Aug 1 14 :45:40 2022 read: IOPS = 6434 , BW = 25 .1MiB/s ( 26 .4MB/s )( 838MiB/33355msec ) slat ( nsec ) : min = 1268 , max = 512155 , avg = 5128 .49, stdev = 4908 .50 clat ( usec ) : min = 108 , max = 237284 , avg = 17218 .47, stdev = 13454 .22 lat ( usec ) : min = 112 , max = 237286 , avg = 17223 .74, stdev = 13454 .22 clat percentiles ( usec ) : | 1 .00th =[ 857 ] , 5 .00th =[ 1696 ] , 10 .00th =[ 2507 ] , 20 .00th =[ 4293 ] , | 30 .00th =[ 6980 ] , 40 .00th =[ 12256 ] , 50 .00th =[ 17695 ] , 60 .00th =[ 20579 ] , | 70 .00th =[ 22938 ] , 80 .00th =[ 25560 ] , 90 .00th =[ 31589 ] , 95 .00th =[ 41157 ] , | 99 .00th =[ 55313 ] , 99 .50th =[ 64226 ] , 99 .90th =[ 94897 ] , 99 .95th =[ 154141 ] , | 99 .99th =[ 227541 ] bw ( KiB/s ) : min = 18128 , max = 31360 , per = 99 .94%, avg = 25724 .41, stdev = 445 .55, samples = 396 iops : min = 4532 , max = 7840 , avg = 6430 .97, stdev = 111 .38, samples = 396 write: IOPS = 2775 , BW = 10 .8MiB/s ( 11 .4MB/s )( 362MiB/33355msec ) ; 0 zone resets slat ( nsec ) : min = 1519 , max = 586139 , avg = 5581 .99, stdev = 5697 .03 clat ( usec ) : min = 735 , max = 234047 , avg = 29153 .24, stdev = 13547 .74 lat ( usec ) : min = 740 , max = 234050 , avg = 29158 .97, stdev = 13547 .75 clat percentiles ( msec ) : | 1 .00th =[ 5 ] , 5 .00th =[ 14 ] , 10 .00th =[ 19 ] , 20 .00th =[ 21 ] , | 30 .00th =[ 23 ] , 40 .00th =[ 24 ] , 50 .00th =[ 26 ] , 60 .00th =[ 28 ] , | 70 .00th =[ 33 ] , 80 .00th =[ 40 ] , 90 .00th =[ 46 ] , 95 .00th =[ 52 ] , | 99 .00th =[ 67 ] , 99 .50th =[ 77 ] , 99 .90th =[ 153 ] , 99 .95th =[ 215 ] , | 99 .99th =[ 230 ] bw ( KiB/s ) : min = 7264 , max = 13640 , per = 99 .93%, avg = 11092 .62, stdev = 204 .64, samples = 396 iops : min = 1816 , max = 3410 , avg = 2773 .11, stdev = 51 .15, samples = 396 lat ( usec ) : 250 = 0 .01%, 500 = 0 .12%, 750 = 0 .35%, 1000 = 0 .56% lat ( msec ) : 2 = 3 .77%, 4 = 8 .37%, 10 = 13 .38%, 20 = 18 .51%, 50 = 52 .05% lat ( msec ) : 100 = 2 .75%, 250 = 0 .11% cpu : usr = 0 .42%, sys = 1 .37%, ctx = 262129 , majf = 1 , minf = 6 IO depths : 1 = 0 .1%, 2 = 0 .1%, 4 = 0 .1%, 8 = 0 .1%, 16 = 0 .1%, 32 = 99 .9%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .1%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 214635 ,92565,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : READ: bw = 25 .1MiB/s ( 26 .4MB/s ) , 25 .1MiB/s-25.1MiB/s ( 26 .4MB/s-26.4MB/s ) , io = 838MiB ( 879MB ) , run = 33355 -33355msec WRITE: bw = 10 .8MiB/s ( 11 .4MB/s ) , 10 .8MiB/s-10.8MiB/s ( 11 .4MB/s-11.4MB/s ) , io = 362MiB ( 379MB ) , run = 33355 -33355msec Disk stats ( read/write ) : rbd0: ios = 212275 /91760, merge = 1000 /200, ticks = 3650146 /2659754, in_queue = 5701392 , util = 86 .01% 1M\u987a\u5e8f\u5199-\u541e\u5410 [ ucloud ] root@master0:~# fio -filename = /data/fio4.img -direct = 1 -iodepth 32 -thread -rw = write -ioengine = libaio -bs = 1M -size = 200m -numjobs = 6 -runtime = 60 -group_reporting -name = mytest mytest: ( g = 0 ) : rw = write, bs =( R ) 1024KiB-1024KiB, ( W ) 1024KiB-1024KiB, ( T ) 1024KiB-1024KiB, ioengine = libaio, iodepth = 32 ... fio-3.16 Starting 6 threads Jobs: 3 ( f = 3 ) : [ _ ( 2 ) ,W ( 2 ) ,_ ( 1 ) ,W ( 1 )][ 90 .0% ][ w = 177MiB/s ][ w = 177 IOPS ][ eta 00m:01s ] mytest: ( groupid = 0 , jobs = 6 ) : err = 0 : pid = 107996 : Mon Aug 1 14 :51:00 2022 write: IOPS = 131 , BW = 131MiB/s ( 138MB/s )( 1200MiB/9131msec ) ; 0 zone resets slat ( usec ) : min = 41 , max = 13194 , avg = 208 .41, stdev = 756 .44 clat ( msec ) : min = 20 , max = 3855 , avg = 1392 .05, stdev = 816 .66 lat ( msec ) : min = 20 , max = 3855 , avg = 1392 .26, stdev = 816 .65 clat percentiles ( msec ) : | 1 .00th =[ 284 ] , 5 .00th =[ 351 ] , 10 .00th =[ 435 ] , 20 .00th =[ 625 ] , | 30 .00th =[ 885 ] , 40 .00th =[ 1099 ] , 50 .00th =[ 1234 ] , 60 .00th =[ 1418 ] , | 70 .00th =[ 1620 ] , 80 .00th =[ 1938 ] , 90 .00th =[ 2769 ] , 95 .00th =[ 2903 ] , | 99 .00th =[ 3608 ] , 99 .50th =[ 3675 ] , 99 .90th =[ 3809 ] , 99 .95th =[ 3842 ] , | 99 .99th =[ 3842 ] bw ( KiB/s ) : min = 24554 , max = 273468 , per = 99 .58%, avg = 134013 .71, stdev = 11587 .87, samples = 93 iops : min = 22 , max = 267 , avg = 130 .28, stdev = 11 .35, samples = 93 lat ( msec ) : 50 = 0 .25%, 250 = 0 .33%, 500 = 13 .33%, 750 = 11 .50%, 1000 = 10 .08% lat ( msec ) : 2000 = 44 .92%, > = 2000 = 19 .58% cpu : usr = 0 .18%, sys = 0 .09%, ctx = 792 , majf = 1 , minf = 6 IO depths : 1 = 0 .5%, 2 = 1 .0%, 4 = 2 .0%, 8 = 4 .0%, 16 = 8 .0%, 32 = 84 .5%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 99 .4%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .6%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,1200,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 32 Run status group 0 ( all jobs ) : WRITE: bw = 131MiB/s ( 138MB/s ) , 131MiB/s-131MiB/s ( 138MB/s-138MB/s ) , io = 1200MiB ( 1258MB ) , run = 9131 -9131msec Disk stats ( read/write ) : rbd0: ios = 0 /887, merge = 0 /280, ticks = 0 /1112233, in_queue = 1110460 , util = 16 .67%","title":"\u793a\u4f8b\uff1a"},{"location":"5.Storage/osd/#rbd-bench","text":"","title":"\u65b9\u6cd5\u4e8c\uff1aRBD bench \u538b\u529b\u6d4b\u8bd5"},{"location":"5.Storage/osd/#_4","text":"[ ucloud ] root@master0:~# rbd help bench usage : rbd bench [--pool <pool>] [--namespace <namespace>] [--image <image>] [--io-size <io-size>] [--io-threads <io-threads>] [--io-total <io-total>] [--io-pattern <io-pattern>] [--rw-mix-read <rw-mix-read>] --io-type <io-type> <image-spec> Simple benchmark. Positional arguments <image-spec> image specification (example : [ <pool-name>/ [ <namespace>/ ]] <image-name>) Optional arguments -p [ --pool ] arg pool name # \u6307\u5b9apool\u7684\u540d\u79f0 --namespace arg namespace name # \u6307\u5b9anamespace --image arg image name --io-size arg IO size (in B/K/M/G/T) [default : 4K] # \u6307\u5b9aIO\u5927\u5c0f --io-threads arg ios in flight [default : 16] # \u6307\u5b9a\u5e76\u53d1 --io-total arg total size for IO (in B/K/M/G/T) [default : 1G] # \u6570\u636e\u7684\u5927\u5c0f --io-pattern arg IO pattern (rand, seq, or full-seq) [default : seq] # iops\uff08rand\u4e3a\u968f\u673a\uff0cseq\u987a\u5e8f\uff09 --rw-mix-read arg read proportion in readwrite (<= 100) [default : 50] # --rw-mix-read \u6df7\u5408\u8bfb\u5199\u8bfb\u7684\u5360\u6bd4 --io-type arg IO type (read, write, or readwrite(rw)) # \u7c7b\u578b\uff0c\u8981\u4ee5\u4ec0\u4e48\u65b9\u5f0f\u538b\u6d4b\uff0c\u8bfb\u6216\u8005\u5199","title":"\u53c2\u6570\u8bf4\u660e\uff1a"},{"location":"5.Storage/osd/#_5","text":"\u6e29\u99a8\u63d0\u793a \u538b\u6d4b\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7iostat -x 1 \u5bf9\u78c1\u76d8\u8fdb\u884c\u76d1\u63a7 - ceph osd perf \u53ef\u4ee5\u4f7f\u7528\u8be5\u547d\u4ee4\u67e5\u770bosd\u5ef6\u8fdf\u60c5\u51b5 4K\u968f\u673a\u5199 rbd bench rook/rook-rbd.img --io-size 4K --io-threads 16 --io-total 1G --io-pattern rand --io-type write bench type write io_size 4096 io_threads 16 bytes 1073741824 pattern random SEC OPS OPS/SEC BYTES/SEC 1 5536 5574 .28 22 MiB/s 2 9664 4849 .68 19 MiB/s 3 13776 4603 .46 18 MiB/s 4 17968 4500 .49 18 MiB/s ...... 64 261440 3935 .99 15 MiB/s elapsed: 64 ops: 262144 ops/sec: 4064 .99 bytes/sec: 16 MiB/s # \u6d4b\u8bd5\u51fa\u5f53\u524d\u7684iops\u4e3a4064.99 4K\u968f\u673a\u8bfb [ ucloud ] root@master0:~# rbd bench rook/rook-rbd.img --io-size 4K --io-threads 16 --io-total 1G --io-pattern rand --io-type read bench type read io_size 4096 io_threads 16 bytes 1073741824 pattern random SEC OPS OPS/SEC BYTES/SEC 1 26816 26939 .7 105 MiB/s 2 53728 26925 .8 105 MiB/s 3 81648 27257 .6 106 MiB/s 4 90896 22569 .9 88 MiB/s 5 115328 23087 .2 90 MiB/s 6 142416 23119 .9 90 MiB/s 7 170048 23263 .9 91 MiB/s 8 197104 23091 .1 90 MiB/s 9 225264 27046 .6 106 MiB/s 10 253360 27606 .3 108 MiB/s elapsed: 10 ops: 262144 ops/sec: 25391 .6 bytes/sec: 99 MiB/s # \u6d4b\u8bd5\u51fa\u5f53\u524d\u7684iops\u4e3a25391.6 4K\u968f\u673a\u6df7\u5408\u8bfb\u5199 [ ucloud ] root@master0:~# rbd bench rook/rook-rbd.img --io-size 4K --io-threads 16 --io-total 1G --io-pattern rand --io-type readwrite --rw-mix-read 70 bench type readwrite read:write = 70 :30 io_size 4096 io_threads 16 bytes 1073741824 pattern random SEC OPS OPS/SEC BYTES/SEC 1 12144 12208 .8 48 MiB/s 2 23488 11775 .5 46 MiB/s 3 34624 11562 45 MiB/s 4 45552 11403 .4 45 MiB/s 5 56528 11317 .8 44 MiB/s 6 67664 11104 43 MiB/s 7 78976 11097 .6 43 MiB/s 8 89872 11049 .6 43 MiB/s 9 101216 11132 .8 43 MiB/s 10 112608 11216 44 MiB/s ..... elapsed: 23 ops: 262144 ops/sec: 11012 .6 bytes/sec: 43 MiB/s read_ops: 183730 read_ops/sec: 7718 .43 read_bytes/sec: 30 MiB/s write_ops: 78414 write_ops/sec: 3294 .14 write_bytes/sec: 13 MiB/s 1M\u987a\u5e8f\u5199\uff08\u6d4b\u541e\u5410\u91cf\uff09 [ ucloud ] root@master0:~# rbd bench rook/rook-rbd.img --io-size 1M --io-threads 16 --io-total 200M --io-pattern seq --io-type write bench type write io_size 1048576 io_threads 16 bytes 209715200 pattern sequential SEC OPS OPS/SEC BYTES/SEC 1 160 175 .298 175 MiB/s elapsed: 1 ops: 200 ops/sec: 136 .986 bytes/sec: 137 MiB/s https://bench.sh/","title":"\u793a\u4f8b\uff1a"},{"location":"5.Storage/pv-rep/","text":"k8s pv \u548c pvc \u00b6 \u76ee\u524dPV\u7684\u63d0\u4f9b\u65b9\u5f0f\u6709\u4e24\u79cd\uff1a\u9759\u6001\u6216\u52a8\u6001\u3002(pv \u6ca1\u6709\u547d\u540d\u7a7a\u95f4\u9650\u5236) \u9759\u6001PV\u7531\u7ba1\u7406\u5458\u63d0\u524d\u521b\u5efa\uff0c\u52a8\u6001PV\u65e0\u9700\u63d0\u524d\u521b\u5efa\uff0c\u53ea\u9700\u6307\u5b9aPVC\u7684StorageClasse\u5373\u53ef \u56de\u6536\u7b56\u7565 \u00b6 Retain\uff1a\u4fdd\u7559\uff0c\u8be5\u7b56\u7565\u5141\u8bb8\u624b\u52a8\u56de\u6536\u8d44\u6e90\uff0c\u5f53\u5220\u9664PVC\u65f6\uff0cPV\u4ecd\u7136\u5b58\u5728\uff0cPV\u88ab\u89c6\u4e3a\u5df2\u91ca\u653e\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u624b\u52a8\u56de\u6536\u5377\u3002 Recycle\uff1a\u56de\u6536\uff0c\u5982\u679cVolume\u63d2\u4ef6\u652f\u6301\uff0cRecycle\u7b56\u7565\u4f1a\u5bf9\u5377\u6267\u884crm -rf\u6e05\u7406\u8be5PV\uff0c\u5e76\u4f7f\u5176\u53ef\u7528\u4e8e\u4e0b\u4e00\u4e2a\u65b0\u7684PVC\uff0c\u4f46\u662f\u672c\u7b56\u7565\u5c06\u6765\u4f1a\u88ab\u5f03\u7528\uff0c\u76ee\u524d\u53ea\u6709NFS\u548cHostPath\u652f\u6301\u8be5\u7b56\u7565\u3002\uff08\u4e0d\u63a8\u8350\u4f7f\u7528\uff09 Delete\uff1a\u5220\u9664\uff0c\u5982\u679cVolume\u63d2\u4ef6\u652f\u6301\uff0c\u5220\u9664PVC\u65f6\u4f1a\u540c\u65f6\u5220\u9664PV\uff0c\u52a8\u6001\u5377\u9ed8\u8ba4\u4e3aDelete\uff0c\u76ee\u524d\u652f\u6301Delete\u7684\u5b58\u50a8\u540e\u7aef\u5305\u62ecAWS EBS, GCE PD, Azure Disk, or OpenStack Cinder\u7b49\u3002 \u53ef\u4ee5\u901a\u8fc7persistentVolumeReclaimPolicy: Recycle\u5b57\u6bb5\u914d\u7f6e \u5b98\u7f51\u6587\u732e: pv \u56de\u6536\u7b56\u7565 pv \u7684\u72b6\u6001 \u00b6 Available\uff1a\u53ef\u7528\uff0c\u6ca1\u6709\u88abPVC\u7ed1\u5b9a\u7684\u7a7a\u95f2\u8d44\u6e90\u3002 Bound\uff1a\u5df2\u7ed1\u5b9a\uff0c\u5df2\u7ecf\u88abPVC\u7ed1\u5b9a\u3002 Released\uff1a\u5df2\u91ca\u653e\uff0cPVC\u88ab\u5220\u9664\uff0c\u4f46\u662f\u8d44\u6e90\u8fd8\u672a\u88ab\u91cd\u65b0\u4f7f\u7528\u3002 Failed\uff1a\u5931\u8d25\uff0c\u81ea\u52a8\u56de\u6536\u5931\u8d25\u3002 pv/pvc \u7684\u521b\u5efa \u00b6 \u521b\u5efaPV apiVersion : v1 kind : PersistentVolume # \u8d44\u6e90\u5bf9\u8c61\u7684\u540d\u79f0\u4e3a pv metadata : name : pv-nfs # pv \u7684\u540d\u79f0\u4e3a\u8bbe\u7f6e\u4e3a pv-nfs spec : capacity : # capacity\uff1a\u5bb9\u91cf\u914d\u7f6e storage : 5Gi volumeMode : Filesystem # \u5377\u7684\u6a21\u5f0f\uff0c\u76ee\u524d\u652f\u6301Filesystem\uff08\u6587\u4ef6\u7cfb\u7edf\uff09 \u548c Block\uff08\u5757\uff09\uff0c\u5176\u4e2dBlock\u7c7b\u578b\u9700\u8981\u540e\u7aef\u5b58\u50a8\u652f\u6301\uff0c\u9ed8\u8ba4\u4e3a\u6587\u4ef6\u7cfb\u7edf accessModes : # \u8be5PV\u7684\u8bbf\u95ee\u6a21\u5f0f(\u8fd9\u91cc\u53ef\u4ee5\u5199\u591a\u4e2a\u6a21\u5f0f) - ReadWriteMany persistentVolumeReclaimPolicy : Recycle # \u56de\u6536\u7b56\u7565 storageClassName : nfs-slow # pvc \u60f3\u7ed1\u5b9a pv,\u9700\u8981\u6307\u5b9astorageClassName\u8fd9\u4e2a\u540d\u79f0 nfs : path : /nfs/share server : 192.168.159.201 \u521b\u5efaPVC root@ubuntu:/opt/k8s-data/pv-pvc# cat 3-pvc.yaml kind : PersistentVolumeClaim apiVersion : v1 metadata : name : nfs # pvc\u7684\u540d\u79f0 spec : storageClassName : nfs-slow # pv \u7684storageClassName ,\u5fc5\u987b\u4e00\u81f4 accessModes : - ReadWriteMany # \u5fc5\u987b\u4e00\u81f4 resources : requests : storage : 100Gi \u8bbf\u95ee\u6a21\u5f0f: ReadWriteOnce:\u53ef\u8bfb\u53ef\u5199\uff0c\u4f46\u53ea\u652f\u6301\u88ab\u5355\u4e2anode\u6302\u8f7d\u3002\u8be5\u8bbf\u95ee\u6a21\u5f0f\u7ea6\u675f\u4ec5\u6709\u4e00\u4e2anode\u8282\u70b9\u53ef\u4ee5\u8bbf\u95eepvc\u3002\u6362\u53e5\u8bdd\u6765\u8bf4\uff0c\u540c\u4e00node\u8282\u70b9\u7684\u4e0d\u540cpod\u662f\u53ef\u4ee5\u5bf9\u540c\u4e00pvc\u8fdb\u884c\u8bfb\u5199\u7684 ReadOnlyMany:\u53ef\u4ee5\u4ee5\u53ea\u8bfb\u7684\u65b9\u5f0f\u88ab\u591a\u4e2anode\u6302\u8f7d ReadWriteMany:\u53ef\u4ee5\u4ee5\u8bfb\u5199\u7684\u65b9\u5f0f\u88ab\u591a\u4e2anode\u6302\u8f7d ReadWriteOncePod\uff1a\u4ec5\u6709\u4e00\u4e2aPod\u53ef\u4ee5\u8bbf\u95ee\u4f7f\u7528\u8be5pvc\uff08Kubernetes >= v1.22\uff09\u5f53\u4f60\u521b\u5efa\u4e00\u4e2a\u5e26\u6709pvc\u8bbf\u95ee\u6a21\u5f0f\u4e3aReadWriteOncePod\u7684Pod A\u65f6\uff0cKubernetes\u786e\u4fdd\u6574\u4e2a\u96c6\u7fa4\u5185\u53ea\u6709\u4e00\u4e2aPod\u53ef\u4ee5\u8bfb\u5199\u8be5PVC\u3002\u6b64\u65f6\u5982\u679c\u4f60\u521b\u5efaPod B\u5e76\u5f15\u7528\u4e86\u4e0ePod A\u76f8\u540c\u7684PVC(ReadWriteOncePod)\u65f6\uff0c\u90a3\u4e48Pod B\u4f1a\u7531\u4e8e\u8be5pvc\u88abPod A\u5f15\u7528\u800c\u542f\u52a8\u5931\u8d25\u3002 \u4e0a\u6d77\u4ea4\u5927\u4fee\u590dpv\u6b65\u9aa4 \u00b6 \u8fd9\u91cc\u4e3b\u8981\u662fkubeadm\u90e8\u7f72\u7684k8s \u73b0\u8c61 \u00b6 PV\u4e0d\u77e5\u9053\u56e0\u4e3a\u4ec0\u4e48\u539f\u56e0\u5904\u4e8eTerminating. \u4fee\u590dPV \u00b6 \u6587\u7ae0\u53c2\u8003\uff1ahttps://github.com/jianz/k8s-reset-terminating-pv \u7aef\u53e3\u8f6c\u53d1\u5230\u672c\u5730 \u00b6 kubectl port-forward pods/etcd-master 2379 :2379 -n kube-system \u4fee\u590dpv \u00b6 ./resetpv-linux-x86-64 --k8s-key-prefix registry pvc-bd426570-7fc2-4270-bd41-9512262b0790 --etcd-ca = /etc/kubernetes/pki/etcd/ca.crt --etcd-cert = /etc/kubernetes/pki/etcd/server.crt --etcd-key = /etc/kubernetes/pki/etcd/server.key Warning pvc-bd426570-7fc2-4270-bd41-9512262b0790 \u662f\u5904\u4e8eTerminating\u7684pv\uff0c\u4fee\u590d\u5b8c\u6210pv\u5904\u4e8eBound\u72b6\u6001 k8s\u5347\u7ea7\u5bfc\u81f4sc\u65e0\u6cd5\u6b63\u5e38work \u00b6 \u53c2\u8003\u5730\u5740: sc\u65e0\u6cd5\u6b63\u5e38work Bug Using Kubernetes v1.20.0, getting \"unexpected error getting claim reference: selfLink was empty, can't make reference \u5f53\u524d\u7684\u89e3\u51b3\u65b9\u6cd5\u662f\u7f16\u8f91 /etc/kubernetes/manifests/kube-apiserver.yaml \u6dfb\u52a0\u8fd9\u4e00\u884c\uff1a ---feature-gates = RemoveSelfLink = false \u4eb2\u548c\u6027\u5bfc\u81f4rook-ceph\u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528 \u00b6 Bug unable to get monitor info from DNS SRV with service name: ceph-mon \u53d6\u6d88\u4eb2\u548c\u6027\u7684\u914d\u7f6e","title":"kubernetes pv/pvc\u7b80\u4ecb"},{"location":"5.Storage/pv-rep/#k8s-pv-pvc","text":"\u76ee\u524dPV\u7684\u63d0\u4f9b\u65b9\u5f0f\u6709\u4e24\u79cd\uff1a\u9759\u6001\u6216\u52a8\u6001\u3002(pv \u6ca1\u6709\u547d\u540d\u7a7a\u95f4\u9650\u5236) \u9759\u6001PV\u7531\u7ba1\u7406\u5458\u63d0\u524d\u521b\u5efa\uff0c\u52a8\u6001PV\u65e0\u9700\u63d0\u524d\u521b\u5efa\uff0c\u53ea\u9700\u6307\u5b9aPVC\u7684StorageClasse\u5373\u53ef","title":"k8s pv \u548c pvc"},{"location":"5.Storage/pv-rep/#_1","text":"Retain\uff1a\u4fdd\u7559\uff0c\u8be5\u7b56\u7565\u5141\u8bb8\u624b\u52a8\u56de\u6536\u8d44\u6e90\uff0c\u5f53\u5220\u9664PVC\u65f6\uff0cPV\u4ecd\u7136\u5b58\u5728\uff0cPV\u88ab\u89c6\u4e3a\u5df2\u91ca\u653e\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u624b\u52a8\u56de\u6536\u5377\u3002 Recycle\uff1a\u56de\u6536\uff0c\u5982\u679cVolume\u63d2\u4ef6\u652f\u6301\uff0cRecycle\u7b56\u7565\u4f1a\u5bf9\u5377\u6267\u884crm -rf\u6e05\u7406\u8be5PV\uff0c\u5e76\u4f7f\u5176\u53ef\u7528\u4e8e\u4e0b\u4e00\u4e2a\u65b0\u7684PVC\uff0c\u4f46\u662f\u672c\u7b56\u7565\u5c06\u6765\u4f1a\u88ab\u5f03\u7528\uff0c\u76ee\u524d\u53ea\u6709NFS\u548cHostPath\u652f\u6301\u8be5\u7b56\u7565\u3002\uff08\u4e0d\u63a8\u8350\u4f7f\u7528\uff09 Delete\uff1a\u5220\u9664\uff0c\u5982\u679cVolume\u63d2\u4ef6\u652f\u6301\uff0c\u5220\u9664PVC\u65f6\u4f1a\u540c\u65f6\u5220\u9664PV\uff0c\u52a8\u6001\u5377\u9ed8\u8ba4\u4e3aDelete\uff0c\u76ee\u524d\u652f\u6301Delete\u7684\u5b58\u50a8\u540e\u7aef\u5305\u62ecAWS EBS, GCE PD, Azure Disk, or OpenStack Cinder\u7b49\u3002 \u53ef\u4ee5\u901a\u8fc7persistentVolumeReclaimPolicy: Recycle\u5b57\u6bb5\u914d\u7f6e \u5b98\u7f51\u6587\u732e: pv \u56de\u6536\u7b56\u7565","title":"\u56de\u6536\u7b56\u7565"},{"location":"5.Storage/pv-rep/#pv","text":"Available\uff1a\u53ef\u7528\uff0c\u6ca1\u6709\u88abPVC\u7ed1\u5b9a\u7684\u7a7a\u95f2\u8d44\u6e90\u3002 Bound\uff1a\u5df2\u7ed1\u5b9a\uff0c\u5df2\u7ecf\u88abPVC\u7ed1\u5b9a\u3002 Released\uff1a\u5df2\u91ca\u653e\uff0cPVC\u88ab\u5220\u9664\uff0c\u4f46\u662f\u8d44\u6e90\u8fd8\u672a\u88ab\u91cd\u65b0\u4f7f\u7528\u3002 Failed\uff1a\u5931\u8d25\uff0c\u81ea\u52a8\u56de\u6536\u5931\u8d25\u3002","title":"pv \u7684\u72b6\u6001"},{"location":"5.Storage/pv-rep/#pvpvc","text":"\u521b\u5efaPV apiVersion : v1 kind : PersistentVolume # \u8d44\u6e90\u5bf9\u8c61\u7684\u540d\u79f0\u4e3a pv metadata : name : pv-nfs # pv \u7684\u540d\u79f0\u4e3a\u8bbe\u7f6e\u4e3a pv-nfs spec : capacity : # capacity\uff1a\u5bb9\u91cf\u914d\u7f6e storage : 5Gi volumeMode : Filesystem # \u5377\u7684\u6a21\u5f0f\uff0c\u76ee\u524d\u652f\u6301Filesystem\uff08\u6587\u4ef6\u7cfb\u7edf\uff09 \u548c Block\uff08\u5757\uff09\uff0c\u5176\u4e2dBlock\u7c7b\u578b\u9700\u8981\u540e\u7aef\u5b58\u50a8\u652f\u6301\uff0c\u9ed8\u8ba4\u4e3a\u6587\u4ef6\u7cfb\u7edf accessModes : # \u8be5PV\u7684\u8bbf\u95ee\u6a21\u5f0f(\u8fd9\u91cc\u53ef\u4ee5\u5199\u591a\u4e2a\u6a21\u5f0f) - ReadWriteMany persistentVolumeReclaimPolicy : Recycle # \u56de\u6536\u7b56\u7565 storageClassName : nfs-slow # pvc \u60f3\u7ed1\u5b9a pv,\u9700\u8981\u6307\u5b9astorageClassName\u8fd9\u4e2a\u540d\u79f0 nfs : path : /nfs/share server : 192.168.159.201 \u521b\u5efaPVC root@ubuntu:/opt/k8s-data/pv-pvc# cat 3-pvc.yaml kind : PersistentVolumeClaim apiVersion : v1 metadata : name : nfs # pvc\u7684\u540d\u79f0 spec : storageClassName : nfs-slow # pv \u7684storageClassName ,\u5fc5\u987b\u4e00\u81f4 accessModes : - ReadWriteMany # \u5fc5\u987b\u4e00\u81f4 resources : requests : storage : 100Gi \u8bbf\u95ee\u6a21\u5f0f: ReadWriteOnce:\u53ef\u8bfb\u53ef\u5199\uff0c\u4f46\u53ea\u652f\u6301\u88ab\u5355\u4e2anode\u6302\u8f7d\u3002\u8be5\u8bbf\u95ee\u6a21\u5f0f\u7ea6\u675f\u4ec5\u6709\u4e00\u4e2anode\u8282\u70b9\u53ef\u4ee5\u8bbf\u95eepvc\u3002\u6362\u53e5\u8bdd\u6765\u8bf4\uff0c\u540c\u4e00node\u8282\u70b9\u7684\u4e0d\u540cpod\u662f\u53ef\u4ee5\u5bf9\u540c\u4e00pvc\u8fdb\u884c\u8bfb\u5199\u7684 ReadOnlyMany:\u53ef\u4ee5\u4ee5\u53ea\u8bfb\u7684\u65b9\u5f0f\u88ab\u591a\u4e2anode\u6302\u8f7d ReadWriteMany:\u53ef\u4ee5\u4ee5\u8bfb\u5199\u7684\u65b9\u5f0f\u88ab\u591a\u4e2anode\u6302\u8f7d ReadWriteOncePod\uff1a\u4ec5\u6709\u4e00\u4e2aPod\u53ef\u4ee5\u8bbf\u95ee\u4f7f\u7528\u8be5pvc\uff08Kubernetes >= v1.22\uff09\u5f53\u4f60\u521b\u5efa\u4e00\u4e2a\u5e26\u6709pvc\u8bbf\u95ee\u6a21\u5f0f\u4e3aReadWriteOncePod\u7684Pod A\u65f6\uff0cKubernetes\u786e\u4fdd\u6574\u4e2a\u96c6\u7fa4\u5185\u53ea\u6709\u4e00\u4e2aPod\u53ef\u4ee5\u8bfb\u5199\u8be5PVC\u3002\u6b64\u65f6\u5982\u679c\u4f60\u521b\u5efaPod B\u5e76\u5f15\u7528\u4e86\u4e0ePod A\u76f8\u540c\u7684PVC(ReadWriteOncePod)\u65f6\uff0c\u90a3\u4e48Pod B\u4f1a\u7531\u4e8e\u8be5pvc\u88abPod A\u5f15\u7528\u800c\u542f\u52a8\u5931\u8d25\u3002","title":"pv/pvc \u7684\u521b\u5efa"},{"location":"5.Storage/pv-rep/#pv_1","text":"\u8fd9\u91cc\u4e3b\u8981\u662fkubeadm\u90e8\u7f72\u7684k8s","title":"\u4e0a\u6d77\u4ea4\u5927\u4fee\u590dpv\u6b65\u9aa4"},{"location":"5.Storage/pv-rep/#_2","text":"PV\u4e0d\u77e5\u9053\u56e0\u4e3a\u4ec0\u4e48\u539f\u56e0\u5904\u4e8eTerminating.","title":"\u73b0\u8c61"},{"location":"5.Storage/pv-rep/#pv_2","text":"\u6587\u7ae0\u53c2\u8003\uff1ahttps://github.com/jianz/k8s-reset-terminating-pv","title":"\u4fee\u590dPV"},{"location":"5.Storage/pv-rep/#_3","text":"kubectl port-forward pods/etcd-master 2379 :2379 -n kube-system","title":"\u7aef\u53e3\u8f6c\u53d1\u5230\u672c\u5730"},{"location":"5.Storage/pv-rep/#pv_3","text":"./resetpv-linux-x86-64 --k8s-key-prefix registry pvc-bd426570-7fc2-4270-bd41-9512262b0790 --etcd-ca = /etc/kubernetes/pki/etcd/ca.crt --etcd-cert = /etc/kubernetes/pki/etcd/server.crt --etcd-key = /etc/kubernetes/pki/etcd/server.key Warning pvc-bd426570-7fc2-4270-bd41-9512262b0790 \u662f\u5904\u4e8eTerminating\u7684pv\uff0c\u4fee\u590d\u5b8c\u6210pv\u5904\u4e8eBound\u72b6\u6001","title":"\u4fee\u590dpv"},{"location":"5.Storage/pv-rep/#k8sscwork","text":"\u53c2\u8003\u5730\u5740: sc\u65e0\u6cd5\u6b63\u5e38work Bug Using Kubernetes v1.20.0, getting \"unexpected error getting claim reference: selfLink was empty, can't make reference \u5f53\u524d\u7684\u89e3\u51b3\u65b9\u6cd5\u662f\u7f16\u8f91 /etc/kubernetes/manifests/kube-apiserver.yaml \u6dfb\u52a0\u8fd9\u4e00\u884c\uff1a ---feature-gates = RemoveSelfLink = false","title":"k8s\u5347\u7ea7\u5bfc\u81f4sc\u65e0\u6cd5\u6b63\u5e38work"},{"location":"5.Storage/pv-rep/#rook-ceph","text":"Bug unable to get monitor info from DNS SRV with service name: ceph-mon \u53d6\u6d88\u4eb2\u548c\u6027\u7684\u914d\u7f6e","title":"\u4eb2\u548c\u6027\u5bfc\u81f4rook-ceph\u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528"},{"location":"5.Storage/rbd-docs/","text":"RBD\u5757\u5b58\u50a8 \u00b6 \u6821\u9a8cpool\u5b89\u88c5\u60c5\u51b5 ceph osd lspools # \u67e5\u770bpool ceph osd pool create rook 16 16 # \u521b\u5efa\u4e00\u4e2arook\u6c60 rbd create -p rook --image rook-rbd.img --size 10G # \u5728pool\u4e0a\u521b\u5efaRBD\u5757\u8bbe\u5907 rbd info rook/rook-rbd.img # \u67e5\u770b\u5757\u7684\u8be6\u7ec6\u4fe1\u606f ceph osd pool get replicapool size # \u67e5\u770bpool\u526f\u672c \u5ba2\u6237\u6302\u8f7dRBD\u5757 [pre] root@m1:~# rbd showmapped id pool namespace image snap device 0 replicapool csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be - /dev/rbd0 1 replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 - /dev/rbd1 [pre] root@m1:~# mkfs.xfs /dev/rbd1 [pre] root@m1:~# mount /dev/rbd1 /data \u67e5\u770breplicapool\u7684\u5757 bash-4.4$ rbd ls -l replicapool NAME SIZE PARENT FMT PROT LOCK csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 110 GiB 2 csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be 50 GiB 2 csi-vol-d3ab89af-5069-11ee-bfc4-4e736d2f91be 50 GiB 2 bash-4.4$ rbd -p replicapool info csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 rbd image 'csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2': size 110 GiB in 28160 objects order 22 (4 MiB objects) snapshot_count: 0 id: 1b8e31cc42074 block_name_prefix: rbd_data.1b8e31cc42074 format: 2 features: layering op_features: flags: create_timestamp: Sun Aug 13 07:58:39 2023 access_timestamp: Sun Aug 13 07:58:39 2023 modify_timestamp: Sun Aug 13 07:58:39 2023","title":"ceph RBD\u4f7f\u7528"},{"location":"5.Storage/rbd-docs/#rbd","text":"\u6821\u9a8cpool\u5b89\u88c5\u60c5\u51b5 ceph osd lspools # \u67e5\u770bpool ceph osd pool create rook 16 16 # \u521b\u5efa\u4e00\u4e2arook\u6c60 rbd create -p rook --image rook-rbd.img --size 10G # \u5728pool\u4e0a\u521b\u5efaRBD\u5757\u8bbe\u5907 rbd info rook/rook-rbd.img # \u67e5\u770b\u5757\u7684\u8be6\u7ec6\u4fe1\u606f ceph osd pool get replicapool size # \u67e5\u770bpool\u526f\u672c \u5ba2\u6237\u6302\u8f7dRBD\u5757 [pre] root@m1:~# rbd showmapped id pool namespace image snap device 0 replicapool csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be - /dev/rbd0 1 replicapool csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 - /dev/rbd1 [pre] root@m1:~# mkfs.xfs /dev/rbd1 [pre] root@m1:~# mount /dev/rbd1 /data \u67e5\u770breplicapool\u7684\u5757 bash-4.4$ rbd ls -l replicapool NAME SIZE PARENT FMT PROT LOCK csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 110 GiB 2 csi-vol-a5f69213-4bbd-11ee-bfc4-4e736d2f91be 50 GiB 2 csi-vol-d3ab89af-5069-11ee-bfc4-4e736d2f91be 50 GiB 2 bash-4.4$ rbd -p replicapool info csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2 rbd image 'csi-vol-36c61ced-39af-11ee-821b-2e922eb2eef2': size 110 GiB in 28160 objects order 22 (4 MiB objects) snapshot_count: 0 id: 1b8e31cc42074 block_name_prefix: rbd_data.1b8e31cc42074 format: 2 features: layering op_features: flags: create_timestamp: Sun Aug 13 07:58:39 2023 access_timestamp: Sun Aug 13 07:58:39 2023 modify_timestamp: Sun Aug 13 07:58:39 2023","title":"RBD\u5757\u5b58\u50a8"},{"location":"5.Storage/redis-cluster-docs/","text":"Redis\u7fa4\u96c6 \u00b6 \u6211\u4eec\u65e5\u5e38\u5728\u5bf9\u4e8eredis\u7684\u4f7f\u7528\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff1a \u9ad8\u53ef\u7528\u95ee\u9898\uff0c\u5982\u4f55\u4fdd\u8bc1redis\u7684\u6301\u7eed\u9ad8\u53ef\u7528\u6027\u3002 \u5bb9\u91cf\u95ee\u9898\uff0c\u5355\u5b9e\u4f8bredis\u5185\u5b58\u65e0\u6cd5\u65e0\u9650\u6269\u5145\uff0c\u8fbe\u523032G\u540e\u5c31\u8fdb\u5165\u4e8664\u4f4d\u4e16\u754c\uff0c\u6027\u80fd\u4e0b\u964d\u3002 \u5e76\u53d1\u6027\u80fd\u95ee\u9898\uff0credis\u53f7\u79f0\u5355\u5b9e\u4f8b10\u4e07\u5e76\u53d1\uff0c\u4f46\u4e5f\u662f\u6709\u5c3d\u5934\u7684\u3002 Redis cluster\u4ecb\u7ecd \u00b6 Redis cluster \u662fredis\u7684\u5206\u5e03\u5f0f\u89e3\u51b3\u65b9\u6848\uff0c\u5728redis3.0\u7248\u672c\u4e2d\u6b63\u5f0f\u63a8\u51fa\u7684\u91c7\u7528\u7684\u662fhash slot\uff08hash\u69fd\uff09\uff0c\u53ef\u4ee5\u5c06\u591a\u4e2aRedis\u5b9e\u4f8b\u6574\u5408\u5728\u4e00\u8d77\uff0c\u5f62\u6210\u4e00\u4e2a\u96c6\u7fa4\uff0c\u4e5f\u5c31\u662f\u5c06\u6570\u636e\u5206\u6563\u5230\u96c6\u7fa4\u7684\u591a\u53f0\u673a\u5668\u4e0a\u3002\u6709\u6548\u7684\u89e3\u51b3\u4e86redis\u5206\u5e03\u5f0f\u65b9\u9762\u7684\u9700\u6c42\uff0c\u5f53\u9047\u5230\u5355\u673a\u5185\u5b58\u3001\u5f00\u53d1\u3001\u6d41\u91cf\u7b49\u74f6\u9888\u65f6\uff0c\u53ef\u4ee5\u91c7\u7528cluster\u67b6\u6784\u8fbe\u5230\u8d1f\u8f7d\u5747\u8861\u7684\u76ee\u7684\u3002 redis-cluster\u7684\u4f18\u52bf: 1.\u5b98\u65b9\u63a8\u8350\uff0c\u6bcb\u5eb8\u7f6e\u7591\u3002 2.\u53bb\u4e2d\u5fc3\u5316\uff0c\u96c6\u7fa4\u6700\u5927\u53ef\u589e\u52a01000\u4e2a\u8282\u70b9\uff0c\u6027\u80fd\u968f\u8282\u70b9\u589e\u52a0\u800c\u7ebf\u6027\u6269\u5c55\u3002 3.\u7ba1\u7406\u65b9\u4fbf\uff0c\u540e\u7eed\u53ef\u81ea\u884c\u589e\u52a0\u6216\u6458\u9664\u8282\u70b9\uff0c\u79fb\u52a8\u5206\u69fd\u7b49\u7b49\u3002 4.\u7b80\u5355\uff0c\u6613\u4e0a\u624b\u3002 Redis\u6570\u636e\u5206\u5e03 \u00b6 \u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e3b\u8981\u89e3\u51b3\u628a\u6574\u4e2a\u6570\u636e\u96c6\u6309\u7167\u5206\u533a\u89c4\u5219\u6620\u5c04\u5230\u591a\u4e2a\u8282\u70b9\u7684\u95ee\u9898\uff0c\u5373\u628a\u6570\u636e\u96c6\u5212\u5206\u5230\u591a\u4e2a\u8282\u70b9\u4e0a\uff0c\u6bcf\u4e2a\u8282\u70b9\u8d1f\u8d23\u6574\u4e2a\u6570\u636e\u7684\u4e00\u4e2a\u5b50\u96c6\u3002\u5e38\u89c1\u7684\u5206\u533a\u89c4\u5219\u6709\u54c8\u5e0c\u5206\u533a\u548c\u987a\u5e8f\u5206\u533a\u3002Redis cluster\u91c7\u7528\u54c8\u5e0c\u5206\u533a\u89c4\u5219\uff0c\u56e0\u6b64\u63a5\u4e0b\u6765\u4f1a\u8ba8\u8bba\u54c8\u5e0c\u89c4\u5219\uff0c\u5e38\u89c1\u7684\u54c8\u5e0c\u5206\u533a\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a(redis cluster\u91c7\u7528\u865a\u62df\u69fd\u5206\u533a) 1.\u8282\u70b9\u53d6\u4f59 2.\u4e00\u81f4\u6027\u54c8\u5e0c\u5206\u533a 3.\u865a\u62df\u69fd\u5206\u533a \u865a\u62df\u69fd\u5206\u533a \u00b6 \u865a\u62df\u69fd\u5206\u533a\u5de7\u5999\u5730\u4f7f\u7528\u4e86\u54c8\u5e0c\u7a7a\u95f4\uff0c\u4f7f\u7528\u5206\u6563\u5ea6\u826f\u597d\u7684\u54c8\u5e0c\u51fd\u6570\u628a\u6240\u6709\u7684\u6570\u636e\u6620\u5c04\u5230\u4e00\u4e2a\u56fa\u5b9a\u7684\u8303\u56f4\u5185\u7684\u6574\u6570\u96c6\u5408\u3002Redis Cluster\u69fd\u7684\u8303\u56f4\u662f0-16383\u3002\u69fd\u662f\u96c6\u7fa4\u6570\u636e\u7ba1\u7406\u548c\u8fc1\u79fb\u7684\u57fa\u672c\u7684\u5355\u4f4d\u3002\u91c7\u7528\u5927\u8303\u56f4\u69fd\u7684\u4e3b\u8981\u76ee\u7684\u662f\u4e3a\u4e86\u65b9\u4fbf\u6570\u636e\u7684\u62c6\u5206\u548c\u96c6\u7fa4\u7684\u6269\u5c55\uff08\u540c\u65f6\u8fd9\u4e5f\u662fredis\u7684\u4f18\u70b9\uff09\uff0c\u4f7f\u6bcf\u4e2a\u8282\u70b9\u8d1f\u8d23\u4e00\u5b9a\u6570\u91cf\u7684\u503c\u3002 Redis\u96c6\u7fa4\u539f\u7406 \u00b6 Redis cluster\u662f\u4e00\u4e2a\u65e0\u4e2d\u5fc3\u7684\u7ed3\u6784\uff0c\u5176\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u4f1a\u4fdd\u5b58\u7740\u6570\u636e\u548c\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u3002\u6bcf\u4e2a\u8282\u70b9\u90fd\u4f1a\u4fdd\u5b58\u5176\u4ed6\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u77e5\u9053\u5176\u5b83\u8282\u70b9\u6240\u8d1f\u8d23\u7684\u69fd\uff0c\u5e76\u4e14\u4f1a\u4e0e\u5176\u4ed6\u8282\u70b9\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u4fe1\u606f\u80fd\u591f\u53ca\u65f6\u611f\u77e5\u6574\u4e2a\u96c6\u7fa4\u4e2d\u5f02\u5e38\u7684\u8282\u70b9\u3002","title":"redis \u96c6\u7fa4\u7bc7"},{"location":"5.Storage/redis-cluster-docs/#redis","text":"\u6211\u4eec\u65e5\u5e38\u5728\u5bf9\u4e8eredis\u7684\u4f7f\u7528\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff1a \u9ad8\u53ef\u7528\u95ee\u9898\uff0c\u5982\u4f55\u4fdd\u8bc1redis\u7684\u6301\u7eed\u9ad8\u53ef\u7528\u6027\u3002 \u5bb9\u91cf\u95ee\u9898\uff0c\u5355\u5b9e\u4f8bredis\u5185\u5b58\u65e0\u6cd5\u65e0\u9650\u6269\u5145\uff0c\u8fbe\u523032G\u540e\u5c31\u8fdb\u5165\u4e8664\u4f4d\u4e16\u754c\uff0c\u6027\u80fd\u4e0b\u964d\u3002 \u5e76\u53d1\u6027\u80fd\u95ee\u9898\uff0credis\u53f7\u79f0\u5355\u5b9e\u4f8b10\u4e07\u5e76\u53d1\uff0c\u4f46\u4e5f\u662f\u6709\u5c3d\u5934\u7684\u3002","title":"Redis\u7fa4\u96c6"},{"location":"5.Storage/redis-cluster-docs/#redis-cluster","text":"Redis cluster \u662fredis\u7684\u5206\u5e03\u5f0f\u89e3\u51b3\u65b9\u6848\uff0c\u5728redis3.0\u7248\u672c\u4e2d\u6b63\u5f0f\u63a8\u51fa\u7684\u91c7\u7528\u7684\u662fhash slot\uff08hash\u69fd\uff09\uff0c\u53ef\u4ee5\u5c06\u591a\u4e2aRedis\u5b9e\u4f8b\u6574\u5408\u5728\u4e00\u8d77\uff0c\u5f62\u6210\u4e00\u4e2a\u96c6\u7fa4\uff0c\u4e5f\u5c31\u662f\u5c06\u6570\u636e\u5206\u6563\u5230\u96c6\u7fa4\u7684\u591a\u53f0\u673a\u5668\u4e0a\u3002\u6709\u6548\u7684\u89e3\u51b3\u4e86redis\u5206\u5e03\u5f0f\u65b9\u9762\u7684\u9700\u6c42\uff0c\u5f53\u9047\u5230\u5355\u673a\u5185\u5b58\u3001\u5f00\u53d1\u3001\u6d41\u91cf\u7b49\u74f6\u9888\u65f6\uff0c\u53ef\u4ee5\u91c7\u7528cluster\u67b6\u6784\u8fbe\u5230\u8d1f\u8f7d\u5747\u8861\u7684\u76ee\u7684\u3002 redis-cluster\u7684\u4f18\u52bf: 1.\u5b98\u65b9\u63a8\u8350\uff0c\u6bcb\u5eb8\u7f6e\u7591\u3002 2.\u53bb\u4e2d\u5fc3\u5316\uff0c\u96c6\u7fa4\u6700\u5927\u53ef\u589e\u52a01000\u4e2a\u8282\u70b9\uff0c\u6027\u80fd\u968f\u8282\u70b9\u589e\u52a0\u800c\u7ebf\u6027\u6269\u5c55\u3002 3.\u7ba1\u7406\u65b9\u4fbf\uff0c\u540e\u7eed\u53ef\u81ea\u884c\u589e\u52a0\u6216\u6458\u9664\u8282\u70b9\uff0c\u79fb\u52a8\u5206\u69fd\u7b49\u7b49\u3002 4.\u7b80\u5355\uff0c\u6613\u4e0a\u624b\u3002","title":"Redis cluster\u4ecb\u7ecd"},{"location":"5.Storage/redis-cluster-docs/#redis_1","text":"\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e3b\u8981\u89e3\u51b3\u628a\u6574\u4e2a\u6570\u636e\u96c6\u6309\u7167\u5206\u533a\u89c4\u5219\u6620\u5c04\u5230\u591a\u4e2a\u8282\u70b9\u7684\u95ee\u9898\uff0c\u5373\u628a\u6570\u636e\u96c6\u5212\u5206\u5230\u591a\u4e2a\u8282\u70b9\u4e0a\uff0c\u6bcf\u4e2a\u8282\u70b9\u8d1f\u8d23\u6574\u4e2a\u6570\u636e\u7684\u4e00\u4e2a\u5b50\u96c6\u3002\u5e38\u89c1\u7684\u5206\u533a\u89c4\u5219\u6709\u54c8\u5e0c\u5206\u533a\u548c\u987a\u5e8f\u5206\u533a\u3002Redis cluster\u91c7\u7528\u54c8\u5e0c\u5206\u533a\u89c4\u5219\uff0c\u56e0\u6b64\u63a5\u4e0b\u6765\u4f1a\u8ba8\u8bba\u54c8\u5e0c\u89c4\u5219\uff0c\u5e38\u89c1\u7684\u54c8\u5e0c\u5206\u533a\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a(redis cluster\u91c7\u7528\u865a\u62df\u69fd\u5206\u533a) 1.\u8282\u70b9\u53d6\u4f59 2.\u4e00\u81f4\u6027\u54c8\u5e0c\u5206\u533a 3.\u865a\u62df\u69fd\u5206\u533a","title":"Redis\u6570\u636e\u5206\u5e03"},{"location":"5.Storage/redis-cluster-docs/#_1","text":"\u865a\u62df\u69fd\u5206\u533a\u5de7\u5999\u5730\u4f7f\u7528\u4e86\u54c8\u5e0c\u7a7a\u95f4\uff0c\u4f7f\u7528\u5206\u6563\u5ea6\u826f\u597d\u7684\u54c8\u5e0c\u51fd\u6570\u628a\u6240\u6709\u7684\u6570\u636e\u6620\u5c04\u5230\u4e00\u4e2a\u56fa\u5b9a\u7684\u8303\u56f4\u5185\u7684\u6574\u6570\u96c6\u5408\u3002Redis Cluster\u69fd\u7684\u8303\u56f4\u662f0-16383\u3002\u69fd\u662f\u96c6\u7fa4\u6570\u636e\u7ba1\u7406\u548c\u8fc1\u79fb\u7684\u57fa\u672c\u7684\u5355\u4f4d\u3002\u91c7\u7528\u5927\u8303\u56f4\u69fd\u7684\u4e3b\u8981\u76ee\u7684\u662f\u4e3a\u4e86\u65b9\u4fbf\u6570\u636e\u7684\u62c6\u5206\u548c\u96c6\u7fa4\u7684\u6269\u5c55\uff08\u540c\u65f6\u8fd9\u4e5f\u662fredis\u7684\u4f18\u70b9\uff09\uff0c\u4f7f\u6bcf\u4e2a\u8282\u70b9\u8d1f\u8d23\u4e00\u5b9a\u6570\u91cf\u7684\u503c\u3002","title":"\u865a\u62df\u69fd\u5206\u533a"},{"location":"5.Storage/redis-cluster-docs/#redis_2","text":"Redis cluster\u662f\u4e00\u4e2a\u65e0\u4e2d\u5fc3\u7684\u7ed3\u6784\uff0c\u5176\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u4f1a\u4fdd\u5b58\u7740\u6570\u636e\u548c\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u3002\u6bcf\u4e2a\u8282\u70b9\u90fd\u4f1a\u4fdd\u5b58\u5176\u4ed6\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u77e5\u9053\u5176\u5b83\u8282\u70b9\u6240\u8d1f\u8d23\u7684\u69fd\uff0c\u5e76\u4e14\u4f1a\u4e0e\u5176\u4ed6\u8282\u70b9\u5b9a\u65f6\u53d1\u9001\u5fc3\u8df3\u4fe1\u606f\u80fd\u591f\u53ca\u65f6\u611f\u77e5\u6574\u4e2a\u96c6\u7fa4\u4e2d\u5f02\u5e38\u7684\u8282\u70b9\u3002","title":"Redis\u96c6\u7fa4\u539f\u7406"},{"location":"5.Storage/redis-docs/","text":"\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e0e\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93 \u00b6 \u6570\u636e\u5e93\u6309\u7167\u5176\u7ed3\u6784\u53ef\u4ee5\u5206\u4e3a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e0e\u5176\u4ed6\u6570\u636e\u5e93\uff0c\u800c\u8fd9\u4e9b\u5176\u4ed6\u6570\u636e\u5e93\u6211\u4eec\u5c06\u7edf\u79f0\u4e3aNoSQL\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u3002 \u626b\u76f2\u77e5\u8bc6 \u00b6 \u5173\u7cfb\u578b\u6570\u636e\u5e93 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u662f\u4e00\u4e2a\u7ed3\u6784\u5316\u7684\u6570\u636e\u5e93\uff0c\u521b\u5efa\u5728\u5173\u7cfb\u6a21\u578b\u7684\u57fa\u7840\u4e0a\uff0c\u4e00\u822c\u9762\u5411\u8bb0\u5f55\uff0c\u4ed6\u501f\u52a9\u4e0e\u96c6\u5408\u4ee3\u6570\u7b49\u6570\u5b66\u6982\u5ff5\u548c\u65b9\u6cd5\u6765\u5904\u7406\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\uff0c\u5173\u7cfb\u6a21\u578b\u662f\u4e8c\u7ef4\u8868\u683c\u6a21\u578b\uff0c\u56e0\u800c\u4e00\u4e2a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5c31\u662f\u7531\u4e8c\u7ef4\u8868\u53ca\u5176\u4e4b\u95f4\u7684\u8054\u7cfb\u7ec4\u6210\u7684\u4e00\u4e2a\u6570\u636e\u4e00\u4e2a\u6570\u636e\u7ec4\u7ec7\u3002\u73b0\u5b9e\u4e16\u754c\u4e2d\uff0c\u5404\u79cd\u5b9e\u4f53\u4e0e\u5b9e\u4f53\u4e4b\u95f4\u7684\u5404\u79cd\u8054\u7cfb\u90fd\u53ef\u4ee5\u7528\u5173\u7cfb\u6a21\u578b\u6765\u8868\u793a\u3002SQL\u8bed\u53e5\uff08Structured Ouery Lanage\uff0c\u7ed3\u6784\u5316\u67e5\u8be2\u8bed\u8a00\uff09\u5c31\u662f\u4e00\u79cd\u57fa\u4e8e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u8bed\u8a00\uff0c\u7528\u4e8e\u6267\u884c\u5bf9\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u6570\u636e\u7684\u68c0\u7d22\u548c\u64cd\u4f5c\u3002\u4e3b\u6d41\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08mysql\u3001oracle\u3001sql server\u3001Microsoft Access\u3001DB2\uff09\u7b49\u3002 \u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93 NoSQL\uff08Not Only SQL\uff09\u5176\u610f\u601d\u662f\u4e0d\u4ec5\u4ec5\u662fSQL\uff0c\u662f\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u603b\u79f0\uff0c\u4e3b\u6d41\u7684\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08Memcached\u3001Redis\u3001MongoDB\u3001Hbase\u3001CouhDB\u7b49\u4ee5\u4e0a\u7684\u8fd9\u4e9b\u6570\u636e\u5e93\u5b83\u4eec\u7684\u5b58\u50a8\u65b9\u5f0f\uff0c\u5b58\u50a8\u7ed3\u6784\uff0c\u4ee5\u53ca\u4f7f\u7528\u573a\u666f\u662f\u5b8c\u5168\u4e0d\u540c\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8ba4\u4e3a\u4ed6\u662f\u4e00\u4e2a\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u96c6\u5408\uff0c\u800c\u4e0d\u662f\u50cf\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e00\u6837\u662f\u4e00\u4e2a\u7edf\u79f0\u3002\u6362\u8a00\u4e4b\uff0c\u4e3b\u6d41\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4ee5\u5916\u7684\u6570\u636e\u5e93\u90fd\u662f\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0cNoSQL\u6570\u636e\u5e93\u51ed\u501f\u7740\u5176\u975e\u5173\u7cfb\u578b\uff0c\u5206\u5e03\u5f0f\uff0c\u5f00\u6e90\u7684\u6a2a\u5411\u6269\u5c55\u7b49\u4f18\u52bf\uff0c\u88ab\u8ba4\u4e3a\u662f\u4e0b\u4e00\u4ee3\u6570\u636e\u5e93\u4ea7\u54c1\uff09\u3002 \u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4ea7\u751f\u80cc\u666f \u00b6 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u5df2\u7ecf\u8bde\u751f\u5f88\u4e45\u4e86\uff0c\u800c\u4e14\u6211\u4eec\u4e00\u76f4\u5728\u4f7f\u7528\uff0c\u6ca1\u6709\u4ec0\u4e48\u95ee\u9898\uff0c\u9762\u5bf9\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u4f1a\u4ea7\u751f\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff1f\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u4ecb\u7ecd\u4e00\u4e0b\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4ea7\u751f\u7684\u80cc\u666f\u3002 \u968f\u7740Web 2.0\u7f51\u7ad9\u7684\u5174\u8d77\uff0c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5728\u5e94\u5bf9Web 2.0\u7f51\u7ad9\uff0c\u7279\u522b\u662f\u6d77\u91cf\u6570\u636e\u5e93\u548c\u9ad8\u5e76\u53d1\u7684SNS\uff08Social Networking Services\uff0c\u5373\u793e\u4ea4\u7f51\u7edc\u670d\u52a1\uff09\u7c7b\u578b\u7684Web 2.0\u7eaf\u52a8\u6001\u7f51\u7ad9\u65f6\uff0c\u66b4\u9732\u51fa\u5f88\u591a\u96be\u4ee5\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u4f8b\u5982\u4ee5\u4e0b\u4e09\u9ad8\u95ee\u9898\u3002 1\uff09High performance\u2014\u2014\u5bf9\u6570\u636e\u5e93\u9ad8\u5e76\u53d1\u8bfb\u5199\u9700\u6c42 Web 2.0\u7f51\u7ad9\u4f1a\u6839\u636e\u7528\u6237\u7684\u4e2a\u6027\u5316\u4fe1\u606f\u6765\u5b9e\u65f6\u751f\u6210\u52a8\u6001\u9875\u9762\u548c\u63d0\u4f9b\u52a8\u6001\u4fe1\u606f\uff0c\u56e0\u4e3a\uff0c\u65e0\u6cd5\u4f7f\u7528\u52a8\u6001\u9875\u9762\u9759\u6001\u5316\u6280\u672f\uff0c\u6240\u4ee5\u6570\u636e\u5e93\u7684\u5e76\u53d1\u8d1f\u8f7d\u975e\u5e38\u9ad8\uff0c\u4e00\u822c\u4f1a\u8fbe\u523010000\u6b21/s\u4ee5\u4e0a\u7684\u8bfb\u5199\u8bf7\u6c42\u3002\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5bf9\u4e8e\u4e0a\u4e07\u6b21\u7684\u67e5\u8be2\u8bf7\u6c42\u8fd8\u662f\u53ef\u4ee5\u52c9\u5f3a\u652f\u6491\u7684\u3002\u5f53\u51fa\u73b0\u4e0a\u4e07\u6b21\u7684\u5199\u6570\u636e\u8bf7\u6c42\u65f6\uff0c\u786c\u76d8I/O\u5c31\u5df2\u7ecf\u65e0\u6cd5\u627f\u53d7\u4e86\uff0c\u5bf9\u4e8e\u666e\u901a\u7684BBS\u7f51\u7ad9\uff0c\u5f80\u5f80\u4e5f\u4f1a\u5b58\u5728\u9ad8\u5e76\u53d1\u7684\u8bfb\u6570\u636e\u8bf7\u6c42\uff0c\u5982\u660e\u661f\u9e7f\u6657\u5728\u5fae\u535a\u4e0a\u516c\u5e03\u604b\u60c5\uff0c\u7ed3\u679c\u56e0\u4e3a\u6d41\u91cf\u8fc7\u5927\u800c\u5f15\u53d1\u5fae\u535a\u762b\u75ea\u3002 2\uff09Huge storage\u2014\u2014\u5bf9\u6d77\u91cf\u6570\u636e\u5e93\u9ad8\u6548\u5b58\u50a8\u4e0e\u8bbf\u95ee\u9700\u6c42 \u7c7b\u4f3c\u4e8eFacebook\u3001Friendfeed\u8fd9\u6837\u7684SNS\u7f51\u7ad9\uff0c\u6bcf\u5929\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u7528\u6237\u52a8\u6001\u4fe1\u606f\uff0c\u4f8b\u5982Friendfeed\u4e00\u4e2a\u6708\u5c31\u4f1a\u4ea7\u751f2.5\u4ebf\u6761\u7528\u6237\u52a8\u6001\u4fe1\u606f\uff0c\u5bf9\u4e8e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6765\u8bf4\uff0c\u5728\u4e00\u4e2a\u5305\u542b2.5\u4ebf\u6761\u8bb0\u5f55\u7684\u8868\u4e2d\u6267\u884cSQL\u67e5\u8be2\uff0c\u6548\u7387\u662f\u975e\u5e38\u4f4e\u7684\u3002 3\uff09High Scalability && High Availability\u2014\u2014\u5bf9\u6570\u636e\u5e93\u9ad8\u6269\u5c55\u6027\u4e0e\u9ad8\u53ef\u7528\u6027\u9700\u6c42 \u5728Web\u67b6\u6784\u4e2d\uff0c\u6570\u636e\u5e93\u662f\u6700\u96be\u8fdb\u884c\u6a2a\u5411\u6269\u5c55\u7684\uff0c\u5f53\u5e94\u7528\u7cfb\u7edf\u7684\u7528\u6237\u91cf\u4e0e\u8bbf\u95ee\u91cf\u4e0e\u65e5\u4ff1\u589e\u65f6\uff0c\u6570\u636e\u5e93\u662f\u6ca1\u529e\u6cd5\u50cfWeb\u670d\u52a1\u4e00\u6837\uff0c\u7b80\u5355\u5730\u901a\u8fc7\u6dfb\u52a0\u786c\u4ef6\u548c\u670d\u52a1\u8282\u70b9\u5176\u6027\u80fd\u548c\u8d1f\u8f7d\u5747\u8861\u80fd\u529b\u7684\uff0c\u5c24\u5176\u5bf9\u4e8e\u4e00\u4e9b\u9700\u898124h\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u7684\u7f51\u7ad9\u6765\u8bf4\uff0c\u6570\u636e\u5e93\u7684\u5347\u7ea7\u4e0e\u6269\u5c55\u6027\u5f80\u5f80\u4f34\u968f\u7740\u505c\u673a\u7ef4\u62a4\u4e0e\u6570\u636e\u8fc1\u79fb\uff0c\u5176\u5de5\u4f5c\u91cf\u662f\u975e\u5e38\u5e9e\u5927\u7684\u3002 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u548c\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u90fd\u6709\u5404\u81ea\u7684\u7279\u70b9\u4e0e\u5e94\u7528\u573a\u666f\uff0c\u518d\u8005\u7684\u7d27\u5bc6\u7ed3\u5408\u5c06\u4f1a\u7ed9Web 2.0\u7684\u6570\u636e\u5e93\u53d1\u5c55\u5e26\u6765\u65b0\u7684\u601d\u8def\uff0c\u8ba9\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5173\u6ce8\u5728\u5173\u7cfb\u4e0a\uff0c\u975e\u5173\u7cfb\u6570\u636e\u5e93\u5173\u6ce8\u5728\u5b58\u50a8\u4e0a\u3002 Redis \u4ecb\u7ecd \u00b6 Redis\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\uff0c\u4f7f\u7528C\u8bed\u8a00\u7f16\u5199\uff0c\u652f\u6301\u7f51\u7edc\uff0c\u53ef\u57fa\u4e8e\u5185\u5b58\u5de5\u4f5c\u4ea6\u53ef\u6301\u4e45\u5316\uff08AOF\uff0cRDB \uff09\u7684\u65e5\u5fd7\u578b\uff0ckey-values\uff08\u952e\u503c\u5bf9\uff09\u6570\u636e\u5e93\uff0c\u4e00\u4e2a\u901f\u5ea6\u6781\u5feb\u7684\u975e\u5173\u7cfb\u6027\u6570\u636e\u5e93\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684NoSQL\u6570\u636e\u5e93\uff0c\u4ed6\u53ef\u4ee5\u5b58\u50a8\uff08key\uff09\u4e0e5\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u503c\uff08value\uff09\u4e4b\u95f4\u7684\u6620\u5c04\uff08mapping\uff09\uff0c\u53ef\u4ee5\u5c06\u5b58\u50a8\u5728\u5185\u5b58\u7684\u952e\u503c\u5bf9\u6570\u6301\u4e45\u5316\u5230\u786c\u76d8\uff0c\u53ef\u4ee5\u4f7f\u7528\u590d\u5236\u7279\u6027\u6765\u6269\u5c55\u8bfb\u6027\u80fd\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5ba2\u6237\u7aef\u5206\u7247\u6765\u6269\u5c55\u6027\u80fd\uff0c\u5e76\u4e14\u5b83\u8fd8\u63d0\u4f9b\u4e86\u591a\u79cd\u8bed\u8a00\u7684API\u3002 Redis\u7684\u6240\u6709\u6570\u636e\u90fd\u662f\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u7136\u540e\u4e0d\u5b9a\u671f\u7684\u901a\u8fc7\u5f02\u6b65\u65b9\u5f0f\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a\uff08\u8fd9\u4e2a\u79f0\u4e3a\u534a\u6301\u4e45\u5316RDB\uff09\uff1b\u4e5f\u53ef\u4ee5\u628a\u6bcf\u4e00\u6b21\u6570\u636e\u53d8\u5316\u90fd\u5199\u5165\u5230\u4e00\u4e2aappend onlyfile\uff08AOF\uff09\u91cc\u9762\uff08\u8fd9\u79f0\u4e3a\u201c\u5168\u6301\u4e45\u5316\u201d\uff09\u3002 \u5168\u6301\u4e45\u5316\u4e0e\u534a\u6301\u4e45\u5316\u7684\u65b9\u5f0f\u5728\u5de5\u4f5c\u4e2d\u9002\u5f53\u7684\u4f7f\u7528\uff0c\u5728\u5982\u4eca\u7684\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5982\u679c\u4f7f\u7528\u5168\u6301\u4e45\u5316\u7684\u65b9\u5f0f\u53ef\u80fd\u4f1a\u9020\u6210append onlyfile\u7684\u6587\u4ef6\u8fc7\u5927\uff0c\u5982\u679c\u662f\u534a\u6301\u4e45\u5316\u7684\u8bdd\u53c8\u6ca1\u6709\u529e\u6cd5\u4fdd\u8bc1\u6570\u636e\u7684\u5b89\u5168\u6027\uff0c\u6240\u4ee5\u5e0c\u671b\u5927\u5bb6\u9002\u5f53\u7684\u4f7f\u7528\u3002 Redis\u7684\u5de5\u4f5c\u539f\u7406 \u00b6 Redis\u670d\u52a1\u5668\u7a0b\u5e8f\u662f\u4e00\u4e2a\u5355\u8fdb\u7a0b\u6a21\u578b\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\u53ef\u4ee5\u5f00\u542f\u591a\u4e2aredis\u8fdb\u7a0b\uff08\u591a\u5b9e\u4f8b\uff09\uff0c\u800credis\u7684\u5b9e\u9645\u5904\u7406\u901f\u5ea6\u5219\u5b8c\u5168\u4f9d\u9760\u4e8e\u4e3b\u8fdb\u7a0b\u7684\u6267\u884c\u901f\u7387\uff0c\u82e5\u5728\u670d\u52a1\u5668\u4e0a\u53ea\u8fd0\u884c\u4e00\u4e2aredis\u8fdb\u7a0b\uff0c\u5f53\u591a\u4e2a\u5ba2\u6237\u7aef\u540c\u65f6\u8bbf\u95ee\u65f6\uff0c\u670d\u52a1\u5668\u5904\u7406\u80fd\u529b\u4f1a\u6709\u4e00\u5b9a\u7a0b\u5ea6\u7684\u4e0b\u964d\uff0c\u82e5\u5728\u4e00\u4e2a\u670d\u52a1\u5668\u4e0a\u5f00\u542f\u591a\u4e2aredis\u8fdb\u7a0b\uff0credis\u5728\u63d0\u9ad8\u5e76\u53d1\u5904\u7406\u80fd\u529b\u7684\u540c\u65f6\u4e5f\u4f1a\u7ed9CPU\u9020\u6210\u5f88\u5927\u7684\u538b\u529b\uff0c\u6240\u4ee5\u5728\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u7ed3\u5408\u5b9e\u9645\u670d\u52a1\u5668\u73af\u5883\u6765\u51b3\u5b9a\u5982\u4f55\u4f7f\u7528\u3002 Redis \u7684\u4f18\u70b9 \u00b6 \u5177\u6709\u6781\u9ad8\u7684\u6570\u636e\u8bfb\u5199\u901f\u5ea6\uff1a\u6570\u636e\u8bfb\u53d6\u901f\u5ea6\u6700\u9ad8\u53ef\u8fbe11\u4e07\u6b21/s\uff0c\u6570\u636e\u5199\u5165\u901f\u5ea6\u6700\u9ad8\u53ef\u8fbe8\u4e071\u5343\u6b21/s \u652f\u6301\u4e30\u5bcc\u7684\u6570\u636e\u7c7b\u578b\uff0c\u652f\u6301\u4e30\u5bcc\u7684\u6570\u636e\u7c7b\u578b\u4e0d\u4ec5\u652f\u6301key-values\u6570\u636e\u7c7b\u578b\uff0c\u8fd8\u652f\u6301Strings\uff0cLists\uff0cHashes\uff0cSets\uff0c\u53caOrdered Sets\u7b49\u6570\u636e\u7c7b\u578b\u64cd\u4f5c \u652f\u6301\u6570\u636e\u7684\u6301\u4e45\u5316\uff0c\u5728\u8fd9\u4e00\u70b9\u4e0aredis\u8fdc\u8fdc\u5f3a\u4e8ememcached\uff0credis\u53ef\u4ee5\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u78c1\u76d8\u4e2d\uff0c\u91cd\u542f\u540e\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u52a0\u8f7d\u4f7f\u7528 \u539f\u5b50\u6027 redis\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u662f\u539f\u5b50\u6027\u7684 \u652f\u6301\u6570\u636e\u5907\u4efd\u53camaster-slave\u6a21\u5f0f\u7684\u6570\u636e\u5907\u4efd ** Helm \u90e8\u7f72 redis** \u00b6 \u5728\u4e91\u539f\u751f\u73af\u5883\u4e2d\u90e8\u7f72 Redis \u96c6\u7fa4\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u4f7f\u7528 Kubernetes\uff0c\u5b83\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u5e73\u53f0\uff0c\u7528\u4e8e\u81ea\u52a8\u5316\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u3002\u5bf9\u4e8e Redis\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Helm\uff0c\u8fd9\u662f\u4e00\u4e2a Kubernetes \u7684\u5305\u7ba1\u7406\u5668\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u66f4\u5bb9\u6613\u5730\u7ba1\u7406\u548c\u90e8\u7f72\u5e94\u7528\u3002 \u4ee5\u4e0b\u662f\u5728 Kubernetes \u4e2d\u4f7f\u7528 Helm \u90e8\u7f72 Redis \u96c6\u7fa4\u7684\u4e24\u79cd\u65b9\u6cd5\uff1a \u96c6\u7fa4\u65b9\u5f0f \u54e8\u5175\u65b9\u5f0f \u4ee5\u4e0b\u662f\u4e00\u4e2a\u5c0f demo \u7684\u4f8b\u5b50: \u5b89\u88c5 Helm \uff1a\u9996\u5148\uff0c\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u5b89\u88c5 Helm\uff0c\u4f60\u9700\u8981\u5728\u4f60\u7684\u673a\u5668\u4e0a\u5b89\u88c5\u5b83\u3002\u4f60\u53ef\u4ee5\u4ece Helm \u7684 GitHub \u4ed3\u5e93\u4e0b\u8f7d\u6700\u65b0\u7684 Helm \u4e8c\u8fdb\u5236\u5305\u5e76\u5b89\u88c5\u3002 \u6dfb\u52a0 Helm \u4ed3\u5e93 \uff1aBitnami \u7ef4\u62a4\u4e86\u4e00\u4e2a\u5305\u542b\u4e86\u8bb8\u591a\u5e38\u89c1\u5e94\u7528\uff08\u5305\u62ec Redis\uff09\u7684 Helm \u4ed3\u5e93\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6dfb\u52a0\u8fd9\u4e2a\u4ed3\u5e93\uff1a helm repo add bitnami https://charts.bitnami.com/bitnami helm repo update helm install my-redis-cluster bitnami/redis --set cluster.enabled=true,cluster.nodes=3,persistence.enabled=true,persistence.size=1Gi \u8fd9\u4e2a\u547d\u4ee4\u5c06\u90e8\u7f72\u4e00\u4e2a\u5305\u542b 3 \u4e2a\u8282\u70b9\u7684 Redis \u96c6\u7fa4\uff0c\u5e76\u4e3a\u6bcf\u4e2a\u8282\u70b9\u542f\u7528\u4e86 1Gi \u7684\u6301\u4e45\u5316\u5b58\u50a8\u3002 \u9a8c\u8bc1\u90e8\u7f72 \uff1a\u6700\u540e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5 Redis \u96c6\u7fa4\u7684\u72b6\u6001\uff1a \u5982\u679c\u4e00\u5207\u987a\u5229\uff0c\u4f60\u5e94\u8be5\u53ef\u4ee5\u770b\u5230\u4f60\u7684 Redis pods \u5728\u8fd0\u884c\u3002 \u8fd9\u53ea\u662f\u4e00\u4e2a\u6700\u57fa\u672c\u7684\u793a\u4f8b\u3002\u5728\u5b9e\u9645\u73af\u5883\u4e2d\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u6839\u636e\u4f60\u7684\u5177\u4f53\u9700\u6c42\u8c03\u6574\u5404\u79cd\u53c2\u6570\uff0c\u4f8b\u5982\u8282\u70b9\u6570\u3001\u5b58\u50a8\u5927\u5c0f\u3001\u5bc6\u7801\u7b49\u3002\u4f60\u53ef\u4ee5\u5728 Bitnami \u7684 Redis Helm chart \u6587\u6863\u4e2d\u627e\u5230\u66f4\u591a\u7684\u914d\u7f6e\u9009\u9879\u3002 \u6b64\u5916\uff0c\u4f60\u4e5f\u9700\u8981\u8003\u8651\u5982\u4f55\u5904\u7406\u6570\u636e\u6301\u4e45\u5316\u3001\u9ad8\u53ef\u7528\u6027\u3001\u5907\u4efd\u548c\u6062\u590d\u7b49\u95ee\u9898\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u914d\u7f6e Kubernetes \u7684 Persistent Volumes \u548c Persistent Volume Claims \u6765\u5904\u7406\u6570\u636e\u6301\u4e45\u5316\uff0c\u914d\u7f6e Redis \u7684\u4e3b\u4ece\u590d\u5236\u548c\u54e8\u5175\u6a21\u5f0f\u6765\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u5b9a\u671f\u5907\u4efd Redis \u6570\u636e\u4ee5\u9632\u6570\u636e\u4e22\u5931\uff0c\u7b49\u7b49\u3002 \u751f\u4ea7\u73af\u5883\u90e8\u7f72 \u00b6 \u6dfb\u52a0Helm chart helm repo add bitnami https://charts.bitnami.com/bitnami helm repo update \u67e5\u8be2 Redis \u8d44\u6e90 $ helm search repo redis NAME CHART VERSION APP VERSION DESCRIPTION bitnami/redis 17.15.2 7.0.12 Redis(R) is an open source, advanced key-value ... bitnami/redis-cluster 8.6.12 7.0.12 Redis(R) is an open source, scalable, distribut... prometheus-community/prometheus-redis-exporter 5.5.0 v1.44.0 Prometheus exporter for Redis metrics stable/prometheus-redis-exporter 3.5.1 1.3.4 DEPRECATED Prometheus exporter for Redis metrics stable/redis 10.5.7 5.0.7 DEPRECATED Open source, advanced key-value stor... stable/redis-ha 4.4.6 5.0.6 DEPRECATED - Highly available Kubernetes implem... ucloud-operator/redis-cluster-operator 0.1.0 0.1.0 A Helm chart for Redis cluster operator deployment stable/sensu 0.2.5 0.28 DEPRECATED Sensu monitoring framework backed by... \u6e29\u99a8\u63d0\u793a stable\u8fd9\u79cd\u65b9\u6848\u5df2\u7ecf\u4e0d\u7ef4\u62a4\u4e86\uff0c\u6240\u4ee5\u4e0d\u8003\u8651\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u8fd9\u8fb9\u4e3b\u8981\u4ee5bitnami\u6765\u8bb2\u3002\u8fd9\u91cc\u4e0d\u63a8\u8350\u4f7f\u7528\u6e90\u7801\u90e8\u7f72 \u4e0b\u8f7d chart \u5305 $ helm search repo redis --versions $ helm pull bitnami/redis --version 17.15.2 \u7531\u4e8eredis\u96c6\u7fa4\u5b58\u50a8\u65b9\u5f0f\u7684\u7279\u6b8a\u6027\uff0c\u8fd9\u91cc\u8003\u8651\u4f7f\u7528\u7684\u65b9\u6848\u7684\uff1alocal-path-provisioner \u5b98\u65b9\u5730\u5740: https://github.com/rancher/local-path-provisioner \u8003\u8651\u7684\u7406\u7531: 1. \u8131\u79bb\u4e2d\u5fc3\u5b58\u50a8\uff0c\u6211\u4eec\u7684\u4e4b\u524d\u6570\u636e\u5e93\u4e3b\u8981\u5b58\u50a8\u5728ceph\u4e2d\uff0c\u4e00\u65e6ceph\u51fa\u73b0\u95ee\u9898\uff0cmysql\u6709\u6781\u5927\u7684\u53ef\u80fd\u65e0\u6cd5\u542f\u52a8\u3002 2. \u5c06mysql\u7684\u6570\u636e\u5206\u79bb\u51fa\u6765\u6709\u5229\u4e8e\u51cf\u5c11\u4e2d\u5fc3\u5b58\u50a8\u7684\u538b\u529b\u3002 3. local-path-provisioner\u5c06\u672c\u5730\u76ee\u5f55\u4f5c\u4e3a\u6700\u540e\u6570\u636e\u5b58\u50a8\u7684\u8def\u5f84\u3002\u56e0\u6b64\u6211\u4eec\u5728\u591a\u4e2a\u8282\u70b9\u6dfb\u52a0\u4e00\u5757\u6570\u636e\u76d8+\u90e8\u7f72\u9ad8\u53ef\u7528\u7684\u54e8\u5175\u96c6\u7fa4\u5e76\u9650\u5236\u4e8e\u8be5\u8282\u70b9\u3002 \u5f53\u65f6\u4ee5\u4e0a\u65b9\u5f0f\u5728\u90e8\u7f72\u54e8\u5175\u96c6\u7fa4\u8fd8\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u5c31\u662f\u4ed6\u53ea\u652f\u6301\u8f6e\u8be2\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee\u540e\u7aef\u7684redis\uff0c\u8fd9\u4e2a\u5c31\u5f88\u626f\u6de1\uff0c\u8981\u662f\u5168\u662f\u8bfb\u7684\u573a\u666f\u8fd8\u53ef\u4ee5\u63a5\u53d7\uff0c\u4f46\u662f\u5982\u679c\u8981\u662f\u5199\u7684\u8bdd\uff0c\u9020\u6210\u7684\u7ed3\u679c\u5c31\u662f\u4e00\u4f1a\u6210\u529f\u4e00\u4f1a\u5931\u8d25\uff0c\u5f88\u50bb\u903c\u3002 \u8fd8\u662f\u89c9\u5f97\u4f7f\u7528\u4ee5\u524dstable\uff0c\u4e0d\u8fc7\u6362\u4e86\u4e00\u4e2a\u4eba\u7ef4\u62a4\u7684\u3002 helm repo add dandydev https://dandydeveloper.github.io/charts helm install dandydev/redis-ha \u4ed6\u652f\u6301hostpath\u548csc\uff0c\u8fd9\u91ccsc\u53ef\u4ee5\u7ed3\u5408local-path-provisioner\u4f7f\u7528\uff0c\u4e0a\u9762bitnami\u53ef\u4ee5\u7b80\u5355\u73a9\u4e00\u4e0b\uff0c\u5c31\u4e0d\u63a8\u8350\u751f\u4ea7\u4e86 \u914d\u7f6e\u6587\u4ef6\u4ecb\u7ecd \u00b6 1 . Redis\u9ed8\u8ba4\u4e0d\u662f\u4ee5\u5b88\u62a4\u8fdb\u7a0b\u7684\u65b9\u5f0f\u8fd0\u884c\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u914d\u7f6e\u9879\u4fee\u6539\uff0c\u4f7f\u7528yes\u542f\u7528\u5b88\u62a4\u8fdb\u7a0b daemonize yes 2 . \u5f53Redis\u4ee5\u5b88\u62a4\u8fdb\u7a0b\u65b9\u5f0f\u8fd0\u884c\u65f6\uff0cRedis\u9ed8\u8ba4\u4f1a\u628apid\u5199\u5165/var/run/redis.pid\u6587\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7pidfile\u6307\u5b9a pidfile /var/run/redis_6379.pid 3 . \u6307\u5b9aRedis\u76d1\u542c\u7aef\u53e3\uff0c\u9ed8\u8ba4\u7aef\u53e3\u4e3a6379 port 6379 4 . \u7ed1\u5b9a\u7684\u4e3b\u673a\u5730\u5740 bind 0 .0.0.0 5 .\u5f53\u5ba2\u6237\u7aef\u95f2\u7f6e\u591a\u957f\u65f6\u95f4\u540e\u5173\u95ed\u8fde\u63a5\uff0c\u5982\u679c\u6307\u5b9a\u4e3a0\uff0c\u8868\u793a\u5173\u95ed\u8be5\u529f\u80fd timeout 300 6 . \u6307\u5b9a\u65e5\u5fd7\u8bb0\u5f55\u7ea7\u522b\uff0cRedis\u603b\u5171\u652f\u6301\u56db\u4e2a\u7ea7\u522b\uff1adebug\u3001verbose\u3001notice\u3001warning\uff0c\u9ed8\u8ba4\u4e3averbose loglevel verbose 7 . \u65e5\u5fd7\u8bb0\u5f55\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u4e3a\u6807\u51c6\u8f93\u51fa\uff0c\u5982\u679c\u914d\u7f6eRedis\u4e3a\u5b88\u62a4\u8fdb\u7a0b\u65b9\u5f0f\u8fd0\u884c\uff0c\u800c\u8fd9\u91cc\u53c8\u914d\u7f6e\u4e3a\u65e5\u5fd7\u8bb0\u5f55\u65b9\u5f0f\u4e3a\u6807\u51c6\u8f93\u51fa\uff0c\u5219\u65e5\u5fd7\u5c06\u4f1a\u53d1\u9001\u7ed9/dev/null logfile /var/log/redis_6379.log 8 . \u8bbe\u7f6e\u6570\u636e\u5e93\u7684\u6570\u91cf\uff0c\u9ed8\u8ba4\u6570\u636e\u5e93\u4e3a0\uff0c\u53ef\u4ee5\u4f7f\u7528SELECT <dbid>\u547d\u4ee4\u5728\u8fde\u63a5\u4e0a\u6307\u5b9a\u6570\u636e\u5e93id databases 16 9 . \u6307\u5b9a\u5728\u591a\u957f\u65f6\u95f4\u5185\uff0c\u6709\u591a\u5c11\u6b21\u66f4\u65b0\u64cd\u4f5c\uff0c\u5c31\u5c06\u6570\u636e\u540c\u6b65\u5230\u6570\u636e\u6587\u4ef6\uff0c\u53ef\u4ee5\u591a\u4e2a\u6761\u4ef6\u914d\u5408 save <seconds> <changes> Redis\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e2d\u63d0\u4f9b\u4e86\u4e09\u4e2a\u6761\u4ef6\uff1a save 900 1 save 300 10 save 60 10000 \u5206\u522b\u8868\u793a900\u79d2\uff0815\u5206\u949f\uff09\u5185\u67091\u4e2a\u66f4\u6539\uff0c300\u79d2\uff085\u5206\u949f\uff09\u5185\u670910\u4e2a\u66f4\u6539\u4ee5\u53ca60\u79d2\u5185\u670910000\u4e2a\u66f4\u6539\u3002 10 . \u6307\u5b9a\u5b58\u50a8\u81f3\u672c\u5730\u6570\u636e\u5e93\u65f6\u662f\u5426\u538b\u7f29\u6570\u636e\uff0c\u9ed8\u8ba4\u4e3ayes\uff0cRedis\u91c7\u7528LZF\u538b\u7f29\uff0c\u5982\u679c\u4e3a\u4e86\u8282\u7701CPU\u65f6\u95f4\uff0c\u53ef\u4ee5\u5173\u95ed\u8be5\u9009\u9879\uff0c\u4f46\u4f1a\u5bfc\u81f4\u6570\u636e\u5e93\u6587\u4ef6\u53d8\u7684\u5de8\u5927 rdbcompression yes 11 . \u6307\u5b9a\u672c\u5730\u6570\u636e\u5e93\u6587\u4ef6\u540d\uff0c\u9ed8\u8ba4\u503c\u4e3adump.rdb dbfilename dump.rdb 12 . \u6307\u5b9a\u672c\u5730\u6570\u636e\u5e93\u5b58\u653e\u76ee\u5f55 dir /var/lib/redis/6379 13 . \u8bbe\u7f6e\u5f53\u672c\u673a\u4e3aslave\u670d\u52a1\u65f6\uff0c\u8bbe\u7f6emaster\u670d\u52a1\u7684IP\u5730\u5740\u53ca\u7aef\u53e3\uff0c\u5728Redis\u542f\u52a8\u65f6\uff0c\u5b83\u4f1a\u81ea\u52a8\u4ecemaster\u8fdb\u884c\u6570\u636e\u540c\u6b65 slaveof <masterip> <masterport> 14 . \u5f53master\u670d\u52a1\u8bbe\u7f6e\u4e86\u5bc6\u7801\u4fdd\u62a4\u65f6\uff0cslave\u670d\u52a1\u8fde\u63a5master\u7684\u5bc6\u7801 masterauth <master-password> 15 . \u8bbe\u7f6eRedis\u8fde\u63a5\u5bc6\u7801\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u8fde\u63a5\u5bc6\u7801\uff0c\u5ba2\u6237\u7aef\u5728\u8fde\u63a5Redis\u65f6\u9700\u8981\u901a\u8fc7AUTH <password>\u547d\u4ee4\u63d0\u4f9b\u5bc6\u7801\uff0c\u9ed8\u8ba4\u5173\u95ed requirepass foobared 16 . \u8bbe\u7f6e\u540c\u4e00\u65f6\u95f4\u6700\u5927\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\uff0c\u9ed8\u8ba4\u65e0\u9650\u5236\uff0cRedis\u53ef\u4ee5\u540c\u65f6\u6253\u5f00\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\u4e3aRedis\u8fdb\u7a0b\u53ef\u4ee5\u6253\u5f00\u7684\u6700\u5927\u6587\u4ef6\u63cf\u8ff0\u7b26\u6570\uff0c\u5982\u679c\u8bbe\u7f6e maxclients 0 \uff0c\u8868\u793a\u4e0d\u4f5c\u9650\u5236\u3002\u5f53\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\u5230\u8fbe\u9650\u5236\u65f6\uff0cRedis\u4f1a\u5173\u95ed\u65b0\u7684\u8fde\u63a5\u5e76\u5411\u5ba2\u6237\u7aef\u8fd4\u56demax number of clients reached\u9519\u8bef\u4fe1\u606f maxclients 128 17 . \u6307\u5b9aRedis\u6700\u5927\u5185\u5b58\u9650\u5236\uff0cRedis\u5728\u542f\u52a8\u65f6\u4f1a\u628a\u6570\u636e\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\uff0c\u8fbe\u5230\u6700\u5927\u5185\u5b58\u540e\uff0cRedis\u4f1a\u5148\u5c1d\u8bd5\u6e05\u9664\u5df2\u5230\u671f\u6216\u5373\u5c06\u5230\u671f\u7684Key\uff0c\u5f53\u6b64\u65b9\u6cd5\u5904\u7406 \u540e\uff0c\u4ecd\u7136\u5230\u8fbe\u6700\u5927\u5185\u5b58\u8bbe\u7f6e\uff0c\u5c06\u65e0\u6cd5\u518d\u8fdb\u884c\u5199\u5165\u64cd\u4f5c\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u8fdb\u884c\u8bfb\u53d6\u64cd\u4f5c\u3002Redis\u65b0\u7684vm\u673a\u5236\uff0c\u4f1a\u628aKey\u5b58\u653e\u5185\u5b58\uff0cValue\u4f1a\u5b58\u653e\u5728swap\u533a maxmemory <bytes> 18 . \u6307\u5b9a\u662f\u5426\u5728\u6bcf\u6b21\u66f4\u65b0\u64cd\u4f5c\u540e\u8fdb\u884c\u65e5\u5fd7\u8bb0\u5f55\uff0cRedis\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u5f02\u6b65\u7684\u628a\u6570\u636e\u5199\u5165\u78c1\u76d8\uff0c\u5982\u679c\u4e0d\u5f00\u542f\uff0c\u53ef\u80fd\u4f1a\u5728\u65ad\u7535\u65f6\u5bfc\u81f4\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6570\u636e\u4e22\u5931\u3002\u56e0\u4e3a redis\u672c\u8eab\u540c\u6b65\u6570\u636e\u6587\u4ef6\u662f\u6309\u4e0a\u9762save\u6761\u4ef6\u6765\u540c\u6b65\u7684\uff0c\u6240\u4ee5\u6709\u7684\u6570\u636e\u4f1a\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\u53ea\u5b58\u5728\u4e8e\u5185\u5b58\u4e2d\u3002\u9ed8\u8ba4\u4e3ano appendonly yes 19 . \u6307\u5b9a\u66f4\u65b0\u65e5\u5fd7\u6587\u4ef6\u540d\uff0c\u9ed8\u8ba4\u4e3aappendonly.aof appendfilename appendonly.aof 20 . \u6307\u5b9a\u66f4\u65b0\u65e5\u5fd7\u6761\u4ef6\uff0c\u5171\u67093\u4e2a\u53ef\u9009\u503c\uff1a no\uff1a\u8868\u793a\u7b49\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u884c\u6570\u636e\u7f13\u5b58\u540c\u6b65\u5230\u78c1\u76d8\uff08\u5feb\uff09 always\uff1a\u8868\u793a\u6bcf\u6b21\u66f4\u65b0\u64cd\u4f5c\u540e\u624b\u52a8\u8c03\u7528fsync () \u5c06\u6570\u636e\u5199\u5230\u78c1\u76d8\uff08\u6162\uff0c\u5b89\u5168\uff09 everysec\uff1a\u8868\u793a\u6bcf\u79d2\u540c\u6b65\u4e00\u6b21\uff08\u6298\u8877\uff0c\u9ed8\u8ba4\u503c\uff09 appendfsync everysec 21 . \u6307\u5b9a\u662f\u5426\u542f\u7528\u865a\u62df\u5185\u5b58\u673a\u5236\uff0c\u9ed8\u8ba4\u503c\u4e3ano\uff0c\u7b80\u5355\u7684\u4ecb\u7ecd\u4e00\u4e0b\uff0cVM\u673a\u5236\u5c06\u6570\u636e\u5206\u9875\u5b58\u653e\uff0c\u7531Redis\u5c06\u8bbf\u95ee\u91cf\u8f83\u5c11\u7684\u9875\u5373\u51b7\u6570\u636eswap\u5230\u78c1\u76d8\u4e0a\uff0c\u8bbf\u95ee\u591a\u7684\u9875\u9762\u7531\u78c1\u76d8\u81ea\u52a8\u6362\u51fa\u5230\u5185\u5b58\u4e2d\uff08\u5728\u540e\u9762\u7684\u6587\u7ae0\u6211\u4f1a\u4ed4\u7ec6\u5206\u6790Redis\u7684VM\u673a\u5236\uff09 vm-enabled no 22 . \u865a\u62df\u5185\u5b58\u6587\u4ef6\u8def\u5f84\uff0c\u9ed8\u8ba4\u503c\u4e3a/tmp/redis.swap\uff0c\u4e0d\u53ef\u591a\u4e2aRedis\u5b9e\u4f8b\u5171\u4eab vm-swap-file /tmp/redis.swap 23 . \u5c06\u6240\u6709\u5927\u4e8evm-max-memory\u7684\u6570\u636e\u5b58\u5165\u865a\u62df\u5185\u5b58,\u65e0\u8bbavm-max-memory\u8bbe\u7f6e\u591a\u5c0f,\u6240\u6709\u7d22\u5f15\u6570\u636e\u90fd\u662f\u5185\u5b58\u5b58\u50a8\u7684 ( Redis\u7684\u7d22\u5f15\u6570\u636e \u5c31\u662fkeys ) ,\u4e5f\u5c31\u662f\u8bf4,\u5f53vm-max-memory\u8bbe\u7f6e\u4e3a0\u7684\u65f6\u5019,\u5176\u5b9e\u662f\u6240\u6709value\u90fd\u5b58\u5728\u4e8e\u78c1\u76d8\u3002\u9ed8\u8ba4\u503c\u4e3a0 vm-max-memory 0 24 . Redis swap\u6587\u4ef6\u5206\u6210\u4e86\u5f88\u591a\u7684page\uff0c\u4e00\u4e2a\u5bf9\u8c61\u53ef\u4ee5\u4fdd\u5b58\u5728\u591a\u4e2apage\u4e0a\u9762\uff0c\u4f46\u4e00\u4e2apage\u4e0a\u4e0d\u80fd\u88ab\u591a\u4e2a\u5bf9\u8c61\u5171\u4eab\uff0cvm-page-size\u662f\u8981\u6839\u636e\u5b58\u50a8\u7684 \u6570\u636e\u5927\u5c0f\u6765\u8bbe\u5b9a\u7684\uff0c\u4f5c\u8005\u5efa\u8bae\u5982\u679c\u5b58\u50a8\u5f88\u591a\u5c0f\u5bf9\u8c61\uff0cpage\u5927\u5c0f\u6700\u597d\u8bbe\u7f6e\u4e3a32\u6216\u800564bytes\uff1b\u5982\u679c\u5b58\u50a8\u5f88\u5927\u5927\u5bf9\u8c61\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u66f4\u5927\u7684page\uff0c\u5982\u679c\u4e0d \u786e\u5b9a\uff0c\u5c31\u4f7f\u7528\u9ed8\u8ba4\u503c vm-page-size 32 25 . \u8bbe\u7f6eswap\u6587\u4ef6\u4e2d\u7684page\u6570\u91cf\uff0c\u7531\u4e8e\u9875\u8868\uff08\u4e00\u79cd\u8868\u793a\u9875\u9762\u7a7a\u95f2\u6216\u4f7f\u7528\u7684bitmap\uff09\u662f\u5728\u653e\u5728\u5185\u5b58\u4e2d\u7684\uff0c\uff0c\u5728\u78c1\u76d8\u4e0a\u6bcf8\u4e2apages\u5c06\u6d88\u80171byte\u7684\u5185\u5b58\u3002 vm-pages 134217728 26 . \u8bbe\u7f6e\u8bbf\u95eeswap\u6587\u4ef6\u7684\u7ebf\u7a0b\u6570,\u6700\u597d\u4e0d\u8981\u8d85\u8fc7\u673a\u5668\u7684\u6838\u6570,\u5982\u679c\u8bbe\u7f6e\u4e3a0,\u90a3\u4e48\u6240\u6709\u5bf9swap\u6587\u4ef6\u7684\u64cd\u4f5c\u90fd\u662f\u4e32\u884c\u7684\uff0c\u53ef\u80fd\u4f1a\u9020\u6210\u6bd4\u8f83\u957f\u65f6\u95f4\u7684\u5ef6\u8fdf\u3002\u9ed8\u8ba4\u503c\u4e3a4 vm-max-threads 4 27 . \u8bbe\u7f6e\u5728\u5411\u5ba2\u6237\u7aef\u5e94\u7b54\u65f6\uff0c\u662f\u5426\u628a\u8f83\u5c0f\u7684\u5305\u5408\u5e76\u4e3a\u4e00\u4e2a\u5305\u53d1\u9001\uff0c\u9ed8\u8ba4\u4e3a\u5f00\u542f glueoutputbuf yes 28 . \u6307\u5b9a\u5728\u8d85\u8fc7\u4e00\u5b9a\u7684\u6570\u91cf\u6216\u8005\u6700\u5927\u7684\u5143\u7d20\u8d85\u8fc7\u67d0\u4e00\u4e34\u754c\u503c\u65f6\uff0c\u91c7\u7528\u4e00\u79cd\u7279\u6b8a\u7684\u54c8\u5e0c\u7b97\u6cd5 hash-max-zipmap-entries 64 hash-max-zipmap-value 512 29 . \u6307\u5b9a\u662f\u5426\u6fc0\u6d3b\u91cd\u7f6e\u54c8\u5e0c\uff0c\u9ed8\u8ba4\u4e3a\u5f00\u542f\uff08\u540e\u9762\u5728\u4ecb\u7ecdRedis\u7684\u54c8\u5e0c\u7b97\u6cd5\u65f6\u5177\u4f53\u4ecb\u7ecd\uff09 activerehashing yes 30 . \u6307\u5b9a\u5305\u542b\u5176\u5b83\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u5728\u540c\u4e00\u4e3b\u673a\u4e0a\u591a\u4e2aRedis\u5b9e\u4f8b\u4e4b\u95f4\u4f7f\u7528\u540c\u4e00\u4efd\u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u540c\u65f6\u5404\u4e2a\u5b9e\u4f8b\u53c8\u62e5\u6709\u81ea\u5df1\u7684\u7279\u5b9a\u914d\u7f6e\u6587\u4ef6 include /path/to/local.conf \u5f53\u7136\u4ee5\u4e0a\u7684\u914d\u7f6e\u53c2\u6570\u4e0d\u9700\u8981\u90fd\u4e86\u89e3\uff0c\u770b\u60c5\u51b5\u9700\u8981\u4ec0\u4e48\u914d\u7f6e\u4ec0\u4e48\u5373\u53ef\u3002\u6211\u4eec\u4e4b\u540e\u4f7f\u7528helm\u90e8\u7f72\u5927\u90e8\u5206\u7684\u53c2\u6570\u4e5f\u5df2\u7ecf\u90fd\u6709\u4e86\u3002redis\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684\u5c31\u662f\u4ed6\u7684\u6301\u4e45\u5316\u3002\u540e\u7eed\u4f1a\u5217\u4e00\u4e0b\u4ed6\u6301\u4e45\u5316\u7684\u7684\u65b9\u5f0f\u3002 redis-cli \u7528\u6cd5 \u00b6 redis-cli -h \u8fdc\u7a0b\u8fde\u63a5\u4e3b\u673a -p \u6307\u5b9a\u7aef\u53e3 -a \u6307\u5b9a\u5bc6\u7801 \u6ce8\uff1a\u82e5\u672a\u8bbe\u7f6e\u6570\u636e\u5e93\u5bc6\u7801 -a\u9009\u9879\u53ef\u4ee5\u5ffd\u7565 \u9000\u51fa\u6570\u636e\u5e93\u64cd\u4f5c\u73af\u5883\u53ef\u4ee5\u6267\u884c quit \u6216 exit \u5c31\u53ef\u4ee5\u8fd4\u56de\u5230\u539f\u6765\u7684shell\u6587\u4ef6 [root@localhost ~]# redis-cli 127.0.0.1:6379> ping PONG # \u6267\u884cping\u547d\u4ee4\u53ef\u4ee5\u68c0\u6d4bRedis\u670d\u52a1\u662f\u5426\u542f\u52a8 redis-benchmark\u6d4b\u8bd5\u5de5\u5177 \u00b6 Redis-benchmark\u662fredis\u5b98\u65b9\u81ea\u5e26\u7684redis\u6027\u80fd\u6d4b\u8bd5\u5de5\u5177\uff0c\u53ef\u4ee5\u6709\u6548\u7684\u6d4b\u8bd5redis\u670d\u52a1\u7684\u6027\u80fd\u3002 \u8bed\u6cd5\uff1a redis-benchmark [option] [option value] \u53c2\u6570\uff1a -h\uff1a\u6307\u5b9a\u670d\u52a1\u5668\u540d -p\uff1a\u6307\u5b9a\u670d\u52a1\u5668\u7aef\u53e3 -s\uff1a\u6307\u5b9a\u670d\u52a1\u5668socket -c\uff1a\u6307\u5b9a\u5e76\u53d1\u8fde\u63a5\u6570 -n\uff1a\u6307\u5b9a\u8bf7\u6c42\u8fde\u63a5\u6570 -d\uff1a\u4ee5\u5b57\u8282\uff08B\uff09\u7684\u5f62\u5f0f\u6307\u5b9a SET/GET\u503c\u7684\u6570\u636e\u5927\u5c0f -k\uff1a1=keep alive 0=reconnect -r:SET/GET/INCR \u4f7f\u7528\u968f\u673akey\uff0cSADD\u4f7f\u7528\u7684\u968f\u673a\u503c -P\uff1a\u901a\u8fc7\u7ba1\u9053\u4f20\u8f93<numreq>\u8bf7\u6c42 -q\uff1a\u5f3a\u5236\u9000\u51fa redis\u3002\u4ec5\u663e\u793a query/sec\u503c --csv :\u4ee5CSV\u683c\u5f0f\u8f93\u51fa -l \uff1a \u751f\u6210\u5faa\u73af\uff0c\u6c38\u4e45\u6267\u884c\u6d4b\u8bd5 -t \uff1a \u4ec5\u8fd0\u884c\u4ee5\u9017\u53f7\u5206\u9694\u7684\u6d4b\u8bd5\u547d\u4ee4\u5217\u8868 -I :idle\u6a21\u5f0f\u3002\u4ec5\u6253\u5f00/v\u4e2aidle\u8fde\u63a5\u5e76\u7b49\u5f85 Redis-benchmark\u5e94\u7528\u5b9e\u4f8b \u00b6 \u6d4b\u8bd5\u5e76\u53d1\u6570\u4e3a10\u8bf7\u6c42\u8fde\u63a5\u6570\u4e3a100000\u4e2a\u8bf7\u6c42\u7684\u6027\u80fd [root@localhost redis]# redis-benchmark -h localhost -p 6379 -c 10 -n 100000 Summary: throughput summary: 2584.25 requests per second latency summary (msec): avg min p50 p95 p99 max 3.378 0.448 2.719 7.159 16.607 389.375 \u6d4b\u8bd5\u5b58\u53d6\u5927\u5c0f\u4e3a100B\u7684\u6570\u636e\u5305\u65f6redis\u7684\u6027\u80fd [root@localhost ~]# redis-benchmark -h localhost -p 6379 -q -d 100 PING_INLINE: 9354.54 requests per second, p50=2.543 msec PING_MBULK: 9018.76 requests per second, p50=2.567 msec SET: 6365.78 requests per second, p50=5.183 msec GET: 8983.11 requests per second, p50=2.639 msec INCR: 6784.26 requests per second, p50=4.711 msec LPUSH: 6266.84 requests per second, p50=5.511 msec RPUSH: 6391.41 requests per second, p50=5.359 msec LPOP: 6735.37 requests per second, p50=4.911 msec RPOP: 7187.01 requests per second, p50=4.935 msec SADD: 9295.41 requests per second, p50=2.551 msec HSET: 6427.15 requests per second, p50=5.359 msec SPOP: 9106.64 requests per second, p50=2.527 msec ZADD: 8525.88 requests per second, p50=2.663 msec ZPOPMIN: 8797.40 requests per second, p50=2.559 msec LPUSH (needed to benchmark LRANGE): 6059.87 requests per second, p50=5.615 msec LRANGE_100 (first 100 elements): 4113.20 requests per second, p50=5.695 msec LRANGE_300 (first 300 elements): 1667.83 requests per second, p50=13.879 msec LRANGE_500 (first 500 elements): 1051.38 requests per second, p50=15.783 msec LRANGE_600 (first 600 elements): 951.19 requests per second, p50=18.767 msec MSET (10 keys): 3831.71 requests per second, p50=9.711 msec \u53c2\u6570\u8bf4\u660e\uff1a \u4f60\u8fd0\u884c\u7684\u662f Redis \u7684\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u4e86\u5404\u79cd\u5e38\u89c1\u7684 Redis \u64cd\u4f5c\u7684\u6027\u80fd\u3002\u4ee5\u4e0b\u662f\u5bf9\u8fd9\u4e9b\u7ed3\u679c\u7684\u89e3\u8bfb\uff1a - `PING_INLINE` \u548c `PING_MBULK` \u662f\u68c0\u6d4b Redis \u670d\u52a1\u5668\u662f\u5426\u5728\u7ebf\u7684\u64cd\u4f5c\u3002\u5728\u8fd9\u6b21\u6d4b\u8bd5\u4e2d\uff0c\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 9354.54 \u548c 9018.76 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 2.543 \u548c 2.567 \u6beb\u79d2\u3002 - `SET`\u3001`GET` \u548c `INCR` \u662f\u5e38\u89c1\u7684\u952e\u503c\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 6365.78\u30018983.11 \u548c 6784.26 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 5.183\u30012.639 \u548c 4.711 \u6beb\u79d2\u3002 - `LPUSH`\u3001`RPUSH`\u3001`LPOP` \u548c `RPOP` \u662f\u5217\u8868\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 6266.84\u30016391.41\u30016735.37 \u548c 7187.01 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 5.511\u30015.359\u30014.911 \u548c 4.935 \u6beb\u79d2\u3002 - `SADD`\u3001`HSET` \u548c `SPOP` \u662f\u96c6\u5408\u548c\u54c8\u5e0c\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 9295.41\u30016427.15 \u548c 9106.64 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 2.551\u30015.359 \u548c 2.527 \u6beb\u79d2\u3002 - `ZADD` \u548c `ZPOPMIN` \u662f\u6709\u5e8f\u96c6\u5408\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 8525.88 \u548c 8797.40 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 2.663 \u548c 2.559 \u6beb\u79d2\u3002 - `LRANGE` \u662f\u83b7\u53d6\u5217\u8868\u7684\u4e00\u90e8\u5206\u7684\u64cd\u4f5c\u3002\u8fd9\u4e2a\u64cd\u4f5c\u7684\u6027\u80fd\u53d6\u51b3\u4e8e\u4f60\u83b7\u53d6\u7684\u5143\u7d20\u6570\u91cf\u3002\u5728\u8fd9\u6b21\u6d4b\u8bd5\u4e2d\uff0c\u83b7\u53d6\u524d 100\u3001300\u3001500 \u548c 600 \u4e2a\u5143\u7d20\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 4113.20\u30011667.83\u30011051.38 \u548c 951.19 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 5.695\u300113.879\u300115.783 \u548c 18.767 \u6beb\u79d2\u3002 - `MSET` \u662f\u4e00\u6b21\u8bbe\u7f6e\u591a\u4e2a\u952e\u503c\u7684\u64cd\u4f5c\u3002\u5728\u8fd9\u6b21\u6d4b\u8bd5\u4e2d\uff0c\u8bbe\u7f6e 10 \u4e2a\u952e\u503c\u7684\u541e\u5410\u91cf\u662f 3831.71 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u662f 9.711 \u6beb\u79d2\u3002 \u8fd9\u4e9b\u7ed3\u679c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u4e86\u89e3\u5728\u4f60\u7684\u786c\u4ef6\u548c\u914d\u7f6e\u4e0b\uff0cRedis \u5bf9\u4e8e\u5404\u79cd\u64cd\u4f5c\u7684\u6027\u80fd\u8868\u73b0\u3002\u5982\u679c\u4f60\u53d1\u73b0\u67d0\u4e9b\u64cd\u4f5c\u7684\u6027\u80fd\u4e0d\u4f73\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u8c03\u6574 Redis \u7684\u914d\u7f6e\u6216\u5347\u7ea7\u4f60\u7684\u786c\u4ef6\u6765\u6539\u5584\u6027\u80fd\u3002 \u6d4b\u8bd5\u6267\u884cset,lpush \u64cd\u4f5c\u65f6\u7684\u6027\u80fd [root@localhost ~]# redis-benchmark -h localhost -p 6379 -t set,lpush -n 100000 -q Redis\u6570\u636e\u5e93\u5e38\u7528\u547d\u4ee4 \u00b6 Redis\u6570\u636e\u5e93\u91c7\u7528key-values\uff08\u952e\u503c\u5bf9\uff09\u7684\u6570\u636e\u5b58\u50a8\u5f62\u5f0f\uff0c\u6240\u4f7f\u7528\u7684\u547d\u4ee4\u662fset\u4e0eget\u547d\u4ee4\u3002 set\uff1a\u7528\u4e8eredis\u6570\u636e\u5e93\u4e2d\u5b58\u653e\u6570\u636e \u547d\u4ee4\u683c\u5f0f\u4e3a set key value get: \u7528\u4e8eredis\u6570\u636e\u5e93\u4e2d\u83b7\u53d6\u6570\u636e \u547d\u4ee4\u683c\u5f0f\u4e3a get key [root@localhost ~]# redis-cli 127.0.0.1:6379> ping # \u6d4b\u8bd5redis\u670d\u52a1\u662f\u5426\u542f\u52a8 PONG 127.0.0.1:6379> info # \u67e5\u770b\u8be6\u7ec6\u4fe1\u606f # Server redis_version:4.0.10 \u2026\u2026#\u7701\u7565\u90e8\u5206\u4fe1\u606f # CPU used_cpu_sys:232.48 # Cluster cluster_enabled:0 # Keyspace db0:keys=4,expires=0,avg_ttl=0 \u5185\u5b58\u4f7f\u7528\u91cf > INFO memory used_memory: 19167628056 used_memory_human: 17.85G used_memory_rss: 20684886016 used_memory_rss_human: 19.26G ... used_memory_overhead: 5727954464 ... used_memory_dataset: 13439673592 used_memory_dataset_perc: 70.12% \u5176\u4e2d used_memory_rss \u662f Redis \u5b9e\u9645\u4f7f\u7528\u7684\u603b\u5185\u5b58\u5927\u5c0f\uff0c\u8fd9\u91cc\u65e2\u5305\u542b\u4e86\u5b58\u50a8\u5728 Redis \u4e2d\u7684\u6570\u636e\u5927\u5c0f\uff08\u4e5f\u5c31\u662f\u4e0a\u9762\u7684 used_memory_dataset\uff09\uff0c\u4e5f\u5305\u542b\u4e86\u4e00\u4e9b Redis \u7684\u7cfb\u7edf\u5f00\u9500\uff08\u4e5f\u5c31\u662f\u4e0a\u9762\u7684 used_memory_overhead\uff09\u3002 set\uff0cget\u5e94\u7528\u6848\u4f8b 127.0.0.1:6379> set name zhangsan # \u8bbe\u7f6e\u952e\u503c\u5217\u8868\u4e3aname \u952e\u503c\u4e3azhangsan OK 127.0.0.1:6379> get name # \u83b7\u53d6name\u7684\u952e\u503c \"zhangsan\" key\u76f8\u5173\u547d\u4ee4 \u5728\u4f7f\u7528keys\u547d\u4ee4\u53ef\u4ee5\u53d6\u7b26\u5408\u89c4\u5219\u7684\u952e\u503c\u5217\u8868\uff0c\u901a\u5e38\u60c5\u51b5\u53ef\u4ee5\u7ed3\u5408 \uff0c\uff1f\u7b49\u9009\u9879\u6765\u4f7f\u7528 \uff1f\uff1a\u8868\u793a\u4efb\u610f\u4e00\u4f4d\u6570\u636e \uff1a\u8868\u793a\u4efb\u610f\u6570\u636e 127.0.0.1:6379> set name zhangsan OK 127.0.0.1:6379> get name \"zhangsan\" 127.0.0.1:6379> set k1 1 OK 127.0.0.1:6379> set k2 2 OK 127.0.0.1:6379> set k3 3 OK 127.0.0.1:6379> set s1 4 OK 127.0.0.1:6379> set v55 5 OK \u901a\u8fc7keys\u83b7\u53d6\u952e\u503c\u5217\u8868\u4fe1\u606f 127.0.0.1:6379> keys * 1) \"name\" 2) \"mylist\" 3) \"key3\" 4) \"myhash\" 5) \"key1\" 6) \"key2\" 7) \"key:__rand_int__\" 8) \"key4\" 9) \"counter:__rand_int__\" 127.0.0.1:6379> KEYS key? # \uff1f\u8868\u793ak\u540e\u9762\u7684\u4efb\u610f\u4e00\u4e2a\u5b57\u7b26 \u53ca\u5339\u914d\u4efb\u4f55\u4e00\u4e2a\u4ee5k\u5f00\u5934\u7684\u952e\u5217\u8868\u540e\u9762\u53ea\u6709\u4e00\u4f4d\u7684 1) \"key3\" 2) \"key1\" 3) \"key2\" 4) \"key4\" 127.0.0.1:6379> 127.0.0.1:6379> KEYS key* # * \u4efb\u610f\u53ca\u5339\u914d\u4efb\u4f55\u4e00\u4e2a\u4ee5key\u5f00\u5934\u7684\u952e\u5217\u8868 1) \"key3\" 2) \"key1\" 3) \"key2\" 4) \"key:__rand_int__\" 5) \"key4\" exists\u547d\u4ee4 \u4f5c\u7528\uff1a\u7528\u6765\u5224\u65ad\u952e\u503c\u662f\u5426\u5b58\u5728 127.0.0.1:6379> exists name # \u5224\u65adname\u952e\u662f\u5426\u5b58\u5728 (integer) 1 # \u8fd4\u56de1\u8868\u793a\u5b58\u5728 127.0.0.1:6379> exists name1 (integer) 0 # \u8fd4\u56de0\u8868\u793a\u4e0d\u5b58\u5728 del \u5220\u9664\u547d\u4ee4 127.0.0.1:6379> get name \"zhangsan\" 127.0.0.1:6379> del name (integer) 1 127.0.0.1:6379> get name (nil) Type \u547d\u4ee4 \u4f5c\u7528\uff1a\u4f7f\u7528type\u547d\u4ee4\u53ef\u4ee5\u83b7\u53d6key\u5bf9\u5e94\u7684value\u503c\u7684\u7c7b\u578b 127.0.0.1:6379> type key1 string rename\u547d\u4ee4 (\u5bf9\u5df2\u6709\u7684key\u8fdb\u884c\u91cd\u547d\u540d) \u547d\u4ee4\u683c\u5f0f\uff1arename \u6e90key \u76ee\u6807key \u6e29\u99a8\u63d0\u793a \u6ce8\u610f\uff1a\u4f7f\u7528rename\u547d\u4ee4\u8fdb\u884c\u91cd\u547d\u540d\u65f6\uff0c\u65e0\u8bba\u76ee\u6807key\u662f\u5426\u5b58\u5728\u90fd\u4f1a\u8fdb\u884c\u91cd\u547d\u540d\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u5efa\u8bae\u5148\u4f7f\u7528exists\u67e5\u770b\u76ee\u6807key\u662f\u5426\u5b58\u5728\uff0c\u518d\u51b3\u5b9a\u662f\u5426\u6267\u884crename\u547d\u4ee4\uff0c\u4ee5\u514d\u8986\u76d6\u91cd\u8981\u7684\u6570\u636e\u3002 127.0.0.1:6379> get key1 \"1\" 127.0.0.1:6379> rename key1 name OK 127.0.0.1:6379> get name \"1\" dbsize\u547d\u4ee4(\u4f5c\u7528\uff1a\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u4e2dkey\u7684\u6570\u76ee) 127.0.0.1:6379> keys * 1) \"name\" 2) \"mylist\" 3) \"key3\" 4) \"myhash\" 5) \"key2\" 6) \"key:__rand_int__\" 7) \"key4\" 8) \"counter:__rand_int__\" 127.0.0.1:6379> dbsize (integer) 8 \u591a\u6570\u636e\u5e93\u5e38\u7528\u547d\u4ee4 \u00b6 \u591a\u6570\u636e\u5e93\u4e4b\u95f4\u5207\u6362 Redis\u652f\u6301\u591a\u6570\u636e\u5e93\uff0credis\u5728\u9ed8\u8ba4\u6ca1\u6709\u4efb\u4f55\u6539\u52a8\u7684\u60c5\u51b5\u4e0b\u5305\u542b16\u4e2a\u6570\u636e\u5e93\uff0c\u6570\u636e\u5e93\u7684\u540d\u79f0\u662f\u4f7f\u7528\u6570\u503c0~15\u6765\u4f9d\u6b21\u547d\u540d\u7684\uff0c\u800c\u6211\u4eec\u901a\u8fc7redis-cli\u6253\u5f00\u7684\u662f\u9ed8\u8ba4\u7684\u7b2c\u4e00\u4e2a\u5e93\u5176\u663e\u793a\u4e3a\u201c \u201d\u7684\u5f62\u5f0f,\u901a\u8fc7select\u547d\u4ee4\u8fdb\u884c\u5207\u6362\u540e \u5176\u683c\u5f0f\u4f1a\u53d8\u4e3a \u201c \u201d\u3002 n \u8868\u793aselect\u540e\u9762\u7684\u6570\u5b57 127.0.0.1:6379> select 5 OK 127.0.0.1:6379[5]> select 15 OK 127.0.0.1:6379[15]> select 16 # \u5207\u6362\u4e3a16\u65f6\u62a5\u9519 (error) ERR DB index is out of range # \u8d85\u51fa\u8303\u56f4 127.0.0.1:6379[15]> select 0 OK \u6e05\u9664\u6570\u636e\u5e93 \u00b6 Redis\u6e05\u9664\u6570\u636e\u5e93\u4e00\u822c\u5206\u4e3a\u4e24\u90e8\u5206 \u6e05\u9664\u5f53\u524d\u6570\u636e\u5e93\uff1aflushdb \u6e05\u9664\u6240\u6709\u6570\u636e\u5e93\u6587\u4ef6\uff1aflushall 127.0.0.1:6379> select 1 OK 127.0.0.1:6379[1]> flushdb OK 127.0.0.1:6379[1]> keys * (empty list or set) 127.0.0.1:6379[1]> select 0 OK 127.0.0.1:6379> keys * 1) \"counter:__rand_int__\" 2) \"key:__rand_int__\" 3) \"k1\" 4) \"myset:__rand_int__\" 5) \"mylist\" 127.0.0.1:6379> select 1 OK 127.0.0.1:6379[1]> flushall OK 127.0.0.1:6379[1]> select 0 OK 127.0.0.1:6379> keys * (empty list or set) \u6d4b\u8bd5\u8fde\u63a5: $ kubectl run --namespace redis-ha redis-client --restart='Never' --env REDIS_PASSWORD=$REDIS_PASSWORD --image docker.io/bitnami/redis:7.2.0-debian-11-r3 --command -- sleep infinity $ k exec -it redis-client -- /bin/bash I have no name!@redis-client:/$ redis-cli -h redis-redis-ha-haproxy.redis-ha I have no name!@redis-client:/$ redis-cli -h redis-redis-ha-haproxy.redis-ha info replication | grep role \u53c2\u8003\u6587\u7ae0 \u00b6 https://github.com/DandyDeveloper/charts/tree/master/charts/redis-ha","title":"redis \u7f13\u5b58\u52a0\u901f"},{"location":"5.Storage/redis-docs/#_1","text":"\u6570\u636e\u5e93\u6309\u7167\u5176\u7ed3\u6784\u53ef\u4ee5\u5206\u4e3a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e0e\u5176\u4ed6\u6570\u636e\u5e93\uff0c\u800c\u8fd9\u4e9b\u5176\u4ed6\u6570\u636e\u5e93\u6211\u4eec\u5c06\u7edf\u79f0\u4e3aNoSQL\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u3002","title":"\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e0e\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93"},{"location":"5.Storage/redis-docs/#_2","text":"\u5173\u7cfb\u578b\u6570\u636e\u5e93 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u662f\u4e00\u4e2a\u7ed3\u6784\u5316\u7684\u6570\u636e\u5e93\uff0c\u521b\u5efa\u5728\u5173\u7cfb\u6a21\u578b\u7684\u57fa\u7840\u4e0a\uff0c\u4e00\u822c\u9762\u5411\u8bb0\u5f55\uff0c\u4ed6\u501f\u52a9\u4e0e\u96c6\u5408\u4ee3\u6570\u7b49\u6570\u5b66\u6982\u5ff5\u548c\u65b9\u6cd5\u6765\u5904\u7406\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\uff0c\u5173\u7cfb\u6a21\u578b\u662f\u4e8c\u7ef4\u8868\u683c\u6a21\u578b\uff0c\u56e0\u800c\u4e00\u4e2a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5c31\u662f\u7531\u4e8c\u7ef4\u8868\u53ca\u5176\u4e4b\u95f4\u7684\u8054\u7cfb\u7ec4\u6210\u7684\u4e00\u4e2a\u6570\u636e\u4e00\u4e2a\u6570\u636e\u7ec4\u7ec7\u3002\u73b0\u5b9e\u4e16\u754c\u4e2d\uff0c\u5404\u79cd\u5b9e\u4f53\u4e0e\u5b9e\u4f53\u4e4b\u95f4\u7684\u5404\u79cd\u8054\u7cfb\u90fd\u53ef\u4ee5\u7528\u5173\u7cfb\u6a21\u578b\u6765\u8868\u793a\u3002SQL\u8bed\u53e5\uff08Structured Ouery Lanage\uff0c\u7ed3\u6784\u5316\u67e5\u8be2\u8bed\u8a00\uff09\u5c31\u662f\u4e00\u79cd\u57fa\u4e8e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u8bed\u8a00\uff0c\u7528\u4e8e\u6267\u884c\u5bf9\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u6570\u636e\u7684\u68c0\u7d22\u548c\u64cd\u4f5c\u3002\u4e3b\u6d41\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08mysql\u3001oracle\u3001sql server\u3001Microsoft Access\u3001DB2\uff09\u7b49\u3002 \u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93 NoSQL\uff08Not Only SQL\uff09\u5176\u610f\u601d\u662f\u4e0d\u4ec5\u4ec5\u662fSQL\uff0c\u662f\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u603b\u79f0\uff0c\u4e3b\u6d41\u7684\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08Memcached\u3001Redis\u3001MongoDB\u3001Hbase\u3001CouhDB\u7b49\u4ee5\u4e0a\u7684\u8fd9\u4e9b\u6570\u636e\u5e93\u5b83\u4eec\u7684\u5b58\u50a8\u65b9\u5f0f\uff0c\u5b58\u50a8\u7ed3\u6784\uff0c\u4ee5\u53ca\u4f7f\u7528\u573a\u666f\u662f\u5b8c\u5168\u4e0d\u540c\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8ba4\u4e3a\u4ed6\u662f\u4e00\u4e2a\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u96c6\u5408\uff0c\u800c\u4e0d\u662f\u50cf\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e00\u6837\u662f\u4e00\u4e2a\u7edf\u79f0\u3002\u6362\u8a00\u4e4b\uff0c\u4e3b\u6d41\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4ee5\u5916\u7684\u6570\u636e\u5e93\u90fd\u662f\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0cNoSQL\u6570\u636e\u5e93\u51ed\u501f\u7740\u5176\u975e\u5173\u7cfb\u578b\uff0c\u5206\u5e03\u5f0f\uff0c\u5f00\u6e90\u7684\u6a2a\u5411\u6269\u5c55\u7b49\u4f18\u52bf\uff0c\u88ab\u8ba4\u4e3a\u662f\u4e0b\u4e00\u4ee3\u6570\u636e\u5e93\u4ea7\u54c1\uff09\u3002","title":"\u626b\u76f2\u77e5\u8bc6"},{"location":"5.Storage/redis-docs/#_3","text":"\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5df2\u7ecf\u8bde\u751f\u5f88\u4e45\u4e86\uff0c\u800c\u4e14\u6211\u4eec\u4e00\u76f4\u5728\u4f7f\u7528\uff0c\u6ca1\u6709\u4ec0\u4e48\u95ee\u9898\uff0c\u9762\u5bf9\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u4f1a\u4ea7\u751f\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff1f\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u4ecb\u7ecd\u4e00\u4e0b\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4ea7\u751f\u7684\u80cc\u666f\u3002 \u968f\u7740Web 2.0\u7f51\u7ad9\u7684\u5174\u8d77\uff0c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5728\u5e94\u5bf9Web 2.0\u7f51\u7ad9\uff0c\u7279\u522b\u662f\u6d77\u91cf\u6570\u636e\u5e93\u548c\u9ad8\u5e76\u53d1\u7684SNS\uff08Social Networking Services\uff0c\u5373\u793e\u4ea4\u7f51\u7edc\u670d\u52a1\uff09\u7c7b\u578b\u7684Web 2.0\u7eaf\u52a8\u6001\u7f51\u7ad9\u65f6\uff0c\u66b4\u9732\u51fa\u5f88\u591a\u96be\u4ee5\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u4f8b\u5982\u4ee5\u4e0b\u4e09\u9ad8\u95ee\u9898\u3002 1\uff09High performance\u2014\u2014\u5bf9\u6570\u636e\u5e93\u9ad8\u5e76\u53d1\u8bfb\u5199\u9700\u6c42 Web 2.0\u7f51\u7ad9\u4f1a\u6839\u636e\u7528\u6237\u7684\u4e2a\u6027\u5316\u4fe1\u606f\u6765\u5b9e\u65f6\u751f\u6210\u52a8\u6001\u9875\u9762\u548c\u63d0\u4f9b\u52a8\u6001\u4fe1\u606f\uff0c\u56e0\u4e3a\uff0c\u65e0\u6cd5\u4f7f\u7528\u52a8\u6001\u9875\u9762\u9759\u6001\u5316\u6280\u672f\uff0c\u6240\u4ee5\u6570\u636e\u5e93\u7684\u5e76\u53d1\u8d1f\u8f7d\u975e\u5e38\u9ad8\uff0c\u4e00\u822c\u4f1a\u8fbe\u523010000\u6b21/s\u4ee5\u4e0a\u7684\u8bfb\u5199\u8bf7\u6c42\u3002\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5bf9\u4e8e\u4e0a\u4e07\u6b21\u7684\u67e5\u8be2\u8bf7\u6c42\u8fd8\u662f\u53ef\u4ee5\u52c9\u5f3a\u652f\u6491\u7684\u3002\u5f53\u51fa\u73b0\u4e0a\u4e07\u6b21\u7684\u5199\u6570\u636e\u8bf7\u6c42\u65f6\uff0c\u786c\u76d8I/O\u5c31\u5df2\u7ecf\u65e0\u6cd5\u627f\u53d7\u4e86\uff0c\u5bf9\u4e8e\u666e\u901a\u7684BBS\u7f51\u7ad9\uff0c\u5f80\u5f80\u4e5f\u4f1a\u5b58\u5728\u9ad8\u5e76\u53d1\u7684\u8bfb\u6570\u636e\u8bf7\u6c42\uff0c\u5982\u660e\u661f\u9e7f\u6657\u5728\u5fae\u535a\u4e0a\u516c\u5e03\u604b\u60c5\uff0c\u7ed3\u679c\u56e0\u4e3a\u6d41\u91cf\u8fc7\u5927\u800c\u5f15\u53d1\u5fae\u535a\u762b\u75ea\u3002 2\uff09Huge storage\u2014\u2014\u5bf9\u6d77\u91cf\u6570\u636e\u5e93\u9ad8\u6548\u5b58\u50a8\u4e0e\u8bbf\u95ee\u9700\u6c42 \u7c7b\u4f3c\u4e8eFacebook\u3001Friendfeed\u8fd9\u6837\u7684SNS\u7f51\u7ad9\uff0c\u6bcf\u5929\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u7528\u6237\u52a8\u6001\u4fe1\u606f\uff0c\u4f8b\u5982Friendfeed\u4e00\u4e2a\u6708\u5c31\u4f1a\u4ea7\u751f2.5\u4ebf\u6761\u7528\u6237\u52a8\u6001\u4fe1\u606f\uff0c\u5bf9\u4e8e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6765\u8bf4\uff0c\u5728\u4e00\u4e2a\u5305\u542b2.5\u4ebf\u6761\u8bb0\u5f55\u7684\u8868\u4e2d\u6267\u884cSQL\u67e5\u8be2\uff0c\u6548\u7387\u662f\u975e\u5e38\u4f4e\u7684\u3002 3\uff09High Scalability && High Availability\u2014\u2014\u5bf9\u6570\u636e\u5e93\u9ad8\u6269\u5c55\u6027\u4e0e\u9ad8\u53ef\u7528\u6027\u9700\u6c42 \u5728Web\u67b6\u6784\u4e2d\uff0c\u6570\u636e\u5e93\u662f\u6700\u96be\u8fdb\u884c\u6a2a\u5411\u6269\u5c55\u7684\uff0c\u5f53\u5e94\u7528\u7cfb\u7edf\u7684\u7528\u6237\u91cf\u4e0e\u8bbf\u95ee\u91cf\u4e0e\u65e5\u4ff1\u589e\u65f6\uff0c\u6570\u636e\u5e93\u662f\u6ca1\u529e\u6cd5\u50cfWeb\u670d\u52a1\u4e00\u6837\uff0c\u7b80\u5355\u5730\u901a\u8fc7\u6dfb\u52a0\u786c\u4ef6\u548c\u670d\u52a1\u8282\u70b9\u5176\u6027\u80fd\u548c\u8d1f\u8f7d\u5747\u8861\u80fd\u529b\u7684\uff0c\u5c24\u5176\u5bf9\u4e8e\u4e00\u4e9b\u9700\u898124h\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u7684\u7f51\u7ad9\u6765\u8bf4\uff0c\u6570\u636e\u5e93\u7684\u5347\u7ea7\u4e0e\u6269\u5c55\u6027\u5f80\u5f80\u4f34\u968f\u7740\u505c\u673a\u7ef4\u62a4\u4e0e\u6570\u636e\u8fc1\u79fb\uff0c\u5176\u5de5\u4f5c\u91cf\u662f\u975e\u5e38\u5e9e\u5927\u7684\u3002 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u548c\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u90fd\u6709\u5404\u81ea\u7684\u7279\u70b9\u4e0e\u5e94\u7528\u573a\u666f\uff0c\u518d\u8005\u7684\u7d27\u5bc6\u7ed3\u5408\u5c06\u4f1a\u7ed9Web 2.0\u7684\u6570\u636e\u5e93\u53d1\u5c55\u5e26\u6765\u65b0\u7684\u601d\u8def\uff0c\u8ba9\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5173\u6ce8\u5728\u5173\u7cfb\u4e0a\uff0c\u975e\u5173\u7cfb\u6570\u636e\u5e93\u5173\u6ce8\u5728\u5b58\u50a8\u4e0a\u3002","title":"\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4ea7\u751f\u80cc\u666f"},{"location":"5.Storage/redis-docs/#redis","text":"Redis\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\uff0c\u4f7f\u7528C\u8bed\u8a00\u7f16\u5199\uff0c\u652f\u6301\u7f51\u7edc\uff0c\u53ef\u57fa\u4e8e\u5185\u5b58\u5de5\u4f5c\u4ea6\u53ef\u6301\u4e45\u5316\uff08AOF\uff0cRDB \uff09\u7684\u65e5\u5fd7\u578b\uff0ckey-values\uff08\u952e\u503c\u5bf9\uff09\u6570\u636e\u5e93\uff0c\u4e00\u4e2a\u901f\u5ea6\u6781\u5feb\u7684\u975e\u5173\u7cfb\u6027\u6570\u636e\u5e93\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684NoSQL\u6570\u636e\u5e93\uff0c\u4ed6\u53ef\u4ee5\u5b58\u50a8\uff08key\uff09\u4e0e5\u79cd\u4e0d\u540c\u7c7b\u578b\u7684\u503c\uff08value\uff09\u4e4b\u95f4\u7684\u6620\u5c04\uff08mapping\uff09\uff0c\u53ef\u4ee5\u5c06\u5b58\u50a8\u5728\u5185\u5b58\u7684\u952e\u503c\u5bf9\u6570\u6301\u4e45\u5316\u5230\u786c\u76d8\uff0c\u53ef\u4ee5\u4f7f\u7528\u590d\u5236\u7279\u6027\u6765\u6269\u5c55\u8bfb\u6027\u80fd\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5ba2\u6237\u7aef\u5206\u7247\u6765\u6269\u5c55\u6027\u80fd\uff0c\u5e76\u4e14\u5b83\u8fd8\u63d0\u4f9b\u4e86\u591a\u79cd\u8bed\u8a00\u7684API\u3002 Redis\u7684\u6240\u6709\u6570\u636e\u90fd\u662f\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u7136\u540e\u4e0d\u5b9a\u671f\u7684\u901a\u8fc7\u5f02\u6b65\u65b9\u5f0f\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a\uff08\u8fd9\u4e2a\u79f0\u4e3a\u534a\u6301\u4e45\u5316RDB\uff09\uff1b\u4e5f\u53ef\u4ee5\u628a\u6bcf\u4e00\u6b21\u6570\u636e\u53d8\u5316\u90fd\u5199\u5165\u5230\u4e00\u4e2aappend onlyfile\uff08AOF\uff09\u91cc\u9762\uff08\u8fd9\u79f0\u4e3a\u201c\u5168\u6301\u4e45\u5316\u201d\uff09\u3002 \u5168\u6301\u4e45\u5316\u4e0e\u534a\u6301\u4e45\u5316\u7684\u65b9\u5f0f\u5728\u5de5\u4f5c\u4e2d\u9002\u5f53\u7684\u4f7f\u7528\uff0c\u5728\u5982\u4eca\u7684\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5982\u679c\u4f7f\u7528\u5168\u6301\u4e45\u5316\u7684\u65b9\u5f0f\u53ef\u80fd\u4f1a\u9020\u6210append onlyfile\u7684\u6587\u4ef6\u8fc7\u5927\uff0c\u5982\u679c\u662f\u534a\u6301\u4e45\u5316\u7684\u8bdd\u53c8\u6ca1\u6709\u529e\u6cd5\u4fdd\u8bc1\u6570\u636e\u7684\u5b89\u5168\u6027\uff0c\u6240\u4ee5\u5e0c\u671b\u5927\u5bb6\u9002\u5f53\u7684\u4f7f\u7528\u3002","title":"Redis \u4ecb\u7ecd"},{"location":"5.Storage/redis-docs/#redis_1","text":"Redis\u670d\u52a1\u5668\u7a0b\u5e8f\u662f\u4e00\u4e2a\u5355\u8fdb\u7a0b\u6a21\u578b\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\u53ef\u4ee5\u5f00\u542f\u591a\u4e2aredis\u8fdb\u7a0b\uff08\u591a\u5b9e\u4f8b\uff09\uff0c\u800credis\u7684\u5b9e\u9645\u5904\u7406\u901f\u5ea6\u5219\u5b8c\u5168\u4f9d\u9760\u4e8e\u4e3b\u8fdb\u7a0b\u7684\u6267\u884c\u901f\u7387\uff0c\u82e5\u5728\u670d\u52a1\u5668\u4e0a\u53ea\u8fd0\u884c\u4e00\u4e2aredis\u8fdb\u7a0b\uff0c\u5f53\u591a\u4e2a\u5ba2\u6237\u7aef\u540c\u65f6\u8bbf\u95ee\u65f6\uff0c\u670d\u52a1\u5668\u5904\u7406\u80fd\u529b\u4f1a\u6709\u4e00\u5b9a\u7a0b\u5ea6\u7684\u4e0b\u964d\uff0c\u82e5\u5728\u4e00\u4e2a\u670d\u52a1\u5668\u4e0a\u5f00\u542f\u591a\u4e2aredis\u8fdb\u7a0b\uff0credis\u5728\u63d0\u9ad8\u5e76\u53d1\u5904\u7406\u80fd\u529b\u7684\u540c\u65f6\u4e5f\u4f1a\u7ed9CPU\u9020\u6210\u5f88\u5927\u7684\u538b\u529b\uff0c\u6240\u4ee5\u5728\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u7ed3\u5408\u5b9e\u9645\u670d\u52a1\u5668\u73af\u5883\u6765\u51b3\u5b9a\u5982\u4f55\u4f7f\u7528\u3002","title":"Redis\u7684\u5de5\u4f5c\u539f\u7406"},{"location":"5.Storage/redis-docs/#redis_2","text":"\u5177\u6709\u6781\u9ad8\u7684\u6570\u636e\u8bfb\u5199\u901f\u5ea6\uff1a\u6570\u636e\u8bfb\u53d6\u901f\u5ea6\u6700\u9ad8\u53ef\u8fbe11\u4e07\u6b21/s\uff0c\u6570\u636e\u5199\u5165\u901f\u5ea6\u6700\u9ad8\u53ef\u8fbe8\u4e071\u5343\u6b21/s \u652f\u6301\u4e30\u5bcc\u7684\u6570\u636e\u7c7b\u578b\uff0c\u652f\u6301\u4e30\u5bcc\u7684\u6570\u636e\u7c7b\u578b\u4e0d\u4ec5\u652f\u6301key-values\u6570\u636e\u7c7b\u578b\uff0c\u8fd8\u652f\u6301Strings\uff0cLists\uff0cHashes\uff0cSets\uff0c\u53caOrdered Sets\u7b49\u6570\u636e\u7c7b\u578b\u64cd\u4f5c \u652f\u6301\u6570\u636e\u7684\u6301\u4e45\u5316\uff0c\u5728\u8fd9\u4e00\u70b9\u4e0aredis\u8fdc\u8fdc\u5f3a\u4e8ememcached\uff0credis\u53ef\u4ee5\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u78c1\u76d8\u4e2d\uff0c\u91cd\u542f\u540e\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u52a0\u8f7d\u4f7f\u7528 \u539f\u5b50\u6027 redis\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u662f\u539f\u5b50\u6027\u7684 \u652f\u6301\u6570\u636e\u5907\u4efd\u53camaster-slave\u6a21\u5f0f\u7684\u6570\u636e\u5907\u4efd","title":"Redis \u7684\u4f18\u70b9"},{"location":"5.Storage/redis-docs/#helm-redis","text":"\u5728\u4e91\u539f\u751f\u73af\u5883\u4e2d\u90e8\u7f72 Redis \u96c6\u7fa4\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u4f7f\u7528 Kubernetes\uff0c\u5b83\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u5e73\u53f0\uff0c\u7528\u4e8e\u81ea\u52a8\u5316\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u3002\u5bf9\u4e8e Redis\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Helm\uff0c\u8fd9\u662f\u4e00\u4e2a Kubernetes \u7684\u5305\u7ba1\u7406\u5668\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u66f4\u5bb9\u6613\u5730\u7ba1\u7406\u548c\u90e8\u7f72\u5e94\u7528\u3002 \u4ee5\u4e0b\u662f\u5728 Kubernetes \u4e2d\u4f7f\u7528 Helm \u90e8\u7f72 Redis \u96c6\u7fa4\u7684\u4e24\u79cd\u65b9\u6cd5\uff1a \u96c6\u7fa4\u65b9\u5f0f \u54e8\u5175\u65b9\u5f0f \u4ee5\u4e0b\u662f\u4e00\u4e2a\u5c0f demo \u7684\u4f8b\u5b50: \u5b89\u88c5 Helm \uff1a\u9996\u5148\uff0c\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u5b89\u88c5 Helm\uff0c\u4f60\u9700\u8981\u5728\u4f60\u7684\u673a\u5668\u4e0a\u5b89\u88c5\u5b83\u3002\u4f60\u53ef\u4ee5\u4ece Helm \u7684 GitHub \u4ed3\u5e93\u4e0b\u8f7d\u6700\u65b0\u7684 Helm \u4e8c\u8fdb\u5236\u5305\u5e76\u5b89\u88c5\u3002 \u6dfb\u52a0 Helm \u4ed3\u5e93 \uff1aBitnami \u7ef4\u62a4\u4e86\u4e00\u4e2a\u5305\u542b\u4e86\u8bb8\u591a\u5e38\u89c1\u5e94\u7528\uff08\u5305\u62ec Redis\uff09\u7684 Helm \u4ed3\u5e93\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6dfb\u52a0\u8fd9\u4e2a\u4ed3\u5e93\uff1a helm repo add bitnami https://charts.bitnami.com/bitnami helm repo update helm install my-redis-cluster bitnami/redis --set cluster.enabled=true,cluster.nodes=3,persistence.enabled=true,persistence.size=1Gi \u8fd9\u4e2a\u547d\u4ee4\u5c06\u90e8\u7f72\u4e00\u4e2a\u5305\u542b 3 \u4e2a\u8282\u70b9\u7684 Redis \u96c6\u7fa4\uff0c\u5e76\u4e3a\u6bcf\u4e2a\u8282\u70b9\u542f\u7528\u4e86 1Gi \u7684\u6301\u4e45\u5316\u5b58\u50a8\u3002 \u9a8c\u8bc1\u90e8\u7f72 \uff1a\u6700\u540e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5 Redis \u96c6\u7fa4\u7684\u72b6\u6001\uff1a \u5982\u679c\u4e00\u5207\u987a\u5229\uff0c\u4f60\u5e94\u8be5\u53ef\u4ee5\u770b\u5230\u4f60\u7684 Redis pods \u5728\u8fd0\u884c\u3002 \u8fd9\u53ea\u662f\u4e00\u4e2a\u6700\u57fa\u672c\u7684\u793a\u4f8b\u3002\u5728\u5b9e\u9645\u73af\u5883\u4e2d\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u6839\u636e\u4f60\u7684\u5177\u4f53\u9700\u6c42\u8c03\u6574\u5404\u79cd\u53c2\u6570\uff0c\u4f8b\u5982\u8282\u70b9\u6570\u3001\u5b58\u50a8\u5927\u5c0f\u3001\u5bc6\u7801\u7b49\u3002\u4f60\u53ef\u4ee5\u5728 Bitnami \u7684 Redis Helm chart \u6587\u6863\u4e2d\u627e\u5230\u66f4\u591a\u7684\u914d\u7f6e\u9009\u9879\u3002 \u6b64\u5916\uff0c\u4f60\u4e5f\u9700\u8981\u8003\u8651\u5982\u4f55\u5904\u7406\u6570\u636e\u6301\u4e45\u5316\u3001\u9ad8\u53ef\u7528\u6027\u3001\u5907\u4efd\u548c\u6062\u590d\u7b49\u95ee\u9898\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u914d\u7f6e Kubernetes \u7684 Persistent Volumes \u548c Persistent Volume Claims \u6765\u5904\u7406\u6570\u636e\u6301\u4e45\u5316\uff0c\u914d\u7f6e Redis \u7684\u4e3b\u4ece\u590d\u5236\u548c\u54e8\u5175\u6a21\u5f0f\u6765\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u5b9a\u671f\u5907\u4efd Redis \u6570\u636e\u4ee5\u9632\u6570\u636e\u4e22\u5931\uff0c\u7b49\u7b49\u3002","title":"** Helm \u90e8\u7f72 redis**"},{"location":"5.Storage/redis-docs/#_4","text":"\u6dfb\u52a0Helm chart helm repo add bitnami https://charts.bitnami.com/bitnami helm repo update \u67e5\u8be2 Redis \u8d44\u6e90 $ helm search repo redis NAME CHART VERSION APP VERSION DESCRIPTION bitnami/redis 17.15.2 7.0.12 Redis(R) is an open source, advanced key-value ... bitnami/redis-cluster 8.6.12 7.0.12 Redis(R) is an open source, scalable, distribut... prometheus-community/prometheus-redis-exporter 5.5.0 v1.44.0 Prometheus exporter for Redis metrics stable/prometheus-redis-exporter 3.5.1 1.3.4 DEPRECATED Prometheus exporter for Redis metrics stable/redis 10.5.7 5.0.7 DEPRECATED Open source, advanced key-value stor... stable/redis-ha 4.4.6 5.0.6 DEPRECATED - Highly available Kubernetes implem... ucloud-operator/redis-cluster-operator 0.1.0 0.1.0 A Helm chart for Redis cluster operator deployment stable/sensu 0.2.5 0.28 DEPRECATED Sensu monitoring framework backed by... \u6e29\u99a8\u63d0\u793a stable\u8fd9\u79cd\u65b9\u6848\u5df2\u7ecf\u4e0d\u7ef4\u62a4\u4e86\uff0c\u6240\u4ee5\u4e0d\u8003\u8651\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u8fd9\u8fb9\u4e3b\u8981\u4ee5bitnami\u6765\u8bb2\u3002\u8fd9\u91cc\u4e0d\u63a8\u8350\u4f7f\u7528\u6e90\u7801\u90e8\u7f72 \u4e0b\u8f7d chart \u5305 $ helm search repo redis --versions $ helm pull bitnami/redis --version 17.15.2 \u7531\u4e8eredis\u96c6\u7fa4\u5b58\u50a8\u65b9\u5f0f\u7684\u7279\u6b8a\u6027\uff0c\u8fd9\u91cc\u8003\u8651\u4f7f\u7528\u7684\u65b9\u6848\u7684\uff1alocal-path-provisioner \u5b98\u65b9\u5730\u5740: https://github.com/rancher/local-path-provisioner \u8003\u8651\u7684\u7406\u7531: 1. \u8131\u79bb\u4e2d\u5fc3\u5b58\u50a8\uff0c\u6211\u4eec\u7684\u4e4b\u524d\u6570\u636e\u5e93\u4e3b\u8981\u5b58\u50a8\u5728ceph\u4e2d\uff0c\u4e00\u65e6ceph\u51fa\u73b0\u95ee\u9898\uff0cmysql\u6709\u6781\u5927\u7684\u53ef\u80fd\u65e0\u6cd5\u542f\u52a8\u3002 2. \u5c06mysql\u7684\u6570\u636e\u5206\u79bb\u51fa\u6765\u6709\u5229\u4e8e\u51cf\u5c11\u4e2d\u5fc3\u5b58\u50a8\u7684\u538b\u529b\u3002 3. local-path-provisioner\u5c06\u672c\u5730\u76ee\u5f55\u4f5c\u4e3a\u6700\u540e\u6570\u636e\u5b58\u50a8\u7684\u8def\u5f84\u3002\u56e0\u6b64\u6211\u4eec\u5728\u591a\u4e2a\u8282\u70b9\u6dfb\u52a0\u4e00\u5757\u6570\u636e\u76d8+\u90e8\u7f72\u9ad8\u53ef\u7528\u7684\u54e8\u5175\u96c6\u7fa4\u5e76\u9650\u5236\u4e8e\u8be5\u8282\u70b9\u3002 \u5f53\u65f6\u4ee5\u4e0a\u65b9\u5f0f\u5728\u90e8\u7f72\u54e8\u5175\u96c6\u7fa4\u8fd8\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u5c31\u662f\u4ed6\u53ea\u652f\u6301\u8f6e\u8be2\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee\u540e\u7aef\u7684redis\uff0c\u8fd9\u4e2a\u5c31\u5f88\u626f\u6de1\uff0c\u8981\u662f\u5168\u662f\u8bfb\u7684\u573a\u666f\u8fd8\u53ef\u4ee5\u63a5\u53d7\uff0c\u4f46\u662f\u5982\u679c\u8981\u662f\u5199\u7684\u8bdd\uff0c\u9020\u6210\u7684\u7ed3\u679c\u5c31\u662f\u4e00\u4f1a\u6210\u529f\u4e00\u4f1a\u5931\u8d25\uff0c\u5f88\u50bb\u903c\u3002 \u8fd8\u662f\u89c9\u5f97\u4f7f\u7528\u4ee5\u524dstable\uff0c\u4e0d\u8fc7\u6362\u4e86\u4e00\u4e2a\u4eba\u7ef4\u62a4\u7684\u3002 helm repo add dandydev https://dandydeveloper.github.io/charts helm install dandydev/redis-ha \u4ed6\u652f\u6301hostpath\u548csc\uff0c\u8fd9\u91ccsc\u53ef\u4ee5\u7ed3\u5408local-path-provisioner\u4f7f\u7528\uff0c\u4e0a\u9762bitnami\u53ef\u4ee5\u7b80\u5355\u73a9\u4e00\u4e0b\uff0c\u5c31\u4e0d\u63a8\u8350\u751f\u4ea7\u4e86","title":"\u751f\u4ea7\u73af\u5883\u90e8\u7f72"},{"location":"5.Storage/redis-docs/#_5","text":"1 . Redis\u9ed8\u8ba4\u4e0d\u662f\u4ee5\u5b88\u62a4\u8fdb\u7a0b\u7684\u65b9\u5f0f\u8fd0\u884c\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u914d\u7f6e\u9879\u4fee\u6539\uff0c\u4f7f\u7528yes\u542f\u7528\u5b88\u62a4\u8fdb\u7a0b daemonize yes 2 . \u5f53Redis\u4ee5\u5b88\u62a4\u8fdb\u7a0b\u65b9\u5f0f\u8fd0\u884c\u65f6\uff0cRedis\u9ed8\u8ba4\u4f1a\u628apid\u5199\u5165/var/run/redis.pid\u6587\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7pidfile\u6307\u5b9a pidfile /var/run/redis_6379.pid 3 . \u6307\u5b9aRedis\u76d1\u542c\u7aef\u53e3\uff0c\u9ed8\u8ba4\u7aef\u53e3\u4e3a6379 port 6379 4 . \u7ed1\u5b9a\u7684\u4e3b\u673a\u5730\u5740 bind 0 .0.0.0 5 .\u5f53\u5ba2\u6237\u7aef\u95f2\u7f6e\u591a\u957f\u65f6\u95f4\u540e\u5173\u95ed\u8fde\u63a5\uff0c\u5982\u679c\u6307\u5b9a\u4e3a0\uff0c\u8868\u793a\u5173\u95ed\u8be5\u529f\u80fd timeout 300 6 . \u6307\u5b9a\u65e5\u5fd7\u8bb0\u5f55\u7ea7\u522b\uff0cRedis\u603b\u5171\u652f\u6301\u56db\u4e2a\u7ea7\u522b\uff1adebug\u3001verbose\u3001notice\u3001warning\uff0c\u9ed8\u8ba4\u4e3averbose loglevel verbose 7 . \u65e5\u5fd7\u8bb0\u5f55\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u4e3a\u6807\u51c6\u8f93\u51fa\uff0c\u5982\u679c\u914d\u7f6eRedis\u4e3a\u5b88\u62a4\u8fdb\u7a0b\u65b9\u5f0f\u8fd0\u884c\uff0c\u800c\u8fd9\u91cc\u53c8\u914d\u7f6e\u4e3a\u65e5\u5fd7\u8bb0\u5f55\u65b9\u5f0f\u4e3a\u6807\u51c6\u8f93\u51fa\uff0c\u5219\u65e5\u5fd7\u5c06\u4f1a\u53d1\u9001\u7ed9/dev/null logfile /var/log/redis_6379.log 8 . \u8bbe\u7f6e\u6570\u636e\u5e93\u7684\u6570\u91cf\uff0c\u9ed8\u8ba4\u6570\u636e\u5e93\u4e3a0\uff0c\u53ef\u4ee5\u4f7f\u7528SELECT <dbid>\u547d\u4ee4\u5728\u8fde\u63a5\u4e0a\u6307\u5b9a\u6570\u636e\u5e93id databases 16 9 . \u6307\u5b9a\u5728\u591a\u957f\u65f6\u95f4\u5185\uff0c\u6709\u591a\u5c11\u6b21\u66f4\u65b0\u64cd\u4f5c\uff0c\u5c31\u5c06\u6570\u636e\u540c\u6b65\u5230\u6570\u636e\u6587\u4ef6\uff0c\u53ef\u4ee5\u591a\u4e2a\u6761\u4ef6\u914d\u5408 save <seconds> <changes> Redis\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e2d\u63d0\u4f9b\u4e86\u4e09\u4e2a\u6761\u4ef6\uff1a save 900 1 save 300 10 save 60 10000 \u5206\u522b\u8868\u793a900\u79d2\uff0815\u5206\u949f\uff09\u5185\u67091\u4e2a\u66f4\u6539\uff0c300\u79d2\uff085\u5206\u949f\uff09\u5185\u670910\u4e2a\u66f4\u6539\u4ee5\u53ca60\u79d2\u5185\u670910000\u4e2a\u66f4\u6539\u3002 10 . \u6307\u5b9a\u5b58\u50a8\u81f3\u672c\u5730\u6570\u636e\u5e93\u65f6\u662f\u5426\u538b\u7f29\u6570\u636e\uff0c\u9ed8\u8ba4\u4e3ayes\uff0cRedis\u91c7\u7528LZF\u538b\u7f29\uff0c\u5982\u679c\u4e3a\u4e86\u8282\u7701CPU\u65f6\u95f4\uff0c\u53ef\u4ee5\u5173\u95ed\u8be5\u9009\u9879\uff0c\u4f46\u4f1a\u5bfc\u81f4\u6570\u636e\u5e93\u6587\u4ef6\u53d8\u7684\u5de8\u5927 rdbcompression yes 11 . \u6307\u5b9a\u672c\u5730\u6570\u636e\u5e93\u6587\u4ef6\u540d\uff0c\u9ed8\u8ba4\u503c\u4e3adump.rdb dbfilename dump.rdb 12 . \u6307\u5b9a\u672c\u5730\u6570\u636e\u5e93\u5b58\u653e\u76ee\u5f55 dir /var/lib/redis/6379 13 . \u8bbe\u7f6e\u5f53\u672c\u673a\u4e3aslave\u670d\u52a1\u65f6\uff0c\u8bbe\u7f6emaster\u670d\u52a1\u7684IP\u5730\u5740\u53ca\u7aef\u53e3\uff0c\u5728Redis\u542f\u52a8\u65f6\uff0c\u5b83\u4f1a\u81ea\u52a8\u4ecemaster\u8fdb\u884c\u6570\u636e\u540c\u6b65 slaveof <masterip> <masterport> 14 . \u5f53master\u670d\u52a1\u8bbe\u7f6e\u4e86\u5bc6\u7801\u4fdd\u62a4\u65f6\uff0cslave\u670d\u52a1\u8fde\u63a5master\u7684\u5bc6\u7801 masterauth <master-password> 15 . \u8bbe\u7f6eRedis\u8fde\u63a5\u5bc6\u7801\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u8fde\u63a5\u5bc6\u7801\uff0c\u5ba2\u6237\u7aef\u5728\u8fde\u63a5Redis\u65f6\u9700\u8981\u901a\u8fc7AUTH <password>\u547d\u4ee4\u63d0\u4f9b\u5bc6\u7801\uff0c\u9ed8\u8ba4\u5173\u95ed requirepass foobared 16 . \u8bbe\u7f6e\u540c\u4e00\u65f6\u95f4\u6700\u5927\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\uff0c\u9ed8\u8ba4\u65e0\u9650\u5236\uff0cRedis\u53ef\u4ee5\u540c\u65f6\u6253\u5f00\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\u4e3aRedis\u8fdb\u7a0b\u53ef\u4ee5\u6253\u5f00\u7684\u6700\u5927\u6587\u4ef6\u63cf\u8ff0\u7b26\u6570\uff0c\u5982\u679c\u8bbe\u7f6e maxclients 0 \uff0c\u8868\u793a\u4e0d\u4f5c\u9650\u5236\u3002\u5f53\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\u5230\u8fbe\u9650\u5236\u65f6\uff0cRedis\u4f1a\u5173\u95ed\u65b0\u7684\u8fde\u63a5\u5e76\u5411\u5ba2\u6237\u7aef\u8fd4\u56demax number of clients reached\u9519\u8bef\u4fe1\u606f maxclients 128 17 . \u6307\u5b9aRedis\u6700\u5927\u5185\u5b58\u9650\u5236\uff0cRedis\u5728\u542f\u52a8\u65f6\u4f1a\u628a\u6570\u636e\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\uff0c\u8fbe\u5230\u6700\u5927\u5185\u5b58\u540e\uff0cRedis\u4f1a\u5148\u5c1d\u8bd5\u6e05\u9664\u5df2\u5230\u671f\u6216\u5373\u5c06\u5230\u671f\u7684Key\uff0c\u5f53\u6b64\u65b9\u6cd5\u5904\u7406 \u540e\uff0c\u4ecd\u7136\u5230\u8fbe\u6700\u5927\u5185\u5b58\u8bbe\u7f6e\uff0c\u5c06\u65e0\u6cd5\u518d\u8fdb\u884c\u5199\u5165\u64cd\u4f5c\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u8fdb\u884c\u8bfb\u53d6\u64cd\u4f5c\u3002Redis\u65b0\u7684vm\u673a\u5236\uff0c\u4f1a\u628aKey\u5b58\u653e\u5185\u5b58\uff0cValue\u4f1a\u5b58\u653e\u5728swap\u533a maxmemory <bytes> 18 . \u6307\u5b9a\u662f\u5426\u5728\u6bcf\u6b21\u66f4\u65b0\u64cd\u4f5c\u540e\u8fdb\u884c\u65e5\u5fd7\u8bb0\u5f55\uff0cRedis\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u5f02\u6b65\u7684\u628a\u6570\u636e\u5199\u5165\u78c1\u76d8\uff0c\u5982\u679c\u4e0d\u5f00\u542f\uff0c\u53ef\u80fd\u4f1a\u5728\u65ad\u7535\u65f6\u5bfc\u81f4\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6570\u636e\u4e22\u5931\u3002\u56e0\u4e3a redis\u672c\u8eab\u540c\u6b65\u6570\u636e\u6587\u4ef6\u662f\u6309\u4e0a\u9762save\u6761\u4ef6\u6765\u540c\u6b65\u7684\uff0c\u6240\u4ee5\u6709\u7684\u6570\u636e\u4f1a\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\u53ea\u5b58\u5728\u4e8e\u5185\u5b58\u4e2d\u3002\u9ed8\u8ba4\u4e3ano appendonly yes 19 . \u6307\u5b9a\u66f4\u65b0\u65e5\u5fd7\u6587\u4ef6\u540d\uff0c\u9ed8\u8ba4\u4e3aappendonly.aof appendfilename appendonly.aof 20 . \u6307\u5b9a\u66f4\u65b0\u65e5\u5fd7\u6761\u4ef6\uff0c\u5171\u67093\u4e2a\u53ef\u9009\u503c\uff1a no\uff1a\u8868\u793a\u7b49\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u884c\u6570\u636e\u7f13\u5b58\u540c\u6b65\u5230\u78c1\u76d8\uff08\u5feb\uff09 always\uff1a\u8868\u793a\u6bcf\u6b21\u66f4\u65b0\u64cd\u4f5c\u540e\u624b\u52a8\u8c03\u7528fsync () \u5c06\u6570\u636e\u5199\u5230\u78c1\u76d8\uff08\u6162\uff0c\u5b89\u5168\uff09 everysec\uff1a\u8868\u793a\u6bcf\u79d2\u540c\u6b65\u4e00\u6b21\uff08\u6298\u8877\uff0c\u9ed8\u8ba4\u503c\uff09 appendfsync everysec 21 . \u6307\u5b9a\u662f\u5426\u542f\u7528\u865a\u62df\u5185\u5b58\u673a\u5236\uff0c\u9ed8\u8ba4\u503c\u4e3ano\uff0c\u7b80\u5355\u7684\u4ecb\u7ecd\u4e00\u4e0b\uff0cVM\u673a\u5236\u5c06\u6570\u636e\u5206\u9875\u5b58\u653e\uff0c\u7531Redis\u5c06\u8bbf\u95ee\u91cf\u8f83\u5c11\u7684\u9875\u5373\u51b7\u6570\u636eswap\u5230\u78c1\u76d8\u4e0a\uff0c\u8bbf\u95ee\u591a\u7684\u9875\u9762\u7531\u78c1\u76d8\u81ea\u52a8\u6362\u51fa\u5230\u5185\u5b58\u4e2d\uff08\u5728\u540e\u9762\u7684\u6587\u7ae0\u6211\u4f1a\u4ed4\u7ec6\u5206\u6790Redis\u7684VM\u673a\u5236\uff09 vm-enabled no 22 . \u865a\u62df\u5185\u5b58\u6587\u4ef6\u8def\u5f84\uff0c\u9ed8\u8ba4\u503c\u4e3a/tmp/redis.swap\uff0c\u4e0d\u53ef\u591a\u4e2aRedis\u5b9e\u4f8b\u5171\u4eab vm-swap-file /tmp/redis.swap 23 . \u5c06\u6240\u6709\u5927\u4e8evm-max-memory\u7684\u6570\u636e\u5b58\u5165\u865a\u62df\u5185\u5b58,\u65e0\u8bbavm-max-memory\u8bbe\u7f6e\u591a\u5c0f,\u6240\u6709\u7d22\u5f15\u6570\u636e\u90fd\u662f\u5185\u5b58\u5b58\u50a8\u7684 ( Redis\u7684\u7d22\u5f15\u6570\u636e \u5c31\u662fkeys ) ,\u4e5f\u5c31\u662f\u8bf4,\u5f53vm-max-memory\u8bbe\u7f6e\u4e3a0\u7684\u65f6\u5019,\u5176\u5b9e\u662f\u6240\u6709value\u90fd\u5b58\u5728\u4e8e\u78c1\u76d8\u3002\u9ed8\u8ba4\u503c\u4e3a0 vm-max-memory 0 24 . Redis swap\u6587\u4ef6\u5206\u6210\u4e86\u5f88\u591a\u7684page\uff0c\u4e00\u4e2a\u5bf9\u8c61\u53ef\u4ee5\u4fdd\u5b58\u5728\u591a\u4e2apage\u4e0a\u9762\uff0c\u4f46\u4e00\u4e2apage\u4e0a\u4e0d\u80fd\u88ab\u591a\u4e2a\u5bf9\u8c61\u5171\u4eab\uff0cvm-page-size\u662f\u8981\u6839\u636e\u5b58\u50a8\u7684 \u6570\u636e\u5927\u5c0f\u6765\u8bbe\u5b9a\u7684\uff0c\u4f5c\u8005\u5efa\u8bae\u5982\u679c\u5b58\u50a8\u5f88\u591a\u5c0f\u5bf9\u8c61\uff0cpage\u5927\u5c0f\u6700\u597d\u8bbe\u7f6e\u4e3a32\u6216\u800564bytes\uff1b\u5982\u679c\u5b58\u50a8\u5f88\u5927\u5927\u5bf9\u8c61\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u66f4\u5927\u7684page\uff0c\u5982\u679c\u4e0d \u786e\u5b9a\uff0c\u5c31\u4f7f\u7528\u9ed8\u8ba4\u503c vm-page-size 32 25 . \u8bbe\u7f6eswap\u6587\u4ef6\u4e2d\u7684page\u6570\u91cf\uff0c\u7531\u4e8e\u9875\u8868\uff08\u4e00\u79cd\u8868\u793a\u9875\u9762\u7a7a\u95f2\u6216\u4f7f\u7528\u7684bitmap\uff09\u662f\u5728\u653e\u5728\u5185\u5b58\u4e2d\u7684\uff0c\uff0c\u5728\u78c1\u76d8\u4e0a\u6bcf8\u4e2apages\u5c06\u6d88\u80171byte\u7684\u5185\u5b58\u3002 vm-pages 134217728 26 . \u8bbe\u7f6e\u8bbf\u95eeswap\u6587\u4ef6\u7684\u7ebf\u7a0b\u6570,\u6700\u597d\u4e0d\u8981\u8d85\u8fc7\u673a\u5668\u7684\u6838\u6570,\u5982\u679c\u8bbe\u7f6e\u4e3a0,\u90a3\u4e48\u6240\u6709\u5bf9swap\u6587\u4ef6\u7684\u64cd\u4f5c\u90fd\u662f\u4e32\u884c\u7684\uff0c\u53ef\u80fd\u4f1a\u9020\u6210\u6bd4\u8f83\u957f\u65f6\u95f4\u7684\u5ef6\u8fdf\u3002\u9ed8\u8ba4\u503c\u4e3a4 vm-max-threads 4 27 . \u8bbe\u7f6e\u5728\u5411\u5ba2\u6237\u7aef\u5e94\u7b54\u65f6\uff0c\u662f\u5426\u628a\u8f83\u5c0f\u7684\u5305\u5408\u5e76\u4e3a\u4e00\u4e2a\u5305\u53d1\u9001\uff0c\u9ed8\u8ba4\u4e3a\u5f00\u542f glueoutputbuf yes 28 . \u6307\u5b9a\u5728\u8d85\u8fc7\u4e00\u5b9a\u7684\u6570\u91cf\u6216\u8005\u6700\u5927\u7684\u5143\u7d20\u8d85\u8fc7\u67d0\u4e00\u4e34\u754c\u503c\u65f6\uff0c\u91c7\u7528\u4e00\u79cd\u7279\u6b8a\u7684\u54c8\u5e0c\u7b97\u6cd5 hash-max-zipmap-entries 64 hash-max-zipmap-value 512 29 . \u6307\u5b9a\u662f\u5426\u6fc0\u6d3b\u91cd\u7f6e\u54c8\u5e0c\uff0c\u9ed8\u8ba4\u4e3a\u5f00\u542f\uff08\u540e\u9762\u5728\u4ecb\u7ecdRedis\u7684\u54c8\u5e0c\u7b97\u6cd5\u65f6\u5177\u4f53\u4ecb\u7ecd\uff09 activerehashing yes 30 . \u6307\u5b9a\u5305\u542b\u5176\u5b83\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u5728\u540c\u4e00\u4e3b\u673a\u4e0a\u591a\u4e2aRedis\u5b9e\u4f8b\u4e4b\u95f4\u4f7f\u7528\u540c\u4e00\u4efd\u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u540c\u65f6\u5404\u4e2a\u5b9e\u4f8b\u53c8\u62e5\u6709\u81ea\u5df1\u7684\u7279\u5b9a\u914d\u7f6e\u6587\u4ef6 include /path/to/local.conf \u5f53\u7136\u4ee5\u4e0a\u7684\u914d\u7f6e\u53c2\u6570\u4e0d\u9700\u8981\u90fd\u4e86\u89e3\uff0c\u770b\u60c5\u51b5\u9700\u8981\u4ec0\u4e48\u914d\u7f6e\u4ec0\u4e48\u5373\u53ef\u3002\u6211\u4eec\u4e4b\u540e\u4f7f\u7528helm\u90e8\u7f72\u5927\u90e8\u5206\u7684\u53c2\u6570\u4e5f\u5df2\u7ecf\u90fd\u6709\u4e86\u3002redis\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684\u5c31\u662f\u4ed6\u7684\u6301\u4e45\u5316\u3002\u540e\u7eed\u4f1a\u5217\u4e00\u4e0b\u4ed6\u6301\u4e45\u5316\u7684\u7684\u65b9\u5f0f\u3002","title":"\u914d\u7f6e\u6587\u4ef6\u4ecb\u7ecd"},{"location":"5.Storage/redis-docs/#redis-cli","text":"redis-cli -h \u8fdc\u7a0b\u8fde\u63a5\u4e3b\u673a -p \u6307\u5b9a\u7aef\u53e3 -a \u6307\u5b9a\u5bc6\u7801 \u6ce8\uff1a\u82e5\u672a\u8bbe\u7f6e\u6570\u636e\u5e93\u5bc6\u7801 -a\u9009\u9879\u53ef\u4ee5\u5ffd\u7565 \u9000\u51fa\u6570\u636e\u5e93\u64cd\u4f5c\u73af\u5883\u53ef\u4ee5\u6267\u884c quit \u6216 exit \u5c31\u53ef\u4ee5\u8fd4\u56de\u5230\u539f\u6765\u7684shell\u6587\u4ef6 [root@localhost ~]# redis-cli 127.0.0.1:6379> ping PONG # \u6267\u884cping\u547d\u4ee4\u53ef\u4ee5\u68c0\u6d4bRedis\u670d\u52a1\u662f\u5426\u542f\u52a8","title":"redis-cli \u7528\u6cd5"},{"location":"5.Storage/redis-docs/#redis-benchmark","text":"Redis-benchmark\u662fredis\u5b98\u65b9\u81ea\u5e26\u7684redis\u6027\u80fd\u6d4b\u8bd5\u5de5\u5177\uff0c\u53ef\u4ee5\u6709\u6548\u7684\u6d4b\u8bd5redis\u670d\u52a1\u7684\u6027\u80fd\u3002 \u8bed\u6cd5\uff1a redis-benchmark [option] [option value] \u53c2\u6570\uff1a -h\uff1a\u6307\u5b9a\u670d\u52a1\u5668\u540d -p\uff1a\u6307\u5b9a\u670d\u52a1\u5668\u7aef\u53e3 -s\uff1a\u6307\u5b9a\u670d\u52a1\u5668socket -c\uff1a\u6307\u5b9a\u5e76\u53d1\u8fde\u63a5\u6570 -n\uff1a\u6307\u5b9a\u8bf7\u6c42\u8fde\u63a5\u6570 -d\uff1a\u4ee5\u5b57\u8282\uff08B\uff09\u7684\u5f62\u5f0f\u6307\u5b9a SET/GET\u503c\u7684\u6570\u636e\u5927\u5c0f -k\uff1a1=keep alive 0=reconnect -r:SET/GET/INCR \u4f7f\u7528\u968f\u673akey\uff0cSADD\u4f7f\u7528\u7684\u968f\u673a\u503c -P\uff1a\u901a\u8fc7\u7ba1\u9053\u4f20\u8f93<numreq>\u8bf7\u6c42 -q\uff1a\u5f3a\u5236\u9000\u51fa redis\u3002\u4ec5\u663e\u793a query/sec\u503c --csv :\u4ee5CSV\u683c\u5f0f\u8f93\u51fa -l \uff1a \u751f\u6210\u5faa\u73af\uff0c\u6c38\u4e45\u6267\u884c\u6d4b\u8bd5 -t \uff1a \u4ec5\u8fd0\u884c\u4ee5\u9017\u53f7\u5206\u9694\u7684\u6d4b\u8bd5\u547d\u4ee4\u5217\u8868 -I :idle\u6a21\u5f0f\u3002\u4ec5\u6253\u5f00/v\u4e2aidle\u8fde\u63a5\u5e76\u7b49\u5f85","title":"redis-benchmark\u6d4b\u8bd5\u5de5\u5177"},{"location":"5.Storage/redis-docs/#redis-benchmark_1","text":"\u6d4b\u8bd5\u5e76\u53d1\u6570\u4e3a10\u8bf7\u6c42\u8fde\u63a5\u6570\u4e3a100000\u4e2a\u8bf7\u6c42\u7684\u6027\u80fd [root@localhost redis]# redis-benchmark -h localhost -p 6379 -c 10 -n 100000 Summary: throughput summary: 2584.25 requests per second latency summary (msec): avg min p50 p95 p99 max 3.378 0.448 2.719 7.159 16.607 389.375 \u6d4b\u8bd5\u5b58\u53d6\u5927\u5c0f\u4e3a100B\u7684\u6570\u636e\u5305\u65f6redis\u7684\u6027\u80fd [root@localhost ~]# redis-benchmark -h localhost -p 6379 -q -d 100 PING_INLINE: 9354.54 requests per second, p50=2.543 msec PING_MBULK: 9018.76 requests per second, p50=2.567 msec SET: 6365.78 requests per second, p50=5.183 msec GET: 8983.11 requests per second, p50=2.639 msec INCR: 6784.26 requests per second, p50=4.711 msec LPUSH: 6266.84 requests per second, p50=5.511 msec RPUSH: 6391.41 requests per second, p50=5.359 msec LPOP: 6735.37 requests per second, p50=4.911 msec RPOP: 7187.01 requests per second, p50=4.935 msec SADD: 9295.41 requests per second, p50=2.551 msec HSET: 6427.15 requests per second, p50=5.359 msec SPOP: 9106.64 requests per second, p50=2.527 msec ZADD: 8525.88 requests per second, p50=2.663 msec ZPOPMIN: 8797.40 requests per second, p50=2.559 msec LPUSH (needed to benchmark LRANGE): 6059.87 requests per second, p50=5.615 msec LRANGE_100 (first 100 elements): 4113.20 requests per second, p50=5.695 msec LRANGE_300 (first 300 elements): 1667.83 requests per second, p50=13.879 msec LRANGE_500 (first 500 elements): 1051.38 requests per second, p50=15.783 msec LRANGE_600 (first 600 elements): 951.19 requests per second, p50=18.767 msec MSET (10 keys): 3831.71 requests per second, p50=9.711 msec \u53c2\u6570\u8bf4\u660e\uff1a \u4f60\u8fd0\u884c\u7684\u662f Redis \u7684\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u4e86\u5404\u79cd\u5e38\u89c1\u7684 Redis \u64cd\u4f5c\u7684\u6027\u80fd\u3002\u4ee5\u4e0b\u662f\u5bf9\u8fd9\u4e9b\u7ed3\u679c\u7684\u89e3\u8bfb\uff1a - `PING_INLINE` \u548c `PING_MBULK` \u662f\u68c0\u6d4b Redis \u670d\u52a1\u5668\u662f\u5426\u5728\u7ebf\u7684\u64cd\u4f5c\u3002\u5728\u8fd9\u6b21\u6d4b\u8bd5\u4e2d\uff0c\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 9354.54 \u548c 9018.76 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 2.543 \u548c 2.567 \u6beb\u79d2\u3002 - `SET`\u3001`GET` \u548c `INCR` \u662f\u5e38\u89c1\u7684\u952e\u503c\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 6365.78\u30018983.11 \u548c 6784.26 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 5.183\u30012.639 \u548c 4.711 \u6beb\u79d2\u3002 - `LPUSH`\u3001`RPUSH`\u3001`LPOP` \u548c `RPOP` \u662f\u5217\u8868\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 6266.84\u30016391.41\u30016735.37 \u548c 7187.01 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 5.511\u30015.359\u30014.911 \u548c 4.935 \u6beb\u79d2\u3002 - `SADD`\u3001`HSET` \u548c `SPOP` \u662f\u96c6\u5408\u548c\u54c8\u5e0c\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 9295.41\u30016427.15 \u548c 9106.64 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 2.551\u30015.359 \u548c 2.527 \u6beb\u79d2\u3002 - `ZADD` \u548c `ZPOPMIN` \u662f\u6709\u5e8f\u96c6\u5408\u64cd\u4f5c\u3002\u5b83\u4eec\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 8525.88 \u548c 8797.40 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 2.663 \u548c 2.559 \u6beb\u79d2\u3002 - `LRANGE` \u662f\u83b7\u53d6\u5217\u8868\u7684\u4e00\u90e8\u5206\u7684\u64cd\u4f5c\u3002\u8fd9\u4e2a\u64cd\u4f5c\u7684\u6027\u80fd\u53d6\u51b3\u4e8e\u4f60\u83b7\u53d6\u7684\u5143\u7d20\u6570\u91cf\u3002\u5728\u8fd9\u6b21\u6d4b\u8bd5\u4e2d\uff0c\u83b7\u53d6\u524d 100\u3001300\u3001500 \u548c 600 \u4e2a\u5143\u7d20\u7684\u541e\u5410\u91cf\u5206\u522b\u662f 4113.20\u30011667.83\u30011051.38 \u548c 951.19 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u5206\u522b\u662f 5.695\u300113.879\u300115.783 \u548c 18.767 \u6beb\u79d2\u3002 - `MSET` \u662f\u4e00\u6b21\u8bbe\u7f6e\u591a\u4e2a\u952e\u503c\u7684\u64cd\u4f5c\u3002\u5728\u8fd9\u6b21\u6d4b\u8bd5\u4e2d\uff0c\u8bbe\u7f6e 10 \u4e2a\u952e\u503c\u7684\u541e\u5410\u91cf\u662f 3831.71 \u8bf7\u6c42/\u79d2\uff0cp50 \u5ef6\u8fdf\u662f 9.711 \u6beb\u79d2\u3002 \u8fd9\u4e9b\u7ed3\u679c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u4e86\u89e3\u5728\u4f60\u7684\u786c\u4ef6\u548c\u914d\u7f6e\u4e0b\uff0cRedis \u5bf9\u4e8e\u5404\u79cd\u64cd\u4f5c\u7684\u6027\u80fd\u8868\u73b0\u3002\u5982\u679c\u4f60\u53d1\u73b0\u67d0\u4e9b\u64cd\u4f5c\u7684\u6027\u80fd\u4e0d\u4f73\uff0c\u4f60\u53ef\u4ee5\u5c1d\u8bd5\u8c03\u6574 Redis \u7684\u914d\u7f6e\u6216\u5347\u7ea7\u4f60\u7684\u786c\u4ef6\u6765\u6539\u5584\u6027\u80fd\u3002 \u6d4b\u8bd5\u6267\u884cset,lpush \u64cd\u4f5c\u65f6\u7684\u6027\u80fd [root@localhost ~]# redis-benchmark -h localhost -p 6379 -t set,lpush -n 100000 -q","title":"Redis-benchmark\u5e94\u7528\u5b9e\u4f8b"},{"location":"5.Storage/redis-docs/#redis_3","text":"Redis\u6570\u636e\u5e93\u91c7\u7528key-values\uff08\u952e\u503c\u5bf9\uff09\u7684\u6570\u636e\u5b58\u50a8\u5f62\u5f0f\uff0c\u6240\u4f7f\u7528\u7684\u547d\u4ee4\u662fset\u4e0eget\u547d\u4ee4\u3002 set\uff1a\u7528\u4e8eredis\u6570\u636e\u5e93\u4e2d\u5b58\u653e\u6570\u636e \u547d\u4ee4\u683c\u5f0f\u4e3a set key value get: \u7528\u4e8eredis\u6570\u636e\u5e93\u4e2d\u83b7\u53d6\u6570\u636e \u547d\u4ee4\u683c\u5f0f\u4e3a get key [root@localhost ~]# redis-cli 127.0.0.1:6379> ping # \u6d4b\u8bd5redis\u670d\u52a1\u662f\u5426\u542f\u52a8 PONG 127.0.0.1:6379> info # \u67e5\u770b\u8be6\u7ec6\u4fe1\u606f # Server redis_version:4.0.10 \u2026\u2026#\u7701\u7565\u90e8\u5206\u4fe1\u606f # CPU used_cpu_sys:232.48 # Cluster cluster_enabled:0 # Keyspace db0:keys=4,expires=0,avg_ttl=0 \u5185\u5b58\u4f7f\u7528\u91cf > INFO memory used_memory: 19167628056 used_memory_human: 17.85G used_memory_rss: 20684886016 used_memory_rss_human: 19.26G ... used_memory_overhead: 5727954464 ... used_memory_dataset: 13439673592 used_memory_dataset_perc: 70.12% \u5176\u4e2d used_memory_rss \u662f Redis \u5b9e\u9645\u4f7f\u7528\u7684\u603b\u5185\u5b58\u5927\u5c0f\uff0c\u8fd9\u91cc\u65e2\u5305\u542b\u4e86\u5b58\u50a8\u5728 Redis \u4e2d\u7684\u6570\u636e\u5927\u5c0f\uff08\u4e5f\u5c31\u662f\u4e0a\u9762\u7684 used_memory_dataset\uff09\uff0c\u4e5f\u5305\u542b\u4e86\u4e00\u4e9b Redis \u7684\u7cfb\u7edf\u5f00\u9500\uff08\u4e5f\u5c31\u662f\u4e0a\u9762\u7684 used_memory_overhead\uff09\u3002 set\uff0cget\u5e94\u7528\u6848\u4f8b 127.0.0.1:6379> set name zhangsan # \u8bbe\u7f6e\u952e\u503c\u5217\u8868\u4e3aname \u952e\u503c\u4e3azhangsan OK 127.0.0.1:6379> get name # \u83b7\u53d6name\u7684\u952e\u503c \"zhangsan\" key\u76f8\u5173\u547d\u4ee4 \u5728\u4f7f\u7528keys\u547d\u4ee4\u53ef\u4ee5\u53d6\u7b26\u5408\u89c4\u5219\u7684\u952e\u503c\u5217\u8868\uff0c\u901a\u5e38\u60c5\u51b5\u53ef\u4ee5\u7ed3\u5408 \uff0c\uff1f\u7b49\u9009\u9879\u6765\u4f7f\u7528 \uff1f\uff1a\u8868\u793a\u4efb\u610f\u4e00\u4f4d\u6570\u636e \uff1a\u8868\u793a\u4efb\u610f\u6570\u636e 127.0.0.1:6379> set name zhangsan OK 127.0.0.1:6379> get name \"zhangsan\" 127.0.0.1:6379> set k1 1 OK 127.0.0.1:6379> set k2 2 OK 127.0.0.1:6379> set k3 3 OK 127.0.0.1:6379> set s1 4 OK 127.0.0.1:6379> set v55 5 OK \u901a\u8fc7keys\u83b7\u53d6\u952e\u503c\u5217\u8868\u4fe1\u606f 127.0.0.1:6379> keys * 1) \"name\" 2) \"mylist\" 3) \"key3\" 4) \"myhash\" 5) \"key1\" 6) \"key2\" 7) \"key:__rand_int__\" 8) \"key4\" 9) \"counter:__rand_int__\" 127.0.0.1:6379> KEYS key? # \uff1f\u8868\u793ak\u540e\u9762\u7684\u4efb\u610f\u4e00\u4e2a\u5b57\u7b26 \u53ca\u5339\u914d\u4efb\u4f55\u4e00\u4e2a\u4ee5k\u5f00\u5934\u7684\u952e\u5217\u8868\u540e\u9762\u53ea\u6709\u4e00\u4f4d\u7684 1) \"key3\" 2) \"key1\" 3) \"key2\" 4) \"key4\" 127.0.0.1:6379> 127.0.0.1:6379> KEYS key* # * \u4efb\u610f\u53ca\u5339\u914d\u4efb\u4f55\u4e00\u4e2a\u4ee5key\u5f00\u5934\u7684\u952e\u5217\u8868 1) \"key3\" 2) \"key1\" 3) \"key2\" 4) \"key:__rand_int__\" 5) \"key4\" exists\u547d\u4ee4 \u4f5c\u7528\uff1a\u7528\u6765\u5224\u65ad\u952e\u503c\u662f\u5426\u5b58\u5728 127.0.0.1:6379> exists name # \u5224\u65adname\u952e\u662f\u5426\u5b58\u5728 (integer) 1 # \u8fd4\u56de1\u8868\u793a\u5b58\u5728 127.0.0.1:6379> exists name1 (integer) 0 # \u8fd4\u56de0\u8868\u793a\u4e0d\u5b58\u5728 del \u5220\u9664\u547d\u4ee4 127.0.0.1:6379> get name \"zhangsan\" 127.0.0.1:6379> del name (integer) 1 127.0.0.1:6379> get name (nil) Type \u547d\u4ee4 \u4f5c\u7528\uff1a\u4f7f\u7528type\u547d\u4ee4\u53ef\u4ee5\u83b7\u53d6key\u5bf9\u5e94\u7684value\u503c\u7684\u7c7b\u578b 127.0.0.1:6379> type key1 string rename\u547d\u4ee4 (\u5bf9\u5df2\u6709\u7684key\u8fdb\u884c\u91cd\u547d\u540d) \u547d\u4ee4\u683c\u5f0f\uff1arename \u6e90key \u76ee\u6807key \u6e29\u99a8\u63d0\u793a \u6ce8\u610f\uff1a\u4f7f\u7528rename\u547d\u4ee4\u8fdb\u884c\u91cd\u547d\u540d\u65f6\uff0c\u65e0\u8bba\u76ee\u6807key\u662f\u5426\u5b58\u5728\u90fd\u4f1a\u8fdb\u884c\u91cd\u547d\u540d\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u5efa\u8bae\u5148\u4f7f\u7528exists\u67e5\u770b\u76ee\u6807key\u662f\u5426\u5b58\u5728\uff0c\u518d\u51b3\u5b9a\u662f\u5426\u6267\u884crename\u547d\u4ee4\uff0c\u4ee5\u514d\u8986\u76d6\u91cd\u8981\u7684\u6570\u636e\u3002 127.0.0.1:6379> get key1 \"1\" 127.0.0.1:6379> rename key1 name OK 127.0.0.1:6379> get name \"1\" dbsize\u547d\u4ee4(\u4f5c\u7528\uff1a\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u4e2dkey\u7684\u6570\u76ee) 127.0.0.1:6379> keys * 1) \"name\" 2) \"mylist\" 3) \"key3\" 4) \"myhash\" 5) \"key2\" 6) \"key:__rand_int__\" 7) \"key4\" 8) \"counter:__rand_int__\" 127.0.0.1:6379> dbsize (integer) 8","title":"Redis\u6570\u636e\u5e93\u5e38\u7528\u547d\u4ee4"},{"location":"5.Storage/redis-docs/#_6","text":"\u591a\u6570\u636e\u5e93\u4e4b\u95f4\u5207\u6362 Redis\u652f\u6301\u591a\u6570\u636e\u5e93\uff0credis\u5728\u9ed8\u8ba4\u6ca1\u6709\u4efb\u4f55\u6539\u52a8\u7684\u60c5\u51b5\u4e0b\u5305\u542b16\u4e2a\u6570\u636e\u5e93\uff0c\u6570\u636e\u5e93\u7684\u540d\u79f0\u662f\u4f7f\u7528\u6570\u503c0~15\u6765\u4f9d\u6b21\u547d\u540d\u7684\uff0c\u800c\u6211\u4eec\u901a\u8fc7redis-cli\u6253\u5f00\u7684\u662f\u9ed8\u8ba4\u7684\u7b2c\u4e00\u4e2a\u5e93\u5176\u663e\u793a\u4e3a\u201c \u201d\u7684\u5f62\u5f0f,\u901a\u8fc7select\u547d\u4ee4\u8fdb\u884c\u5207\u6362\u540e \u5176\u683c\u5f0f\u4f1a\u53d8\u4e3a \u201c \u201d\u3002 n \u8868\u793aselect\u540e\u9762\u7684\u6570\u5b57 127.0.0.1:6379> select 5 OK 127.0.0.1:6379[5]> select 15 OK 127.0.0.1:6379[15]> select 16 # \u5207\u6362\u4e3a16\u65f6\u62a5\u9519 (error) ERR DB index is out of range # \u8d85\u51fa\u8303\u56f4 127.0.0.1:6379[15]> select 0 OK","title":"\u591a\u6570\u636e\u5e93\u5e38\u7528\u547d\u4ee4"},{"location":"5.Storage/redis-docs/#_7","text":"Redis\u6e05\u9664\u6570\u636e\u5e93\u4e00\u822c\u5206\u4e3a\u4e24\u90e8\u5206 \u6e05\u9664\u5f53\u524d\u6570\u636e\u5e93\uff1aflushdb \u6e05\u9664\u6240\u6709\u6570\u636e\u5e93\u6587\u4ef6\uff1aflushall 127.0.0.1:6379> select 1 OK 127.0.0.1:6379[1]> flushdb OK 127.0.0.1:6379[1]> keys * (empty list or set) 127.0.0.1:6379[1]> select 0 OK 127.0.0.1:6379> keys * 1) \"counter:__rand_int__\" 2) \"key:__rand_int__\" 3) \"k1\" 4) \"myset:__rand_int__\" 5) \"mylist\" 127.0.0.1:6379> select 1 OK 127.0.0.1:6379[1]> flushall OK 127.0.0.1:6379[1]> select 0 OK 127.0.0.1:6379> keys * (empty list or set) \u6d4b\u8bd5\u8fde\u63a5: $ kubectl run --namespace redis-ha redis-client --restart='Never' --env REDIS_PASSWORD=$REDIS_PASSWORD --image docker.io/bitnami/redis:7.2.0-debian-11-r3 --command -- sleep infinity $ k exec -it redis-client -- /bin/bash I have no name!@redis-client:/$ redis-cli -h redis-redis-ha-haproxy.redis-ha I have no name!@redis-client:/$ redis-cli -h redis-redis-ha-haproxy.redis-ha info replication | grep role","title":"\u6e05\u9664\u6570\u636e\u5e93"},{"location":"5.Storage/redis-docs/#_8","text":"https://github.com/DandyDeveloper/charts/tree/master/charts/redis-ha","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"5.Storage/rook-ceph-update/","text":"rook-ceph \u7248\u672c\u5347\u7ea7 \u00b6 https://blog.51cto.com/foxhound/2553979","title":"rook-ceph \u7248\u672c\u5347\u7ea7"},{"location":"5.Storage/rook-ceph-update/#rook-ceph","text":"https://blog.51cto.com/foxhound/2553979","title":"rook-ceph \u7248\u672c\u5347\u7ea7"},{"location":"5.Storage/rook-ceph/","text":"rook-ceph\u7b80\u4ecb \u00b6 \u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u652f\u6301\u5bf9\u8c61\u5b58\u50a8\uff0c\u5757\u8bbe\u5907\uff0c\u6587\u4ef6\u7cfb\u7edf \u5757\u5b58\u50a8 CephFs \u5bf9\u8c61\u5b58\u50a8 ceph \u7684\u7248\u672c\u5386\u53f2 \u00b6 x.0.z - \u5f00\u53d1\u7248 x.1.z - \u5019\u9009\u7248 x.2.z - \u7a33\u5b9a\uff0c\u4fee\u6b63\u7248 ceph\u96c6\u7fa4\u89d2\u8272\u5b9a\u4e49 \u00b6 \u6ce8\u610f ceph\u96c6\u7fa4\u7684osd\u8282\u70b9\u4e00\u822c\u4fdd\u8bc1>=3\u4e2a\uff0c\u6765\u4fdd\u8bc1\u6570\u636e\u7684\u9ad8\u53ef\u7528\u6027\u3002 mon : ceph \u76d1\u89c6\u5668,\u5728\u4e00\u4e2a\u4e3b\u673a\u4e0a\u8fd0\u884c\u7684\u4e00\u4e2a\u5b88\u62a4\u8fdb\u7a0b\uff0c\u7528\u4e8e\u7ef4\u62a4\u96c6\u7fa4\u72b6\u6001\u6620\u5c04\u5173\u7cfb mgr : \u8d1f\u8d23\u8ddf\u8e2a\u8fd0\u884c\u65f6\u6307\u6807\u548cceph\u96c6\u7fa4\u7684\u5f53\u524d\u72b6\u6001 osd : \u78c1\u76d8\uff08\u771f\u6b63\u5b58\u50a8\u6570\u636e\u7684\u5730\u65b9\uff09 ceph \u9762\u8bd5\u9898 ceph rook-ceph\u90e8\u7f72 \u00b6 \u73af\u5883\u8981\u6c42 \u4e00\u4e2ak8s\u96c6\u7fa4\uff0cnode\u8282\u70b9\u6700\u5c11\u4e09\u4e2a\u8282\u70b9 mon: 8C 8G/200G 16C 16g/32-200G \u666e\u901a\u6d4b\u8bd5\u90e8\u7f72\uff1a \u00b6 \u90e8\u7f72crds\uff0ccommon\uff0coperator \u00b6 [ucloud] root@master0:~# git clone --single-branch --branch v1.5.5 https://github.com/rook/rook.git cd rook/cluster/examples/kubernetes/ceph kubectl create -f crds.yaml -f common.yaml -f operator.yaml kubectl create -f cluster.yaml \u955c\u50cf\u5217\u8868\uff1a \u00b6 # ROOK_CSI_CEPH_IMAGE: \"quay.io/cephcsi/cephcsi:v3.4.0\" # ROOK_CSI_REGISTRAR_IMAGE: \"k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.3.0\" # ROOK_CSI_RESIZER_IMAGE: \"k8s.gcr.io/sig-storage/csi-resizer:v1.3.0\" # ROOK_CSI_PROVISIONER_IMAGE: \"k8s.gcr.io/sig-storage/csi-provisioner:v3.0.0\" # ROOK_CSI_SNAPSHOTTER_IMAGE: \"k8s.gcr.io/sig-storage/csi-snapshotter:v4.2.0\" # ROOK_CSI_ATTACHER_IMAGE: \"k8s.gcr.io/sig-storage/csi-attacher:v3.3.0\" CSI\u83b7\u53d6\u955c\u50cf\u811a\u672c\uff1a \u00b6 [ ucloud ] root@node0:/home/lixie# cat <<EOF>> image-sci.sh #!/bin/bash image_list=' csi-node-driver-registrar:v2.0.1 csi-attacher:v3.0.0 csi-snapshotter:v3.0.0 csi-resizer:v1.0.0 csi-provisioner:v2.0.0 ' aliyuncs=\"registry.aliyuncs.com/it00021hot\" google_gcr=\"k8s.gcr.io/sig-storage\" for image in $image_list do echo $image docker pull ${aliyuncs}/${image} docker tag ${aliyuncs}/${image} ${google_gcr}/${image} docker rm ${aliyuncs}/${image} #echo \"${aliyuncs}/${image} ${google_gcr}/${image} downloaded.\" done EOF \u5b9a\u5236\u5316\u90e8\u7f72\uff1a \u00b6 \u5b9a\u5236mon\u8c03\u5ea6\u53c2\u6570 \u00b6 \u80cc\u666f \u2f63\u4ea7\u73af\u5883\u6709\u2f00\u4e9b\u4e13\u2ed4\u7684\u8282\u70b9\u2f64\u4e8emon\u3001mgr\uff0c\u5b58\u50a8\u8282\u70b9\u8282\u70b9\u4f7f\u2f64\u5355\u72ec\u7684\u8282\u70b9\u627f\u62c5,\u5229\u2f64\u8c03\u5ea6\u673a\u5236\u5b9e \u73b0 placement : mon : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : ceph-mon operator : In values : - enabled #\u8bbe\u7f6e\u78c1\u76d8\u7684\u53c2\u6570\uff0c\u8c03\u6574\u4e3afalse\uff0c\u2f45\u4fbf\u540e\u2faf\u5b9a\u5236 214 useAllNodes : false 215 useAllDevices : false \u5206\u522b\u7ed9\u8282\u70b9\u6253\u4e0a\u6807\u7b7e [ucloud] root@master0:~# kubectl label node node0 ceph-mon=enabled node/node0 labeled [ucloud] root@master0:~# kubectl label node node1 ceph-mon=enabled node/node1 labeled [ucloud] root@master0:~# kubectl label node node2 ceph-mon=enabled node/node2 labeled \u83b7\u53d6\u955c\u50cf\u811a\u672c $ cat image-rook-ceph-sci-v1.7.11.sh #!/bin/bash image_list=' csi-node-driver-registrar:v2.0.1 csi-attacher:v3.0.0 csi-snapshotter:v3.0.0 csi-resizer:v1.0.0 csi-provisioner:v2.0.0 ' aliyuncs=\"registry.aliyuncs.com/it00021hot\" google_gcr=\"k8s.gcr.io/sig-storage\" for image in $image_list do echo $image docker pull ${aliyuncs}/${image} docker tag ${aliyuncs}/${image} ${google_gcr}/${image} #docker rm ${aliyuncs}/${image} #echo \"${aliyuncs}/${image} ${google_gcr}/${image} downloaded.\" done EOF \u5b9a\u5236mgr\u8c03\u5ea6\u53c2\u6570 \u00b6 \u6e29\u99a8\u63d0\u793a \u4fee\u6539mgr\u7684\u8c03\u5ea6\u53c2\u6570,\u4fee\u6539\u5b8c\u4e4b\u540e\u91cd\u65b0apply cluster.yaml\u914d\u7f6e\u4f7f\u5176\u52a0\u8f7d\u5230\u96c6\u7fa4\u4e2d mgr : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : ceph-mgr operator : In values : - enabled \u6b64\u65f6\u8c03\u5ea6\u4f1a\u5931\u8d25\uff0c\u7ed9node-1\u548cnode-2\u6253\u4e0a ceph-mgr=enabled \u7684\u6807\u7b7e $ kubectl label nodes node0 ceph-mgr=enabled node/node0 labeled $ kubectl label nodes node1 ceph-mgr=enabled node/node1 labeled \u5b9a\u5236msd\u8c03\u5ea6\u53c2\u6570 \u00b6 \u8bbe\u7f6eosd\u7684\u8c03\u5ea6\u53c2\u6570 osd : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : ceph-osd operator : In values : - enabled \u5b9a\u5236osd\u7684\u78c1\u76d8\u53c2\u6570 nodes : - name : \"node0\" devices : # specific devices to use for storage can be specified for each node - name : \"vdb\" - name : \"node1\" devices : # specific devices to use for storage can be specified for each node - name : \"vdc\" toolbox\u5ba2\u6237\u7aef \u00b6 apply\u4ee5\u4e0b\u4e2d\u4e24\u4e2a\u6587\u4ef6\u7684\u4e00\u4e2a\u5c31\u53ef\u4ee5\uff0c\u4e00\u822c\u9009\u62e9toolbox.yaml $ ll tool* -rw-r--r-- 1 beiyiwangdejiyi staff 1.7K 7 19 17:26 toolbox-job.yaml # \u4e00\u6b21\u6027\u4efb\u52a1 -rw-r--r-- 1 beiyiwangdejiyi staff 1.4K 7 19 17:26 toolbox.yaml kubectl apply -f toolbox.yaml k8s\u8bbf\u95eeceph \u00b6 centos\u7cfb\u7edf\uff1a 1. \u914d\u7f6eCeph yum\u6e90 \u00b6 [root@node-1 ~]# cat /etc/yum.repos.d/ceph.repo [ceph] name=ceph baseurl=https://mirrors.aliyun.com/ceph/rpm-octopus/el8/x86_64/ enabled=1 gpgcheck=0 2.\u5b89\u88c5ceph-common \u00b6 [root@node-1 ~]# yum -y install ceph-common 3. \u521b\u5efaceph\u914d\u7f6e\u6587\u4ef6 \u00b6 [root@rook-ceph-tools-65c94d77bb-b9b2h /]# cat /etc/ceph/ceph.conf # \u67e5\u770b\u4e4b\u540e\u5bbf\u4e3b\u673a\u521b\u5efa [global] mon_host = 10.43.248.216:6789,10.43.174.200:6789,10.43.9.21:6789 [client.admin] keyring = /etc/ceph/keyring [root@rook-ceph-tools-65c94d77bb-b9b2h /]# cat /etc/ceph/keyring # \u67e5\u770b\u4e4b\u540e\u5bbf\u4e3b\u673a\u521b\u5efa [client.admin] key = AQCRS+NijUeiIxAAhFtv6je2FmMEAVHAJJqPwg== ubuntu\u7cfb\u7edf\uff1a apt install ceph-common \u8bbf\u95eeRBD\u5757\u5b58\u50a8 \u00b6 1.\u521b\u5efa\u4e00\u4e2apool \u00b6 [ root@rook-ceph-tools-65c94d77bb-xg6xs / ] # ceph osd pool create rook 16 16 pool 'rook' created [root@rook-ceph-tools-65c94d77bb-xg6xs /]# ceph osd lspools # \u67e5\u770bpools 1 device_health_metrics 2 replicapool 3 rook 2. \u5728pool\u4e0a\u521b\u5efa\u5757\u8bbe\u5907 \u00b6 [ root@rook-ceph-tools-65c94d77bb-xg6xs / ] # rbd create -p rook --image rook-rbd.img --size 10G [ root@rook-ceph-tools-65c94d77bb-xg6xs / ] # rbd ls -p rook rook-rbd.img [root@rook-ceph-tools-65c94d77bb-xg6xs /]# rbd info rook/rook-rbd.img # \u67e5\u770b\u8be6\u7ec6\u4fe1\u606f rbd image 'rook-rbd.img' : size 10 GiB in 2560 objects order 22 (4 MiB objects) snapshot_count : 0 id : 50a7fcf85890 block_name_prefix : rbd_data.50a7fcf85890 format : 2 features : layering op_features : flags : create_timestamp : Fri Jul 29 05:40:05 2022 access_timestamp : Fri Jul 29 05:40:05 2022 modify_timestamp : Fri Jul 29 05:40:05 2022 3\u3001\u5ba2\u6237\u6302\u8f7dRBD\u5757 \u00b6 [ ucloud ] root@master0:/home/lixie# rbd map rook/rook-rbd.img /dev/rbd0 [ ucloud ] root@master0:/home/lixie# rbd showmapped id pool namespace image snap device 0 rook rook-rbd.img - /dev/rbd0 [ ucloud ] root@master0:/home/lixie# mkfs.xfs /dev/rbd0 meta-data = /dev/rbd1 isize = 512 agcount = 16 , agsize = 163840 blks = sectsz = 512 attr = 2 , projid32bit = 1 = crc = 1 finobt = 1 , sparse = 1 , rmapbt = 0 = reflink = 1 data = bsize = 4096 blocks = 2621440 , imaxpct = 25 = sunit = 16 swidth = 16 blks naming = version 2 bsize = 4096 ascii-ci = 0 , ftype = 1 log = internal log bsize = 4096 blocks = 2560 , version = 2 = sectsz = 512 sunit = 16 blks, lazy-count = 1 realtime = none extsz = 4096 blocks = 0 , rtextents = 0 \u95ee\u9898\u4e00\uff1a\u52a0\u8f7d rbd \u5185\u6838\u6a21\u5757\u5931\u8d25 [root@rook-ceph-tools-65c94d77bb-xg6xs /]# rbd map rook/rook-rbd.img modinfo: ERROR: Module alias rbd not found. modprobe: FATAL: Module rbd not found in directory /lib/modules/5.4.0-48-generic rbd: failed to load rbd kernel module (1) rbd: failed to set udev buffer size: (1) Operation not permitted rbd: sysfs write failed In some cases useful info is found in syslog - try \"dmesg | tail\". rbd: map failed: (2) No such file or directory \u89e3\u51b3\u65b9\u6cd5\uff1a [ucloud] root@node0:/home/lixie# modprobe rbd [ucloud] root@node0:/home/lixie# lsmod |grep rbd rbd 106496 0 libceph 327680 1 rbd \u95ee\u9898\u4e8c\uff1amap rdb [root@rook-ceph-tools-65c94d77bb-b9b2h /]# rbd map rook/rook-rbd.img rbd: failed to set udev buffer size: (1) Operation not permitted rbd: sysfs write failed In some cases useful info is found in syslog - try \"dmesg | tail\". \u89e3\u51b3\u65b9\u6cd5\uff1a \u5728\u5bbf\u4e3b\u673a\u4e0a\u6267\u884c\uff0c\u8be5\u547d\u4ee4\u3002 \u95ee\u9898\u4e09: \u5185\u6838\u6a21\u5757\u4e0d\u652f\u6301\u8fd9\u4e48\u591a\u7684\u7279\u6027 [dev] root@master0:/home/lixie# rbd map rook/rook-rbd1.img rbd: sysfs write failed RBD image feature set mismatch. You can disable features unsupported by the kernel with \"rbd feature disable rook/rook-rbd1.img object-map fast-diff deep-flatten\". In some cases useful info is found in syslog - try \"dmesg | tail\". rbd: map failed: (6) No such device or address \u89e3\u51b3\u65b9\u6cd5\uff1a rbd feature disable rook/rook-rbd1.img object-map fast-diff deep-flatten # \u6309\u7167\u4ed6\u7684\u63d0\u793a\uff0c\u5148\u7981\u6b62\u8fd9\u4e9b\u7279\u6027\u518dmap Dashbaard \u56fe\u5f62\u7ba1\u7406 \u00b6 \u6e29\u99a8\u63d0\u793a \u6ce8\u610f\u9700\u8981\u5c06\u4e3b\u673a\u66b4\u6f0f\u7aef\u53e3\u7684\u5b89\u5168\u7ec4\u6253\u5f00\uff0c\u5b89\u5168\u7ec4\u6253\u5f00 31926 \u7aef\u53e3 \u542f\u2f64\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230rook-ceph-mgr-dashboard-external-http\u7684service\uff0c\u5176\u7c7b\u578b\u662fNodePort\uff0c /Users/beiyiwangdejiyi/k8s-data/rook-v1.6.11/cluster/examples/kubernetes/ceph k apply -f dashboard-external-http.yaml $ k get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE csi-cephfsplugin-metrics ClusterIP 10.97.7.142 <none> 8080/TCP,8081/TCP 579d csi-rbdplugin-metrics ClusterIP 10.97.0.194 <none> 8080/TCP,8081/TCP 579d rook-ceph-mgr ClusterIP 10.97.15.77 <none> 9283/TCP 579d rook-ceph-mgr-dashboard ClusterIP 10.97.4.98 <none> 7000/TCP 579d rook-ceph-mgr-dashboard-external-http NodePort 10.97.10.172 <none> 7000:31926/TCP 8m18s \u9ed8\u8ba4mgr\u521b\u5efa\u4e86\u2f00\u4e2aadmin\u7684\u2f64\u6237\uff0c\u5176\u5bc6\u7801\u5b58\u653e\u5728rook-ceph-dashboard-password\u7684secrets\u5bf9\u8c61\u4e2d\uff0c\u901a\u8fc7\u5982\u4e0b\u2f45\u5f0f\u53ef\u4ee5\u83b7\u53d6\u5230 kubectl get secrets -n rook-ceph rook-ceph-dashboard-password -oyaml apiVersion : v1 data : password : XTBndS0iREN1bE9UMGpQY2JQSSE= # \u91c7\u7528base64\u52a0\u5bc6 kind : Secret metadata : creationTimestamp : \"2020-12-16T18:01:16Z\" name : rook-ceph-dashboard-password namespace : rook-ceph ownerReferences : - apiVersion : ceph.rook.io/v1 blockOwnerDeletion : true controller : true kind : CephCluster name : rook-ceph uid : ee10d125-4428-4e88-983a-53190bc3411c resourceVersion : \"103972533\" uid : 7082d4ad-47bb-46e2-b439-624016cc5f81 type : kubernetes.io/rook base64 \u89e3\u5bc6 $ echo XTBndS0iREN1bE9UMGpQY2JQSSE= | base64 -d ]0gu-\"DCulOT0jPcbPI!% \u6d4b\u8bd5\u767b\u9646 URL: http://106.75.119.241:31926/ \u5e10\u53f7: admin \u5bc6\u7801: ]0gu-\"DCulOT0jPcbPI! \u8fdb\u5165\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e0b\u754c\u9762 Dashboard \u76d1\u63a7ceph \u00b6 $ k get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE csi-cephfsplugin-metrics ClusterIP 10.97.7.142 <none> 8080/TCP,8081/TCP 580d csi-rbdplugin-metrics ClusterIP 10.97.0.194 <none> 8080/TCP,8081/TCP 580d rook-ceph-mgr ClusterIP 10.97.15.77 <none> 9283/TCP 580d # \u7ed9prometheus\u4f5c\u4e3a\u5ba2\u6237\u7aef\u4f7f\u7528\u7684 ...... \u90e8\u7f72Prometheus Operator \u00b6 kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/v0.40.0/bundle.yaml \u786e\u8ba4prometheus-operator\u5904\u4e8erun\u72b6\u6001 $ k get pod prometheus-operator-7ccf6dfc8-d9dmm 1/1 Running 0 142 \u90e8\u7f72Prometheus Instances \u00b6 $ git clone --single-branch --branch v1.6.11 https://github.com/rook/rook.git cd rook/cluster/examples/kubernetes/ceph/monitoring \u521b\u5efa\u670d\u52a1\u76d1\u89c6\u5668\u4ee5\u53ca Prometheus \u670d\u52a1\u5668 pod \u548c\u670d\u52a1 kubectl create -f service-monitor.yaml kubectl create -f prometheus.yaml kubectl create -f prometheus-service.yaml \u672c\u5730\u6d4b\u8bd5\u8bbf\u95ee\uff1a $ k port-forward pod/prometheus-rook-prometheus-0 -n rook-ceph 9090 9090 \u8bbf\u95ee\uff1ahttp://localhost:9090/ grafana\u6d4b\u8bd5\u8bbf\u95ee\uff1a $ k port-forward pod/grafana-cc568dbd8-4nvlq -n infra 3000 80 \u8bbf\u95ee\uff1ahttp://localhost:3000/ \u5e10\u53f7\uff1aadmin \u5bc6\u7801\uff1astrongpassword \u76d1\u63a7\u5c55\u677f Ceph - Cluster\uff1ahttps://grafana.com/grafana/dashboards/2842 Ceph - OSD \uff1a https://grafana.com/grafana/dashboards/5336 Ceph - Pools\uff1a https://grafana.com/grafana/dashboards/5342 \u5bf9\u8c61\u5b58\u50a8 \u00b6 \u90e8\u7f72RGW\u5bf9\u8c61\u5b58\u50a8 \u00b6 $ k apply -f object.yaml [ ucloud ] root@master0:~/.kube# kubectl get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE csi-rbdplugin-metrics ClusterIP 10 .43.40.164 <none> 8080 /TCP,8081/TCP 7d4h csi-cephfsplugin-metrics ClusterIP 10 .43.170.151 <none> 8080 /TCP,8081/TCP 7d4h rook-ceph-mon-a ClusterIP 10 .43.248.216 <none> 6789 /TCP,3300/TCP 7d4h rook-ceph-mon-b ClusterIP 10 .43.174.200 <none> 6789 /TCP,3300/TCP 7d4h rook-ceph-mon-c ClusterIP 10 .43.9.21 <none> 6789 /TCP,3300/TCP 7d4h rook-ceph-mgr-dashboard ClusterIP 10 .43.193.31 <none> 8443 /TCP 7d4h rook-ceph-mgr ClusterIP 10 .43.114.15 <none> 9283 /TCP 7d4h wordpress-mysql ClusterIP None <none> 3306 /TCP 7d3h rook-prometheus NodePort 10 .43.128.1 <none> 9090 :30900/TCP 3d prometheus-operated ClusterIP None <none> 9090 /TCP 3d rook-ceph-rgw-my-store ClusterIP 10 .43.73.235 <none> 80 /TCP 18m [ ucloud ] root@master0:~/.kube# curl http://10.43.73.235 <?xml version = \"1.0\" encoding = \"UTF-8\" ?><ListAllMyBucketsResult xmlns = \"http://s3.amazonaws.com/doc/2006-03-01/\" ><Owner><ID>anonymous</ID><DisplayName></DisplayName></Owner><Buckets></Buckets></ListAllMyBucketsResult> [ ucloud ] root@master0:~/.kube# RGW\u9ad8\u53ef\u7528 \u00b6 $ vim object.yaml 54 instances: 2 \u521b\u5efaBucket \u00b6 \u521b\u5efastorageclass $ k apply -f storageclass-bucket-delete.yaml storageclass.storage.k8s.io/rook-ceph-delete-bucket created \u521b\u5efabucket $ k apply -f object-bucket-claim-delete.yaml objectbucketclaim.objectbucket.io/ceph-delete-bucket created \u5bb9\u5668\u8bbf\u95ee\u5bf9\u8c61\u5b58\u50a8 \u00b6 \u83b7\u53d6ceph-rgw\u7684\u8bbf\u95ee\u5730\u5740 $ k get cm ceph-delete-bucket -o yaml apiVersion : v1 data : BUCKET_HOST : rook-ceph-rgw-my-store.rook-ceph.svc BUCKET_NAME : ceph-bkt-148b1fa5-7868-42e5-8135-383d357c41cd BUCKET_PORT : \"80\" BUCKET_REGION : us-east-1 BUCKET_SUBREGION : \"\" kind : ConfigMap metadata : creationTimestamp : \"2022-08-05T08:24:27Z\" finalizers : - objectbucket.io/finalizer labels : bucket-provisioner : rook-ceph.ceph.rook.io-bucket name : ceph-delete-bucket namespace : rook-ceph ownerReferences : - apiVersion : objectbucket.io/v1alpha1 blockOwnerDeletion : true controller : true kind : ObjectBucketClaim name : ceph-delete-bucket uid : a8c69ebc-1e4d-477c-97e7-479b532962b3 resourceVersion : \"1282724\" uid : 26786f4b-9371-46fa-8ca9-f470e5e92cb2 \u62ff\u5230secrets $ k get secrets ceph-delete-bucket -o yaml apiVersion : v1 data : AWS_ACCESS_KEY_ID : Rk9JSjBJNlg0NDVNUVVMVkpGMzc= AWS_SECRET_ACCESS_KEY : SVdjaElaeVdUbTNGNkRyZ29UcUQ0R1gzOVlhczR4S1ZmWExERHNYeA== kind : Secret metadata : creationTimestamp : \"2022-08-05T08:24:27Z\" finalizers : - objectbucket.io/finalizer labels : bucket-provisioner : rook-ceph.ceph.rook.io-bucket name : ceph-delete-bucket namespace : rook-ceph ownerReferences : - apiVersion : objectbucket.io/v1alpha1 blockOwnerDeletion : true controller : true kind : ObjectBucketClaim name : ceph-delete-bucket uid : a8c69ebc-1e4d-477c-97e7-479b532962b3 resourceVersion : \"1282723\" uid : 1b0af759-7c7d-4fe4-9a80-ea2615fa8fef type : Opaque base64 \u89e3\u5bc6 $ echo Rk9JSjBJNlg0NDVNUVVMVkpGMzc = | base64 -d FOIJ0I6X445MQULVJF37% # beiyiwangdejiyi @ beiyiwangdejiyideMacBook-Pro in ~/note-work/hugo on git:main x [14:28:13] $ echo SVdjaElaeVdUbTNGNkRyZ29UcUQ0R1gzOVlhczR4S1ZmWExERHNYeA == | base64 -d IWchIZyWTm3F6DrgoTqD4GX39Yas4xKVfXLDDsXx% fio --name=sequential-read --directory=/config --rw=read --refill_buffers --bs=4K --size=200M root@nginx-run-685fdf6467-mdl9v:/# fio --name = sequential-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M sequential-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process sequential-read: Laying out IO file ( 1 file / 200MiB ) sequential-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 723 : Wed Aug 10 06 :28:37 2022 read: IOPS = 98 .8k, BW = 386MiB/s ( 405MB/s )( 200MiB/518msec ) clat ( nsec ) : min = 378 , max = 86956k, avg = 9833 .73, stdev = 534902 .03 lat ( nsec ) : min = 411 , max = 86956k, avg = 9868 .39, stdev = 534902 .42 clat percentiles ( nsec ) : | 1 .00th =[ 398 ] , 5 .00th =[ 486 ] , 10 .00th =[ 532 ] , | 20 .00th =[ 556 ] , 30 .00th =[ 580 ] , 40 .00th =[ 604 ] , | 50 .00th =[ 628 ] , 60 .00th =[ 644 ] , 70 .00th =[ 668 ] , | 80 .00th =[ 708 ] , 90 .00th =[ 804 ] , 95 .00th =[ 932 ] , | 99 .00th =[ 70144 ] , 99 .50th =[ 102912 ] , 99 .90th =[ 456704 ] , | 99 .95th =[ 1253376 ] , 99 .99th =[ 26083328 ] bw ( KiB/s ) : min = 401376 , max = 401376 , per = 100 .00%, avg = 401376 .00, stdev = 0 .00, samples = 1 iops : min = 100344 , max = 100344 , avg = 100344 .00, stdev = 0 .00, samples = 1 lat ( nsec ) : 500 = 5 .72%, 750 = 80 .66%, 1000 = 9 .78% lat ( usec ) : 2 = 1 .74%, 4 = 0 .06%, 10 = 0 .17%, 20 = 0 .06%, 50 = 0 .11% lat ( usec ) : 100 = 1 .17%, 250 = 0 .37%, 500 = 0 .07%, 750 = 0 .02%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .02%, 4 = 0 .01%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01% cpu : usr = 3 .29%, sys = 17 .02%, ctx = 571 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 386MiB/s ( 405MB/s ) , 386MiB/s-386MiB/s ( 405MB/s-405MB/s ) , io = 200MiB ( 210MB ) , run = 518 -518msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = sequential-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M sequential-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process sequential-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 729 : Wed Aug 10 06 :30:48 2022 read: IOPS = 344k, BW = 1342MiB/s ( 1407MB/s )( 200MiB/149msec ) clat ( nsec ) : min = 375 , max = 7097 .8k, avg = 2339 .11, stdev = 39079 .52 lat ( nsec ) : min = 406 , max = 7097 .8k, avg = 2372 .97, stdev = 39080 .14 clat percentiles ( nsec ) : | 1 .00th =[ 406 ] , 5 .00th =[ 524 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 588 ] , 40 .00th =[ 612 ] , | 50 .00th =[ 628 ] , 60 .00th =[ 644 ] , 70 .00th =[ 668 ] , | 80 .00th =[ 700 ] , 90 .00th =[ 748 ] , 95 .00th =[ 868 ] , | 99 .00th =[ 67072 ] , 99 .50th =[ 73216 ] , 99 .90th =[ 114176 ] , | 99 .95th =[ 156672 ] , 99 .99th =[ 1122304 ] lat ( nsec ) : 500 = 2 .29%, 750 = 87 .79%, 1000 = 7 .05% lat ( usec ) : 2 = 0 .96%, 4 = 0 .01%, 10 = 0 .15%, 20 = 0 .04%, 50 = 0 .11% lat ( usec ) : 100 = 1 .42%, 250 = 0 .15%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% lat ( msec ) : 2 = 0 .02%, 4 = 0 .01%, 10 = 0 .01% cpu : usr = 25 .68%, sys = 49 .32%, ctx = 335 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 1342MiB/s ( 1407MB/s ) , 1342MiB/s-1342MiB/s ( 1407MB/s-1407MB/s ) , io = 200MiB ( 210MB ) , run = 149 -149msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = big-file-multi-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.25 Starting 6 processes big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) Jobs: 2 ( f = 2 ) : [ _ ( 4 ) ,R ( 2 )][ 100 .0% ][ r = 264MiB/s ][ r = 67 .7k IOPS ][ eta 00m:00s ] big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 732 : Wed Aug 10 06 :32:40 2022 read: IOPS = 11 .1k, BW = 43 .5MiB/s ( 45 .6MB/s )( 200MiB/4602msec ) clat ( nsec ) : min = 377 , max = 522247k, avg = 89494 .70, stdev = 4682750 .76 lat ( nsec ) : min = 408 , max = 522247k, avg = 89553 .19, stdev = 4682751 .34 clat percentiles ( nsec ) : | 1 .00th =[ 414 ] , 5 .00th =[ 516 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 620 ] , 40 .00th =[ 660 ] , | 50 .00th =[ 692 ] , 60 .00th =[ 732 ] , 70 .00th =[ 796 ] , | 80 .00th =[ 884 ] , 90 .00th =[ 1020 ] , 95 .00th =[ 1192 ] , | 99 .00th =[ 83456 ] , 99 .50th =[ 218112 ] , 99 .90th =[ 5144576 ] , | 99 .95th =[ 20578304 ] , 99 .99th =[ 240123904 ] bw ( KiB/s ) : min = 14080 , max = 90112 , per = 18 .59%, avg = 45625 .50, stdev = 27571 .34, samples = 8 iops : min = 3520 , max = 22528 , avg = 11406 .37, stdev = 6892 .84, samples = 8 lat ( nsec ) : 500 = 3 .47%, 750 = 60 .05%, 1000 = 25 .67% lat ( usec ) : 2 = 8 .49%, 4 = 0 .21%, 10 = 0 .15%, 20 = 0 .08%, 50 = 0 .07% lat ( usec ) : 100 = 1 .00%, 250 = 0 .33%, 500 = 0 .14%, 750 = 0 .07%, 1000 = 0 .04% lat ( msec ) : 2 = 0 .06%, 4 = 0 .04%, 10 = 0 .05%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .02%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .59%, sys = 2 .00%, ctx = 671 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 733 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .7k, BW = 41 .9MiB/s ( 43 .9MB/s )( 200MiB/4776msec ) clat ( nsec ) : min = 376 , max = 734234k, avg = 92901 .06, stdev = 5934361 .60 lat ( nsec ) : min = 411 , max = 734234k, avg = 92951 .67, stdev = 5934362 .28 clat percentiles ( nsec ) : | 1 .00th =[ 402 ] , 5 .00th =[ 516 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 588 ] , 30 .00th =[ 636 ] , 40 .00th =[ 684 ] , | 50 .00th =[ 732 ] , 60 .00th =[ 788 ] , 70 .00th =[ 860 ] , | 80 .00th =[ 940 ] , 90 .00th =[ 1080 ] , 95 .00th =[ 1272 ] , | 99 .00th =[ 91648 ] , 99 .50th =[ 193536 ] , 99 .90th =[ 3981312 ] , | 99 .95th =[ 27131904 ] , 99 .99th =[ 233832448 ] bw ( KiB/s ) : min = 8192 , max = 98304 , per = 19 .42%, avg = 47655 .75, stdev = 31431 .05, samples = 8 iops : min = 2048 , max = 24576 , avg = 11913 .88, stdev = 7857 .79, samples = 8 lat ( nsec ) : 500 = 3 .87%, 750 = 50 .45%, 1000 = 31 .27% lat ( usec ) : 2 = 12 .03%, 4 = 0 .18%, 10 = 0 .15%, 20 = 0 .07%, 50 = 0 .06% lat ( usec ) : 100 = 1 .02%, 250 = 0 .48%, 500 = 0 .15%, 750 = 0 .05%, 1000 = 0 .04% lat ( msec ) : 2 = 0 .05%, 4 = 0 .02%, 10 = 0 .03%, 20 = 0 .02%, 50 = 0 .02% lat ( msec ) : 100 = 0 .02%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .44%, sys = 2 .07%, ctx = 845 , majf = 0 , minf = 17 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 734 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .9k, BW = 42 .6MiB/s ( 44 .7MB/s )( 200MiB/4696msec ) clat ( nsec ) : min = 379 , max = 607583k, avg = 91313 .18, stdev = 4982310 .93 lat ( nsec ) : min = 412 , max = 607583k, avg = 91361 .07, stdev = 4982311 .06 clat percentiles ( nsec ) : | 1 .00th =[ 410 ] , 5 .00th =[ 516 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 620 ] , 40 .00th =[ 660 ] , | 50 .00th =[ 700 ] , 60 .00th =[ 740 ] , 70 .00th =[ 804 ] , | 80 .00th =[ 900 ] , 90 .00th =[ 1048 ] , 95 .00th =[ 1240 ] , | 99 .00th =[ 78336 ] , 99 .50th =[ 130560 ] , 99 .90th =[ 4882432 ] , | 99 .95th =[ 14483456 ] , 99 .99th =[ 254803968 ] bw ( KiB/s ) : min = 7680 , max = 90112 , per = 17 .01%, avg = 41739 .89, stdev = 24407 .57, samples = 9 iops : min = 1920 , max = 22528 , avg = 10434 .89, stdev = 6101 .90, samples = 9 lat ( nsec ) : 500 = 3 .93%, 750 = 58 .07%, 1000 = 25 .64% lat ( usec ) : 2 = 10 .13%, 4 = 0 .22%, 10 = 0 .13%, 20 = 0 .04%, 50 = 0 .08% lat ( usec ) : 100 = 1 .10%, 250 = 0 .34%, 500 = 0 .08%, 750 = 0 .04%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .04%, 4 = 0 .03%, 10 = 0 .04%, 20 = 0 .02%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .72%, sys = 1 .81%, ctx = 502 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 735 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .6k, BW = 41 .5MiB/s ( 43 .5MB/s )( 200MiB/4822msec ) clat ( nsec ) : min = 374 , max = 700599k, avg = 93757 .53, stdev = 5099889 .71 lat ( nsec ) : min = 413 , max = 700599k, avg = 93803 .83, stdev = 5099890 .00 clat percentiles ( nsec ) : | 1 .00th =[ 430 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 620 ] , 40 .00th =[ 660 ] , | 50 .00th =[ 692 ] , 60 .00th =[ 732 ] , 70 .00th =[ 804 ] , | 80 .00th =[ 900 ] , 90 .00th =[ 1048 ] , 95 .00th =[ 1256 ] , | 99 .00th =[ 91648 ] , 99 .50th =[ 226304 ] , 99 .90th =[ 5931008 ] , | 99 .95th =[ 24248320 ] , 99 .99th =[ 235929600 ] bw ( KiB/s ) : min = 6520 , max = 65536 , per = 15 .07%, avg = 36989 .89, stdev = 18379 .13, samples = 9 iops : min = 1630 , max = 16384 , avg = 9247 .44, stdev = 4594 .77, samples = 9 lat ( nsec ) : 500 = 3 .74%, 750 = 59 .39%, 1000 = 24 .25% lat ( usec ) : 2 = 10 .19%, 4 = 0 .22%, 10 = 0 .18%, 20 = 0 .08%, 50 = 0 .08% lat ( usec ) : 100 = 0 .96%, 250 = 0 .43%, 500 = 0 .14%, 750 = 0 .07%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .06%, 4 = 0 .04%, 10 = 0 .06%, 20 = 0 .02%, 50 = 0 .02% lat ( msec ) : 100 = 0 .01%, 250 = 0 .02%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .21%, sys = 2 .24%, ctx = 874 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 736 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .2k, BW = 39 .9MiB/s ( 41 .9MB/s )( 200MiB/5008msec ) clat ( nsec ) : min = 377 , max = 806541k, avg = 97234 .58, stdev = 6320832 .41 lat ( nsec ) : min = 414 , max = 806541k, avg = 97345 .92, stdev = 6320844 .03 clat percentiles ( nsec ) : | 1 .00th =[ 402 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 612 ] , 40 .00th =[ 652 ] , | 50 .00th =[ 684 ] , 60 .00th =[ 724 ] , 70 .00th =[ 772 ] , | 80 .00th =[ 868 ] , 90 .00th =[ 1032 ] , 95 .00th =[ 1240 ] , | 99 .00th =[ 80384 ] , 99 .50th =[ 154624 ] , 99 .90th =[ 5275648 ] , | 99 .95th =[ 20054016 ] , 99 .99th =[ 200278016 ] bw ( KiB/s ) : min = 8192 , max = 49152 , per = 12 .40%, avg = 30434 .00, stdev = 15445 .75, samples = 9 iops : min = 2048 , max = 12288 , avg = 7608 .44, stdev = 3861 .51, samples = 9 lat ( nsec ) : 500 = 3 .77%, 750 = 62 .98%, 1000 = 22 .07% lat ( usec ) : 2 = 8 .67%, 4 = 0 .18%, 10 = 0 .26%, 20 = 0 .12%, 50 = 0 .12% lat ( usec ) : 100 = 1 .05%, 250 = 0 .40%, 500 = 0 .11%, 750 = 0 .04%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .05%, 4 = 0 .04%, 10 = 0 .03%, 20 = 0 .03%, 50 = 0 .02% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% cpu : usr = 0 .46%, sys = 1 .96%, ctx = 787 , majf = 0 , minf = 17 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 737 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .3k, BW = 40 .2MiB/s ( 42 .1MB/s )( 200MiB/4977msec ) clat ( nsec ) : min = 378 , max = 894860k, avg = 96613 .11, stdev = 5799729 .12 lat ( nsec ) : min = 413 , max = 894860k, avg = 96658 .78, stdev = 5799729 .19 clat percentiles ( nsec ) : | 1 .00th =[ 398 ] , 5 .00th =[ 506 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 612 ] , 40 .00th =[ 644 ] , | 50 .00th =[ 676 ] , 60 .00th =[ 716 ] , 70 .00th =[ 764 ] , | 80 .00th =[ 852 ] , 90 .00th =[ 988 ] , 95 .00th =[ 1176 ] , | 99 .00th =[ 87552 ] , 99 .50th =[ 216064 ] , 99 .90th =[ 6848512 ] , | 99 .95th =[ 31064064 ] , 99 .99th =[ 231735296 ] bw ( KiB/s ) : min = 16929 , max = 69632 , per = 14 .42%, avg = 35383 .25, stdev = 17459 .47, samples = 8 iops : min = 4232 , max = 17408 , avg = 8845 .75, stdev = 4364 .90, samples = 8 lat ( nsec ) : 500 = 4 .66%, 750 = 63 .16%, 1000 = 22 .55% lat ( usec ) : 2 = 7 .10%, 4 = 0 .20%, 10 = 0 .27%, 20 = 0 .09%, 50 = 0 .11% lat ( usec ) : 100 = 0 .99%, 250 = 0 .44%, 500 = 0 .12%, 750 = 0 .07%, 1000 = 0 .04% lat ( msec ) : 2 = 0 .06%, 4 = 0 .04%, 10 = 0 .03%, 20 = 0 .03%, 50 = 0 .01% lat ( msec ) : 100 = 0 .02%, 250 = 0 .02%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% cpu : usr = 0 .32%, sys = 2 .05%, ctx = 1006 , majf = 0 , minf = 17 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 240MiB/s ( 251MB/s ) , 39 .9MiB/s-43.5MiB/s ( 41 .9MB/s-45.6MB/s ) , io = 1200MiB ( 1258MB ) , run = 4602 -5008msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = big-file-multi-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.25 Starting 6 processes Jobs: 3 ( f = 3 ) : [ _ ( 1 ) ,R ( 1 ) ,_ ( 1 ) ,R ( 1 ) ,_ ( 1 ) ,R ( 1 )][ 80 .0% ][ r = 172MiB/s ][ r = 44 .1k IOPS ][ eta 00m:02s ] big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 740 : Wed Aug 10 06 :34:00 2022 read: IOPS = 8276 , BW = 32 .3MiB/s ( 33 .9MB/s )( 200MiB/6186msec ) clat ( nsec ) : min = 378 , max = 805881k, avg = 120250 .60, stdev = 7449083 .91 lat ( nsec ) : min = 410 , max = 805881k, avg = 120301 .98, stdev = 7449084 .14 clat percentiles ( nsec ) : | 1 .00th =[ 422 ] , 5 .00th =[ 532 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 612 ] , 40 .00th =[ 636 ] , | 50 .00th =[ 660 ] , 60 .00th =[ 684 ] , 70 .00th =[ 716 ] , | 80 .00th =[ 748 ] , 90 .00th =[ 860 ] , 95 .00th =[ 996 ] , | 99 .00th =[ 77312 ] , 99 .50th =[ 132096 ] , 99 .90th =[ 1318912 ] , | 99 .95th =[ 10289152 ] , 99 .99th =[ 434110464 ] bw ( KiB/s ) : min = 8192 , max = 65536 , per = 23 .93%, avg = 35045 .82, stdev = 25507 .11, samples = 11 iops : min = 2048 , max = 16384 , avg = 8761 .45, stdev = 6376 .78, samples = 11 lat ( nsec ) : 500 = 2 .40%, 750 = 77 .33%, 1000 = 15 .36% lat ( usec ) : 2 = 2 .64%, 4 = 0 .06%, 10 = 0 .18%, 20 = 0 .11%, 50 = 0 .13% lat ( usec ) : 100 = 1 .11%, 250 = 0 .39%, 500 = 0 .09%, 750 = 0 .05%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .03%, 4 = 0 .02%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% cpu : usr = 0 .34%, sys = 1 .62%, ctx = 845 , majf = 0 , minf = 14 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 741 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6102 , BW = 23 .8MiB/s ( 24 .0MB/s )( 200MiB/8390msec ) clat ( nsec ) : min = 379 , max = 1190 .5M, avg = 162758 .58, stdev = 11051920 .43 lat ( nsec ) : min = 413 , max = 1190 .5M, avg = 162807 .90, stdev = 11051920 .69 clat percentiles ( nsec ) : | 1 .00th =[ 410 ] , 5 .00th =[ 524 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 604 ] , 40 .00th =[ 636 ] , | 50 .00th =[ 668 ] , 60 .00th =[ 700 ] , 70 .00th =[ 724 ] , | 80 .00th =[ 764 ] , 90 .00th =[ 876 ] , 95 .00th =[ 1004 ] , | 99 .00th =[ 78336 ] , 99 .50th =[ 156672 ] , 99 .90th =[ 1073152 ] , | 99 .95th =[ 5275648 ] , 99 .99th =[ 616562688 ] bw ( KiB/s ) : min = 512 , max = 73728 , per = 20 .69%, avg = 30307 .20, stdev = 21673 .33, samples = 10 iops : min = 128 , max = 18432 , avg = 7576 .80, stdev = 5418 .33, samples = 10 lat ( nsec ) : 500 = 2 .76%, 750 = 73 .76%, 1000 = 18 .35% lat ( usec ) : 2 = 2 .79%, 4 = 0 .04%, 10 = 0 .22%, 20 = 0 .13%, 50 = 0 .14% lat ( usec ) : 100 = 1 .05%, 250 = 0 .42%, 500 = 0 .14%, 750 = 0 .05%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .04%, 4 = 0 .02%, 10 = 0 .02%, 20 = 0 .01%, 100 = 0 .01% lat ( msec ) : 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 2000 = 0 .01% cpu : usr = 0 .33%, sys = 1 .10%, ctx = 982 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 742 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6906 , BW = 26 .0MiB/s ( 28 .3MB/s )( 200MiB/7413msec ) clat ( nsec ) : min = 380 , max = 1034 .3M, avg = 144218 .03, stdev = 9148025 .05 lat ( nsec ) : min = 414 , max = 1034 .3M, avg = 144254 .80, stdev = 9148025 .00 clat percentiles ( nsec ) : | 1 .00th =[ 406 ] , 5 .00th =[ 524 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 596 ] , 40 .00th =[ 620 ] , | 50 .00th =[ 652 ] , 60 .00th =[ 676 ] , 70 .00th =[ 708 ] , | 80 .00th =[ 748 ] , 90 .00th =[ 860 ] , 95 .00th =[ 988 ] , | 99 .00th =[ 78336 ] , 99 .50th =[ 146432 ] , 99 .90th =[ 1253376 ] , | 99 .95th =[ 4620288 ] , 99 .99th =[ 522190848 ] bw ( KiB/s ) : min = 16384 , max = 73728 , per = 26 .85%, avg = 39318 .40, stdev = 23491 .33, samples = 10 iops : min = 4096 , max = 18432 , avg = 9829 .60, stdev = 5872 .83, samples = 10 lat ( nsec ) : 500 = 3 .29%, 750 = 76 .66%, 1000 = 15 .22% lat ( usec ) : 2 = 2 .43%, 4 = 0 .10%, 10 = 0 .23%, 20 = 0 .12%, 50 = 0 .12% lat ( usec ) : 100 = 1 .13%, 250 = 0 .37%, 500 = 0 .13%, 750 = 0 .05%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .04%, 4 = 0 .02%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% lat ( msec ) : 2000 = 0 .01% cpu : usr = 0 .32%, sys = 1 .32%, ctx = 864 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 743 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6106 , BW = 23 .9MiB/s ( 25 .0MB/s )( 200MiB/8385msec ) clat ( nsec ) : min = 380 , max = 1507 .9M, avg = 162772 .24, stdev = 13174473 .96 lat ( nsec ) : min = 414 , max = 1507 .9M, avg = 162810 .08, stdev = 13174473 .94 clat percentiles ( nsec ) : | 1 .00th =[ 398 ] , 5 .00th =[ 510 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 604 ] , 40 .00th =[ 636 ] , | 50 .00th =[ 668 ] , 60 .00th =[ 692 ] , 70 .00th =[ 724 ] , | 80 .00th =[ 764 ] , 90 .00th =[ 876 ] , 95 .00th =[ 1012 ] , | 99 .00th =[ 79360 ] , 99 .50th =[ 136192 ] , 99 .90th =[ 897024 ] , | 99 .95th =[ 2506752 ] , 99 .99th =[ 434110464 ] bw ( KiB/s ) : min = 8 , max = 81920 , per = 20 .70%, avg = 30310 .40, stdev = 22461 .38, samples = 10 iops : min = 2 , max = 20480 , avg = 7577 .60, stdev = 5615 .35, samples = 10 lat ( nsec ) : 500 = 4 .29%, 750 = 73 .14%, 1000 = 17 .30% lat ( usec ) : 2 = 2 .94%, 4 = 0 .04%, 10 = 0 .22%, 20 = 0 .07%, 50 = 0 .19% lat ( usec ) : 100 = 1 .10%, 250 = 0 .44%, 500 = 0 .11%, 750 = 0 .05%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .03%, 4 = 0 .01%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 2000 = 0 .01% cpu : usr = 0 .05%, sys = 1 .40%, ctx = 993 , majf = 0 , minf = 14 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 744 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6911 , BW = 26 .0MiB/s ( 28 .3MB/s )( 200MiB/7408msec ) clat ( nsec ) : min = 381 , max = 1179 .3M, avg = 143994 .58, stdev = 11079777 .48 lat ( nsec ) : min = 413 , max = 1179 .3M, avg = 144029 .70, stdev = 11079777 .45 clat percentiles ( nsec ) : | 1 .00th =[ 406 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 580 ] , 40 .00th =[ 612 ] , | 50 .00th =[ 636 ] , 60 .00th =[ 668 ] , 70 .00th =[ 692 ] , | 80 .00th =[ 732 ] , 90 .00th =[ 836 ] , 95 .00th =[ 956 ] , | 99 .00th =[ 76288 ] , 99 .50th =[ 111104 ] , 99 .90th =[ 995328 ] , | 99 .95th =[ 3227648 ] , 99 .99th =[ 742391808 ] bw ( KiB/s ) : min = 5040 , max = 73728 , per = 22 .93%, avg = 33587 .20, stdev = 27492 .28, samples = 10 iops : min = 1260 , max = 18432 , avg = 8396 .80, stdev = 6873 .07, samples = 10 lat ( nsec ) : 500 = 3 .81%, 750 = 78 .93%, 1000 = 13 .08% lat ( usec ) : 2 = 2 .02%, 4 = 0 .02%, 10 = 0 .21%, 20 = 0 .07%, 50 = 0 .12% lat ( usec ) : 100 = 1 .15%, 250 = 0 .36%, 500 = 0 .07%, 750 = 0 .04%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .04%, 4 = 0 .02%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01%, 2000 = 0 .01% cpu : usr = 0 .26%, sys = 1 .35%, ctx = 724 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 745 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6238 , BW = 24 .4MiB/s ( 25 .6MB/s )( 200MiB/8207msec ) clat ( nsec ) : min = 379 , max = 1170 .8M, avg = 159639 .78, stdev = 10672683 .50 lat ( nsec ) : min = 413 , max = 1170 .8M, avg = 159675 .27, stdev = 10672683 .47 clat percentiles ( nsec ) : | 1 .00th =[ 410 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 596 ] , 40 .00th =[ 628 ] , | 50 .00th =[ 652 ] , 60 .00th =[ 684 ] , 70 .00th =[ 716 ] , | 80 .00th =[ 764 ] , 90 .00th =[ 876 ] , 95 .00th =[ 1012 ] , | 99 .00th =[ 77312 ] , 99 .50th =[ 156672 ] , 99 .90th =[ 1810432 ] , | 99 .95th =[ 5865472 ] , 99 .99th =[ 616562688 ] bw ( KiB/s ) : min = 6400 , max = 74752 , per = 18 .50%, avg = 27096 .62, stdev = 22310 .47, samples = 13 iops : min = 1600 , max = 18688 , avg = 6774 .15, stdev = 5577 .62, samples = 13 lat ( nsec ) : 500 = 4 .00%, 750 = 74 .22%, 1000 = 16 .52% lat ( usec ) : 2 = 3 .01%, 4 = 0 .05%, 10 = 0 .19%, 20 = 0 .07%, 50 = 0 .11% lat ( usec ) : 100 = 1 .06%, 250 = 0 .40%, 500 = 0 .14%, 750 = 0 .05%, 1000 = 0 .05% lat ( msec ) : 2 = 0 .04%, 4 = 0 .03%, 10 = 0 .03%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% lat ( msec ) : 2000 = 0 .01% cpu : usr = 0 .26%, sys = 1 .22%, ctx = 949 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 143MiB/s ( 150MB/s ) , 23 .8MiB/s-32.3MiB/s ( 24 .0MB/s-33.9MB/s ) , io = 1200MiB ( 1258MB ) , run = 6186 -8390msec fio --name=sequential-write --directory=/config --rw=write --refill_buffers --bs=4K --size=200M --end_fsync=1 fio --name=big-file-multi-read --directory=$PWD --rw=read --refill_buffers --bs=4K --size=200M --numjobs=6 fio --name=sequential-write --directory=/config --rw=write --refill_buffers --bs=4K --size=200M --end_fsync=1 root@nginx-run-685fdf6467-mdl9v:/config# fio --name = sequential-write --directory = /config --rw = write --refill_buffers --bs = 4K --size = 200M --end_fsync = 1 sequential-write: ( g = 0 ) : rw = write, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process sequential-write: Laying out IO file ( 1 file / 200MiB ) Jobs: 1 ( f = 1 ) sequential-write: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 756 : Wed Aug 10 06 :39:40 2022 write: IOPS = 33 .6k, BW = 131MiB/s ( 138MB/s )( 200MiB/1525msec ) ; 0 zone resets clat ( usec ) : min = 7 , max = 7420 , avg = 27 .69, stdev = 125 .85 lat ( usec ) : min = 7 , max = 7420 , avg = 27 .76, stdev = 125 .85 clat percentiles ( usec ) : | 1 .00th =[ 8 ] , 5 .00th =[ 9 ] , 10 .00th =[ 11 ] , 20 .00th =[ 12 ] , | 30 .00th =[ 20 ] , 40 .00th =[ 21 ] , 50 .00th =[ 22 ] , 60 .00th =[ 22 ] , | 70 .00th =[ 23 ] , 80 .00th =[ 24 ] , 90 .00th =[ 28 ] , 95 .00th =[ 37 ] , | 99 .00th =[ 118 ] , 99 .50th =[ 285 ] , 99 .90th =[ 1860 ] , 99 .95th =[ 3097 ] , | 99 .99th =[ 4752 ] bw ( KiB/s ) : min = 132286 , max = 138088 , per = 100 .00%, avg = 135187 .00, stdev = 4102 .63, samples = 2 iops : min = 33071 , max = 34522 , avg = 33796 .50, stdev = 1026 .01, samples = 2 lat ( usec ) : 10 = 9 .54%, 20 = 24 .43%, 50 = 63 .08%, 100 = 1 .75%, 250 = 0 .66% lat ( usec ) : 500 = 0 .22%, 750 = 0 .09%, 1000 = 0 .05% lat ( msec ) : 2 = 0 .10%, 4 = 0 .07%, 10 = 0 .03% cpu : usr = 9 .84%, sys = 31 .04%, ctx = 51905 , majf = 0 , minf = 12 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,51200,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : WRITE: bw = 131MiB/s ( 138MB/s ) , 131MiB/s-131MiB/s ( 138MB/s-138MB/s ) , io = 200MiB ( 210MB ) , run = 1525 -1525msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = sequential-write --directory = /config --rw = write --refill_buffers --bs = 4K --size = 200M --end_fsync = 1 sequential-write: ( g = 0 ) : rw = write, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process Jobs: 1 ( f = 1 ) sequential-write: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 759 : Wed Aug 10 06 :41:20 2022 write: IOPS = 31 .3k, BW = 122MiB/s ( 128MB/s )( 200MiB/1637msec ) ; 0 zone resets clat ( usec ) : min = 7 , max = 9234 , avg = 30 .16, stdev = 137 .54 lat ( usec ) : min = 7 , max = 9234 , avg = 30 .21, stdev = 137 .54 clat percentiles ( usec ) : | 1 .00th =[ 8 ] , 5 .00th =[ 9 ] , 10 .00th =[ 11 ] , 20 .00th =[ 18 ] , | 30 .00th =[ 20 ] , 40 .00th =[ 21 ] , 50 .00th =[ 22 ] , 60 .00th =[ 22 ] , | 70 .00th =[ 23 ] , 80 .00th =[ 24 ] , 90 .00th =[ 29 ] , 95 .00th =[ 41 ] , | 99 .00th =[ 147 ] , 99 .50th =[ 379 ] , 99 .90th =[ 2311 ] , 99 .95th =[ 3064 ] , | 99 .99th =[ 4490 ] bw ( KiB/s ) : min = 119544 , max = 132640 , per = 100 .00%, avg = 128018 .67, stdev = 7349 .32, samples = 3 iops : min = 29886 , max = 33160 , avg = 32004 .67, stdev = 1837 .33, samples = 3 lat ( usec ) : 10 = 7 .32%, 20 = 25 .16%, 50 = 63 .95%, 100 = 2 .08%, 250 = 0 .85% lat ( usec ) : 500 = 0 .23%, 750 = 0 .09%, 1000 = 0 .08% lat ( msec ) : 2 = 0 .12%, 4 = 0 .11%, 10 = 0 .02% cpu : usr = 7 .21%, sys = 32 .64%, ctx = 51971 , majf = 0 , minf = 13 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,51200,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : WRITE: bw = 122MiB/s ( 128MB/s ) , 122MiB/s-122MiB/s ( 128MB/s-128MB/s ) , io = 200MiB ( 210MB ) , run = 1637 -1637msec fio --name=big-file-multi-write --directory=/config --rw=write --refill_buffers --bs=4K --size=200M --numjobs=6 --end_fsync=1 fio -filename=/config/fio.img -direct=1 -iodepth 32 -thread -rw=randread -ioengine=libaio -bs=4k -size=200m -numjobs=2 -runtime=60 -group_reporting -name=mytest \u56fa\u6001\u5bbf\u4e3b\u673a\uff1a [ ucloud ] root@node1:/var/jfsCache# fio --name = big-file-multi-read --directory = $PWD --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.16 Starting 6 processes Jobs: 6 ( f = 6 ) : [ R ( 6 )][ 88 .9% ][ r = 130MiB/s ][ r = 33 .2k IOPS ][ eta 00m:01s ] big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 225237 : Fri Aug 12 14 :09:04 2022 read: IOPS = 5925 , BW = 23 .1MiB/s ( 24 .3MB/s )( 200MiB/8641msec ) clat ( nsec ) : min = 434 , max = 21757k, avg = 168221 .11, stdev = 1662876 .10 lat ( nsec ) : min = 471 , max = 21757k, avg = 168260 .51, stdev = 1662876 .63 clat percentiles ( nsec ) : | 1 .00th =[ 524 ] , 5 .00th =[ 540 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 572 ] , 40 .00th =[ 580 ] , | 50 .00th =[ 596 ] , 60 .00th =[ 612 ] , 70 .00th =[ 628 ] , | 80 .00th =[ 660 ] , 90 .00th =[ 732 ] , 95 .00th =[ 884 ] , | 99 .00th =[ 3948544 ] , 99 .50th =[ 19005440 ] , 99 .90th =[ 20054016 ] , | 99 .95th =[ 20054016 ] , 99 .99th =[ 20054016 ] \u5185\u5b58\u5bbf\u4e3b\u673a\uff1a [ ucloud ] root@node1:/var/jfsCache# fio --name = big-file-multi-read --directory = $PWD --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.16 Starting 6 processes big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 12095 : Fri Aug 12 15 :05:27 2022 read: IOPS = 966k, BW = 3774MiB/s ( 3957MB/s )( 200MiB/53msec ) clat ( nsec ) : min = 520 , max = 221610 , avg = 757 .38, stdev = 2561 .09 lat ( nsec ) : min = 553 , max = 221646 , avg = 792 .50, stdev = 2561 .18 clat percentiles ( nsec ) : | 1 .00th =[ 540 ] , 5 .00th =[ 556 ] , 10 .00th =[ 556 ] , 20 .00th =[ 564 ] , | 30 .00th =[ 572 ] , 40 .00th =[ 580 ] , 50 .00th =[ 596 ] , 60 .00th =[ 612 ] , | 70 .00th =[ 644 ] , 80 .00th =[ 724 ] , 90 .00th =[ 908 ] , 95 .00th =[ 940 ] , | 99 .00th =[ 3344 ] , 99 .50th =[ 3728 ] , 99 .90th =[ 19072 ] , 99 .95th =[ 43264 ] , | 99 .99th =[ 115200 ] fio --name=small-file-multi-read \\ --directory=/config \\ --rw=read --file_service_type=sequential \\ --bs=4k --filesize=4k --nrfiles=500 \\ --numjobs=2","title":"ceph \u5206\u5e03\u5f0f\u5b58\u50a8"},{"location":"5.Storage/rook-ceph/#rook-ceph","text":"\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u652f\u6301\u5bf9\u8c61\u5b58\u50a8\uff0c\u5757\u8bbe\u5907\uff0c\u6587\u4ef6\u7cfb\u7edf \u5757\u5b58\u50a8 CephFs \u5bf9\u8c61\u5b58\u50a8","title":"rook-ceph\u7b80\u4ecb"},{"location":"5.Storage/rook-ceph/#ceph","text":"x.0.z - \u5f00\u53d1\u7248 x.1.z - \u5019\u9009\u7248 x.2.z - \u7a33\u5b9a\uff0c\u4fee\u6b63\u7248","title":"ceph \u7684\u7248\u672c\u5386\u53f2"},{"location":"5.Storage/rook-ceph/#ceph_1","text":"\u6ce8\u610f ceph\u96c6\u7fa4\u7684osd\u8282\u70b9\u4e00\u822c\u4fdd\u8bc1>=3\u4e2a\uff0c\u6765\u4fdd\u8bc1\u6570\u636e\u7684\u9ad8\u53ef\u7528\u6027\u3002 mon : ceph \u76d1\u89c6\u5668,\u5728\u4e00\u4e2a\u4e3b\u673a\u4e0a\u8fd0\u884c\u7684\u4e00\u4e2a\u5b88\u62a4\u8fdb\u7a0b\uff0c\u7528\u4e8e\u7ef4\u62a4\u96c6\u7fa4\u72b6\u6001\u6620\u5c04\u5173\u7cfb mgr : \u8d1f\u8d23\u8ddf\u8e2a\u8fd0\u884c\u65f6\u6307\u6807\u548cceph\u96c6\u7fa4\u7684\u5f53\u524d\u72b6\u6001 osd : \u78c1\u76d8\uff08\u771f\u6b63\u5b58\u50a8\u6570\u636e\u7684\u5730\u65b9\uff09 ceph \u9762\u8bd5\u9898 ceph","title":"ceph\u96c6\u7fa4\u89d2\u8272\u5b9a\u4e49"},{"location":"5.Storage/rook-ceph/#rook-ceph_1","text":"\u73af\u5883\u8981\u6c42 \u4e00\u4e2ak8s\u96c6\u7fa4\uff0cnode\u8282\u70b9\u6700\u5c11\u4e09\u4e2a\u8282\u70b9 mon: 8C 8G/200G 16C 16g/32-200G","title":"rook-ceph\u90e8\u7f72"},{"location":"5.Storage/rook-ceph/#_1","text":"","title":"\u666e\u901a\u6d4b\u8bd5\u90e8\u7f72\uff1a"},{"location":"5.Storage/rook-ceph/#crdscommonoperator","text":"[ucloud] root@master0:~# git clone --single-branch --branch v1.5.5 https://github.com/rook/rook.git cd rook/cluster/examples/kubernetes/ceph kubectl create -f crds.yaml -f common.yaml -f operator.yaml kubectl create -f cluster.yaml","title":"\u90e8\u7f72crds\uff0ccommon\uff0coperator"},{"location":"5.Storage/rook-ceph/#_2","text":"# ROOK_CSI_CEPH_IMAGE: \"quay.io/cephcsi/cephcsi:v3.4.0\" # ROOK_CSI_REGISTRAR_IMAGE: \"k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.3.0\" # ROOK_CSI_RESIZER_IMAGE: \"k8s.gcr.io/sig-storage/csi-resizer:v1.3.0\" # ROOK_CSI_PROVISIONER_IMAGE: \"k8s.gcr.io/sig-storage/csi-provisioner:v3.0.0\" # ROOK_CSI_SNAPSHOTTER_IMAGE: \"k8s.gcr.io/sig-storage/csi-snapshotter:v4.2.0\" # ROOK_CSI_ATTACHER_IMAGE: \"k8s.gcr.io/sig-storage/csi-attacher:v3.3.0\"","title":"\u955c\u50cf\u5217\u8868\uff1a"},{"location":"5.Storage/rook-ceph/#csi","text":"[ ucloud ] root@node0:/home/lixie# cat <<EOF>> image-sci.sh #!/bin/bash image_list=' csi-node-driver-registrar:v2.0.1 csi-attacher:v3.0.0 csi-snapshotter:v3.0.0 csi-resizer:v1.0.0 csi-provisioner:v2.0.0 ' aliyuncs=\"registry.aliyuncs.com/it00021hot\" google_gcr=\"k8s.gcr.io/sig-storage\" for image in $image_list do echo $image docker pull ${aliyuncs}/${image} docker tag ${aliyuncs}/${image} ${google_gcr}/${image} docker rm ${aliyuncs}/${image} #echo \"${aliyuncs}/${image} ${google_gcr}/${image} downloaded.\" done EOF","title":"CSI\u83b7\u53d6\u955c\u50cf\u811a\u672c\uff1a"},{"location":"5.Storage/rook-ceph/#_3","text":"","title":"\u5b9a\u5236\u5316\u90e8\u7f72\uff1a"},{"location":"5.Storage/rook-ceph/#mon","text":"\u80cc\u666f \u2f63\u4ea7\u73af\u5883\u6709\u2f00\u4e9b\u4e13\u2ed4\u7684\u8282\u70b9\u2f64\u4e8emon\u3001mgr\uff0c\u5b58\u50a8\u8282\u70b9\u8282\u70b9\u4f7f\u2f64\u5355\u72ec\u7684\u8282\u70b9\u627f\u62c5,\u5229\u2f64\u8c03\u5ea6\u673a\u5236\u5b9e \u73b0 placement : mon : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : ceph-mon operator : In values : - enabled #\u8bbe\u7f6e\u78c1\u76d8\u7684\u53c2\u6570\uff0c\u8c03\u6574\u4e3afalse\uff0c\u2f45\u4fbf\u540e\u2faf\u5b9a\u5236 214 useAllNodes : false 215 useAllDevices : false \u5206\u522b\u7ed9\u8282\u70b9\u6253\u4e0a\u6807\u7b7e [ucloud] root@master0:~# kubectl label node node0 ceph-mon=enabled node/node0 labeled [ucloud] root@master0:~# kubectl label node node1 ceph-mon=enabled node/node1 labeled [ucloud] root@master0:~# kubectl label node node2 ceph-mon=enabled node/node2 labeled \u83b7\u53d6\u955c\u50cf\u811a\u672c $ cat image-rook-ceph-sci-v1.7.11.sh #!/bin/bash image_list=' csi-node-driver-registrar:v2.0.1 csi-attacher:v3.0.0 csi-snapshotter:v3.0.0 csi-resizer:v1.0.0 csi-provisioner:v2.0.0 ' aliyuncs=\"registry.aliyuncs.com/it00021hot\" google_gcr=\"k8s.gcr.io/sig-storage\" for image in $image_list do echo $image docker pull ${aliyuncs}/${image} docker tag ${aliyuncs}/${image} ${google_gcr}/${image} #docker rm ${aliyuncs}/${image} #echo \"${aliyuncs}/${image} ${google_gcr}/${image} downloaded.\" done EOF","title":"\u5b9a\u5236mon\u8c03\u5ea6\u53c2\u6570"},{"location":"5.Storage/rook-ceph/#mgr","text":"\u6e29\u99a8\u63d0\u793a \u4fee\u6539mgr\u7684\u8c03\u5ea6\u53c2\u6570,\u4fee\u6539\u5b8c\u4e4b\u540e\u91cd\u65b0apply cluster.yaml\u914d\u7f6e\u4f7f\u5176\u52a0\u8f7d\u5230\u96c6\u7fa4\u4e2d mgr : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : ceph-mgr operator : In values : - enabled \u6b64\u65f6\u8c03\u5ea6\u4f1a\u5931\u8d25\uff0c\u7ed9node-1\u548cnode-2\u6253\u4e0a ceph-mgr=enabled \u7684\u6807\u7b7e $ kubectl label nodes node0 ceph-mgr=enabled node/node0 labeled $ kubectl label nodes node1 ceph-mgr=enabled node/node1 labeled","title":"\u5b9a\u5236mgr\u8c03\u5ea6\u53c2\u6570"},{"location":"5.Storage/rook-ceph/#msd","text":"\u8bbe\u7f6eosd\u7684\u8c03\u5ea6\u53c2\u6570 osd : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : ceph-osd operator : In values : - enabled \u5b9a\u5236osd\u7684\u78c1\u76d8\u53c2\u6570 nodes : - name : \"node0\" devices : # specific devices to use for storage can be specified for each node - name : \"vdb\" - name : \"node1\" devices : # specific devices to use for storage can be specified for each node - name : \"vdc\"","title":"\u5b9a\u5236msd\u8c03\u5ea6\u53c2\u6570"},{"location":"5.Storage/rook-ceph/#toolbox","text":"apply\u4ee5\u4e0b\u4e2d\u4e24\u4e2a\u6587\u4ef6\u7684\u4e00\u4e2a\u5c31\u53ef\u4ee5\uff0c\u4e00\u822c\u9009\u62e9toolbox.yaml $ ll tool* -rw-r--r-- 1 beiyiwangdejiyi staff 1.7K 7 19 17:26 toolbox-job.yaml # \u4e00\u6b21\u6027\u4efb\u52a1 -rw-r--r-- 1 beiyiwangdejiyi staff 1.4K 7 19 17:26 toolbox.yaml kubectl apply -f toolbox.yaml","title":"toolbox\u5ba2\u6237\u7aef"},{"location":"5.Storage/rook-ceph/#k8sceph","text":"centos\u7cfb\u7edf\uff1a","title":"k8s\u8bbf\u95eeceph"},{"location":"5.Storage/rook-ceph/#1-ceph-yum","text":"[root@node-1 ~]# cat /etc/yum.repos.d/ceph.repo [ceph] name=ceph baseurl=https://mirrors.aliyun.com/ceph/rpm-octopus/el8/x86_64/ enabled=1 gpgcheck=0","title":"1. \u914d\u7f6eCeph yum\u6e90"},{"location":"5.Storage/rook-ceph/#2ceph-common","text":"[root@node-1 ~]# yum -y install ceph-common","title":"2.\u5b89\u88c5ceph-common"},{"location":"5.Storage/rook-ceph/#3-ceph","text":"[root@rook-ceph-tools-65c94d77bb-b9b2h /]# cat /etc/ceph/ceph.conf # \u67e5\u770b\u4e4b\u540e\u5bbf\u4e3b\u673a\u521b\u5efa [global] mon_host = 10.43.248.216:6789,10.43.174.200:6789,10.43.9.21:6789 [client.admin] keyring = /etc/ceph/keyring [root@rook-ceph-tools-65c94d77bb-b9b2h /]# cat /etc/ceph/keyring # \u67e5\u770b\u4e4b\u540e\u5bbf\u4e3b\u673a\u521b\u5efa [client.admin] key = AQCRS+NijUeiIxAAhFtv6je2FmMEAVHAJJqPwg== ubuntu\u7cfb\u7edf\uff1a apt install ceph-common","title":"3. \u521b\u5efaceph\u914d\u7f6e\u6587\u4ef6"},{"location":"5.Storage/rook-ceph/#rbd","text":"","title":"\u8bbf\u95eeRBD\u5757\u5b58\u50a8"},{"location":"5.Storage/rook-ceph/#1pool","text":"[ root@rook-ceph-tools-65c94d77bb-xg6xs / ] # ceph osd pool create rook 16 16 pool 'rook' created [root@rook-ceph-tools-65c94d77bb-xg6xs /]# ceph osd lspools # \u67e5\u770bpools 1 device_health_metrics 2 replicapool 3 rook","title":"1.\u521b\u5efa\u4e00\u4e2apool"},{"location":"5.Storage/rook-ceph/#2-pool","text":"[ root@rook-ceph-tools-65c94d77bb-xg6xs / ] # rbd create -p rook --image rook-rbd.img --size 10G [ root@rook-ceph-tools-65c94d77bb-xg6xs / ] # rbd ls -p rook rook-rbd.img [root@rook-ceph-tools-65c94d77bb-xg6xs /]# rbd info rook/rook-rbd.img # \u67e5\u770b\u8be6\u7ec6\u4fe1\u606f rbd image 'rook-rbd.img' : size 10 GiB in 2560 objects order 22 (4 MiB objects) snapshot_count : 0 id : 50a7fcf85890 block_name_prefix : rbd_data.50a7fcf85890 format : 2 features : layering op_features : flags : create_timestamp : Fri Jul 29 05:40:05 2022 access_timestamp : Fri Jul 29 05:40:05 2022 modify_timestamp : Fri Jul 29 05:40:05 2022","title":"2. \u5728pool\u4e0a\u521b\u5efa\u5757\u8bbe\u5907"},{"location":"5.Storage/rook-ceph/#3rbd","text":"[ ucloud ] root@master0:/home/lixie# rbd map rook/rook-rbd.img /dev/rbd0 [ ucloud ] root@master0:/home/lixie# rbd showmapped id pool namespace image snap device 0 rook rook-rbd.img - /dev/rbd0 [ ucloud ] root@master0:/home/lixie# mkfs.xfs /dev/rbd0 meta-data = /dev/rbd1 isize = 512 agcount = 16 , agsize = 163840 blks = sectsz = 512 attr = 2 , projid32bit = 1 = crc = 1 finobt = 1 , sparse = 1 , rmapbt = 0 = reflink = 1 data = bsize = 4096 blocks = 2621440 , imaxpct = 25 = sunit = 16 swidth = 16 blks naming = version 2 bsize = 4096 ascii-ci = 0 , ftype = 1 log = internal log bsize = 4096 blocks = 2560 , version = 2 = sectsz = 512 sunit = 16 blks, lazy-count = 1 realtime = none extsz = 4096 blocks = 0 , rtextents = 0 \u95ee\u9898\u4e00\uff1a\u52a0\u8f7d rbd \u5185\u6838\u6a21\u5757\u5931\u8d25 [root@rook-ceph-tools-65c94d77bb-xg6xs /]# rbd map rook/rook-rbd.img modinfo: ERROR: Module alias rbd not found. modprobe: FATAL: Module rbd not found in directory /lib/modules/5.4.0-48-generic rbd: failed to load rbd kernel module (1) rbd: failed to set udev buffer size: (1) Operation not permitted rbd: sysfs write failed In some cases useful info is found in syslog - try \"dmesg | tail\". rbd: map failed: (2) No such file or directory \u89e3\u51b3\u65b9\u6cd5\uff1a [ucloud] root@node0:/home/lixie# modprobe rbd [ucloud] root@node0:/home/lixie# lsmod |grep rbd rbd 106496 0 libceph 327680 1 rbd \u95ee\u9898\u4e8c\uff1amap rdb [root@rook-ceph-tools-65c94d77bb-b9b2h /]# rbd map rook/rook-rbd.img rbd: failed to set udev buffer size: (1) Operation not permitted rbd: sysfs write failed In some cases useful info is found in syslog - try \"dmesg | tail\". \u89e3\u51b3\u65b9\u6cd5\uff1a \u5728\u5bbf\u4e3b\u673a\u4e0a\u6267\u884c\uff0c\u8be5\u547d\u4ee4\u3002 \u95ee\u9898\u4e09: \u5185\u6838\u6a21\u5757\u4e0d\u652f\u6301\u8fd9\u4e48\u591a\u7684\u7279\u6027 [dev] root@master0:/home/lixie# rbd map rook/rook-rbd1.img rbd: sysfs write failed RBD image feature set mismatch. You can disable features unsupported by the kernel with \"rbd feature disable rook/rook-rbd1.img object-map fast-diff deep-flatten\". In some cases useful info is found in syslog - try \"dmesg | tail\". rbd: map failed: (6) No such device or address \u89e3\u51b3\u65b9\u6cd5\uff1a rbd feature disable rook/rook-rbd1.img object-map fast-diff deep-flatten # \u6309\u7167\u4ed6\u7684\u63d0\u793a\uff0c\u5148\u7981\u6b62\u8fd9\u4e9b\u7279\u6027\u518dmap","title":"3\u3001\u5ba2\u6237\u6302\u8f7dRBD\u5757"},{"location":"5.Storage/rook-ceph/#dashbaard","text":"\u6e29\u99a8\u63d0\u793a \u6ce8\u610f\u9700\u8981\u5c06\u4e3b\u673a\u66b4\u6f0f\u7aef\u53e3\u7684\u5b89\u5168\u7ec4\u6253\u5f00\uff0c\u5b89\u5168\u7ec4\u6253\u5f00 31926 \u7aef\u53e3 \u542f\u2f64\u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230rook-ceph-mgr-dashboard-external-http\u7684service\uff0c\u5176\u7c7b\u578b\u662fNodePort\uff0c /Users/beiyiwangdejiyi/k8s-data/rook-v1.6.11/cluster/examples/kubernetes/ceph k apply -f dashboard-external-http.yaml $ k get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE csi-cephfsplugin-metrics ClusterIP 10.97.7.142 <none> 8080/TCP,8081/TCP 579d csi-rbdplugin-metrics ClusterIP 10.97.0.194 <none> 8080/TCP,8081/TCP 579d rook-ceph-mgr ClusterIP 10.97.15.77 <none> 9283/TCP 579d rook-ceph-mgr-dashboard ClusterIP 10.97.4.98 <none> 7000/TCP 579d rook-ceph-mgr-dashboard-external-http NodePort 10.97.10.172 <none> 7000:31926/TCP 8m18s \u9ed8\u8ba4mgr\u521b\u5efa\u4e86\u2f00\u4e2aadmin\u7684\u2f64\u6237\uff0c\u5176\u5bc6\u7801\u5b58\u653e\u5728rook-ceph-dashboard-password\u7684secrets\u5bf9\u8c61\u4e2d\uff0c\u901a\u8fc7\u5982\u4e0b\u2f45\u5f0f\u53ef\u4ee5\u83b7\u53d6\u5230 kubectl get secrets -n rook-ceph rook-ceph-dashboard-password -oyaml apiVersion : v1 data : password : XTBndS0iREN1bE9UMGpQY2JQSSE= # \u91c7\u7528base64\u52a0\u5bc6 kind : Secret metadata : creationTimestamp : \"2020-12-16T18:01:16Z\" name : rook-ceph-dashboard-password namespace : rook-ceph ownerReferences : - apiVersion : ceph.rook.io/v1 blockOwnerDeletion : true controller : true kind : CephCluster name : rook-ceph uid : ee10d125-4428-4e88-983a-53190bc3411c resourceVersion : \"103972533\" uid : 7082d4ad-47bb-46e2-b439-624016cc5f81 type : kubernetes.io/rook base64 \u89e3\u5bc6 $ echo XTBndS0iREN1bE9UMGpQY2JQSSE= | base64 -d ]0gu-\"DCulOT0jPcbPI!% \u6d4b\u8bd5\u767b\u9646 URL: http://106.75.119.241:31926/ \u5e10\u53f7: admin \u5bc6\u7801: ]0gu-\"DCulOT0jPcbPI! \u8fdb\u5165\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e0b\u754c\u9762","title":"Dashbaard \u56fe\u5f62\u7ba1\u7406"},{"location":"5.Storage/rook-ceph/#dashboard-ceph","text":"$ k get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE csi-cephfsplugin-metrics ClusterIP 10.97.7.142 <none> 8080/TCP,8081/TCP 580d csi-rbdplugin-metrics ClusterIP 10.97.0.194 <none> 8080/TCP,8081/TCP 580d rook-ceph-mgr ClusterIP 10.97.15.77 <none> 9283/TCP 580d # \u7ed9prometheus\u4f5c\u4e3a\u5ba2\u6237\u7aef\u4f7f\u7528\u7684 ......","title":"Dashboard \u76d1\u63a7ceph"},{"location":"5.Storage/rook-ceph/#prometheus-operator","text":"kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/v0.40.0/bundle.yaml \u786e\u8ba4prometheus-operator\u5904\u4e8erun\u72b6\u6001 $ k get pod prometheus-operator-7ccf6dfc8-d9dmm 1/1 Running 0 142","title":"\u90e8\u7f72Prometheus Operator"},{"location":"5.Storage/rook-ceph/#prometheus-instances","text":"$ git clone --single-branch --branch v1.6.11 https://github.com/rook/rook.git cd rook/cluster/examples/kubernetes/ceph/monitoring \u521b\u5efa\u670d\u52a1\u76d1\u89c6\u5668\u4ee5\u53ca Prometheus \u670d\u52a1\u5668 pod \u548c\u670d\u52a1 kubectl create -f service-monitor.yaml kubectl create -f prometheus.yaml kubectl create -f prometheus-service.yaml \u672c\u5730\u6d4b\u8bd5\u8bbf\u95ee\uff1a $ k port-forward pod/prometheus-rook-prometheus-0 -n rook-ceph 9090 9090 \u8bbf\u95ee\uff1ahttp://localhost:9090/ grafana\u6d4b\u8bd5\u8bbf\u95ee\uff1a $ k port-forward pod/grafana-cc568dbd8-4nvlq -n infra 3000 80 \u8bbf\u95ee\uff1ahttp://localhost:3000/ \u5e10\u53f7\uff1aadmin \u5bc6\u7801\uff1astrongpassword \u76d1\u63a7\u5c55\u677f Ceph - Cluster\uff1ahttps://grafana.com/grafana/dashboards/2842 Ceph - OSD \uff1a https://grafana.com/grafana/dashboards/5336 Ceph - Pools\uff1a https://grafana.com/grafana/dashboards/5342","title":"\u90e8\u7f72Prometheus Instances"},{"location":"5.Storage/rook-ceph/#_4","text":"","title":"\u5bf9\u8c61\u5b58\u50a8"},{"location":"5.Storage/rook-ceph/#rgw","text":"$ k apply -f object.yaml [ ucloud ] root@master0:~/.kube# kubectl get svc -n rook-ceph NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE csi-rbdplugin-metrics ClusterIP 10 .43.40.164 <none> 8080 /TCP,8081/TCP 7d4h csi-cephfsplugin-metrics ClusterIP 10 .43.170.151 <none> 8080 /TCP,8081/TCP 7d4h rook-ceph-mon-a ClusterIP 10 .43.248.216 <none> 6789 /TCP,3300/TCP 7d4h rook-ceph-mon-b ClusterIP 10 .43.174.200 <none> 6789 /TCP,3300/TCP 7d4h rook-ceph-mon-c ClusterIP 10 .43.9.21 <none> 6789 /TCP,3300/TCP 7d4h rook-ceph-mgr-dashboard ClusterIP 10 .43.193.31 <none> 8443 /TCP 7d4h rook-ceph-mgr ClusterIP 10 .43.114.15 <none> 9283 /TCP 7d4h wordpress-mysql ClusterIP None <none> 3306 /TCP 7d3h rook-prometheus NodePort 10 .43.128.1 <none> 9090 :30900/TCP 3d prometheus-operated ClusterIP None <none> 9090 /TCP 3d rook-ceph-rgw-my-store ClusterIP 10 .43.73.235 <none> 80 /TCP 18m [ ucloud ] root@master0:~/.kube# curl http://10.43.73.235 <?xml version = \"1.0\" encoding = \"UTF-8\" ?><ListAllMyBucketsResult xmlns = \"http://s3.amazonaws.com/doc/2006-03-01/\" ><Owner><ID>anonymous</ID><DisplayName></DisplayName></Owner><Buckets></Buckets></ListAllMyBucketsResult> [ ucloud ] root@master0:~/.kube#","title":"\u90e8\u7f72RGW\u5bf9\u8c61\u5b58\u50a8"},{"location":"5.Storage/rook-ceph/#rgw_1","text":"$ vim object.yaml 54 instances: 2","title":"RGW\u9ad8\u53ef\u7528"},{"location":"5.Storage/rook-ceph/#bucket","text":"\u521b\u5efastorageclass $ k apply -f storageclass-bucket-delete.yaml storageclass.storage.k8s.io/rook-ceph-delete-bucket created \u521b\u5efabucket $ k apply -f object-bucket-claim-delete.yaml objectbucketclaim.objectbucket.io/ceph-delete-bucket created","title":"\u521b\u5efaBucket"},{"location":"5.Storage/rook-ceph/#_5","text":"\u83b7\u53d6ceph-rgw\u7684\u8bbf\u95ee\u5730\u5740 $ k get cm ceph-delete-bucket -o yaml apiVersion : v1 data : BUCKET_HOST : rook-ceph-rgw-my-store.rook-ceph.svc BUCKET_NAME : ceph-bkt-148b1fa5-7868-42e5-8135-383d357c41cd BUCKET_PORT : \"80\" BUCKET_REGION : us-east-1 BUCKET_SUBREGION : \"\" kind : ConfigMap metadata : creationTimestamp : \"2022-08-05T08:24:27Z\" finalizers : - objectbucket.io/finalizer labels : bucket-provisioner : rook-ceph.ceph.rook.io-bucket name : ceph-delete-bucket namespace : rook-ceph ownerReferences : - apiVersion : objectbucket.io/v1alpha1 blockOwnerDeletion : true controller : true kind : ObjectBucketClaim name : ceph-delete-bucket uid : a8c69ebc-1e4d-477c-97e7-479b532962b3 resourceVersion : \"1282724\" uid : 26786f4b-9371-46fa-8ca9-f470e5e92cb2 \u62ff\u5230secrets $ k get secrets ceph-delete-bucket -o yaml apiVersion : v1 data : AWS_ACCESS_KEY_ID : Rk9JSjBJNlg0NDVNUVVMVkpGMzc= AWS_SECRET_ACCESS_KEY : SVdjaElaeVdUbTNGNkRyZ29UcUQ0R1gzOVlhczR4S1ZmWExERHNYeA== kind : Secret metadata : creationTimestamp : \"2022-08-05T08:24:27Z\" finalizers : - objectbucket.io/finalizer labels : bucket-provisioner : rook-ceph.ceph.rook.io-bucket name : ceph-delete-bucket namespace : rook-ceph ownerReferences : - apiVersion : objectbucket.io/v1alpha1 blockOwnerDeletion : true controller : true kind : ObjectBucketClaim name : ceph-delete-bucket uid : a8c69ebc-1e4d-477c-97e7-479b532962b3 resourceVersion : \"1282723\" uid : 1b0af759-7c7d-4fe4-9a80-ea2615fa8fef type : Opaque base64 \u89e3\u5bc6 $ echo Rk9JSjBJNlg0NDVNUVVMVkpGMzc = | base64 -d FOIJ0I6X445MQULVJF37% # beiyiwangdejiyi @ beiyiwangdejiyideMacBook-Pro in ~/note-work/hugo on git:main x [14:28:13] $ echo SVdjaElaeVdUbTNGNkRyZ29UcUQ0R1gzOVlhczR4S1ZmWExERHNYeA == | base64 -d IWchIZyWTm3F6DrgoTqD4GX39Yas4xKVfXLDDsXx% fio --name=sequential-read --directory=/config --rw=read --refill_buffers --bs=4K --size=200M root@nginx-run-685fdf6467-mdl9v:/# fio --name = sequential-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M sequential-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process sequential-read: Laying out IO file ( 1 file / 200MiB ) sequential-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 723 : Wed Aug 10 06 :28:37 2022 read: IOPS = 98 .8k, BW = 386MiB/s ( 405MB/s )( 200MiB/518msec ) clat ( nsec ) : min = 378 , max = 86956k, avg = 9833 .73, stdev = 534902 .03 lat ( nsec ) : min = 411 , max = 86956k, avg = 9868 .39, stdev = 534902 .42 clat percentiles ( nsec ) : | 1 .00th =[ 398 ] , 5 .00th =[ 486 ] , 10 .00th =[ 532 ] , | 20 .00th =[ 556 ] , 30 .00th =[ 580 ] , 40 .00th =[ 604 ] , | 50 .00th =[ 628 ] , 60 .00th =[ 644 ] , 70 .00th =[ 668 ] , | 80 .00th =[ 708 ] , 90 .00th =[ 804 ] , 95 .00th =[ 932 ] , | 99 .00th =[ 70144 ] , 99 .50th =[ 102912 ] , 99 .90th =[ 456704 ] , | 99 .95th =[ 1253376 ] , 99 .99th =[ 26083328 ] bw ( KiB/s ) : min = 401376 , max = 401376 , per = 100 .00%, avg = 401376 .00, stdev = 0 .00, samples = 1 iops : min = 100344 , max = 100344 , avg = 100344 .00, stdev = 0 .00, samples = 1 lat ( nsec ) : 500 = 5 .72%, 750 = 80 .66%, 1000 = 9 .78% lat ( usec ) : 2 = 1 .74%, 4 = 0 .06%, 10 = 0 .17%, 20 = 0 .06%, 50 = 0 .11% lat ( usec ) : 100 = 1 .17%, 250 = 0 .37%, 500 = 0 .07%, 750 = 0 .02%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .02%, 4 = 0 .01%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01% cpu : usr = 3 .29%, sys = 17 .02%, ctx = 571 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 386MiB/s ( 405MB/s ) , 386MiB/s-386MiB/s ( 405MB/s-405MB/s ) , io = 200MiB ( 210MB ) , run = 518 -518msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = sequential-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M sequential-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process sequential-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 729 : Wed Aug 10 06 :30:48 2022 read: IOPS = 344k, BW = 1342MiB/s ( 1407MB/s )( 200MiB/149msec ) clat ( nsec ) : min = 375 , max = 7097 .8k, avg = 2339 .11, stdev = 39079 .52 lat ( nsec ) : min = 406 , max = 7097 .8k, avg = 2372 .97, stdev = 39080 .14 clat percentiles ( nsec ) : | 1 .00th =[ 406 ] , 5 .00th =[ 524 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 588 ] , 40 .00th =[ 612 ] , | 50 .00th =[ 628 ] , 60 .00th =[ 644 ] , 70 .00th =[ 668 ] , | 80 .00th =[ 700 ] , 90 .00th =[ 748 ] , 95 .00th =[ 868 ] , | 99 .00th =[ 67072 ] , 99 .50th =[ 73216 ] , 99 .90th =[ 114176 ] , | 99 .95th =[ 156672 ] , 99 .99th =[ 1122304 ] lat ( nsec ) : 500 = 2 .29%, 750 = 87 .79%, 1000 = 7 .05% lat ( usec ) : 2 = 0 .96%, 4 = 0 .01%, 10 = 0 .15%, 20 = 0 .04%, 50 = 0 .11% lat ( usec ) : 100 = 1 .42%, 250 = 0 .15%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% lat ( msec ) : 2 = 0 .02%, 4 = 0 .01%, 10 = 0 .01% cpu : usr = 25 .68%, sys = 49 .32%, ctx = 335 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 1342MiB/s ( 1407MB/s ) , 1342MiB/s-1342MiB/s ( 1407MB/s-1407MB/s ) , io = 200MiB ( 210MB ) , run = 149 -149msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = big-file-multi-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.25 Starting 6 processes big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) big-file-multi-read: Laying out IO file ( 1 file / 200MiB ) Jobs: 2 ( f = 2 ) : [ _ ( 4 ) ,R ( 2 )][ 100 .0% ][ r = 264MiB/s ][ r = 67 .7k IOPS ][ eta 00m:00s ] big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 732 : Wed Aug 10 06 :32:40 2022 read: IOPS = 11 .1k, BW = 43 .5MiB/s ( 45 .6MB/s )( 200MiB/4602msec ) clat ( nsec ) : min = 377 , max = 522247k, avg = 89494 .70, stdev = 4682750 .76 lat ( nsec ) : min = 408 , max = 522247k, avg = 89553 .19, stdev = 4682751 .34 clat percentiles ( nsec ) : | 1 .00th =[ 414 ] , 5 .00th =[ 516 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 620 ] , 40 .00th =[ 660 ] , | 50 .00th =[ 692 ] , 60 .00th =[ 732 ] , 70 .00th =[ 796 ] , | 80 .00th =[ 884 ] , 90 .00th =[ 1020 ] , 95 .00th =[ 1192 ] , | 99 .00th =[ 83456 ] , 99 .50th =[ 218112 ] , 99 .90th =[ 5144576 ] , | 99 .95th =[ 20578304 ] , 99 .99th =[ 240123904 ] bw ( KiB/s ) : min = 14080 , max = 90112 , per = 18 .59%, avg = 45625 .50, stdev = 27571 .34, samples = 8 iops : min = 3520 , max = 22528 , avg = 11406 .37, stdev = 6892 .84, samples = 8 lat ( nsec ) : 500 = 3 .47%, 750 = 60 .05%, 1000 = 25 .67% lat ( usec ) : 2 = 8 .49%, 4 = 0 .21%, 10 = 0 .15%, 20 = 0 .08%, 50 = 0 .07% lat ( usec ) : 100 = 1 .00%, 250 = 0 .33%, 500 = 0 .14%, 750 = 0 .07%, 1000 = 0 .04% lat ( msec ) : 2 = 0 .06%, 4 = 0 .04%, 10 = 0 .05%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .02%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .59%, sys = 2 .00%, ctx = 671 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 733 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .7k, BW = 41 .9MiB/s ( 43 .9MB/s )( 200MiB/4776msec ) clat ( nsec ) : min = 376 , max = 734234k, avg = 92901 .06, stdev = 5934361 .60 lat ( nsec ) : min = 411 , max = 734234k, avg = 92951 .67, stdev = 5934362 .28 clat percentiles ( nsec ) : | 1 .00th =[ 402 ] , 5 .00th =[ 516 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 588 ] , 30 .00th =[ 636 ] , 40 .00th =[ 684 ] , | 50 .00th =[ 732 ] , 60 .00th =[ 788 ] , 70 .00th =[ 860 ] , | 80 .00th =[ 940 ] , 90 .00th =[ 1080 ] , 95 .00th =[ 1272 ] , | 99 .00th =[ 91648 ] , 99 .50th =[ 193536 ] , 99 .90th =[ 3981312 ] , | 99 .95th =[ 27131904 ] , 99 .99th =[ 233832448 ] bw ( KiB/s ) : min = 8192 , max = 98304 , per = 19 .42%, avg = 47655 .75, stdev = 31431 .05, samples = 8 iops : min = 2048 , max = 24576 , avg = 11913 .88, stdev = 7857 .79, samples = 8 lat ( nsec ) : 500 = 3 .87%, 750 = 50 .45%, 1000 = 31 .27% lat ( usec ) : 2 = 12 .03%, 4 = 0 .18%, 10 = 0 .15%, 20 = 0 .07%, 50 = 0 .06% lat ( usec ) : 100 = 1 .02%, 250 = 0 .48%, 500 = 0 .15%, 750 = 0 .05%, 1000 = 0 .04% lat ( msec ) : 2 = 0 .05%, 4 = 0 .02%, 10 = 0 .03%, 20 = 0 .02%, 50 = 0 .02% lat ( msec ) : 100 = 0 .02%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .44%, sys = 2 .07%, ctx = 845 , majf = 0 , minf = 17 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 734 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .9k, BW = 42 .6MiB/s ( 44 .7MB/s )( 200MiB/4696msec ) clat ( nsec ) : min = 379 , max = 607583k, avg = 91313 .18, stdev = 4982310 .93 lat ( nsec ) : min = 412 , max = 607583k, avg = 91361 .07, stdev = 4982311 .06 clat percentiles ( nsec ) : | 1 .00th =[ 410 ] , 5 .00th =[ 516 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 620 ] , 40 .00th =[ 660 ] , | 50 .00th =[ 700 ] , 60 .00th =[ 740 ] , 70 .00th =[ 804 ] , | 80 .00th =[ 900 ] , 90 .00th =[ 1048 ] , 95 .00th =[ 1240 ] , | 99 .00th =[ 78336 ] , 99 .50th =[ 130560 ] , 99 .90th =[ 4882432 ] , | 99 .95th =[ 14483456 ] , 99 .99th =[ 254803968 ] bw ( KiB/s ) : min = 7680 , max = 90112 , per = 17 .01%, avg = 41739 .89, stdev = 24407 .57, samples = 9 iops : min = 1920 , max = 22528 , avg = 10434 .89, stdev = 6101 .90, samples = 9 lat ( nsec ) : 500 = 3 .93%, 750 = 58 .07%, 1000 = 25 .64% lat ( usec ) : 2 = 10 .13%, 4 = 0 .22%, 10 = 0 .13%, 20 = 0 .04%, 50 = 0 .08% lat ( usec ) : 100 = 1 .10%, 250 = 0 .34%, 500 = 0 .08%, 750 = 0 .04%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .04%, 4 = 0 .03%, 10 = 0 .04%, 20 = 0 .02%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .72%, sys = 1 .81%, ctx = 502 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 735 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .6k, BW = 41 .5MiB/s ( 43 .5MB/s )( 200MiB/4822msec ) clat ( nsec ) : min = 374 , max = 700599k, avg = 93757 .53, stdev = 5099889 .71 lat ( nsec ) : min = 413 , max = 700599k, avg = 93803 .83, stdev = 5099890 .00 clat percentiles ( nsec ) : | 1 .00th =[ 430 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 620 ] , 40 .00th =[ 660 ] , | 50 .00th =[ 692 ] , 60 .00th =[ 732 ] , 70 .00th =[ 804 ] , | 80 .00th =[ 900 ] , 90 .00th =[ 1048 ] , 95 .00th =[ 1256 ] , | 99 .00th =[ 91648 ] , 99 .50th =[ 226304 ] , 99 .90th =[ 5931008 ] , | 99 .95th =[ 24248320 ] , 99 .99th =[ 235929600 ] bw ( KiB/s ) : min = 6520 , max = 65536 , per = 15 .07%, avg = 36989 .89, stdev = 18379 .13, samples = 9 iops : min = 1630 , max = 16384 , avg = 9247 .44, stdev = 4594 .77, samples = 9 lat ( nsec ) : 500 = 3 .74%, 750 = 59 .39%, 1000 = 24 .25% lat ( usec ) : 2 = 10 .19%, 4 = 0 .22%, 10 = 0 .18%, 20 = 0 .08%, 50 = 0 .08% lat ( usec ) : 100 = 0 .96%, 250 = 0 .43%, 500 = 0 .14%, 750 = 0 .07%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .06%, 4 = 0 .04%, 10 = 0 .06%, 20 = 0 .02%, 50 = 0 .02% lat ( msec ) : 100 = 0 .01%, 250 = 0 .02%, 500 = 0 .01%, 750 = 0 .01% cpu : usr = 0 .21%, sys = 2 .24%, ctx = 874 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 736 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .2k, BW = 39 .9MiB/s ( 41 .9MB/s )( 200MiB/5008msec ) clat ( nsec ) : min = 377 , max = 806541k, avg = 97234 .58, stdev = 6320832 .41 lat ( nsec ) : min = 414 , max = 806541k, avg = 97345 .92, stdev = 6320844 .03 clat percentiles ( nsec ) : | 1 .00th =[ 402 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 612 ] , 40 .00th =[ 652 ] , | 50 .00th =[ 684 ] , 60 .00th =[ 724 ] , 70 .00th =[ 772 ] , | 80 .00th =[ 868 ] , 90 .00th =[ 1032 ] , 95 .00th =[ 1240 ] , | 99 .00th =[ 80384 ] , 99 .50th =[ 154624 ] , 99 .90th =[ 5275648 ] , | 99 .95th =[ 20054016 ] , 99 .99th =[ 200278016 ] bw ( KiB/s ) : min = 8192 , max = 49152 , per = 12 .40%, avg = 30434 .00, stdev = 15445 .75, samples = 9 iops : min = 2048 , max = 12288 , avg = 7608 .44, stdev = 3861 .51, samples = 9 lat ( nsec ) : 500 = 3 .77%, 750 = 62 .98%, 1000 = 22 .07% lat ( usec ) : 2 = 8 .67%, 4 = 0 .18%, 10 = 0 .26%, 20 = 0 .12%, 50 = 0 .12% lat ( usec ) : 100 = 1 .05%, 250 = 0 .40%, 500 = 0 .11%, 750 = 0 .04%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .05%, 4 = 0 .04%, 10 = 0 .03%, 20 = 0 .03%, 50 = 0 .02% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% cpu : usr = 0 .46%, sys = 1 .96%, ctx = 787 , majf = 0 , minf = 17 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 737 : Wed Aug 10 06 :32:40 2022 read: IOPS = 10 .3k, BW = 40 .2MiB/s ( 42 .1MB/s )( 200MiB/4977msec ) clat ( nsec ) : min = 378 , max = 894860k, avg = 96613 .11, stdev = 5799729 .12 lat ( nsec ) : min = 413 , max = 894860k, avg = 96658 .78, stdev = 5799729 .19 clat percentiles ( nsec ) : | 1 .00th =[ 398 ] , 5 .00th =[ 506 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 612 ] , 40 .00th =[ 644 ] , | 50 .00th =[ 676 ] , 60 .00th =[ 716 ] , 70 .00th =[ 764 ] , | 80 .00th =[ 852 ] , 90 .00th =[ 988 ] , 95 .00th =[ 1176 ] , | 99 .00th =[ 87552 ] , 99 .50th =[ 216064 ] , 99 .90th =[ 6848512 ] , | 99 .95th =[ 31064064 ] , 99 .99th =[ 231735296 ] bw ( KiB/s ) : min = 16929 , max = 69632 , per = 14 .42%, avg = 35383 .25, stdev = 17459 .47, samples = 8 iops : min = 4232 , max = 17408 , avg = 8845 .75, stdev = 4364 .90, samples = 8 lat ( nsec ) : 500 = 4 .66%, 750 = 63 .16%, 1000 = 22 .55% lat ( usec ) : 2 = 7 .10%, 4 = 0 .20%, 10 = 0 .27%, 20 = 0 .09%, 50 = 0 .11% lat ( usec ) : 100 = 0 .99%, 250 = 0 .44%, 500 = 0 .12%, 750 = 0 .07%, 1000 = 0 .04% lat ( msec ) : 2 = 0 .06%, 4 = 0 .04%, 10 = 0 .03%, 20 = 0 .03%, 50 = 0 .01% lat ( msec ) : 100 = 0 .02%, 250 = 0 .02%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% cpu : usr = 0 .32%, sys = 2 .05%, ctx = 1006 , majf = 0 , minf = 17 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 240MiB/s ( 251MB/s ) , 39 .9MiB/s-43.5MiB/s ( 41 .9MB/s-45.6MB/s ) , io = 1200MiB ( 1258MB ) , run = 4602 -5008msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = big-file-multi-read --directory = /config --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.25 Starting 6 processes Jobs: 3 ( f = 3 ) : [ _ ( 1 ) ,R ( 1 ) ,_ ( 1 ) ,R ( 1 ) ,_ ( 1 ) ,R ( 1 )][ 80 .0% ][ r = 172MiB/s ][ r = 44 .1k IOPS ][ eta 00m:02s ] big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 740 : Wed Aug 10 06 :34:00 2022 read: IOPS = 8276 , BW = 32 .3MiB/s ( 33 .9MB/s )( 200MiB/6186msec ) clat ( nsec ) : min = 378 , max = 805881k, avg = 120250 .60, stdev = 7449083 .91 lat ( nsec ) : min = 410 , max = 805881k, avg = 120301 .98, stdev = 7449084 .14 clat percentiles ( nsec ) : | 1 .00th =[ 422 ] , 5 .00th =[ 532 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 580 ] , 30 .00th =[ 612 ] , 40 .00th =[ 636 ] , | 50 .00th =[ 660 ] , 60 .00th =[ 684 ] , 70 .00th =[ 716 ] , | 80 .00th =[ 748 ] , 90 .00th =[ 860 ] , 95 .00th =[ 996 ] , | 99 .00th =[ 77312 ] , 99 .50th =[ 132096 ] , 99 .90th =[ 1318912 ] , | 99 .95th =[ 10289152 ] , 99 .99th =[ 434110464 ] bw ( KiB/s ) : min = 8192 , max = 65536 , per = 23 .93%, avg = 35045 .82, stdev = 25507 .11, samples = 11 iops : min = 2048 , max = 16384 , avg = 8761 .45, stdev = 6376 .78, samples = 11 lat ( nsec ) : 500 = 2 .40%, 750 = 77 .33%, 1000 = 15 .36% lat ( usec ) : 2 = 2 .64%, 4 = 0 .06%, 10 = 0 .18%, 20 = 0 .11%, 50 = 0 .13% lat ( usec ) : 100 = 1 .11%, 250 = 0 .39%, 500 = 0 .09%, 750 = 0 .05%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .03%, 4 = 0 .02%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% cpu : usr = 0 .34%, sys = 1 .62%, ctx = 845 , majf = 0 , minf = 14 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 741 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6102 , BW = 23 .8MiB/s ( 24 .0MB/s )( 200MiB/8390msec ) clat ( nsec ) : min = 379 , max = 1190 .5M, avg = 162758 .58, stdev = 11051920 .43 lat ( nsec ) : min = 413 , max = 1190 .5M, avg = 162807 .90, stdev = 11051920 .69 clat percentiles ( nsec ) : | 1 .00th =[ 410 ] , 5 .00th =[ 524 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 604 ] , 40 .00th =[ 636 ] , | 50 .00th =[ 668 ] , 60 .00th =[ 700 ] , 70 .00th =[ 724 ] , | 80 .00th =[ 764 ] , 90 .00th =[ 876 ] , 95 .00th =[ 1004 ] , | 99 .00th =[ 78336 ] , 99 .50th =[ 156672 ] , 99 .90th =[ 1073152 ] , | 99 .95th =[ 5275648 ] , 99 .99th =[ 616562688 ] bw ( KiB/s ) : min = 512 , max = 73728 , per = 20 .69%, avg = 30307 .20, stdev = 21673 .33, samples = 10 iops : min = 128 , max = 18432 , avg = 7576 .80, stdev = 5418 .33, samples = 10 lat ( nsec ) : 500 = 2 .76%, 750 = 73 .76%, 1000 = 18 .35% lat ( usec ) : 2 = 2 .79%, 4 = 0 .04%, 10 = 0 .22%, 20 = 0 .13%, 50 = 0 .14% lat ( usec ) : 100 = 1 .05%, 250 = 0 .42%, 500 = 0 .14%, 750 = 0 .05%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .04%, 4 = 0 .02%, 10 = 0 .02%, 20 = 0 .01%, 100 = 0 .01% lat ( msec ) : 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 2000 = 0 .01% cpu : usr = 0 .33%, sys = 1 .10%, ctx = 982 , majf = 0 , minf = 16 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 742 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6906 , BW = 26 .0MiB/s ( 28 .3MB/s )( 200MiB/7413msec ) clat ( nsec ) : min = 380 , max = 1034 .3M, avg = 144218 .03, stdev = 9148025 .05 lat ( nsec ) : min = 414 , max = 1034 .3M, avg = 144254 .80, stdev = 9148025 .00 clat percentiles ( nsec ) : | 1 .00th =[ 406 ] , 5 .00th =[ 524 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 596 ] , 40 .00th =[ 620 ] , | 50 .00th =[ 652 ] , 60 .00th =[ 676 ] , 70 .00th =[ 708 ] , | 80 .00th =[ 748 ] , 90 .00th =[ 860 ] , 95 .00th =[ 988 ] , | 99 .00th =[ 78336 ] , 99 .50th =[ 146432 ] , 99 .90th =[ 1253376 ] , | 99 .95th =[ 4620288 ] , 99 .99th =[ 522190848 ] bw ( KiB/s ) : min = 16384 , max = 73728 , per = 26 .85%, avg = 39318 .40, stdev = 23491 .33, samples = 10 iops : min = 4096 , max = 18432 , avg = 9829 .60, stdev = 5872 .83, samples = 10 lat ( nsec ) : 500 = 3 .29%, 750 = 76 .66%, 1000 = 15 .22% lat ( usec ) : 2 = 2 .43%, 4 = 0 .10%, 10 = 0 .23%, 20 = 0 .12%, 50 = 0 .12% lat ( usec ) : 100 = 1 .13%, 250 = 0 .37%, 500 = 0 .13%, 750 = 0 .05%, 1000 = 0 .03% lat ( msec ) : 2 = 0 .04%, 4 = 0 .02%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% lat ( msec ) : 2000 = 0 .01% cpu : usr = 0 .32%, sys = 1 .32%, ctx = 864 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 743 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6106 , BW = 23 .9MiB/s ( 25 .0MB/s )( 200MiB/8385msec ) clat ( nsec ) : min = 380 , max = 1507 .9M, avg = 162772 .24, stdev = 13174473 .96 lat ( nsec ) : min = 414 , max = 1507 .9M, avg = 162810 .08, stdev = 13174473 .94 clat percentiles ( nsec ) : | 1 .00th =[ 398 ] , 5 .00th =[ 510 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 604 ] , 40 .00th =[ 636 ] , | 50 .00th =[ 668 ] , 60 .00th =[ 692 ] , 70 .00th =[ 724 ] , | 80 .00th =[ 764 ] , 90 .00th =[ 876 ] , 95 .00th =[ 1012 ] , | 99 .00th =[ 79360 ] , 99 .50th =[ 136192 ] , 99 .90th =[ 897024 ] , | 99 .95th =[ 2506752 ] , 99 .99th =[ 434110464 ] bw ( KiB/s ) : min = 8 , max = 81920 , per = 20 .70%, avg = 30310 .40, stdev = 22461 .38, samples = 10 iops : min = 2 , max = 20480 , avg = 7577 .60, stdev = 5615 .35, samples = 10 lat ( nsec ) : 500 = 4 .29%, 750 = 73 .14%, 1000 = 17 .30% lat ( usec ) : 2 = 2 .94%, 4 = 0 .04%, 10 = 0 .22%, 20 = 0 .07%, 50 = 0 .19% lat ( usec ) : 100 = 1 .10%, 250 = 0 .44%, 500 = 0 .11%, 750 = 0 .05%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .03%, 4 = 0 .01%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 2000 = 0 .01% cpu : usr = 0 .05%, sys = 1 .40%, ctx = 993 , majf = 0 , minf = 14 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 744 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6911 , BW = 26 .0MiB/s ( 28 .3MB/s )( 200MiB/7408msec ) clat ( nsec ) : min = 381 , max = 1179 .3M, avg = 143994 .58, stdev = 11079777 .48 lat ( nsec ) : min = 413 , max = 1179 .3M, avg = 144029 .70, stdev = 11079777 .45 clat percentiles ( nsec ) : | 1 .00th =[ 406 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 580 ] , 40 .00th =[ 612 ] , | 50 .00th =[ 636 ] , 60 .00th =[ 668 ] , 70 .00th =[ 692 ] , | 80 .00th =[ 732 ] , 90 .00th =[ 836 ] , 95 .00th =[ 956 ] , | 99 .00th =[ 76288 ] , 99 .50th =[ 111104 ] , 99 .90th =[ 995328 ] , | 99 .95th =[ 3227648 ] , 99 .99th =[ 742391808 ] bw ( KiB/s ) : min = 5040 , max = 73728 , per = 22 .93%, avg = 33587 .20, stdev = 27492 .28, samples = 10 iops : min = 1260 , max = 18432 , avg = 8396 .80, stdev = 6873 .07, samples = 10 lat ( nsec ) : 500 = 3 .81%, 750 = 78 .93%, 1000 = 13 .08% lat ( usec ) : 2 = 2 .02%, 4 = 0 .02%, 10 = 0 .21%, 20 = 0 .07%, 50 = 0 .12% lat ( usec ) : 100 = 1 .15%, 250 = 0 .36%, 500 = 0 .07%, 750 = 0 .04%, 1000 = 0 .02% lat ( msec ) : 2 = 0 .04%, 4 = 0 .02%, 10 = 0 .01%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01%, 2000 = 0 .01% cpu : usr = 0 .26%, sys = 1 .35%, ctx = 724 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 745 : Wed Aug 10 06 :34:00 2022 read: IOPS = 6238 , BW = 24 .4MiB/s ( 25 .6MB/s )( 200MiB/8207msec ) clat ( nsec ) : min = 379 , max = 1170 .8M, avg = 159639 .78, stdev = 10672683 .50 lat ( nsec ) : min = 413 , max = 1170 .8M, avg = 159675 .27, stdev = 10672683 .47 clat percentiles ( nsec ) : | 1 .00th =[ 410 ] , 5 .00th =[ 516 ] , 10 .00th =[ 540 ] , | 20 .00th =[ 572 ] , 30 .00th =[ 596 ] , 40 .00th =[ 628 ] , | 50 .00th =[ 652 ] , 60 .00th =[ 684 ] , 70 .00th =[ 716 ] , | 80 .00th =[ 764 ] , 90 .00th =[ 876 ] , 95 .00th =[ 1012 ] , | 99 .00th =[ 77312 ] , 99 .50th =[ 156672 ] , 99 .90th =[ 1810432 ] , | 99 .95th =[ 5865472 ] , 99 .99th =[ 616562688 ] bw ( KiB/s ) : min = 6400 , max = 74752 , per = 18 .50%, avg = 27096 .62, stdev = 22310 .47, samples = 13 iops : min = 1600 , max = 18688 , avg = 6774 .15, stdev = 5577 .62, samples = 13 lat ( nsec ) : 500 = 4 .00%, 750 = 74 .22%, 1000 = 16 .52% lat ( usec ) : 2 = 3 .01%, 4 = 0 .05%, 10 = 0 .19%, 20 = 0 .07%, 50 = 0 .11% lat ( usec ) : 100 = 1 .06%, 250 = 0 .40%, 500 = 0 .14%, 750 = 0 .05%, 1000 = 0 .05% lat ( msec ) : 2 = 0 .04%, 4 = 0 .03%, 10 = 0 .03%, 20 = 0 .01%, 50 = 0 .01% lat ( msec ) : 100 = 0 .01%, 250 = 0 .01%, 500 = 0 .01%, 750 = 0 .01%, 1000 = 0 .01% lat ( msec ) : 2000 = 0 .01% cpu : usr = 0 .26%, sys = 1 .22%, ctx = 949 , majf = 0 , minf = 15 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 51200 ,0,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : READ: bw = 143MiB/s ( 150MB/s ) , 23 .8MiB/s-32.3MiB/s ( 24 .0MB/s-33.9MB/s ) , io = 1200MiB ( 1258MB ) , run = 6186 -8390msec fio --name=sequential-write --directory=/config --rw=write --refill_buffers --bs=4K --size=200M --end_fsync=1 fio --name=big-file-multi-read --directory=$PWD --rw=read --refill_buffers --bs=4K --size=200M --numjobs=6 fio --name=sequential-write --directory=/config --rw=write --refill_buffers --bs=4K --size=200M --end_fsync=1 root@nginx-run-685fdf6467-mdl9v:/config# fio --name = sequential-write --directory = /config --rw = write --refill_buffers --bs = 4K --size = 200M --end_fsync = 1 sequential-write: ( g = 0 ) : rw = write, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process sequential-write: Laying out IO file ( 1 file / 200MiB ) Jobs: 1 ( f = 1 ) sequential-write: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 756 : Wed Aug 10 06 :39:40 2022 write: IOPS = 33 .6k, BW = 131MiB/s ( 138MB/s )( 200MiB/1525msec ) ; 0 zone resets clat ( usec ) : min = 7 , max = 7420 , avg = 27 .69, stdev = 125 .85 lat ( usec ) : min = 7 , max = 7420 , avg = 27 .76, stdev = 125 .85 clat percentiles ( usec ) : | 1 .00th =[ 8 ] , 5 .00th =[ 9 ] , 10 .00th =[ 11 ] , 20 .00th =[ 12 ] , | 30 .00th =[ 20 ] , 40 .00th =[ 21 ] , 50 .00th =[ 22 ] , 60 .00th =[ 22 ] , | 70 .00th =[ 23 ] , 80 .00th =[ 24 ] , 90 .00th =[ 28 ] , 95 .00th =[ 37 ] , | 99 .00th =[ 118 ] , 99 .50th =[ 285 ] , 99 .90th =[ 1860 ] , 99 .95th =[ 3097 ] , | 99 .99th =[ 4752 ] bw ( KiB/s ) : min = 132286 , max = 138088 , per = 100 .00%, avg = 135187 .00, stdev = 4102 .63, samples = 2 iops : min = 33071 , max = 34522 , avg = 33796 .50, stdev = 1026 .01, samples = 2 lat ( usec ) : 10 = 9 .54%, 20 = 24 .43%, 50 = 63 .08%, 100 = 1 .75%, 250 = 0 .66% lat ( usec ) : 500 = 0 .22%, 750 = 0 .09%, 1000 = 0 .05% lat ( msec ) : 2 = 0 .10%, 4 = 0 .07%, 10 = 0 .03% cpu : usr = 9 .84%, sys = 31 .04%, ctx = 51905 , majf = 0 , minf = 12 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,51200,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : WRITE: bw = 131MiB/s ( 138MB/s ) , 131MiB/s-131MiB/s ( 138MB/s-138MB/s ) , io = 200MiB ( 210MB ) , run = 1525 -1525msec root@nginx-run-685fdf6467-mdl9v:/config# fio --name = sequential-write --directory = /config --rw = write --refill_buffers --bs = 4K --size = 200M --end_fsync = 1 sequential-write: ( g = 0 ) : rw = write, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 fio-3.25 Starting 1 process Jobs: 1 ( f = 1 ) sequential-write: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 759 : Wed Aug 10 06 :41:20 2022 write: IOPS = 31 .3k, BW = 122MiB/s ( 128MB/s )( 200MiB/1637msec ) ; 0 zone resets clat ( usec ) : min = 7 , max = 9234 , avg = 30 .16, stdev = 137 .54 lat ( usec ) : min = 7 , max = 9234 , avg = 30 .21, stdev = 137 .54 clat percentiles ( usec ) : | 1 .00th =[ 8 ] , 5 .00th =[ 9 ] , 10 .00th =[ 11 ] , 20 .00th =[ 18 ] , | 30 .00th =[ 20 ] , 40 .00th =[ 21 ] , 50 .00th =[ 22 ] , 60 .00th =[ 22 ] , | 70 .00th =[ 23 ] , 80 .00th =[ 24 ] , 90 .00th =[ 29 ] , 95 .00th =[ 41 ] , | 99 .00th =[ 147 ] , 99 .50th =[ 379 ] , 99 .90th =[ 2311 ] , 99 .95th =[ 3064 ] , | 99 .99th =[ 4490 ] bw ( KiB/s ) : min = 119544 , max = 132640 , per = 100 .00%, avg = 128018 .67, stdev = 7349 .32, samples = 3 iops : min = 29886 , max = 33160 , avg = 32004 .67, stdev = 1837 .33, samples = 3 lat ( usec ) : 10 = 7 .32%, 20 = 25 .16%, 50 = 63 .95%, 100 = 2 .08%, 250 = 0 .85% lat ( usec ) : 500 = 0 .23%, 750 = 0 .09%, 1000 = 0 .08% lat ( msec ) : 2 = 0 .12%, 4 = 0 .11%, 10 = 0 .02% cpu : usr = 7 .21%, sys = 32 .64%, ctx = 51971 , majf = 0 , minf = 13 IO depths : 1 = 100 .0%, 2 = 0 .0%, 4 = 0 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, > = 64 = 0 .0% submit : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% complete : 0 = 0 .0%, 4 = 100 .0%, 8 = 0 .0%, 16 = 0 .0%, 32 = 0 .0%, 64 = 0 .0%, > = 64 = 0 .0% issued rwts: total = 0 ,51200,0,0 short = 0 ,0,0,0 dropped = 0 ,0,0,0 latency : target = 0 , window = 0 , percentile = 100 .00%, depth = 1 Run status group 0 ( all jobs ) : WRITE: bw = 122MiB/s ( 128MB/s ) , 122MiB/s-122MiB/s ( 128MB/s-128MB/s ) , io = 200MiB ( 210MB ) , run = 1637 -1637msec fio --name=big-file-multi-write --directory=/config --rw=write --refill_buffers --bs=4K --size=200M --numjobs=6 --end_fsync=1 fio -filename=/config/fio.img -direct=1 -iodepth 32 -thread -rw=randread -ioengine=libaio -bs=4k -size=200m -numjobs=2 -runtime=60 -group_reporting -name=mytest \u56fa\u6001\u5bbf\u4e3b\u673a\uff1a [ ucloud ] root@node1:/var/jfsCache# fio --name = big-file-multi-read --directory = $PWD --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.16 Starting 6 processes Jobs: 6 ( f = 6 ) : [ R ( 6 )][ 88 .9% ][ r = 130MiB/s ][ r = 33 .2k IOPS ][ eta 00m:01s ] big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 225237 : Fri Aug 12 14 :09:04 2022 read: IOPS = 5925 , BW = 23 .1MiB/s ( 24 .3MB/s )( 200MiB/8641msec ) clat ( nsec ) : min = 434 , max = 21757k, avg = 168221 .11, stdev = 1662876 .10 lat ( nsec ) : min = 471 , max = 21757k, avg = 168260 .51, stdev = 1662876 .63 clat percentiles ( nsec ) : | 1 .00th =[ 524 ] , 5 .00th =[ 540 ] , 10 .00th =[ 548 ] , | 20 .00th =[ 564 ] , 30 .00th =[ 572 ] , 40 .00th =[ 580 ] , | 50 .00th =[ 596 ] , 60 .00th =[ 612 ] , 70 .00th =[ 628 ] , | 80 .00th =[ 660 ] , 90 .00th =[ 732 ] , 95 .00th =[ 884 ] , | 99 .00th =[ 3948544 ] , 99 .50th =[ 19005440 ] , 99 .90th =[ 20054016 ] , | 99 .95th =[ 20054016 ] , 99 .99th =[ 20054016 ] \u5185\u5b58\u5bbf\u4e3b\u673a\uff1a [ ucloud ] root@node1:/var/jfsCache# fio --name = big-file-multi-read --directory = $PWD --rw = read --refill_buffers --bs = 4K --size = 200M --numjobs = 6 big-file-multi-read: ( g = 0 ) : rw = read, bs =( R ) 4096B-4096B, ( W ) 4096B-4096B, ( T ) 4096B-4096B, ioengine = psync, iodepth = 1 ... fio-3.16 Starting 6 processes big-file-multi-read: ( groupid = 0 , jobs = 1 ) : err = 0 : pid = 12095 : Fri Aug 12 15 :05:27 2022 read: IOPS = 966k, BW = 3774MiB/s ( 3957MB/s )( 200MiB/53msec ) clat ( nsec ) : min = 520 , max = 221610 , avg = 757 .38, stdev = 2561 .09 lat ( nsec ) : min = 553 , max = 221646 , avg = 792 .50, stdev = 2561 .18 clat percentiles ( nsec ) : | 1 .00th =[ 540 ] , 5 .00th =[ 556 ] , 10 .00th =[ 556 ] , 20 .00th =[ 564 ] , | 30 .00th =[ 572 ] , 40 .00th =[ 580 ] , 50 .00th =[ 596 ] , 60 .00th =[ 612 ] , | 70 .00th =[ 644 ] , 80 .00th =[ 724 ] , 90 .00th =[ 908 ] , 95 .00th =[ 940 ] , | 99 .00th =[ 3344 ] , 99 .50th =[ 3728 ] , 99 .90th =[ 19072 ] , 99 .95th =[ 43264 ] , | 99 .99th =[ 115200 ] fio --name=small-file-multi-read \\ --directory=/config \\ --rw=read --file_service_type=sequential \\ --bs=4k --filesize=4k --nrfiles=500 \\ --numjobs=2","title":"\u5bb9\u5668\u8bbf\u95ee\u5bf9\u8c61\u5b58\u50a8"},{"location":"5.Storage/s3-client-docs/","text":"\u5728\u8fd0\u7ef4\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7ecf\u5e38\u4f1a\u9047\u5230\u8981\u6e05\u7406\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\uff0c\u5728rook\u4e2d\u63a8\u8350\u4e86\u4e00\u4e2as3\u7684\u5de5\u5177\uff0c\u53ebs3cmd\uff0c\u90a3\u4e48\u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a\u5de5\u5177\u5bf9 \u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u4e0a\u4f20\uff0c\u4e0b\u8f7d\uff0c\u5220\u9664\u7b49\u64cd\u4f5c. s3cmd \u547d\u4ee4\u7528\u6cd5: \u6e29\u99a8\u63d0\u793a \u5728\u4f7f\u7528 s3cmd \u547d\u4ee4,\u9700\u8981\u5bf9\u6876\u6709\u6743\u9650,\u5177\u4f53\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003: https://github.com/barry-boy/note-k8s/issues/115 \u67e5\u770b bucket root@rbd-demo-c5fc7f94-89l5k:/# s3cmd ls 2023-08-12 17:18 s3://ceph-bkt-a0842637-c874-4dc7-b0d5-639d6aa825a2 s3cmd \u9012\u5f52\u5220\u9664 s3cmd del --recursive s3://ceph-bkt-a0842637-c874-4dc7-b0d5-639d6aa825a2/juicefs-sc/ s3cmd del --recursive s3://ceph-bkt-a0842637-c874-4dc7-b0d5-639d6aa825a2/openbayes-jfs/","title":"ceph s3cmd\u7ba1\u7406"},{"location":"6.Gitops/2024-10-10-Github-rsync-Gitee/","text":"\u56fd\u5185\u7531\u4e8e\u7f51\u7edc\u7684\u539f\u56e0\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\u624d\u80fd\u8bbf\u95ee github \u7684\u4ed3\u5e93,\u4f46\u662f\u6211\u53c8\u60f3\u628a\u6211\u7684\u4ed3\u5e93\u540c\u6b65\u4e00\u4efd\u5230\u6211\u4eec\u56fd\u5185\u7684 gitee \u4e0a.(\u5229\u7528 github action \u6765\u5b9e\u73b0) 1. \u5b9e\u65f6\u5907\u4efd(github \u63d0\u4ea4\u4ee3\u7801\u4e4b\u540e\u4f1a\u76f4\u63a5\u540c\u6b65 gitee),\u4ee3\u7801\u7684\u5b89\u5168\u6027\u53ef\u4ee5\u4fdd\u8bc1 2. \u5728\u56fd\u5185\u90e8\u7f72 gitops \u670d\u52a1\u53ef\u4ee5\u901a\u8fc7\u62c9\u53d6 gitee \u7684\u4ee3\u7801\u5b9e\u73b0\u81ea\u52a8\u5316\u7684 gitops \u6d41\u7a0b,\u6765\u81ea\u52a8\u90e8\u7f72\u6216\u8005\u53d1\u5e03. \u9996\u5148\u4f60\u9700\u8981\u6ce8\u518c\u4e00\u4e2a gitee \u7684\u8d26\u53f7. - \u6ce8\u518c\u4e4b\u540e\u9700\u8981\u83b7\u53d6\u4e00\u4e2a token \u6765\u65b9\u4fbf\u6211\u4eec github action \u4f7f\u7528 \u6211\u7684\u9879\u76ee\u76ee\u5f55\u7ed3\u6784 cd .github/workflows $ tree (csg/infra) . \u251c\u2500\u2500 ci.yaml \u2514\u2500\u2500 sync-to-gitee.yml \u5176\u4e2d sync-to-gitee \u5c31\u662f\u6211\u4eec\u540c\u6b65\u7684\u914d\u7f6e\u6587\u4ef6 \u9700\u8981\u6dfb\u52a0: target-url target-username target-token $ cat sync-to-gitee.yml (csg/infra) name: sync-gitee on: push: branches: - '**' jobs: sync: runs-on: ubuntu-latest name: Git Repo Sync steps: - uses: actions/checkout@v2 with: fetch-depth: 0 - uses: wangchucheng/git-repo-sync@v0.1.0 with: # Such as https://github.com/wangchucheng/git-repo-sync.git target-url: https://gitee.com/awxie/lvycoder.github.io.git # Such as wangchucheng target-username: awxie # You can store token in your project's 'Setting > Secrets' and reference the name here. Such as ${{ secrets.ACCESS_TOKEN }} target-token: xxxxxxxxxxxxxxx","title":"Github Rysnc \u540c\u6b65 Gitee"},{"location":"6.Gitops/2024-9-26-Git-docs/","text":"git commit \u540e\uff0c\u63d0\u4ea4\u8bb0\u5f55\u6d88\u5931\u4e0d\u89c1 \u00b6 \u4eca\u5929\u5728\u64cd\u4f5c git rebase \u65f6\u5019, \u53d1\u73b0\u6267\u884c git rebase --abort \u6211\u7684 git commit \u63d0\u4ea4\u4e22\u5931\u4e86,\u518d\u770b\u4e86\u4e00\u4e0bPR\u4e5f\u6ca1\u6709\u4e86,\u8fd9\u65f6\u5019\u6709\u70b9\u614c. \u95ee\u9898\u5904\u7406 \u00b6 \u901a\u8fc7\u4ee5\u4e0b git reflog \u6765\u627e\u5230\u81ea\u5df1\u672c\u5730\u6240\u6709\u7684 commit \u8bb0\u5f55 git reflog git reset --hard commit-id git reset --hard ac729e2a7 \u901a\u8fc7 git reflog \u67e5\u770b\u6240\u6709\u7684 commit \u63d0\u4ea4,\u7ea2\u8272\u8fd9\u662f\u6211\u8981\u6062\u590d\u7684 commit id","title":"Git Commit \u95ee\u9898"},{"location":"6.Gitops/2024-9-26-Git-docs/#git-commit","text":"\u4eca\u5929\u5728\u64cd\u4f5c git rebase \u65f6\u5019, \u53d1\u73b0\u6267\u884c git rebase --abort \u6211\u7684 git commit \u63d0\u4ea4\u4e22\u5931\u4e86,\u518d\u770b\u4e86\u4e00\u4e0bPR\u4e5f\u6ca1\u6709\u4e86,\u8fd9\u65f6\u5019\u6709\u70b9\u614c.","title":"git commit \u540e\uff0c\u63d0\u4ea4\u8bb0\u5f55\u6d88\u5931\u4e0d\u89c1"},{"location":"6.Gitops/2024-9-26-Git-docs/#_1","text":"\u901a\u8fc7\u4ee5\u4e0b git reflog \u6765\u627e\u5230\u81ea\u5df1\u672c\u5730\u6240\u6709\u7684 commit \u8bb0\u5f55 git reflog git reset --hard commit-id git reset --hard ac729e2a7 \u901a\u8fc7 git reflog \u67e5\u770b\u6240\u6709\u7684 commit \u63d0\u4ea4,\u7ea2\u8272\u8fd9\u662f\u6211\u8981\u6062\u590d\u7684 commit id","title":"\u95ee\u9898\u5904\u7406"},{"location":"Devops/3-github-docs/","text":"\u7ffb\u5899\u5de5\u5177: \u00b6 \u7ecf\u5e38\u4f7f\u7528google\u6d4f\u89c8\u5668\u7684\u5c0f\u4f19\u4f34\u662f\u4e0d\u662f\u7ecf\u5e38\u60f3\u7ffb\u5899\u627e\u4e00\u4e9b\u5b66\u4e60\u8d44\u6e90\uff0c\u56e0\u4e3a\u8981\u79d1\u5b66\u4e0a\u7f51\uff0c\u4ecb\u7ecd\u4e00\u6b3e\u5de5\u5177\u53ef\u4ee5\u514d\u8d39\u7ffb\u5899\uff0c\u901f\u5ea6\u57281M\u4ee5\u5185\u6ee1\u8db3\u65e5\u5e38\u5076\u800c\u60f3\u7ffb\u5899\u770b\u770b\u7684\u670b\u53cb\u3002 \u5b98\u7f51: \u767d\u9cb8\u52a0\u901f\u5668\uff08\u50bb\u74dc\u5f0f\u5b89\u88c5\uff09 \u4e0b\u8f7d\u5730\u5740: https://www.bjch110.com/?mid=3013 \u4f18\u70b9: \u591a\u5e73\u53f0\u90fd\u53ef\u4ee5\u4f7f\u7528 \u514d\u8d39\u4f7f\u7528\uff08\u767d\u5ad6\u515a\u798f\u5229\uff09 \u4f7f\u7528\u7b80\u5355 \u4e0d\u80fd\u7ffb\u5899\u7684\u670b\u53cb\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u94fe\u63a5\u8bbf\u95ee\u6211\u7684\u4e91\u76d8 \u767d\u9cb8\u52a0\u901f\u5668 : https://www.aliyundrive.com/s/HcZDipB1dzM \u5f53\u7136\u5982\u679c\u4f60\u4f1a\u8ba1\u7b97\u673a\u4e13\u4e1a\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u9879\u76ee: https://github.com/Alvin9999/new-pac/wiki \u6cb9\u7334\u811a\u672c \u00b6 \u6cb9\u7334\u811a\u672c\u53c8\u53ebTampermonkey\uff0c\u8fd9\u4e2a\u662fGoogle\u4e0a\u7684\u4e00\u4e2a\u6269\u5c55\uff0c\u5982\u679c\u4f60\u4f1a\u7528\u4e00\u5b9a\u7ed9\u4f60\u7684\u5de5\u4f5c\u548c\u751f\u6d3b\u6709\u4e00\u5b9a\u7684\u5347\u534e\u3002 \u9996\u5148\u4f60\u9700\u8981\u5b89\u88c5\u4e00\u4e0b\u8fd9\u4e2a\u6269\u5c55\u5de5\u5177\uff0c\u8fd9\u91cc\u4e0d\u505a\u8fc7\u591a\u4ecb\u7ecd\uff0c\u7f51\u4e0a\u7684\u6559\u7a0b\u4e00\u5927\u5806\u3002\u4e0b\u9762\u8bf4\u4e00\u4e0b\u6211\u7528\u7684\u51e0\u4e2a\u811a\u672c\u3002 \u811a\u672c\u4e00: AC-baidu-\u91cd\u5b9a\u5411\u4f18\u5316\u767e\u5ea6\u641c\u72d7\u8c37\u6b4c\u5fc5\u5e94\u641c\u7d22_favicon_\u53cc\u5217 \u8fd9\u4e2a\u662f\u6ca1\u6709\u5f00\u542f\u8fd9\u4e2a\u811a\u672c\u4f7f\u7528Google: \u8fd9\u4e2a\u662f\u5f00\u542f\u811a\u672c\u4f7f\u7528Google,\u660e\u663e\u53ef\u4ee5\u770b\u5230\u542f\u7528\u811a\u672c\u4e4b\u540e\u4f60\u7684\u663e\u793a\u6210\u4e3a\u4e86\u4e24\u884c\u3002\u4e5f\u66f4\u52a0\u76f4\u89c2\u548c\u7f8e\u89c2\u3002 \u811a\u672c\u4e8c: Clean csdn blog \u6e05\u723d\u9605\u8bfb\u535a\u5ba2 CSDN \u4e00\u822c\u56fd\u5185\u7a0b\u5e8f\u5458\u4f1a\u8fdb\u884c\u4e00\u4e9b\u641c\u7d22\u6587\u7ae0\uff0c\u4f46\u662f\u6700\u8fd1\u51e0\u5e74\u8fd9\u4e2a\u4e0a\u9762\u57fa\u672c\u90fd\u662f\u96f7\u540c\uff0c\u5783\u573e\u6587\u7ae0\u592a\u591a\uff0c\u6536\u8d39\u7b49\u7b49\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u811a\u672c\u6765\u89c4\u907f\u8fd9\u4e9b\u95ee\u9898\uff08\u4e0d\u80fd\u4fdd\u8bc1\u6240\u6709\uff09 \u811a\u672c\u4e09: B\u7ad9\u89c6\u5c4f\u4e0b\u8f7d\u811a\u672c\u6216\u8005\u4e0b\u8f7d\u6269\u5c55","title":"Google \u6d4f\u89c8\u5668\u6269\u5c55"},{"location":"Devops/3-github-docs/#_1","text":"\u7ecf\u5e38\u4f7f\u7528google\u6d4f\u89c8\u5668\u7684\u5c0f\u4f19\u4f34\u662f\u4e0d\u662f\u7ecf\u5e38\u60f3\u7ffb\u5899\u627e\u4e00\u4e9b\u5b66\u4e60\u8d44\u6e90\uff0c\u56e0\u4e3a\u8981\u79d1\u5b66\u4e0a\u7f51\uff0c\u4ecb\u7ecd\u4e00\u6b3e\u5de5\u5177\u53ef\u4ee5\u514d\u8d39\u7ffb\u5899\uff0c\u901f\u5ea6\u57281M\u4ee5\u5185\u6ee1\u8db3\u65e5\u5e38\u5076\u800c\u60f3\u7ffb\u5899\u770b\u770b\u7684\u670b\u53cb\u3002 \u5b98\u7f51: \u767d\u9cb8\u52a0\u901f\u5668\uff08\u50bb\u74dc\u5f0f\u5b89\u88c5\uff09 \u4e0b\u8f7d\u5730\u5740: https://www.bjch110.com/?mid=3013 \u4f18\u70b9: \u591a\u5e73\u53f0\u90fd\u53ef\u4ee5\u4f7f\u7528 \u514d\u8d39\u4f7f\u7528\uff08\u767d\u5ad6\u515a\u798f\u5229\uff09 \u4f7f\u7528\u7b80\u5355 \u4e0d\u80fd\u7ffb\u5899\u7684\u670b\u53cb\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u94fe\u63a5\u8bbf\u95ee\u6211\u7684\u4e91\u76d8 \u767d\u9cb8\u52a0\u901f\u5668 : https://www.aliyundrive.com/s/HcZDipB1dzM \u5f53\u7136\u5982\u679c\u4f60\u4f1a\u8ba1\u7b97\u673a\u4e13\u4e1a\u4e5f\u53ef\u4ee5\u5c1d\u8bd5\u4e00\u4e0b\u8fd9\u4e2a\u9879\u76ee: https://github.com/Alvin9999/new-pac/wiki","title":"\u7ffb\u5899\u5de5\u5177:"},{"location":"Devops/3-github-docs/#_2","text":"\u6cb9\u7334\u811a\u672c\u53c8\u53ebTampermonkey\uff0c\u8fd9\u4e2a\u662fGoogle\u4e0a\u7684\u4e00\u4e2a\u6269\u5c55\uff0c\u5982\u679c\u4f60\u4f1a\u7528\u4e00\u5b9a\u7ed9\u4f60\u7684\u5de5\u4f5c\u548c\u751f\u6d3b\u6709\u4e00\u5b9a\u7684\u5347\u534e\u3002 \u9996\u5148\u4f60\u9700\u8981\u5b89\u88c5\u4e00\u4e0b\u8fd9\u4e2a\u6269\u5c55\u5de5\u5177\uff0c\u8fd9\u91cc\u4e0d\u505a\u8fc7\u591a\u4ecb\u7ecd\uff0c\u7f51\u4e0a\u7684\u6559\u7a0b\u4e00\u5927\u5806\u3002\u4e0b\u9762\u8bf4\u4e00\u4e0b\u6211\u7528\u7684\u51e0\u4e2a\u811a\u672c\u3002 \u811a\u672c\u4e00: AC-baidu-\u91cd\u5b9a\u5411\u4f18\u5316\u767e\u5ea6\u641c\u72d7\u8c37\u6b4c\u5fc5\u5e94\u641c\u7d22_favicon_\u53cc\u5217 \u8fd9\u4e2a\u662f\u6ca1\u6709\u5f00\u542f\u8fd9\u4e2a\u811a\u672c\u4f7f\u7528Google: \u8fd9\u4e2a\u662f\u5f00\u542f\u811a\u672c\u4f7f\u7528Google,\u660e\u663e\u53ef\u4ee5\u770b\u5230\u542f\u7528\u811a\u672c\u4e4b\u540e\u4f60\u7684\u663e\u793a\u6210\u4e3a\u4e86\u4e24\u884c\u3002\u4e5f\u66f4\u52a0\u76f4\u89c2\u548c\u7f8e\u89c2\u3002 \u811a\u672c\u4e8c: Clean csdn blog \u6e05\u723d\u9605\u8bfb\u535a\u5ba2 CSDN \u4e00\u822c\u56fd\u5185\u7a0b\u5e8f\u5458\u4f1a\u8fdb\u884c\u4e00\u4e9b\u641c\u7d22\u6587\u7ae0\uff0c\u4f46\u662f\u6700\u8fd1\u51e0\u5e74\u8fd9\u4e2a\u4e0a\u9762\u57fa\u672c\u90fd\u662f\u96f7\u540c\uff0c\u5783\u573e\u6587\u7ae0\u592a\u591a\uff0c\u6536\u8d39\u7b49\u7b49\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u811a\u672c\u6765\u89c4\u907f\u8fd9\u4e9b\u95ee\u9898\uff08\u4e0d\u80fd\u4fdd\u8bc1\u6240\u6709\uff09 \u811a\u672c\u4e09: B\u7ad9\u89c6\u5c4f\u4e0b\u8f7d\u811a\u672c\u6216\u8005\u4e0b\u8f7d\u6269\u5c55","title":"\u6cb9\u7334\u811a\u672c"},{"location":"Devops/4-github-gitee-doc/","text":"\u524d\u8a00 \u00b6 GitHub\u4f5c\u4e3a\u5168\u7403\u6700\u5927\u7684\u4ee3\u7801\u6258\u7ba1\u5e73\u53f0\uff0c\u4e0a\u9762\u4e0d\u4ec5\u6709\u5f88\u591a\u4f18\u79c0\u7684\u9879\u76ee\uff0c\u5305\u62ec\u81ea\u5df1\u7684\u9879\u76ee\u4e5f\u6258\u7ba1\u5728\u4e0a\u9762\uff0c\u4f46\u662f\u7531\u4e8e\u56fd\u5185\u7f51\u7edc\u7684\u539f\u56e0\uff0c\u4e0d\u5f97\u4e0d\u60f3\u4e00\u4e2a\u529e\u6cd5\u53ef\u4ee5\u5c06GitHub\u540c\u6b65\u5230\u56fd\u5185\uff0c\u5982\u679c\u540c\u6b65\uff0c\u9996\u5148\u80af\u5b9a\u662fgitee\u4e0a\uff1b\u90a3\u4e48\u5927\u4f6c\u7684\u8fd9\u7bc7\u6587\u7ae0 \u300a\u4e00\u7bc7\u6559\u4f60\u4ee3\u7801\u540c\u6b65 Github \u548c Gitee\u300b \uff0c\u6211\u4e5f\u4eb2\u81ea\u5b9e\u8df5\u7684\u4e00\u4e0b\uff0c\u505a\u4e00\u4e0b\u8bb0\u5f55\uff5e 1. Gitee \u5bfc\u5165\u4ed3\u5e93 \u00b6 \u4e0a\u7bc7\u6211\u4eec\u5df2\u7ecf\u5728 Github \u521b\u5efa\u4e86\u535a\u5ba2\u4ed3\u5e93\uff0c\u73b0\u5728\u6211\u4eec\u5728 Gitee \u7ed1\u5b9a Github \u8d26\u53f7\u540e\uff0c\u9009\u62e9\u4ed3\u5e93\u5bfc\u5165: \u5bfc\u5165\u6211\u4eec\u9700\u8981\u540c\u6b65\u7684\u4ed3\u5e93 \u6587\u7ae0\u53c2\u8003: \u300a\u4e00\u7bc7\u6559\u4f60\u4ee3\u7801\u540c\u6b65 Github \u548c Gitee\u300b","title":"Github\u4ed3\u5e93\u540c\u6b65\u81f3Gitee"},{"location":"Devops/4-github-gitee-doc/#_1","text":"GitHub\u4f5c\u4e3a\u5168\u7403\u6700\u5927\u7684\u4ee3\u7801\u6258\u7ba1\u5e73\u53f0\uff0c\u4e0a\u9762\u4e0d\u4ec5\u6709\u5f88\u591a\u4f18\u79c0\u7684\u9879\u76ee\uff0c\u5305\u62ec\u81ea\u5df1\u7684\u9879\u76ee\u4e5f\u6258\u7ba1\u5728\u4e0a\u9762\uff0c\u4f46\u662f\u7531\u4e8e\u56fd\u5185\u7f51\u7edc\u7684\u539f\u56e0\uff0c\u4e0d\u5f97\u4e0d\u60f3\u4e00\u4e2a\u529e\u6cd5\u53ef\u4ee5\u5c06GitHub\u540c\u6b65\u5230\u56fd\u5185\uff0c\u5982\u679c\u540c\u6b65\uff0c\u9996\u5148\u80af\u5b9a\u662fgitee\u4e0a\uff1b\u90a3\u4e48\u5927\u4f6c\u7684\u8fd9\u7bc7\u6587\u7ae0 \u300a\u4e00\u7bc7\u6559\u4f60\u4ee3\u7801\u540c\u6b65 Github \u548c Gitee\u300b \uff0c\u6211\u4e5f\u4eb2\u81ea\u5b9e\u8df5\u7684\u4e00\u4e0b\uff0c\u505a\u4e00\u4e0b\u8bb0\u5f55\uff5e","title":"\u524d\u8a00"},{"location":"Devops/4-github-gitee-doc/#1-gitee","text":"\u4e0a\u7bc7\u6211\u4eec\u5df2\u7ecf\u5728 Github \u521b\u5efa\u4e86\u535a\u5ba2\u4ed3\u5e93\uff0c\u73b0\u5728\u6211\u4eec\u5728 Gitee \u7ed1\u5b9a Github \u8d26\u53f7\u540e\uff0c\u9009\u62e9\u4ed3\u5e93\u5bfc\u5165: \u5bfc\u5165\u6211\u4eec\u9700\u8981\u540c\u6b65\u7684\u4ed3\u5e93 \u6587\u7ae0\u53c2\u8003: \u300a\u4e00\u7bc7\u6559\u4f60\u4ee3\u7801\u540c\u6b65 Github \u548c Gitee\u300b","title":"1. Gitee \u5bfc\u5165\u4ed3\u5e93"},{"location":"Devops/git-error-docs/","text":"\u62a5\u9519\u6307\u5357 \u00b6 \u95ee\u9898\u590d\u73b0: \u00b6 \u5f53\u6211\u4eec\u5728 git fetch \u6216 git rebase \u6211\u4eec\u672c\u5730\u6709\u4e00\u4e9b\u6587\u4ef6\u6ca1\u6709\u63d0\u4ea4\uff0c\u5c31\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u8fd9\u79cd\u60c5\u51b5\u3002 $ git checkout lixie2 error: \u60a8\u5bf9\u4e0b\u5217\u6587\u4ef6\u7684\u672c\u5730\u4fee\u6539\u5c06\u88ab\u68c0\u51fa\u64cd\u4f5c\u8986\u76d6\uff1a ansible/inventory/office ansible/office.yml ssh-config-hosts \u8bf7\u5728\u5207\u6362\u5206\u652f\u524d\u63d0\u4ea4\u6216\u8d2e\u85cf\u60a8\u7684\u4fee\u6539\u3002 \u6b63\u5728\u7ec8\u6b62 \u95ee\u9898\u5904\u7406: \u00b6 \u5f53\u6211\u4eec\u9700\u8981\u66f4\u65b0\u672c\u5730\u5206\u652f\u4ee3\u7801\uff0c\u9047\u5230\u4ee5\u4e0a\u7684\u62a5\u9519\uff0c\u53ef\u4ee5\u901a\u8fc7 git stash \u5c06\u672a\u63d0\u4ea4\u7684\u4fee\u6539\u4fdd\u5b58\u5230\u4e00\u4e2a\u4e34\u65f6\u7684\u533a\u57df\u3002\u7136\u540e\u6211\u4eec\u518d\u8fdb\u884c git fetch \u66f4\u65b0\u672c\u5730\u4ee3\u7801\u5c31\u53ef\u4ee5\u6b63\u5e38\u4f7f\u7528\u4e86. \u5728\u5b8c\u6210\u66f4\u65b0\u64cd\u4f5c\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u4f7f\u7528 git stash apply \u6700\u8fd1\u7684 stash \u5e94\u7528\u5230\u5de5\u4f5c\u76ee\u5f55.","title":"Git \u62a5\u9519\u6307\u5357"},{"location":"Devops/git-error-docs/#_1","text":"","title":"\u62a5\u9519\u6307\u5357"},{"location":"Devops/git-error-docs/#_2","text":"\u5f53\u6211\u4eec\u5728 git fetch \u6216 git rebase \u6211\u4eec\u672c\u5730\u6709\u4e00\u4e9b\u6587\u4ef6\u6ca1\u6709\u63d0\u4ea4\uff0c\u5c31\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u8fd9\u79cd\u60c5\u51b5\u3002 $ git checkout lixie2 error: \u60a8\u5bf9\u4e0b\u5217\u6587\u4ef6\u7684\u672c\u5730\u4fee\u6539\u5c06\u88ab\u68c0\u51fa\u64cd\u4f5c\u8986\u76d6\uff1a ansible/inventory/office ansible/office.yml ssh-config-hosts \u8bf7\u5728\u5207\u6362\u5206\u652f\u524d\u63d0\u4ea4\u6216\u8d2e\u85cf\u60a8\u7684\u4fee\u6539\u3002 \u6b63\u5728\u7ec8\u6b62","title":"\u95ee\u9898\u590d\u73b0:"},{"location":"Devops/git-error-docs/#_3","text":"\u5f53\u6211\u4eec\u9700\u8981\u66f4\u65b0\u672c\u5730\u5206\u652f\u4ee3\u7801\uff0c\u9047\u5230\u4ee5\u4e0a\u7684\u62a5\u9519\uff0c\u53ef\u4ee5\u901a\u8fc7 git stash \u5c06\u672a\u63d0\u4ea4\u7684\u4fee\u6539\u4fdd\u5b58\u5230\u4e00\u4e2a\u4e34\u65f6\u7684\u533a\u57df\u3002\u7136\u540e\u6211\u4eec\u518d\u8fdb\u884c git fetch \u66f4\u65b0\u672c\u5730\u4ee3\u7801\u5c31\u53ef\u4ee5\u6b63\u5e38\u4f7f\u7528\u4e86. \u5728\u5b8c\u6210\u66f4\u65b0\u64cd\u4f5c\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u4f7f\u7528 git stash apply \u6700\u8fd1\u7684 stash \u5e94\u7528\u5230\u5de5\u4f5c\u76ee\u5f55.","title":"\u95ee\u9898\u5904\u7406:"},{"location":"Devops/github/","text":"\u8ba4\u8bc6 Github: \u00b6 Github\u987e\u540d\u601d\u4e49\u662f\u4e00\u4e2aGit\u7248\u672c\u5e93\u7684\u6258\u7ba1\u670d\u52a1\uff0c\u662f\u76ee\u524d\u5168\u7403\u6700\u5927\u7684\u8f6f\u4ef6\u4ed3\u5e93\uff0c\u62e5\u6709\u4e0a\u767e\u4e07\u7684\u5f00\u53d1\u8005\u7528\u6237\uff0c\u4e5f\u662f\u8f6f\u4ef6\u5f00\u53d1\u548c\u5bfb\u627e\u8d44\u6e90\u7684\u6700\u4f73\u9014\u5f84\uff0cGithub\u4e0d\u4ec5\u53ef\u4ee5\u6258\u7ba1\u5404\u79cdGit\u7248\u672c\u4ed3\u5e93\uff0c\u8fd8\u62e5\u6709\u4e86\u66f4\u7f8e\u89c2\u7684Web\u754c\u9762\uff0c\u60a8\u7684\u4ee3\u7801\u6587\u4ef6\u53ef\u4ee5\u88ab\u4efb\u4f55\u4eba\u514b\u9686\uff0c\u4f7f\u5f97\u5f00\u53d1\u8005\u4e3a\u5f00\u6e90\u9879\u8d21\u732e\u4ee3\u7801\u53d8\u5f97\u66f4\u52a0\u5bb9\u6613\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4ed8\u8d39\u8d2d\u4e70\u79c1\u6709\u5e93\uff0c\u8fd9\u6837\u9ad8\u6027\u4ef7\u6bd4\u7684\u79c1\u6709\u5e93\u771f\u7684\u662f\u5e2e\u52a9\u5230\u4e86\u5f88\u591a\u56e2\u961f\u548c\u4f01\u4e1a\u3002 \u4e00\u3001\u6ce8\u518cGithub\u5e10\u53f7 \u00b6 1.1. \u8fdb\u5165github\u7684\u5b98\u7f51: https://github.com/ 1.2. \u70b9\u51fb\u6ce8\u518c\u8d26\u53f7 \u6e29\u99a8\u63d0\u793a \u7528\u6237\u6635\u79f0\uff0c\u5efa\u8bae\u7528\u6709\u7279\u8272\u81ea\u5df1\u7684\uff0c\u800c\u4e14\u4e0d\u8981\u592a\u957f\uff0c\u8981\u597d\u8bb0\uff0c\u4ee5\u540e\u5bf9\u521b\u5efa\u4ed3\u5e93\u6709\u5f88\u5927\u7684\u5e2e\u52a9\u3002 \u7535\u5b50\u90ae\u7bb1\u5730\u5740\uff0c\u586b\u5199\u4f60\u5e38\u7528\u7684\uff0c\u4e0d\u8981\u4e71\u586b\uff0c\u4e00\u4f1a\u662f\u8981\u53d1\u6fc0\u6d3b\u94fe\u63a5\u5230\u4f60\u90ae\u7bb1\u7684\u3002 \u7528\u6237\u5bc6\u7801\uff0c\u786e\u4fdd\u81f3\u5c1115\u4e2a\u5b57\u7b26\u6216\u81f3\u5c118\u4e2a\u5b57\u7b26\uff08 \u5305\u62ec\u6570\u5b57 \u548c\u5c0f\u5199\u5b57\u6bcd\uff09 \u8f93\u5165\u5b8c\u4f1a\u6709\u4e00\u4e2a\u4eba\u673a\u9a8c\u8bc1\uff0c\u4f60\u53ea\u9700\u628a\u56fe\u7247\u77eb\u6b63\u5373\u53ef\u3002 1.3. \u9009\u62e9\u4e2a\u4eba\u7248 1.4. \u9009\u62e9\u5174\u8da3 1.5.\u9a8c\u8bc1\u90ae\u7bb1 \u5230\u8fd9\u91cc\u57fa\u672c\u5c31\u5b8c\u6210\u4e86\u5bf9github\u5e10\u53f7\u7684\u6ce8\u518c\u3002 \u4e8c\u3001\u521b\u5efa\u4ed3\u5e93 \u00b6 2.1. \u65b0\u5efa\u4e00\u4e2a\u516c\u5171\u4ed3\u5e93 2.2. \u521d\u59cb\u5316\u4ed3\u5e93 \u4e09\u3001\u63d0\u4ea4\u4ee3\u7801 \u00b6 Github \u63d0\u4ea4 pr \u4ee3\u7801commit\u89c4\u7ea6: https://www.conventionalcommits.org/zh-hans/v1.0.0/ git checkout -b lixie //\u5207\u6362\u5230lixie\u5206\u652f git add . git status // \u67e5\u770b\u6682\u5b58\u533a\u63d0\u4ea4\u7684\u5185\u5bb9 git commit -m \"feat(ssh): add lixie for sjtu\" git branch git remote origin git branch //\u67e5\u770b\u5206\u652f git push origin lixie //\u5c06\u4ee3\u7801\u4e0a\u4f20\u8fdc\u7a0blixie\u5206\u652f git rebase origin/master git push origin lixie git push origin lixie -f \u5f3a\u5236\u63d0\u4ea4\u5230lixie\u5206\u533a \u56db\u3001\u914d\u7f6e\u516c\u94a5 \u00b6 4.1. \u751f\u6210\u5bc6\u94a5\u5bf9 root@a100-1:/home/lixie# ssh-keygen //\u4e00\u8def\u56de\u8f66 Generating public/private rsa key pair. Enter file in which to save the key (/root/.ssh/id_rsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_rsa Your public key has been saved in /root/.ssh/id_rsa.pub The key fingerprint is: SHA256:a92LUGI9FIkRl7wUlOVKqh3Xtsigo2XkG8iau0JKHUE root@a100-1 The key's randomart image is: +---[RSA 3072]----+ | .E o*=*. | | . ..*o | | . .o.. | | . =.o | | . . . S * o | | o o + = X = . | |+ o O = + o | |o o + = . . . | | .=o. . . . | +----[SHA256]-----+ // \u5bb6\u76ee\u5f55\u4e0b\u5c31\u4f1a\u751f\u6210\u51e0\u4e2a\u6587\u4ef6 root@a100-1:~# ls .ssh/ authorized_keys id_rsa id_rsa.pub 4.2. \u5c06\u516c\u94a5\u4e0a\u4f20\u5230github \u9700\u8981\u7ed9\u516c\u94a5\u8d77\u4e00\u4e2a\u540d\u79f0\uff0c\u590d\u5236\u81ea\u5df1\u521a\u521a\u521b\u5efa\u7684\u516c\u94a5 \u4e0a\u4f20\u5b8c\u6210\u4e4b\u540e\uff0c\u5c31\u4e0d\u9700\u8981\u63d0\u4ea4\u7684\u65f6\u5019\u518d\u8f93\u5165\u5bc6\u7801\u9a8c\u8bc1\u4e86\u3002windows\u4e5f\u7c7b\u4f3c\u53ef\u4ee5\u81ea\u884c\u767e\u5ea6\u3002 windows \u4f7f\u7528git \u7f51\u7ad9\u5730\u5740: https://git-for-windows.github.io \u4e0b\u8f7d\u5730\u5740: https://github.com/git-for-windows/git/releases/download/v2.22.0.windows.1/Git-2.22.0-64-bit.exe","title":"Github"},{"location":"Devops/github/#github","text":"Github\u987e\u540d\u601d\u4e49\u662f\u4e00\u4e2aGit\u7248\u672c\u5e93\u7684\u6258\u7ba1\u670d\u52a1\uff0c\u662f\u76ee\u524d\u5168\u7403\u6700\u5927\u7684\u8f6f\u4ef6\u4ed3\u5e93\uff0c\u62e5\u6709\u4e0a\u767e\u4e07\u7684\u5f00\u53d1\u8005\u7528\u6237\uff0c\u4e5f\u662f\u8f6f\u4ef6\u5f00\u53d1\u548c\u5bfb\u627e\u8d44\u6e90\u7684\u6700\u4f73\u9014\u5f84\uff0cGithub\u4e0d\u4ec5\u53ef\u4ee5\u6258\u7ba1\u5404\u79cdGit\u7248\u672c\u4ed3\u5e93\uff0c\u8fd8\u62e5\u6709\u4e86\u66f4\u7f8e\u89c2\u7684Web\u754c\u9762\uff0c\u60a8\u7684\u4ee3\u7801\u6587\u4ef6\u53ef\u4ee5\u88ab\u4efb\u4f55\u4eba\u514b\u9686\uff0c\u4f7f\u5f97\u5f00\u53d1\u8005\u4e3a\u5f00\u6e90\u9879\u8d21\u732e\u4ee3\u7801\u53d8\u5f97\u66f4\u52a0\u5bb9\u6613\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u4ed8\u8d39\u8d2d\u4e70\u79c1\u6709\u5e93\uff0c\u8fd9\u6837\u9ad8\u6027\u4ef7\u6bd4\u7684\u79c1\u6709\u5e93\u771f\u7684\u662f\u5e2e\u52a9\u5230\u4e86\u5f88\u591a\u56e2\u961f\u548c\u4f01\u4e1a\u3002","title":"\u8ba4\u8bc6 Github:"},{"location":"Devops/github/#github_1","text":"1.1. \u8fdb\u5165github\u7684\u5b98\u7f51: https://github.com/ 1.2. \u70b9\u51fb\u6ce8\u518c\u8d26\u53f7 \u6e29\u99a8\u63d0\u793a \u7528\u6237\u6635\u79f0\uff0c\u5efa\u8bae\u7528\u6709\u7279\u8272\u81ea\u5df1\u7684\uff0c\u800c\u4e14\u4e0d\u8981\u592a\u957f\uff0c\u8981\u597d\u8bb0\uff0c\u4ee5\u540e\u5bf9\u521b\u5efa\u4ed3\u5e93\u6709\u5f88\u5927\u7684\u5e2e\u52a9\u3002 \u7535\u5b50\u90ae\u7bb1\u5730\u5740\uff0c\u586b\u5199\u4f60\u5e38\u7528\u7684\uff0c\u4e0d\u8981\u4e71\u586b\uff0c\u4e00\u4f1a\u662f\u8981\u53d1\u6fc0\u6d3b\u94fe\u63a5\u5230\u4f60\u90ae\u7bb1\u7684\u3002 \u7528\u6237\u5bc6\u7801\uff0c\u786e\u4fdd\u81f3\u5c1115\u4e2a\u5b57\u7b26\u6216\u81f3\u5c118\u4e2a\u5b57\u7b26\uff08 \u5305\u62ec\u6570\u5b57 \u548c\u5c0f\u5199\u5b57\u6bcd\uff09 \u8f93\u5165\u5b8c\u4f1a\u6709\u4e00\u4e2a\u4eba\u673a\u9a8c\u8bc1\uff0c\u4f60\u53ea\u9700\u628a\u56fe\u7247\u77eb\u6b63\u5373\u53ef\u3002 1.3. \u9009\u62e9\u4e2a\u4eba\u7248 1.4. \u9009\u62e9\u5174\u8da3 1.5.\u9a8c\u8bc1\u90ae\u7bb1 \u5230\u8fd9\u91cc\u57fa\u672c\u5c31\u5b8c\u6210\u4e86\u5bf9github\u5e10\u53f7\u7684\u6ce8\u518c\u3002","title":"\u4e00\u3001\u6ce8\u518cGithub\u5e10\u53f7"},{"location":"Devops/github/#_1","text":"2.1. \u65b0\u5efa\u4e00\u4e2a\u516c\u5171\u4ed3\u5e93 2.2. \u521d\u59cb\u5316\u4ed3\u5e93","title":"\u4e8c\u3001\u521b\u5efa\u4ed3\u5e93"},{"location":"Devops/github/#_2","text":"Github \u63d0\u4ea4 pr \u4ee3\u7801commit\u89c4\u7ea6: https://www.conventionalcommits.org/zh-hans/v1.0.0/ git checkout -b lixie //\u5207\u6362\u5230lixie\u5206\u652f git add . git status // \u67e5\u770b\u6682\u5b58\u533a\u63d0\u4ea4\u7684\u5185\u5bb9 git commit -m \"feat(ssh): add lixie for sjtu\" git branch git remote origin git branch //\u67e5\u770b\u5206\u652f git push origin lixie //\u5c06\u4ee3\u7801\u4e0a\u4f20\u8fdc\u7a0blixie\u5206\u652f git rebase origin/master git push origin lixie git push origin lixie -f \u5f3a\u5236\u63d0\u4ea4\u5230lixie\u5206\u533a","title":"\u4e09\u3001\u63d0\u4ea4\u4ee3\u7801"},{"location":"Devops/github/#_3","text":"4.1. \u751f\u6210\u5bc6\u94a5\u5bf9 root@a100-1:/home/lixie# ssh-keygen //\u4e00\u8def\u56de\u8f66 Generating public/private rsa key pair. Enter file in which to save the key (/root/.ssh/id_rsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_rsa Your public key has been saved in /root/.ssh/id_rsa.pub The key fingerprint is: SHA256:a92LUGI9FIkRl7wUlOVKqh3Xtsigo2XkG8iau0JKHUE root@a100-1 The key's randomart image is: +---[RSA 3072]----+ | .E o*=*. | | . ..*o | | . .o.. | | . =.o | | . . . S * o | | o o + = X = . | |+ o O = + o | |o o + = . . . | | .=o. . . . | +----[SHA256]-----+ // \u5bb6\u76ee\u5f55\u4e0b\u5c31\u4f1a\u751f\u6210\u51e0\u4e2a\u6587\u4ef6 root@a100-1:~# ls .ssh/ authorized_keys id_rsa id_rsa.pub 4.2. \u5c06\u516c\u94a5\u4e0a\u4f20\u5230github \u9700\u8981\u7ed9\u516c\u94a5\u8d77\u4e00\u4e2a\u540d\u79f0\uff0c\u590d\u5236\u81ea\u5df1\u521a\u521a\u521b\u5efa\u7684\u516c\u94a5 \u4e0a\u4f20\u5b8c\u6210\u4e4b\u540e\uff0c\u5c31\u4e0d\u9700\u8981\u63d0\u4ea4\u7684\u65f6\u5019\u518d\u8f93\u5165\u5bc6\u7801\u9a8c\u8bc1\u4e86\u3002windows\u4e5f\u7c7b\u4f3c\u53ef\u4ee5\u81ea\u884c\u767e\u5ea6\u3002 windows \u4f7f\u7528git \u7f51\u7ad9\u5730\u5740: https://git-for-windows.github.io \u4e0b\u8f7d\u5730\u5740: https://github.com/git-for-windows/git/releases/download/v2.22.0.windows.1/Git-2.22.0-64-bit.exe","title":"\u56db\u3001\u914d\u7f6e\u516c\u94a5"},{"location":"Helm/helm-chart/","text":"Helm \u4f7f\u7528\u4e00\u79cd\u540d\u4e3a charts \u7684\u5305\u683c\u5f0f\uff0c\u4e00\u4e2a chart \u662f\u63cf\u8ff0\u4e00\u7ec4\u76f8\u5173\u7684 Kubernetes \u8d44\u6e90\u7684\u6587\u4ef6\u96c6\u5408\uff0c\u5355\u4e2a chart \u53ef\u80fd\u7528\u4e8e\u90e8\u7f72\u7b80\u5355\u7684\u5e94\u7528\uff0c\u6bd4\u5982 memcached pod\uff0c\u6216\u8005\u590d\u6742\u7684\u5e94\u7528\uff0c\u6bd4\u5982\u4e00\u4e2a\u5e26\u6709 HTTP \u670d\u52a1\u3001\u6570\u636e\u5e93\u3001\u7f13\u5b58\u7b49\u7b49\u529f\u80fd\u7684\u5b8c\u6574 web \u5e94\u7528\u7a0b\u5e8f\u3002 Charts \u662f\u521b\u5efa\u5728\u7279\u5b9a\u76ee\u5f55\u4e0b\u9762\u7684\u6587\u4ef6\u96c6\u5408\uff0c\u7136\u540e\u53ef\u4ee5\u5c06\u5b83\u4eec\u6253\u5305\u5230\u4e00\u4e2a\u7248\u672c\u5316\u7684\u5b58\u6863\u4e2d\u6765\u90e8\u7f72\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u770b\u770b\u4f7f\u7528 Helm \u6784\u5efa charts \u7684\u4e00\u4e9b\u57fa\u672c\u65b9\u6cd5\u3002 \u6587\u4ef6\u7ed3\u6784 \u00b6 chart \u88ab\u7ec4\u7ec7\u4e3a\u4e00\u4e2a\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u96c6\u5408\uff0c\u76ee\u5f55\u540d\u79f0\u5c31\u662f chart \u7684\u540d\u79f0\uff08\u4e0d\u5305\u542b\u7248\u672c\u4fe1\u606f\uff09\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a WordPress \u7684 chart\uff0c\u4f1a\u88ab\u5b58\u50a8\u5728 wordpress/ \u76ee\u5f55\u4e0b\u9762\uff0c\u57fa\u672c\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a wordpress/ Chart.yaml # \u5305\u542b\u5f53\u524d chart \u4fe1\u606f\u7684 YAML \u6587\u4ef6 LICENSE # \u53ef\u9009\uff1a\u5305\u542b chart \u7684 license \u7684\u6587\u672c\u6587\u4ef6 README.md # \u53ef\u9009\uff1a\u4e00\u4e2a\u53ef\u8bfb\u6027\u9ad8\u7684 README \u6587\u4ef6 values.yaml # \u5f53\u524d chart \u7684\u9ed8\u8ba4\u914d\u7f6e values values.schema.json # \u53ef\u9009: \u4e00\u4e2a\u4f5c\u7528\u5728 values.yaml \u6587\u4ef6\u4e0a\u7684 JSON \u6a21\u5f0f charts/ # \u5305\u542b\u8be5 chart \u4f9d\u8d56\u7684\u6240\u6709 chart \u7684\u76ee\u5f55 crds/ # Custom Resource Definitions templates/ # \u6a21\u677f\u76ee\u5f55\uff0c\u4e0e values \u7ed3\u5408\u4f7f\u7528\u65f6\uff0c\u5c06\u6e32\u67d3\u751f\u6210 Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6 templates/NOTES.txt # \u53ef\u9009: \u5305\u542b\u7b80\u77ed\u4f7f\u7528\u4f7f\u7528\u7684\u6587\u672c\u6587\u4ef6 \u53e6\u5916 Helm \u4f1a\u4fdd\u7559 charts/\u3001crds/ \u4ee5\u53ca templates/ \u76ee\u5f55\u4ee5\u53ca\u4e0a\u9762\u5217\u51fa\u7684\u6587\u4ef6\u540d\u7684\u4f7f\u7528\u3002 \u4f7f\u7528 Helm \u7ba1\u7406Chart \u00b6 helm \u5de5\u5177\u6709\u51e0\u4e2a\u7528\u4e8e\u64cd\u4f5c charts \u7684\u547d\u4ee4\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 chart \u5305\uff1a \u279c helm create mychart \u4e00\u65e6\u4f60\u5df2\u7ecf\u7f16\u8f91\u4e86\u4e00\u4e2a chart \u5305\uff0cHelm \u53ef\u4ee5\u5c06\u5176\u6253\u5305\u5230\u4e00\u4e2a\u72ec\u7acb\u6587\u4ef6\u4e2d\uff1a \u279c helm package mychart Archived mychart-0.1.-.tgz \u4f60\u8fd8\u53ef\u4ee5\u4f7f\u7528 helm \u5e2e\u52a9\u4f60\u67e5\u627e chart \u5305\u7684\u683c\u5f0f\u8981\u6c42\u65b9\u9762\u6216\u5176\u4ed6\u95ee\u9898\uff1a \u279c helm lint mychart No issues found","title":"kubernetes Helm chart\u5305"},{"location":"Helm/helm-chart/#_1","text":"chart \u88ab\u7ec4\u7ec7\u4e3a\u4e00\u4e2a\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u96c6\u5408\uff0c\u76ee\u5f55\u540d\u79f0\u5c31\u662f chart \u7684\u540d\u79f0\uff08\u4e0d\u5305\u542b\u7248\u672c\u4fe1\u606f\uff09\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a WordPress \u7684 chart\uff0c\u4f1a\u88ab\u5b58\u50a8\u5728 wordpress/ \u76ee\u5f55\u4e0b\u9762\uff0c\u57fa\u672c\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a wordpress/ Chart.yaml # \u5305\u542b\u5f53\u524d chart \u4fe1\u606f\u7684 YAML \u6587\u4ef6 LICENSE # \u53ef\u9009\uff1a\u5305\u542b chart \u7684 license \u7684\u6587\u672c\u6587\u4ef6 README.md # \u53ef\u9009\uff1a\u4e00\u4e2a\u53ef\u8bfb\u6027\u9ad8\u7684 README \u6587\u4ef6 values.yaml # \u5f53\u524d chart \u7684\u9ed8\u8ba4\u914d\u7f6e values values.schema.json # \u53ef\u9009: \u4e00\u4e2a\u4f5c\u7528\u5728 values.yaml \u6587\u4ef6\u4e0a\u7684 JSON \u6a21\u5f0f charts/ # \u5305\u542b\u8be5 chart \u4f9d\u8d56\u7684\u6240\u6709 chart \u7684\u76ee\u5f55 crds/ # Custom Resource Definitions templates/ # \u6a21\u677f\u76ee\u5f55\uff0c\u4e0e values \u7ed3\u5408\u4f7f\u7528\u65f6\uff0c\u5c06\u6e32\u67d3\u751f\u6210 Kubernetes \u8d44\u6e90\u6e05\u5355\u6587\u4ef6 templates/NOTES.txt # \u53ef\u9009: \u5305\u542b\u7b80\u77ed\u4f7f\u7528\u4f7f\u7528\u7684\u6587\u672c\u6587\u4ef6 \u53e6\u5916 Helm \u4f1a\u4fdd\u7559 charts/\u3001crds/ \u4ee5\u53ca templates/ \u76ee\u5f55\u4ee5\u53ca\u4e0a\u9762\u5217\u51fa\u7684\u6587\u4ef6\u540d\u7684\u4f7f\u7528\u3002","title":"\u6587\u4ef6\u7ed3\u6784"},{"location":"Helm/helm-chart/#helm-chart","text":"helm \u5de5\u5177\u6709\u51e0\u4e2a\u7528\u4e8e\u64cd\u4f5c charts \u7684\u547d\u4ee4\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 chart \u5305\uff1a \u279c helm create mychart \u4e00\u65e6\u4f60\u5df2\u7ecf\u7f16\u8f91\u4e86\u4e00\u4e2a chart \u5305\uff0cHelm \u53ef\u4ee5\u5c06\u5176\u6253\u5305\u5230\u4e00\u4e2a\u72ec\u7acb\u6587\u4ef6\u4e2d\uff1a \u279c helm package mychart Archived mychart-0.1.-.tgz \u4f60\u8fd8\u53ef\u4ee5\u4f7f\u7528 helm \u5e2e\u52a9\u4f60\u67e5\u627e chart \u5305\u7684\u683c\u5f0f\u8981\u6c42\u65b9\u9762\u6216\u5176\u4ed6\u95ee\u9898\uff1a \u279c helm lint mychart No issues found","title":"\u4f7f\u7528 Helm \u7ba1\u7406Chart"},{"location":"Helm/helm-install/","text":"Helm \u00b6 Helm \u7b80\u4ecb \u00b6 Helm \u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u7ba1\u7406 Kubernetes \u5e94\u7528\u7a0b\u5e8f - Helm Charts \u53ef\u4ee5\u5b9a\u4e49\u3001\u5b89\u88c5\u548c\u5347\u7ea7\u590d\u6742\u7684 Kubernetes \u5e94\u7528\u7a0b\u5e8f\uff0cCharts \u5305\u5f88\u5bb9\u6613\u521b\u5efa\u3001\u7248\u672c\u7ba1\u7406\u3001\u5206\u4eab\u548c\u5206\u5e03. \u7b80\u5355\u53ef\u4ee5\u7406\u89e3Linux\u4e2dyum\u7684\u7684\u611f\u89c9 Helm \u5b89\u88c5 \u00b6 \u83b7\u53d6\u8f6f\u4ef6 \u5b98\u7f51\u5730\u5740\uff1ahttps://github.com/helm/helm/releases \u4e0b\u8f7d\u5230\u672c\u5730\u89e3\u538b\u540e\uff0c\u5c06 helm \u4e8c\u8fdb\u5236\u5305\u6587\u4ef6\u79fb\u52a8\u5230\u4efb\u610f\u7684 PATH \u8def\u5f84\u4e0b $ helm version version.BuildInfo{Version:\"v3.9.0\", GitCommit:\"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\", GitTreeState:\"clean\", GoVersion:\"go1.18.2\"} Linux \u4e0b\u5b89\u88c5 root@k8s-master:/opt# wget https://get.helm.sh/helm-v3.8.1-linux-amd64.tar.gz cni containerd helm-v3.8.1-linux-amd64.tar.gz root@k8s-master:/opt# tar -xf helm-v3.8.1-linux-amd64.tar.gz root@k8s-master:/opt/linux-amd64# mv helm /usr/bin/ \u7ba1\u7406\u914d\u7f6e \u00b6 **Chart\u56fd\u5185\u4ed3\u5e93\u914d\u7f6e ** \u00b6 \u4ed3\u5e93\u914d\u7f6e \u5fae\u8f6f\u7684\u6e90\uff1ahttp://mirror.azure.cn/kubernetes/charts/ \u963f\u91cc\u7684\u6e90\uff1ahttps://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts \u5b98\u65b9\u7684\u6e90\uff1ahttps://hub.kubeapps.com/charts/incubator \u6dfb\u52a0chart\u5b58\u50a8\u5e93 \u00b6 helm repo add stable http://mirror.azure.cn/kubernetes/charts helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts root@k8s-master:/opt/linux-amd64# helm repo update # \u66f4\u65b0\u6e90 \u67e5\u770b\u5b58\u50a8\u5e93 \u00b6 $ helm repo list NAME URL stable http://mirror.azure.cn/kubernetes/charts/ openbayes https://dev.openbayes.com/charts \u5220\u9664\u5b58\u50a8\u5e93 \u00b6 root@k8s-master:/opt/linux-amd64# helm repo remove aliyun \u4e0b\u8f7dchart\u5305 \u00b6 root@k8s-master:/opt/# helm fetch grafana/grafana Helm \u90e8\u7f72\u5e94\u7528: \u00b6 Helm \u90e8\u7f72traefix \u00b6 \u90e8\u7f72traefik \u6587\u7ae0\u53c2\u8003: https://github.com/traefik/traefik-helm-chart git clone https://github.com/traefik/traefik-helm-chart.git \u5b9a\u4e49values\u6587\u4ef6 $ cat sjtu-traefik.yaml image : name : traefik tag : \"2.7\" # values-prod.yaml # Create an IngressRoute for the dashboard ingressRoute : dashboard : enabled : false # \u7981\u7528helm\u4e2d\u6e32\u67d3\u7684dashboard\uff0c\u6211\u4eec\u81ea\u5df1\u624b\u52a8\u521b\u5efa # Configure ports ports : web : port : 8000 hostPort : 80 # \u4f7f\u7528 hostport \u6a21\u5f0f # Use nodeport if set. This is useful if you have configured Traefik in a # LoadBalancer # nodePort: 32080 # Port Redirections # Added in 2.2, you can make permanent redirects via entrypoints. # https://docs.traefik.io/routing/entrypoints/#redirection # redirectTo: websecure websecure : port : 8443 hostPort : 443 # \u4f7f\u7528 hostport \u6a21\u5f0f # Options for the main traefik service, where the entrypoints traffic comes # from. service : # \u4f7f\u7528 hostport \u6a21\u5f0f\u5c31\u4e0d\u9700\u8981Service\u4e86 enabled : false # Logs # https://docs.traefik.io/observability/logs/ #logs: # general: # level: DEBUG tolerations : # kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\u9ed8\u8ba4\u60c5\u51b5\u4e0bmaster\u662f\u6709\u6c61\u70b9\uff0c\u9700\u8981\u5bb9\u5fcd\u8fd9\u4e2a\u6c61\u70b9\u624d\u53ef\u4ee5\u90e8\u7f72 - key : \"node-role.kubernetes.io/master\" operator : \"Equal\" effect : \"NoSchedule\" nodeSelector : # \u56fa\u5b9a\u5230master1\u8282\u70b9\uff08\u8be5\u8282\u70b9\u624d\u53ef\u4ee5\u8bbf\u95ee\u5916\u7f51\uff09 kubernetes.io/hostname : \"master\" \u67e5\u770b\u6e32\u67d3\u7ed3\u679c \u00b6 helm template -f ./values.yaml mysql . -n default > mysql.yaml \u90e8\u7f72traefik helm upgrade --install traefik traefik/traefik -f ./traefik/values/sjtu-traefik.yaml --namespace kube-system \u67e5\u770b\u8fd9\u6b21\u90e8\u7f72 \u6e29\u99a8\u63d0\u793a \u8fd9\u4e2a\u662f\u6709\u547d\u540d\u7a7a\u95f4\u9650\u5236\u7684\uff0c-A \u53ef\u4ee5\u67e5\u770b\u6240\u6709helm release $ helm list -A NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION traefik kube-system 5 2022-07-08 19:08:15.393244 +0800 CST deployed traefik-10.24.0 2.8.0 Helm \u5347\u7ea7\u56de\u6eda \u00b6 \u5347\u7ea7 \u00b6 \u4e3e\u4f8b\u8bf4\u660e \u4f8b\u5982\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u6765\u5347\u7ea7grafana\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7--set \u5728\u540e\u9762\u4f20\u53c2\u6570 helm upgrade --install grafana grafana/grafana \u6ce8\u610f\u4e8b\u9879 \u5728\u5347\u7ea7\u5e94\u7528\u7a0b\u5e8f\u4e4b\u524d\u53ef\u4ee5\u901a\u8fc7diff\u7684\u65b9\u5f0f\u6765\u67e5\u770b\u4e24\u4e2a\u7248\u672c\u7684\u533a\u522b\uff0c\u786e\u5b9a\u6ca1\u95ee\u9898\uff0c\u518d\u5347\u7ea7 $ helm diff upgrade --install grafana grafana/grafana -f ./grafana.yaml -n infra \u56de\u6eda \u00b6 helm rollback version-id \u65e0\u8bba\u662f\u5347\u7ea7\u8fd8\u662f\u56de\u6eda\u90fd\u662f\u6709\u4e00\u4e2a\u7684\u98ce\u9669\u7684\uff0c\u6ce8\u610f\u9632\u6b62\u8bef\u64cd\u4f5c\u3002","title":"kubernetes Helm \u5b9e\u8df5"},{"location":"Helm/helm-install/#helm","text":"","title":"Helm"},{"location":"Helm/helm-install/#helm_1","text":"Helm \u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u7ba1\u7406 Kubernetes \u5e94\u7528\u7a0b\u5e8f - Helm Charts \u53ef\u4ee5\u5b9a\u4e49\u3001\u5b89\u88c5\u548c\u5347\u7ea7\u590d\u6742\u7684 Kubernetes \u5e94\u7528\u7a0b\u5e8f\uff0cCharts \u5305\u5f88\u5bb9\u6613\u521b\u5efa\u3001\u7248\u672c\u7ba1\u7406\u3001\u5206\u4eab\u548c\u5206\u5e03. \u7b80\u5355\u53ef\u4ee5\u7406\u89e3Linux\u4e2dyum\u7684\u7684\u611f\u89c9","title":"Helm \u7b80\u4ecb"},{"location":"Helm/helm-install/#helm_2","text":"\u83b7\u53d6\u8f6f\u4ef6 \u5b98\u7f51\u5730\u5740\uff1ahttps://github.com/helm/helm/releases \u4e0b\u8f7d\u5230\u672c\u5730\u89e3\u538b\u540e\uff0c\u5c06 helm \u4e8c\u8fdb\u5236\u5305\u6587\u4ef6\u79fb\u52a8\u5230\u4efb\u610f\u7684 PATH \u8def\u5f84\u4e0b $ helm version version.BuildInfo{Version:\"v3.9.0\", GitCommit:\"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\", GitTreeState:\"clean\", GoVersion:\"go1.18.2\"} Linux \u4e0b\u5b89\u88c5 root@k8s-master:/opt# wget https://get.helm.sh/helm-v3.8.1-linux-amd64.tar.gz cni containerd helm-v3.8.1-linux-amd64.tar.gz root@k8s-master:/opt# tar -xf helm-v3.8.1-linux-amd64.tar.gz root@k8s-master:/opt/linux-amd64# mv helm /usr/bin/","title":"Helm \u5b89\u88c5"},{"location":"Helm/helm-install/#_1","text":"","title":"\u7ba1\u7406\u914d\u7f6e"},{"location":"Helm/helm-install/#chart","text":"\u4ed3\u5e93\u914d\u7f6e \u5fae\u8f6f\u7684\u6e90\uff1ahttp://mirror.azure.cn/kubernetes/charts/ \u963f\u91cc\u7684\u6e90\uff1ahttps://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts \u5b98\u65b9\u7684\u6e90\uff1ahttps://hub.kubeapps.com/charts/incubator","title":"**Chart\u56fd\u5185\u4ed3\u5e93\u914d\u7f6e **"},{"location":"Helm/helm-install/#chart_1","text":"helm repo add stable http://mirror.azure.cn/kubernetes/charts helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts root@k8s-master:/opt/linux-amd64# helm repo update # \u66f4\u65b0\u6e90","title":"\u6dfb\u52a0chart\u5b58\u50a8\u5e93"},{"location":"Helm/helm-install/#_2","text":"$ helm repo list NAME URL stable http://mirror.azure.cn/kubernetes/charts/ openbayes https://dev.openbayes.com/charts","title":"\u67e5\u770b\u5b58\u50a8\u5e93"},{"location":"Helm/helm-install/#_3","text":"root@k8s-master:/opt/linux-amd64# helm repo remove aliyun","title":"\u5220\u9664\u5b58\u50a8\u5e93"},{"location":"Helm/helm-install/#chart_2","text":"root@k8s-master:/opt/# helm fetch grafana/grafana","title":"\u4e0b\u8f7dchart\u5305"},{"location":"Helm/helm-install/#helm_3","text":"","title":"Helm \u90e8\u7f72\u5e94\u7528:"},{"location":"Helm/helm-install/#helm-traefix","text":"\u90e8\u7f72traefik \u6587\u7ae0\u53c2\u8003: https://github.com/traefik/traefik-helm-chart git clone https://github.com/traefik/traefik-helm-chart.git \u5b9a\u4e49values\u6587\u4ef6 $ cat sjtu-traefik.yaml image : name : traefik tag : \"2.7\" # values-prod.yaml # Create an IngressRoute for the dashboard ingressRoute : dashboard : enabled : false # \u7981\u7528helm\u4e2d\u6e32\u67d3\u7684dashboard\uff0c\u6211\u4eec\u81ea\u5df1\u624b\u52a8\u521b\u5efa # Configure ports ports : web : port : 8000 hostPort : 80 # \u4f7f\u7528 hostport \u6a21\u5f0f # Use nodeport if set. This is useful if you have configured Traefik in a # LoadBalancer # nodePort: 32080 # Port Redirections # Added in 2.2, you can make permanent redirects via entrypoints. # https://docs.traefik.io/routing/entrypoints/#redirection # redirectTo: websecure websecure : port : 8443 hostPort : 443 # \u4f7f\u7528 hostport \u6a21\u5f0f # Options for the main traefik service, where the entrypoints traffic comes # from. service : # \u4f7f\u7528 hostport \u6a21\u5f0f\u5c31\u4e0d\u9700\u8981Service\u4e86 enabled : false # Logs # https://docs.traefik.io/observability/logs/ #logs: # general: # level: DEBUG tolerations : # kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\u9ed8\u8ba4\u60c5\u51b5\u4e0bmaster\u662f\u6709\u6c61\u70b9\uff0c\u9700\u8981\u5bb9\u5fcd\u8fd9\u4e2a\u6c61\u70b9\u624d\u53ef\u4ee5\u90e8\u7f72 - key : \"node-role.kubernetes.io/master\" operator : \"Equal\" effect : \"NoSchedule\" nodeSelector : # \u56fa\u5b9a\u5230master1\u8282\u70b9\uff08\u8be5\u8282\u70b9\u624d\u53ef\u4ee5\u8bbf\u95ee\u5916\u7f51\uff09 kubernetes.io/hostname : \"master\"","title":"Helm \u90e8\u7f72traefix"},{"location":"Helm/helm-install/#_4","text":"helm template -f ./values.yaml mysql . -n default > mysql.yaml \u90e8\u7f72traefik helm upgrade --install traefik traefik/traefik -f ./traefik/values/sjtu-traefik.yaml --namespace kube-system \u67e5\u770b\u8fd9\u6b21\u90e8\u7f72 \u6e29\u99a8\u63d0\u793a \u8fd9\u4e2a\u662f\u6709\u547d\u540d\u7a7a\u95f4\u9650\u5236\u7684\uff0c-A \u53ef\u4ee5\u67e5\u770b\u6240\u6709helm release $ helm list -A NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION traefik kube-system 5 2022-07-08 19:08:15.393244 +0800 CST deployed traefik-10.24.0 2.8.0","title":"\u67e5\u770b\u6e32\u67d3\u7ed3\u679c"},{"location":"Helm/helm-install/#helm_4","text":"","title":"Helm \u5347\u7ea7\u56de\u6eda"},{"location":"Helm/helm-install/#_5","text":"\u4e3e\u4f8b\u8bf4\u660e \u4f8b\u5982\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u6765\u5347\u7ea7grafana\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7--set \u5728\u540e\u9762\u4f20\u53c2\u6570 helm upgrade --install grafana grafana/grafana \u6ce8\u610f\u4e8b\u9879 \u5728\u5347\u7ea7\u5e94\u7528\u7a0b\u5e8f\u4e4b\u524d\u53ef\u4ee5\u901a\u8fc7diff\u7684\u65b9\u5f0f\u6765\u67e5\u770b\u4e24\u4e2a\u7248\u672c\u7684\u533a\u522b\uff0c\u786e\u5b9a\u6ca1\u95ee\u9898\uff0c\u518d\u5347\u7ea7 $ helm diff upgrade --install grafana grafana/grafana -f ./grafana.yaml -n infra","title":"\u5347\u7ea7"},{"location":"Helm/helm-install/#_6","text":"helm rollback version-id \u65e0\u8bba\u662f\u5347\u7ea7\u8fd8\u662f\u56de\u6eda\u90fd\u662f\u6709\u4e00\u4e2a\u7684\u98ce\u9669\u7684\uff0c\u6ce8\u610f\u9632\u6b62\u8bef\u64cd\u4f5c\u3002","title":"\u56de\u6eda"},{"location":"Helm/helm/","text":"Helm \u914d\u7f6egrafana \u00b6 \u83b7\u53d6Token \u00b6 \u53c2\u8003: \u5b98\u7f51 curl -X POST -H \"Content-Type: application/json\" -d '{\"name\":\"apikeycurl\", \"role\": \"Admin\"}' http://admin:strongpassword@localhost:3000/api/auth/keys {\"id\":1,\"name\":\"apikeycurl\",\"key\":\"eyJrIjoiVHV2czQxNTdiQnFEWDJ6VjRXMjJpUTc1bGtkR2NmQUoiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoxfQ==\"}% \u6253\u5f00dashboardProviders \u00b6 \u6ce8\u610f \u6ce8\u610f\u53bb\u6389dashboardProviders\u540e\u9762\u7684{} dashboardProviders : dashboardproviders.yaml : apiVersion : 1 providers : - name : 'default' orgId : 1 folder : '' type : file disableDeletion : false editable : true options : path : /var/lib/grafana/dashboards/default # \u6dfb\u52a0\u5b98\u7f51dashboard dashboards : default : ceph-cluster : gnetId : 2842 revision : 14 datasource : Prometheus ceph-osd : gnetId : 5336 revision : 5 datasource : Prometheus ceph-pools : gnetId : 5342 revision : 5 datasource : Prometheus token : 'eyJrIjoiVHV2czQxNTdiQnFEWDJ6VjRXMjJpUTc1bGtkR2NmQUoiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoxfQ=='","title":"Helm \u914d\u7f6egrafana"},{"location":"Helm/helm/#helm-grafana","text":"","title":"Helm \u914d\u7f6egrafana"},{"location":"Helm/helm/#token","text":"\u53c2\u8003: \u5b98\u7f51 curl -X POST -H \"Content-Type: application/json\" -d '{\"name\":\"apikeycurl\", \"role\": \"Admin\"}' http://admin:strongpassword@localhost:3000/api/auth/keys {\"id\":1,\"name\":\"apikeycurl\",\"key\":\"eyJrIjoiVHV2czQxNTdiQnFEWDJ6VjRXMjJpUTc1bGtkR2NmQUoiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoxfQ==\"}%","title":"\u83b7\u53d6Token"},{"location":"Helm/helm/#dashboardproviders","text":"\u6ce8\u610f \u6ce8\u610f\u53bb\u6389dashboardProviders\u540e\u9762\u7684{} dashboardProviders : dashboardproviders.yaml : apiVersion : 1 providers : - name : 'default' orgId : 1 folder : '' type : file disableDeletion : false editable : true options : path : /var/lib/grafana/dashboards/default # \u6dfb\u52a0\u5b98\u7f51dashboard dashboards : default : ceph-cluster : gnetId : 2842 revision : 14 datasource : Prometheus ceph-osd : gnetId : 5336 revision : 5 datasource : Prometheus ceph-pools : gnetId : 5342 revision : 5 datasource : Prometheus token : 'eyJrIjoiVHV2czQxNTdiQnFEWDJ6VjRXMjJpUTc1bGtkR2NmQUoiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoxfQ=='","title":"\u6253\u5f00dashboardProviders"},{"location":"Macuse/mac-k9s-doc/","text":"**\u4ec0\u4e48\u662f k9s ** \u00b6 K9s \u662f\u4e00\u4e2a\u57fa\u4e8e\u7ec8\u7aef\u7684 UI\uff0c\u7528\u4e8e\u4e0e Kubernetes \u96c6\u7fa4\u8fdb\u884c\u4ea4\u4e92\u3002\u8be5\u9879\u76ee\u7684\u76ee\u7684\u662f\u8ba9\u60a8\u66f4\u8f7b\u677e\u5730\u5728\u91ce\u5916\u5bfc\u822a\u3001\u89c2\u5bdf\u548c\u7ba1\u7406\u5df2\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u3002K9s \u4e0d\u65ad\u76d1\u89c6 Kubernetes \u7684\u53d8\u5316\uff0c\u5e76\u63d0\u4f9b\u540e\u7eed\u547d\u4ee4\u6765\u4e0e\u60a8\u89c2\u5bdf\u5230\u7684\u8d44\u6e90\u8fdb\u884c\u4ea4\u4e92\u3002 \u5982\u4f55\u5b89\u88c5 \u00b6 MacOS # Via Homebrew brew install derailed/k9s/k9s \u5982\u4f55\u4f7f\u7528 \u00b6 \u8bf4\u767d\u4e86,\u4ed6\u5c31\u662f\u4e00\u79cd\u7ec8\u7aef\u4e0b\u7ba1\u7406 k8s \u96c6\u7fa4\u7684\u4e00\u4e2a\u5c0f\u5de5\u5177,\u65b9\u4fbf\u6211\u4eec\u7ba1\u7406\u96c6\u7fa4\u4f7f\u7528\u7684,\u5bf9\u6b64\u6211\u5f55\u5236\u4e86\u4e00\u4e2a\u5c0f\u89c6\u9891,\u5927\u6982\u8bb2\u4e86\u4e00\u4e0b\u4ed6\u5982\u4f55\u4f7f\u7528.","title":"k9s \u5b9e\u8df5\u5e94\u7528"},{"location":"Macuse/mac-k9s-doc/#k9s","text":"K9s \u662f\u4e00\u4e2a\u57fa\u4e8e\u7ec8\u7aef\u7684 UI\uff0c\u7528\u4e8e\u4e0e Kubernetes \u96c6\u7fa4\u8fdb\u884c\u4ea4\u4e92\u3002\u8be5\u9879\u76ee\u7684\u76ee\u7684\u662f\u8ba9\u60a8\u66f4\u8f7b\u677e\u5730\u5728\u91ce\u5916\u5bfc\u822a\u3001\u89c2\u5bdf\u548c\u7ba1\u7406\u5df2\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u3002K9s \u4e0d\u65ad\u76d1\u89c6 Kubernetes \u7684\u53d8\u5316\uff0c\u5e76\u63d0\u4f9b\u540e\u7eed\u547d\u4ee4\u6765\u4e0e\u60a8\u89c2\u5bdf\u5230\u7684\u8d44\u6e90\u8fdb\u884c\u4ea4\u4e92\u3002","title":"**\u4ec0\u4e48\u662f k9s **"},{"location":"Macuse/mac-k9s-doc/#_1","text":"MacOS # Via Homebrew brew install derailed/k9s/k9s","title":"\u5982\u4f55\u5b89\u88c5"},{"location":"Macuse/mac-k9s-doc/#_2","text":"\u8bf4\u767d\u4e86,\u4ed6\u5c31\u662f\u4e00\u79cd\u7ec8\u7aef\u4e0b\u7ba1\u7406 k8s \u96c6\u7fa4\u7684\u4e00\u4e2a\u5c0f\u5de5\u5177,\u65b9\u4fbf\u6211\u4eec\u7ba1\u7406\u96c6\u7fa4\u4f7f\u7528\u7684,\u5bf9\u6b64\u6211\u5f55\u5236\u4e86\u4e00\u4e2a\u5c0f\u89c6\u9891,\u5927\u6982\u8bb2\u4e86\u4e00\u4e0b\u4ed6\u5982\u4f55\u4f7f\u7528.","title":"\u5982\u4f55\u4f7f\u7528"},{"location":"Macuse/mac-kubeconfig/","text":"kubecm \u7684\u4e00\u4e9b\u5b9e\u8df5 \u00b6 \u95ee\u9898\u80cc\u666f \u00b6 \u5728\u7ef4\u62a4\u548c\u7ba1\u7406\u591a\u4e2ak8s\u96c6\u7fa4\u65f6\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u5bf9\u5e94\u7684config\u6587\u4ef6\uff0c\u90a3\u4e48\u5e26\u6765\u7684\u95ee\u9898\u5c31\u662f\u5728 ~/.kube \u76ee\u5f55\u4e0b\u5c31\u4f1a\u6709\u4e00\u5927\u5806\u5404\u79cd\u73af\u5883\u7684 yaml\uff0c\u5bf9\u4e8e\u7ba1\u7406\u6765\u8bf4\u4e0d\u662f\u7279\u522b\u7684\u53cb\u597d\u3002 \u66f4\u6709\u53ef\u80fd\u5728\u4e0d\u540c\u7684\u96c6\u7fa4\u5207\u6765\u5207\u53bb\uff0c\u9020\u6210\u8fd0\u7ef4\u4e8b\u6545\u3002\u56e0\u6b64\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u79cd\u7ba1\u7406 kubeconfig \u7684\u4e00\u79cd\u65b9\u5f0f.(\u8fd9\u4e2a\u4e3b\u8981\u4ee5 mac \u6765\u4f5c\u4e3a\u6f14\u793a). \u89e3\u51b3\u75db\u70b9 \u00b6 \u7edf\u4e00\u7ba1\u7406\u591a\u4e2ak8s\u96c6\u7fa4 \u6765\u56de\u5207\u6362\u6307\u5b9anamespace\u7e41\u7410 \u5f88\u591a\u65f6\u5019\u4e0d\u77e5\u9053\u81ea\u5df1\u5728\u54ea\u4e2a\u96c6\u7fa4\u4e0b \u5982\u4f55\u5b89\u88c5 \u00b6 Mac\u5b89\u88c5\u5730\u5740\uff1a \u53ea\u9700\u8981\u4f7f\u7528 brew \u76f4\u63a5\u5b89\u88c5kubecm\u5373\u53ef kubecm \u6848\u4f8b: \u00b6 \u53c2\u6570\u8bf4\u660e\uff1a \u6211\u6700\u5e38\u7528\u7684\u5c31\u662f\u6dfb\u52a0\uff0c\u5220\u9664\uff0c\u5207\u6362\u96c6\u7fa4 Manage your kubeconfig more easily. \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588 \u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 Tips Find more information at: https://kubecm.cloud Usage: kubecm [ command ] Available Commands: add Add KubeConfig to $HOME /.kube/config # \u6dfb\u52a0 alias Generate alias for all contexts clear Clear lapsed context, cluster and user cloud manage kubeconfig from cloud completion Generate completion script create Create new KubeConfig ( experiment ) delete Delete the specified context from the kubeconfig # \u5220\u9664 help Help about any command list List KubeConfig merge Merge multiple kubeconfig files into one namespace Switch or change namespace interactively rename Rename the contexts of kubeconfig switch Switch Kube Context interactively # \u5207\u6362 version Print version info Flags: --config string path of kubeconfig ( default \" $HOME /.kube/config\" ) -h, --help help for kubecm --ui-size int number of list items to show in menu at once ( default 4 ) Use \"kubecm [command] --help\" for more information about a command. \u9996\u5148\u6211\u4eec\u5148\u56de\u5230\uff1a\u5bb6\u76ee\u5f55\u4e0b\u7684 .kube \u76ee\u5f55 $ pwd /Users/beiyiwangdejiyi/.kube \u6dfb\u52a0\u4e00\u4e2a\u96c6\u7fa4 \u00b6 kubecm add -f enflame.yaml \u5220\u9664\u4e00\u4e2a\u96c6\u7fa4 \u00b6 $ kubecm delete # \u9009\u62e9\u5220\u9664\u7684\u96c6\u7fa4\uff0c\u9009\u62e9True Use the arrow keys to navigate: \u2193 \u2191 \u2192 \u2190 and / toggles search Select The Delete Kube Context \ud83d\ude3c ucloud-k3s ( * ) enflame produce \u2193 pve \u5207\u6362\u4e00\u4e2a\u96c6\u7fa4 \u00b6 $ kubecm switch # \u53ef\u4ee5\u4e0a\u4e0b\u5207\u6362\uff0c\u9009\u62e9\u96c6\u7fa4\u73af\u5883 Use the arrow keys to navigate: \u2193 \u2191 \u2192 \u2190 and / toggles search Select Kube Context ucloud-k3s ( * ) bj \ud83d\ude3c dev \u2193 produce \u4ee5\u4e0a\u5c31\u662fkubecm \u7684\u4e00\u4e9b\u5b89\u88c5\u548c\u4f7f\u7528\u65b9\u6cd5\uff0c\u5176\u4ed6\u7684\u5982\u679c\u611f\u5174\u8da3\u53ef\u4ee5\u81ea\u5df1\u8bd5\u4e00\u8bd5\u3002 kubens kubectx \u6587\u7ae0\u5730\u5740\uff1a kubenc kubectx\u5b89\u88c5 \u00b6 \u5982\u679c\u4f60\u4f7f\u7528Homebrew\uff0c\u4f60\u53ef\u4ee5\u50cf\u8fd9\u6837\u5b89\u88c5\uff1a brew install kubectx \u5b89\u88c5\u5b8c\u6210\u4e4b\u540e\uff0c\u6765\u8fd9\u6837\u4f7f\u7528kubens\u5c31\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5207\u6362namespace\u3002 fzf\u5b89\u88c5 \u00b6 fzf \u5b89\u88c5 fzf\u5b98\u7f51 \u8fd9\u91cc\u9762\u6bd4\u8f83\u597d\u73a9\u7684\u8fd8\u6709\u4e00\u4e2a\u5e26\u6709\u6a21\u7cca\u641c\u7d22\u7684\u4ea4\u4e92\u5f0f\u83dc\u5355\uff0c\u5b89\u88c5\u5b8c\u6210\u4e4b\u540e\u518d\u4f7f\u7528kubens\u5c31\u9999\u7684\u5f88\u554a brew install fzf $( brew --prefix ) /opt/fzf/install \u6e29\u99a8\u63d0\u793a \u5982\u679c\u4e0d\u80fd\u4f7f\u7528\uff0c\u9700\u8981\u5173\u95ed\u7ec8\u7aef\uff0c\u91cd\u65b0\u6253\u5f00 fzf\u9664\u4e86\u8fd9\u4e9b\uff0c\u8fd8\u6709\u5f88\u591a\u7684\u9a9a\u64cd\u4f5c\uff0cshell\u547d\u4ee4\u8865\u5168\uff0c\u53e6\u5916fzf \u91cd\u5199\u4e86 ctrl+r \u641c\u7d22\u5386\u53f2\u547d\u4ee4 ** \u6587\u7ae0\u53c2\u8003:** \u00b6 https://formulae.brew.sh/formula/kubecm https://github.com/sunny0826/kubecm","title":"kubeconfig \u5b9e\u8df5\u5e94\u7528"},{"location":"Macuse/mac-kubeconfig/#kubecm","text":"","title":"kubecm \u7684\u4e00\u4e9b\u5b9e\u8df5"},{"location":"Macuse/mac-kubeconfig/#_1","text":"\u5728\u7ef4\u62a4\u548c\u7ba1\u7406\u591a\u4e2ak8s\u96c6\u7fa4\u65f6\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u81ea\u5df1\u5bf9\u5e94\u7684config\u6587\u4ef6\uff0c\u90a3\u4e48\u5e26\u6765\u7684\u95ee\u9898\u5c31\u662f\u5728 ~/.kube \u76ee\u5f55\u4e0b\u5c31\u4f1a\u6709\u4e00\u5927\u5806\u5404\u79cd\u73af\u5883\u7684 yaml\uff0c\u5bf9\u4e8e\u7ba1\u7406\u6765\u8bf4\u4e0d\u662f\u7279\u522b\u7684\u53cb\u597d\u3002 \u66f4\u6709\u53ef\u80fd\u5728\u4e0d\u540c\u7684\u96c6\u7fa4\u5207\u6765\u5207\u53bb\uff0c\u9020\u6210\u8fd0\u7ef4\u4e8b\u6545\u3002\u56e0\u6b64\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u79cd\u7ba1\u7406 kubeconfig \u7684\u4e00\u79cd\u65b9\u5f0f.(\u8fd9\u4e2a\u4e3b\u8981\u4ee5 mac \u6765\u4f5c\u4e3a\u6f14\u793a).","title":"\u95ee\u9898\u80cc\u666f"},{"location":"Macuse/mac-kubeconfig/#_2","text":"\u7edf\u4e00\u7ba1\u7406\u591a\u4e2ak8s\u96c6\u7fa4 \u6765\u56de\u5207\u6362\u6307\u5b9anamespace\u7e41\u7410 \u5f88\u591a\u65f6\u5019\u4e0d\u77e5\u9053\u81ea\u5df1\u5728\u54ea\u4e2a\u96c6\u7fa4\u4e0b","title":"\u89e3\u51b3\u75db\u70b9"},{"location":"Macuse/mac-kubeconfig/#_3","text":"Mac\u5b89\u88c5\u5730\u5740\uff1a \u53ea\u9700\u8981\u4f7f\u7528 brew \u76f4\u63a5\u5b89\u88c5kubecm\u5373\u53ef","title":"\u5982\u4f55\u5b89\u88c5"},{"location":"Macuse/mac-kubeconfig/#kubecm_1","text":"\u53c2\u6570\u8bf4\u660e\uff1a \u6211\u6700\u5e38\u7528\u7684\u5c31\u662f\u6dfb\u52a0\uff0c\u5220\u9664\uff0c\u5207\u6362\u96c6\u7fa4 Manage your kubeconfig more easily. \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588 \u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588\u2588\u2588\u2588\u2588 \u2588\u2588 \u2588\u2588 Tips Find more information at: https://kubecm.cloud Usage: kubecm [ command ] Available Commands: add Add KubeConfig to $HOME /.kube/config # \u6dfb\u52a0 alias Generate alias for all contexts clear Clear lapsed context, cluster and user cloud manage kubeconfig from cloud completion Generate completion script create Create new KubeConfig ( experiment ) delete Delete the specified context from the kubeconfig # \u5220\u9664 help Help about any command list List KubeConfig merge Merge multiple kubeconfig files into one namespace Switch or change namespace interactively rename Rename the contexts of kubeconfig switch Switch Kube Context interactively # \u5207\u6362 version Print version info Flags: --config string path of kubeconfig ( default \" $HOME /.kube/config\" ) -h, --help help for kubecm --ui-size int number of list items to show in menu at once ( default 4 ) Use \"kubecm [command] --help\" for more information about a command. \u9996\u5148\u6211\u4eec\u5148\u56de\u5230\uff1a\u5bb6\u76ee\u5f55\u4e0b\u7684 .kube \u76ee\u5f55 $ pwd /Users/beiyiwangdejiyi/.kube","title":"kubecm \u6848\u4f8b:"},{"location":"Macuse/mac-kubeconfig/#_4","text":"kubecm add -f enflame.yaml","title":"\u6dfb\u52a0\u4e00\u4e2a\u96c6\u7fa4"},{"location":"Macuse/mac-kubeconfig/#_5","text":"$ kubecm delete # \u9009\u62e9\u5220\u9664\u7684\u96c6\u7fa4\uff0c\u9009\u62e9True Use the arrow keys to navigate: \u2193 \u2191 \u2192 \u2190 and / toggles search Select The Delete Kube Context \ud83d\ude3c ucloud-k3s ( * ) enflame produce \u2193 pve","title":"\u5220\u9664\u4e00\u4e2a\u96c6\u7fa4"},{"location":"Macuse/mac-kubeconfig/#_6","text":"$ kubecm switch # \u53ef\u4ee5\u4e0a\u4e0b\u5207\u6362\uff0c\u9009\u62e9\u96c6\u7fa4\u73af\u5883 Use the arrow keys to navigate: \u2193 \u2191 \u2192 \u2190 and / toggles search Select Kube Context ucloud-k3s ( * ) bj \ud83d\ude3c dev \u2193 produce \u4ee5\u4e0a\u5c31\u662fkubecm \u7684\u4e00\u4e9b\u5b89\u88c5\u548c\u4f7f\u7528\u65b9\u6cd5\uff0c\u5176\u4ed6\u7684\u5982\u679c\u611f\u5174\u8da3\u53ef\u4ee5\u81ea\u5df1\u8bd5\u4e00\u8bd5\u3002 kubens kubectx \u6587\u7ae0\u5730\u5740\uff1a kubenc","title":"\u5207\u6362\u4e00\u4e2a\u96c6\u7fa4"},{"location":"Macuse/mac-kubeconfig/#kubectx","text":"\u5982\u679c\u4f60\u4f7f\u7528Homebrew\uff0c\u4f60\u53ef\u4ee5\u50cf\u8fd9\u6837\u5b89\u88c5\uff1a brew install kubectx \u5b89\u88c5\u5b8c\u6210\u4e4b\u540e\uff0c\u6765\u8fd9\u6837\u4f7f\u7528kubens\u5c31\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5207\u6362namespace\u3002","title":"kubectx\u5b89\u88c5"},{"location":"Macuse/mac-kubeconfig/#fzf","text":"fzf \u5b89\u88c5 fzf\u5b98\u7f51 \u8fd9\u91cc\u9762\u6bd4\u8f83\u597d\u73a9\u7684\u8fd8\u6709\u4e00\u4e2a\u5e26\u6709\u6a21\u7cca\u641c\u7d22\u7684\u4ea4\u4e92\u5f0f\u83dc\u5355\uff0c\u5b89\u88c5\u5b8c\u6210\u4e4b\u540e\u518d\u4f7f\u7528kubens\u5c31\u9999\u7684\u5f88\u554a brew install fzf $( brew --prefix ) /opt/fzf/install \u6e29\u99a8\u63d0\u793a \u5982\u679c\u4e0d\u80fd\u4f7f\u7528\uff0c\u9700\u8981\u5173\u95ed\u7ec8\u7aef\uff0c\u91cd\u65b0\u6253\u5f00 fzf\u9664\u4e86\u8fd9\u4e9b\uff0c\u8fd8\u6709\u5f88\u591a\u7684\u9a9a\u64cd\u4f5c\uff0cshell\u547d\u4ee4\u8865\u5168\uff0c\u53e6\u5916fzf \u91cd\u5199\u4e86 ctrl+r \u641c\u7d22\u5386\u53f2\u547d\u4ee4","title":"fzf\u5b89\u88c5"},{"location":"Macuse/mac-kubeconfig/#_7","text":"https://formulae.brew.sh/formula/kubecm https://github.com/sunny0826/kubecm","title":"** \u6587\u7ae0\u53c2\u8003:**"},{"location":"Macuse/mac-usb-system/","text":"Mac \u5236\u4f5cLinux\u7cfb\u7edf\u76d8\uff08\u5176\u4ed6\u53d1\u884c\u7248\u90fd\u53ef\u4ee5\uff09 \u00b6 1.1. Convert ISO file to RAW img file\" $ hdiutil convert -format UDRW -o target.img ~/Downloads/CentOS-7-x86_64-Minimal-2009.iso \u6b63\u5728\u8bfb\u53d6Master Boot Record\uff08MBR\uff1a0\uff09\u2026 \u6b63\u5728\u8bfb\u53d6CentOS 7 x86_64 \uff08Apple_ISO\uff1a1\uff09\u2026 \u6b63\u5728\u8bfb\u53d6\uff08Type EF\uff1a2\uff09\u2026 . \u6b63\u5728\u8bfb\u53d6CentOS 7 x86_64 \uff08Apple_ISO\uff1a3\uff09\u2026 ............................................................................... \u5df2\u8017\u65f6\uff1a 1 .235s \u901f\u5ea6\uff1a787.3MB/\u79d2 \u8282\u7701\uff1a0.0% created: /Users/bougou/target.img.dmg 1.2. Get USB dev id $ diskutil list /dev/disk0 ( internal ) : #: TYPE NAME SIZE IDENTIFIER 0 : GUID_partition_scheme 1 .0 TB disk0 1 : Apple_APFS_ISC 524 .3 MB disk0s1 2 : Apple_APFS Container disk3 994 .7 GB disk0s2 3 : Apple_APFS_Recovery 5 .4 GB disk0s3 /dev/disk3 ( synthesized ) : #: TYPE NAME SIZE IDENTIFIER 0 : APFS Container Scheme - +994.7 GB disk3 Physical Store disk0s2 1 : APFS Volume Macintosh HD 15 .2 GB disk3s1 2 : APFS Snapshot com.apple.os.update-... 15 .2 GB disk3s1s1 3 : APFS Volume Preboot 614 .7 MB disk3s2 4 : APFS Volume Recovery 1 .6 GB disk3s3 5 : APFS Volume Data 120 .9 GB disk3s5 6 : APFS Volume VM 20 .5 KB disk3s6 /dev/disk4 ( external, physical ) : #: TYPE NAME SIZE IDENTIFIER 0 : FDisk_partition_scheme *15.5 GB disk4 1 : 0xEF 9 .0 MB disk4s2 1.3. unmountDisk $ diskutil umountDisk /dev/disk4 Unmount of all volumes on disk4 was successful 1.4. dd and eject USB $ sudo dd if = ~/target.img.dmg of = /dev/disk4 bs = 1m Password: 972 +1 records in 972 +1 records out 1019942912 bytes transferred in 47 .017375 secs ( 21692894 bytes/sec )","title":"Mac \u5236\u4f5cubuntu\u7cfb\u7edf\u76d8"},{"location":"Macuse/mac-usb-system/#mac-linux","text":"1.1. Convert ISO file to RAW img file\" $ hdiutil convert -format UDRW -o target.img ~/Downloads/CentOS-7-x86_64-Minimal-2009.iso \u6b63\u5728\u8bfb\u53d6Master Boot Record\uff08MBR\uff1a0\uff09\u2026 \u6b63\u5728\u8bfb\u53d6CentOS 7 x86_64 \uff08Apple_ISO\uff1a1\uff09\u2026 \u6b63\u5728\u8bfb\u53d6\uff08Type EF\uff1a2\uff09\u2026 . \u6b63\u5728\u8bfb\u53d6CentOS 7 x86_64 \uff08Apple_ISO\uff1a3\uff09\u2026 ............................................................................... \u5df2\u8017\u65f6\uff1a 1 .235s \u901f\u5ea6\uff1a787.3MB/\u79d2 \u8282\u7701\uff1a0.0% created: /Users/bougou/target.img.dmg 1.2. Get USB dev id $ diskutil list /dev/disk0 ( internal ) : #: TYPE NAME SIZE IDENTIFIER 0 : GUID_partition_scheme 1 .0 TB disk0 1 : Apple_APFS_ISC 524 .3 MB disk0s1 2 : Apple_APFS Container disk3 994 .7 GB disk0s2 3 : Apple_APFS_Recovery 5 .4 GB disk0s3 /dev/disk3 ( synthesized ) : #: TYPE NAME SIZE IDENTIFIER 0 : APFS Container Scheme - +994.7 GB disk3 Physical Store disk0s2 1 : APFS Volume Macintosh HD 15 .2 GB disk3s1 2 : APFS Snapshot com.apple.os.update-... 15 .2 GB disk3s1s1 3 : APFS Volume Preboot 614 .7 MB disk3s2 4 : APFS Volume Recovery 1 .6 GB disk3s3 5 : APFS Volume Data 120 .9 GB disk3s5 6 : APFS Volume VM 20 .5 KB disk3s6 /dev/disk4 ( external, physical ) : #: TYPE NAME SIZE IDENTIFIER 0 : FDisk_partition_scheme *15.5 GB disk4 1 : 0xEF 9 .0 MB disk4s2 1.3. unmountDisk $ diskutil umountDisk /dev/disk4 Unmount of all volumes on disk4 was successful 1.4. dd and eject USB $ sudo dd if = ~/target.img.dmg of = /dev/disk4 bs = 1m Password: 972 +1 records in 972 +1 records out 1019942912 bytes transferred in 47 .017375 secs ( 21692894 bytes/sec )","title":"Mac \u5236\u4f5cLinux\u7cfb\u7edf\u76d8\uff08\u5176\u4ed6\u53d1\u884c\u7248\u90fd\u53ef\u4ee5\uff09"},{"location":"Macuse/mac-vscode/","text":"mac \u4f7f\u7528code\u547d\u4ee4\u6253\u5f00VSCode \u00b6 \u89e3\u51b3VSCode\u5feb\u6377\u6307\u4ee4code\u91cd\u542f\u5931\u6548 \u6587\u7ae0\u53c2\u8003: - https://juejin.cn/post/6844903872989757447","title":"Mac vscode\u4f7f\u7528\u6280\u5de7"},{"location":"Macuse/mac-vscode/#mac-codevscode","text":"\u89e3\u51b3VSCode\u5feb\u6377\u6307\u4ee4code\u91cd\u542f\u5931\u6548 \u6587\u7ae0\u53c2\u8003: - https://juejin.cn/post/6844903872989757447","title":"mac \u4f7f\u7528code\u547d\u4ee4\u6253\u5f00VSCode"},{"location":"Nvidia/Nvidia-drive/","text":"\u5220\u9664nvidia \u76f8\u5173\u7684\u8f6f\u4ef6 \u00b6 // \u8fc7\u6ee4\u51fa\u6765\u4ee5rc\u5f00\u5934\u548cnvidia\u7684\u5305\u5e76\u5378\u8f7d dpkg -l | grep nvidia | grep \"^rc\" | awk '{print $2}' | grep -E 'nvidia' | xargs dpkg --purge dpkg -l | grep nvidia | grep \"^ii\" | awk '{print $2}' | grep -E '^nvidia' | xargs dpkg --force-all -r dpkg -l | grep nvidia | awk '{print $2}' | xargs apt remove -y dpkg -l | grep nvidia | awk '{print $2}' | xargs apt purge -y","title":"Nvidia drive"},{"location":"Nvidia/Nvidia-drive/#nvidia","text":"// \u8fc7\u6ee4\u51fa\u6765\u4ee5rc\u5f00\u5934\u548cnvidia\u7684\u5305\u5e76\u5378\u8f7d dpkg -l | grep nvidia | grep \"^rc\" | awk '{print $2}' | grep -E 'nvidia' | xargs dpkg --purge dpkg -l | grep nvidia | grep \"^ii\" | awk '{print $2}' | grep -E '^nvidia' | xargs dpkg --force-all -r dpkg -l | grep nvidia | awk '{print $2}' | xargs apt remove -y dpkg -l | grep nvidia | awk '{print $2}' | xargs apt purge -y","title":"\u5220\u9664nvidia \u76f8\u5173\u7684\u8f6f\u4ef6"},{"location":"ansible/ansible-case1/","text":"Ansible \u6982\u8ff0 \u00b6 \u7531\u4e8e\u4e92\u8054\u7f51\u7684\u5feb\u901f\u53d1\u5c55\u5bfc\u81f4\u4ea7\u54c1\u66f4\u65b0\u6362\u4ee3\u901f\u5ea6\u9010\u6b65\u589e\u957f\uff0c\u8fd0\u7ef4\u4eba\u5458\u6bcf\u5929\u90fd\u8981\u8fdb\u884c \u5927\u91cf\u7684\u7ef4\u62a4\u64cd\u4f5c\uff0c\u6309\u7167\u4f20\u7edf\u65b9\u5f0f\u8fdb\u884c\u7ef4\u62a4\u4f7f\u5f97\u5de5\u4f5c\u6548\u7387\u4f4e\u4e0b\u3002\u8fd9\u65f6\u90e8\u7f72\u81ea\u52a8\u5316\u8fd0\u7ef4\u5c31 \u53ef\u4ee5\u5c3d\u53ef\u80fd\u5b89\u5168\u3001\u9ad8\u6548\u7684\u5b8c\u6210\u8fd9\u4e9b\u5de5\u4f5c\u3002 Ansible \u662f\u57fa\u4e8e Python \u5f00\u53d1\uff0c\u96c6\u5408\u4e86\u4f17\u591a\u4f18\u79c0\u8fd0\u7ef4\u5de5\u5177\u7684\u4f18\u70b9\uff0c\u5b9e\u73b0\u4e86\u6279\u91cf\u8fd0\u884c \u547d\u4ee4\u3001\u90e8\u7f72\u7a0b\u5e8f\u3001\u914d\u7f6e\u7cfb\u7edf\u7b49\u529f\u80fd\u7684\u81ea\u52a8\u5316\u8fd0\u7ef4\u7ba1\u7406\u5de5\u5177\u3002\u9ed8\u8ba4\u901a\u8fc7 SSH \u534f\u8bae\u8fdb\u884c \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6216\u4e0b\u53d1\u914d\u7f6e\uff0c\u65e0\u9700\u90e8\u7f72\u4efb\u4f55\u5ba2\u6237\u7aef\u4ee3\u7406\u8f6f\u4ef6\uff0c\u4ece\u800c\u4f7f\u5f97\u81ea\u52a8\u5316\u73af\u5883\u90e8\u7f72 \u53d8\u5f97\u66f4\u52a0\u7b80\u5355\u3002\u53ef\u540c\u65f6\u652f\u6301\u591a\u53f0\u4e3b\u673a\u5e76\u884c\u7ba1\u7406\uff0c\u4f7f\u5f97\u7ba1\u7406\u4e3b\u673a\u66f4\u52a0\u4fbf\u6377\u3002 Ansible \u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u79cd\u57fa\u4e8e\u6a21\u5757\u8fdb\u884c\u5de5\u4f5c\u7684\u6846\u67b6\u7ed3\u6784\uff0c\u6279\u91cf\u90e8\u7f72\u80fd\u529b\u5c31\u662f\u7531 Ansible \u6240\u8fd0\u884c\u7684\u6a21\u5757\u5b9e\u73b0\u7684\u3002\u7b80\u800c\u8a00\u4e4b Ansible \u662f\u57fa\u4e8e\u201c\u6a21\u5757\u201d\u5b8c\u6210\u5404\u79cd\u201c\u4efb\u52a1\u201d\u7684\u3002\u5176 \u57fa\u672c\u6846\u67b6\u7ed3\u6784\u5982\u56fe 3.1 \u6240\u793a\u3002 \u7531\u56fe 3.1 \u53ef\u4ee5\u5f97\u51fa Ansible \u7684\u57fa\u672c\u67b6\u6784\u7531\u516d\u5927\u4ef6\u6784\u6210\u3002 Ansible core \u6838\u5fc3\u5f15\u64ce\uff1a\u5373 Ansible \u672c\u8eab\uff1b Host Inventory \u4e3b\u673a\u6e05\u5355\uff1a\u7528\u6765\u5b9a\u4e49 Ansible \u6240\u7ba1\u7406\u4e3b\u673a\uff0c\u9ed8\u8ba4\u662f\u5728 Ansible \u7684 hosts \u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u88ab\u7ba1\u7406\u4e3b\u673a\uff0c\u540c\u65f6\u4e5f\u652f\u6301\u81ea\u5b9a\u4e49\u52a8\u6001\u4e3b\u673a\u6e05\u5355\u548c\u6307\u5b9a\u5176\u5b83 \u914d\u7f6e\u6587\u4ef6\u7684\u4f4d\u7f6e\uff1b Connect plugin \u8fde\u63a5\u63d2\u4ef6\uff1a\u8d1f\u8d23\u548c\u88ab\u7ba1\u7406\u4e3b\u673a\u5b9e\u73b0\u901a\u4fe1\u3002\u9664\u652f\u6301\u4f7f\u7528 SSH \u8fde\u63a5 \u88ab\u7ba1\u7406\u4e3b\u673a\u5916\uff0cAnsible \u8fd8\u652f\u6301\u5176\u5b83\u7684\u8fde\u63a5\u65b9\u5f0f\uff0c\u6240\u4ee5\u9700\u8981\u6709\u8fde\u63a5\u63d2\u4ef6\u5c06\u5404\u4e2a\u4e3b \u673a\u7528\u8fde\u63a5\u63d2\u4ef6\u8fde\u63a5\u5230 Ansible\uff1b Playbook\uff08yaml\uff0cjinjia2\uff09\u5267\u672c\uff1a\u7528\u6765\u96c6\u4e2d\u5b9a\u4e49 Ansible \u4efb\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5373\u5c06 \u591a\u4e2a\u4efb\u52a1\u5b9a\u4e49\u5728\u4e00\u4e2a\u5267\u672c\u4e2d\u7531 Ansible \u81ea\u52a8\u6267\u884c\uff0c\u53ef\u4ee5\u7531\u63a7\u5236\u4e3b\u673a\u9488\u5bf9\u591a\u53f0\u88ab\u7ba1 \u7406\u4e3b\u673a\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u4efb\u52a1\uff1b Core modules \u6838\u5fc3\u6a21\u5757\uff1a\u662f Ansible \u81ea\u5e26\u7684\u6a21\u5757\uff0c\u4f7f\u7528\u8fd9\u4e9b\u6a21\u5757\u5c06\u8d44\u6e90\u5206\u53d1\u5230\u88ab \u7ba1\u7406\u4e3b\u673a\u4f7f\u5176\u6267\u884c\u7279\u5b9a\u4efb\u52a1\u6216\u5339\u914d\u7279\u5b9a\u7684\u72b6\u6001\uff1b Custom modules \u81ea\u5b9a\u4e49\u6a21\u5757\uff1a\u7528\u4e8e\u5b8c\u6210\u6a21\u5757\u529f\u80fd\u7684\u8865\u5145\uff0c\u53ef\u501f\u52a9\u76f8\u5173\u63d2\u4ef6\u5b8c\u6210 \u8bb0\u5f55\u65e5\u5fd7\u3001\u53d1\u9001\u90ae\u4ef6\u7b49\u529f\u80fd\u3002 \u5b89\u88c5\u90e8\u7f72 Ansible \u670d\u52a1 \u00b6 Ansible \u81ea\u52a8\u5316\u8fd0\u7ef4\u73af\u5883\u7531\u63a7\u5236\u4e3b\u673a\u4e0e\u88ab\u7ba1\u7406\u4e3b\u673a\u7ec4\u6210\u3002\u7531\u4e8e Ansible \u662f\u57fa\u4e8e SSH \u534f\u8bae \u8fdb\u884c\u901a\u4fe1\u7684\uff0c\u6240\u4ee5\u63a7\u5236\u4e3b\u673a\u5b89\u88c5 Ansible \u8f6f\u4ef6\u540e\u4e0d\u9700\u8981\u91cd\u542f\u6216\u8fd0\u884c\u4efb\u4f55\u7a0b\u5e8f\uff0c\u88ab\u7ba1\u7406\u4e3b\u673a\u4e5f \u4e0d\u9700\u8981\u5b89\u88c5\u548c\u8fd0\u884c\u4efb\u4f55\u4ee3\u7406\u7a0b\u5e8f\u3002 \u5b89\u88c5 Ansible \u00b6 Centos \u7cfb\u7edf Ansible \u53ef\u4ee5\u4f7f\u7528\u6e90\u7801\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u4e2d YUM \u8f6f\u4ef6\u5305\u7ba1\u7406\u5de5 \u5177\u8fdb\u884c\u5b89\u88c5\u3002 YUM \u65b9\u5f0f\u5b89\u88c5 Ansible\uff0c\u9700\u8981\u4f9d\u8d56\u7b2c\u4e09\u65b9\u7684 EPEL \u6e90\uff0c\u4e0b\u9762\u914d\u7f6e EPEL \u6e90 \u4f5c\u4e3a\u90e8\u7f72 Ansible \u7684 YUM \u6e90 [ root@ansible-node1 ~ ] # yum install -y epel-release [ root@ansible-node1 ~ ] # yum install -y ansible [ root@ansible-node1 ~ ] # ansible --version //\u67e5\u770bansible\u7248\u672c Mac \u7cfb\u7edf \u5b98\u65b9\u6587\u7ae0\u53c2\u8003\u5730\u5740 \u8fd9\u91cc\u4e00\u822c\u6211\u4f1a\u4f7f\u7528Mac\u7535\u8111\u4f5c\u4e3aansible-server \u6765\u6267\u884cansible\u811a\u672c brew install ansible \u914d\u7f6e\u4e3b\u673a\u6e05\u5355 \u00b6 \u51c6\u5907\u5de5\u4f5c \u914d\u7f6einventory/pve [ pve ] master.pve hostname = master ansible_host = 192 .168.1.11 ansible_ssh_user = root ansible_ssh_pass = \"pass@word1\" \u8fd9\u91cc\u9996\u5148\u6211\u4eec\u5148\u660e\u767d\uff0c\u6bcf\u4e00\u4e2a\u88ab\u63a7\u5236\u7684\u4e3b\u673a\u9ed8\u8ba4\u80af\u5b9a\u4f1a\u6709\u4e00\u4e2a\u5e10\u53f7\u548c\u5bc6\u7801\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u666e\u901a\u7528\u6237\u6765\u5bf9\u8be5\u4e3b\u673a\u8fdb\u884c\u4e00\u7cfb\u5217\u64cd\u4f5c\uff5e \u6e29\u99a8\u63d0\u793a \u53ef\u80fd\u51fa\u73b0sudo\u6743\u9650\u4e0d\u591f\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u53ef\u4ee5\u5728inventory\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9 gtx3090.c1 hostname = ubuntu ansible_ssh_user = xxx ansible_sudo_pass = xxx ansible_ssh_pass = \"password\" \u8bbe\u7f6eSSH\u65e0\u5bc6\u7801\u767b\u9646 \u00b6 \u5982\u679c\u4e0a\u4e2a\u6b65\u9aa4\u914d\u7f6e\u597d\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u53ef\u4ee5\u5ffd\u7565\uff5e \u5f53\u7136\u53ef\u4ee5\u7ed3\u5408\u4f7f\u7528\uff0c\u5177\u4f53\u573a\u666f\u8fd8\u9700\u8981\u6839\u636e\u81ea\u5df1\u60c5\u51b5\u6765\u914d\u7f6e \u4e3a\u4e86\u907f\u514d Ansible \u4e0b\u53d1\u6307\u4ee4\u65f6\u9700\u8981\u8f93\u5165\u88ab\u7ba1\u7406\u4e3b\u673a\u7684\u5bc6\u7801\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bc1\u4e66\u7b7e\u540d\u8fbe\u5230 SSH \u65e0\u5bc6\u7801\u767b\u5f55\u3002\u4f7f\u7528 ssh-keygen \u4ea7\u751f\u4e00\u5bf9\u5bc6\u94a5\uff0c\u5e76\u901a\u8fc7 ssh-copy-id \u547d\u4ee4\u6765\u53d1\u9001\u751f\u6210\u7684\u516c\u94a5\u3002 Ansible \u547d\u4ee4\u5e94\u7528\u57fa\u7840 \u00b6 Ansible \u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u884c\u7684\u65b9\u5f0f\u8fdb\u884c\u81ea\u52a8\u5316\u7ba1\u7406\u3002\u547d\u4ee4\u7684\u57fa\u672c\u8bed\u6cd5\u5982\u4e0b\u6240\u793a\uff1a ansible <host-pattern> [-m module_name] [-a args] Ansible \u5e38\u7528\u9009\u9879 host-pattern\uff1a\u6307\u5b9a\u88ab\u7ba1\u7406\u4e3b\u673a [-m module_name]\uff1a\u6307\u5b9a\u6240\u4f7f\u7528\u7684\u6a21\u5757 [-a args]\uff1a\u8bbe\u7f6e\u6a21\u5757\u5bf9\u5e94\u7684\u53c2\u6570 -C //\u9884\u6267\u884c --list-hosts //\u5217\u51fa\u6b63\u5728\u8fd0\u884c\u4efb\u52a1\u7684\u4e3b\u673a --list-tasks //\u5217\u51fatasks --limit \u4e3b\u673a\u5217\u8868 //\u53ea\u9488\u5bf9\u7279\u5b9a\u4e3b\u673a\u6267\u884c Ansible \u7684\u547d\u4ee4\u884c\u7ba1\u7406\u5de5\u5177\u90fd\u662f\u7531\u4e00\u7cfb\u5217\u6a21\u5757\u3001\u53c2\u6570\u7ec4\u6210\u7684\uff0c\u4f7f\u7528\u67d0\u4e9b\u6a21\u5757\u6216\u53c2\u6570\u4e4b\u524d\uff0c \u53ef\u4ee5\u5728\u547d\u4ee4\u540e\u9762\u52a0\u4e0a-h \u6216--help \u6765\u83b7\u53d6\u5e2e\u52a9\u3002\u4f8b\u5982\uff0cansible-doc \u5de5\u5177\u53ef\u4ee5\u4f7f\u7528 ansible-doc -h \u6216\u8005 ansible-doc --help \u67e5\u770b\u5176\u5e2e\u52a9\u4fe1\u606f\u3002 ansible-doc \u5de5\u5177\u7528\u4e8e\u67e5\u770b\u6a21\u5757\u5e2e\u52a9\u4fe1\u606f\u3002\u4e3b\u8981\u9009\u9879\u5305\u62ec\uff1a -l \u7528\u6765\u5217\u51fa\u53ef\u4f7f\u7528\u7684\u6a21\u5757\uff1b -s \u7528\u6765\u5217\u51fa\u67d0\u4e2a\u6a21\u5757\u7684\u63cf\u8ff0\u4fe1\u606f\u548c\u4f7f\u7528\u793a\u5217\u3002 \u4f8b\u5982\uff1a\u4e0b\u9762\u64cd\u4f5c\u53ef\u4ee5\u5217\u51fa yum \u6a21\u5757\u7684\u63cf\u8ff0\u4fe1\u606f\u548c\u64cd\u4f5c\u52a8\u4f5c\u3002 [ root@ansible-node1 ~ ] # ansible-doc -s yum Ansible \u81ea\u5e26\u4e86\u5f88\u591a\u6a21\u5757\uff0c\u80fd\u591f\u4e0b\u53d1\u6267\u884c Ansible \u7684\u5404\u79cd\u7ba1\u7406\u4efb\u52a1\u3002\u9996\u5148\u6765\u4e86\u89e3\u4e0b Ansible \u5e38\u7528\u7684\u8fd9\u4e9b\u6838\u5fc3\u6a21\u5757\u3002 \u63a2\u6d4b\u6a21\u5757: $ ansible mac -m ping cpu-4.mac | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } cpu-3.mac | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } cpu-1.mac | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } 1. command \u6a21\u5757 \u00b6 Ansibale \u7ba1\u7406\u5de5\u5177\u4f7f\u7528-m \u9009\u9879\u6765\u6307\u5b9a\u6240\u4f7f\u7528\u6a21\u5757\uff0c\u9ed8\u8ba4\u4f7f\u7528 command \u6a21\u5757\uff0c\u5373 -m \u9009 \u9879\u7701\u7565\u65f6\u4f1a\u8fd0\u884c\u6b64\u6a21\u5757\uff0c\u7528\u4e8e\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u8fd0\u884c\u547d\u4ee4\u3002\u4f8b\u5982\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u6267\u884c date \u547d\u4ee4\uff0c\u663e\u793a\u88ab\u7ba1\u7406\u4e3b\u673a\u65f6\u95f4\u3002\u6709\u4e09\u79cd\u6267\u884c\u547d\u4ee4\u7684\u65b9\u5f0f\u6765\u7ba1\u7406\u5199\u5165\u4e3b\u673a\u6e05\u5355\u4e2d\u7684\u4e3b\u673a\u3002 \u793a\u4f8b\u4e00\uff1a\u4f7f\u7528 IP \u5730\u5740\u67e5\u770b\u88ab\u7ba1\u7406\u4e3b\u673a\u65e5\u671f $ ansible cka -m command -a 'date' --limit cka.master cka.master | CHANGED | rc = 0 >> Wed Oct 12 12 :24:17 AM CST 2022 \u6e29\u99a8\u63d0\u793a \u8fd9\u91cc\u6211\u4f7f\u7528\u7684mac\u7b14\u8bb0\u672c\uff0c\u4f7f\u7528\u7684ansible-playbook\uff0c\u5728\u4ed3\u5e93\u4e2d\u6709\u4e00\u4e2a\u5173\u4e8eansible.cfg\u7684\u914d\u7f6e\u6587\u4ef6\u3002 $ cat ansible.cfg [ defaults ] pipelining = True strategy = free host_key_checking = False inventory = inventory //\u8fd9\u91cc\u4e3b\u8981\u7684\u76ee\u5f55\uff0c\u4e3b\u673a\u6e05\u5355\u6587\u4ef6\u4f4d\u7f6e library = library # gathering = smart fact_caching = redis # redis on stg-master fact_caching_connection = 106 .75.63.184:3389:0:OpenBayesAnsibleCache fact_caching_timeout = 0 forks = 16 [ privilege_escalation ] become = True [ diff ] always = yes \u793a\u4f8b\u4e8c\uff1a\u4f7f\u7528\u7ba1\u63a7\u4e3b\u673a\u5206\u522b\u67e5\u770b\u88ab\u7ba1\u7406 cka-1 \u548c cka-2 \u7ec4\u91cc\u9762\u6240\u6709\u4e3b\u673a\u7684\u65e5\u671f \u9996\u5148\uff0c\u9700\u8981\u51c6\u5907\u4e3b\u673a\u6587\u4ef6 $ cat inventory/cka [ cka-1 ] cka.master hostname = master0 ansible_host = 172 .30.42.244 ansible_user = lixie [ cka-2 ] cka.node1 hostname = node1 ansible_host = 172 .30.192.106 ansible_user = lixie cka.node2 hostname = node2 ansible_host = 172 .30.226.223 ansible_user = lixie \u5206\u7ec4\u6267\u884cansible \u547d\u4ee4 $ ansible cka-1 -m command -a 'date' //\u7b2c\u4e00\u7ec4 cka.master | CHANGED | rc = 0 >> Wed Oct 12 12 :42:15 AM CST 2022 $ ansible cka-2 -m command -a 'date' //\u7b2c\u4e8c\u7ec4 cka.node1 | CHANGED | rc = 0 >> Wed Oct 12 12 :38:55 AM CST 2022 cka.node2 | CHANGED | rc = 0 >> Wed Oct 12 12 :38:55 AM CST 2022 \u5f53\u7136\u4e86\uff0c\u5982\u679c\u4e0a\u9762\u7684\u53ef\u4ee5\u6b63\u786e\u6267\u884c\uff0c\u90a3\u4e48\u5176\u5b9e\u547d\u4ee4\u4e5f\u5c31\u662f\u6709\u624b\u5c31\u884c \u793a\u4f8b: $ ansible cka-2 -m command -a 'df -h' \u793a\u4f8b\u4e09\uff1a\u67e5\u770b\u6240\u6709\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u7684\u65e5\u671f [ root@ansible-node1 ~ ] # ansible all -m command -a 'date 2. User \u6a21\u5757 \u00b6 Ansible \u4e2d\u7684 user \u6a21\u5757\u7528\u4e8e\u521b\u5efa\u65b0\u7528\u6237\u548c\u66f4\u6539\u3001\u5220\u9664\u5df2\u5b58\u5728\u7684\u7528\u6237\u3002\u5176\u4e2d name \u9009\u9879\u7528 \u4e8e\u6307\u660e\u521b\u5efa\u7684\u7528\u6237\u540d\u79f0\u3002\u4e3b\u8981\u5305\u62ec\u4e24\u79cd\u72b6\u6001\uff08state\uff09\uff1a present \u8868\u793a\u6dfb\u52a0 (\u7701\u7565\u72b6\u6001\u65f6\u9ed8\u8ba4\u4f7f\u7528)\uff1b absent \u8868\u793a\u79fb\u9664 \u793a\u4f8b\u4e00\uff1a\u5728\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e0a\u521b\u5efa\u4e00\u4e2a user1 \u7528\u6237\u3002 $ ansible cka-1 -m user -a 'name=\"user1\"' \u793a\u4f8b\u4e8c\uff1a\u5220\u9664\u4e0a\u8ff0\u521b\u5efa\u7684\u7528\u6237 user1\u3002 $ ansible cka-1 -m user -a 'name=\"user1\" state=absent ' \u793a\u4f8b\u4e09: ansible\u521b\u5efa\u7528\u6237\u5e76\u6307\u5b9a\u5bc6\u7801 \u751f\u6210\u52a0\u5bc6\u5bc6\u7801 $ a = $( python3 -c 'import crypt,getpass;pw=\"pass@word\";print(crypt.crypt(pw))' ) $ echo $a 8e7klQ1BR7DIY \u66f4\u65b0\u5bc6\u7801 $ ansible note1 -m user -a 'name=test password=\"$a\" update_password=always' //\u53ef\u4ee5\u4f7f\u7528\u53d8\u91cf $ ansible cka-1 -m user -a 'name=\"user1\" password=8e7klQ1BR7DIY update_password=always' 3. cron \u6a21\u5757 \u00b6 Ansible \u4e2d\u7684 cron \u6a21\u5757\u7528\u4e8e\u5b9a\u4e49\u4efb\u52a1\u8ba1\u5212\u3002\u4e3b\u8981\u5305\u62ec\u4e24\u79cd\u72b6\u6001\uff08state\uff09\uff1a present \u8868\u793a\u6dfb\u52a0 (\u7701\u7565\u72b6\u6001\u65f6\u9ed8\u8ba4\u4f7f\u7528) absent \u8868\u793a\u79fb\u9664\u3002 4. group \u6a21\u5757 \u00b6 Ansible \u4e2d\u7684 group \u6a21\u5757\u7528\u4e8e\u5bf9\u7528\u6237\u7ec4\u8fdb\u884c\u7ba1\u7406\u3002 \u793a\u4f8b\u4e00\uff1a\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u521b\u5efa mysql \u7ec4\uff0cgid \u4e3a 555\u3002 $ ansible cka-1 -m group -a 'name=mysql gid=555 system=yes' \u793a\u4f8b\u4e8c\uff1a\u5c06\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u7684 mysql \u7528\u6237\u6dfb\u52a0\u5230 mysql \u7ec4\u4e2d\u3002 ansible cka-1 -m user -a 'name=mysql uid=555 system=yes group=mysql' 5. copy \u6a21\u5757 \u00b6 Ansible \u4e2d\u7684 copy \u6a21\u5757\u7528\u4e8e\u5b9e\u73b0\u6587\u4ef6\u590d\u5236\u548c\u6279\u91cf\u4e0b\u53d1\u6587\u4ef6\u3002\u5176\u4e2d\u4f7f\u7528 src \u6765\u5b9a\u4e49\u672c\u5730\u6e90\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 dest \u5b9a\u4e49\u88ab\u7ba1\u7406\u4e3b\u673a\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 content \u5219\u662f\u4f7f\u7528\u6307\u5b9a\u4fe1\u606f\u5185\u5bb9\u751f\u6210 \u76ee\u6807\u6587\u4ef6\u3002 \u793a \u4f8b \u4e00 \uff1a \u5c06\u672c\u5730\u6587\u4ef6 ucloud.yaml \u590d\u5236\u5230\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u7684\u6240\u6709\u4e3b\u673a\u4e0a\u7684 /tmp/(\u5f53\u7136\u4e5f\u53ef\u4ee5\u91cd\u547d\u540d)\uff0c\u5e76\u5c06\u6240\u6709\u8005\u8bbe\u7f6e\u4e3a root\uff0c\u6743\u9650\u8bbe\u7f6e\u4e3a 640\u3002 $ ansible cka-1 -m copy -a 'src=ucloud.yaml dest=/tmp/ owner=root mode=640' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a\uff0c\u9a8c\u8bc1\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u7ed3\u679c\u3002 [ cka ] root@master0:/tmp# ll total 44 drwxrwxrwt 10 root root 4096 Oct 12 10 :37 ./ drwxr-xr-x 19 root root 4096 May 24 23 :27 ../ -rw-r----- 1 root root 1172 Oct 12 10 :33 ucloud.yaml \u6e29\u99a8\u63d0\u793a \u5982\u679c\u51fa\u73b0\u4ee5\u4e0b\u7684\u62a5\u9519\u4fe1\u606f\uff0c\u662f\u56e0\u4e3a\u88ab\u7ba1\u7406\u4e3b\u673a\u5f00\u542f\u4e86 SELinux\uff0c\u9700\u8981\u5728\u88ab\u7ba1\u7406\u673a\u4e0a\u5b89\u88c5 libselinux-python \u8f6f\u4ef6\u5305\uff0c\u624d\u53ef\u4ee5\u4f7f\u7528 Ansible \u4e2d\u4e0e copy\u3001file \u76f8\u5173\u7684\u51fd\u6570\u3002 \"msg\": \"Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!\" \u793a\u4f8b\u4e8c\uff1a\u5c06\u201dHello Ansible Hi Ansible\u201d \u5199\u5165\u5230\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e0a\u7684/tmp/ucloud.yaml \u6587\u4ef6\u4e2d\u3002 \u5f53\u7136\u8fd9\u4e2a\u4f8b\u5b50\u6211\u89c9\u5f97\u5f88\u9e21\u808b\uff5e\uff0c\u6ce8\u610f\u8fd9\u5c06\u5b8c\u5168\u66ff\u6362ucloud.yaml\u91cc\u7684\u6587\u4ef6\u5185\u5bb9 $ ansible cka-1 -m copy -a 'content=\"Hello Ansible Hi Ansible\" dest=/tmp/ucloud.yaml' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a cka-1\uff0c\u9a8c\u8bc1\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u7ed3\u679c\u3002 [ cka ] root@master0:/tmp# cat ucloud.yaml Hello Ansible Hi Ansible 6. file \u6a21\u5757 \u00b6 Ansible \u4e2d\u4f7f\u7528 file \u6a21\u5757\u6765\u8bbe\u7f6e\u6587\u4ef6\u5c5e\u6027\u3002\u5176\u4e2d\u4f7f\u7528 path \u6307\u5b9a\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 src \u5b9a\u4e49 \u6e90\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 name \u6216 dest \u6765\u66ff\u6362\u521b\u5efa\u6587\u4ef6\u7684\u7b26\u53f7\u94fe\u63a5\u3002 \u793a\u4f8b\u4e00\uff1a\u8bbe\u7f6e\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e2d/tmp/ucloud.yaml \u6587\u4ef6\u7684\u6240\u5c5e\u4e3b\u4e3a mysql\uff0c\u6240\u5c5e\u7ec4\u4e3a mysql\uff0c\u6743\u9650\u4e3a 644\u3002 $ ansible cka-1 -m file -a 'owner=mysql group=mysql mode=644 path=/tmp/ucloud.yaml' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a\uff0c\u9a8c\u8bc1\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u7ed3\u679c [ cka ] root@master0:/tmp# ll -rw-r--r-- 1 mysql mysql 24 Oct 12 10 :44 ucloud.yaml 7. ping \u6a21\u5757 \u00b6 Ansible \u4e2d\u4f7f\u7528 ping \u6a21\u5757\u6765\u68c0\u6d4b\u6307\u5b9a\u4e3b\u673a\u7684\u8fde\u901a\u6027\u3002 \u793a\u4f8b\uff1a\u68c0\u6d4b\u6240\u6709\u88ab\u7ba1\u7406\u4e3b\u673a\u7684\u8fde\u901a\u6027\u3002 $ ansible cka-1 -m ping cka.master | SUCCESS = > { \"changed\" : false, \"ping\" : \"pong\" } cka.node2 | SUCCESS = > { \"changed\" : false, \"ping\" : \"pong\" } cka.node1 | SUCCESS = > { \"changed\" : false, \"ping\" : \"pong\" } 8. service \u6a21\u5757 \u00b6 Ansible \u4e2d\u4f7f\u7528 service \u6a21\u5757\u6765\u63a7\u5236\u7ba1\u7406\u670d\u52a1\u7684\u8fd0\u884c\u72b6\u6001\u3002\u5176\u4e2d\u4f7f\u7528 enabled \u8868\u793a\u662f\u5426 \u5f00\u673a\u81ea\u52a8\u542f\u52a8\uff0c\u53d6\u503c\u4e3a true \u6216\u8005 false\uff1b\u4f7f\u7528 name \u5b9a\u4e49\u670d\u52a1\u540d\u79f0\uff1b\u4f7f\u7528 state \u6307\u5b9a\u670d\u52a1\u72b6 \u6001\uff0c\u53d6\u503c\u6709 started\u3001stoped\u3001restarted\u3002 \u793a\u4f8b\u4e00\uff1a\u67e5\u770b\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a lxcfs \u670d\u52a1\u7684\u72b6\u6001\u3002 $ ansible cka-1 -a 'systemctl status lxcfs' \u793a\u4f8b\u4e8c\uff1a\u67e5\u770b\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u7684 lxcfs \u670d\u52a1\u662f\u5426\u662f\u5f00\u673a\u81ea\u52a8\u542f\u52a8\u72b6\u6001\u3002 $ ansible cka-1 -a 'systemctl is-enabled lxcfs' cka.node2 | CHANGED | rc = 0 >> enabled cka.master | CHANGED | rc = 0 >> enabled cka.node1 | CHANGED | rc = 0 >> enabled \u542f\u52a8\u88ab\u7ba1\u7406\u7ec4\u91cc\u6240\u6709\u4e3b\u673a\u7684 lxcfs \u670d\u52a1\u5e76\u4e14\u8bbe\u7f6e\u4e3a\u5f00\u673a\u81ea\u52a8\u542f\u52a8\u72b6\u6001\u3002 ansible cka-1 -m service -a 'enabled=true name=lxcfs state=started' \u542f\u52a8\u88ab\u7ba1\u7406\u7ec4\u91cc\u6240\u6709\u4e3b\u673a\u7684 lxcfs \u670d\u52a1\u5e76\u4e14\u5173\u95ed\u4e3a\u5f00\u673a\u81ea\u52a8\u542f\u52a8\u72b6\u6001 $ ansible cka-1 -m service -a 'enabled=false name=lxcfs state=started' 9. shell \u6a21\u5757 \u00b6 Ansible \u4e2d\u7684 shell \u6a21\u5757\u53ef\u4ee5\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u8fd0\u884c\u547d\u4ee4\uff0c\u5e76\u652f\u6301\u50cf\u7ba1\u9053\u7b26\u7b49\u529f\u80fd\u7684\u590d\u6742\u547d\u4ee4\u3002 \u793a\u4f8b\u4e00\uff1a\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u521b\u5efa\u7528\u6237 user2\uff0cuid\u548cgid \u90fd\u4e3a 1001\uff0c\u7528 \u6237\u5bb6\u76ee\u5f55\u4e3a/home/user1\uff0cshell \u4e3a/bin/bash\u3002 $ ansible cka-1 -m user -a 'name=user2' \u793a\u4f8b\u4e8c\uff1a\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u7684\u6240\u6709\u4e3b\u673a\u4f7f\u7528\u65e0\u4ea4\u4e92\u6a21\u5f0f\u7ed9\u7528\u6237\u8bbe\u7f6e\u5bc6\u7801\u3002 $ ansible cka-1 -m shell -a 'echo redhat|passwd --stdin user2' $ ansible cka-1 -m shell -a \"echo 'user:tju_openbayes'|chpasswd\" \u793a\u4f8b\u4e09: \u53ef\u4ee5\u4f7f\u7528\u7ba1\u9053\u7b26 $ ansible cka-1 -m shell -a 'cat /etc/passwd |wc -l' 10. script \u6a21\u5757 \u00b6 Ansible \u4e2d\u7684 script \u6a21\u5757\u53ef\u4ee5\u5c06\u672c\u5730\u811a\u672c\u590d\u5236\u5230\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u8fdb\u884c\u8fd0\u884c\u3002\u9700\u8981\u6ce8 \u610f\u7684\u662f\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\u6307\u5b9a\u811a\u672c\u4f4d\u7f6e\u3002 \u793a\u4f8b\uff1a\u7f16\u8f91\u4e00\u4e2a\u672c\u5730\u811a\u672c test.sh\uff0c\u590d\u5236\u5230\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e0a\u8fd0\u884c\u3002 $ cat test.sh #!/bin/bash echo \"hello tom\" >> /tmp/1.txt //\u51c6\u5907\u4e00\u4e2a\u6d4b\u8bd5\u811a\u672c chmod +x test.sh $ ansible cka-1 -m script -a '../scripts/test.sh' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a,\u67e5\u770b\u6267\u884c\u7ed3\u679c [ cka ] root@master0:/tmp# cat 1 .txt hello tom 11. atp \u6a21\u5757 \u00b6 Ansible \u4e2d\u7684 apt\u6a21\u5757\u8d1f\u8d23\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u5b89\u88c5\u4e0e\u5378\u8f7d\u8f6f\u4ef6\u5305\uff0c\u4f46\u662f\u9700\u8981\u63d0\u524d\u5728\u6bcf\u4e2a\u8282\u70b9\u914d\u7f6e\u81ea\u5df1\u7684 apt \u4ed3\u5e93\u3002 \u4f7f\u7528 name \u6307\u5b9a\u8981\u5b89\u88c5\u7684\u8f6f\u4ef6\u5305\uff0c\u8fd8\u53ef\u4ee5\u5e26\u4e0a\u8f6f\u4ef6\u5305\u7684\u7248\u672c\u53f7\uff1b\u5426\u5219\u5b89\u88c5\u6700\u65b0\u7684\u8f6f\u4ef6\u5305 \u4f7f\u7528 state \u6307\u5b9a\u5b89\u88c5\u8f6f\u4ef6\u5305\u7684\u72b6\u6001\uff0cpresent\u3001latest \u7528\u6765\u8868\u793a\u5b89\u88c5\uff0cabsent \u8868\u793a\u5378\u8f7d\u3002 update_cache=yes \u5f53\u8fd9\u4e2a\u53c2\u6570\u4e3ayes\u7684\u65f6\u5019\u7b49\u4e8eapt-get update \u5b89\u88c5tree\u5305 $ ansible cka-1 -m apt -a 'name=tree update_cache=yes' \u5378\u8f7dtree\u5305 $ ansible cka-1 -m apt -a 'name=tree state=absent' 12. yum \u6a21\u5757 \u00b6 \u8fd9\u91cc\u88ab\u63a7\u4e3b\u673a\u6ca1\u6709centos\u7cfb\u7edf\uff0c\u5c31\u7565\uff5e 13. setup \u6a21\u5757 \u00b6 Ansible \u4e2d\u4f7f\u7528 setup \u6a21\u5757\u6536\u96c6\u3001\u67e5\u770b\u88ab\u7ba1\u7406\u4e3b\u673a\u7684 facts\uff08facts \u662f Ansible \u91c7\u96c6 \u88ab\u7ba1\u7406\u4e3b\u673a\u8bbe\u5907\u4fe1\u606f\u7684\u4e00\u4e2a\u529f\u80fd\uff09\u3002\u6bcf\u4e2a\u88ab\u7ba1\u7406\u4e3b\u673a\u5728\u63a5\u6536\u5e76\u8fd0\u884c\u7ba1\u7406\u547d\u4ee4\u4e4b\u524d\uff0c\u90fd \u4f1a\u5c06\u81ea\u5df1\u7684\u76f8\u5173\u4fe1\u606f\uff08\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u3001IP \u5730\u5740\u7b49\uff09\u53d1\u9001\u7ed9\u63a7\u5236\u4e3b\u673a\u3002 $ ansible cka-1 -m setup 14. hostname \u6a21\u5757 \u00b6 \u53ef\u4ee5\u5229\u7528hostname \u7ed9\u4e3b\u673a\u4fee\u6539\u4e3b\u673a\u540d $ ansible cka-1 -m hostname -a 'name=nginx01' 15. cron \u6a21\u5757 \u00b6 $ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh' # \u521b\u5efa\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh disabled=yes' # \u7981\u7528\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh disabled=no' # \u542f\u7528\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh state=absent' # \u5220\u9664\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m shell -a \"crontab -l\" # \u67e5\u770b\u8ba1\u5212\u4efb\u52a1 16. Lineinfile \u6a21\u5757 \u00b6 \u5141\u8bb8\u4f60\u5728\u6587\u4ef6\u4e2d\u641c\u7d22\u7279\u5b9a\u7684\u884c\uff0c\u5e76\u5728\u627e\u5230\u5339\u914d\u9879\u65f6\u66ff\u6362\u5b83\u3002\u5982\u679c\u6ca1\u6709\u627e\u5230\u5339\u914d\u9879\uff0c\u5b83\u5c06\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u884c \u4f60\u53ef\u4ee5\u4f7f\u7528Ansible\u7684\u547d\u4ee4\u884c\u65b9\u5f0f\u6765\u6267\u884c lineinfile \u6a21\u5757\u3002\u8fd9\u662f\u4e00\u4e2a\u793a\u4f8b\uff0c\u5b83\u4f7f\u7528 ansible \u547d\u4ee4\u6765\u786e\u4fddSELinux\u8bbe\u7f6e\u4e3a\u5f3a\u5236\u6a21\u5f0f\uff1a ansible localhost -m lineinfile -a \"path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=enforcing'\" Ansible \u6848\u4f8b \u00b6 \u6848\u4f8b\u4e00\uff1acreate_user.yaml \u00b6 Ansible \u6279\u91cf\u521b\u5efa\u7528\u6237 \u8fd9\u91cc\u8bbe\u7f6epassword\u9700\u8981\u4f7f\u7528python\u547d\u4ee4\u751f\u6210sha-512\u7b97\u6cd5,pw\u662f\u8981\u52a0\u5bc6\u7684\u5bc6\u7801 a=$(python3 -c 'import crypt,getpass;pw=\"123456\";print(crypt.crypt(pw))') $ echo $a QUbhMQ9BAGQBE \u793a\u4f8b\u4e00 \u7528\u6237\u5bc6\u7801 - hosts : pve tasks : - name : ensure admin group group : name : admin state : present - name : ensure admin group nopasswd sudo copy : dest : /etc/sudoers.d/admin content : | %admin ALL=(ALL:ALL) NOPASSWD: ALL - name : add user user : name={{ item }} groups=admin password=d6F1o2yfgTymU shell=/bin/bash with_items : - user1 - user2 - user3 \u793a\u4f8b\u4e8c: \u516c\u94a5\u5f62\u5f0f tasks : - name : ensure admin group group : name : admin state : present - name : ensure admin group nopasswd sudo copy : dest : /etc/sudoers.d/admin content : | %admin ALL=(ALL:ALL) NOPASSWD: ALL - user : name : \"{{ item }}\" groups : admin shell : /bin/bash with_items : - lixie - user : name : \"{{ item }}\" state : absent with_items : - user # - ubuntu - authorized_key : user : \"{{ item.u }}\" key : \"https://github.com/{{ item.k }}.keys\" # \u516c\u94a5\u4e0a\u4f20\u5230github with_items : - { u : lixie , k : lixie021 } \u6267\u884cansible-playbook ansible-playbook -i inventory/pve pve.yaml \u5b98\u65b9\u53c2\u8003\u6587\u732e: https://gist.github.com/alces/f7e3de25d98a19550a4e4f97cabc2cf4?from_wecom=1 ansible-playbook -i ucd-mysql, add-ssh-users.yml \u9644\u4ef6 \u00b6 ubuntu22.04 \u8fd0\u884cansible\u62a5\u9519 ubuntu22.04 \u6267\u884c\u62a5\u9519 TASK [ Gathering Facts ] ******************************************************************************************************* fatal: [ axis ] : FAILED! = > { \"ansible_facts\" : {} , \"changed\" : false, \"failed_modules\" : { \"ansible.legacy.setup\" : { \"failed\" : true, \"module_stderr\" : \"/bin/sh: 1: /usr/bin/python: not found\\n\" , \"module_stdout\" : \"\" , \"msg\" : \"The module failed to execute correctly, you probably need to set the interpreter.\\nSee stdout/stderr for the exact error\" , \"rc\" : 127 }} , \"msg\" : \"The following modules failed to execute: ansible.legacy.setup\\n\" }","title":"Ansible \u5e94\u7528\u57fa\u7840"},{"location":"ansible/ansible-case1/#ansible","text":"\u7531\u4e8e\u4e92\u8054\u7f51\u7684\u5feb\u901f\u53d1\u5c55\u5bfc\u81f4\u4ea7\u54c1\u66f4\u65b0\u6362\u4ee3\u901f\u5ea6\u9010\u6b65\u589e\u957f\uff0c\u8fd0\u7ef4\u4eba\u5458\u6bcf\u5929\u90fd\u8981\u8fdb\u884c \u5927\u91cf\u7684\u7ef4\u62a4\u64cd\u4f5c\uff0c\u6309\u7167\u4f20\u7edf\u65b9\u5f0f\u8fdb\u884c\u7ef4\u62a4\u4f7f\u5f97\u5de5\u4f5c\u6548\u7387\u4f4e\u4e0b\u3002\u8fd9\u65f6\u90e8\u7f72\u81ea\u52a8\u5316\u8fd0\u7ef4\u5c31 \u53ef\u4ee5\u5c3d\u53ef\u80fd\u5b89\u5168\u3001\u9ad8\u6548\u7684\u5b8c\u6210\u8fd9\u4e9b\u5de5\u4f5c\u3002 Ansible \u662f\u57fa\u4e8e Python \u5f00\u53d1\uff0c\u96c6\u5408\u4e86\u4f17\u591a\u4f18\u79c0\u8fd0\u7ef4\u5de5\u5177\u7684\u4f18\u70b9\uff0c\u5b9e\u73b0\u4e86\u6279\u91cf\u8fd0\u884c \u547d\u4ee4\u3001\u90e8\u7f72\u7a0b\u5e8f\u3001\u914d\u7f6e\u7cfb\u7edf\u7b49\u529f\u80fd\u7684\u81ea\u52a8\u5316\u8fd0\u7ef4\u7ba1\u7406\u5de5\u5177\u3002\u9ed8\u8ba4\u901a\u8fc7 SSH \u534f\u8bae\u8fdb\u884c \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6216\u4e0b\u53d1\u914d\u7f6e\uff0c\u65e0\u9700\u90e8\u7f72\u4efb\u4f55\u5ba2\u6237\u7aef\u4ee3\u7406\u8f6f\u4ef6\uff0c\u4ece\u800c\u4f7f\u5f97\u81ea\u52a8\u5316\u73af\u5883\u90e8\u7f72 \u53d8\u5f97\u66f4\u52a0\u7b80\u5355\u3002\u53ef\u540c\u65f6\u652f\u6301\u591a\u53f0\u4e3b\u673a\u5e76\u884c\u7ba1\u7406\uff0c\u4f7f\u5f97\u7ba1\u7406\u4e3b\u673a\u66f4\u52a0\u4fbf\u6377\u3002 Ansible \u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u79cd\u57fa\u4e8e\u6a21\u5757\u8fdb\u884c\u5de5\u4f5c\u7684\u6846\u67b6\u7ed3\u6784\uff0c\u6279\u91cf\u90e8\u7f72\u80fd\u529b\u5c31\u662f\u7531 Ansible \u6240\u8fd0\u884c\u7684\u6a21\u5757\u5b9e\u73b0\u7684\u3002\u7b80\u800c\u8a00\u4e4b Ansible \u662f\u57fa\u4e8e\u201c\u6a21\u5757\u201d\u5b8c\u6210\u5404\u79cd\u201c\u4efb\u52a1\u201d\u7684\u3002\u5176 \u57fa\u672c\u6846\u67b6\u7ed3\u6784\u5982\u56fe 3.1 \u6240\u793a\u3002 \u7531\u56fe 3.1 \u53ef\u4ee5\u5f97\u51fa Ansible \u7684\u57fa\u672c\u67b6\u6784\u7531\u516d\u5927\u4ef6\u6784\u6210\u3002 Ansible core \u6838\u5fc3\u5f15\u64ce\uff1a\u5373 Ansible \u672c\u8eab\uff1b Host Inventory \u4e3b\u673a\u6e05\u5355\uff1a\u7528\u6765\u5b9a\u4e49 Ansible \u6240\u7ba1\u7406\u4e3b\u673a\uff0c\u9ed8\u8ba4\u662f\u5728 Ansible \u7684 hosts \u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u88ab\u7ba1\u7406\u4e3b\u673a\uff0c\u540c\u65f6\u4e5f\u652f\u6301\u81ea\u5b9a\u4e49\u52a8\u6001\u4e3b\u673a\u6e05\u5355\u548c\u6307\u5b9a\u5176\u5b83 \u914d\u7f6e\u6587\u4ef6\u7684\u4f4d\u7f6e\uff1b Connect plugin \u8fde\u63a5\u63d2\u4ef6\uff1a\u8d1f\u8d23\u548c\u88ab\u7ba1\u7406\u4e3b\u673a\u5b9e\u73b0\u901a\u4fe1\u3002\u9664\u652f\u6301\u4f7f\u7528 SSH \u8fde\u63a5 \u88ab\u7ba1\u7406\u4e3b\u673a\u5916\uff0cAnsible \u8fd8\u652f\u6301\u5176\u5b83\u7684\u8fde\u63a5\u65b9\u5f0f\uff0c\u6240\u4ee5\u9700\u8981\u6709\u8fde\u63a5\u63d2\u4ef6\u5c06\u5404\u4e2a\u4e3b \u673a\u7528\u8fde\u63a5\u63d2\u4ef6\u8fde\u63a5\u5230 Ansible\uff1b Playbook\uff08yaml\uff0cjinjia2\uff09\u5267\u672c\uff1a\u7528\u6765\u96c6\u4e2d\u5b9a\u4e49 Ansible \u4efb\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5373\u5c06 \u591a\u4e2a\u4efb\u52a1\u5b9a\u4e49\u5728\u4e00\u4e2a\u5267\u672c\u4e2d\u7531 Ansible \u81ea\u52a8\u6267\u884c\uff0c\u53ef\u4ee5\u7531\u63a7\u5236\u4e3b\u673a\u9488\u5bf9\u591a\u53f0\u88ab\u7ba1 \u7406\u4e3b\u673a\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u4efb\u52a1\uff1b Core modules \u6838\u5fc3\u6a21\u5757\uff1a\u662f Ansible \u81ea\u5e26\u7684\u6a21\u5757\uff0c\u4f7f\u7528\u8fd9\u4e9b\u6a21\u5757\u5c06\u8d44\u6e90\u5206\u53d1\u5230\u88ab \u7ba1\u7406\u4e3b\u673a\u4f7f\u5176\u6267\u884c\u7279\u5b9a\u4efb\u52a1\u6216\u5339\u914d\u7279\u5b9a\u7684\u72b6\u6001\uff1b Custom modules \u81ea\u5b9a\u4e49\u6a21\u5757\uff1a\u7528\u4e8e\u5b8c\u6210\u6a21\u5757\u529f\u80fd\u7684\u8865\u5145\uff0c\u53ef\u501f\u52a9\u76f8\u5173\u63d2\u4ef6\u5b8c\u6210 \u8bb0\u5f55\u65e5\u5fd7\u3001\u53d1\u9001\u90ae\u4ef6\u7b49\u529f\u80fd\u3002","title":"Ansible \u6982\u8ff0"},{"location":"ansible/ansible-case1/#ansible_1","text":"Ansible \u81ea\u52a8\u5316\u8fd0\u7ef4\u73af\u5883\u7531\u63a7\u5236\u4e3b\u673a\u4e0e\u88ab\u7ba1\u7406\u4e3b\u673a\u7ec4\u6210\u3002\u7531\u4e8e Ansible \u662f\u57fa\u4e8e SSH \u534f\u8bae \u8fdb\u884c\u901a\u4fe1\u7684\uff0c\u6240\u4ee5\u63a7\u5236\u4e3b\u673a\u5b89\u88c5 Ansible \u8f6f\u4ef6\u540e\u4e0d\u9700\u8981\u91cd\u542f\u6216\u8fd0\u884c\u4efb\u4f55\u7a0b\u5e8f\uff0c\u88ab\u7ba1\u7406\u4e3b\u673a\u4e5f \u4e0d\u9700\u8981\u5b89\u88c5\u548c\u8fd0\u884c\u4efb\u4f55\u4ee3\u7406\u7a0b\u5e8f\u3002","title":"\u5b89\u88c5\u90e8\u7f72 Ansible \u670d\u52a1"},{"location":"ansible/ansible-case1/#ansible_2","text":"Centos \u7cfb\u7edf Ansible \u53ef\u4ee5\u4f7f\u7528\u6e90\u7801\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u4e2d YUM \u8f6f\u4ef6\u5305\u7ba1\u7406\u5de5 \u5177\u8fdb\u884c\u5b89\u88c5\u3002 YUM \u65b9\u5f0f\u5b89\u88c5 Ansible\uff0c\u9700\u8981\u4f9d\u8d56\u7b2c\u4e09\u65b9\u7684 EPEL \u6e90\uff0c\u4e0b\u9762\u914d\u7f6e EPEL \u6e90 \u4f5c\u4e3a\u90e8\u7f72 Ansible \u7684 YUM \u6e90 [ root@ansible-node1 ~ ] # yum install -y epel-release [ root@ansible-node1 ~ ] # yum install -y ansible [ root@ansible-node1 ~ ] # ansible --version //\u67e5\u770bansible\u7248\u672c Mac \u7cfb\u7edf \u5b98\u65b9\u6587\u7ae0\u53c2\u8003\u5730\u5740 \u8fd9\u91cc\u4e00\u822c\u6211\u4f1a\u4f7f\u7528Mac\u7535\u8111\u4f5c\u4e3aansible-server \u6765\u6267\u884cansible\u811a\u672c brew install ansible","title":"\u5b89\u88c5 Ansible"},{"location":"ansible/ansible-case1/#_1","text":"\u51c6\u5907\u5de5\u4f5c \u914d\u7f6einventory/pve [ pve ] master.pve hostname = master ansible_host = 192 .168.1.11 ansible_ssh_user = root ansible_ssh_pass = \"pass@word1\" \u8fd9\u91cc\u9996\u5148\u6211\u4eec\u5148\u660e\u767d\uff0c\u6bcf\u4e00\u4e2a\u88ab\u63a7\u5236\u7684\u4e3b\u673a\u9ed8\u8ba4\u80af\u5b9a\u4f1a\u6709\u4e00\u4e2a\u5e10\u53f7\u548c\u5bc6\u7801\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u666e\u901a\u7528\u6237\u6765\u5bf9\u8be5\u4e3b\u673a\u8fdb\u884c\u4e00\u7cfb\u5217\u64cd\u4f5c\uff5e \u6e29\u99a8\u63d0\u793a \u53ef\u80fd\u51fa\u73b0sudo\u6743\u9650\u4e0d\u591f\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u53ef\u4ee5\u5728inventory\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9 gtx3090.c1 hostname = ubuntu ansible_ssh_user = xxx ansible_sudo_pass = xxx ansible_ssh_pass = \"password\"","title":"\u914d\u7f6e\u4e3b\u673a\u6e05\u5355"},{"location":"ansible/ansible-case1/#ssh","text":"\u5982\u679c\u4e0a\u4e2a\u6b65\u9aa4\u914d\u7f6e\u597d\uff0c\u8fd9\u4e2a\u6b65\u9aa4\u53ef\u4ee5\u5ffd\u7565\uff5e \u5f53\u7136\u53ef\u4ee5\u7ed3\u5408\u4f7f\u7528\uff0c\u5177\u4f53\u573a\u666f\u8fd8\u9700\u8981\u6839\u636e\u81ea\u5df1\u60c5\u51b5\u6765\u914d\u7f6e \u4e3a\u4e86\u907f\u514d Ansible \u4e0b\u53d1\u6307\u4ee4\u65f6\u9700\u8981\u8f93\u5165\u88ab\u7ba1\u7406\u4e3b\u673a\u7684\u5bc6\u7801\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bc1\u4e66\u7b7e\u540d\u8fbe\u5230 SSH \u65e0\u5bc6\u7801\u767b\u5f55\u3002\u4f7f\u7528 ssh-keygen \u4ea7\u751f\u4e00\u5bf9\u5bc6\u94a5\uff0c\u5e76\u901a\u8fc7 ssh-copy-id \u547d\u4ee4\u6765\u53d1\u9001\u751f\u6210\u7684\u516c\u94a5\u3002","title":"\u8bbe\u7f6eSSH\u65e0\u5bc6\u7801\u767b\u9646"},{"location":"ansible/ansible-case1/#ansible_3","text":"Ansible \u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u884c\u7684\u65b9\u5f0f\u8fdb\u884c\u81ea\u52a8\u5316\u7ba1\u7406\u3002\u547d\u4ee4\u7684\u57fa\u672c\u8bed\u6cd5\u5982\u4e0b\u6240\u793a\uff1a ansible <host-pattern> [-m module_name] [-a args] Ansible \u5e38\u7528\u9009\u9879 host-pattern\uff1a\u6307\u5b9a\u88ab\u7ba1\u7406\u4e3b\u673a [-m module_name]\uff1a\u6307\u5b9a\u6240\u4f7f\u7528\u7684\u6a21\u5757 [-a args]\uff1a\u8bbe\u7f6e\u6a21\u5757\u5bf9\u5e94\u7684\u53c2\u6570 -C //\u9884\u6267\u884c --list-hosts //\u5217\u51fa\u6b63\u5728\u8fd0\u884c\u4efb\u52a1\u7684\u4e3b\u673a --list-tasks //\u5217\u51fatasks --limit \u4e3b\u673a\u5217\u8868 //\u53ea\u9488\u5bf9\u7279\u5b9a\u4e3b\u673a\u6267\u884c Ansible \u7684\u547d\u4ee4\u884c\u7ba1\u7406\u5de5\u5177\u90fd\u662f\u7531\u4e00\u7cfb\u5217\u6a21\u5757\u3001\u53c2\u6570\u7ec4\u6210\u7684\uff0c\u4f7f\u7528\u67d0\u4e9b\u6a21\u5757\u6216\u53c2\u6570\u4e4b\u524d\uff0c \u53ef\u4ee5\u5728\u547d\u4ee4\u540e\u9762\u52a0\u4e0a-h \u6216--help \u6765\u83b7\u53d6\u5e2e\u52a9\u3002\u4f8b\u5982\uff0cansible-doc \u5de5\u5177\u53ef\u4ee5\u4f7f\u7528 ansible-doc -h \u6216\u8005 ansible-doc --help \u67e5\u770b\u5176\u5e2e\u52a9\u4fe1\u606f\u3002 ansible-doc \u5de5\u5177\u7528\u4e8e\u67e5\u770b\u6a21\u5757\u5e2e\u52a9\u4fe1\u606f\u3002\u4e3b\u8981\u9009\u9879\u5305\u62ec\uff1a -l \u7528\u6765\u5217\u51fa\u53ef\u4f7f\u7528\u7684\u6a21\u5757\uff1b -s \u7528\u6765\u5217\u51fa\u67d0\u4e2a\u6a21\u5757\u7684\u63cf\u8ff0\u4fe1\u606f\u548c\u4f7f\u7528\u793a\u5217\u3002 \u4f8b\u5982\uff1a\u4e0b\u9762\u64cd\u4f5c\u53ef\u4ee5\u5217\u51fa yum \u6a21\u5757\u7684\u63cf\u8ff0\u4fe1\u606f\u548c\u64cd\u4f5c\u52a8\u4f5c\u3002 [ root@ansible-node1 ~ ] # ansible-doc -s yum Ansible \u81ea\u5e26\u4e86\u5f88\u591a\u6a21\u5757\uff0c\u80fd\u591f\u4e0b\u53d1\u6267\u884c Ansible \u7684\u5404\u79cd\u7ba1\u7406\u4efb\u52a1\u3002\u9996\u5148\u6765\u4e86\u89e3\u4e0b Ansible \u5e38\u7528\u7684\u8fd9\u4e9b\u6838\u5fc3\u6a21\u5757\u3002 \u63a2\u6d4b\u6a21\u5757: $ ansible mac -m ping cpu-4.mac | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } cpu-3.mac | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } cpu-1.mac | SUCCESS => { \"changed\": false, \"ping\": \"pong\" }","title":"Ansible \u547d\u4ee4\u5e94\u7528\u57fa\u7840"},{"location":"ansible/ansible-case1/#1-command","text":"Ansibale \u7ba1\u7406\u5de5\u5177\u4f7f\u7528-m \u9009\u9879\u6765\u6307\u5b9a\u6240\u4f7f\u7528\u6a21\u5757\uff0c\u9ed8\u8ba4\u4f7f\u7528 command \u6a21\u5757\uff0c\u5373 -m \u9009 \u9879\u7701\u7565\u65f6\u4f1a\u8fd0\u884c\u6b64\u6a21\u5757\uff0c\u7528\u4e8e\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u8fd0\u884c\u547d\u4ee4\u3002\u4f8b\u5982\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u6267\u884c date \u547d\u4ee4\uff0c\u663e\u793a\u88ab\u7ba1\u7406\u4e3b\u673a\u65f6\u95f4\u3002\u6709\u4e09\u79cd\u6267\u884c\u547d\u4ee4\u7684\u65b9\u5f0f\u6765\u7ba1\u7406\u5199\u5165\u4e3b\u673a\u6e05\u5355\u4e2d\u7684\u4e3b\u673a\u3002 \u793a\u4f8b\u4e00\uff1a\u4f7f\u7528 IP \u5730\u5740\u67e5\u770b\u88ab\u7ba1\u7406\u4e3b\u673a\u65e5\u671f $ ansible cka -m command -a 'date' --limit cka.master cka.master | CHANGED | rc = 0 >> Wed Oct 12 12 :24:17 AM CST 2022 \u6e29\u99a8\u63d0\u793a \u8fd9\u91cc\u6211\u4f7f\u7528\u7684mac\u7b14\u8bb0\u672c\uff0c\u4f7f\u7528\u7684ansible-playbook\uff0c\u5728\u4ed3\u5e93\u4e2d\u6709\u4e00\u4e2a\u5173\u4e8eansible.cfg\u7684\u914d\u7f6e\u6587\u4ef6\u3002 $ cat ansible.cfg [ defaults ] pipelining = True strategy = free host_key_checking = False inventory = inventory //\u8fd9\u91cc\u4e3b\u8981\u7684\u76ee\u5f55\uff0c\u4e3b\u673a\u6e05\u5355\u6587\u4ef6\u4f4d\u7f6e library = library # gathering = smart fact_caching = redis # redis on stg-master fact_caching_connection = 106 .75.63.184:3389:0:OpenBayesAnsibleCache fact_caching_timeout = 0 forks = 16 [ privilege_escalation ] become = True [ diff ] always = yes \u793a\u4f8b\u4e8c\uff1a\u4f7f\u7528\u7ba1\u63a7\u4e3b\u673a\u5206\u522b\u67e5\u770b\u88ab\u7ba1\u7406 cka-1 \u548c cka-2 \u7ec4\u91cc\u9762\u6240\u6709\u4e3b\u673a\u7684\u65e5\u671f \u9996\u5148\uff0c\u9700\u8981\u51c6\u5907\u4e3b\u673a\u6587\u4ef6 $ cat inventory/cka [ cka-1 ] cka.master hostname = master0 ansible_host = 172 .30.42.244 ansible_user = lixie [ cka-2 ] cka.node1 hostname = node1 ansible_host = 172 .30.192.106 ansible_user = lixie cka.node2 hostname = node2 ansible_host = 172 .30.226.223 ansible_user = lixie \u5206\u7ec4\u6267\u884cansible \u547d\u4ee4 $ ansible cka-1 -m command -a 'date' //\u7b2c\u4e00\u7ec4 cka.master | CHANGED | rc = 0 >> Wed Oct 12 12 :42:15 AM CST 2022 $ ansible cka-2 -m command -a 'date' //\u7b2c\u4e8c\u7ec4 cka.node1 | CHANGED | rc = 0 >> Wed Oct 12 12 :38:55 AM CST 2022 cka.node2 | CHANGED | rc = 0 >> Wed Oct 12 12 :38:55 AM CST 2022 \u5f53\u7136\u4e86\uff0c\u5982\u679c\u4e0a\u9762\u7684\u53ef\u4ee5\u6b63\u786e\u6267\u884c\uff0c\u90a3\u4e48\u5176\u5b9e\u547d\u4ee4\u4e5f\u5c31\u662f\u6709\u624b\u5c31\u884c \u793a\u4f8b: $ ansible cka-2 -m command -a 'df -h' \u793a\u4f8b\u4e09\uff1a\u67e5\u770b\u6240\u6709\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u7684\u65e5\u671f [ root@ansible-node1 ~ ] # ansible all -m command -a 'date","title":"1. command \u6a21\u5757"},{"location":"ansible/ansible-case1/#2-user","text":"Ansible \u4e2d\u7684 user \u6a21\u5757\u7528\u4e8e\u521b\u5efa\u65b0\u7528\u6237\u548c\u66f4\u6539\u3001\u5220\u9664\u5df2\u5b58\u5728\u7684\u7528\u6237\u3002\u5176\u4e2d name \u9009\u9879\u7528 \u4e8e\u6307\u660e\u521b\u5efa\u7684\u7528\u6237\u540d\u79f0\u3002\u4e3b\u8981\u5305\u62ec\u4e24\u79cd\u72b6\u6001\uff08state\uff09\uff1a present \u8868\u793a\u6dfb\u52a0 (\u7701\u7565\u72b6\u6001\u65f6\u9ed8\u8ba4\u4f7f\u7528)\uff1b absent \u8868\u793a\u79fb\u9664 \u793a\u4f8b\u4e00\uff1a\u5728\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e0a\u521b\u5efa\u4e00\u4e2a user1 \u7528\u6237\u3002 $ ansible cka-1 -m user -a 'name=\"user1\"' \u793a\u4f8b\u4e8c\uff1a\u5220\u9664\u4e0a\u8ff0\u521b\u5efa\u7684\u7528\u6237 user1\u3002 $ ansible cka-1 -m user -a 'name=\"user1\" state=absent ' \u793a\u4f8b\u4e09: ansible\u521b\u5efa\u7528\u6237\u5e76\u6307\u5b9a\u5bc6\u7801 \u751f\u6210\u52a0\u5bc6\u5bc6\u7801 $ a = $( python3 -c 'import crypt,getpass;pw=\"pass@word\";print(crypt.crypt(pw))' ) $ echo $a 8e7klQ1BR7DIY \u66f4\u65b0\u5bc6\u7801 $ ansible note1 -m user -a 'name=test password=\"$a\" update_password=always' //\u53ef\u4ee5\u4f7f\u7528\u53d8\u91cf $ ansible cka-1 -m user -a 'name=\"user1\" password=8e7klQ1BR7DIY update_password=always'","title":"2. User \u6a21\u5757"},{"location":"ansible/ansible-case1/#3-cron","text":"Ansible \u4e2d\u7684 cron \u6a21\u5757\u7528\u4e8e\u5b9a\u4e49\u4efb\u52a1\u8ba1\u5212\u3002\u4e3b\u8981\u5305\u62ec\u4e24\u79cd\u72b6\u6001\uff08state\uff09\uff1a present \u8868\u793a\u6dfb\u52a0 (\u7701\u7565\u72b6\u6001\u65f6\u9ed8\u8ba4\u4f7f\u7528) absent \u8868\u793a\u79fb\u9664\u3002","title":"3. cron \u6a21\u5757"},{"location":"ansible/ansible-case1/#4-group","text":"Ansible \u4e2d\u7684 group \u6a21\u5757\u7528\u4e8e\u5bf9\u7528\u6237\u7ec4\u8fdb\u884c\u7ba1\u7406\u3002 \u793a\u4f8b\u4e00\uff1a\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u521b\u5efa mysql \u7ec4\uff0cgid \u4e3a 555\u3002 $ ansible cka-1 -m group -a 'name=mysql gid=555 system=yes' \u793a\u4f8b\u4e8c\uff1a\u5c06\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u7684 mysql \u7528\u6237\u6dfb\u52a0\u5230 mysql \u7ec4\u4e2d\u3002 ansible cka-1 -m user -a 'name=mysql uid=555 system=yes group=mysql'","title":"4. group \u6a21\u5757"},{"location":"ansible/ansible-case1/#5-copy","text":"Ansible \u4e2d\u7684 copy \u6a21\u5757\u7528\u4e8e\u5b9e\u73b0\u6587\u4ef6\u590d\u5236\u548c\u6279\u91cf\u4e0b\u53d1\u6587\u4ef6\u3002\u5176\u4e2d\u4f7f\u7528 src \u6765\u5b9a\u4e49\u672c\u5730\u6e90\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 dest \u5b9a\u4e49\u88ab\u7ba1\u7406\u4e3b\u673a\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 content \u5219\u662f\u4f7f\u7528\u6307\u5b9a\u4fe1\u606f\u5185\u5bb9\u751f\u6210 \u76ee\u6807\u6587\u4ef6\u3002 \u793a \u4f8b \u4e00 \uff1a \u5c06\u672c\u5730\u6587\u4ef6 ucloud.yaml \u590d\u5236\u5230\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u7684\u6240\u6709\u4e3b\u673a\u4e0a\u7684 /tmp/(\u5f53\u7136\u4e5f\u53ef\u4ee5\u91cd\u547d\u540d)\uff0c\u5e76\u5c06\u6240\u6709\u8005\u8bbe\u7f6e\u4e3a root\uff0c\u6743\u9650\u8bbe\u7f6e\u4e3a 640\u3002 $ ansible cka-1 -m copy -a 'src=ucloud.yaml dest=/tmp/ owner=root mode=640' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a\uff0c\u9a8c\u8bc1\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u7ed3\u679c\u3002 [ cka ] root@master0:/tmp# ll total 44 drwxrwxrwt 10 root root 4096 Oct 12 10 :37 ./ drwxr-xr-x 19 root root 4096 May 24 23 :27 ../ -rw-r----- 1 root root 1172 Oct 12 10 :33 ucloud.yaml \u6e29\u99a8\u63d0\u793a \u5982\u679c\u51fa\u73b0\u4ee5\u4e0b\u7684\u62a5\u9519\u4fe1\u606f\uff0c\u662f\u56e0\u4e3a\u88ab\u7ba1\u7406\u4e3b\u673a\u5f00\u542f\u4e86 SELinux\uff0c\u9700\u8981\u5728\u88ab\u7ba1\u7406\u673a\u4e0a\u5b89\u88c5 libselinux-python \u8f6f\u4ef6\u5305\uff0c\u624d\u53ef\u4ee5\u4f7f\u7528 Ansible \u4e2d\u4e0e copy\u3001file \u76f8\u5173\u7684\u51fd\u6570\u3002 \"msg\": \"Aborting, target uses selinux but python bindings (libselinux-python) aren't installed!\" \u793a\u4f8b\u4e8c\uff1a\u5c06\u201dHello Ansible Hi Ansible\u201d \u5199\u5165\u5230\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e0a\u7684/tmp/ucloud.yaml \u6587\u4ef6\u4e2d\u3002 \u5f53\u7136\u8fd9\u4e2a\u4f8b\u5b50\u6211\u89c9\u5f97\u5f88\u9e21\u808b\uff5e\uff0c\u6ce8\u610f\u8fd9\u5c06\u5b8c\u5168\u66ff\u6362ucloud.yaml\u91cc\u7684\u6587\u4ef6\u5185\u5bb9 $ ansible cka-1 -m copy -a 'content=\"Hello Ansible Hi Ansible\" dest=/tmp/ucloud.yaml' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a cka-1\uff0c\u9a8c\u8bc1\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u7ed3\u679c\u3002 [ cka ] root@master0:/tmp# cat ucloud.yaml Hello Ansible Hi Ansible","title":"5. copy \u6a21\u5757"},{"location":"ansible/ansible-case1/#6-file","text":"Ansible \u4e2d\u4f7f\u7528 file \u6a21\u5757\u6765\u8bbe\u7f6e\u6587\u4ef6\u5c5e\u6027\u3002\u5176\u4e2d\u4f7f\u7528 path \u6307\u5b9a\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 src \u5b9a\u4e49 \u6e90\u6587\u4ef6\u8def\u5f84\uff1b\u4f7f\u7528 name \u6216 dest \u6765\u66ff\u6362\u521b\u5efa\u6587\u4ef6\u7684\u7b26\u53f7\u94fe\u63a5\u3002 \u793a\u4f8b\u4e00\uff1a\u8bbe\u7f6e\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e2d/tmp/ucloud.yaml \u6587\u4ef6\u7684\u6240\u5c5e\u4e3b\u4e3a mysql\uff0c\u6240\u5c5e\u7ec4\u4e3a mysql\uff0c\u6743\u9650\u4e3a 644\u3002 $ ansible cka-1 -m file -a 'owner=mysql group=mysql mode=644 path=/tmp/ucloud.yaml' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a\uff0c\u9a8c\u8bc1\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u7ed3\u679c [ cka ] root@master0:/tmp# ll -rw-r--r-- 1 mysql mysql 24 Oct 12 10 :44 ucloud.yaml","title":"6. file \u6a21\u5757"},{"location":"ansible/ansible-case1/#7-ping","text":"Ansible \u4e2d\u4f7f\u7528 ping \u6a21\u5757\u6765\u68c0\u6d4b\u6307\u5b9a\u4e3b\u673a\u7684\u8fde\u901a\u6027\u3002 \u793a\u4f8b\uff1a\u68c0\u6d4b\u6240\u6709\u88ab\u7ba1\u7406\u4e3b\u673a\u7684\u8fde\u901a\u6027\u3002 $ ansible cka-1 -m ping cka.master | SUCCESS = > { \"changed\" : false, \"ping\" : \"pong\" } cka.node2 | SUCCESS = > { \"changed\" : false, \"ping\" : \"pong\" } cka.node1 | SUCCESS = > { \"changed\" : false, \"ping\" : \"pong\" }","title":"7. ping \u6a21\u5757"},{"location":"ansible/ansible-case1/#8-service","text":"Ansible \u4e2d\u4f7f\u7528 service \u6a21\u5757\u6765\u63a7\u5236\u7ba1\u7406\u670d\u52a1\u7684\u8fd0\u884c\u72b6\u6001\u3002\u5176\u4e2d\u4f7f\u7528 enabled \u8868\u793a\u662f\u5426 \u5f00\u673a\u81ea\u52a8\u542f\u52a8\uff0c\u53d6\u503c\u4e3a true \u6216\u8005 false\uff1b\u4f7f\u7528 name \u5b9a\u4e49\u670d\u52a1\u540d\u79f0\uff1b\u4f7f\u7528 state \u6307\u5b9a\u670d\u52a1\u72b6 \u6001\uff0c\u53d6\u503c\u6709 started\u3001stoped\u3001restarted\u3002 \u793a\u4f8b\u4e00\uff1a\u67e5\u770b\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a lxcfs \u670d\u52a1\u7684\u72b6\u6001\u3002 $ ansible cka-1 -a 'systemctl status lxcfs' \u793a\u4f8b\u4e8c\uff1a\u67e5\u770b\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u7684 lxcfs \u670d\u52a1\u662f\u5426\u662f\u5f00\u673a\u81ea\u52a8\u542f\u52a8\u72b6\u6001\u3002 $ ansible cka-1 -a 'systemctl is-enabled lxcfs' cka.node2 | CHANGED | rc = 0 >> enabled cka.master | CHANGED | rc = 0 >> enabled cka.node1 | CHANGED | rc = 0 >> enabled \u542f\u52a8\u88ab\u7ba1\u7406\u7ec4\u91cc\u6240\u6709\u4e3b\u673a\u7684 lxcfs \u670d\u52a1\u5e76\u4e14\u8bbe\u7f6e\u4e3a\u5f00\u673a\u81ea\u52a8\u542f\u52a8\u72b6\u6001\u3002 ansible cka-1 -m service -a 'enabled=true name=lxcfs state=started' \u542f\u52a8\u88ab\u7ba1\u7406\u7ec4\u91cc\u6240\u6709\u4e3b\u673a\u7684 lxcfs \u670d\u52a1\u5e76\u4e14\u5173\u95ed\u4e3a\u5f00\u673a\u81ea\u52a8\u542f\u52a8\u72b6\u6001 $ ansible cka-1 -m service -a 'enabled=false name=lxcfs state=started'","title":"8. service \u6a21\u5757"},{"location":"ansible/ansible-case1/#9-shell","text":"Ansible \u4e2d\u7684 shell \u6a21\u5757\u53ef\u4ee5\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u8fd0\u884c\u547d\u4ee4\uff0c\u5e76\u652f\u6301\u50cf\u7ba1\u9053\u7b26\u7b49\u529f\u80fd\u7684\u590d\u6742\u547d\u4ee4\u3002 \u793a\u4f8b\u4e00\uff1a\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u521b\u5efa\u7528\u6237 user2\uff0cuid\u548cgid \u90fd\u4e3a 1001\uff0c\u7528 \u6237\u5bb6\u76ee\u5f55\u4e3a/home/user1\uff0cshell \u4e3a/bin/bash\u3002 $ ansible cka-1 -m user -a 'name=user2' \u793a\u4f8b\u4e8c\uff1a\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u7684\u6240\u6709\u4e3b\u673a\u4f7f\u7528\u65e0\u4ea4\u4e92\u6a21\u5f0f\u7ed9\u7528\u6237\u8bbe\u7f6e\u5bc6\u7801\u3002 $ ansible cka-1 -m shell -a 'echo redhat|passwd --stdin user2' $ ansible cka-1 -m shell -a \"echo 'user:tju_openbayes'|chpasswd\" \u793a\u4f8b\u4e09: \u53ef\u4ee5\u4f7f\u7528\u7ba1\u9053\u7b26 $ ansible cka-1 -m shell -a 'cat /etc/passwd |wc -l'","title":"9. shell \u6a21\u5757"},{"location":"ansible/ansible-case1/#10-script","text":"Ansible \u4e2d\u7684 script \u6a21\u5757\u53ef\u4ee5\u5c06\u672c\u5730\u811a\u672c\u590d\u5236\u5230\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u8fdb\u884c\u8fd0\u884c\u3002\u9700\u8981\u6ce8 \u610f\u7684\u662f\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\u6307\u5b9a\u811a\u672c\u4f4d\u7f6e\u3002 \u793a\u4f8b\uff1a\u7f16\u8f91\u4e00\u4e2a\u672c\u5730\u811a\u672c test.sh\uff0c\u590d\u5236\u5230\u88ab\u7ba1\u7406\u7ec4 cka-1 \u91cc\u6240\u6709\u4e3b\u673a\u4e0a\u8fd0\u884c\u3002 $ cat test.sh #!/bin/bash echo \"hello tom\" >> /tmp/1.txt //\u51c6\u5907\u4e00\u4e2a\u6d4b\u8bd5\u811a\u672c chmod +x test.sh $ ansible cka-1 -m script -a '../scripts/test.sh' \u767b\u5f55\u88ab\u7ba1\u7406\u4e3b\u673a,\u67e5\u770b\u6267\u884c\u7ed3\u679c [ cka ] root@master0:/tmp# cat 1 .txt hello tom","title":"10. script \u6a21\u5757"},{"location":"ansible/ansible-case1/#11-atp","text":"Ansible \u4e2d\u7684 apt\u6a21\u5757\u8d1f\u8d23\u5728\u88ab\u7ba1\u7406\u4e3b\u673a\u4e0a\u5b89\u88c5\u4e0e\u5378\u8f7d\u8f6f\u4ef6\u5305\uff0c\u4f46\u662f\u9700\u8981\u63d0\u524d\u5728\u6bcf\u4e2a\u8282\u70b9\u914d\u7f6e\u81ea\u5df1\u7684 apt \u4ed3\u5e93\u3002 \u4f7f\u7528 name \u6307\u5b9a\u8981\u5b89\u88c5\u7684\u8f6f\u4ef6\u5305\uff0c\u8fd8\u53ef\u4ee5\u5e26\u4e0a\u8f6f\u4ef6\u5305\u7684\u7248\u672c\u53f7\uff1b\u5426\u5219\u5b89\u88c5\u6700\u65b0\u7684\u8f6f\u4ef6\u5305 \u4f7f\u7528 state \u6307\u5b9a\u5b89\u88c5\u8f6f\u4ef6\u5305\u7684\u72b6\u6001\uff0cpresent\u3001latest \u7528\u6765\u8868\u793a\u5b89\u88c5\uff0cabsent \u8868\u793a\u5378\u8f7d\u3002 update_cache=yes \u5f53\u8fd9\u4e2a\u53c2\u6570\u4e3ayes\u7684\u65f6\u5019\u7b49\u4e8eapt-get update \u5b89\u88c5tree\u5305 $ ansible cka-1 -m apt -a 'name=tree update_cache=yes' \u5378\u8f7dtree\u5305 $ ansible cka-1 -m apt -a 'name=tree state=absent'","title":"11. atp \u6a21\u5757"},{"location":"ansible/ansible-case1/#12-yum","text":"\u8fd9\u91cc\u88ab\u63a7\u4e3b\u673a\u6ca1\u6709centos\u7cfb\u7edf\uff0c\u5c31\u7565\uff5e","title":"12. yum \u6a21\u5757"},{"location":"ansible/ansible-case1/#13-setup","text":"Ansible \u4e2d\u4f7f\u7528 setup \u6a21\u5757\u6536\u96c6\u3001\u67e5\u770b\u88ab\u7ba1\u7406\u4e3b\u673a\u7684 facts\uff08facts \u662f Ansible \u91c7\u96c6 \u88ab\u7ba1\u7406\u4e3b\u673a\u8bbe\u5907\u4fe1\u606f\u7684\u4e00\u4e2a\u529f\u80fd\uff09\u3002\u6bcf\u4e2a\u88ab\u7ba1\u7406\u4e3b\u673a\u5728\u63a5\u6536\u5e76\u8fd0\u884c\u7ba1\u7406\u547d\u4ee4\u4e4b\u524d\uff0c\u90fd \u4f1a\u5c06\u81ea\u5df1\u7684\u76f8\u5173\u4fe1\u606f\uff08\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u3001IP \u5730\u5740\u7b49\uff09\u53d1\u9001\u7ed9\u63a7\u5236\u4e3b\u673a\u3002 $ ansible cka-1 -m setup","title":"13. setup \u6a21\u5757"},{"location":"ansible/ansible-case1/#14-hostname","text":"\u53ef\u4ee5\u5229\u7528hostname \u7ed9\u4e3b\u673a\u4fee\u6539\u4e3b\u673a\u540d $ ansible cka-1 -m hostname -a 'name=nginx01'","title":"14. hostname \u6a21\u5757"},{"location":"ansible/ansible-case1/#15-cron","text":"$ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh' # \u521b\u5efa\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh disabled=yes' # \u7981\u7528\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh disabled=no' # \u542f\u7528\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/lixie.sh state=absent' # \u5220\u9664\u8ba1\u5212\u4efb\u52a1 $ ansible mac -m shell -a \"crontab -l\" # \u67e5\u770b\u8ba1\u5212\u4efb\u52a1","title":"15. cron \u6a21\u5757"},{"location":"ansible/ansible-case1/#16-lineinfile","text":"\u5141\u8bb8\u4f60\u5728\u6587\u4ef6\u4e2d\u641c\u7d22\u7279\u5b9a\u7684\u884c\uff0c\u5e76\u5728\u627e\u5230\u5339\u914d\u9879\u65f6\u66ff\u6362\u5b83\u3002\u5982\u679c\u6ca1\u6709\u627e\u5230\u5339\u914d\u9879\uff0c\u5b83\u5c06\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u884c \u4f60\u53ef\u4ee5\u4f7f\u7528Ansible\u7684\u547d\u4ee4\u884c\u65b9\u5f0f\u6765\u6267\u884c lineinfile \u6a21\u5757\u3002\u8fd9\u662f\u4e00\u4e2a\u793a\u4f8b\uff0c\u5b83\u4f7f\u7528 ansible \u547d\u4ee4\u6765\u786e\u4fddSELinux\u8bbe\u7f6e\u4e3a\u5f3a\u5236\u6a21\u5f0f\uff1a ansible localhost -m lineinfile -a \"path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=enforcing'\"","title":"16. Lineinfile \u6a21\u5757"},{"location":"ansible/ansible-case1/#ansible_4","text":"","title":"Ansible \u6848\u4f8b"},{"location":"ansible/ansible-case1/#create_useryaml","text":"Ansible \u6279\u91cf\u521b\u5efa\u7528\u6237 \u8fd9\u91cc\u8bbe\u7f6epassword\u9700\u8981\u4f7f\u7528python\u547d\u4ee4\u751f\u6210sha-512\u7b97\u6cd5,pw\u662f\u8981\u52a0\u5bc6\u7684\u5bc6\u7801 a=$(python3 -c 'import crypt,getpass;pw=\"123456\";print(crypt.crypt(pw))') $ echo $a QUbhMQ9BAGQBE \u793a\u4f8b\u4e00 \u7528\u6237\u5bc6\u7801 - hosts : pve tasks : - name : ensure admin group group : name : admin state : present - name : ensure admin group nopasswd sudo copy : dest : /etc/sudoers.d/admin content : | %admin ALL=(ALL:ALL) NOPASSWD: ALL - name : add user user : name={{ item }} groups=admin password=d6F1o2yfgTymU shell=/bin/bash with_items : - user1 - user2 - user3 \u793a\u4f8b\u4e8c: \u516c\u94a5\u5f62\u5f0f tasks : - name : ensure admin group group : name : admin state : present - name : ensure admin group nopasswd sudo copy : dest : /etc/sudoers.d/admin content : | %admin ALL=(ALL:ALL) NOPASSWD: ALL - user : name : \"{{ item }}\" groups : admin shell : /bin/bash with_items : - lixie - user : name : \"{{ item }}\" state : absent with_items : - user # - ubuntu - authorized_key : user : \"{{ item.u }}\" key : \"https://github.com/{{ item.k }}.keys\" # \u516c\u94a5\u4e0a\u4f20\u5230github with_items : - { u : lixie , k : lixie021 } \u6267\u884cansible-playbook ansible-playbook -i inventory/pve pve.yaml \u5b98\u65b9\u53c2\u8003\u6587\u732e: https://gist.github.com/alces/f7e3de25d98a19550a4e4f97cabc2cf4?from_wecom=1 ansible-playbook -i ucd-mysql, add-ssh-users.yml","title":"\u6848\u4f8b\u4e00\uff1acreate_user.yaml"},{"location":"ansible/ansible-case1/#_2","text":"ubuntu22.04 \u8fd0\u884cansible\u62a5\u9519 ubuntu22.04 \u6267\u884c\u62a5\u9519 TASK [ Gathering Facts ] ******************************************************************************************************* fatal: [ axis ] : FAILED! = > { \"ansible_facts\" : {} , \"changed\" : false, \"failed_modules\" : { \"ansible.legacy.setup\" : { \"failed\" : true, \"module_stderr\" : \"/bin/sh: 1: /usr/bin/python: not found\\n\" , \"module_stdout\" : \"\" , \"msg\" : \"The module failed to execute correctly, you probably need to set the interpreter.\\nSee stdout/stderr for the exact error\" , \"rc\" : 127 }} , \"msg\" : \"The following modules failed to execute: ansible.legacy.setup\\n\" }","title":"\u9644\u4ef6"},{"location":"ansible/ansible-docs2/","text":"YAML \u4ecb\u7ecd \u00b6 YAML \u662f\u4e00\u79cd\u7528\u6765\u8868\u8fbe\u8d44\u6599\u5e8f\u5217\u7684\u683c\u5f0f\uff0c\u53c2\u8003\u4e86\u5176\u4ed6\u591a\u79cd\u8bed\u8a00\u6240\u4ee5\u5177\u6709\u5f88\u9ad8\u7684\u53ef \u8bfb\u6027\u3002YAML \u662f YAML Ain\u2019t Markup Language \u7684\u7f29\u5199\uff0c\u5373 YAML \u4e0d\u662f XML\u3002\u4e0d\u8fc7\u5728 \u7814\u53d1\u8fd9\u79cd\u8bed\u8a00\u65f6\uff0cYAML \u7684\u610f\u601d\u5176\u5b9e\u662f\u201dYet Another Markup Language\u201d\uff08\u4ecd\u662f\u4e00\u79cd\u6807 \u8bb0\u8bed\u8a00\uff09\u3002\u5176\u7279\u6027\u5982\u4e0b\uff1a \u5177\u6709\u5f88\u597d\u7684\u53ef\u8bfb\u6027\uff0c\u6613\u4e8e\u5b9e\u73b0\uff1b \u8868\u8fbe\u80fd\u529b\u5f3a\uff0c\u6269\u5c55\u6027\u597d\uff1b \u548c\u811a\u672c\u8bed\u8a00\u7684\u4ea4\u4e92\u6027\u597d\uff1b \u6709\u4e00\u4e2a\u4e00\u81f4\u7684\u4fe1\u606f\u6a21\u578b\uff1b \u53ef\u4ee5\u57fa\u4e8e\u6d41\u6765\u5904\u7406\u3002 YAML \u8bed\u6cd5 \u00b6 YAML \u7684\u8bed\u6cd5\u548c\u5176\u5b83\u8bed\u8a00\u7c7b\u4f3c\uff0c\u4e5f\u53ef\u4ee5\u8868\u8fbe\u6563\u5217\u8868\u3001\u6807\u91cf\u7b49\u6570\u636e\u7ed3\u6784\u3002\u5176\u4e2d\u7ed3\u6784 \uff08structure\uff09\u901a\u8fc7\u7a7a\u683c\u6765\u5c55\u793a\uff1b\u5e8f\u5217\uff08sequence\uff09\u91cc\u7684\u9879\u7528\u201d-\u201d\u6765\u4ee3\u8868\uff1bMap \u91cc\u7684\u952e\u503c \u5bf9\u7528\u201d:\u201d\u5206\u9694\u3002YAML \u6587\u4ef6\u6269\u5c55\u540d\u901a\u5e38\u4e3a\uff1ayaml\uff0c\u5982\uff1aexample.yaml\u3002\u4e0b\u9762\u662f YAML \u7684\u4e00\u4e2a\u793a\u4f8b\u3002 YAML\u5e38\u7528\u7684\u6570\u636e\u7c7b\u578b \u00b6 YAML \u4e2d\u6709\u4e24\u79cd\u5e38\u7528\u7684\u6570\u636e\u7c7b\u578b\uff1alist \u548c dictionary\u3002 1.list \uff08\u5217\u8868\uff09 \u5217\u8868\uff08list\uff09\u7684\u6240\u6709\u5143\u7d20\u5747\u4f7f\u7528\u201d-\u201d\u5f00\u5934\uff0c\u4f8b\u5982\uff1a -Apple -Orange -Strawberry -Mango 2.dictionary \u5b57\u5178\uff08dictionary\uff09\u901a\u8fc7 key \u4e0e value \u8fdb\u884c\u6807\u8bc6\uff0c\u4f8b\u5982\uff1a name: Example Developer Job: Developer Skill: Elite \u4e5f\u53ef\u4ee5\u4f7f\u7528 key:value \u7684\u5f62\u5f0f\u653e\u7f6e\u4e8e{ }\u4e2d\u8fdb\u884c\u8868\u793a\uff0c\u4f8b\u5982\uff1a { name: Example Developer, Job: Developer, Skill: Elite} Ansible \u57fa\u7840\u5143\u7d20\u4ecb\u7ecd \u00b6 ** Inventory(\u4e3b\u673a\u6e05\u5355)** \u00b6 Inventory \u6587\u4ef6\u4e2d\u4ee5\u4e2d\u62ec\u53f7\u4e2d\u7684\u5b57\u7b26\u6807\u8bc6\u4e3a\u7ec4\u540d\uff0c\u5c06\u4e3b\u673a\u5206\u7ec4\u7ba1\u7406\uff0c\u4e5f\u53ef\u4ee5\u5c06\u540c\u4e00\u4e3b\u673a\u540c\u65f6\u5212\u5206\u5230\u591a\u4e2a\u4e0d\u540c\u7684\u7ec4\u4e2d\u3002\u5982\u679c\u88ab\u7ba1\u7406\u4e3b\u673a\u4f7f\u7528\u975e\u9ed8\u8ba4\u7684SSH\u7aef\u53e3\uff0c\u4ee5\u4e0b\u4f8b\u5b50\u4e3b\u8981\u5206\u4e86\u4e24\u4e2a\u4e3b\u673a\u7ec4cka-1\u548ccka-2\uff0cinventory \u4e0b\u6709\u5f88\u591a\u7684\u4e3b\u673a\u6587\u4ef6\uff0c\u6ce8\u610f\u8fd9\u91ccansible\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u505a\u4e86\u4fee\u6539\u7684\u3002 $ cat inventory/cka [cka-1] cka.master hostname=master0 ansible_host=172.30.42.244 ansible_user=lixie [cka-2] cka.node1 hostname=node1 ansible_host=172.30.192.106 ansible_user=lixie cka.node2 hostname=node2 ansible_host=172.30.226.223 ansible_user=lixie **Inventory \u53c2\u6570: ** \u00b6 Ansible \u57fa\u4e8e SSH \u8fde\u63a5 Inventory \u4e2d\u6307\u5b9a\u7684\u88ab\u7ba1\u7406\u4e3b\u673a\u65f6\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570\u6307\u5b9a \u4ea4\u4e92\u65b9\u5f0f\uff0c\u8fd9\u4e9b\u53c2\u6570\u5982\u8868 3-2 \u6240\u793a\u3002 \u53c2\u6570 \u542b\u4e49 ansible_ssh_port \u6307\u5b9a SSH \u8fde\u63a5\u7684\u7aef\u53e3\u53f7 ansible_ssh_user \u6307\u5b9a SSH \u8fde\u63a5\u7684\u7528\u6237\u540d ansible_ssh_pass \u6307\u5b9a SSH \u8fde\u63a5\u7684\u5bc6\u7801 ansible_sudo_pass \u6307\u5b9a\u6267\u884c sudo \u547d\u4ee4\u65f6\u7684\u5bc6\u7801 ansible_connection \u5b9a\u4e49 SSH \u8fde\u63a5\u7684\u7c7b\u578b\uff08\u4f8b\u5982\uff1alocal, ssh, paramiko\uff09 ansible_ssh_private_key_file \u6307\u5b9a SSH \u8fde\u63a5\u7684\u79c1\u94a5\u6587\u4ef6\u8def\u5f84 ansible_shell_type \u6307\u5b9a\u4e3b\u673a\u6240\u4f7f\u7528\u7684 Shell \u89e3\u91ca\u5668\uff0c\u9ed8\u8ba4\u662f sh ansible_python_interpreter \u6307\u5b9a Python \u89e3\u91ca\u5668\u7684\u8def\u5f84 ansible_*_interpreter \u6307\u5b9a\u4e3b\u673a\u4e0a\u5176\u4ed6\u8bed\u6cd5\u89e3\u91ca\u5668\u7684\u8def\u5f84","title":"Ansible \u9ad8\u7ea7\u7528\u6cd5"},{"location":"ansible/ansible-docs2/#yaml","text":"YAML \u662f\u4e00\u79cd\u7528\u6765\u8868\u8fbe\u8d44\u6599\u5e8f\u5217\u7684\u683c\u5f0f\uff0c\u53c2\u8003\u4e86\u5176\u4ed6\u591a\u79cd\u8bed\u8a00\u6240\u4ee5\u5177\u6709\u5f88\u9ad8\u7684\u53ef \u8bfb\u6027\u3002YAML \u662f YAML Ain\u2019t Markup Language \u7684\u7f29\u5199\uff0c\u5373 YAML \u4e0d\u662f XML\u3002\u4e0d\u8fc7\u5728 \u7814\u53d1\u8fd9\u79cd\u8bed\u8a00\u65f6\uff0cYAML \u7684\u610f\u601d\u5176\u5b9e\u662f\u201dYet Another Markup Language\u201d\uff08\u4ecd\u662f\u4e00\u79cd\u6807 \u8bb0\u8bed\u8a00\uff09\u3002\u5176\u7279\u6027\u5982\u4e0b\uff1a \u5177\u6709\u5f88\u597d\u7684\u53ef\u8bfb\u6027\uff0c\u6613\u4e8e\u5b9e\u73b0\uff1b \u8868\u8fbe\u80fd\u529b\u5f3a\uff0c\u6269\u5c55\u6027\u597d\uff1b \u548c\u811a\u672c\u8bed\u8a00\u7684\u4ea4\u4e92\u6027\u597d\uff1b \u6709\u4e00\u4e2a\u4e00\u81f4\u7684\u4fe1\u606f\u6a21\u578b\uff1b \u53ef\u4ee5\u57fa\u4e8e\u6d41\u6765\u5904\u7406\u3002","title":"YAML \u4ecb\u7ecd"},{"location":"ansible/ansible-docs2/#yaml_1","text":"YAML \u7684\u8bed\u6cd5\u548c\u5176\u5b83\u8bed\u8a00\u7c7b\u4f3c\uff0c\u4e5f\u53ef\u4ee5\u8868\u8fbe\u6563\u5217\u8868\u3001\u6807\u91cf\u7b49\u6570\u636e\u7ed3\u6784\u3002\u5176\u4e2d\u7ed3\u6784 \uff08structure\uff09\u901a\u8fc7\u7a7a\u683c\u6765\u5c55\u793a\uff1b\u5e8f\u5217\uff08sequence\uff09\u91cc\u7684\u9879\u7528\u201d-\u201d\u6765\u4ee3\u8868\uff1bMap \u91cc\u7684\u952e\u503c \u5bf9\u7528\u201d:\u201d\u5206\u9694\u3002YAML \u6587\u4ef6\u6269\u5c55\u540d\u901a\u5e38\u4e3a\uff1ayaml\uff0c\u5982\uff1aexample.yaml\u3002\u4e0b\u9762\u662f YAML \u7684\u4e00\u4e2a\u793a\u4f8b\u3002","title":"YAML \u8bed\u6cd5"},{"location":"ansible/ansible-docs2/#yaml_2","text":"YAML \u4e2d\u6709\u4e24\u79cd\u5e38\u7528\u7684\u6570\u636e\u7c7b\u578b\uff1alist \u548c dictionary\u3002 1.list \uff08\u5217\u8868\uff09 \u5217\u8868\uff08list\uff09\u7684\u6240\u6709\u5143\u7d20\u5747\u4f7f\u7528\u201d-\u201d\u5f00\u5934\uff0c\u4f8b\u5982\uff1a -Apple -Orange -Strawberry -Mango 2.dictionary \u5b57\u5178\uff08dictionary\uff09\u901a\u8fc7 key \u4e0e value \u8fdb\u884c\u6807\u8bc6\uff0c\u4f8b\u5982\uff1a name: Example Developer Job: Developer Skill: Elite \u4e5f\u53ef\u4ee5\u4f7f\u7528 key:value \u7684\u5f62\u5f0f\u653e\u7f6e\u4e8e{ }\u4e2d\u8fdb\u884c\u8868\u793a\uff0c\u4f8b\u5982\uff1a { name: Example Developer, Job: Developer, Skill: Elite}","title":"YAML\u5e38\u7528\u7684\u6570\u636e\u7c7b\u578b"},{"location":"ansible/ansible-docs2/#ansible","text":"","title":"Ansible \u57fa\u7840\u5143\u7d20\u4ecb\u7ecd"},{"location":"ansible/ansible-docs2/#inventory","text":"Inventory \u6587\u4ef6\u4e2d\u4ee5\u4e2d\u62ec\u53f7\u4e2d\u7684\u5b57\u7b26\u6807\u8bc6\u4e3a\u7ec4\u540d\uff0c\u5c06\u4e3b\u673a\u5206\u7ec4\u7ba1\u7406\uff0c\u4e5f\u53ef\u4ee5\u5c06\u540c\u4e00\u4e3b\u673a\u540c\u65f6\u5212\u5206\u5230\u591a\u4e2a\u4e0d\u540c\u7684\u7ec4\u4e2d\u3002\u5982\u679c\u88ab\u7ba1\u7406\u4e3b\u673a\u4f7f\u7528\u975e\u9ed8\u8ba4\u7684SSH\u7aef\u53e3\uff0c\u4ee5\u4e0b\u4f8b\u5b50\u4e3b\u8981\u5206\u4e86\u4e24\u4e2a\u4e3b\u673a\u7ec4cka-1\u548ccka-2\uff0cinventory \u4e0b\u6709\u5f88\u591a\u7684\u4e3b\u673a\u6587\u4ef6\uff0c\u6ce8\u610f\u8fd9\u91ccansible\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u505a\u4e86\u4fee\u6539\u7684\u3002 $ cat inventory/cka [cka-1] cka.master hostname=master0 ansible_host=172.30.42.244 ansible_user=lixie [cka-2] cka.node1 hostname=node1 ansible_host=172.30.192.106 ansible_user=lixie cka.node2 hostname=node2 ansible_host=172.30.226.223 ansible_user=lixie","title":"** Inventory(\u4e3b\u673a\u6e05\u5355)**"},{"location":"ansible/ansible-docs2/#inventory_1","text":"Ansible \u57fa\u4e8e SSH \u8fde\u63a5 Inventory \u4e2d\u6307\u5b9a\u7684\u88ab\u7ba1\u7406\u4e3b\u673a\u65f6\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570\u6307\u5b9a \u4ea4\u4e92\u65b9\u5f0f\uff0c\u8fd9\u4e9b\u53c2\u6570\u5982\u8868 3-2 \u6240\u793a\u3002 \u53c2\u6570 \u542b\u4e49 ansible_ssh_port \u6307\u5b9a SSH \u8fde\u63a5\u7684\u7aef\u53e3\u53f7 ansible_ssh_user \u6307\u5b9a SSH \u8fde\u63a5\u7684\u7528\u6237\u540d ansible_ssh_pass \u6307\u5b9a SSH \u8fde\u63a5\u7684\u5bc6\u7801 ansible_sudo_pass \u6307\u5b9a\u6267\u884c sudo \u547d\u4ee4\u65f6\u7684\u5bc6\u7801 ansible_connection \u5b9a\u4e49 SSH \u8fde\u63a5\u7684\u7c7b\u578b\uff08\u4f8b\u5982\uff1alocal, ssh, paramiko\uff09 ansible_ssh_private_key_file \u6307\u5b9a SSH \u8fde\u63a5\u7684\u79c1\u94a5\u6587\u4ef6\u8def\u5f84 ansible_shell_type \u6307\u5b9a\u4e3b\u673a\u6240\u4f7f\u7528\u7684 Shell \u89e3\u91ca\u5668\uff0c\u9ed8\u8ba4\u662f sh ansible_python_interpreter \u6307\u5b9a Python \u89e3\u91ca\u5668\u7684\u8def\u5f84 ansible_*_interpreter \u6307\u5b9a\u4e3b\u673a\u4e0a\u5176\u4ed6\u8bed\u6cd5\u89e3\u91ca\u5668\u7684\u8def\u5f84","title":"**Inventory \u53c2\u6570: **"},{"location":"ansible/ansible-install-docs/","text":"Mac \u5b89\u88c5 ansible \u00b6 brew install ansible \u53c2\u8003\u6587\u7ae0 \u00b6 https://formulae.brew.sh/formula/ansible","title":"Ansible \u5b89\u88c5"},{"location":"ansible/ansible-install-docs/#mac-ansible","text":"brew install ansible","title":"Mac \u5b89\u88c5 ansible"},{"location":"ansible/ansible-install-docs/#_1","text":"https://formulae.brew.sh/formula/ansible","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"ansible/ansible-playbook/","text":"playbook \u914d\u7f6e\u6587\u4ef6 \u00b6 Playbook\u914d\u7f6e\u6587\u4ef6\u4f7f\u7528YAML\u8bed\u6cd5\uff0c\u5177\u6709\u7b80\u4ecb\u660e\u4e86\uff0c\u7ed3\u6784\u6e05\u6670\u7b49\u7279\u70b9\u3002Playbook\u914d\u7f6e\u6587\u4ef6\u7c7b\u4f3c\u4e8eshell\u811a\u672c\uff0c\u662f\u4e00\u4e2aYAML\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u7528\u4e8e\u4fdd\u5b58\u9488\u5bf9\u7279\u5b9a\u9700\u6c42\u7684\u4efb\u52a1\u5217\u8868\uff0c\u524d\u9762\u4ecb\u7ecd\u7684ansible\u547d\u4ee4\u867d\u7136\u53ef\u4ee5\u5b8c\u6210\u5404\u79cd\u4efb\u52a1\uff0c\u4f46\u662f\u5f53\u914d\u7f6e\u4e00\u7cfb\u5217\u4efb\u52a1\u65f6\uff0c\u9010\u6761\u8f93\u5165\u547d\u4ee4\u5c31\u663e\u5f97\u6548\u7387\u975e\u5e38\u4f4e\u4e0b\uff0c\u66f4\u6709\u6548\u7684\u65b9\u5f0f\u5728playbook\u914d\u7f6e\u4e2d\u914d\u7f6e\u6240\u6709\u7684\u4efb\u52a1\u4ee3\u7801\uff0c\u5229\u7528ansible-playbook\u547d\u4ee4\u6267\u884c\u8be5\u6587\u4ef6\uff0c\u53ef\u4ee5\u5b9e\u73b0\u81ea\u52a8\u5316\u8fd0\u7ef4\uff0cYAML\u6587\u4ef6\u7684\u6269\u5c55\u540d\u901a\u5e38\u4e3a.yaml\u6216.yml\u3002 YAML\u8bed\u6cd5\u548c\u5176\u4ed6\u9ad8\u7ea7\u8bed\u8a00\u7c7b\u4f3c\uff0c\u5176\u7ed3\u6784\u901a\u8fc7\u7f29\u8fdb\u6765\u5c55\u793a\uff0c\u901a\u8fc7\u201c-\u201d\u6765\u4ee3\u8868\u9009\u9879\uff0c\u901a\u8fc7\u5192\u53f7\u201c\uff1a\u201d\u6765\u5206\u9694\u952e\u548c\u503c\u3002\u6574\u4e2a\u6587\u4ef6\u4ee5\u201c---\u201d\u5f00\u59cb\u5e76\u4ee5\u201c\u2026\u201d\u7ed3\u675f\uff0c\u5982\u4e0b\u6240\u793a \u4fee\u6539hosts\u6587\u4ef6 [root@ansible ~]# vim /etc/ansible/hosts [test01] 192.168.200.112 [test02] 192.168.200.113 [root@ansible ~]# vim /etc/ansible/test.yml --- - hosts: test01 remote_user: root tasks: - name: adduser user: name=user2 state=present tags: - testaaa - name: addgroup group: name=root system=yes tags: - testbbb - hosts: test02 remote_user: root tasks: - name: copy file copy: src=/etc/passwd dest=/home tags: - testccc \u6ce8\u91ca: [root@ansible ~]# vim /etc/ansible/test.yml //\u521b\u5efatest\uff0cyml\u6587\u4ef6 --- //\u5f00\u5934\u683c\u5f0f\uff08\u53ef\u5ffd\u7565\uff09 - hosts: test01 //\u8868\u793a\u5bf9test01\uff08192.168.200.112\uff09\u7684\u64cd\u4f5c remote_user: root //\u8fdc\u7aef\u6267\u884c\u7528\u6237\u8eab\u4efdroot tasks: //\u4efb\u52a1\u5217\u8868 - name: adduser //\u4efb\u52a1\u540d\u79f0 user: name=user2 state=present //\u6267\u884cuser\u6a21\u5757\u521b\u5efa\u7528\u6237 tags: //\u521b\u5efatag\u6807\u7b7e - testaaa //tag\u6807\u7b7e\u4e3atestaaa - name: addgroup //\u4efb\u52a1\u540d\u79f0 group: name=root system=yes //\u6267\u884cgroup\u6a21\u5757\u521b\u5efa\u7ec4 tags: //\u521b\u5efatag\u6807\u7b7e - testbbb //tag\u6807\u7b7e\u4e3atestbbb - hosts\uff1atest02 //\u8868\u793a\u5bf9test02\uff08192.168.200.113\uff09\u7684\u64cd\u4f5c remote_user: root //\u8fdc\u7aef\u6267\u884c\u7528\u6237\u8eab\u4efdroot tasks: //\u4efb\u52a1\u5217\u8868 - name: copy file to test //\u4efb\u52a1\u540d\u79f0 copy: src=/etc/passwd dest=/home //\u6267\u884ccopy\u6a21\u5757\u590d\u5236\u6587\u4ef6 tags: //\u521b\u5efatag\u6807\u7b7e - testccc //tag\u6807\u7b7e\u4e3atestccc ... //\u7ed3\u5c3e\u683c\u5f0f\uff08\u53ef\u5ffd\u7565\uff09 \u6240\u6709\u7684\u201c-\u201d\u548c\u201c\uff1a\u201d\u540e\u9762\u5747\u6709\u7a7a\u683c\uff0c\u800c\u4e14\u8981\u6ce8\u610f\u7f29\u8fdb\u548c\u5bf9\u9f50 Playbook\u7684\u6838\u5fc3\u5143\u7d20\u5305\u542b\uff1a \u00b6 hosts\uff1a\u4efb\u52a1\u7684\u76ee\u6807\u4e3b\u673a\uff0c\u591a\u4e2a\u4e3b\u673a\u7528\u5192\u53f7\u5206\u9694\uff0c\u4e00\u822c\u8c03\u7528/etc/ansible/hosts\u4e2d\u7684\u5206\u7ec4\u4fe1\u606f remote_user:\u8fdc\u7a0b\u4e3b\u673a\u4e0a\uff0c\u8fd0\u884c\u6b64\u4efb\u52a1\u7684\u4ec0\u4e48\u9ed8\u8ba4\u4e3aroot tasks\uff1a\u4efb\u52a1\uff0c\u5373\u5b9a\u4e49\u7684\u5177\u4f53\u4efb\u52a1\uff0c\u7531\u6a21\u5757\u5b9a\u4e49\u7684\u64cd\u4f5c\u5217\u8868 handlers\uff1a\u89e6\u53d1\u5668\uff0c\u7c7b\u4f3ctasks\uff0c\u53ea\u662f\u5728\u7279\u5b9a\u7684\u6761\u4ef6\u4e0b\u624d\u4f1a\u89e6\u53d1\u4efb\u52a1\u3002\u67d0\u4efb\u52a1\u7684\u72b6\u6001\u5728\u8fd0\u884c\u540e\u4e3achanged\u65f6\uff0c\u53ef\u901a\u8fc7\u201cnotify\u201d\u901a\u77e5\u7ed9\u76f8\u5e94\u7684handlers\u8fdb\u884c\u89e6\u53d1\u6267\u884c\u3002 roles\uff1a\u89d2\u8272\uff0c\u5c06hosts\u5265\u79bb\u51fa\u53bb\uff0c\u7531tasks\uff0chandlers\u7b49\u6240\u7ec4\u6210\u7684\u4e00\u79cd\u7279\u5b9a\u7684\u7ed3\u6784\u96c6\u5408\u3002 1. --syntax-check:\u68c0\u6d4byaml\u6587\u4ef6\u7684\u8bed\u6cd5 2. -C\uff08--check\uff09\uff1a\u6d4b\u8bd5\uff0c\u4e0d\u4f1a\u6539\u53d8\u4e3b\u673a\u7684\u4efb\u4f55\u914d\u7f6e 3. --list-hosts:\u5217\u51fayaml\u6587\u4ef6\u5f71\u54cd\u7684\u4e3b\u673a\u5217\u8868 4. --list-tasks\uff1a\u5217\u51fayaml\u6587\u4ef6\u7684\u4efb\u52a1\u5217\u8868 5. --list-tags:\u5217\u51fayaml\u6587\u4ef6\u4e2d\u7684\u6807\u7b7e 6. -t TAGS (--tags=TAGS):\u8868\u793a\u53ea\u6267\u884c\u6307\u5b9a\u6807\u7b7e\u7684\u4efb\u52a1 7. --skip-tags=SKIP_TAGSS:\u8868\u793a\u9664\u4e86\u6307\u5b9a\u6807\u7b7e\u4efb\u52a1\uff0c\u6267\u884c\u5176\u4ed6\u4efb\u52a1 8. --start-at-task=START_AT:\u4ece\u6307\u5b9a\u4efb\u52a1\u5f00\u59cb\u5f80\u4e0b\u8fd0\u884c \u5b9e\u9a8c\u6848\u4f8b: [root@ansible ~]# ansible-playbook --syntax-check /etc/ansible/test.yaml playbook: /etc/ansible/test.yml //\u6ca1\u6709\u62a5\u9519\u63d0\u793a \u9884\u6d4b\u8bd5: [root@ansible ~]# ansible-playbook -C /etc/ansible/test.yaml \u5217\u51fa\u4efb\u52a1: $ ansible-playbook --list-tasks /etc/ansible/test.yml // \u53ea\u6267\u884ccpu-3.mac \u4e3b\u673a\u4e0atag\u4e3atestccc $ ansible-playbook -i inventory/mac test_tag.yml --tag testccc --limit cpu-3.mac \u5217\u51fa\u6807\u7b7e: [root@ansible ~]# ansible-playbook --list-tags /etc/ansible/test.yml \u6267\u884c\u4efb\u52a1: [root@ansible ~]# ansible-playbook /etc/ansible/test.yml \u5217\u51fa\u4e3b\u673a: $ ansible mac --list hosts (3): cpu-1.mac cpu-3.mac cpu-4.mac $ ansible mac --list-hosts hosts (3): cpu-1.mac cpu-3.mac cpu-4.mac Ansible playbook: \u00b6 1. \u6267\u884c\u914d\u7f6e\u6587\u4ef6 \u00b6 Playbook\u914d\u7f6e\u6587\u4ef6\u4f7f\u7528YAML\u8bed\u6cd5\uff0c\u5177\u6709\u7b80\u4ecb\u660e\u4e86\uff0c\u7ed3\u6784\u6e05\u6670\u7b49\u7279\u70b9\u3002Playbook\u914d\u7f6e\u6587\u4ef6\u7c7b\u4f3c\u4e8eshell\u811a\u672c\uff0c\u662f\u4e00\u4e2aYAML\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u7528\u4e8e\u4fdd\u5b58\u9488\u5bf9\u7279\u5b9a\u9700\u6c42\u7684\u4efb\u52a1\u5217\u8868\uff0c\u524d\u9762\u4ecb\u7ecd\u7684ansible\u547d\u4ee4\u867d\u7136\u53ef\u4ee5\u5b8c\u6210\u5404\u79cd\u4efb\u52a1\uff0c\u4f46\u662f\u5f53\u914d\u7f6e\u4e00\u7cfb\u5217\u4efb\u52a1\u65f6\uff0c\u9010\u6761\u8f93\u5165\u547d\u4ee4\u5c31\u663e\u5f97\u6548\u7387\u975e\u5e38\u4f4e\u4e0b\uff0c\u66f4\u6709\u6548\u7684\u65b9\u5f0f\u5728playbook\u914d\u7f6e\u4e2d\u914d\u7f6e\u6240\u6709\u7684\u4efb\u52a1\u4ee3\u7801\uff0c\u5229\u7528ansible-playbook\u547d\u4ee4\u6267\u884c\u8be5\u6587\u4ef6\uff0c\u53ef\u4ee5\u5b9e\u73b0\u81ea\u52a8\u5316\u8fd0\u7ef4\uff0cYAML\u6587\u4ef6\u7684\u6269\u5c55\u540d\u901a\u5e38\u4e3a.yaml\u6216.yml\u3002 YAML\u8bed\u6cd5\u548c\u5176\u4ed6\u9ad8\u7ea7\u8bed\u8a00\u7c7b\u4f3c\uff0c\u5176\u7ed3\u6784\u901a\u8fc7\u7f29\u8fdb\u6765\u5c55\u793a\uff0c\u901a\u8fc7\u201c-\u201d\u6765\u4ee3\u8868\u9009\u9879\uff0c\u901a\u8fc7\u5192\u53f7\u201c\uff1a\u201d\u6765\u5206\u9694\u952e\u548c\u503c\u3002\u6574\u4e2a\u6587\u4ef6\u4ee5\u201c---\u201d\u5f00\u59cb\u5e76\u4ee5\u201c\u2026\u201d\u7ed3\u675f\uff0c\u5982\u4e0b\u6240\u793a 2. \u89e6\u53d1\u5668 \u00b6 \u9700\u8981\u89e6\u53d1\u624d\u80fd\u6267\u884c\u7684\u4efb\u52a1\uff0c\u5f53\u4e4b\u524d\u5b9a\u4e49\u5728tasks\u4e2d\u7684\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\uff0c\u82e5\u5e0c\u671b\u5728\u57fa\u7840\u4e0a\u89e6\u53d1\u5176\u4ed6\u7684\u4efb\u52a1\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5b9a\u4e49handlers\u3002\u4f8b\u5982\uff0c\u5f53\u901a\u8fc7ansible\u7684\u6a21\u5757\u5bf9\u76ee\u6807\u4e3b\u673a\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\u4e4b\u540e\uff0c\u5982\u679c\u4efb\u52a1\u6267\u884c\u6210\u529f\uff0c\u53ef\u4ee5\u89e6\u53d1\u4e00\u4e2a\u89e6\u53d1\u5668\uff0c\u5728\u89e6\u53d1\u5668\u4e2d\u5b9a\u4e49\u76ee\u6807\u4e3b\u673a\u7684\u670d\u52a1\u91cd\u542f\u64cd\u4f5c\uff0c\u4ee5\u4f7f\u914d\u7f6e\u6587\u4ef6\u751f\u6548\uff0chandlers\u89e6\u53d1\u5668\u5177\u6709\u4ee5\u4e0b\u4f18\u70b9\u3002 1.handlers\u662fAnsible\u63d0\u4f9b\u7684\u6761\u4ef6\u673a\u5236\u4e4b\u4e00\uff0chandlers\u548ctask\u5f88\u7c7b\u4f3c\uff0c\u4f46\u662f\u4ed6\u5728\u88abtask\u901a\u77e5\u7684\u65f6\u5019\u624d\u4f1a\u89e6\u53d1\u6267\u884c 2.handlers\u53ea\u4f1a\u5728\u6240\u6709\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\u6267\u884c\uff0c\u800c\u4e14\u5373\u4f7f\u88ab\u901a\u77e5\u4e86\u591a\u6b21\uff0c\u5b83\u4e5f\u53ea\u4f1a\u6267\u884c\u4e00\u6b21\uff0chandlers\u6309\u7167\u5b9a\u4e49\u7684\u987a\u5e8f\u4f9d\u6b21\u6267\u884c 3. \u89d2\u8272 \u00b6 \u5c06\u591a\u79cd\u4e0d\u540c\u7684tasks\u7684\u6587\u4ef6\u96c6\u4e2d\u5b58\u50a8\u5728\u67d0\u4e2a\u76ee\u5f55\u4e0b\uff0c\u5219\u8be5\u76ee\u5f55\u5c31\u662f\u89d2\u8272\uff0c\u89d2\u8272\u4e00\u822c\u5b58\u653e\u5728/etc/ansible/roles/\u76ee\u5f55\u4e2d\uff0c\u53ef\u901a\u8fc7ansible\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u8c03\u6574\u9ed8\u8ba4\u7684\u89d2\u8272\u76ee\u5f55\u3002/etc/ansible/roles\u76ee\u5f55\u4e0b\u6709\u5f88\u591a\u7684\u5b50\u76ee\u5f55\uff0c\u5176\u4e2d\u6bcf\u4e00\u4e2a\u5b50\u76ee\u5f55\u5bf9\u5e94\u4e00\u4e2a\u89d2\u8272\u3002\u6bcf\u4e2a\u89d2\u8272\u4e5f\u6709\u81ea\u5df1\u7684\u76ee\u5f55\u7ed3\u6784\u3002 \u6bcf\u4e2a\u89d2\u8272\u7684\u5b9a\u4e49\uff0c\u4ee5\u7279\u5b9a\u7684\u5c42\u7ea7\u76ee\u5f55\u7ed3\u6784\u8fdb\u884c\u7ec4\u7ec7\uff0c\u4ee5Mariadb\uff08mysql\u89d2\u8272) \u4e3a\u4f8b 1.files\uff1a\u5b58\u653ecopy\u6216script\u7b49\u6a21\u5757\u8c03\u7528\u7684\u6587\u4ef6 2.templates\uff1a\u5b58\u653etemplate\u6a21\u5757\u67e5\u627e\u6240\u9700\u8981\u7684\u6a21\u677f\u6587\u4ef6\u7684\u76ee\u5f55\uff0c\u5982mysql\u914d\u7f6e\u6587\u4ef6\u7b49\u6a21\u677f 3.tasks\uff1a\u4efb\u52a1\u5b58\u653e\u76ee\u5f55 4.handlers\uff1a\u5b58\u653e\u76f8\u5173\u89e6\u53d1\u6267\u884c\u5668\u7684\u76ee\u5f55 5.vars\uff1a\u53d8\u91cf\u5b58\u653e\u7684\u76ee\u5f55 6.meta\uff1a\u7528\u4e8e\u5b58\u653e\u6b64\u89d2\u8272\u5143\u6570\u636e 7.default\uff1a\u9ed8\u8ba4\u53d8\u91cf\u5b58\u653e\u76ee\u5f55\uff0c\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u6b64\u89d2\u8272\u4f7f\u7528\u7684\u9ed8\u8ba4\u53d8\u91cf 4. \u53d8\u91cf \u00b6 \u5b9e\u4f8b1: \u5229\u7528\u7cfb\u7edf\u53d8\u91cf\u83b7\u53d6\u4e3b\u673a\u7cfb\u7edf tasks: - name: Gather system information setup: - name: Print ansible_distribution debug: var: ansible_distribution 5. Template\u6a21\u677f \u00b6 \u914d\u7f6e\u6587\u4ef6\u5982\u679c\u4f7f\u7528copy\u6a21\u5757\u53bb\u4e0b\u53d1\u7684\u8bdd\uff0c\u90a3\u4e48\u6240\u6709\u4e3b\u673a\u7684\u914d\u7f6e\u90fd\u662f\u4e00\u6837\u7684\uff1b \u5982\u679c\u4e0b\u53d1\u7684\u914d\u7f6e\u6587\u4ef6\u91cc\u6709\u53ef\u53d8\u7684\u914d\u7f6e\uff0c\u9700\u8981\u7528\u5230template\u6a21\u5757\u3002 5.1 \u5229\u7528template\u6a21\u5757\u4e0b\u53d1\u53ef\u53d8\u7684\u914d\u7f6e\u6587\u4ef6 [root@ansible ~]# cat /tmp/test my name is {{ myname }} # \u81ea\u5b9a\u4e49\u53d8\u91cf my name is {{ ansible_all_ipv4_addresses[1] }} # \u7cfb\u7edf\u53d8\u91cf [root@ansible ~]# cat /etc/ansible/filevars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u53d8\u91cf vars: - myname: \"cloud\" #\u81ea\u5b9a\u4e49\u53d8\u91cf tasks: - name: template test template: src=/tmp/test dest=/root/test #\u4f7f\u7528template\u4e0b\u53d1\u53ef\u53d8\u914d\u7f6e\u6587\u4ef6 ... [root@ansible ~]# ansible-playbook /etc/ansible/filevars.yml PLAY [all] ************************************************************************ TASK [Gathering Facts] ************************************************************ ok: [192.168.200.112] ok: [192.168.200.113] TASK [template test] ************************************************************** changed: [192.168.200.113] changed: [192.168.200.112] PLAY RECAP ************************************************************************ 192.168.200.112 : ok=2 changed=1 unreachable=0 failed=0 192.168.200.113 : ok=2 changed=1 unreachable=0 failed=0 [root@client1 ~]# cat /tmp/test ip 192.168.122.1 cpu 1 time 2019-05-15 5.2 \u4e0b\u53d1\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u4f7f\u7528\u5224\u65ad\u8bed\u6cd5 [root@ansible ~]# vim /tmp/if.j2 {% if PORT %} #if PORT\u5b58\u5728 ip=0.0.0.0:{{ PORT }} {% else %} #\u5426\u5219\u7684\u8bdd ip=0.0.0.0:80 {% endif %} #\u7ed3\u5c3e [root@ansible ~]# vim /etc/ansible/test_ifvars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u5185\u7f6e\u53d8\u91cf vars: - PORT: 90 #\u81ea\u5b9a\u4e49\u53d8\u91cf tasks: - name: jinja2 if test template: src=/tmp/if.j2 dest=/root/test ... [root@ansible ~]# ansible-playbook /etc/ansible/test_ifvars.yml PLAY [all] ************************************************************************ TASK [Gathering Facts] ************************************************************ ok: [192.168.200.112] ok: [192.168.200.113] TASK [jinja2 if test] ************************************************************* changed: [192.168.200.112] changed: [192.168.200.113] PLAY RECAP ************************************************************************ 192.168.200.112 : ok=2 changed=1 unreachable=0 failed=0 192.168.200.113 : ok=2 changed=1 unreachable=0 failed=0 [root@client1 ~]# cat /root/test #if PORT\u5b58\u5728 ip=0.0.0.0:90 #\u7ed3\u5c3e \u4ee5\u4e0b\u662f\u4f60\u7ed9\u51fa\u7684\u547d\u4ee4\u548c\u8f93\u51fa\u7684Markdown\u683c\u5f0f\uff1a 1. \u5c06\u53d8\u91cfPORT\u503c\u8bbe\u4e3a\u7a7a\uff0c\u7136\u540e\u8fd0\u884cAnsible playbook\uff1a ```shell [root@ansible ~]# vim /etc/ansible/test_ifvars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u5185\u7f6e\u53d8\u91cf vars: - PORT: #\u53d8\u91cf\u4e3a\u7a7a tasks: - name: jinja2 if test template: src=/tmp/if.j2 dest=/root/test ... [root@ansible ~]# ansible-playbook /etc/ansible/test_ifvars.yml \u8fd0\u884c\u7ed3\u679c\uff1a PLAY [ all ] ************************************************************************ TASK [ Gathering Facts ] ************************************************************ ok: [ 192 .168.200.112 ] ok: [ 192 .168.200.113 ] TASK [ jinja2 if test ] ************************************************************* changed: [ 192 .168.200.112 ] changed: [ 192 .168.200.113 ] PLAY RECAP ************************************************************************ 192 .168.200.112 : ok = 2 changed = 1 unreachable = 0 failed = 0 192 .168.200.113 : ok = 2 changed = 1 unreachable = 0 failed = 0 \u5728\u5ba2\u6237\u7aef\u68c0\u67e5\u751f\u6210\u7684\u6587\u4ef6\uff1a [ root@client1 ~ ] # cat /root/test #\u5426\u5219\u7684\u8bdd ip = 0 .0.0.0:80 #\u7ed3\u5c3e \u4f7f\u7528Ansible playbook\u4e0b\u53d1\u53ef\u6267\u884c\u52a8\u4f5c\u7684\u53ef\u53d8\u7684nginx\u914d\u7f6e\u6587\u4ef6\uff1a [ root@ansible ~ ] # cp nginx.conf /tmp/nginx.j2 [ root@ansible ~ ] # head -3 /tmp/nginx.j2 #user nobody; worker_processes {{ ansible_processor_vcpus }} ; #\u53ef\u53d8\u7684\u53c2\u6570 \u521b\u5efa\u5e76\u8fd0\u884cAnsible playbook\uff1a [ root@ansible ~ ] # cat /etc/ansible/test_nginxvars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u5185\u7f6e\u53d8\u91cf tasks: - name: nginx conf template: src = /tmp/nginx.j2 dest = /usr/local/nginx/conf/nginx.conf notify: - reload nginx #\u4e0b\u53d1\u901a\u77e5\u7ed9handlers\u6a21\u5757\u6267\u884c\u540d\u5b57\u53eb\u505areload nginx\u7684\u52a8\u4f5c handlers: #\u5b9a\u4e49\u52a8\u4f5c - name: reload nginx #\u52a8\u4f5c\u7684\u540d\u5b57 shell: /usr/local/nginx/sbin/nginx -s reload ... [ root@ansible ~ ] # ansible-playbook /etc/ansible/test_nginxvars.yml \u8fd0\u884c\u7ed3\u679c\uff1a PLAY [ all ] ************************************************************************ TASK [ Gathering Facts ] ************************************************************ ok: [ 192 .168.200.113 ] ok: [ 192 .168.200.112 ] TASK [ nginx conf ] ***************************************************************** ok: [ 192 .168.200.112 ] ok: [ 192 .168.200.113 ] PLAY RECAP ************************************************************************ 192 .168.200.112 : ok = 2 changed = 0 unreachable = 0 failed = 0 192 .168.200.113 : ok = 2 changed = 0 unreachable = 0 failed = 0 \u5728\u5ba2\u6237\u7aef\u68c0\u67e5\u751f\u6210\u7684\u914d\u7f6e\u6587\u4ef6\uff1a [ root@client1 ~ ] # head -3 /usr/local/nginx/conf/nginx.conf #user nobody; worker_processes 1 ; 5.1 \u6a21\u7248\u53d8\u91cf\u83b7\u53d6 \u00b6 \u65b9\u5f0f\u4e00\uff1a {% for host in groups['k8s_masters'] %} server {{ host }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:6443 check {% endfor %} \u65b9\u5f0f\u4e8c\uff1a \u5982\u679c\u4f60\u60f3\u5728\u751f\u6210\u7684 HAProxy \u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u4e3b\u673a\u7684 IP \u5730\u5740\u4ee3\u66ff\u4e3b\u673a\u540d\uff0c\u4f60\u53ef\u4ee5\u4fee\u6539\u4f60\u7684\u6a21\u677f\uff0c\u5982\u4e0b\u6240\u793a\uff1a {% for host in groups['k8s_master'] %} server {{ hostvars[host]['ansible_default_ipv4']['address'] }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:6443 check {% endfor %} \u5728\u8fd9\u4e2a\u4fee\u6539\u540e\u7684\u6a21\u677f\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 hostvars[host]['ansible_default_ipv4']['address'] \u6765\u83b7\u53d6\u6bcf\u4e2a\u4e3b\u673a\u7684 IP \u5730\u5740\uff0c\u5e76\u7528\u8fd9\u4e2a IP \u5730\u5740\u4ee3\u66ff\u4e86\u539f\u6765\u7684\u4e3b\u673a\u540d\u3002 \u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e2a\u4fee\u6539\u5047\u8bbe\u4f60\u7684\u4e3b\u673a\u90fd\u6709\u4e00\u4e2a\u5b9a\u4e49\u4e86 'ansible_default_ipv4' \u53d8\u91cf\u7684 IPv4 \u5730\u5740\u3002\u8fd9\u4e2a\u53d8\u91cf\u901a\u5e38\u7531 Ansible \u7684 setup \u6a21\u5757\u81ea\u52a8\u6536\u96c6\uff0c\u4f46\u5982\u679c\u4f60\u7684\u4e3b\u673a\u6ca1\u6709 IPv4 \u5730\u5740\uff0c\u6216\u8005\u6ca1\u6709\u8fd0\u884c setup \u6a21\u5757\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u624b\u52a8\u8bbe\u7f6e\u8fd9\u4e2a\u53d8\u91cf\u3002","title":"Ansible playbook"},{"location":"ansible/ansible-playbook/#playbook","text":"Playbook\u914d\u7f6e\u6587\u4ef6\u4f7f\u7528YAML\u8bed\u6cd5\uff0c\u5177\u6709\u7b80\u4ecb\u660e\u4e86\uff0c\u7ed3\u6784\u6e05\u6670\u7b49\u7279\u70b9\u3002Playbook\u914d\u7f6e\u6587\u4ef6\u7c7b\u4f3c\u4e8eshell\u811a\u672c\uff0c\u662f\u4e00\u4e2aYAML\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u7528\u4e8e\u4fdd\u5b58\u9488\u5bf9\u7279\u5b9a\u9700\u6c42\u7684\u4efb\u52a1\u5217\u8868\uff0c\u524d\u9762\u4ecb\u7ecd\u7684ansible\u547d\u4ee4\u867d\u7136\u53ef\u4ee5\u5b8c\u6210\u5404\u79cd\u4efb\u52a1\uff0c\u4f46\u662f\u5f53\u914d\u7f6e\u4e00\u7cfb\u5217\u4efb\u52a1\u65f6\uff0c\u9010\u6761\u8f93\u5165\u547d\u4ee4\u5c31\u663e\u5f97\u6548\u7387\u975e\u5e38\u4f4e\u4e0b\uff0c\u66f4\u6709\u6548\u7684\u65b9\u5f0f\u5728playbook\u914d\u7f6e\u4e2d\u914d\u7f6e\u6240\u6709\u7684\u4efb\u52a1\u4ee3\u7801\uff0c\u5229\u7528ansible-playbook\u547d\u4ee4\u6267\u884c\u8be5\u6587\u4ef6\uff0c\u53ef\u4ee5\u5b9e\u73b0\u81ea\u52a8\u5316\u8fd0\u7ef4\uff0cYAML\u6587\u4ef6\u7684\u6269\u5c55\u540d\u901a\u5e38\u4e3a.yaml\u6216.yml\u3002 YAML\u8bed\u6cd5\u548c\u5176\u4ed6\u9ad8\u7ea7\u8bed\u8a00\u7c7b\u4f3c\uff0c\u5176\u7ed3\u6784\u901a\u8fc7\u7f29\u8fdb\u6765\u5c55\u793a\uff0c\u901a\u8fc7\u201c-\u201d\u6765\u4ee3\u8868\u9009\u9879\uff0c\u901a\u8fc7\u5192\u53f7\u201c\uff1a\u201d\u6765\u5206\u9694\u952e\u548c\u503c\u3002\u6574\u4e2a\u6587\u4ef6\u4ee5\u201c---\u201d\u5f00\u59cb\u5e76\u4ee5\u201c\u2026\u201d\u7ed3\u675f\uff0c\u5982\u4e0b\u6240\u793a \u4fee\u6539hosts\u6587\u4ef6 [root@ansible ~]# vim /etc/ansible/hosts [test01] 192.168.200.112 [test02] 192.168.200.113 [root@ansible ~]# vim /etc/ansible/test.yml --- - hosts: test01 remote_user: root tasks: - name: adduser user: name=user2 state=present tags: - testaaa - name: addgroup group: name=root system=yes tags: - testbbb - hosts: test02 remote_user: root tasks: - name: copy file copy: src=/etc/passwd dest=/home tags: - testccc \u6ce8\u91ca: [root@ansible ~]# vim /etc/ansible/test.yml //\u521b\u5efatest\uff0cyml\u6587\u4ef6 --- //\u5f00\u5934\u683c\u5f0f\uff08\u53ef\u5ffd\u7565\uff09 - hosts: test01 //\u8868\u793a\u5bf9test01\uff08192.168.200.112\uff09\u7684\u64cd\u4f5c remote_user: root //\u8fdc\u7aef\u6267\u884c\u7528\u6237\u8eab\u4efdroot tasks: //\u4efb\u52a1\u5217\u8868 - name: adduser //\u4efb\u52a1\u540d\u79f0 user: name=user2 state=present //\u6267\u884cuser\u6a21\u5757\u521b\u5efa\u7528\u6237 tags: //\u521b\u5efatag\u6807\u7b7e - testaaa //tag\u6807\u7b7e\u4e3atestaaa - name: addgroup //\u4efb\u52a1\u540d\u79f0 group: name=root system=yes //\u6267\u884cgroup\u6a21\u5757\u521b\u5efa\u7ec4 tags: //\u521b\u5efatag\u6807\u7b7e - testbbb //tag\u6807\u7b7e\u4e3atestbbb - hosts\uff1atest02 //\u8868\u793a\u5bf9test02\uff08192.168.200.113\uff09\u7684\u64cd\u4f5c remote_user: root //\u8fdc\u7aef\u6267\u884c\u7528\u6237\u8eab\u4efdroot tasks: //\u4efb\u52a1\u5217\u8868 - name: copy file to test //\u4efb\u52a1\u540d\u79f0 copy: src=/etc/passwd dest=/home //\u6267\u884ccopy\u6a21\u5757\u590d\u5236\u6587\u4ef6 tags: //\u521b\u5efatag\u6807\u7b7e - testccc //tag\u6807\u7b7e\u4e3atestccc ... //\u7ed3\u5c3e\u683c\u5f0f\uff08\u53ef\u5ffd\u7565\uff09 \u6240\u6709\u7684\u201c-\u201d\u548c\u201c\uff1a\u201d\u540e\u9762\u5747\u6709\u7a7a\u683c\uff0c\u800c\u4e14\u8981\u6ce8\u610f\u7f29\u8fdb\u548c\u5bf9\u9f50","title":"playbook \u914d\u7f6e\u6587\u4ef6"},{"location":"ansible/ansible-playbook/#playbook_1","text":"hosts\uff1a\u4efb\u52a1\u7684\u76ee\u6807\u4e3b\u673a\uff0c\u591a\u4e2a\u4e3b\u673a\u7528\u5192\u53f7\u5206\u9694\uff0c\u4e00\u822c\u8c03\u7528/etc/ansible/hosts\u4e2d\u7684\u5206\u7ec4\u4fe1\u606f remote_user:\u8fdc\u7a0b\u4e3b\u673a\u4e0a\uff0c\u8fd0\u884c\u6b64\u4efb\u52a1\u7684\u4ec0\u4e48\u9ed8\u8ba4\u4e3aroot tasks\uff1a\u4efb\u52a1\uff0c\u5373\u5b9a\u4e49\u7684\u5177\u4f53\u4efb\u52a1\uff0c\u7531\u6a21\u5757\u5b9a\u4e49\u7684\u64cd\u4f5c\u5217\u8868 handlers\uff1a\u89e6\u53d1\u5668\uff0c\u7c7b\u4f3ctasks\uff0c\u53ea\u662f\u5728\u7279\u5b9a\u7684\u6761\u4ef6\u4e0b\u624d\u4f1a\u89e6\u53d1\u4efb\u52a1\u3002\u67d0\u4efb\u52a1\u7684\u72b6\u6001\u5728\u8fd0\u884c\u540e\u4e3achanged\u65f6\uff0c\u53ef\u901a\u8fc7\u201cnotify\u201d\u901a\u77e5\u7ed9\u76f8\u5e94\u7684handlers\u8fdb\u884c\u89e6\u53d1\u6267\u884c\u3002 roles\uff1a\u89d2\u8272\uff0c\u5c06hosts\u5265\u79bb\u51fa\u53bb\uff0c\u7531tasks\uff0chandlers\u7b49\u6240\u7ec4\u6210\u7684\u4e00\u79cd\u7279\u5b9a\u7684\u7ed3\u6784\u96c6\u5408\u3002 1. --syntax-check:\u68c0\u6d4byaml\u6587\u4ef6\u7684\u8bed\u6cd5 2. -C\uff08--check\uff09\uff1a\u6d4b\u8bd5\uff0c\u4e0d\u4f1a\u6539\u53d8\u4e3b\u673a\u7684\u4efb\u4f55\u914d\u7f6e 3. --list-hosts:\u5217\u51fayaml\u6587\u4ef6\u5f71\u54cd\u7684\u4e3b\u673a\u5217\u8868 4. --list-tasks\uff1a\u5217\u51fayaml\u6587\u4ef6\u7684\u4efb\u52a1\u5217\u8868 5. --list-tags:\u5217\u51fayaml\u6587\u4ef6\u4e2d\u7684\u6807\u7b7e 6. -t TAGS (--tags=TAGS):\u8868\u793a\u53ea\u6267\u884c\u6307\u5b9a\u6807\u7b7e\u7684\u4efb\u52a1 7. --skip-tags=SKIP_TAGSS:\u8868\u793a\u9664\u4e86\u6307\u5b9a\u6807\u7b7e\u4efb\u52a1\uff0c\u6267\u884c\u5176\u4ed6\u4efb\u52a1 8. --start-at-task=START_AT:\u4ece\u6307\u5b9a\u4efb\u52a1\u5f00\u59cb\u5f80\u4e0b\u8fd0\u884c \u5b9e\u9a8c\u6848\u4f8b: [root@ansible ~]# ansible-playbook --syntax-check /etc/ansible/test.yaml playbook: /etc/ansible/test.yml //\u6ca1\u6709\u62a5\u9519\u63d0\u793a \u9884\u6d4b\u8bd5: [root@ansible ~]# ansible-playbook -C /etc/ansible/test.yaml \u5217\u51fa\u4efb\u52a1: $ ansible-playbook --list-tasks /etc/ansible/test.yml // \u53ea\u6267\u884ccpu-3.mac \u4e3b\u673a\u4e0atag\u4e3atestccc $ ansible-playbook -i inventory/mac test_tag.yml --tag testccc --limit cpu-3.mac \u5217\u51fa\u6807\u7b7e: [root@ansible ~]# ansible-playbook --list-tags /etc/ansible/test.yml \u6267\u884c\u4efb\u52a1: [root@ansible ~]# ansible-playbook /etc/ansible/test.yml \u5217\u51fa\u4e3b\u673a: $ ansible mac --list hosts (3): cpu-1.mac cpu-3.mac cpu-4.mac $ ansible mac --list-hosts hosts (3): cpu-1.mac cpu-3.mac cpu-4.mac","title":"Playbook\u7684\u6838\u5fc3\u5143\u7d20\u5305\u542b\uff1a"},{"location":"ansible/ansible-playbook/#ansible-playbook","text":"","title":"Ansible playbook:"},{"location":"ansible/ansible-playbook/#1","text":"Playbook\u914d\u7f6e\u6587\u4ef6\u4f7f\u7528YAML\u8bed\u6cd5\uff0c\u5177\u6709\u7b80\u4ecb\u660e\u4e86\uff0c\u7ed3\u6784\u6e05\u6670\u7b49\u7279\u70b9\u3002Playbook\u914d\u7f6e\u6587\u4ef6\u7c7b\u4f3c\u4e8eshell\u811a\u672c\uff0c\u662f\u4e00\u4e2aYAML\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u7528\u4e8e\u4fdd\u5b58\u9488\u5bf9\u7279\u5b9a\u9700\u6c42\u7684\u4efb\u52a1\u5217\u8868\uff0c\u524d\u9762\u4ecb\u7ecd\u7684ansible\u547d\u4ee4\u867d\u7136\u53ef\u4ee5\u5b8c\u6210\u5404\u79cd\u4efb\u52a1\uff0c\u4f46\u662f\u5f53\u914d\u7f6e\u4e00\u7cfb\u5217\u4efb\u52a1\u65f6\uff0c\u9010\u6761\u8f93\u5165\u547d\u4ee4\u5c31\u663e\u5f97\u6548\u7387\u975e\u5e38\u4f4e\u4e0b\uff0c\u66f4\u6709\u6548\u7684\u65b9\u5f0f\u5728playbook\u914d\u7f6e\u4e2d\u914d\u7f6e\u6240\u6709\u7684\u4efb\u52a1\u4ee3\u7801\uff0c\u5229\u7528ansible-playbook\u547d\u4ee4\u6267\u884c\u8be5\u6587\u4ef6\uff0c\u53ef\u4ee5\u5b9e\u73b0\u81ea\u52a8\u5316\u8fd0\u7ef4\uff0cYAML\u6587\u4ef6\u7684\u6269\u5c55\u540d\u901a\u5e38\u4e3a.yaml\u6216.yml\u3002 YAML\u8bed\u6cd5\u548c\u5176\u4ed6\u9ad8\u7ea7\u8bed\u8a00\u7c7b\u4f3c\uff0c\u5176\u7ed3\u6784\u901a\u8fc7\u7f29\u8fdb\u6765\u5c55\u793a\uff0c\u901a\u8fc7\u201c-\u201d\u6765\u4ee3\u8868\u9009\u9879\uff0c\u901a\u8fc7\u5192\u53f7\u201c\uff1a\u201d\u6765\u5206\u9694\u952e\u548c\u503c\u3002\u6574\u4e2a\u6587\u4ef6\u4ee5\u201c---\u201d\u5f00\u59cb\u5e76\u4ee5\u201c\u2026\u201d\u7ed3\u675f\uff0c\u5982\u4e0b\u6240\u793a","title":"1. \u6267\u884c\u914d\u7f6e\u6587\u4ef6"},{"location":"ansible/ansible-playbook/#2","text":"\u9700\u8981\u89e6\u53d1\u624d\u80fd\u6267\u884c\u7684\u4efb\u52a1\uff0c\u5f53\u4e4b\u524d\u5b9a\u4e49\u5728tasks\u4e2d\u7684\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\uff0c\u82e5\u5e0c\u671b\u5728\u57fa\u7840\u4e0a\u89e6\u53d1\u5176\u4ed6\u7684\u4efb\u52a1\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u5b9a\u4e49handlers\u3002\u4f8b\u5982\uff0c\u5f53\u901a\u8fc7ansible\u7684\u6a21\u5757\u5bf9\u76ee\u6807\u4e3b\u673a\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\u4e4b\u540e\uff0c\u5982\u679c\u4efb\u52a1\u6267\u884c\u6210\u529f\uff0c\u53ef\u4ee5\u89e6\u53d1\u4e00\u4e2a\u89e6\u53d1\u5668\uff0c\u5728\u89e6\u53d1\u5668\u4e2d\u5b9a\u4e49\u76ee\u6807\u4e3b\u673a\u7684\u670d\u52a1\u91cd\u542f\u64cd\u4f5c\uff0c\u4ee5\u4f7f\u914d\u7f6e\u6587\u4ef6\u751f\u6548\uff0chandlers\u89e6\u53d1\u5668\u5177\u6709\u4ee5\u4e0b\u4f18\u70b9\u3002 1.handlers\u662fAnsible\u63d0\u4f9b\u7684\u6761\u4ef6\u673a\u5236\u4e4b\u4e00\uff0chandlers\u548ctask\u5f88\u7c7b\u4f3c\uff0c\u4f46\u662f\u4ed6\u5728\u88abtask\u901a\u77e5\u7684\u65f6\u5019\u624d\u4f1a\u89e6\u53d1\u6267\u884c 2.handlers\u53ea\u4f1a\u5728\u6240\u6709\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\u6267\u884c\uff0c\u800c\u4e14\u5373\u4f7f\u88ab\u901a\u77e5\u4e86\u591a\u6b21\uff0c\u5b83\u4e5f\u53ea\u4f1a\u6267\u884c\u4e00\u6b21\uff0chandlers\u6309\u7167\u5b9a\u4e49\u7684\u987a\u5e8f\u4f9d\u6b21\u6267\u884c","title":"2. \u89e6\u53d1\u5668"},{"location":"ansible/ansible-playbook/#3","text":"\u5c06\u591a\u79cd\u4e0d\u540c\u7684tasks\u7684\u6587\u4ef6\u96c6\u4e2d\u5b58\u50a8\u5728\u67d0\u4e2a\u76ee\u5f55\u4e0b\uff0c\u5219\u8be5\u76ee\u5f55\u5c31\u662f\u89d2\u8272\uff0c\u89d2\u8272\u4e00\u822c\u5b58\u653e\u5728/etc/ansible/roles/\u76ee\u5f55\u4e2d\uff0c\u53ef\u901a\u8fc7ansible\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u8c03\u6574\u9ed8\u8ba4\u7684\u89d2\u8272\u76ee\u5f55\u3002/etc/ansible/roles\u76ee\u5f55\u4e0b\u6709\u5f88\u591a\u7684\u5b50\u76ee\u5f55\uff0c\u5176\u4e2d\u6bcf\u4e00\u4e2a\u5b50\u76ee\u5f55\u5bf9\u5e94\u4e00\u4e2a\u89d2\u8272\u3002\u6bcf\u4e2a\u89d2\u8272\u4e5f\u6709\u81ea\u5df1\u7684\u76ee\u5f55\u7ed3\u6784\u3002 \u6bcf\u4e2a\u89d2\u8272\u7684\u5b9a\u4e49\uff0c\u4ee5\u7279\u5b9a\u7684\u5c42\u7ea7\u76ee\u5f55\u7ed3\u6784\u8fdb\u884c\u7ec4\u7ec7\uff0c\u4ee5Mariadb\uff08mysql\u89d2\u8272) \u4e3a\u4f8b 1.files\uff1a\u5b58\u653ecopy\u6216script\u7b49\u6a21\u5757\u8c03\u7528\u7684\u6587\u4ef6 2.templates\uff1a\u5b58\u653etemplate\u6a21\u5757\u67e5\u627e\u6240\u9700\u8981\u7684\u6a21\u677f\u6587\u4ef6\u7684\u76ee\u5f55\uff0c\u5982mysql\u914d\u7f6e\u6587\u4ef6\u7b49\u6a21\u677f 3.tasks\uff1a\u4efb\u52a1\u5b58\u653e\u76ee\u5f55 4.handlers\uff1a\u5b58\u653e\u76f8\u5173\u89e6\u53d1\u6267\u884c\u5668\u7684\u76ee\u5f55 5.vars\uff1a\u53d8\u91cf\u5b58\u653e\u7684\u76ee\u5f55 6.meta\uff1a\u7528\u4e8e\u5b58\u653e\u6b64\u89d2\u8272\u5143\u6570\u636e 7.default\uff1a\u9ed8\u8ba4\u53d8\u91cf\u5b58\u653e\u76ee\u5f55\uff0c\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u6b64\u89d2\u8272\u4f7f\u7528\u7684\u9ed8\u8ba4\u53d8\u91cf","title":"3. \u89d2\u8272"},{"location":"ansible/ansible-playbook/#4","text":"\u5b9e\u4f8b1: \u5229\u7528\u7cfb\u7edf\u53d8\u91cf\u83b7\u53d6\u4e3b\u673a\u7cfb\u7edf tasks: - name: Gather system information setup: - name: Print ansible_distribution debug: var: ansible_distribution","title":"4. \u53d8\u91cf"},{"location":"ansible/ansible-playbook/#5-template","text":"\u914d\u7f6e\u6587\u4ef6\u5982\u679c\u4f7f\u7528copy\u6a21\u5757\u53bb\u4e0b\u53d1\u7684\u8bdd\uff0c\u90a3\u4e48\u6240\u6709\u4e3b\u673a\u7684\u914d\u7f6e\u90fd\u662f\u4e00\u6837\u7684\uff1b \u5982\u679c\u4e0b\u53d1\u7684\u914d\u7f6e\u6587\u4ef6\u91cc\u6709\u53ef\u53d8\u7684\u914d\u7f6e\uff0c\u9700\u8981\u7528\u5230template\u6a21\u5757\u3002 5.1 \u5229\u7528template\u6a21\u5757\u4e0b\u53d1\u53ef\u53d8\u7684\u914d\u7f6e\u6587\u4ef6 [root@ansible ~]# cat /tmp/test my name is {{ myname }} # \u81ea\u5b9a\u4e49\u53d8\u91cf my name is {{ ansible_all_ipv4_addresses[1] }} # \u7cfb\u7edf\u53d8\u91cf [root@ansible ~]# cat /etc/ansible/filevars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u53d8\u91cf vars: - myname: \"cloud\" #\u81ea\u5b9a\u4e49\u53d8\u91cf tasks: - name: template test template: src=/tmp/test dest=/root/test #\u4f7f\u7528template\u4e0b\u53d1\u53ef\u53d8\u914d\u7f6e\u6587\u4ef6 ... [root@ansible ~]# ansible-playbook /etc/ansible/filevars.yml PLAY [all] ************************************************************************ TASK [Gathering Facts] ************************************************************ ok: [192.168.200.112] ok: [192.168.200.113] TASK [template test] ************************************************************** changed: [192.168.200.113] changed: [192.168.200.112] PLAY RECAP ************************************************************************ 192.168.200.112 : ok=2 changed=1 unreachable=0 failed=0 192.168.200.113 : ok=2 changed=1 unreachable=0 failed=0 [root@client1 ~]# cat /tmp/test ip 192.168.122.1 cpu 1 time 2019-05-15 5.2 \u4e0b\u53d1\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u4f7f\u7528\u5224\u65ad\u8bed\u6cd5 [root@ansible ~]# vim /tmp/if.j2 {% if PORT %} #if PORT\u5b58\u5728 ip=0.0.0.0:{{ PORT }} {% else %} #\u5426\u5219\u7684\u8bdd ip=0.0.0.0:80 {% endif %} #\u7ed3\u5c3e [root@ansible ~]# vim /etc/ansible/test_ifvars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u5185\u7f6e\u53d8\u91cf vars: - PORT: 90 #\u81ea\u5b9a\u4e49\u53d8\u91cf tasks: - name: jinja2 if test template: src=/tmp/if.j2 dest=/root/test ... [root@ansible ~]# ansible-playbook /etc/ansible/test_ifvars.yml PLAY [all] ************************************************************************ TASK [Gathering Facts] ************************************************************ ok: [192.168.200.112] ok: [192.168.200.113] TASK [jinja2 if test] ************************************************************* changed: [192.168.200.112] changed: [192.168.200.113] PLAY RECAP ************************************************************************ 192.168.200.112 : ok=2 changed=1 unreachable=0 failed=0 192.168.200.113 : ok=2 changed=1 unreachable=0 failed=0 [root@client1 ~]# cat /root/test #if PORT\u5b58\u5728 ip=0.0.0.0:90 #\u7ed3\u5c3e \u4ee5\u4e0b\u662f\u4f60\u7ed9\u51fa\u7684\u547d\u4ee4\u548c\u8f93\u51fa\u7684Markdown\u683c\u5f0f\uff1a 1. \u5c06\u53d8\u91cfPORT\u503c\u8bbe\u4e3a\u7a7a\uff0c\u7136\u540e\u8fd0\u884cAnsible playbook\uff1a ```shell [root@ansible ~]# vim /etc/ansible/test_ifvars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u5185\u7f6e\u53d8\u91cf vars: - PORT: #\u53d8\u91cf\u4e3a\u7a7a tasks: - name: jinja2 if test template: src=/tmp/if.j2 dest=/root/test ... [root@ansible ~]# ansible-playbook /etc/ansible/test_ifvars.yml \u8fd0\u884c\u7ed3\u679c\uff1a PLAY [ all ] ************************************************************************ TASK [ Gathering Facts ] ************************************************************ ok: [ 192 .168.200.112 ] ok: [ 192 .168.200.113 ] TASK [ jinja2 if test ] ************************************************************* changed: [ 192 .168.200.112 ] changed: [ 192 .168.200.113 ] PLAY RECAP ************************************************************************ 192 .168.200.112 : ok = 2 changed = 1 unreachable = 0 failed = 0 192 .168.200.113 : ok = 2 changed = 1 unreachable = 0 failed = 0 \u5728\u5ba2\u6237\u7aef\u68c0\u67e5\u751f\u6210\u7684\u6587\u4ef6\uff1a [ root@client1 ~ ] # cat /root/test #\u5426\u5219\u7684\u8bdd ip = 0 .0.0.0:80 #\u7ed3\u5c3e \u4f7f\u7528Ansible playbook\u4e0b\u53d1\u53ef\u6267\u884c\u52a8\u4f5c\u7684\u53ef\u53d8\u7684nginx\u914d\u7f6e\u6587\u4ef6\uff1a [ root@ansible ~ ] # cp nginx.conf /tmp/nginx.j2 [ root@ansible ~ ] # head -3 /tmp/nginx.j2 #user nobody; worker_processes {{ ansible_processor_vcpus }} ; #\u53ef\u53d8\u7684\u53c2\u6570 \u521b\u5efa\u5e76\u8fd0\u884cAnsible playbook\uff1a [ root@ansible ~ ] # cat /etc/ansible/test_nginxvars.yml --- - hosts: all gather_facts: True #\u5f00\u542f\u7cfb\u7edf\u5185\u7f6e\u53d8\u91cf tasks: - name: nginx conf template: src = /tmp/nginx.j2 dest = /usr/local/nginx/conf/nginx.conf notify: - reload nginx #\u4e0b\u53d1\u901a\u77e5\u7ed9handlers\u6a21\u5757\u6267\u884c\u540d\u5b57\u53eb\u505areload nginx\u7684\u52a8\u4f5c handlers: #\u5b9a\u4e49\u52a8\u4f5c - name: reload nginx #\u52a8\u4f5c\u7684\u540d\u5b57 shell: /usr/local/nginx/sbin/nginx -s reload ... [ root@ansible ~ ] # ansible-playbook /etc/ansible/test_nginxvars.yml \u8fd0\u884c\u7ed3\u679c\uff1a PLAY [ all ] ************************************************************************ TASK [ Gathering Facts ] ************************************************************ ok: [ 192 .168.200.113 ] ok: [ 192 .168.200.112 ] TASK [ nginx conf ] ***************************************************************** ok: [ 192 .168.200.112 ] ok: [ 192 .168.200.113 ] PLAY RECAP ************************************************************************ 192 .168.200.112 : ok = 2 changed = 0 unreachable = 0 failed = 0 192 .168.200.113 : ok = 2 changed = 0 unreachable = 0 failed = 0 \u5728\u5ba2\u6237\u7aef\u68c0\u67e5\u751f\u6210\u7684\u914d\u7f6e\u6587\u4ef6\uff1a [ root@client1 ~ ] # head -3 /usr/local/nginx/conf/nginx.conf #user nobody; worker_processes 1 ;","title":"5. Template\u6a21\u677f"},{"location":"ansible/ansible-playbook/#51","text":"\u65b9\u5f0f\u4e00\uff1a {% for host in groups['k8s_masters'] %} server {{ host }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:6443 check {% endfor %} \u65b9\u5f0f\u4e8c\uff1a \u5982\u679c\u4f60\u60f3\u5728\u751f\u6210\u7684 HAProxy \u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u4e3b\u673a\u7684 IP \u5730\u5740\u4ee3\u66ff\u4e3b\u673a\u540d\uff0c\u4f60\u53ef\u4ee5\u4fee\u6539\u4f60\u7684\u6a21\u677f\uff0c\u5982\u4e0b\u6240\u793a\uff1a {% for host in groups['k8s_master'] %} server {{ hostvars[host]['ansible_default_ipv4']['address'] }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}:6443 check {% endfor %} \u5728\u8fd9\u4e2a\u4fee\u6539\u540e\u7684\u6a21\u677f\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u4e86 hostvars[host]['ansible_default_ipv4']['address'] \u6765\u83b7\u53d6\u6bcf\u4e2a\u4e3b\u673a\u7684 IP \u5730\u5740\uff0c\u5e76\u7528\u8fd9\u4e2a IP \u5730\u5740\u4ee3\u66ff\u4e86\u539f\u6765\u7684\u4e3b\u673a\u540d\u3002 \u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e2a\u4fee\u6539\u5047\u8bbe\u4f60\u7684\u4e3b\u673a\u90fd\u6709\u4e00\u4e2a\u5b9a\u4e49\u4e86 'ansible_default_ipv4' \u53d8\u91cf\u7684 IPv4 \u5730\u5740\u3002\u8fd9\u4e2a\u53d8\u91cf\u901a\u5e38\u7531 Ansible \u7684 setup \u6a21\u5757\u81ea\u52a8\u6536\u96c6\uff0c\u4f46\u5982\u679c\u4f60\u7684\u4e3b\u673a\u6ca1\u6709 IPv4 \u5730\u5740\uff0c\u6216\u8005\u6ca1\u6709\u8fd0\u884c setup \u6a21\u5757\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u624b\u52a8\u8bbe\u7f6e\u8fd9\u4e2a\u53d8\u91cf\u3002","title":"5.1 \u6a21\u7248\u53d8\u91cf\u83b7\u53d6"},{"location":"basic/5-kubernetes-UI-docs/","text":"Kuboard \u4ecb\u7ecd \u00b6 Kuboard \u662f\u4e00\u6b3e\u514d\u8d39\u7684 Kubernetes \u7ba1\u7406\u5de5\u5177\uff0c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u7ed3\u5408\u5df2\u6709\u6216\u65b0\u5efa\u7684\u4ee3\u7801\u4ed3\u5e93\u3001\u955c\u50cf\u4ed3\u5e93\u3001CI/CD\u5de5\u5177\u7b49\uff0c\u53ef\u4ee5\u4fbf\u6377\u7684\u642d\u5efa\u4e00\u4e2a\u751f\u4ea7\u53ef\u7528\u7684 Kubernetes \u5bb9\u5668\u4e91\u5e73\u53f0\uff0c\u8f7b\u677e\u7ba1\u7406\u548c\u8fd0\u884c\u4e91\u539f\u751f\u5e94\u7528\u3002\u60a8\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5c06 Kuboard \u5b89\u88c5\u5230\u73b0\u6709\u7684 Kubernetes \u96c6\u7fa4\uff0c\u901a\u8fc7 Kuboard \u63d0\u4f9b\u7684 Kubernetes RBAC \u7ba1\u7406\u754c\u9762\uff0c\u5c06 Kubernetes \u63d0\u4f9b\u7684\u80fd\u529b\u5f00\u653e\u7ed9\u60a8\u7684\u5f00\u53d1/\u6d4b\u8bd5\u56e2\u961f\u3002Kuboard \u63d0\u4f9b\u7684\u529f\u80fd\u6709\uff1a \u517c\u5bb9\u6027 \u00b6 \u5b89\u88c5 \u00b6 kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml \u6e29\u99a8\u63d0\u793a \u5b89\u88c5\u7684\u65f6\u5019\u6211\u9047\u5230\u670d\u52a1\u8dd1\u4e0d\u8d77\u6765\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51 https://kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85-2\u6765\u8c03\u8bd5 \u51fa\u73b0\u5982\u56fe\uff0c\u4e24\u4e2a\u670d\u52a1\u90fdRunning\uff0c\u90a3\u4e48\u5c31\u90e8\u7f72\u6210\u529f\u4e86\uff01 \u8bbf\u95ee Kuboard \u00b6 \u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u94fe\u63a5 http://your-node-ip-address:30080 \u8f93\u5165\u521d\u59cb\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u5e76\u767b\u5f55 \u7528\u6237\u540d\uff1a admin \u5bc6\u7801\uff1a Kuboard123 \u6587\u7ae0\u53c2\u8003: \u00b6 https://kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85","title":"Kubernetes UI"},{"location":"basic/5-kubernetes-UI-docs/#kuboard","text":"Kuboard \u662f\u4e00\u6b3e\u514d\u8d39\u7684 Kubernetes \u7ba1\u7406\u5de5\u5177\uff0c\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u7ed3\u5408\u5df2\u6709\u6216\u65b0\u5efa\u7684\u4ee3\u7801\u4ed3\u5e93\u3001\u955c\u50cf\u4ed3\u5e93\u3001CI/CD\u5de5\u5177\u7b49\uff0c\u53ef\u4ee5\u4fbf\u6377\u7684\u642d\u5efa\u4e00\u4e2a\u751f\u4ea7\u53ef\u7528\u7684 Kubernetes \u5bb9\u5668\u4e91\u5e73\u53f0\uff0c\u8f7b\u677e\u7ba1\u7406\u548c\u8fd0\u884c\u4e91\u539f\u751f\u5e94\u7528\u3002\u60a8\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5c06 Kuboard \u5b89\u88c5\u5230\u73b0\u6709\u7684 Kubernetes \u96c6\u7fa4\uff0c\u901a\u8fc7 Kuboard \u63d0\u4f9b\u7684 Kubernetes RBAC \u7ba1\u7406\u754c\u9762\uff0c\u5c06 Kubernetes \u63d0\u4f9b\u7684\u80fd\u529b\u5f00\u653e\u7ed9\u60a8\u7684\u5f00\u53d1/\u6d4b\u8bd5\u56e2\u961f\u3002Kuboard \u63d0\u4f9b\u7684\u529f\u80fd\u6709\uff1a","title":"Kuboard \u4ecb\u7ecd"},{"location":"basic/5-kubernetes-UI-docs/#_1","text":"","title":"\u517c\u5bb9\u6027"},{"location":"basic/5-kubernetes-UI-docs/#_2","text":"kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml \u6e29\u99a8\u63d0\u793a \u5b89\u88c5\u7684\u65f6\u5019\u6211\u9047\u5230\u670d\u52a1\u8dd1\u4e0d\u8d77\u6765\u53ef\u4ee5\u53c2\u8003\u5b98\u7f51 https://kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85-2\u6765\u8c03\u8bd5 \u51fa\u73b0\u5982\u56fe\uff0c\u4e24\u4e2a\u670d\u52a1\u90fdRunning\uff0c\u90a3\u4e48\u5c31\u90e8\u7f72\u6210\u529f\u4e86\uff01","title":"\u5b89\u88c5"},{"location":"basic/5-kubernetes-UI-docs/#kuboard_1","text":"\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u94fe\u63a5 http://your-node-ip-address:30080 \u8f93\u5165\u521d\u59cb\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u5e76\u767b\u5f55 \u7528\u6237\u540d\uff1a admin \u5bc6\u7801\uff1a Kuboard123","title":"\u8bbf\u95ee Kuboard"},{"location":"basic/5-kubernetes-UI-docs/#_3","text":"https://kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85","title":"\u6587\u7ae0\u53c2\u8003:"},{"location":"basic/6-kubernetes-etcd-docs/","text":"\u5b98\u7f51: https://etcd.io/ Github\u5730\u5740: https://github.com/etcd-io/etcd ETCD \u7279\u6027: \u00b6 \u5b8c\u5168\u590d\u5236: \u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u90fd\u53ef\u4ee5\u4f7f\u7528\u5b8c\u6574\u7684\u5b58\u6863 \u9ad8\u53ef\u7528\u6027: ETCD\u53ef\u4ee5\u907f\u514d\u786c\u4ef6\u7684\u5355\u70b9\u6545\u969c\u548c\u7f51\u7edc\u95ee\u9898 \u4e00\u81f4\u6027: \u6bcf\u6b21\u5199\u5165\u90fd\u4f1a\u8fd4\u56de\u8de8\u591a\u4e3b\u673a\u7684\u6700\u65b0\u5199\u5165 \u7b80\u5355: \u5305\u62ec\u4e00\u4e2a\u5b9a\u4e49\u826f\u597d,\u9762\u5411\u7528\u6237\u7684API \u5b89\u5168: \u5b9e\u73b0\u4e86\u5e26\u6709\u53ef\u9009\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u8eab\u4efd\u9a8c\u8bc1\u7684\u81ea\u52a8\u5316TLS \u5feb\u901f: \u6bcf\u79d2\u4e00\u4e07\u6b21\u5199\u5165\u7684\u57fa\u51c6\u901f\u5ea6 \u53ef\u9760: \u4f7f\u7528Raft\u7b97\u6cd5\u5b9e\u73b0\u5b58\u50a8\u7684\u5408\u7406\u5206\u5e03\u5728etcd\u7684\u5de5\u4f5c\u539f\u7406 \u786c\u4ef6\u63a8\u8350 \u00b6 ETCD \u4e3b\u8981\u8003\u8651\u5185\u5b58\uff0cCPU\uff0c\u78c1\u76d8 \u5b98\u7f51\u786c\u4ef6(\u63a8\u8350): https://etcd.io/docs/v3.5/op-guide/hardware/ \u6e29\u99a8\u63d0\u793a \u5b98\u65b9\u63d0\u4f9b\u7684\u786c\u4ef6\u6709\u4e9b\u8fc7\u4e8e\u4fdd\u5b88\uff0c\u6b63\u5f0f\u7684\u751f\u4ea7\u73af\u5883\u6700\u597d\u9ad8\u4e8e\u5b98\u65b9\u63a8\u8350\u76841.5-2\u500d\u6bd4\u8f83\u5408\u7406 ETCD \u5ba2\u6237\u7aef\u4f7f\u7528 \u00b6 root@m1-pre:~# etcdctl member list 4469cb53324fe68b, started, etcd-192.168.1.102, https://192.168.1.102:2380, https://192.168.1.102:2379, false 9f5e0acc1f346641, started, etcd-192.168.1.101, https://192.168.1.101:2380, https://192.168.1.101:2379, false e519401c4b995768, started, etcd-192.168.1.103, https://192.168.1.103:2380, https://192.168.1.103:2379, false \u9a8c\u8bc1\u5f53\u524d\u6240\u6709ETCD\u6210\u5458\u72b6\u6001 root@m1-pre:~# export NODE_IPS = \"192.168.1.101 192.168.1.102 192.168.1.103\" root@m1-pre:~# for ip in ${ NODE_IPS } ; do ETCDCTL_API = 3 /usr/bin/etcdctl --endpoints = https:// ${ ip } :2379 --cacert = /etc/kubernetes/ssl/ca.pem --cert = /etc/kubernetes/ssl/etcd.pem --key = /etc/kubernetes/ssl/etcd-key.pem endpoint health ; done https://192.168.1.101:2379 is healthy: successfully committed proposal: took = 17 .871745ms https://192.168.1.102:2379 is healthy: successfully committed proposal: took = 12 .499902ms https://192.168.1.103:2379 is healthy: successfully committed proposal: took = 10 .525834ms \u663e\u793a\u8be6\u7ec6\u4fe1\u606f root@m1-pre:~# for ip in ${ NODE_IPS } ; do ETCDCTL_API = 3 /usr/bin/etcdctl --write-out = table endpoint status --endpoints = https:// ${ ip } :2379 --cacert = /etc/kubernetes/ssl/ca.pem --cert = /etc/kubernetes/ssl/etcd.pem --key = /etc/kubernetes/ssl/etcd-key.pem ; done +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://192.168.1.101:2379 | 9f5e0acc1f346641 | 3 .4.13 | 2 .5 MB | true | false | 128 | 259947 | 259947 | | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://192.168.1.102:2379 | 4469cb53324fe68b | 3 .4.13 | 2 .5 MB | false | false | 128 | 259947 | 259947 | | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://192.168.1.103:2379 | e519401c4b995768 | 3 .4.13 | 2 .5 MB | false | false | 128 | 259947 | 259947 | | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ \u67e5\u770bETCD\u6570\u636e $ etcdctl get / --prefix --keys-only $ etcdctl get /registry/pods/default/test $ etcdctl get / --prefix --keys-only | grep namespace $ etcdctl get / --prefix --keys-only | grep calico $ etcdctl get / --prefix --keys-only | grep deployment $ ETCDCTL_API = 3 etcdctl put /name \"linux60\" //\u589e $ ETCDCTL_API = 3 etcdctl get /name //\u67e5 $ ETCDCTL_API = 3 etcdctl del /name //\u5220 $ ETCDCTL_API = 3 etcdctl watch /data //\u65e0key\u4e5f\u53ef\u4ee5\u8fdb\u884cwatch watch \u5982\u540c\u6240\u793a: ETCD\u5907\u4efd\u6062\u590d \u00b6 WAL\u987e\u540d\u601d\u4e49\uff0c\u5728\u771f\u6b63\u6267\u884c\u5199\u64cd\u4f5c\u4e4b\u524d\u5148\u5199\u4e00\u4e2a\u65e5\u5fd7\uff0c\u9884\u5199\u65e5\u5fd7 WAL \u5b58\u653e\u4e86\u9884\u5199\u65e5\u5fd7\uff0c\u6700\u5927\u7684\u4f5c\u7528\u662f\u8bb0\u5f55\u4e86\u6574\u4e2a\u6570\u636e\u53d8\u5316\u7684\u7684\u5168\u90e8\u5386\u7a0b\u3002\u5728etcd\u4e2d\uff0c\u6240\u6709\u6570\u636e\u7684\u4fee\u6539\u5728\u63d0\u4ea4\u524d\u90fd\u8981\u5148\u5199\u5165WAL\u4e2d V3 \u7248\u672c\u5907\u4efd\u6570\u636e ETCDCTL_API = 3 etcdctl snapshot save <filename> \u81ea\u52a8\u5907\u4efd\u6570\u636e $ mkdir /data/etcd-backup $ cat etcd-backup.sh #!/bin/bash source /etc/profile DATE = ` date +%Y%m%d-%H%M ` ETCDCTL_API = 3 /usr/bin/etcdctl snapshot save /data/etcd-backup/etcd-snapshot- ${ DATE } .db ETCDFILE = ` find /data/etcd-backup -mtime +30 -name etcd-* | wc -l ` if [ ${ ETCDFILE } -gt 30 ] ; then find /data/etcd-backup -mtime +30 -name etcd-* -exec rm -f {} \\; fi V3 \u7248\u672c\u6062\u590d\u6570\u636e ETCDCTL_API = 3 etcdctl snapshot restore /data/etcd/etcd.db --data-dir = /opt/data // \u6062\u590d\u7684\u76ee\u5f55\u5fc5\u987b\u4e0d\u5b58\u5728\uff0c\u5426\u5219\u4f1a\u62a5\u9519","title":"kubernetes etcd \u7b80\u4ecb\u4e0e\u5b9e\u8df5"},{"location":"basic/6-kubernetes-etcd-docs/#etcd","text":"\u5b8c\u5168\u590d\u5236: \u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u90fd\u53ef\u4ee5\u4f7f\u7528\u5b8c\u6574\u7684\u5b58\u6863 \u9ad8\u53ef\u7528\u6027: ETCD\u53ef\u4ee5\u907f\u514d\u786c\u4ef6\u7684\u5355\u70b9\u6545\u969c\u548c\u7f51\u7edc\u95ee\u9898 \u4e00\u81f4\u6027: \u6bcf\u6b21\u5199\u5165\u90fd\u4f1a\u8fd4\u56de\u8de8\u591a\u4e3b\u673a\u7684\u6700\u65b0\u5199\u5165 \u7b80\u5355: \u5305\u62ec\u4e00\u4e2a\u5b9a\u4e49\u826f\u597d,\u9762\u5411\u7528\u6237\u7684API \u5b89\u5168: \u5b9e\u73b0\u4e86\u5e26\u6709\u53ef\u9009\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\u8eab\u4efd\u9a8c\u8bc1\u7684\u81ea\u52a8\u5316TLS \u5feb\u901f: \u6bcf\u79d2\u4e00\u4e07\u6b21\u5199\u5165\u7684\u57fa\u51c6\u901f\u5ea6 \u53ef\u9760: \u4f7f\u7528Raft\u7b97\u6cd5\u5b9e\u73b0\u5b58\u50a8\u7684\u5408\u7406\u5206\u5e03\u5728etcd\u7684\u5de5\u4f5c\u539f\u7406","title":"ETCD \u7279\u6027:"},{"location":"basic/6-kubernetes-etcd-docs/#_1","text":"ETCD \u4e3b\u8981\u8003\u8651\u5185\u5b58\uff0cCPU\uff0c\u78c1\u76d8 \u5b98\u7f51\u786c\u4ef6(\u63a8\u8350): https://etcd.io/docs/v3.5/op-guide/hardware/ \u6e29\u99a8\u63d0\u793a \u5b98\u65b9\u63d0\u4f9b\u7684\u786c\u4ef6\u6709\u4e9b\u8fc7\u4e8e\u4fdd\u5b88\uff0c\u6b63\u5f0f\u7684\u751f\u4ea7\u73af\u5883\u6700\u597d\u9ad8\u4e8e\u5b98\u65b9\u63a8\u8350\u76841.5-2\u500d\u6bd4\u8f83\u5408\u7406","title":"\u786c\u4ef6\u63a8\u8350"},{"location":"basic/6-kubernetes-etcd-docs/#etcd_1","text":"root@m1-pre:~# etcdctl member list 4469cb53324fe68b, started, etcd-192.168.1.102, https://192.168.1.102:2380, https://192.168.1.102:2379, false 9f5e0acc1f346641, started, etcd-192.168.1.101, https://192.168.1.101:2380, https://192.168.1.101:2379, false e519401c4b995768, started, etcd-192.168.1.103, https://192.168.1.103:2380, https://192.168.1.103:2379, false \u9a8c\u8bc1\u5f53\u524d\u6240\u6709ETCD\u6210\u5458\u72b6\u6001 root@m1-pre:~# export NODE_IPS = \"192.168.1.101 192.168.1.102 192.168.1.103\" root@m1-pre:~# for ip in ${ NODE_IPS } ; do ETCDCTL_API = 3 /usr/bin/etcdctl --endpoints = https:// ${ ip } :2379 --cacert = /etc/kubernetes/ssl/ca.pem --cert = /etc/kubernetes/ssl/etcd.pem --key = /etc/kubernetes/ssl/etcd-key.pem endpoint health ; done https://192.168.1.101:2379 is healthy: successfully committed proposal: took = 17 .871745ms https://192.168.1.102:2379 is healthy: successfully committed proposal: took = 12 .499902ms https://192.168.1.103:2379 is healthy: successfully committed proposal: took = 10 .525834ms \u663e\u793a\u8be6\u7ec6\u4fe1\u606f root@m1-pre:~# for ip in ${ NODE_IPS } ; do ETCDCTL_API = 3 /usr/bin/etcdctl --write-out = table endpoint status --endpoints = https:// ${ ip } :2379 --cacert = /etc/kubernetes/ssl/ca.pem --cert = /etc/kubernetes/ssl/etcd.pem --key = /etc/kubernetes/ssl/etcd-key.pem ; done +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://192.168.1.101:2379 | 9f5e0acc1f346641 | 3 .4.13 | 2 .5 MB | true | false | 128 | 259947 | 259947 | | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://192.168.1.102:2379 | 4469cb53324fe68b | 3 .4.13 | 2 .5 MB | false | false | 128 | 259947 | 259947 | | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | https://192.168.1.103:2379 | e519401c4b995768 | 3 .4.13 | 2 .5 MB | false | false | 128 | 259947 | 259947 | | +----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ \u67e5\u770bETCD\u6570\u636e $ etcdctl get / --prefix --keys-only $ etcdctl get /registry/pods/default/test $ etcdctl get / --prefix --keys-only | grep namespace $ etcdctl get / --prefix --keys-only | grep calico $ etcdctl get / --prefix --keys-only | grep deployment $ ETCDCTL_API = 3 etcdctl put /name \"linux60\" //\u589e $ ETCDCTL_API = 3 etcdctl get /name //\u67e5 $ ETCDCTL_API = 3 etcdctl del /name //\u5220 $ ETCDCTL_API = 3 etcdctl watch /data //\u65e0key\u4e5f\u53ef\u4ee5\u8fdb\u884cwatch watch \u5982\u540c\u6240\u793a:","title":"ETCD \u5ba2\u6237\u7aef\u4f7f\u7528"},{"location":"basic/6-kubernetes-etcd-docs/#etcd_2","text":"WAL\u987e\u540d\u601d\u4e49\uff0c\u5728\u771f\u6b63\u6267\u884c\u5199\u64cd\u4f5c\u4e4b\u524d\u5148\u5199\u4e00\u4e2a\u65e5\u5fd7\uff0c\u9884\u5199\u65e5\u5fd7 WAL \u5b58\u653e\u4e86\u9884\u5199\u65e5\u5fd7\uff0c\u6700\u5927\u7684\u4f5c\u7528\u662f\u8bb0\u5f55\u4e86\u6574\u4e2a\u6570\u636e\u53d8\u5316\u7684\u7684\u5168\u90e8\u5386\u7a0b\u3002\u5728etcd\u4e2d\uff0c\u6240\u6709\u6570\u636e\u7684\u4fee\u6539\u5728\u63d0\u4ea4\u524d\u90fd\u8981\u5148\u5199\u5165WAL\u4e2d V3 \u7248\u672c\u5907\u4efd\u6570\u636e ETCDCTL_API = 3 etcdctl snapshot save <filename> \u81ea\u52a8\u5907\u4efd\u6570\u636e $ mkdir /data/etcd-backup $ cat etcd-backup.sh #!/bin/bash source /etc/profile DATE = ` date +%Y%m%d-%H%M ` ETCDCTL_API = 3 /usr/bin/etcdctl snapshot save /data/etcd-backup/etcd-snapshot- ${ DATE } .db ETCDFILE = ` find /data/etcd-backup -mtime +30 -name etcd-* | wc -l ` if [ ${ ETCDFILE } -gt 30 ] ; then find /data/etcd-backup -mtime +30 -name etcd-* -exec rm -f {} \\; fi V3 \u7248\u672c\u6062\u590d\u6570\u636e ETCDCTL_API = 3 etcdctl snapshot restore /data/etcd/etcd.db --data-dir = /opt/data // \u6062\u590d\u7684\u76ee\u5f55\u5fc5\u987b\u4e0d\u5b58\u5728\uff0c\u5426\u5219\u4f1a\u62a5\u9519","title":"ETCD\u5907\u4efd\u6062\u590d"},{"location":"basic/7-kubernetes-coredns-docs/","text":"CoreDNS\u7b80\u4ecb \u5b98\u7f51: https://coredns.io/ Github \u5730\u5740: https://github.com/coredns/coredns Coredns \u662fkubernetes\u4e2d\u7684\u4e00\u4e2a\u57df\u540d\u89e3\u6790\u7684\u7ec4\u4ef6\uff0c\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u89e3\u6790kubernetes\u4e2d\u7684\u57df\u540d\u3002 \u4e0d\u8fc7CoreDNS\u7684yaml\u4e2d\u6709\u4e00\u4e2a\u5c0fBUG\uff0c\u9700\u8981\u52a0\u5165\u4ee5\u4e0b\u5185\u5bb9\u624d\u80fd\u6b63\u5e38work - apiGroups : - discovery.k8s.io resources : - endpointslices verbs : - list - watch \u4e0b\u9762\u8fd9\u4e2ayaml\u5c31\u662fCoredns\u7684\u914d\u7f6e # __MACHINE_GENERATED_WARNING__ apiVersion : v1 kind : ServiceAccount metadata : name : coredns namespace : kube-system labels : kubernetes.io/cluster-service : \"true\" addonmanager.kubernetes.io/mode : Reconcile --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRole metadata : labels : kubernetes.io/bootstrapping : rbac-defaults addonmanager.kubernetes.io/mode : Reconcile name : system:coredns rules : - apiGroups : - \"\" resources : - endpoints - services - pods - namespaces verbs : - list - watch - apiGroups : - \"\" resources : - nodes verbs : - get - apiGroups : - discovery.k8s.io resources : - endpointslices verbs : - list - watch --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : annotations : rbac.authorization.kubernetes.io/autoupdate : \"true\" labels : kubernetes.io/bootstrapping : rbac-defaults addonmanager.kubernetes.io/mode : EnsureExists name : system:coredns roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:coredns subjects : - kind : ServiceAccount name : coredns namespace : kube-system --- apiVersion : v1 kind : ConfigMap metadata : name : coredns namespace : kube-system labels : addonmanager.kubernetes.io/mode : EnsureExists data : Corefile : | .:53 { errors health { lameduck 5s } ready kubernetes magedu.local. in-addr.arpa ip6.arpa { //\u8fd9\u4e2a\u9700\u8981\u6839\u636e\u81ea\u5df1\u914d\u7f6e\u7684\u57df\u540d\u540e\u7f00\u6765\u6539 pods insecure fallthrough in-addr.arpa ip6.arpa ttl 30 } prometheus :9153 forward . 8.8.8.8 { //\u5982\u679c\u89e3\u6790\u4e0d\u4e86\u4f1a\u8f6c\u53d1\u52308.8.8.8 \uff0c\u8fd9\u4e2a\u4e5f\u53ef\u4ee5\u6539\u4e3a/etc/resolv.conf max_concurrent 1000 } cache 30 loop reload loadbalance } --- apiVersion : apps/v1 kind : Deployment metadata : name : coredns namespace : kube-system labels : k8s-app : kube-dns kubernetes.io/cluster-service : \"true\" addonmanager.kubernetes.io/mode : Reconcile kubernetes.io/name : \"CoreDNS\" spec : # replicas: not specified here: # 1. In order to make Addon Manager do not reconcile this replicas parameter. # 2. Default is 1. # 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on. strategy : type : RollingUpdate rollingUpdate : maxUnavailable : 1 selector : matchLabels : k8s-app : kube-dns template : metadata : labels : k8s-app : kube-dns spec : securityContext : seccompProfile : type : RuntimeDefault priorityClassName : system-cluster-critical serviceAccountName : coredns affinity : podAntiAffinity : preferredDuringSchedulingIgnoredDuringExecution : - weight : 100 podAffinityTerm : labelSelector : matchExpressions : - key : k8s-app operator : In values : [ \"kube-dns\" ] topologyKey : kubernetes.io/hostname tolerations : - key : \"CriticalAddonsOnly\" operator : \"Exists\" nodeSelector : kubernetes.io/os : linux containers : - name : coredns #image: k8s.gcr.io/coredns/coredns:v1.8.0 image : coredns/coredns:1.8.6 imagePullPolicy : IfNotPresent resources : limits : memory : 512Mi requests : cpu : 100m memory : 70Mi args : [ \"-conf\" , \"/etc/coredns/Corefile\" ] volumeMounts : - name : config-volume mountPath : /etc/coredns readOnly : true ports : - containerPort : 53 name : dns protocol : UDP - containerPort : 53 name : dns-tcp protocol : TCP - containerPort : 9153 name : metrics protocol : TCP livenessProbe : httpGet : path : /health port : 8080 scheme : HTTP initialDelaySeconds : 60 timeoutSeconds : 5 successThreshold : 1 failureThreshold : 5 readinessProbe : httpGet : path : /ready port : 8181 scheme : HTTP securityContext : allowPrivilegeEscalation : false capabilities : add : - NET_BIND_SERVICE drop : - all readOnlyRootFilesystem : true dnsPolicy : Default volumes : - name : config-volume configMap : name : coredns items : - key : Corefile path : Corefile --- apiVersion : v1 kind : Service metadata : name : kube-dns namespace : kube-system annotations : prometheus.io/port : \"9153\" prometheus.io/scrape : \"true\" labels : k8s-app : kube-dns kubernetes.io/cluster-service : \"true\" addonmanager.kubernetes.io/mode : Reconcile kubernetes.io/name : \"CoreDNS\" spec : selector : k8s-app : kube-dns clusterIP : 10.100.0.2 //\u8fd9\u4e2aIP\u9700\u8981\u6839\u636e\u81ea\u5df1\u7684\u73af\u5883\u6765\u8c03\u8bd5 ports : - name : dns port : 53 protocol : UDP - name : dns-tcp port : 53 protocol : TCP - name : metrics port : 9153 protocol : TCP","title":"kubernetes coredns \u7b80\u4ecb\u4e0e\u5b9e\u8df5"},{"location":"basic/7-kubernetes-update-docs/","text":"Master\u8282\u70b9\u7ef4\u62a4 \u00b6 \u9996\u5148\u9700\u8981\u4ece\u8d1f\u8f7d\u5747\u8861\u8e22\u51fa\u53bb \u5c06master\u8282\u70b9\u8bbe\u7f6e\u4e0d\u53ef\u8c03\u5ea6\u7684\u72b6\u6001\uff0c\u5e76\u9a71\u9010\u6240\u5728\u8282\u70b9\u7684pod\uff0c\u8fd9\u91cc\u53ef\u80fd\u4f1a\u9047\u5230\u6709\u4e9bpod\u65e0\u6cd5\u9a71\u9010\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u5f3a\u5236\u9a71\u9010 \u53bbGitHub\u4e0b\u8f7d\u8981\u5347\u7ea7\u7684\u4e8c\u8fdb\u5236\u5305\uff0c\u5e76\u8fdb\u884c\u66ff\u6362\uff08\u66ff\u6362\u524dmaster\u9700\u8981\u628a\u670d\u52a1\u90fd\u505c\u6389\uff09 \u7ec4\u4ef6\u5347\u7ea7 \u00b6 Master\u8282\u70b9\u670d\u52a1: kube-apiserver,kube-controller-manager,kubelet,kube-proxy,kube-scheduler,kubectl Node\u8282\u70b9\u670d\u52a1: kubectl,kubelet,kube-proxy kubernetes\u4e8c\u8fdb\u5236\u5305\u5982\u4f55\u83b7\u53d6\uff1f https://github.com/kubernetes/kubernetes/releases \u9009\u62e9kubernetes\u7248\u672c\uff0c\u70b9\u51fbCHANGELOG https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.22.md \u9009\u62e9\u8981\u4e0b\u8f7d\u7684\u5305 wget https://dl.k8s.io/v1.22.17/kubernetes.tar.gz wget https://dl.k8s.io/v1.22.17/kubernetes-client-linux-amd64.tar.gz wget https://dl.k8s.io/v1.22.17/kubernetes-server-linux-amd64.tar.gz wget https://dl.k8s.io/v1.22.17/kubernetes-node-linux-amd64.tar.gz","title":"kubernetes \u8282\u70b9\u7ef4\u62a4"},{"location":"basic/7-kubernetes-update-docs/#master","text":"\u9996\u5148\u9700\u8981\u4ece\u8d1f\u8f7d\u5747\u8861\u8e22\u51fa\u53bb \u5c06master\u8282\u70b9\u8bbe\u7f6e\u4e0d\u53ef\u8c03\u5ea6\u7684\u72b6\u6001\uff0c\u5e76\u9a71\u9010\u6240\u5728\u8282\u70b9\u7684pod\uff0c\u8fd9\u91cc\u53ef\u80fd\u4f1a\u9047\u5230\u6709\u4e9bpod\u65e0\u6cd5\u9a71\u9010\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u5f3a\u5236\u9a71\u9010 \u53bbGitHub\u4e0b\u8f7d\u8981\u5347\u7ea7\u7684\u4e8c\u8fdb\u5236\u5305\uff0c\u5e76\u8fdb\u884c\u66ff\u6362\uff08\u66ff\u6362\u524dmaster\u9700\u8981\u628a\u670d\u52a1\u90fd\u505c\u6389\uff09","title":"Master\u8282\u70b9\u7ef4\u62a4"},{"location":"basic/7-kubernetes-update-docs/#_1","text":"Master\u8282\u70b9\u670d\u52a1: kube-apiserver,kube-controller-manager,kubelet,kube-proxy,kube-scheduler,kubectl Node\u8282\u70b9\u670d\u52a1: kubectl,kubelet,kube-proxy kubernetes\u4e8c\u8fdb\u5236\u5305\u5982\u4f55\u83b7\u53d6\uff1f https://github.com/kubernetes/kubernetes/releases \u9009\u62e9kubernetes\u7248\u672c\uff0c\u70b9\u51fbCHANGELOG https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.22.md \u9009\u62e9\u8981\u4e0b\u8f7d\u7684\u5305 wget https://dl.k8s.io/v1.22.17/kubernetes.tar.gz wget https://dl.k8s.io/v1.22.17/kubernetes-client-linux-amd64.tar.gz wget https://dl.k8s.io/v1.22.17/kubernetes-server-linux-amd64.tar.gz wget https://dl.k8s.io/v1.22.17/kubernetes-node-linux-amd64.tar.gz","title":"\u7ec4\u4ef6\u5347\u7ea7"},{"location":"basic/9-install-keepalived-cluster/","text":"kubeadm + keepalived\u5b9e\u73b0\u9ad8\u53ef\u7528 \u00b6 \u73af\u5883\u51c6\u5907: \u00b6 kubernetes \u9ad8\u53ef\u7528\u6700\u5c11\u9700\u8981\u4e09\u53f0\u673a\u5668\uff0c\u5206\u522b\u5728\u4e09\u53f0\u673a\u5668\u4e0a\u90e8\u7f72keepalived\u670d\u52a1\uff0c\u4f18\u5148\u7ea7\u4e3a100\uff0c80\uff0c70\u3002 \u6ce8\u610f\u4e8b\u9879: \u4e91\u73af\u5883\u914d\u7f6ekeepalived\u670d\u52a1\uff0c\u9700\u8981\u5355\u72ec\u5f00\u4e00\u4e2aVIP\u3002\u5e76\u4e14keepalived\u9700\u8981\u5f00\u542f\u5355\u64ad\u6a21\u5f0f \u4f8b\u5982: (ucloud\u4e91\u73af\u5883) \u8fd9\u91cc\u6211\u4eec\u7533\u8bf7\u7684VIP\u5730\u5740\u4e3a\uff1a10.0.0.163 \u6240\u4ee5\u4e09\u53f0master\u8282\u70b9hosts\u52a0\u5165\u4e00\u4e0b\u4fe1\u606f 10.0.0.163 ucloud.k8s.vip k8s-vip \u4e3b\u673a\u4e00: m1.ucloud apt install keepalived -y # \u5b89\u88c5keeplived\u670d\u52a1 [ucloud] root@master0:~# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state MASTER interface eth0 virtual_router_id 1 priority 100 advert_int 2 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.0.0.134 #\u914d\u7f6e\u5355\u64ad\u7684\u6e90\u5730\u5740 unicast_peer { 10.0.0.57 10.0.0.8 #\u914d\u7f6e\u5355\u64ad\u7684\u76ee\u6807\u5730\u5740 } virtual_ipaddress { 10.0.0.163 } } \u4e3b\u673a\u4e8c: m2.ucloud [ucloud] root@node1:~# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state BACKUP interface eth0 virtual_router_id 1 priority 80 advert_int 2 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.0.0.57 unicast_peer { 10.0.0.134 10.0.0.8 #\u914d\u7f6e\u5355\u64ad\u7684\u76ee\u6807\u5730\u5740 } virtual_ipaddress { 10.0.0.163 } } \u4e3b\u673a\u4e8c: m3.ucloud [ucloud] root@node2:~# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state BACKUP interface eth0 virtual_router_id 1 priority 70 advert_int 2 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.0.0.8 unicast_peer { 10.0.0.134 10.0.0.57 } virtual_ipaddress { 10.0.0.163 } } Ansible \u7cfb\u7edf\u521d\u59cb\u5316+\u90e8\u7f72kubernetes \u00b6 ansible \u8dd1\u8fc7kubernetes\u4e4b\u540e\uff0c\u8fdb\u884ckubernetes \u7684Master\u521d\u59cb\u5316 \u4e0b\u9762\u662f\u4e00\u4e2a\u521d\u59cb\u5316kubeadm\u7684Yaml --- apiVersion: kubeadm.k8s.io/v1beta2 kind: InitConfiguration localAPIEndpoint: advertiseAddress: \"10.0.0.134\" bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: \"master0\" taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: \"v1.22.17\" apiServer: timeoutForControlPlane: 4m0s certSANs: - k8s - k8s-api - \"k8s-vip\" // \u6dfb\u52a0\u5185\u5bb9 - \"ucloud.k8s.vip\" // \u6dfb\u52a0\u5185\u5bb9 - \"master0\" - \"master0.ucloud.in.openbayes.com\" - \"master.ucloud.in.openbayes.com\" - \"106.75.85.160\" certificatesDir: /etc/kubernetes/pki clusterName: \"ucloud\" controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.aliyuncs.com/google_containers networking: dnsDomain: \"ucloud.in.openbayes.com\" podSubnet: \"10.96.0.0/20\" serviceSubnet: \"10.97.0.0/20\" controlPlaneEndpoint: \"ucloud.k8s.vip:6443\" // \u6dfb\u52a0\u5185\u5bb9 scheduler: {} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration clusterCIDR: \"10.96.0.0/20\" mode: ipvs # Ansible managed # vim: ft=yaml: # # kubeadm init --config=kubeadm.yaml \u5b98\u65b9\u63d0\u4f9b\u4e86\u4e24\u4e2ashell\u811a\u672c\u6765\u62f7\u8d1d\u8bc1\u4e66 [ucloud] root@master0:~# cat scp-ca.sh USER=ubuntu # \u53ef\u5b9a\u5236 CONTROL_PLANE_IPS=\"10.0.0.57\" for host in ${CONTROL_PLANE_IPS}; do scp /etc/kubernetes/pki/ca.crt \"${USER}\"@$host: scp /etc/kubernetes/pki/ca.key \"${USER}\"@$host: scp /etc/kubernetes/pki/sa.key \"${USER}\"@$host: scp /etc/kubernetes/pki/sa.pub \"${USER}\"@$host: scp /etc/kubernetes/pki/front-proxy-ca.crt \"${USER}\"@$host: scp /etc/kubernetes/pki/front-proxy-ca.key \"${USER}\"@$host: scp /etc/kubernetes/pki/etcd/ca.crt \"${USER}\"@$host:etcd-ca.crt # \u5982\u679c\u4f60\u6b63\u4f7f\u7528\u5916\u90e8 etcd\uff0c\u5ffd\u7565\u4e0b\u4e00\u884c scp /etc/kubernetes/pki/etcd/ca.key \"${USER}\"@$host:etcd-ca.key done [ucloud] root@node2:~# cat cp-ca.sh USER=ubuntu # \u53ef\u5b9a\u5236 mkdir -p /etc/kubernetes/pki/etcd mv /home/${USER}/ca.crt /etc/kubernetes/pki/ mv /home/${USER}/ca.key /etc/kubernetes/pki/ mv /home/${USER}/sa.pub /etc/kubernetes/pki/ mv /home/${USER}/sa.key /etc/kubernetes/pki/ mv /home/${USER}/front-proxy-ca.crt /etc/kubernetes/pki/ mv /home/${USER}/front-proxy-ca.key /etc/kubernetes/pki/ mv /home/${USER}/etcd-ca.crt /etc/kubernetes/pki/etcd/ca.crt # \u5982\u679c\u4f60\u6b63\u4f7f\u7528\u5916\u90e8 etcd\uff0c\u5ffd\u7565\u4e0b\u4e00\u884c mv /home/${USER}/etcd-ca.key /etc/kubernetes/pki/etcd/ca.key \u521d\u59cb\u5316Master\u8282\u70b9 kubeadm init --config=kubeadm.yaml Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of control-plane nodes by copying certificate authorities and service account keys on each node and then running the following as root: kubeadm join cloud.k8s.vip:6443 --token xy3gsl.dq2o7hriq4n5ujvs \\ --discovery-token-ca-cert-hash sha256:cb5fd12da0f6fbe1202d833e0e197b70f8e08c4d8cfca91c513a6ef8f6ae2efa \\ --control-plane Then you can join any number of worker nodes by running the following on each as root: kubeadm join cloud.k8s.vip:6443 --token xy3gsl.dq2o7hriq4n5ujvs \\ --discovery-token-ca-cert-hash sha256:cb5fd12da0f6fbe1202d833e0e197b70f8e08c4d8cfca91c513a6ef8f6ae2efa \u62f7\u8d1d\u5b8c\u6210\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u52a0\u5165master\u8282\u70b9\u4e86\u3002\u8fd9\u6837\u4e09\u4e2a\u8282\u70b9\u7684\u9ad8\u53ef\u7528\u4e5f\u5c31\u5b8c\u6210\u4e86","title":"kubernetes \u9879\u76ee\u4e8c"},{"location":"basic/9-install-keepalived-cluster/#kubeadm-keepalived","text":"","title":"kubeadm + keepalived\u5b9e\u73b0\u9ad8\u53ef\u7528"},{"location":"basic/9-install-keepalived-cluster/#_1","text":"kubernetes \u9ad8\u53ef\u7528\u6700\u5c11\u9700\u8981\u4e09\u53f0\u673a\u5668\uff0c\u5206\u522b\u5728\u4e09\u53f0\u673a\u5668\u4e0a\u90e8\u7f72keepalived\u670d\u52a1\uff0c\u4f18\u5148\u7ea7\u4e3a100\uff0c80\uff0c70\u3002 \u6ce8\u610f\u4e8b\u9879: \u4e91\u73af\u5883\u914d\u7f6ekeepalived\u670d\u52a1\uff0c\u9700\u8981\u5355\u72ec\u5f00\u4e00\u4e2aVIP\u3002\u5e76\u4e14keepalived\u9700\u8981\u5f00\u542f\u5355\u64ad\u6a21\u5f0f \u4f8b\u5982: (ucloud\u4e91\u73af\u5883) \u8fd9\u91cc\u6211\u4eec\u7533\u8bf7\u7684VIP\u5730\u5740\u4e3a\uff1a10.0.0.163 \u6240\u4ee5\u4e09\u53f0master\u8282\u70b9hosts\u52a0\u5165\u4e00\u4e0b\u4fe1\u606f 10.0.0.163 ucloud.k8s.vip k8s-vip \u4e3b\u673a\u4e00: m1.ucloud apt install keepalived -y # \u5b89\u88c5keeplived\u670d\u52a1 [ucloud] root@master0:~# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state MASTER interface eth0 virtual_router_id 1 priority 100 advert_int 2 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.0.0.134 #\u914d\u7f6e\u5355\u64ad\u7684\u6e90\u5730\u5740 unicast_peer { 10.0.0.57 10.0.0.8 #\u914d\u7f6e\u5355\u64ad\u7684\u76ee\u6807\u5730\u5740 } virtual_ipaddress { 10.0.0.163 } } \u4e3b\u673a\u4e8c: m2.ucloud [ucloud] root@node1:~# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state BACKUP interface eth0 virtual_router_id 1 priority 80 advert_int 2 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.0.0.57 unicast_peer { 10.0.0.134 10.0.0.8 #\u914d\u7f6e\u5355\u64ad\u7684\u76ee\u6807\u5730\u5740 } virtual_ipaddress { 10.0.0.163 } } \u4e3b\u673a\u4e8c: m3.ucloud [ucloud] root@node2:~# cat /etc/keepalived/keepalived.conf vrrp_instance VI_1 { state BACKUP interface eth0 virtual_router_id 1 priority 70 advert_int 2 authentication { auth_type PASS auth_pass 1111 } unicast_src_ip 10.0.0.8 unicast_peer { 10.0.0.134 10.0.0.57 } virtual_ipaddress { 10.0.0.163 } }","title":"\u73af\u5883\u51c6\u5907:"},{"location":"basic/9-install-keepalived-cluster/#ansible-kubernetes","text":"ansible \u8dd1\u8fc7kubernetes\u4e4b\u540e\uff0c\u8fdb\u884ckubernetes \u7684Master\u521d\u59cb\u5316 \u4e0b\u9762\u662f\u4e00\u4e2a\u521d\u59cb\u5316kubeadm\u7684Yaml --- apiVersion: kubeadm.k8s.io/v1beta2 kind: InitConfiguration localAPIEndpoint: advertiseAddress: \"10.0.0.134\" bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: \"master0\" taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: \"v1.22.17\" apiServer: timeoutForControlPlane: 4m0s certSANs: - k8s - k8s-api - \"k8s-vip\" // \u6dfb\u52a0\u5185\u5bb9 - \"ucloud.k8s.vip\" // \u6dfb\u52a0\u5185\u5bb9 - \"master0\" - \"master0.ucloud.in.openbayes.com\" - \"master.ucloud.in.openbayes.com\" - \"106.75.85.160\" certificatesDir: /etc/kubernetes/pki clusterName: \"ucloud\" controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: registry.aliyuncs.com/google_containers networking: dnsDomain: \"ucloud.in.openbayes.com\" podSubnet: \"10.96.0.0/20\" serviceSubnet: \"10.97.0.0/20\" controlPlaneEndpoint: \"ucloud.k8s.vip:6443\" // \u6dfb\u52a0\u5185\u5bb9 scheduler: {} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration clusterCIDR: \"10.96.0.0/20\" mode: ipvs # Ansible managed # vim: ft=yaml: # # kubeadm init --config=kubeadm.yaml \u5b98\u65b9\u63d0\u4f9b\u4e86\u4e24\u4e2ashell\u811a\u672c\u6765\u62f7\u8d1d\u8bc1\u4e66 [ucloud] root@master0:~# cat scp-ca.sh USER=ubuntu # \u53ef\u5b9a\u5236 CONTROL_PLANE_IPS=\"10.0.0.57\" for host in ${CONTROL_PLANE_IPS}; do scp /etc/kubernetes/pki/ca.crt \"${USER}\"@$host: scp /etc/kubernetes/pki/ca.key \"${USER}\"@$host: scp /etc/kubernetes/pki/sa.key \"${USER}\"@$host: scp /etc/kubernetes/pki/sa.pub \"${USER}\"@$host: scp /etc/kubernetes/pki/front-proxy-ca.crt \"${USER}\"@$host: scp /etc/kubernetes/pki/front-proxy-ca.key \"${USER}\"@$host: scp /etc/kubernetes/pki/etcd/ca.crt \"${USER}\"@$host:etcd-ca.crt # \u5982\u679c\u4f60\u6b63\u4f7f\u7528\u5916\u90e8 etcd\uff0c\u5ffd\u7565\u4e0b\u4e00\u884c scp /etc/kubernetes/pki/etcd/ca.key \"${USER}\"@$host:etcd-ca.key done [ucloud] root@node2:~# cat cp-ca.sh USER=ubuntu # \u53ef\u5b9a\u5236 mkdir -p /etc/kubernetes/pki/etcd mv /home/${USER}/ca.crt /etc/kubernetes/pki/ mv /home/${USER}/ca.key /etc/kubernetes/pki/ mv /home/${USER}/sa.pub /etc/kubernetes/pki/ mv /home/${USER}/sa.key /etc/kubernetes/pki/ mv /home/${USER}/front-proxy-ca.crt /etc/kubernetes/pki/ mv /home/${USER}/front-proxy-ca.key /etc/kubernetes/pki/ mv /home/${USER}/etcd-ca.crt /etc/kubernetes/pki/etcd/ca.crt # \u5982\u679c\u4f60\u6b63\u4f7f\u7528\u5916\u90e8 etcd\uff0c\u5ffd\u7565\u4e0b\u4e00\u884c mv /home/${USER}/etcd-ca.key /etc/kubernetes/pki/etcd/ca.key \u521d\u59cb\u5316Master\u8282\u70b9 kubeadm init --config=kubeadm.yaml Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of control-plane nodes by copying certificate authorities and service account keys on each node and then running the following as root: kubeadm join cloud.k8s.vip:6443 --token xy3gsl.dq2o7hriq4n5ujvs \\ --discovery-token-ca-cert-hash sha256:cb5fd12da0f6fbe1202d833e0e197b70f8e08c4d8cfca91c513a6ef8f6ae2efa \\ --control-plane Then you can join any number of worker nodes by running the following on each as root: kubeadm join cloud.k8s.vip:6443 --token xy3gsl.dq2o7hriq4n5ujvs \\ --discovery-token-ca-cert-hash sha256:cb5fd12da0f6fbe1202d833e0e197b70f8e08c4d8cfca91c513a6ef8f6ae2efa \u62f7\u8d1d\u5b8c\u6210\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u52a0\u5165master\u8282\u70b9\u4e86\u3002\u8fd9\u6837\u4e09\u4e2a\u8282\u70b9\u7684\u9ad8\u53ef\u7528\u4e5f\u5c31\u5b8c\u6210\u4e86","title":"Ansible \u7cfb\u7edf\u521d\u59cb\u5316+\u90e8\u7f72kubernetes"},{"location":"basic/cncf-docs/","text":"\u4e91\u539f\u751f\u7684\u5b9a\u4e49 \u00b6 \u5b98\u65b9\u4ecb\u7ecd: \u4e91\u539f\u751f\u6280\u672f\u6709\u5229\u4e8e\u5404\u7ec4\u7ec7\u5728\u516c\u6709\u4e91\u3001\u79c1\u6709\u4e91\u548c\u6df7\u5408\u4e91\u7b49\u65b0\u578b\u52a8\u6001\u73af\u5883\u4e2d\uff0c\u6784\u5efa\u548c\u8fd0\u884c\u53ef\u5f39\u6027\u6269\u5c55\u7684\u5e94\u7528\u3002\u4e91\u539f\u751f\u7684\u4ee3\u8868\u6280\u672f\u5305\u62ec\u5bb9\u5668\u3001\u670d\u52a1\u7f51\u683c\u3001\u5fae\u670d\u52a1\u3001\u4e0d\u53ef\u53d8\u57fa\u7840\u8bbe\u65bd\u548c\u58f0\u660e\u5f0fAPI\u3002 \u8fd9\u4e9b\u6280\u672f\u80fd\u591f\u6784\u5efa\u5bb9\u9519\u6027\u597d\u3001\u6613\u4e8e\u7ba1\u7406\u548c\u4fbf\u4e8e\u89c2\u5bdf\u7684\u677e\u8026\u5408\u7cfb\u7edf\u3002\u7ed3\u5408\u53ef\u9760\u7684\u81ea\u52a8\u5316\u624b\u6bb5\uff0c\u4e91\u539f\u751f\u6280\u672f\u4f7f\u5de5\u7a0b\u5e08\u80fd\u591f\u8f7b\u677e\u5730\u5bf9\u7cfb\u7edf\u4f5c\u51fa\u9891\u7e41\u548c\u53ef\u9884\u6d4b\u7684\u91cd\u5927\u53d8\u66f4\u3002 \u4e91\u539f\u751f\u8ba1\u7b97\u57fa\u91d1\u4f1a\uff08CNCF\uff09\u81f4\u529b\u4e8e\u57f9\u80b2\u548c\u7ef4\u62a4\u4e00\u4e2a\u5382\u5546\u4e2d\u7acb\u7684\u5f00\u6e90\u751f\u6001\u7cfb\u7edf\uff0c\u6765\u63a8\u5e7f\u4e91\u539f\u751f\u6280\u672f\u3002\u6211\u4eec\u901a\u8fc7\u5c06\u6700\u524d\u6cbf\u7684\u6a21\u5f0f\u6c11\u4e3b\u5316\uff0c\u8ba9\u8fd9\u4e9b\u521b\u65b0\u4e3a\u5927\u4f17\u6240\u7528\u3002 CNCF \u4e91\u539f\u751f\u5bb9\u5668\u751f\u6001\u7cfb\u7edf\u6982\u8981 \u00b6 \u5b98\u65b9\u4ecb\u7ecd\uff1a CNCF \u5b98\u7f51: \u53c2\u8003 kubecon \u6d3b\u52a8\u4e86\u89e3\u5230\u4e00\u4e9b\u6700\u65b0\u7684\u6280\u672f.\u4ee5\u4e0b\u662f\u5bf9\u4e00\u4e9b\u6280\u672f\u7684\u7b80\u5355\u8bf4\u660e: KubeBlocks \u00b6 KubeBlocks\u521b\u5efa\u57fa\u7840\u8bbe\u65bd: (\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u7b26\u5408\u751f\u4ea7\u8981\u6c42\u7684\u6570\u636e\u5e93\u96c6\u7fa4) https://github.com/apecloud/kubeblocks#get-started-with-kubeblocks \u652f\u6301\u7684\u9644\u52a0\u7ec4\u4ef6: OpenKruise \u00b6 OpenKruise \u662f\u4e00\u4e2a\u57fa\u4e8e Kubernetes \u7684\u6269\u5c55\u5957\u4ef6\uff0c\u4e3b\u8981\u805a\u7126\u4e8e\u4e91\u539f\u751f\u5e94\u7528\u7684\u81ea\u52a8\u5316\uff0c\u6bd4\u5982 \u90e8\u7f72\u3001\u53d1\u5e03\u3001\u8fd0\u7ef4\u4ee5\u53ca\u53ef\u7528\u6027\u9632\u62a4\u3002 kubeasz \u00b6 kubeasz kubeasz (ansible\u81ea\u52a8\u5316\u5b89\u88c5\u4e8c\u8fdb\u5236k8s\u9879\u76ee) github \u5730\u5740: https://github.com/easzlab/kubeasz ceph \u00b6 ceph ceph (\u4e91\u539f\u751f\u5b58\u50a8) github \u5730\u5740: https://github.com/ceph/ceph rancher \u00b6 rancher \u4e00\u4e2a\u7ba1\u7406k8s\u7684UI\u5de5\u5177 \u5b98\u65b9\u5730\u5740: https://www.rancher.com/ cert-manager \u00b6 cert-manager \u4e91\u539f\u751f\u8bc1\u4e66\u7ba1\u7406 \u5b98\u65b9\u5730\u5740: https://cert-manager.io/ kubevirt \u00b6 kubeVirt \u4e91\u539f\u751f\u865a\u62df\u673a\u89e3\u51b3\u65b9\u6848\uff08\u5728k8s\u4e2d\u8fd0\u884c\u865a\u62df\u673a\uff09 Juicefs \u00b6 Juicefs \u4e91\u539f\u751f\u5206\u5e03\u5f0f\u5b58\u50a8 \u5b66\u4e60\u6587\u6863\uff1a \u00b6 www.qikqiak.com/k8strain www.qikqiak.com/k8strain2 www.qikqiak.com/k3s Devops\u5468\u671f\u8868 kubecon \u4f1a\u8bae","title":"\u4e91\u539f\u751f\u7b80\u4ecb\u53caCNCF"},{"location":"basic/cncf-docs/#_1","text":"\u5b98\u65b9\u4ecb\u7ecd: \u4e91\u539f\u751f\u6280\u672f\u6709\u5229\u4e8e\u5404\u7ec4\u7ec7\u5728\u516c\u6709\u4e91\u3001\u79c1\u6709\u4e91\u548c\u6df7\u5408\u4e91\u7b49\u65b0\u578b\u52a8\u6001\u73af\u5883\u4e2d\uff0c\u6784\u5efa\u548c\u8fd0\u884c\u53ef\u5f39\u6027\u6269\u5c55\u7684\u5e94\u7528\u3002\u4e91\u539f\u751f\u7684\u4ee3\u8868\u6280\u672f\u5305\u62ec\u5bb9\u5668\u3001\u670d\u52a1\u7f51\u683c\u3001\u5fae\u670d\u52a1\u3001\u4e0d\u53ef\u53d8\u57fa\u7840\u8bbe\u65bd\u548c\u58f0\u660e\u5f0fAPI\u3002 \u8fd9\u4e9b\u6280\u672f\u80fd\u591f\u6784\u5efa\u5bb9\u9519\u6027\u597d\u3001\u6613\u4e8e\u7ba1\u7406\u548c\u4fbf\u4e8e\u89c2\u5bdf\u7684\u677e\u8026\u5408\u7cfb\u7edf\u3002\u7ed3\u5408\u53ef\u9760\u7684\u81ea\u52a8\u5316\u624b\u6bb5\uff0c\u4e91\u539f\u751f\u6280\u672f\u4f7f\u5de5\u7a0b\u5e08\u80fd\u591f\u8f7b\u677e\u5730\u5bf9\u7cfb\u7edf\u4f5c\u51fa\u9891\u7e41\u548c\u53ef\u9884\u6d4b\u7684\u91cd\u5927\u53d8\u66f4\u3002 \u4e91\u539f\u751f\u8ba1\u7b97\u57fa\u91d1\u4f1a\uff08CNCF\uff09\u81f4\u529b\u4e8e\u57f9\u80b2\u548c\u7ef4\u62a4\u4e00\u4e2a\u5382\u5546\u4e2d\u7acb\u7684\u5f00\u6e90\u751f\u6001\u7cfb\u7edf\uff0c\u6765\u63a8\u5e7f\u4e91\u539f\u751f\u6280\u672f\u3002\u6211\u4eec\u901a\u8fc7\u5c06\u6700\u524d\u6cbf\u7684\u6a21\u5f0f\u6c11\u4e3b\u5316\uff0c\u8ba9\u8fd9\u4e9b\u521b\u65b0\u4e3a\u5927\u4f17\u6240\u7528\u3002","title":"\u4e91\u539f\u751f\u7684\u5b9a\u4e49"},{"location":"basic/cncf-docs/#cncf","text":"\u5b98\u65b9\u4ecb\u7ecd\uff1a CNCF \u5b98\u7f51: \u53c2\u8003 kubecon \u6d3b\u52a8\u4e86\u89e3\u5230\u4e00\u4e9b\u6700\u65b0\u7684\u6280\u672f.\u4ee5\u4e0b\u662f\u5bf9\u4e00\u4e9b\u6280\u672f\u7684\u7b80\u5355\u8bf4\u660e:","title":"CNCF \u4e91\u539f\u751f\u5bb9\u5668\u751f\u6001\u7cfb\u7edf\u6982\u8981"},{"location":"basic/cncf-docs/#kubeblocks","text":"KubeBlocks\u521b\u5efa\u57fa\u7840\u8bbe\u65bd: (\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5feb\u901f\u521b\u5efa\u4e00\u4e2a\u7b26\u5408\u751f\u4ea7\u8981\u6c42\u7684\u6570\u636e\u5e93\u96c6\u7fa4) https://github.com/apecloud/kubeblocks#get-started-with-kubeblocks \u652f\u6301\u7684\u9644\u52a0\u7ec4\u4ef6:","title":"KubeBlocks"},{"location":"basic/cncf-docs/#openkruise","text":"OpenKruise \u662f\u4e00\u4e2a\u57fa\u4e8e Kubernetes \u7684\u6269\u5c55\u5957\u4ef6\uff0c\u4e3b\u8981\u805a\u7126\u4e8e\u4e91\u539f\u751f\u5e94\u7528\u7684\u81ea\u52a8\u5316\uff0c\u6bd4\u5982 \u90e8\u7f72\u3001\u53d1\u5e03\u3001\u8fd0\u7ef4\u4ee5\u53ca\u53ef\u7528\u6027\u9632\u62a4\u3002","title":"OpenKruise"},{"location":"basic/cncf-docs/#kubeasz","text":"kubeasz kubeasz (ansible\u81ea\u52a8\u5316\u5b89\u88c5\u4e8c\u8fdb\u5236k8s\u9879\u76ee) github \u5730\u5740: https://github.com/easzlab/kubeasz","title":"kubeasz"},{"location":"basic/cncf-docs/#ceph","text":"ceph ceph (\u4e91\u539f\u751f\u5b58\u50a8) github \u5730\u5740: https://github.com/ceph/ceph","title":"ceph"},{"location":"basic/cncf-docs/#rancher","text":"rancher \u4e00\u4e2a\u7ba1\u7406k8s\u7684UI\u5de5\u5177 \u5b98\u65b9\u5730\u5740: https://www.rancher.com/","title":"rancher"},{"location":"basic/cncf-docs/#cert-manager","text":"cert-manager \u4e91\u539f\u751f\u8bc1\u4e66\u7ba1\u7406 \u5b98\u65b9\u5730\u5740: https://cert-manager.io/","title":"cert-manager"},{"location":"basic/cncf-docs/#kubevirt","text":"kubeVirt \u4e91\u539f\u751f\u865a\u62df\u673a\u89e3\u51b3\u65b9\u6848\uff08\u5728k8s\u4e2d\u8fd0\u884c\u865a\u62df\u673a\uff09","title":"kubevirt"},{"location":"basic/cncf-docs/#juicefs","text":"Juicefs \u4e91\u539f\u751f\u5206\u5e03\u5f0f\u5b58\u50a8","title":"Juicefs"},{"location":"basic/cncf-docs/#_2","text":"www.qikqiak.com/k8strain www.qikqiak.com/k8strain2 www.qikqiak.com/k3s Devops\u5468\u671f\u8868 kubecon \u4f1a\u8bae","title":"\u5b66\u4e60\u6587\u6863\uff1a"},{"location":"basic/etcd/","text":"Etcd \u5907\u4efd \u00b6 https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/ Info \u4ee5\u4e0b\u5907\u4efd\u4e3b\u8981\u662f\u4ee5kubeadm\u5b89\u88c5\u7684k8s \u67e5\u770b\u8bc1\u4e66\u7684\u8def\u5f84 \u00b6 [cka] root@master0:/home/lixie# cat /etc/kubernetes/manifests/etcd.yaml apiVersion: v1 kind: Pod metadata: annotations: kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.159.81:2379 creationTimestamp: null labels: component: etcd tier: control-plane name: etcd namespace: kube-system spec: containers: - command: - etcd - --advertise-client-urls=https://192.168.159.81:2379 - --cert-file=/etc/kubernetes/pki/etcd/server.crt # \u6307\u5b9a crt \u6587\u4ef6 - --client-cert-auth=true - --data-dir=/var/lib/etcd - --initial-advertise-peer-urls=https://192.168.159.81:2380 - --initial-cluster=master0=https://192.168.159.81:2380 - --key-file=/etc/kubernetes/pki/etcd/server.key # \u6307\u5b9a key \u6587\u4ef6 - --listen-client-urls=https://127.0.0.1:2379,https://192.168.159.81:2379 - --listen-metrics-urls=http://127.0.0.1:2381 - --listen-peer-urls=https://192.168.159.81:2380 - --name=master0 - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt - --peer-client-cert-auth=true - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt # \u6307\u5b9a\u8bc1\u4e66\u6587\u4ef6 - --snapshot-count=10000 - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt \u624b\u52a8\u5907\u4efd \u00b6 \u5b89\u88c5etcd\u5ba2\u6237\u7aef \u00b6 apt install etcd-client \u6307\u5b9a\u8def\u5f84\u5907\u4efd \u00b6 \u8fd9\u91cc\u5c06\u5907\u4efd\u6307\u5b9a\u5907\u4efd\u5230 /srv/data/\uff0c\u6307\u5b9a\u7684\u4e09\u4e2a\u6587\u4ef6\u5c31\u662f\u4ee5\u4e0a\u6807\u6ce8\u7684\u4e09\u4e2a\u4f4d\u7f6e export ETCDCTL_API=3 # \u58f0\u660eetcd-api mkdir /srv/data/ etcdctl --endpoints=https://127.0.0.1:2379 \\ --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key \\ snapshot save /srv/data/etcd-snapshot.db \u6821\u9a8c\u7ed3\u679c\uff1a etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot status /srv/data/etcd-snapshot.db \u81ea\u52a8\u5907\u4efd \u00b6 \u8fd8\u539f\uff08kubeadm \u5b89\u88c5\u7684k8s\uff09 \u00b6 \u6a21\u62df\u6545\u969c \u00b6 \u8fd9\u91cc\u6211\u6a21\u62df\u5220\u9664\u4e86\u8fd9\u4e2a\u8d44\u6e90\uff0c\u770b\u4e00\u4f1a\u662f\u5426\u53ef\u4ee5\u8fd8\u539f [ucloud] root@master0:~# k get pod NAME READY STATUS RESTARTS AGE nginx-ds-6mnw5 1/1 Running 0 2d [ucloud] root@master0:~# k delete ds nginx-ds daemonset.apps \"nginx-ds\" deleted \u786e\u8ba4k8s\u7ec4\u4ef6\u7684\u4f4d\u7f6e \u00b6 \u67e5\u770bkubelet\u7684\u72b6\u6001 [ucloud] root@master0:~# systemctl status kubelet \u25cf kubelet.service - kubelet: The Kubernetes Node Agent Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled) Drop-In: /etc/systemd/system/kubelet.service.d # \u67e5\u770b\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6 \u2514\u250010-kubeadm.conf Active: active (running) since Mon 2022-07-04 15:09:15 CST; 1 day 23h ago Docs: https://kubernetes.io/docs/home/ Main PID: 39279 (kubelet) Tasks: 17 (limit: 4390) Memory: 63.3M CGroup: /system.slice/kubelet.service \u67e5\u770b\u6587\u4ef6\uff1a/etc/systemd/system/kubelet.service.d/10-kubeadm.conf [ucloud] root@master0:~# cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf # Note: This dropin only works with kubeadm and kubelet v1.11+ [Service] Environment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf\" Environment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\" # \u67e5\u770b\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6 # This is a file that \"kubeadm init\" and \"kubeadm join\" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file. EnvironmentFile=-/etc/default/kubelet ExecStart= ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS \u67e5\u770b\u6587\u4ef6\uff1a/var/lib/kubelet/config.yaml [ucloud] root@master0:~# cat /var/lib/kubelet/config.yaml apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false webhook: cacheTTL: 0s enabled: true x509: ...... staticPodPath: /etc/kubernetes/manifests # \u770b\u5230\u8fd9\u884c\uff0c\u5c31\u8bf4\u660e\u914d\u7f6e\u6587\u4ef6\u8fd9\u4e2amanifests\u4e0b streamingConnectionIdleTimeout: 0s syncFrequency: 0s volumeStatsAggPeriod: 0s \u505c\u6b62api-server \u00b6 [ucloud] root@master0:~# mkdir /opt/backup/ -p [ucloud] root@master0:~# cd /etc/kubernetes/manifests [ucloud] root@master0:/etc/kubernetes/manifests# ll total 24 drwxr-xr-x 2 root root 4096 Jul 3 22:01 ./ drwxr-xr-x 5 root root 4096 Jul 3 21:15 ../ -rw------- 1 root root 2294 Jul 3 22:00 etcd.yaml -rw------- 1 root root 4036 Jul 3 22:00 kube-apiserver.yaml -rw------- 1 root root 3541 Jul 3 22:00 kube-controller-manager.yaml -rw------- 1 root root 1464 Jul 3 22:00 kube-scheduler.yaml [ucloud] root@master0:/etc/kubernetes/manifests# mv kube-* /opt/backup/ # \u79fb\u8d70\u4e4b\u540e\u6211\u4eec\u4f1a\u53d1\u73b0\u4e0d\u80fd\u4f7f\u7528kubectl\u547d\u4ee4 \u8fdb\u884c\u8fd8\u539f \u00b6 \u5982\u679c\u6062\u590d\u5931\u8d25\u9700\u8981\u6dfb\u52a0--skip-hash-check\u53c2\u6570 [ucloud] root@master0:~# etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot restore /srv/data/etcd-snapshot.db --data-dir=/var/lib/etcd-restore --skip-hash-check \u4fee\u6539etcd\u7684\u914d\u7f6e\u6587\u4ef6 \u5c06 volume \u914d\u7f6e\u7684 path: /var/lib/etcd \u6539\u6210/var/lib/etcd-restore [ucloud] root@master0:/etc/kubernetes/manifests# pwd /etc/kubernetes/manifests [ucloud] root@master0:/etc/kubernetes/manifests# vim etcd.yaml - hostPath: path: /var/lib/etcd-restore # \u5c06\u6539\u76ee\u5f55\u4fee\u6539\u4e3a\u8fd8\u539fetcd\u7684\u4f4d\u7f6e type: DirectoryOrCreate \u8fd8\u539fk8s\u7ec4\u4ef6 mv /opt/backup/* /etc/kubernetes/manifests systemctl restart kubelet \u6821\u9a8c\u7ed3\u679c\uff1a \u53d1\u73b0\u8bef\u5220\u9664\u7684pod\u8fd8\u539f\u6210\u529f [ucloud] root@master0:/etc/kubernetes/manifests# k get pod NAME READY STATUS RESTARTS AGE nginx-ds-6mnw5 1/1 Running 0 2d","title":"Etcd \u5907\u4efd"},{"location":"basic/etcd/#etcd","text":"https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/ Info \u4ee5\u4e0b\u5907\u4efd\u4e3b\u8981\u662f\u4ee5kubeadm\u5b89\u88c5\u7684k8s","title":"Etcd \u5907\u4efd"},{"location":"basic/etcd/#_1","text":"[cka] root@master0:/home/lixie# cat /etc/kubernetes/manifests/etcd.yaml apiVersion: v1 kind: Pod metadata: annotations: kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.159.81:2379 creationTimestamp: null labels: component: etcd tier: control-plane name: etcd namespace: kube-system spec: containers: - command: - etcd - --advertise-client-urls=https://192.168.159.81:2379 - --cert-file=/etc/kubernetes/pki/etcd/server.crt # \u6307\u5b9a crt \u6587\u4ef6 - --client-cert-auth=true - --data-dir=/var/lib/etcd - --initial-advertise-peer-urls=https://192.168.159.81:2380 - --initial-cluster=master0=https://192.168.159.81:2380 - --key-file=/etc/kubernetes/pki/etcd/server.key # \u6307\u5b9a key \u6587\u4ef6 - --listen-client-urls=https://127.0.0.1:2379,https://192.168.159.81:2379 - --listen-metrics-urls=http://127.0.0.1:2381 - --listen-peer-urls=https://192.168.159.81:2380 - --name=master0 - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt - --peer-client-cert-auth=true - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt # \u6307\u5b9a\u8bc1\u4e66\u6587\u4ef6 - --snapshot-count=10000 - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt","title":"\u67e5\u770b\u8bc1\u4e66\u7684\u8def\u5f84"},{"location":"basic/etcd/#_2","text":"","title":"\u624b\u52a8\u5907\u4efd"},{"location":"basic/etcd/#etcd_1","text":"apt install etcd-client","title":"\u5b89\u88c5etcd\u5ba2\u6237\u7aef"},{"location":"basic/etcd/#_3","text":"\u8fd9\u91cc\u5c06\u5907\u4efd\u6307\u5b9a\u5907\u4efd\u5230 /srv/data/\uff0c\u6307\u5b9a\u7684\u4e09\u4e2a\u6587\u4ef6\u5c31\u662f\u4ee5\u4e0a\u6807\u6ce8\u7684\u4e09\u4e2a\u4f4d\u7f6e export ETCDCTL_API=3 # \u58f0\u660eetcd-api mkdir /srv/data/ etcdctl --endpoints=https://127.0.0.1:2379 \\ --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key \\ snapshot save /srv/data/etcd-snapshot.db \u6821\u9a8c\u7ed3\u679c\uff1a etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot status /srv/data/etcd-snapshot.db","title":"\u6307\u5b9a\u8def\u5f84\u5907\u4efd"},{"location":"basic/etcd/#_4","text":"","title":"\u81ea\u52a8\u5907\u4efd"},{"location":"basic/etcd/#kubeadm-k8s","text":"","title":"\u8fd8\u539f\uff08kubeadm \u5b89\u88c5\u7684k8s\uff09"},{"location":"basic/etcd/#_5","text":"\u8fd9\u91cc\u6211\u6a21\u62df\u5220\u9664\u4e86\u8fd9\u4e2a\u8d44\u6e90\uff0c\u770b\u4e00\u4f1a\u662f\u5426\u53ef\u4ee5\u8fd8\u539f [ucloud] root@master0:~# k get pod NAME READY STATUS RESTARTS AGE nginx-ds-6mnw5 1/1 Running 0 2d [ucloud] root@master0:~# k delete ds nginx-ds daemonset.apps \"nginx-ds\" deleted","title":"\u6a21\u62df\u6545\u969c"},{"location":"basic/etcd/#k8s","text":"\u67e5\u770bkubelet\u7684\u72b6\u6001 [ucloud] root@master0:~# systemctl status kubelet \u25cf kubelet.service - kubelet: The Kubernetes Node Agent Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled) Drop-In: /etc/systemd/system/kubelet.service.d # \u67e5\u770b\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6 \u2514\u250010-kubeadm.conf Active: active (running) since Mon 2022-07-04 15:09:15 CST; 1 day 23h ago Docs: https://kubernetes.io/docs/home/ Main PID: 39279 (kubelet) Tasks: 17 (limit: 4390) Memory: 63.3M CGroup: /system.slice/kubelet.service \u67e5\u770b\u6587\u4ef6\uff1a/etc/systemd/system/kubelet.service.d/10-kubeadm.conf [ucloud] root@master0:~# cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf # Note: This dropin only works with kubeadm and kubelet v1.11+ [Service] Environment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf\" Environment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\" # \u67e5\u770b\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6 # This is a file that \"kubeadm init\" and \"kubeadm join\" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file. EnvironmentFile=-/etc/default/kubelet ExecStart= ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS \u67e5\u770b\u6587\u4ef6\uff1a/var/lib/kubelet/config.yaml [ucloud] root@master0:~# cat /var/lib/kubelet/config.yaml apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false webhook: cacheTTL: 0s enabled: true x509: ...... staticPodPath: /etc/kubernetes/manifests # \u770b\u5230\u8fd9\u884c\uff0c\u5c31\u8bf4\u660e\u914d\u7f6e\u6587\u4ef6\u8fd9\u4e2amanifests\u4e0b streamingConnectionIdleTimeout: 0s syncFrequency: 0s volumeStatsAggPeriod: 0s","title":"\u786e\u8ba4k8s\u7ec4\u4ef6\u7684\u4f4d\u7f6e"},{"location":"basic/etcd/#api-server","text":"[ucloud] root@master0:~# mkdir /opt/backup/ -p [ucloud] root@master0:~# cd /etc/kubernetes/manifests [ucloud] root@master0:/etc/kubernetes/manifests# ll total 24 drwxr-xr-x 2 root root 4096 Jul 3 22:01 ./ drwxr-xr-x 5 root root 4096 Jul 3 21:15 ../ -rw------- 1 root root 2294 Jul 3 22:00 etcd.yaml -rw------- 1 root root 4036 Jul 3 22:00 kube-apiserver.yaml -rw------- 1 root root 3541 Jul 3 22:00 kube-controller-manager.yaml -rw------- 1 root root 1464 Jul 3 22:00 kube-scheduler.yaml [ucloud] root@master0:/etc/kubernetes/manifests# mv kube-* /opt/backup/ # \u79fb\u8d70\u4e4b\u540e\u6211\u4eec\u4f1a\u53d1\u73b0\u4e0d\u80fd\u4f7f\u7528kubectl\u547d\u4ee4","title":"\u505c\u6b62api-server"},{"location":"basic/etcd/#_6","text":"\u5982\u679c\u6062\u590d\u5931\u8d25\u9700\u8981\u6dfb\u52a0--skip-hash-check\u53c2\u6570 [ucloud] root@master0:~# etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot restore /srv/data/etcd-snapshot.db --data-dir=/var/lib/etcd-restore --skip-hash-check \u4fee\u6539etcd\u7684\u914d\u7f6e\u6587\u4ef6 \u5c06 volume \u914d\u7f6e\u7684 path: /var/lib/etcd \u6539\u6210/var/lib/etcd-restore [ucloud] root@master0:/etc/kubernetes/manifests# pwd /etc/kubernetes/manifests [ucloud] root@master0:/etc/kubernetes/manifests# vim etcd.yaml - hostPath: path: /var/lib/etcd-restore # \u5c06\u6539\u76ee\u5f55\u4fee\u6539\u4e3a\u8fd8\u539fetcd\u7684\u4f4d\u7f6e type: DirectoryOrCreate \u8fd8\u539fk8s\u7ec4\u4ef6 mv /opt/backup/* /etc/kubernetes/manifests systemctl restart kubelet \u6821\u9a8c\u7ed3\u679c\uff1a \u53d1\u73b0\u8bef\u5220\u9664\u7684pod\u8fd8\u539f\u6210\u529f [ucloud] root@master0:/etc/kubernetes/manifests# k get pod NAME READY STATUS RESTARTS AGE nginx-ds-6mnw5 1/1 Running 0 2d","title":"\u8fdb\u884c\u8fd8\u539f"},{"location":"basic/overview/","text":"K8S\u7b80\u4ecb \u00b6","title":"K8S\u7b80\u4ecb"},{"location":"basic/overview/#k8s","text":"","title":"K8S\u7b80\u4ecb"},{"location":"cert-manager/cert-manager-doc/","text":"Cert-manager \u5b89\u88c5 \u00b6 helm upgrade --install \\ cert-manager jetstack/cert-manager \\ --namespace cert-manager \\ --create-namespace \\ --version v1.15.1 \\ -f ./values.yaml values \u914d\u7f6e\u6587\u4ef6\uff1a installCRDs : true extraArgs : - --enable-certificate-owner-ref=true - --dns01-recursive-nameservers-only - --dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53 \u6e29\u99a8\u63d0\u793a \u5728\u4f7f\u7528cert-manager\u5bf9\u63a5cloudflare\u65f6\uff0c\u51fa\u73b0\u4e86DNS\u65e0\u6cd5\u9a8c\u8bc1\u7684\u60c5\u51b5\uff0c\u5177\u4f53\u5185\u5bb9\u53ef\u4ee5\u770b\u4e0b\u6765\u7684issues\uff0c\u89e3\u51b3\u529e\u6cd5\u89e3\u91ca\u52a0\u4e0avalues\u4e2d\u7684\u5185\u5bb9\u3002 \u95ee\u9898\u5904\u7406 \u00b6 https://github.com/cert-manager/cert-manager/issues/5917","title":"kubernetes Cert-manager \u5b89\u88c5"},{"location":"cert-manager/cert-manager-doc/#cert-manager","text":"helm upgrade --install \\ cert-manager jetstack/cert-manager \\ --namespace cert-manager \\ --create-namespace \\ --version v1.15.1 \\ -f ./values.yaml values \u914d\u7f6e\u6587\u4ef6\uff1a installCRDs : true extraArgs : - --enable-certificate-owner-ref=true - --dns01-recursive-nameservers-only - --dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53 \u6e29\u99a8\u63d0\u793a \u5728\u4f7f\u7528cert-manager\u5bf9\u63a5cloudflare\u65f6\uff0c\u51fa\u73b0\u4e86DNS\u65e0\u6cd5\u9a8c\u8bc1\u7684\u60c5\u51b5\uff0c\u5177\u4f53\u5185\u5bb9\u53ef\u4ee5\u770b\u4e0b\u6765\u7684issues\uff0c\u89e3\u51b3\u529e\u6cd5\u89e3\u91ca\u52a0\u4e0avalues\u4e2d\u7684\u5185\u5bb9\u3002","title":"Cert-manager \u5b89\u88c5"},{"location":"cert-manager/cert-manager-doc/#_1","text":"https://github.com/cert-manager/cert-manager/issues/5917","title":"\u95ee\u9898\u5904\u7406"},{"location":"chatgpt/chatgpt-docs/","text":"\u5927\u5bb6\u90fd\u4e86\u89e3\uff0c\u56fd\u5185\u653f\u7b56\u7684\u5f71\u54cd\uff0c\u65e0\u6cd5\u5728\u5185\u5730\u4f7f\u7528chatgpt\u3002\u800c\u4e14\u6ce8\u518c\u6bd4\u8f83\u7e41\u7410\u3002\u9700\u8981\u4e00\u4e2a\u5883\u5916\u624b\u673a\u53f7\u505a\u9a8c\u8bc1.\u56e0\u6b64\u6211\u5bf9\u6ce8\u518cchatgpt\u505a\u4e86\u4e00\u4e9b\u8bb0\u5f55 \u51c6\u5907\u5de5\u4f5c: \u51c6\u5907\u4e00\u4e2a\u63a5\u7801\u5e73\u53f0:","title":"\u6ce8\u518cchatgpt"},{"location":"chatgpt/chatgpt-pulgin-docs/","text":"Pluginpedia There's An AI For That HeyGen # \u89c6\u5c4f\u751f\u6210\u63d2\u4ef6 Show me diagrams # \u601d\u7ef4\u5bfc\u56fe","title":"Chatgpt pulgin docs"},{"location":"chatgpt/google-ai-docs/","text":"","title":"\u641c\u7d22\u6280\u672f\u8bb0\u5f55"},{"location":"chatgpt/gpts-docs/","text":"chatgpt 4.0 \u5e26\u6765gtps\u7684\u529f\u80fd\u6210\u4e3a\u5168\u65b0\u516c\u5e03\u51fa\u6765\u7684\u6700\u6709\u4eae\u70b9\u7684\u7279\u6027\u3002\u4ee5\u4e0b\u662f\u5bf9gpts\u505a\u4e00\u4e0b\u8bb0\u5f55\u3002 \u901a\u8fc7\u5bf9\u8bdd\u6765\u5b9e\u73b0\u521b\u5efa\u81ea\u5df1\u72ec\u6709\u5b9a\u5236\u7684gpt \u6f14\u793a\u6b65\u9aa4: \u00b6 \u70b9\u51fbcreate a GPT \u5c31\u53ef\u4ee5\u521b\u5efa\u4e86 \u53ef\u4ee5\u770b\u5230\u5de6\u8fb9\u90e8\u5206\uff0c\u548c\u53f3\u8fb9\u90e8\u5206\uff08\u5de6\u8fb9\u5176\u5b9e\u5c31\u662f\u901a\u8fc7\u81ea\u7136\u8bed\u8a00\u6765\u5236\u4f5c\u4e00\u4e2a\u5b9a\u5236\u5316\u7684gpt\uff09 \u6211\u4eec\u53ef\u4ee5\u6253\u5f00config\u7684\u914d\u7f6e\u9875\u9762\uff08\u901a\u8fc7config\u8fd9\u4e2a\u914d\u7f6e\u9875\u9762\u6211\u4eec\u53ef\u4ee5\u5bf9\u6211\u4eec\u7684gpt\u8fdb\u884c\u8c03\u8bd5\uff09","title":"\u5982\u4f55\u4f7f\u7528Chatgpt\u6765\u5236\u4f5c\u4e13\u5c5egpt"},{"location":"chatgpt/gpts-docs/#_1","text":"\u70b9\u51fbcreate a GPT \u5c31\u53ef\u4ee5\u521b\u5efa\u4e86 \u53ef\u4ee5\u770b\u5230\u5de6\u8fb9\u90e8\u5206\uff0c\u548c\u53f3\u8fb9\u90e8\u5206\uff08\u5de6\u8fb9\u5176\u5b9e\u5c31\u662f\u901a\u8fc7\u81ea\u7136\u8bed\u8a00\u6765\u5236\u4f5c\u4e00\u4e2a\u5b9a\u5236\u5316\u7684gpt\uff09 \u6211\u4eec\u53ef\u4ee5\u6253\u5f00config\u7684\u914d\u7f6e\u9875\u9762\uff08\u901a\u8fc7config\u8fd9\u4e2a\u914d\u7f6e\u9875\u9762\u6211\u4eec\u53ef\u4ee5\u5bf9\u6211\u4eec\u7684gpt\u8fdb\u884c\u8c03\u8bd5\uff09","title":"\u6f14\u793a\u6b65\u9aa4:"},{"location":"cks/cka/","text":"cka \u8ba4\u8bc1\u8003\u8bd5 \u00b6 1. \u76d1\u63a7 pod\u65e5\u5fd7 5% \u00b6 \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u76d1\u63a7\u540d\u4e3a foobar \u7684 Pod \u7684\u65e5\u5fd7\uff0c\u5e76\u8fc7\u6ee4\u51fa\u5177\u6709 unable-access-website \u4fe1\u606f\u7684\u884c\uff0c\u7136\u540e\u5c06\u5199\u5165\u5230 /opt/KUTR00101/foobar \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl logs foobar | grep unable-access-website > /opt/KUTR00101/foobar 2.\u76d1\u63a7 pod \u5ea6\u91cf \u6307\u6807: 5% \u00b6 \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u627e\u51fa\u5177\u6709 name=cpu-user \u7684 Pod\uff0c\u5e76\u8fc7\u6ee4\u51fa\u4f7f\u7528 CPU \u6700\u9ad8\u7684 Pod\uff0c\u7136\u540e\u628a\u5b83\u7684\u540d\u5b57\u5199\u5728\u5df2\u7ecf\u5b58\u5728\u7684/opt/KUTR00401/KUTR00401.txt \u6587\u4ef6\u91cc \uff08\u6ce8\u610f\u4ed6\u6ca1\u6709\u8bf4\u6307\u5b9a namespace\u3002\u6240\u4ee5\u9700\u8981\u4f7f\u7528-A \u6307\u5b9a\u6240\u4ee5 namespace\uff09 \u6ce8\u610f\u662f \u8ffd\u52a0 \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl top pod -A -l | grep name = cpu-user # \u6ce8\u610f\u8fd9\u91cc\u7684 pod \u540d\u5b57\u4ee5\u5b9e\u9645\u540d\u5b57\u4e3a\u51c6\uff0c\u6309\u7167 CPU \u90a3\u4e00\u5217\u8fdb\u884c\u9009\u62e9\u4e00\u4e2a\u6700\u5927\u7684 Pod\uff0c\u53e6\u5916\u5982\u679c CPU \u7684\u6570\u503c\u662f 1 2 3 \u8fd9\u6837\u7684\u3002\u662f\u5927\u4e8e\u5e26 m \u8fd9\u6837\u7684\uff0c\u56e0\u4e3a 1 \u9897 CPU \u7b49\u4e8e 1000m\uff0c\u6ce8\u610f\u8981\u7528>>\u800c\u4e0d\u662f> $ echo \"coredns-54d67798b7-hl8xc\" >> /opt/KUTR00401/KUTR00401.txt 3.Deployment \u6269\u7f29\u5bb9 \u00b6 \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u6269\u5bb9\u540d\u5b57\u4e3a loadbalancer \u7684 deployment \u7684\u526f\u672c\u6570\u4e3a 6 \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl scale --replicas = 6 deployment loadbalancer $ kubectl edit 4. \u68c0\u67e5 Node \u8282\u70b9\u7684\u5065\u5eb7\u72b6\u6001 \u00b6 \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u68c0\u67e5\u96c6\u7fa4\u4e2d\u6709\u591a\u5c11\u8282\u70b9\u4e3a Ready \u72b6\u6001\uff0c\u5e76\u4e14\u53bb\u9664\u5305\u542b NoSchedule \u6c61\u70b9\u7684\u8282\u70b9\u3002\u4e4b\u540e\u5c06\u6570\u5b57\u5199\u5230/opt/KUSC00402/kusc00402.txt \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl get node | grep -i ready # \u8bb0\u5f55\u603b\u6570\u4e3a A $ kubectl describe node | grep Taint | grep NoSchedule # \u8bb0\u5f55\u603b\u6570\u4e3a B # \u5c06 A \u51cf B \u7684\u503c x \u5bfc\u5165\u5230/opt/KUSC00402/kusc00402.txt $ echo x >> /opt/KUSC00402/kusc00402.txt 5. \u8282\u70b9\u7ef4\u62a4 \u00b6 \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u5c06 ek8s-node-1 \u8282\u70b9\u8bbe\u7f6e\u4e3a\u4e0d\u53ef\u7528\uff0c\u7136\u540e\u91cd\u65b0\u8c03\u5ea6\u8be5\u8282\u70b9\u4e0a\u7684\u6240\u6709 Pod \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context ek8s $ kubectl cordon ek8s-node-1 $ kubectl drain ek8s-node-1 --delete-emptydir-data --ignore-daemonsets --force $ k delete pod pod-name --grace-period = 0 --force 6. \u6307\u5b9a\u8282\u70b9\u90e8\u7f72 \u00b6 \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a Pod\uff0c\u540d\u5b57\u4e3a nginx-kusc00401\uff0c\u955c\u50cf\u5730\u5740\u662f nginx\uff0c\u8c03\u5ea6\u5230\u5177\u6709 disk=spinning \u6807\u7b7e\u7684\u8282\u70b9\u4e0a \uff0c \u8be5\u9898\u53ef\u4ee5\u53c2\u8003\u94fe\u63a5\uff1a https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/ \u8be5\u9898\u53ef\u4ee5\u53c2\u8003\u94fe\u63a5\uff1a https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/ \u89e3\u9898\u6b65\u9aa4: \u9898\u76ee\u4e00\uff1a apiVersion : v1 kind : Pod metadata : name : nginx-kusc00401 labels : role : nginx-kusc00401 spec : containers : - name : nginx image : nginx nodeSelector : disk : spinning \u9898\u76ee\u4e8c\uff1a $ cat 6-2-cka.yaml apiVersion : v1 kind : Pod metadata : name : nginx-kusc00402 labels : role : nginx-kusc00402 spec : nodeName : node1 containers : - name : nginx image : nginx 7. \u4e00\u4e2a Pod \u591a\u4e2a\u5bb9\u5668 \u00b6 \u56fe\u793a\uff1a \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a Pod \uff0c \u540d\u5b57\u4e3a kucc1 \uff0c\u8fd9\u4e2a Pod \u53ef\u80fd\u5305\u542b 1-4 \u5bb9 \u5668 \uff0c \u8be5\u9898\u4e3a\u56db\u4e2a \uff1anginx+redis+memcached+consul \u89e3\u9898\u6b65\u9aa4: $ cat 7-cka.yaml apiVersion : v1 kind : Pod metadata : name : kucc1 spec : containers : - name : nginx image : nginx - name : redis image : redis - name : memcached image : memcached - name : consul image : consul 8. Service \u8003\u9898 \u00b6 \u4e2d\u6587\u89e3\u91ca: \u91cd\u65b0\u914d\u7f6e\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684 deployment front-end\uff0c\u5728\u540d\u5b57\u4e3a nginx \u7684\u5bb9\u5668\u91cc\u9762\u6dfb\u52a0\u4e00\u4e2a\u7aef\u53e3\u914d\u7f6e\uff0c\u540d\u5b57\u4e3a http\uff0c\u66b4\u9732\u7aef\u53e3\u53f7\u4e3a 80\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a service\uff0c\u540d\u5b57\u4e3a front-end-svc\uff0c\u66b4\u9732\u8be5deployment \u7684 http \u7aef\u53e3\uff0c\u5e76\u4e14 service \u7684\u7c7b\u578b\u4e3a NodePort\u3002 ports : - containerPort : 80 name : http protocol : TCP \u521b\u5efa\u4e00\u4e2asvc kubectl expose deploy front-end --name = front-end-svc --port = 80 \\ --target-port = http --type = NodePort 9. Ingress\u8003\u9898 8% \u00b6 \u53c2\u8003\u5730\u5740: https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/ \u56fe\u793a: \u73af\u5883\u51c6\u5907: [ cka ] root@master0:/home/lixie# k label node node1 ingress = true node/node1 labeled \u4e2d\u6587\u89e3\u91ca: \u5728 ing-internal \u547d\u540d\u7a7a\u95f4\u4e0b\u521b\u5efa\u4e00\u4e2a ingress\uff0c\u540d\u5b57\u4e3a pong\uff0c\u4ee3\u7406\u7684 service hi\uff0c\u7aef\u53e3\u4e3a 5678\uff0c\u914d\u7f6e\u8def\u5f84/hi\u3002 \u9a8c\u8bc1\uff1a\u8bbf\u95ee curl -kL /hi \u4f1a\u8fd4\u56de hi \u89e3\u9898\u6b65\u9aa4: $ k label node node2 ingress = true $ k apply -f ingress.yaml [ cka ] root@master0:~/cka# cat 9-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : pong # \u540d\u79f0\u9700\u8981\u8be5 namespace : ing-internal # \u9700\u8981\u8be5 spec : ingressClassName : nginx rules : - http : paths : - pathType : Prefix path : \"/hi\" # \u8bbf\u95ee\u8def\u5f84\u9700\u8981\u6539 backend : service : name : front-end-svc # \u9700\u8981\u8be5 port : number : 80 10. Sidecar 8% \u00b6 \u56fe\u793a: \u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/ \u4e2d\u6587\u89e3\u91ca: \u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a busybox \u4e14\u955c\u50cf\u4e3a busybox \u7684 sidecar \u5230\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u540d\u4e3a legacy-app \u7684 Pod \u4e0a\uff0c\u8fd9\u4e2a sidecar \u7684\u542f\u52a8\u547d\u4ee4\u4e3a/bin/sh, -c, 'tail -n+1 -f /var/log/legacy-app.log'\u3002 \u5e76\u4e14\u8fd9\u4e2a sidecar \u548c\u539f\u6709\u7684\u955c\u50cf\u6302\u8f7d\u4e00\u4e2a\u540d\u4e3a logs \u7684 volume\uff0c\u6302\u8f7d\u7684\u76ee\u5f55\u4e3a/var/log/ \u5bfc\u51fayaml [ cka ] root@master0:~/cka# cat 10-1.yaml apiVersion : v1 kind : Pod metadata : name : legacy-app spec : containers : - name : count image : busybox args : - /bin/sh - -c - > i=0; while true; do echo \"$(date) INFO $i\" >> /var/log/legacy-app.log; i=$((i+1)); sleep 1; done \u9996\u5148\u5c06 legacy-app \u7684 Pod \u7684 yaml \u5bfc\u51fa\uff0c\u5927\u81f4\u5982\u4e0b\uff1a kubectl get pod legacy-app -o yaml > 10-2.yaml \u8fdb\u884c\u4fee\u6539 [ cka ] root@master0:~/cka# cat 10-2.yaml apiVersion : v1 kind : Pod metadata : name : legacy-app namespace : default spec : containers : - name : busybox # \u9700\u8981\u4fee\u6539 image : busybox # \u9700\u8981\u4fee\u6539 args : [ /bin/sh , -c , 'tail -n+1 -F /var/log/legacy-app.log' ] volumeMounts : - name : logs # \u9700\u8981\u4fee\u6539 mountPath : /var/log - args : - /bin/sh - -c - | i=0; while true; do echo \"$(date) INFO $i\" >> /var/log/legacy-app.log; i=$((i+1)); sleep 1; done image : busybox imagePullPolicy : Always name : count resources : {} terminationMessagePath : /dev/termination-log terminationMessagePolicy : File volumeMounts : # \u9700\u8981\u6dfb\u52a0 - name : logs mountPath : /var/log volumes : - name : logs # \u9700\u8981\u4fee\u6539 emptyDir : {} 11.RBAC\u8003\u9898 \u00b6 \u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/ \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a deployment-clusterrole \u7684 clusterrole\uff0c\u8be5 clusterrole \u53ea\u5141\u8bb8\u521b\u5efa Deployment\u3001 Daemonset\u3001Statefulset \u7684 create \u64cd\u4f5c\u5728\u540d\u5b57\u4e3a app-team1 \u7684 namespace \u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a cicd-token \u7684 serviceAccount\uff0c\u5e76\u4e14\u5c06\u4e0a\u4e00\u6b65\u521b\u5efa clusterrole \u7684\u6743\u9650\u7ed1\u5b9a\u5230\u8be5 serviceAccount \u89e3\u9898\u6b65\u9aa4: apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRole metadata : # \"namespace\" \u88ab\u5ffd\u7565\uff0c\u56e0\u4e3a ClusterRoles \u4e0d\u53d7\u540d\u5b57\u7a7a\u95f4\u9650\u5236 name : deployment-clusterrole rules : - apiGroups : [ \"apps\" ] # \u5728 HTTP \u5c42\u9762\uff0c\u7528\u6765\u8bbf\u95ee Secret \u8d44\u6e90\u7684\u540d\u79f0\u4e3a \"secrets\" resources : [ \"deployments\" , \"daemonsets\" , \"statefulsets\" ] verbs : [ \"create\" ] \u521b\u5efaserviceAccount: $ k create ns app-team1 $ k create sa cicd-token -n app-team1 $ k create rolebinding deployment-rolebinding \\ --clusterrole = 'deployment-clusterrole' \\ --serviceaccount = app-team1:cicd-token -n app-team1 12. NetworkPolicy \u00b6 \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a\u540d\u5b57\u4e3a allow-port-from-namespace \u7684 NetworkPolicy\uff0c\u8fd9\u4e2a NetworkPolicy \u5141\u8bb8internal \u547d\u540d\u7a7a\u95f4\u4e0b\u7684 Pod \u8bbf\u95ee\u8be5\u547d\u540d\u7a7a\u95f4\u4e0b\u7684 9000 \u7aef\u53e3\u3002\u5e76\u4e14\u4e0d\u5141\u8bb8\u4e0d\u662f internal \u547d\u4ee4\u7a7a\u95f4\u7684\u4e0b\u7684 Pod \u8bbf\u95ee\u4e0d\u5141\u8bb8\u8bbf\u95ee\u6ca1\u6709\u76d1\u542c 9000 \u7aef\u53e3\u7684 Pod\u3002 \u89e3\u9898\u6b65\u9aa4: $ cat 12-1-cka.yaml apiVersion : networking.k8s.io/v1 kind : NetworkPolicy metadata : name : allow-port-from-namespace namespace : internal spec : ingress : - from : - podSelector : {} ports : - port : 9000 protocol : TCP podSelector : {} policyTypes : - Ingress 13. PersistentVolume \u00b6 \u6587\u7ae0\u53c2\u8003: https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a pv\uff0c\u540d\u5b57\u4e3a app-config\uff0c\u5927\u5c0f\u4e3a 2Gi\uff0c\u8bbf\u95ee\u6743\u9650\u4e3a ReadWriteMany\u3002Volume \u7684\u7c7b\u578b\u4e3a hostPath\uff0c\u8def\u5f84\u4e3a/srv/app-config apiVersion : v1 kind : PersistentVolume metadata : name : app-config labels : type : local spec : storageClassName : manual capacity : storage : 2Gi accessModes : - ReadWriteMany hostPath : path : \"/srv/app-config\" 14. CSI & PersistentVolumeClaim \u00b6 \u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a\u540d\u5b57\u4e3a pv-volume \u7684 pvc\uff0c\u6307\u5b9a storageClass \u4e3a csi-hostpath-sc\uff0c\u5927\u5c0f\u4e3a 10Mi \u7136\u540e\u521b\u5efa\u4e00\u4e2a Pod\uff0c\u540d\u5b57\u4e3a web-server\uff0c\u955c\u50cf\u4e3a nginx\uff0c\u5e76\u4e14\u6302\u8f7d\u8be5 PVC \u81f3/usr/share/nginx/html\uff0c \u6302\u8f7d\u7684\u6743\u9650\u4e3a ReadWriteOnce\u3002\u4e4b\u540e\u901a\u8fc7 kubectl edit \u6216\u8005 kubectl path \u5c06 pvc \u6539\u6210 70Mi\uff0c\u5e76\u4e14\u8bb0\u5f55\u4fee\u6539\u8bb0\u5f55\u3002 \u51c6\u5907\u5de5\u4f5c: $ mkdir csi-hostpath $ cd csi-hostpath $ git clone https://gitee.com/dukuan/k8s-ha-install.git $ cd k8s-ha-install/ $ git checkout manual-installation-v1.20.x-csi-hostpath $ kubectl create -f snapshotter/ $ kubectl get volumesnapshotclasses.snapshot.storage.k8s.io $ kubectl get volumesnapshots.snapshot.storage.k8s.io $ kubectl get volumesnapshotcontents.snapshot.storage.k8s.io # \u5982\u679c\u8fd4\u56de\u503c\u4e0d\u662ferror: the server doesn't have a resource type \"volumesnapshotclasses\"\u8868\u793a\u5b89\u88c5\u6210\u529f # \u6709\u8fd4\u56de\u503c\u8bf4\u660eSnapshot Controller\u5df2\u7ecf\u5b89\u88c5 $ kubectl get pods --all-namespaces -o = jsonpath = '{range .items[*]}{\"\\n\"}{range .spec.containers[*]}{.image}{\", \"}{end}{end}' | grep snapshot-controller $ \u5b89\u88c5csi-hostpath $ cd csi-hostpath/ $ kubectl apply -f . $ \u521b\u5efastorageClass $ cd examples/ $ kubectl create -f csi-storageclass.yaml \u89e3\u9898\u6b65\u9aa4: \u521b\u5efa\u4e00\u4e2apvc apiVersion : v1 kind : PersistentVolumeClaim metadata : name : pv-volume spec : storageClassName : csi-hostpath-sc accessModes : - ReadWriteOnce resources : requests : storage : 10Mi \u521b\u5efa\u4e00\u4e2apod\u6302\u5728pvc apiVersion : v1 kind : Pod metadata : name : web-server spec : volumes : - name : pv-volume persistentVolumeClaim : claimName : pv-volume containers : - name : task-pv-container image : nginx ports : - containerPort : 80 name : \"http-server\" volumeMounts : - mountPath : \"/usr/share/nginx/html\" name : pv-volume kubectl patch pvc pv-volume -p '{\"spec\":{\"resources\":{\"requests\":{\"storage\": \"70Mi\"}}}}' --record 15. Etcd \u5907\u4efd\u6062\u590d \u00b6 \u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/ \u4e2d\u6587\u89e3\u91ca: \u9488\u5bf9 etcd \u5b9e\u4f8b https://127.0.0.1:2379 \u521b\u5efa\u4e00\u4e2a\u5feb\u7167\uff0c\u4fdd\u5b58\u5230/srv/data/etcd-snapshot.db\u3002 \u5728\u521b\u5efa\u5feb\u7167\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u5361\u4f4f\u4e86\uff0c\u5c31\u952e\u5165 ctrl+c \u7ec8\u6b62\uff0c\u7136\u540e\u91cd\u8bd5\u3002 \u7136\u540e\u6062\u590d\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u5feb\u7167\uff1a /var/lib/backup/etcd-snapshot-previous.db \u6267\u884c etcdctl \u547d\u4ee4\u7684\u8bc1\u4e66\u5b58\u653e\u5728\uff1a ca \u8bc1\u4e66\uff1a/opt/KUIN00601/ca.crt \u5ba2\u6237\u7aef\u8bc1\u4e66\uff1a/opt/KUIN00601/etcd-client.crt \u5ba2\u6237\u7aef\u5bc6\u94a5\uff1a/opt/KUIN00601/etcd-client.key \u89e3\u9898\u6b65\u9aa4: \u7ec3\u4e60\u65f6\u9700\u8981\u67e5\u770b\u8bc1\u4e66\u7684\u8def\u5f84: [ cka ] root@master0:/home/lixie# cat /etc/kubernetes/manifests/etcd.yaml apiVersion: v1 kind: Pod metadata: annotations: kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.159.81:2379 creationTimestamp: null labels: component: etcd tier: control-plane name: etcd namespace: kube-system spec: containers: - command: - etcd - --advertise-client-urls = https://192.168.159.81:2379 - --cert-file = /etc/kubernetes/pki/etcd/server.crt # \u6307\u5b9a crt \u6587\u4ef6 - --client-cert-auth = true - --data-dir = /var/lib/etcd - --initial-advertise-peer-urls = https://192.168.159.81:2380 - --initial-cluster = master0 = https://192.168.159.81:2380 - --key-file = /etc/kubernetes/pki/etcd/server.key # \u6307\u5b9a key \u6587\u4ef6 - --listen-client-urls = https://127.0.0.1:2379,https://192.168.159.81:2379 - --listen-metrics-urls = http://127.0.0.1:2381 - --listen-peer-urls = https://192.168.159.81:2380 - --name = master0 - --peer-cert-file = /etc/kubernetes/pki/etcd/peer.crt - --peer-client-cert-auth = true - --peer-key-file = /etc/kubernetes/pki/etcd/peer.key - --peer-trusted-ca-file = /etc/kubernetes/pki/etcd/ca.crt # \u6307\u5b9a\u8bc1\u4e66\u6587\u4ef6 - --snapshot-count = 10000 - --trusted-ca-file = /etc/kubernetes/pki/etcd/ca.crt \u8fd9\u4e2a\u8bc1\u4e66\u7684\u8def\u5f84\u6839\u636e\u9898\u76ee\u63d0\u4f9b\u7684\u5199\u5c31\u53ef\u4ee5\u4e86 \u5907\u4efd: apt install etcd-client export ETCDCTL_API = 3 mkdir /srv/data/ etcdctl --endpoints = https://127.0.0.1:2379 \\ --cacert = /etc/kubernetes/pki/etcd/ca.crt \\ --cert = /etc/kubernetes/pki/etcd/server.crt \\ --key = /etc/kubernetes/pki/etcd/server.key \\ snapshot save /srv/data/etcd-snapshot.db \u8fd8\u539f\u6570\u636e: \u914d\u7f6e\u6587\u4ef6\u53ef\u80fd\u4e0d\u5728\u539f\u6765\u7684\u4f4d\u7f6e,\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u7684\u65b9\u5f0f\u6765\u67e5\u627e \u6a21\u62df\u5220\u9664: (\u5220\u9664 pod \u8fd9\u6837 etcd \u7684\u6570\u636e\u5c31\u4f1a\u6ca1\u6709\u8fd9\u4e2a\u6570\u636e) \u6a21\u62df\u8fd8\u539f: mv /etc/kubernetes/manifests /etc/kubernetes/manifests.bak export ETCDCTL_API = 3 etcdctl --endpoints = https://127.0.0.1:2379 --cacert = /etc/kubernetes/pki/etcd/ca.crt --cert = /etc/kubernetes/pki/etcd/server.crt --key = /etc/kubernetes/pki/etcd/server.key snapshot restore /src/data/etcd-snapshot.db --data-dir = /var/lib/etcd-restore --skip-hash-check mv /etc/kubernetes/manifests.bak /etc/kubernetes/manifests systemctl restart kubelet 16. k8s \u5347\u7ea7 \u00b6 \u4e2d\u6587\u89e3\u91ca: \u4ec5\u9700\u8981\u5347\u7ea7 master \u8282\u70b9,\u548c kubelet,kubectl\u3002\u4e0d\u9700\u8981\u5347\u7ea7 etcd \u7b49\u5176\u4ed6\u7ec4\u4ef6 \u89e3\u9898\u6b65\u9aa4: $ k cordon master0 $ k drain master0 --delete-emptydir-data --ignore-daemonsets --force \u4e4b\u540e\u9700\u8981\u6309\u7167\u9898\u76ee\u63d0\u793a ssh \u5230\u4e00\u4e2a master \u8282\u70b9 $ apt update $ apt-cache policy kubeadm | grep 1 .19.0 # (\u6ce8\u610f\u7248\u672c\u7684\u5dee\u5f02\uff0c\u6709\u53ef\u80fd\u5e76\u975e 1.18.8 \u5347\u7ea7\u5230 1 .19 ) $ apt-get install kubeadm = 1 .19.0-00 # \u9a8c\u8bc1\u5347\u7ea7\u8ba1\u5212 $ kubeadm upgrade plan # \u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff0c\u53ef\u5347\u7ea7\u5230\u6307\u5b9a\u7248\u672c You can now apply the upgrade by executing the following command: kubeadm upgrade apply v1.19.0 \u5f00\u59cb\u5347\u7ea7 Master \u8282\u70b9 kubeadm upgrade apply v1.20.9 --etcd-upgrade = false # \u6ce8\u610f\u8fd9\u91cc\u4e0d\u9700\u8981\u5347\u7ea7 etcd \u5347\u7ea7kubelet\u548ckubectl apt-get install -y kubelet = 1 .19.0-00 kubectl = 1 .19.0-00 $ systemctl daemon-reload $ systemctl restart kubelet $ kubectl uncordon k8s-master 17. \u96c6\u7fa4\u6545\u969c\u6392\u67e5 \u2013 kubelet \u6545\u969c \u00b6 \u4e2d\u6587\u89e3\u91ca: \u4e00\u4e2a\u540d\u4e3a wk8s-node-0 \u7684\u8282\u70b9\u72b6\u6001\u4e3a NotReady\uff0c\u8ba9\u5176\u4ed6\u6062\u590d\u81f3\u6b63\u5e38\u72b6\u6001\uff0c\u5e76\u786e\u8ba4\u6240\u6709\u7684\u66f4\u6539\u5f00\u673a\u81ea\u52a8\u5b8c\u6210 $ ssh wk8s-node-0 $ sudo -i # systemctl status kubelet # systemctl start kubelet # systemctl enable kubelet \u53d8\u66f4\u9898: \u00b6 \u5982\u679cfubar\u6ca1\u6709\u6253\u6807\u7b7e\uff0c\u9700\u8981\u6253\u4e00\u4e2a\u6807\u7b7e $ cat network-policy.yaml apiVersion : networking.k8s.io/v1 kind : NetworkPolicy metadata : name : allow-port-from-namespace namespace : my-app spec : egress : - to : - namespaceSelector : matchLabels : name : fubar ports : - protocol : TCP port : 53 ingress : - from : - podSelector : {} ports : - protocol : TCP port : 80 podSelector : {} policyTypes : - Ingress - Egress","title":"kubernetes CKA\u8003\u9898"},{"location":"cks/cka/#cka","text":"","title":"cka \u8ba4\u8bc1\u8003\u8bd5"},{"location":"cks/cka/#1-pod-5","text":"\u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u76d1\u63a7\u540d\u4e3a foobar \u7684 Pod \u7684\u65e5\u5fd7\uff0c\u5e76\u8fc7\u6ee4\u51fa\u5177\u6709 unable-access-website \u4fe1\u606f\u7684\u884c\uff0c\u7136\u540e\u5c06\u5199\u5165\u5230 /opt/KUTR00101/foobar \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl logs foobar | grep unable-access-website > /opt/KUTR00101/foobar","title":"1. \u76d1\u63a7 pod\u65e5\u5fd7 5%"},{"location":"cks/cka/#2-pod-5","text":"\u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u627e\u51fa\u5177\u6709 name=cpu-user \u7684 Pod\uff0c\u5e76\u8fc7\u6ee4\u51fa\u4f7f\u7528 CPU \u6700\u9ad8\u7684 Pod\uff0c\u7136\u540e\u628a\u5b83\u7684\u540d\u5b57\u5199\u5728\u5df2\u7ecf\u5b58\u5728\u7684/opt/KUTR00401/KUTR00401.txt \u6587\u4ef6\u91cc \uff08\u6ce8\u610f\u4ed6\u6ca1\u6709\u8bf4\u6307\u5b9a namespace\u3002\u6240\u4ee5\u9700\u8981\u4f7f\u7528-A \u6307\u5b9a\u6240\u4ee5 namespace\uff09 \u6ce8\u610f\u662f \u8ffd\u52a0 \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl top pod -A -l | grep name = cpu-user # \u6ce8\u610f\u8fd9\u91cc\u7684 pod \u540d\u5b57\u4ee5\u5b9e\u9645\u540d\u5b57\u4e3a\u51c6\uff0c\u6309\u7167 CPU \u90a3\u4e00\u5217\u8fdb\u884c\u9009\u62e9\u4e00\u4e2a\u6700\u5927\u7684 Pod\uff0c\u53e6\u5916\u5982\u679c CPU \u7684\u6570\u503c\u662f 1 2 3 \u8fd9\u6837\u7684\u3002\u662f\u5927\u4e8e\u5e26 m \u8fd9\u6837\u7684\uff0c\u56e0\u4e3a 1 \u9897 CPU \u7b49\u4e8e 1000m\uff0c\u6ce8\u610f\u8981\u7528>>\u800c\u4e0d\u662f> $ echo \"coredns-54d67798b7-hl8xc\" >> /opt/KUTR00401/KUTR00401.txt","title":"2.\u76d1\u63a7 pod \u5ea6\u91cf \u6307\u6807: 5%"},{"location":"cks/cka/#3deployment","text":"\u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u6269\u5bb9\u540d\u5b57\u4e3a loadbalancer \u7684 deployment \u7684\u526f\u672c\u6570\u4e3a 6 \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl scale --replicas = 6 deployment loadbalancer $ kubectl edit","title":"3.Deployment \u6269\u7f29\u5bb9"},{"location":"cks/cka/#4-node","text":"\u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u68c0\u67e5\u96c6\u7fa4\u4e2d\u6709\u591a\u5c11\u8282\u70b9\u4e3a Ready \u72b6\u6001\uff0c\u5e76\u4e14\u53bb\u9664\u5305\u542b NoSchedule \u6c61\u70b9\u7684\u8282\u70b9\u3002\u4e4b\u540e\u5c06\u6570\u5b57\u5199\u5230/opt/KUSC00402/kusc00402.txt \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context k8s $ kubectl get node | grep -i ready # \u8bb0\u5f55\u603b\u6570\u4e3a A $ kubectl describe node | grep Taint | grep NoSchedule # \u8bb0\u5f55\u603b\u6570\u4e3a B # \u5c06 A \u51cf B \u7684\u503c x \u5bfc\u5165\u5230/opt/KUSC00402/kusc00402.txt $ echo x >> /opt/KUSC00402/kusc00402.txt","title":"4. \u68c0\u67e5 Node \u8282\u70b9\u7684\u5065\u5eb7\u72b6\u6001"},{"location":"cks/cka/#5","text":"\u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u5c06 ek8s-node-1 \u8282\u70b9\u8bbe\u7f6e\u4e3a\u4e0d\u53ef\u7528\uff0c\u7136\u540e\u91cd\u65b0\u8c03\u5ea6\u8be5\u8282\u70b9\u4e0a\u7684\u6240\u6709 Pod \u89e3\u9898\u6b65\u9aa4: $ kubectl config use-context ek8s $ kubectl cordon ek8s-node-1 $ kubectl drain ek8s-node-1 --delete-emptydir-data --ignore-daemonsets --force $ k delete pod pod-name --grace-period = 0 --force","title":"5. \u8282\u70b9\u7ef4\u62a4"},{"location":"cks/cka/#6","text":"\u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a Pod\uff0c\u540d\u5b57\u4e3a nginx-kusc00401\uff0c\u955c\u50cf\u5730\u5740\u662f nginx\uff0c\u8c03\u5ea6\u5230\u5177\u6709 disk=spinning \u6807\u7b7e\u7684\u8282\u70b9\u4e0a \uff0c \u8be5\u9898\u53ef\u4ee5\u53c2\u8003\u94fe\u63a5\uff1a https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/ \u8be5\u9898\u53ef\u4ee5\u53c2\u8003\u94fe\u63a5\uff1a https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/ \u89e3\u9898\u6b65\u9aa4: \u9898\u76ee\u4e00\uff1a apiVersion : v1 kind : Pod metadata : name : nginx-kusc00401 labels : role : nginx-kusc00401 spec : containers : - name : nginx image : nginx nodeSelector : disk : spinning \u9898\u76ee\u4e8c\uff1a $ cat 6-2-cka.yaml apiVersion : v1 kind : Pod metadata : name : nginx-kusc00402 labels : role : nginx-kusc00402 spec : nodeName : node1 containers : - name : nginx image : nginx","title":"6. \u6307\u5b9a\u8282\u70b9\u90e8\u7f72"},{"location":"cks/cka/#7-pod","text":"\u56fe\u793a\uff1a \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a Pod \uff0c \u540d\u5b57\u4e3a kucc1 \uff0c\u8fd9\u4e2a Pod \u53ef\u80fd\u5305\u542b 1-4 \u5bb9 \u5668 \uff0c \u8be5\u9898\u4e3a\u56db\u4e2a \uff1anginx+redis+memcached+consul \u89e3\u9898\u6b65\u9aa4: $ cat 7-cka.yaml apiVersion : v1 kind : Pod metadata : name : kucc1 spec : containers : - name : nginx image : nginx - name : redis image : redis - name : memcached image : memcached - name : consul image : consul","title":"7. \u4e00\u4e2a Pod \u591a\u4e2a\u5bb9\u5668"},{"location":"cks/cka/#8-service","text":"\u4e2d\u6587\u89e3\u91ca: \u91cd\u65b0\u914d\u7f6e\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684 deployment front-end\uff0c\u5728\u540d\u5b57\u4e3a nginx \u7684\u5bb9\u5668\u91cc\u9762\u6dfb\u52a0\u4e00\u4e2a\u7aef\u53e3\u914d\u7f6e\uff0c\u540d\u5b57\u4e3a http\uff0c\u66b4\u9732\u7aef\u53e3\u53f7\u4e3a 80\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a service\uff0c\u540d\u5b57\u4e3a front-end-svc\uff0c\u66b4\u9732\u8be5deployment \u7684 http \u7aef\u53e3\uff0c\u5e76\u4e14 service \u7684\u7c7b\u578b\u4e3a NodePort\u3002 ports : - containerPort : 80 name : http protocol : TCP \u521b\u5efa\u4e00\u4e2asvc kubectl expose deploy front-end --name = front-end-svc --port = 80 \\ --target-port = http --type = NodePort","title":"8. Service \u8003\u9898"},{"location":"cks/cka/#9-ingress-8","text":"\u53c2\u8003\u5730\u5740: https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/ \u56fe\u793a: \u73af\u5883\u51c6\u5907: [ cka ] root@master0:/home/lixie# k label node node1 ingress = true node/node1 labeled \u4e2d\u6587\u89e3\u91ca: \u5728 ing-internal \u547d\u540d\u7a7a\u95f4\u4e0b\u521b\u5efa\u4e00\u4e2a ingress\uff0c\u540d\u5b57\u4e3a pong\uff0c\u4ee3\u7406\u7684 service hi\uff0c\u7aef\u53e3\u4e3a 5678\uff0c\u914d\u7f6e\u8def\u5f84/hi\u3002 \u9a8c\u8bc1\uff1a\u8bbf\u95ee curl -kL /hi \u4f1a\u8fd4\u56de hi \u89e3\u9898\u6b65\u9aa4: $ k label node node2 ingress = true $ k apply -f ingress.yaml [ cka ] root@master0:~/cka# cat 9-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : pong # \u540d\u79f0\u9700\u8981\u8be5 namespace : ing-internal # \u9700\u8981\u8be5 spec : ingressClassName : nginx rules : - http : paths : - pathType : Prefix path : \"/hi\" # \u8bbf\u95ee\u8def\u5f84\u9700\u8981\u6539 backend : service : name : front-end-svc # \u9700\u8981\u8be5 port : number : 80","title":"9. Ingress\u8003\u9898 8%"},{"location":"cks/cka/#10-sidecar-8","text":"\u56fe\u793a: \u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/ \u4e2d\u6587\u89e3\u91ca: \u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a busybox \u4e14\u955c\u50cf\u4e3a busybox \u7684 sidecar \u5230\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u540d\u4e3a legacy-app \u7684 Pod \u4e0a\uff0c\u8fd9\u4e2a sidecar \u7684\u542f\u52a8\u547d\u4ee4\u4e3a/bin/sh, -c, 'tail -n+1 -f /var/log/legacy-app.log'\u3002 \u5e76\u4e14\u8fd9\u4e2a sidecar \u548c\u539f\u6709\u7684\u955c\u50cf\u6302\u8f7d\u4e00\u4e2a\u540d\u4e3a logs \u7684 volume\uff0c\u6302\u8f7d\u7684\u76ee\u5f55\u4e3a/var/log/ \u5bfc\u51fayaml [ cka ] root@master0:~/cka# cat 10-1.yaml apiVersion : v1 kind : Pod metadata : name : legacy-app spec : containers : - name : count image : busybox args : - /bin/sh - -c - > i=0; while true; do echo \"$(date) INFO $i\" >> /var/log/legacy-app.log; i=$((i+1)); sleep 1; done \u9996\u5148\u5c06 legacy-app \u7684 Pod \u7684 yaml \u5bfc\u51fa\uff0c\u5927\u81f4\u5982\u4e0b\uff1a kubectl get pod legacy-app -o yaml > 10-2.yaml \u8fdb\u884c\u4fee\u6539 [ cka ] root@master0:~/cka# cat 10-2.yaml apiVersion : v1 kind : Pod metadata : name : legacy-app namespace : default spec : containers : - name : busybox # \u9700\u8981\u4fee\u6539 image : busybox # \u9700\u8981\u4fee\u6539 args : [ /bin/sh , -c , 'tail -n+1 -F /var/log/legacy-app.log' ] volumeMounts : - name : logs # \u9700\u8981\u4fee\u6539 mountPath : /var/log - args : - /bin/sh - -c - | i=0; while true; do echo \"$(date) INFO $i\" >> /var/log/legacy-app.log; i=$((i+1)); sleep 1; done image : busybox imagePullPolicy : Always name : count resources : {} terminationMessagePath : /dev/termination-log terminationMessagePolicy : File volumeMounts : # \u9700\u8981\u6dfb\u52a0 - name : logs mountPath : /var/log volumes : - name : logs # \u9700\u8981\u4fee\u6539 emptyDir : {}","title":"10. Sidecar 8%"},{"location":"cks/cka/#11rbac","text":"\u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/ \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a deployment-clusterrole \u7684 clusterrole\uff0c\u8be5 clusterrole \u53ea\u5141\u8bb8\u521b\u5efa Deployment\u3001 Daemonset\u3001Statefulset \u7684 create \u64cd\u4f5c\u5728\u540d\u5b57\u4e3a app-team1 \u7684 namespace \u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a cicd-token \u7684 serviceAccount\uff0c\u5e76\u4e14\u5c06\u4e0a\u4e00\u6b65\u521b\u5efa clusterrole \u7684\u6743\u9650\u7ed1\u5b9a\u5230\u8be5 serviceAccount \u89e3\u9898\u6b65\u9aa4: apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRole metadata : # \"namespace\" \u88ab\u5ffd\u7565\uff0c\u56e0\u4e3a ClusterRoles \u4e0d\u53d7\u540d\u5b57\u7a7a\u95f4\u9650\u5236 name : deployment-clusterrole rules : - apiGroups : [ \"apps\" ] # \u5728 HTTP \u5c42\u9762\uff0c\u7528\u6765\u8bbf\u95ee Secret \u8d44\u6e90\u7684\u540d\u79f0\u4e3a \"secrets\" resources : [ \"deployments\" , \"daemonsets\" , \"statefulsets\" ] verbs : [ \"create\" ] \u521b\u5efaserviceAccount: $ k create ns app-team1 $ k create sa cicd-token -n app-team1 $ k create rolebinding deployment-rolebinding \\ --clusterrole = 'deployment-clusterrole' \\ --serviceaccount = app-team1:cicd-token -n app-team1","title":"11.RBAC\u8003\u9898"},{"location":"cks/cka/#12-networkpolicy","text":"\u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a\u540d\u5b57\u4e3a allow-port-from-namespace \u7684 NetworkPolicy\uff0c\u8fd9\u4e2a NetworkPolicy \u5141\u8bb8internal \u547d\u540d\u7a7a\u95f4\u4e0b\u7684 Pod \u8bbf\u95ee\u8be5\u547d\u540d\u7a7a\u95f4\u4e0b\u7684 9000 \u7aef\u53e3\u3002\u5e76\u4e14\u4e0d\u5141\u8bb8\u4e0d\u662f internal \u547d\u4ee4\u7a7a\u95f4\u7684\u4e0b\u7684 Pod \u8bbf\u95ee\u4e0d\u5141\u8bb8\u8bbf\u95ee\u6ca1\u6709\u76d1\u542c 9000 \u7aef\u53e3\u7684 Pod\u3002 \u89e3\u9898\u6b65\u9aa4: $ cat 12-1-cka.yaml apiVersion : networking.k8s.io/v1 kind : NetworkPolicy metadata : name : allow-port-from-namespace namespace : internal spec : ingress : - from : - podSelector : {} ports : - port : 9000 protocol : TCP podSelector : {} policyTypes : - Ingress","title":"12. NetworkPolicy"},{"location":"cks/cka/#13-persistentvolume","text":"\u6587\u7ae0\u53c2\u8003: https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a pv\uff0c\u540d\u5b57\u4e3a app-config\uff0c\u5927\u5c0f\u4e3a 2Gi\uff0c\u8bbf\u95ee\u6743\u9650\u4e3a ReadWriteMany\u3002Volume \u7684\u7c7b\u578b\u4e3a hostPath\uff0c\u8def\u5f84\u4e3a/srv/app-config apiVersion : v1 kind : PersistentVolume metadata : name : app-config labels : type : local spec : storageClassName : manual capacity : storage : 2Gi accessModes : - ReadWriteMany hostPath : path : \"/srv/app-config\"","title":"13. PersistentVolume"},{"location":"cks/cka/#14-csi-persistentvolumeclaim","text":"\u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ \u56fe\u793a: \u4e2d\u6587\u89e3\u91ca: \u521b\u5efa\u4e00\u4e2a\u540d\u5b57\u4e3a pv-volume \u7684 pvc\uff0c\u6307\u5b9a storageClass \u4e3a csi-hostpath-sc\uff0c\u5927\u5c0f\u4e3a 10Mi \u7136\u540e\u521b\u5efa\u4e00\u4e2a Pod\uff0c\u540d\u5b57\u4e3a web-server\uff0c\u955c\u50cf\u4e3a nginx\uff0c\u5e76\u4e14\u6302\u8f7d\u8be5 PVC \u81f3/usr/share/nginx/html\uff0c \u6302\u8f7d\u7684\u6743\u9650\u4e3a ReadWriteOnce\u3002\u4e4b\u540e\u901a\u8fc7 kubectl edit \u6216\u8005 kubectl path \u5c06 pvc \u6539\u6210 70Mi\uff0c\u5e76\u4e14\u8bb0\u5f55\u4fee\u6539\u8bb0\u5f55\u3002 \u51c6\u5907\u5de5\u4f5c: $ mkdir csi-hostpath $ cd csi-hostpath $ git clone https://gitee.com/dukuan/k8s-ha-install.git $ cd k8s-ha-install/ $ git checkout manual-installation-v1.20.x-csi-hostpath $ kubectl create -f snapshotter/ $ kubectl get volumesnapshotclasses.snapshot.storage.k8s.io $ kubectl get volumesnapshots.snapshot.storage.k8s.io $ kubectl get volumesnapshotcontents.snapshot.storage.k8s.io # \u5982\u679c\u8fd4\u56de\u503c\u4e0d\u662ferror: the server doesn't have a resource type \"volumesnapshotclasses\"\u8868\u793a\u5b89\u88c5\u6210\u529f # \u6709\u8fd4\u56de\u503c\u8bf4\u660eSnapshot Controller\u5df2\u7ecf\u5b89\u88c5 $ kubectl get pods --all-namespaces -o = jsonpath = '{range .items[*]}{\"\\n\"}{range .spec.containers[*]}{.image}{\", \"}{end}{end}' | grep snapshot-controller $ \u5b89\u88c5csi-hostpath $ cd csi-hostpath/ $ kubectl apply -f . $ \u521b\u5efastorageClass $ cd examples/ $ kubectl create -f csi-storageclass.yaml \u89e3\u9898\u6b65\u9aa4: \u521b\u5efa\u4e00\u4e2apvc apiVersion : v1 kind : PersistentVolumeClaim metadata : name : pv-volume spec : storageClassName : csi-hostpath-sc accessModes : - ReadWriteOnce resources : requests : storage : 10Mi \u521b\u5efa\u4e00\u4e2apod\u6302\u5728pvc apiVersion : v1 kind : Pod metadata : name : web-server spec : volumes : - name : pv-volume persistentVolumeClaim : claimName : pv-volume containers : - name : task-pv-container image : nginx ports : - containerPort : 80 name : \"http-server\" volumeMounts : - mountPath : \"/usr/share/nginx/html\" name : pv-volume kubectl patch pvc pv-volume -p '{\"spec\":{\"resources\":{\"requests\":{\"storage\": \"70Mi\"}}}}' --record","title":"14. CSI &amp; PersistentVolumeClaim"},{"location":"cks/cka/#15-etcd","text":"\u6587\u7ae0\u53c2\u8003: https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/ \u4e2d\u6587\u89e3\u91ca: \u9488\u5bf9 etcd \u5b9e\u4f8b https://127.0.0.1:2379 \u521b\u5efa\u4e00\u4e2a\u5feb\u7167\uff0c\u4fdd\u5b58\u5230/srv/data/etcd-snapshot.db\u3002 \u5728\u521b\u5efa\u5feb\u7167\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u5361\u4f4f\u4e86\uff0c\u5c31\u952e\u5165 ctrl+c \u7ec8\u6b62\uff0c\u7136\u540e\u91cd\u8bd5\u3002 \u7136\u540e\u6062\u590d\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u5feb\u7167\uff1a /var/lib/backup/etcd-snapshot-previous.db \u6267\u884c etcdctl \u547d\u4ee4\u7684\u8bc1\u4e66\u5b58\u653e\u5728\uff1a ca \u8bc1\u4e66\uff1a/opt/KUIN00601/ca.crt \u5ba2\u6237\u7aef\u8bc1\u4e66\uff1a/opt/KUIN00601/etcd-client.crt \u5ba2\u6237\u7aef\u5bc6\u94a5\uff1a/opt/KUIN00601/etcd-client.key \u89e3\u9898\u6b65\u9aa4: \u7ec3\u4e60\u65f6\u9700\u8981\u67e5\u770b\u8bc1\u4e66\u7684\u8def\u5f84: [ cka ] root@master0:/home/lixie# cat /etc/kubernetes/manifests/etcd.yaml apiVersion: v1 kind: Pod metadata: annotations: kubeadm.kubernetes.io/etcd.advertise-client-urls: https://192.168.159.81:2379 creationTimestamp: null labels: component: etcd tier: control-plane name: etcd namespace: kube-system spec: containers: - command: - etcd - --advertise-client-urls = https://192.168.159.81:2379 - --cert-file = /etc/kubernetes/pki/etcd/server.crt # \u6307\u5b9a crt \u6587\u4ef6 - --client-cert-auth = true - --data-dir = /var/lib/etcd - --initial-advertise-peer-urls = https://192.168.159.81:2380 - --initial-cluster = master0 = https://192.168.159.81:2380 - --key-file = /etc/kubernetes/pki/etcd/server.key # \u6307\u5b9a key \u6587\u4ef6 - --listen-client-urls = https://127.0.0.1:2379,https://192.168.159.81:2379 - --listen-metrics-urls = http://127.0.0.1:2381 - --listen-peer-urls = https://192.168.159.81:2380 - --name = master0 - --peer-cert-file = /etc/kubernetes/pki/etcd/peer.crt - --peer-client-cert-auth = true - --peer-key-file = /etc/kubernetes/pki/etcd/peer.key - --peer-trusted-ca-file = /etc/kubernetes/pki/etcd/ca.crt # \u6307\u5b9a\u8bc1\u4e66\u6587\u4ef6 - --snapshot-count = 10000 - --trusted-ca-file = /etc/kubernetes/pki/etcd/ca.crt \u8fd9\u4e2a\u8bc1\u4e66\u7684\u8def\u5f84\u6839\u636e\u9898\u76ee\u63d0\u4f9b\u7684\u5199\u5c31\u53ef\u4ee5\u4e86 \u5907\u4efd: apt install etcd-client export ETCDCTL_API = 3 mkdir /srv/data/ etcdctl --endpoints = https://127.0.0.1:2379 \\ --cacert = /etc/kubernetes/pki/etcd/ca.crt \\ --cert = /etc/kubernetes/pki/etcd/server.crt \\ --key = /etc/kubernetes/pki/etcd/server.key \\ snapshot save /srv/data/etcd-snapshot.db \u8fd8\u539f\u6570\u636e: \u914d\u7f6e\u6587\u4ef6\u53ef\u80fd\u4e0d\u5728\u539f\u6765\u7684\u4f4d\u7f6e,\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u7684\u65b9\u5f0f\u6765\u67e5\u627e \u6a21\u62df\u5220\u9664: (\u5220\u9664 pod \u8fd9\u6837 etcd \u7684\u6570\u636e\u5c31\u4f1a\u6ca1\u6709\u8fd9\u4e2a\u6570\u636e) \u6a21\u62df\u8fd8\u539f: mv /etc/kubernetes/manifests /etc/kubernetes/manifests.bak export ETCDCTL_API = 3 etcdctl --endpoints = https://127.0.0.1:2379 --cacert = /etc/kubernetes/pki/etcd/ca.crt --cert = /etc/kubernetes/pki/etcd/server.crt --key = /etc/kubernetes/pki/etcd/server.key snapshot restore /src/data/etcd-snapshot.db --data-dir = /var/lib/etcd-restore --skip-hash-check mv /etc/kubernetes/manifests.bak /etc/kubernetes/manifests systemctl restart kubelet","title":"15. Etcd \u5907\u4efd\u6062\u590d"},{"location":"cks/cka/#16-k8s","text":"\u4e2d\u6587\u89e3\u91ca: \u4ec5\u9700\u8981\u5347\u7ea7 master \u8282\u70b9,\u548c kubelet,kubectl\u3002\u4e0d\u9700\u8981\u5347\u7ea7 etcd \u7b49\u5176\u4ed6\u7ec4\u4ef6 \u89e3\u9898\u6b65\u9aa4: $ k cordon master0 $ k drain master0 --delete-emptydir-data --ignore-daemonsets --force \u4e4b\u540e\u9700\u8981\u6309\u7167\u9898\u76ee\u63d0\u793a ssh \u5230\u4e00\u4e2a master \u8282\u70b9 $ apt update $ apt-cache policy kubeadm | grep 1 .19.0 # (\u6ce8\u610f\u7248\u672c\u7684\u5dee\u5f02\uff0c\u6709\u53ef\u80fd\u5e76\u975e 1.18.8 \u5347\u7ea7\u5230 1 .19 ) $ apt-get install kubeadm = 1 .19.0-00 # \u9a8c\u8bc1\u5347\u7ea7\u8ba1\u5212 $ kubeadm upgrade plan # \u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff0c\u53ef\u5347\u7ea7\u5230\u6307\u5b9a\u7248\u672c You can now apply the upgrade by executing the following command: kubeadm upgrade apply v1.19.0 \u5f00\u59cb\u5347\u7ea7 Master \u8282\u70b9 kubeadm upgrade apply v1.20.9 --etcd-upgrade = false # \u6ce8\u610f\u8fd9\u91cc\u4e0d\u9700\u8981\u5347\u7ea7 etcd \u5347\u7ea7kubelet\u548ckubectl apt-get install -y kubelet = 1 .19.0-00 kubectl = 1 .19.0-00 $ systemctl daemon-reload $ systemctl restart kubelet $ kubectl uncordon k8s-master","title":"16. k8s \u5347\u7ea7"},{"location":"cks/cka/#17-kubelet","text":"\u4e2d\u6587\u89e3\u91ca: \u4e00\u4e2a\u540d\u4e3a wk8s-node-0 \u7684\u8282\u70b9\u72b6\u6001\u4e3a NotReady\uff0c\u8ba9\u5176\u4ed6\u6062\u590d\u81f3\u6b63\u5e38\u72b6\u6001\uff0c\u5e76\u786e\u8ba4\u6240\u6709\u7684\u66f4\u6539\u5f00\u673a\u81ea\u52a8\u5b8c\u6210 $ ssh wk8s-node-0 $ sudo -i # systemctl status kubelet # systemctl start kubelet # systemctl enable kubelet","title":"17. \u96c6\u7fa4\u6545\u969c\u6392\u67e5 \u2013 kubelet \u6545\u969c"},{"location":"cks/cka/#_1","text":"\u5982\u679cfubar\u6ca1\u6709\u6253\u6807\u7b7e\uff0c\u9700\u8981\u6253\u4e00\u4e2a\u6807\u7b7e $ cat network-policy.yaml apiVersion : networking.k8s.io/v1 kind : NetworkPolicy metadata : name : allow-port-from-namespace namespace : my-app spec : egress : - to : - namespaceSelector : matchLabels : name : fubar ports : - protocol : TCP port : 53 ingress : - from : - podSelector : {} ports : - protocol : TCP port : 80 podSelector : {} policyTypes : - Ingress - Egress","title":"\u53d8\u66f4\u9898:"},{"location":"cks/cks/","text":"CKS\u8003\u9898 \u00b6 \u8003\u9898\u4e00\uff1a\u5bb9\u5668\u8fd0\u884c\u65f6\uff08runtimeclass \u8003\u9898\uff09 \u00b6 1.1.1 \u8003\u9898 \u00b6 1.1.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 gvisor\u5b98\u7f51\uff1a https://gvisor.dev/docs/user_guide/install/ \u9996\u5148\uff0c\u5fc5\u987b\u5b89\u88c5\u9002\u5f53\u7684\u4f9d\u8d56\u9879\u4ee5\u5141\u8bb8 apt \u901a\u8fc7 https \u5b89\u88c5\u8f6f\u4ef6\u5305 sudo apt-get update && \\ sudo apt-get install -y \\ apt-transport-https \\ ca-certificates \\ curl \\ gnupg \u63a5\u4e0b\u6765\uff0c\u914d\u7f6e\u7528\u4e8e\u7b7e\u7f72\u6863\u6848\u548c\u5b58\u50a8\u5e93\u7684\u5bc6\u94a5 curl -fsSL https://gvisor.dev/archive.key | sudo gpg --dearmor -o /usr/share/keyrings/gvisor-archive-keyring.gpg echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] https://storage.googleapis.com/gvisor/releases release main\" | sudo tee /etc/apt/sources.list.d/gvisor.list > /dev/null \u73b0\u5728\u53ef\u4ee5\u5b89\u88c5runsc\u5305\u4e86 sudo apt-get update && sudo apt-get install -y runsc \u914d\u7f6econtainerd [mac] root@cpu-1:/home/lixie# vim /etc/containerd/config.toml [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runsc] runtime_type = \"io.containerd.runsc.v1\" [mac] root@cpu-1:/home/lixie# systemctl daemon-reload && systemctl restart containerd 5. \u521b\u5efa\u4e00\u4e2apod $ kubectl create ns client namespace/client created $ kubectl run nginx --image=nginx -n client pod/nginx created 1.1.3 \u8003\u9898\u89e3\u7b54 \u00b6 \u53c2\u8003\u5730\u5740 https://kubernetes.io/zh-cn/docs/concepts/containers/runtime-class/ \u521b\u5efa RuntimeClass \u8d44\u6e90 \u00b6 # RuntimeClass \u5b9a\u4e49\u4e8e node.k8s.io API \u7ec4 apiVersion : node.k8s.io/v1 kind : RuntimeClass metadata : # RuntimeClass \u662f\u4e00\u4e2a\u96c6\u7fa4\u5c42\u9762\u7684\u8d44\u6e90 name : untrusted # \u7528\u6765\u5f15\u7528 RuntimeClass \u7684\u540d\u5b57 handler : runsc # \u5bf9\u5e94\u7684 CRI \u914d\u7f6e\u7684\u540d\u79f0 \u6dfb\u52a0 runtimeClassName \u00b6 apiVersion : v1 kind : Pod metadata : name : mypod spec : runtimeClassName : untrusted # \u6ce8\u610f\u8fd9\u4e2auntrusted \u540d\u79f0 # ... kubectl get po nginx -n client -oyaml > nginx.yaml kubectl delete -f nginx.yaml ; kubectl create -f nginx.yaml 2022-01 \u8003\u9898\u66f4\u65b0 \u00b6 apiVersion: apps/v1 kind: Deployment metadata: name: jfs-app labels: app: nginx spec: replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: runtimeClassName: untrusted # \u6ce8\u610f\u66f4\u6539\u4e4b\u540e\u7684\u4f4d\u7f6e containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent \u8003\u9898\u4e8c\uff1aServiceAccount\u8003\u9898 \u00b6 \u53c2\u8003\u5730\u5740 https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/ 1.2.1 \u8003\u9898 \u00b6 1.2.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 k create ns prod kubectl run backend -n prod --image=nginx --dry-run=client -oyaml > pod-manifests.yaml 1.2.3 \u8003\u9898\u89e3\u7b54 \u00b6 \u5b98\u65b9\u6587\u6863\uff1a https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/ kubectl create sa backend-sa -n prod --dry-run=client -oyaml > sa.yaml apiVersion : v1 kind : ServiceAccount metadata : creationTimestamp : null name : backend-sa namespace : prod automountServiceAccountToken : false # \u4e0d\u6302\u8f7d API \u51ed\u636e \u521b\u5efa\u4e00\u4e2apod\uff0c\u5e76\u6302\u5728serviceAccount apiVersion : v1 kind : Pod metadata : creationTimestamp : null labels : run : backend name : backend namespace : prod spec : serviceAccountName : backend-sa # \u6302\u8f7dsa containers : - image : nginx name : backend resources : {} dnsPolicy : ClusterFirst restartPolicy : Always status : {} - \u5220\u9664prod\u4e0b\u5176\u4ed6\u6ca1\u6709\u4f7f\u7528\u7684sa kubectl delete sa default -n prod \u8003\u9898\u4e09\uff1akube-bench \u8003\u9898 \u00b6 Kube-Bench\u662f\u4e00\u4e2a\u7528\u4e8e\u68c0\u67e5\u548c\u8bc4\u4f30Kubernetes\u96c6\u7fa4\u5b89\u5168\u6027\u7684\u5f00\u6e90\u5de5\u5177\u3002\u5b83\u901a\u8fc7\u6267\u884c\u4e00\u7cfb\u5217\u7684\u5b89\u5168\u68c0\u67e5\u6765\u8bc4\u4f30Kubernetes\u96c6\u7fa4\u7684\u5b89\u5168\u6027\u914d\u7f6e\uff0c\u5e76\u63d0\u4f9b\u76f8\u5e94\u7684\u5efa\u8bae\u548c\u6307\u5bfc\u6765\u6539\u5584\u5b89\u5168\u6027\u3002 1.3.1 \u8003\u9898 \u00b6 1.3.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 [mac] vim /etc/kubernetes/manifests/kube-apiserver.yaml - --authorization-mode=AlwaysAllow - --enable-bootstrap-token-auth=false [mac] vim /var/lib/kubelet/config.yaml apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: true webhook: cacheTTL: 0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.crt authorization: mode: AlwaysAllow vim /etc/kubernetes/manifests/etcd.yaml - --client-cert-auth=false \u5b89\u88c5 kube-bench\uff1a wget https://github.com/aquasecurity/kube-bench/releases/download/v0.6.15/kube-bench_0.6.15_linux_amd64.deb dpkg -i kube-bench_0.6.15_linux_amd64.deb kube-bench kube-bench master # \u53ea\u68c0\u67e5master\u8282\u70b9 1.3.3 \u8003\u9898\u89e3\u7b54 \u00b6 ssh \u5230\u5bf9\u5e94\u7684\u8282\u70b9\u4e0a\u4fee\u6539 kube-apiserver \u914d\u7f6e\uff1a vim /etc/kubernetes/manifests/kube-apiserver.yaml - --authorization-mode=Node,RBAC \u4fee\u6539etcd vim /etc/kubernetes/manifests/etcd.yaml - --client-cert-auth=true \u4fee\u6539kubelet [mac] vim /var/lib/kubelet/config.yaml apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false # \u6539\u4e3afalse webhook: cacheTTL: 0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.crt authorization: mode: Webhook # \u6539\u4e3aWebhook \u4fee\u6539\u5b8c\u6210\u9000\u51fa\uff0c\u4fee\u6539node\u8282\u70b9 systemctl daemon-reload && systemctl restart kubelet \u8003\u9898\u56db. NetworkPolicy \u8003\u9898-\u9ed8\u8ba4\u62d2\u7edd\u6240\u6709ingress\u6d41\u91cf \u00b6 \u53c2\u8003\u5730\u5740 https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/ 1.4.1 \u8003\u9898 \u00b6 1.4.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 1.4.3 \u8003\u9898\u89e3\u7b54 \u00b6 apiVersion : networking.k8s.io/v1 kind : NetworkPolicy metadata : name : defaultdeny # \u540d\u79f0\u53ef\u80fd\u4e0d\u4e00\u6837 spec : podSelector : {} policyTypes : - Ingress k apply -f network-policy.yaml -n production \u8003\u9898\u4e94\uff1aTLS\u901a\u4fe1\u914d\u7f6e \u00b6 \u53c2\u6570\u5730\u5740 https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/ 1.5.1 \u8003\u9898 \u00b6 \u6587\u7ae0\u53c2\u8003\uff1ahttps://www.hao.kim/1112.html \u4fee\u6539API server\u548cetcd\u4e4b\u95f4\u901a\u4fe1\u7684TLS\u914d\u7f6e kube-apiserver\u9664\u4e86 TLS 1.3 \u53ca\u4ee5\u4e0a\u7684\u7248\u672c\u53ef\u4ee5\u4f7f\u7528\uff0c\u5176\u4ed6\u7248\u672c\u90fd\u4e0d\u5141\u8bb8\u4f7f\u7528\u3002 \u5bc6\u7801\u5957\u4ef6\uff08Cipher suite\uff09\u4e3a TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 1.5.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 1.5.3 \u8003\u9898\u89e3\u7b54 \u00b6 \u767b\u5f55\u5230master\u8282\u70b9\uff1a [mac] root@cpu-4:~# vim /etc/kubernetes/manifests/kube-apiserver.yaml - --tls-min-version=VersionTLS13 - --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 [mac] root@cpu-4:~# vim /etc/kubernetes/manifests/etcd.yaml - --cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 systemctl daemon-reload && systemctl restart kubelet \u8003\u9898\u516d. RBAC \u8003\u9898 \u00b6 1.6.1 \u8003\u9898 \u00b6 1.6.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 kubectl create ns monitoring kubectl create sa service-account-web -n monitoring \u521b\u5efa Role\uff1a $ cat role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: monitoring name: web-role rules: - apiGroups: [\"\"] # \"\" \u6807\u660e core API \u7ec4 resources: [\"pods\"] verbs: [\"get\", \"watch\", \"list\"] kubectl create -f role.yaml \u6388\u6743\uff1a kubectl create rolebinding pod-get --role=web-role --serviceaccount=monitoring:service-account-web -n monitoring \u521b\u5efa Pod\uff1a vim pod-rbac.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: dev-pod name: dev-pod namespace: monitoring spec: serviceAccountName: service-account-web containers: - image: nginx name: dev-pod resources: {} dnsPolicy: ClusterFirst restartPolicy: Always # kubectl create -f pod-rbac.yaml 1.6.3 \u8003\u9898\u89e3\u7b54 \u00b6 kubectl get po -n monitoring dev-pod -oyaml | grep serviceAccountName kubectl get rolebinding -n monitoring -oyaml |grep service-account-web -B 5 $ k edit role web-role -n monitoring # \u5220\u9664\u5176\u4ed6\u6743\u9650\u53ea\u7559get k apply -f role-sts-update.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: monitoring name: role-2 rules: - apiGroups: [\"extensions\",\"apps\"] resources: [\"statefulsets\"] verbs: [\"update\"] kubectl create rolebinding role-2-binding --role=role-2 --serviceaccount=monitoring:service-account-web -n monitoring \u53d8\u5f97\u9898\u578b \u00b6 \u8003\u9898 \u00b6 \u7f16\u8f91\u7ed1\u5b9a\u5230pod\u7684 serviceaccount test-sa-3\u7684\u73b0\u6709role\uff0c\u4ec5\u5141\u8bb8\u53ea\u5bf9endpoints\u7c7b\u578b\u7684resources\u6267\u884cget\u64cd\u4f5c \u5728namespace monitoring\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3arole-2\uff0c\u5e76\u4ec5\u5141\u8bb8\u6267\u884cdelete\u64cd\u4f5c\u7684\u65b0role \u521b\u5efa\u4e00\u4e2a\u540d\u4e3arole-2-binding\u7684\u65b0\u7684rolebing\uff0c\u5c06role-2\u7ed1\u5b9a\u9053Pod\u7ed1\u5b9a\u7684serviceaccount \u4e0a \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 k create deploy nginx --image=nginx -n monitoring --dry-run=client -oyaml > role-new.yaml k create sa test-sa-3 -n monitoring apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: nginx name: nginx namespace: monitoring spec: replicas: 1 selector: matchLabels: app: nginx strategy: {} template: metadata: creationTimestamp: null labels: app: nginx spec: serviceAccountName: test-sa-3 # \u6dfb\u52a0serviceAccountName containers: - image: nginx name: nginx resources: {} status: {} kubectl create role web-role --verb=create --resource=deployments -n monitoring kubectl create rolebinding web-role-binding --role=web-role --serviceaccount=monitoring:test-sa-3 -n monitoring \u89e3\u9898 \u00b6 \u67e5\u627e\u7ed1\u5b9a\u7684Role\uff08\u53ef\u80fd\u6ca1\u6709\u8fd9\u4e2arolebinding\uff0c\u6ca1\u6709\u7684\u8bdd\u76f4\u63a5edit test-sa-3\uff09 k get rolebinding -n monitoring -oyaml |grep test-sa-3 -B 5 k edit role web-role -n monitoring - apiGroups: - '' # \u4fee\u6539\u4e3a\u7a7a resources: - endpoints # \u4fee\u6539 verbs: - get # \u4fee\u6539 k create role role-2 --verb=delete --resource=namespaces -n monitoring k create rolebinding role-2-binding --role=role-2 --serviceaccount=monitoring:test-sa-3 -n monitoring 7. \u5ba1\u8ba1\u65e5\u5fd7 \u8003\u9898 \u00b6 \u5b98\u65b9\u6587\u6863\uff1ahttps://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/ 1.7.1 \u8003\u9898 \u00b6 1.7.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883 \u00b6 \u521b\u5efa\u5ba1\u8ba1\u65e5\u5fd7\u89c4\u5219\uff08\u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684 master \u8282\u70b9\uff09\uff1a mkdir -p /etc/kubernetes/logpolicy/ /var/log/kubernetes/ # \u6b64\u6b65\u8003\u8bd5\u4e0d\u7528\u6267\u884c 1.7.3 \u8003\u9898\u89e3\u7b54 \u00b6 cat /etc/kubernetes/logpolicy/sample-policy.yaml apiVersion : audit.k8s.io/v1 # This is required. kind : Policy omitStages : - \"RequestReceived\" rules : - level : RequestResponse resources : - group : \"\" resources : [ \"cronjobs\" ] - level : Request resources : - group : \"\" resources : [ \"persistendvolumes\" ] namespaces : [ \"front-apps\" ] - level : Metadata resources : - group : \"\" # core API group resources : [ \"secrets\" , \"configmaps\" ] - level : Metadata omitStages : - \"RequestReceived\" vim /etc/kubernetes/manifests/kube-apiserver.yaml - --audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml - --audit-log-path=/var/log/kubernetes/kubernetes-logs.txt - --audit-log-maxage=30 - --audit-log-maxbackup=10 \u8003\u8bd5\u73af\u5883\uff1a\u5df2\u7ecfmount - mountPath: /var/log/kubernetes name: kubernetes-logs - mountPath: /etc/kubernetes/logpolicy name: kubernetes-policy name: kubernetes-policy hostNetwork: true priorityClassName: system-node-critical volumes: - hostPath: path: /etc/kubernetes/logpolicy name: kubernetes-policy - hostPath: path: /var/log/kubernetes name: kubernetes-logs systemctl daemon-reload systemctl restart kubelet \u9898\u76ee\u53d8\u66f4\uff1a \u00b6 \u539f\u9898\u7684\u7b2c\u4e00\u4e2a\u7b56\u7565\u53d8\u6210\u4e86\uff1aRequestResponse\u7ea7\u522b\u7684nodes\u66f4\u6539 \u7b2c\u4e8c\u4e2a\u7b56\u7565\u7684namespace front-apps\u53d8\u6210\u4e86webapps \u8003\u9898\u516b\uff1ak8s \u51ed\u636e\u7ba1\u7406-secret \u00b6 \u9898\u76ee \u00b6 \u6a21\u62df\u73af\u5883 \u00b6 kubectl create ns monitoring kubectl create secret generic db1-test --from-literal=username=admin --from-literal=password=pass -n monitoring \u8003\u9898\u89e3\u7b54 \u00b6 \u5b98\u7f51\uff1ahttps://kubernetes.io/zh-cn/docs/concepts/configuration/secret/ \u67e5\u770b secret \u5185\u5bb9\uff1a kubectl get secret db1-test -n monitoring -oyaml | grep data -A 2 -m 1 # \u89e3\u5bc6\u540e\u4fdd\u5b58 mkdir /home/candidate echo -n \"YWRtaW4=\" | base64 -d > /home/candidate/user.txt echo -n \"cGFzcw==\" | base64 -d > /home/candidate/old-passwort.txt \u521b\u5efa dev-mark Secret\uff1a kubectl create secret generic dev-mark --from-literal=username=production-instance --from-literal=password=aV3qff3rqda -n monitoring \u521b\u5efapod\uff1a kubectl run secret-pod -n monitoring --image=redis --dry-run=client -oyaml > secret-pod.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: secret-pod name: secret-pod namespace: monitoring spec: volumes: - name: secret-volume secret: secretName: dev-mark containers: - image: redis name: secret-pod resources: {} volumeMounts: - name: secret-volume mountPath: \"/etc/test-secret\" dnsPolicy: ClusterFirst restartPolicy: Always status: {} \u8003\u9898\u4e5d\uff1aDockerfile\u548cDeployment\u4f18\u5316 \u00b6 \u8003\u9898 \u00b6 \u6a21\u62df\u73af\u5883 \u00b6 cat /home/candidate/Dockerfile FROM ubuntu:16.04 USER root RUN apt get install -y nginx=4.2 ENV ENV=testing USER root CMD [\"nginx -d\"] cat /home/candidate/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: test name: test spec: replicas: 1 selector: matchLabels: app: test strategy: {} template: metadata: creationTimestamp: null labels: app: test spec: containers: - image: redis name: redis resources: {} securityContext: capabilities: add: [\"NET_ADMIN\"] drop: [\"all\"] privileged: true readOnlyRootFilesystem: false runAsUser: 65535 \u8003\u9898\u89e3\u7b54 \u00b6 \u4f18\u5316Dockerfile cat /home/candidate/Dockerfile FROM ubuntu:16.04 USER nobody # \u5c06roo\u5929\u7528\u6237\u6539\u4e3a65535\u6216\u8005nobody RUN apt get install -y nginx=4.2 ENV ENV=testing USER nobody # \u5c06roo\u5929\u7528\u6237\u6539\u4e3a65535\u6216\u8005nobody CMD [\"nginx -d\"] \u4f18\u5316deployment apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: test name: test spec: replicas: 1 selector: matchLabels: app: test strategy: {} template: metadata: creationTimestamp: null labels: app: test spec: containers: - image: redis name: redis resources: {} securityContext: capabilities: add: [\"NET_ADMIN\"] drop: [\"all\"] privileged: False # \u5173\u95ed\u7279\u6743\u6a21\u5f0f readOnlyRootFilesystem: True # \u6253\u5f00\u53ea\u8bfb runAsUser: 65535 \u6ce8\u610f\uff1a\u5982\u679c drop:\u90a3\u4e00\u9879\u4e3a\u7a7a\uff0c\u9700\u8981\u6539\u4e3a all \u8003\u9898\u53d8\u66f4 \u00b6 SecurityContext \u5b89\u5168\u5bb9\u5668\u914d\u7f6e \u8003\u9898 \u00b6 \u4fee\u6539\u8fd0\u884c\u5728namespaces app\uff0c\u540d\u4e3alamp-deployment \u7684deployment\uff0c\u4f7f\u5176containerds \u4f7f\u7528\u7528\u6237ID 30000 \u8fd0\u884c \u4f7f\u7528\u4e00\u4e2a\u53ea\u8bfb\u7684\u6839\u6587\u4ef6\u7cfb\u7edf \u7981\u7528 privilege escalation [mac] root@cpu-4:~# kubectl create ns app [mac] root@cpu-4:~# kubectl create deploy lamp-deployment --image=redis -n app \u8003\u9898\u89e3\u7b54 \u00b6 kubectl edit deploy lamp-deployment -n app containers: - image: redis imagePullPolicy: Always name: redis resources: {} securityContext: allowPrivilegeEscalation: false readOnlyRootFilesystem: true runAsUser: 30000 # \u5982\u679c\u6709\u591a\u4e2acontainers \u9700\u8981\u90fd\u6dfb\u52a0 securityContext \u914d\u7f6e \u8003\u9898\u5341\uff1a\u65e0\u72b6\u6001\u548c\u4e0d\u53ef\u53d8\u5e94\u7528 \u00b6 \u8003\u9898 \u00b6 \u6a21\u62df\u73af\u5883 \u00b6 kubectl create ns development cat 11-pod-pri.yaml apiVersion : v1 kind : Pod metadata : creationTimestamp : null labels : run : dev-pod name : dev-pod namespace : development spec : containers : - image : nginx name : dev-pod resources : {} securityContext : privileged : true dnsPolicy : ClusterFirst restartPolicy : Always k apply -f 11-pod-pri.yaml \u8003\u9898\u89e3\u7b54 \u00b6 k get pod -n development -oyaml |grep -E \"privileged|RootFileSystem\" # \u68c0\u67e5\u6302\u8f7d\u6570\u636e\u7684pod kubectl edit pod -n development k delete pod dev-pod # \u5220\u9664\u5177\u6709\u7279\u6743\u7684\u5bb9\u5668\u548c\u4ee5\u53ca\u6302\u8f7d\u6570\u636e\u7684\u5bb9\u5668 \u8003\u9898\u5341\u4e00\uff1aNetworkPolicy \u8bbf\u95ee\u63a7\u5236 \u00b6 \u8003\u9898 \u00b6 \u6a21\u62df\u73af\u5883 \u00b6 kubectl create ns development kubectl run products-service --image=nginx -n development kubectl create ns qa \u8003\u9898\u89e3\u7b54 \u00b6 \u5b98\u7f51\uff1ahttps://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/ kubectl get ns qa --show-labels kubectl get po products-service -n development --show-labels k apply -f pod-restriction-network-policy.yaml apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: pod-restriction namespace: development spec: podSelector: matchLabels: run: products-service policyTypes: - Ingress ingress: - from: - podSelector: matchLabels: environment: testing namespaceSelector: {} - from: - namespaceSelector: matchLabels: kubernetes.io/metadata.name: qa \u8003\u9898\u5341\u4e8c\uff1a Trivy \u626b\u63cf\u955c\u50cf\u5b89\u5168\u6f0f\u6d1e \uff083\u5206\uff09 \u00b6 \u8003\u9898 \u00b6 \u6a21\u62df\u8003\u9898 \u00b6 sudo apt-get install wget apt-transport-https gnupg lsb-release -y wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add - echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list wget https://github.com/aquasecurity/trivy/releases/download/v0.30.4/trivy_0.30.4_Linux-64bit.deb dpkg -i trivy_0.30.4_Linux-64bit.deb kubectl create ns kamino kubectl run nginx --image=nginx -n kamino kubectl run node --image=registry.cn-beijing.aliyuncs.com/dotbalo/node:v3.18.1 -n kamino kubectl run alpine --image=alpine:3.14 -n kamino \u8003\u9898\u89e3\u7b54 \u00b6 \u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684 master \u8282\u70b9 kubectl get pods -n kamino -o=custom-columns=\"NAME:.metadata.name,IMAGE:.spec.containers[*].image\" trivy image --skip-update -s \"HIGH,CRITICAL\" alpine:3.14 \u5220\u9664\u5305\u542b\u8fd9\u4e9b\u6f0f\u6d1e\u7684\u955c\u50cf\u548cpod \u8003\u9898\u5341\u4e09\uff1a\u7981\u6b62\u533f\u540d\u8bbf\u95ee \uff086\u5206\uff09 \u00b6 \u8003\u9898 \u00b6 \u6a21\u62df\u73af\u5883 \u00b6 \u8003\u9898\u89e3\u7b54 \u00b6 \u5207\u6362context\u540e\uff0cssh\u5230\u5bf9\u5e94\u7684master\u8282\u70b9,\u66f4\u6539context\uff0cssh\u5230\u5bf9\u5e94\u7684master\u8282\u70b9 [mac] root@cpu-4:~# vim /etc/kubernetes/manifests/kube-apiserver.yaml - --authorization-mode=Node,RBAC - --enable-admission-plugins=NodeRestriction \u5220\u9664 clusterrolebinding\uff1a kubectl delete clusterrolebinding system:anonymous \u8003\u9898\u5341\u56db\uff1aAppArmor \uff0812\u5206\uff09 \u00b6 \u8003\u9898 \u00b6 \u5b98\u65b9\u6587\u6863\uff1ahttps://kubernetes.io/docs/tutorials/security/apparmor/ \u6a21\u62df\u73af\u5883 \u00b6 Node \u8282\u70b9\u5b89\u88c5 AppArmor\uff1a apt-get install apparmor-utils -y apparmor_status \u521b\u5efa AppArmor \u9650\u5236\u6587\u4ef6\uff1a root@cks-node:~# vim /etc/apparmor.d/nginx_apparmor #include <tunables/global> profile nginx-profile-1 flags=(attach_disconnected) { #include <abstractions/base> file, # Deny all file writes. deny /** w, } Master \u8282\u70b9\u521b\u5efa deploy \u6587\u4ef6: apiVersion: v1 kind: Pod metadata: name: nginx-deploy spec: containers: - name: nginx-deploy image: busybox:1.28 command: [ \"sh\", \"-c\", \"echo 'Hello AppArmor!' && sleep 1h\" ] \u8003\u9898\u89e3\u7b54 \u00b6 \u5207\u6362 Context\uff0cssh \u5230 node \u8282\u70b9\u8fdb\u884c\u64cd\u4f5c \u52a0\u8f7d apparmor \u914d\u7f6e\u6587\u4ef6\uff1a apparmor_parser /etc/apparmor.d/nginx_apparmor \u67e5\u770b apparmor \u7684\u7b56\u7565\u540d\u79f0\uff1a apparmor_status | grep nginx-profile kubectl create -f nginx-deploy.yaml apiVersion: v1 kind: Pod metadata: name: nginx-deploy annotations: container.apparmor.security.beta.kubernetes.io/nginx-deploy: localhost/nginx-profile-1 # \u589e\u52a0\u4e00\u4e2a\u6ce8\u89e3 spec: containers: - name: nginx-deploy image: busybox:1.28 command: [ \"sh\", \"-c\", \"echo 'Hello AppArmor!' && sleep 1h\" ] \u8003\u9898\u5341\u4e94\uff1asysdig \u00b6 \u8003\u9898 \u00b6 \u6a21\u62df\u73af\u5883 \u00b6 \u5728\u5de5\u4f5c\u8282\u70b9\u5b89\u88c5 sysdig\uff1a curl -s https://s3.amazonaws.com/download.draios.com/stable/install-sysdig |bash kubectl run redis --image=redis \u8003\u9898\u89e3\u7b54 \u00b6 \u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684\u5de5\u4f5c\u8282\u70b9 \u67e5\u770b\u5bb9\u5668\u7684\u540d\u5b57\u6216 ID: docker ps |grep redis \u6ca1\u6709 Docker \u547d\u4ee4: crictl ps | grep redis \u5982\u679c\u65e2\u6ca1\u6709 Docker \u547d\u4ee4\u4e5f\u6ca1\u6709 crictl \u547d\u4ee4\uff1a kubectl get po redis -oyaml | grep containerID \u4f7f\u7528 sysdig \u8fdb\u884c\u68c0\u6d4b\uff1a sudo sysdig -M 30 -p \"%evt.time,%user.uid,%proc.name\" container.id=46183d7281e15 > /opt/KSRS00101/events/details \u6ce8\u610f\uff1a\u5982\u679c\u6587\u4ef6\u4e3a\u7a7a\uff0c\u4f7f\u7528 container.name \u91cd\u65b0\u6267\u884c sudo sysdig -M 30 -p \"%evt.time,%user.uid,%proc.name\" container.name=redis > /opt/KSRS00101/events/details \u8003\u9898\u5341\u516d\uff1aImagePolicyWebhook \u00b6 \u6a21\u62df\u73af\u5883 \u00b6 \u4e0a\u4f20 cfssl \u548c cfssljson \u5e76\u66f4\u6539\u6743\u9650\uff1a # mv cfssl_linux-amd64 /usr/local/bin/cfssl chmod +x /usr/local/bin/cfssl # mv cfssljson_linux-amd64 /usr/local/bin/cfssljson chmod +x /usr/local/bin/cfssljson \u751f\u6210 ImagePolicyWebhook \u6240\u7528\u7684\u8bc1\u4e66\uff1a cat <<EOF | cfssl genkey - | cfssljson -bare server { \"hosts\": [ \"wakanda.local\", \"wakanda.local.default.svc\", \"wakanda.local.default.svc.cluster.local\", \"wakanda.local.default.pod.cluster.local\" ], \"CN\": \"system:node:image-bouncer-webhook.default.pod.cluster.local\", \"key\": { \"algo\": \"ecdsa\", \"size\": 256 }, \"names\": [ { \"O\": \"system:nodes\" } ] } EOF \u521b\u5efa\u4e00\u4e2a CSR\uff1a cat <<EOF | kubectl apply -f - apiVersion: certificates.k8s.io/v1 kind: CertificateSigningRequest metadata: name: wakanda.local spec: request: $(cat server.csr | base64 | tr -d '\\n') signerName: kubernetes.io/kubelet-serving usages: - digital signature - key encipherment - server auth EOF kubectl get csr kubectl certificate approve wakanda.local kubectl get csr wakanda.local -o jsonpath='{.status.certificate}' | base64 --decode > server.crt cp server.crt /etc/kubernetes/pki/ echo \"127.0.0.1 wakanda.local\" >> /etc/hosts \u521b\u5efa\u51c6\u5165\u63a7\u5236\u5668\u7684\u914d\u7f6e\u6587\u4ef6\uff1a mkdir /etc/kubernetes/epconfig/ vim /etc/kubernetes/epconfig/admission_configuration.json { \"imagePolicy\": { \"kubeConfigFile\": \"/etc/kubernetes/epconfig/kubeconfig.yaml\", \"allowTTL\": 50, \"denyTTL\": 50, \"retryBackoff\": 500, \"defaultAllow\": true } } \u521b\u5efa kubeconfig\uff1a vim /etc/kubernetes/epconfig/kubeconfig.yaml apiVersion: v1 kind: Config clusters: - cluster: certificate-authority: /etc/kubernetes/pki/server.crt server: name: bouncer_webhook contexts: - context: cluster: bouncer_webhook user: api-server name: bouncer_validator current-context: bouncer_validator preferences: {} users: - name: api-server user: client-certificate: /etc/kubernetes/pki/apiserver.crt client-key: /etc/kubernetes/pki/apiserver.key \u5b89\u88c5 Docker\uff08https://docs.docker.com/engine/install/ubuntu/\uff09\uff1a apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null apt-get update -y apt-get install docker-ce docker-ce-cli \u542f\u52a8 ImagePolicyWebHook \u670d\u52a1\u5668\uff1a chmod 777 * docker run -tid --rm \\ -v `pwd`/server-key.pem:/certs/server-key.pem:ro \\ -v `pwd`/server.crt:/certs/server.crt:ro \\ -p 8082:1323 \\ registry.cn-beijing.aliyuncs.com/dotbalo/kube-image-bouncer \\ -k /certs/server-key.pem \\ -c /certs/server.crt mkdir /root/KSSC00202/ cat /root/KSSC00202/configuration-test.yml apiVersion: v1 kind: ReplicationController metadata: name: nginx-latest spec: replicas: 1 selector: app: nginx-latest template: metadata: name: nginx-latest labels: app: nginx-latest spec: containers: - name: nginx-latest image: nginx ports: - containerPort: 80 \u8003\u9898\u89e3\u7b54 \u00b6 \u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684 master \u8282\u70b9 \u5173\u95ed\u9ed8\u8ba4\u5141\u8bb8\uff1a vim /etc/kubernetes/epconfig/admission_configuration.json 'defaultAllow': false # \u5c06true \u6539\u6210 false \u914d\u7f6e Webhook \u5730\u5740\uff1a vim /etc/kubernetes/epconfig/kubeconfig.yaml apiVersion: v1 kind: Config clusters: - cluster: certificate-authority: /etc/kubernetes/pki/server.crt server: https://acme.local:8082/image_policy # \u589e\u52a0webhook server name: bouncer_webhook contexts: - context: cluster: bouncer_webhook user: api-server name: bouncer_validator current-context: bouncer_validator preferences: {} users: - name: api-server user: client-certificate: /etc/kubernetes/pki/apiserver.crt client-key: /etc/kubernetes/pki/apiserver.key - \u5f00\u542f ImagePolicyWebhook\uff1a vim /etc/kubernetes/manifests/kube-apiserver.yaml - --enable-admission-plugins=NodeRestriction,ImagePolicyWebhook - --admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json \u5728 volumeMounts \u589e\u52a0 volumeMounts: - mountPath: /etc/kubernetes/epconfig name: epconfig \u5728volumes \u589e\u52a0 volumes: - name: epconfig hostPath: path: /etc/kubernetes/epconfig \u91cd\u542fkubelet\u670d\u52a1 systemctl daemon-reload && systemctl restart kubelet","title":"kubernetes CKS\u8003\u9898"},{"location":"cks/cks/#cks","text":"","title":"CKS\u8003\u9898"},{"location":"cks/cks/#runtimeclass","text":"","title":"\u8003\u9898\u4e00\uff1a\u5bb9\u5668\u8fd0\u884c\u65f6\uff08runtimeclass \u8003\u9898\uff09"},{"location":"cks/cks/#111","text":"","title":"1.1.1 \u8003\u9898"},{"location":"cks/cks/#112","text":"gvisor\u5b98\u7f51\uff1a https://gvisor.dev/docs/user_guide/install/ \u9996\u5148\uff0c\u5fc5\u987b\u5b89\u88c5\u9002\u5f53\u7684\u4f9d\u8d56\u9879\u4ee5\u5141\u8bb8 apt \u901a\u8fc7 https \u5b89\u88c5\u8f6f\u4ef6\u5305 sudo apt-get update && \\ sudo apt-get install -y \\ apt-transport-https \\ ca-certificates \\ curl \\ gnupg \u63a5\u4e0b\u6765\uff0c\u914d\u7f6e\u7528\u4e8e\u7b7e\u7f72\u6863\u6848\u548c\u5b58\u50a8\u5e93\u7684\u5bc6\u94a5 curl -fsSL https://gvisor.dev/archive.key | sudo gpg --dearmor -o /usr/share/keyrings/gvisor-archive-keyring.gpg echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] https://storage.googleapis.com/gvisor/releases release main\" | sudo tee /etc/apt/sources.list.d/gvisor.list > /dev/null \u73b0\u5728\u53ef\u4ee5\u5b89\u88c5runsc\u5305\u4e86 sudo apt-get update && sudo apt-get install -y runsc \u914d\u7f6econtainerd [mac] root@cpu-1:/home/lixie# vim /etc/containerd/config.toml [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runsc] runtime_type = \"io.containerd.runsc.v1\" [mac] root@cpu-1:/home/lixie# systemctl daemon-reload && systemctl restart containerd 5. \u521b\u5efa\u4e00\u4e2apod $ kubectl create ns client namespace/client created $ kubectl run nginx --image=nginx -n client pod/nginx created","title":"1.1.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#113","text":"\u53c2\u8003\u5730\u5740 https://kubernetes.io/zh-cn/docs/concepts/containers/runtime-class/","title":"1.1.3 \u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#runtimeclass_1","text":"# RuntimeClass \u5b9a\u4e49\u4e8e node.k8s.io API \u7ec4 apiVersion : node.k8s.io/v1 kind : RuntimeClass metadata : # RuntimeClass \u662f\u4e00\u4e2a\u96c6\u7fa4\u5c42\u9762\u7684\u8d44\u6e90 name : untrusted # \u7528\u6765\u5f15\u7528 RuntimeClass \u7684\u540d\u5b57 handler : runsc # \u5bf9\u5e94\u7684 CRI \u914d\u7f6e\u7684\u540d\u79f0","title":"\u521b\u5efa RuntimeClass \u8d44\u6e90"},{"location":"cks/cks/#runtimeclassname","text":"apiVersion : v1 kind : Pod metadata : name : mypod spec : runtimeClassName : untrusted # \u6ce8\u610f\u8fd9\u4e2auntrusted \u540d\u79f0 # ... kubectl get po nginx -n client -oyaml > nginx.yaml kubectl delete -f nginx.yaml ; kubectl create -f nginx.yaml","title":"\u6dfb\u52a0 runtimeClassName"},{"location":"cks/cks/#2022-01","text":"apiVersion: apps/v1 kind: Deployment metadata: name: jfs-app labels: app: nginx spec: replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: runtimeClassName: untrusted # \u6ce8\u610f\u66f4\u6539\u4e4b\u540e\u7684\u4f4d\u7f6e containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent","title":"2022-01 \u8003\u9898\u66f4\u65b0"},{"location":"cks/cks/#serviceaccount","text":"\u53c2\u8003\u5730\u5740 https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/","title":"\u8003\u9898\u4e8c\uff1aServiceAccount\u8003\u9898"},{"location":"cks/cks/#121","text":"","title":"1.2.1 \u8003\u9898"},{"location":"cks/cks/#122","text":"k create ns prod kubectl run backend -n prod --image=nginx --dry-run=client -oyaml > pod-manifests.yaml","title":"1.2.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#123","text":"\u5b98\u65b9\u6587\u6863\uff1a https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/ kubectl create sa backend-sa -n prod --dry-run=client -oyaml > sa.yaml apiVersion : v1 kind : ServiceAccount metadata : creationTimestamp : null name : backend-sa namespace : prod automountServiceAccountToken : false # \u4e0d\u6302\u8f7d API \u51ed\u636e \u521b\u5efa\u4e00\u4e2apod\uff0c\u5e76\u6302\u5728serviceAccount apiVersion : v1 kind : Pod metadata : creationTimestamp : null labels : run : backend name : backend namespace : prod spec : serviceAccountName : backend-sa # \u6302\u8f7dsa containers : - image : nginx name : backend resources : {} dnsPolicy : ClusterFirst restartPolicy : Always status : {} - \u5220\u9664prod\u4e0b\u5176\u4ed6\u6ca1\u6709\u4f7f\u7528\u7684sa kubectl delete sa default -n prod","title":"1.2.3 \u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#kube-bench","text":"Kube-Bench\u662f\u4e00\u4e2a\u7528\u4e8e\u68c0\u67e5\u548c\u8bc4\u4f30Kubernetes\u96c6\u7fa4\u5b89\u5168\u6027\u7684\u5f00\u6e90\u5de5\u5177\u3002\u5b83\u901a\u8fc7\u6267\u884c\u4e00\u7cfb\u5217\u7684\u5b89\u5168\u68c0\u67e5\u6765\u8bc4\u4f30Kubernetes\u96c6\u7fa4\u7684\u5b89\u5168\u6027\u914d\u7f6e\uff0c\u5e76\u63d0\u4f9b\u76f8\u5e94\u7684\u5efa\u8bae\u548c\u6307\u5bfc\u6765\u6539\u5584\u5b89\u5168\u6027\u3002","title":"\u8003\u9898\u4e09\uff1akube-bench \u8003\u9898"},{"location":"cks/cks/#131","text":"","title":"1.3.1 \u8003\u9898"},{"location":"cks/cks/#132","text":"[mac] vim /etc/kubernetes/manifests/kube-apiserver.yaml - --authorization-mode=AlwaysAllow - --enable-bootstrap-token-auth=false [mac] vim /var/lib/kubelet/config.yaml apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: true webhook: cacheTTL: 0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.crt authorization: mode: AlwaysAllow vim /etc/kubernetes/manifests/etcd.yaml - --client-cert-auth=false \u5b89\u88c5 kube-bench\uff1a wget https://github.com/aquasecurity/kube-bench/releases/download/v0.6.15/kube-bench_0.6.15_linux_amd64.deb dpkg -i kube-bench_0.6.15_linux_amd64.deb kube-bench kube-bench master # \u53ea\u68c0\u67e5master\u8282\u70b9","title":"1.3.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#133","text":"ssh \u5230\u5bf9\u5e94\u7684\u8282\u70b9\u4e0a\u4fee\u6539 kube-apiserver \u914d\u7f6e\uff1a vim /etc/kubernetes/manifests/kube-apiserver.yaml - --authorization-mode=Node,RBAC \u4fee\u6539etcd vim /etc/kubernetes/manifests/etcd.yaml - --client-cert-auth=true \u4fee\u6539kubelet [mac] vim /var/lib/kubelet/config.yaml apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false # \u6539\u4e3afalse webhook: cacheTTL: 0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.crt authorization: mode: Webhook # \u6539\u4e3aWebhook \u4fee\u6539\u5b8c\u6210\u9000\u51fa\uff0c\u4fee\u6539node\u8282\u70b9 systemctl daemon-reload && systemctl restart kubelet","title":"1.3.3 \u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#networkpolicy-ingress","text":"\u53c2\u8003\u5730\u5740 https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/","title":"\u8003\u9898\u56db. NetworkPolicy \u8003\u9898-\u9ed8\u8ba4\u62d2\u7edd\u6240\u6709ingress\u6d41\u91cf"},{"location":"cks/cks/#141","text":"","title":"1.4.1 \u8003\u9898"},{"location":"cks/cks/#142","text":"","title":"1.4.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#143","text":"apiVersion : networking.k8s.io/v1 kind : NetworkPolicy metadata : name : defaultdeny # \u540d\u79f0\u53ef\u80fd\u4e0d\u4e00\u6837 spec : podSelector : {} policyTypes : - Ingress k apply -f network-policy.yaml -n production","title":"1.4.3 \u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#tls","text":"\u53c2\u6570\u5730\u5740 https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/","title":"\u8003\u9898\u4e94\uff1aTLS\u901a\u4fe1\u914d\u7f6e"},{"location":"cks/cks/#151","text":"\u6587\u7ae0\u53c2\u8003\uff1ahttps://www.hao.kim/1112.html \u4fee\u6539API server\u548cetcd\u4e4b\u95f4\u901a\u4fe1\u7684TLS\u914d\u7f6e kube-apiserver\u9664\u4e86 TLS 1.3 \u53ca\u4ee5\u4e0a\u7684\u7248\u672c\u53ef\u4ee5\u4f7f\u7528\uff0c\u5176\u4ed6\u7248\u672c\u90fd\u4e0d\u5141\u8bb8\u4f7f\u7528\u3002 \u5bc6\u7801\u5957\u4ef6\uff08Cipher suite\uff09\u4e3a TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256","title":"1.5.1 \u8003\u9898"},{"location":"cks/cks/#152","text":"","title":"1.5.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#153","text":"\u767b\u5f55\u5230master\u8282\u70b9\uff1a [mac] root@cpu-4:~# vim /etc/kubernetes/manifests/kube-apiserver.yaml - --tls-min-version=VersionTLS13 - --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 [mac] root@cpu-4:~# vim /etc/kubernetes/manifests/etcd.yaml - --cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 systemctl daemon-reload && systemctl restart kubelet","title":"1.5.3 \u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#rbac","text":"","title":"\u8003\u9898\u516d. RBAC \u8003\u9898"},{"location":"cks/cks/#161","text":"","title":"1.6.1 \u8003\u9898"},{"location":"cks/cks/#162","text":"kubectl create ns monitoring kubectl create sa service-account-web -n monitoring \u521b\u5efa Role\uff1a $ cat role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: monitoring name: web-role rules: - apiGroups: [\"\"] # \"\" \u6807\u660e core API \u7ec4 resources: [\"pods\"] verbs: [\"get\", \"watch\", \"list\"] kubectl create -f role.yaml \u6388\u6743\uff1a kubectl create rolebinding pod-get --role=web-role --serviceaccount=monitoring:service-account-web -n monitoring \u521b\u5efa Pod\uff1a vim pod-rbac.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: dev-pod name: dev-pod namespace: monitoring spec: serviceAccountName: service-account-web containers: - image: nginx name: dev-pod resources: {} dnsPolicy: ClusterFirst restartPolicy: Always # kubectl create -f pod-rbac.yaml","title":"1.6.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#163","text":"kubectl get po -n monitoring dev-pod -oyaml | grep serviceAccountName kubectl get rolebinding -n monitoring -oyaml |grep service-account-web -B 5 $ k edit role web-role -n monitoring # \u5220\u9664\u5176\u4ed6\u6743\u9650\u53ea\u7559get k apply -f role-sts-update.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: namespace: monitoring name: role-2 rules: - apiGroups: [\"extensions\",\"apps\"] resources: [\"statefulsets\"] verbs: [\"update\"] kubectl create rolebinding role-2-binding --role=role-2 --serviceaccount=monitoring:service-account-web -n monitoring","title":"1.6.3 \u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#_1","text":"","title":"\u53d8\u5f97\u9898\u578b"},{"location":"cks/cks/#_2","text":"\u7f16\u8f91\u7ed1\u5b9a\u5230pod\u7684 serviceaccount test-sa-3\u7684\u73b0\u6709role\uff0c\u4ec5\u5141\u8bb8\u53ea\u5bf9endpoints\u7c7b\u578b\u7684resources\u6267\u884cget\u64cd\u4f5c \u5728namespace monitoring\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3arole-2\uff0c\u5e76\u4ec5\u5141\u8bb8\u6267\u884cdelete\u64cd\u4f5c\u7684\u65b0role \u521b\u5efa\u4e00\u4e2a\u540d\u4e3arole-2-binding\u7684\u65b0\u7684rolebing\uff0c\u5c06role-2\u7ed1\u5b9a\u9053Pod\u7ed1\u5b9a\u7684serviceaccount \u4e0a","title":"\u8003\u9898"},{"location":"cks/cks/#_3","text":"k create deploy nginx --image=nginx -n monitoring --dry-run=client -oyaml > role-new.yaml k create sa test-sa-3 -n monitoring apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: nginx name: nginx namespace: monitoring spec: replicas: 1 selector: matchLabels: app: nginx strategy: {} template: metadata: creationTimestamp: null labels: app: nginx spec: serviceAccountName: test-sa-3 # \u6dfb\u52a0serviceAccountName containers: - image: nginx name: nginx resources: {} status: {} kubectl create role web-role --verb=create --resource=deployments -n monitoring kubectl create rolebinding web-role-binding --role=web-role --serviceaccount=monitoring:test-sa-3 -n monitoring","title":"\u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#_4","text":"\u67e5\u627e\u7ed1\u5b9a\u7684Role\uff08\u53ef\u80fd\u6ca1\u6709\u8fd9\u4e2arolebinding\uff0c\u6ca1\u6709\u7684\u8bdd\u76f4\u63a5edit test-sa-3\uff09 k get rolebinding -n monitoring -oyaml |grep test-sa-3 -B 5 k edit role web-role -n monitoring - apiGroups: - '' # \u4fee\u6539\u4e3a\u7a7a resources: - endpoints # \u4fee\u6539 verbs: - get # \u4fee\u6539 k create role role-2 --verb=delete --resource=namespaces -n monitoring k create rolebinding role-2-binding --role=role-2 --serviceaccount=monitoring:test-sa-3 -n monitoring","title":"\u89e3\u9898"},{"location":"cks/cks/#7","text":"\u5b98\u65b9\u6587\u6863\uff1ahttps://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/","title":"7. \u5ba1\u8ba1\u65e5\u5fd7 \u8003\u9898"},{"location":"cks/cks/#171","text":"","title":"1.7.1 \u8003\u9898"},{"location":"cks/cks/#172","text":"\u521b\u5efa\u5ba1\u8ba1\u65e5\u5fd7\u89c4\u5219\uff08\u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684 master \u8282\u70b9\uff09\uff1a mkdir -p /etc/kubernetes/logpolicy/ /var/log/kubernetes/ # \u6b64\u6b65\u8003\u8bd5\u4e0d\u7528\u6267\u884c","title":"1.7.2 \u6a21\u62df\u8003\u8bd5\u73af\u5883"},{"location":"cks/cks/#173","text":"cat /etc/kubernetes/logpolicy/sample-policy.yaml apiVersion : audit.k8s.io/v1 # This is required. kind : Policy omitStages : - \"RequestReceived\" rules : - level : RequestResponse resources : - group : \"\" resources : [ \"cronjobs\" ] - level : Request resources : - group : \"\" resources : [ \"persistendvolumes\" ] namespaces : [ \"front-apps\" ] - level : Metadata resources : - group : \"\" # core API group resources : [ \"secrets\" , \"configmaps\" ] - level : Metadata omitStages : - \"RequestReceived\" vim /etc/kubernetes/manifests/kube-apiserver.yaml - --audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml - --audit-log-path=/var/log/kubernetes/kubernetes-logs.txt - --audit-log-maxage=30 - --audit-log-maxbackup=10 \u8003\u8bd5\u73af\u5883\uff1a\u5df2\u7ecfmount - mountPath: /var/log/kubernetes name: kubernetes-logs - mountPath: /etc/kubernetes/logpolicy name: kubernetes-policy name: kubernetes-policy hostNetwork: true priorityClassName: system-node-critical volumes: - hostPath: path: /etc/kubernetes/logpolicy name: kubernetes-policy - hostPath: path: /var/log/kubernetes name: kubernetes-logs systemctl daemon-reload systemctl restart kubelet","title":"1.7.3 \u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#_5","text":"\u539f\u9898\u7684\u7b2c\u4e00\u4e2a\u7b56\u7565\u53d8\u6210\u4e86\uff1aRequestResponse\u7ea7\u522b\u7684nodes\u66f4\u6539 \u7b2c\u4e8c\u4e2a\u7b56\u7565\u7684namespace front-apps\u53d8\u6210\u4e86webapps","title":"\u9898\u76ee\u53d8\u66f4\uff1a"},{"location":"cks/cks/#k8s-secret","text":"","title":"\u8003\u9898\u516b\uff1ak8s \u51ed\u636e\u7ba1\u7406-secret"},{"location":"cks/cks/#_6","text":"","title":"\u9898\u76ee"},{"location":"cks/cks/#_7","text":"kubectl create ns monitoring kubectl create secret generic db1-test --from-literal=username=admin --from-literal=password=pass -n monitoring","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_8","text":"\u5b98\u7f51\uff1ahttps://kubernetes.io/zh-cn/docs/concepts/configuration/secret/ \u67e5\u770b secret \u5185\u5bb9\uff1a kubectl get secret db1-test -n monitoring -oyaml | grep data -A 2 -m 1 # \u89e3\u5bc6\u540e\u4fdd\u5b58 mkdir /home/candidate echo -n \"YWRtaW4=\" | base64 -d > /home/candidate/user.txt echo -n \"cGFzcw==\" | base64 -d > /home/candidate/old-passwort.txt \u521b\u5efa dev-mark Secret\uff1a kubectl create secret generic dev-mark --from-literal=username=production-instance --from-literal=password=aV3qff3rqda -n monitoring \u521b\u5efapod\uff1a kubectl run secret-pod -n monitoring --image=redis --dry-run=client -oyaml > secret-pod.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: secret-pod name: secret-pod namespace: monitoring spec: volumes: - name: secret-volume secret: secretName: dev-mark containers: - image: redis name: secret-pod resources: {} volumeMounts: - name: secret-volume mountPath: \"/etc/test-secret\" dnsPolicy: ClusterFirst restartPolicy: Always status: {}","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#dockerfiledeployment","text":"","title":"\u8003\u9898\u4e5d\uff1aDockerfile\u548cDeployment\u4f18\u5316"},{"location":"cks/cks/#_9","text":"","title":"\u8003\u9898"},{"location":"cks/cks/#_10","text":"cat /home/candidate/Dockerfile FROM ubuntu:16.04 USER root RUN apt get install -y nginx=4.2 ENV ENV=testing USER root CMD [\"nginx -d\"] cat /home/candidate/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: test name: test spec: replicas: 1 selector: matchLabels: app: test strategy: {} template: metadata: creationTimestamp: null labels: app: test spec: containers: - image: redis name: redis resources: {} securityContext: capabilities: add: [\"NET_ADMIN\"] drop: [\"all\"] privileged: true readOnlyRootFilesystem: false runAsUser: 65535","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_11","text":"\u4f18\u5316Dockerfile cat /home/candidate/Dockerfile FROM ubuntu:16.04 USER nobody # \u5c06roo\u5929\u7528\u6237\u6539\u4e3a65535\u6216\u8005nobody RUN apt get install -y nginx=4.2 ENV ENV=testing USER nobody # \u5c06roo\u5929\u7528\u6237\u6539\u4e3a65535\u6216\u8005nobody CMD [\"nginx -d\"] \u4f18\u5316deployment apiVersion: apps/v1 kind: Deployment metadata: creationTimestamp: null labels: app: test name: test spec: replicas: 1 selector: matchLabels: app: test strategy: {} template: metadata: creationTimestamp: null labels: app: test spec: containers: - image: redis name: redis resources: {} securityContext: capabilities: add: [\"NET_ADMIN\"] drop: [\"all\"] privileged: False # \u5173\u95ed\u7279\u6743\u6a21\u5f0f readOnlyRootFilesystem: True # \u6253\u5f00\u53ea\u8bfb runAsUser: 65535 \u6ce8\u610f\uff1a\u5982\u679c drop:\u90a3\u4e00\u9879\u4e3a\u7a7a\uff0c\u9700\u8981\u6539\u4e3a all","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#_12","text":"SecurityContext \u5b89\u5168\u5bb9\u5668\u914d\u7f6e","title":"\u8003\u9898\u53d8\u66f4"},{"location":"cks/cks/#_13","text":"\u4fee\u6539\u8fd0\u884c\u5728namespaces app\uff0c\u540d\u4e3alamp-deployment \u7684deployment\uff0c\u4f7f\u5176containerds \u4f7f\u7528\u7528\u6237ID 30000 \u8fd0\u884c \u4f7f\u7528\u4e00\u4e2a\u53ea\u8bfb\u7684\u6839\u6587\u4ef6\u7cfb\u7edf \u7981\u7528 privilege escalation [mac] root@cpu-4:~# kubectl create ns app [mac] root@cpu-4:~# kubectl create deploy lamp-deployment --image=redis -n app","title":"\u8003\u9898"},{"location":"cks/cks/#_14","text":"kubectl edit deploy lamp-deployment -n app containers: - image: redis imagePullPolicy: Always name: redis resources: {} securityContext: allowPrivilegeEscalation: false readOnlyRootFilesystem: true runAsUser: 30000 # \u5982\u679c\u6709\u591a\u4e2acontainers \u9700\u8981\u90fd\u6dfb\u52a0 securityContext \u914d\u7f6e","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#_15","text":"","title":"\u8003\u9898\u5341\uff1a\u65e0\u72b6\u6001\u548c\u4e0d\u53ef\u53d8\u5e94\u7528"},{"location":"cks/cks/#_16","text":"","title":"\u8003\u9898"},{"location":"cks/cks/#_17","text":"kubectl create ns development cat 11-pod-pri.yaml apiVersion : v1 kind : Pod metadata : creationTimestamp : null labels : run : dev-pod name : dev-pod namespace : development spec : containers : - image : nginx name : dev-pod resources : {} securityContext : privileged : true dnsPolicy : ClusterFirst restartPolicy : Always k apply -f 11-pod-pri.yaml","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_18","text":"k get pod -n development -oyaml |grep -E \"privileged|RootFileSystem\" # \u68c0\u67e5\u6302\u8f7d\u6570\u636e\u7684pod kubectl edit pod -n development k delete pod dev-pod # \u5220\u9664\u5177\u6709\u7279\u6743\u7684\u5bb9\u5668\u548c\u4ee5\u53ca\u6302\u8f7d\u6570\u636e\u7684\u5bb9\u5668","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#networkpolicy","text":"","title":"\u8003\u9898\u5341\u4e00\uff1aNetworkPolicy \u8bbf\u95ee\u63a7\u5236"},{"location":"cks/cks/#_19","text":"","title":"\u8003\u9898"},{"location":"cks/cks/#_20","text":"kubectl create ns development kubectl run products-service --image=nginx -n development kubectl create ns qa","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_21","text":"\u5b98\u7f51\uff1ahttps://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/ kubectl get ns qa --show-labels kubectl get po products-service -n development --show-labels k apply -f pod-restriction-network-policy.yaml apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: pod-restriction namespace: development spec: podSelector: matchLabels: run: products-service policyTypes: - Ingress ingress: - from: - podSelector: matchLabels: environment: testing namespaceSelector: {} - from: - namespaceSelector: matchLabels: kubernetes.io/metadata.name: qa","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#trivy-3","text":"","title":"\u8003\u9898\u5341\u4e8c\uff1a Trivy \u626b\u63cf\u955c\u50cf\u5b89\u5168\u6f0f\u6d1e \uff083\u5206\uff09"},{"location":"cks/cks/#_22","text":"","title":"\u8003\u9898"},{"location":"cks/cks/#_23","text":"sudo apt-get install wget apt-transport-https gnupg lsb-release -y wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add - echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list wget https://github.com/aquasecurity/trivy/releases/download/v0.30.4/trivy_0.30.4_Linux-64bit.deb dpkg -i trivy_0.30.4_Linux-64bit.deb kubectl create ns kamino kubectl run nginx --image=nginx -n kamino kubectl run node --image=registry.cn-beijing.aliyuncs.com/dotbalo/node:v3.18.1 -n kamino kubectl run alpine --image=alpine:3.14 -n kamino","title":"\u6a21\u62df\u8003\u9898"},{"location":"cks/cks/#_24","text":"\u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684 master \u8282\u70b9 kubectl get pods -n kamino -o=custom-columns=\"NAME:.metadata.name,IMAGE:.spec.containers[*].image\" trivy image --skip-update -s \"HIGH,CRITICAL\" alpine:3.14 \u5220\u9664\u5305\u542b\u8fd9\u4e9b\u6f0f\u6d1e\u7684\u955c\u50cf\u548cpod","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#6","text":"","title":"\u8003\u9898\u5341\u4e09\uff1a\u7981\u6b62\u533f\u540d\u8bbf\u95ee \uff086\u5206\uff09"},{"location":"cks/cks/#_25","text":"","title":"\u8003\u9898"},{"location":"cks/cks/#_26","text":"","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_27","text":"\u5207\u6362context\u540e\uff0cssh\u5230\u5bf9\u5e94\u7684master\u8282\u70b9,\u66f4\u6539context\uff0cssh\u5230\u5bf9\u5e94\u7684master\u8282\u70b9 [mac] root@cpu-4:~# vim /etc/kubernetes/manifests/kube-apiserver.yaml - --authorization-mode=Node,RBAC - --enable-admission-plugins=NodeRestriction \u5220\u9664 clusterrolebinding\uff1a kubectl delete clusterrolebinding system:anonymous","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#apparmor-12","text":"","title":"\u8003\u9898\u5341\u56db\uff1aAppArmor \uff0812\u5206\uff09"},{"location":"cks/cks/#_28","text":"\u5b98\u65b9\u6587\u6863\uff1ahttps://kubernetes.io/docs/tutorials/security/apparmor/","title":"\u8003\u9898"},{"location":"cks/cks/#_29","text":"Node \u8282\u70b9\u5b89\u88c5 AppArmor\uff1a apt-get install apparmor-utils -y apparmor_status \u521b\u5efa AppArmor \u9650\u5236\u6587\u4ef6\uff1a root@cks-node:~# vim /etc/apparmor.d/nginx_apparmor #include <tunables/global> profile nginx-profile-1 flags=(attach_disconnected) { #include <abstractions/base> file, # Deny all file writes. deny /** w, } Master \u8282\u70b9\u521b\u5efa deploy \u6587\u4ef6: apiVersion: v1 kind: Pod metadata: name: nginx-deploy spec: containers: - name: nginx-deploy image: busybox:1.28 command: [ \"sh\", \"-c\", \"echo 'Hello AppArmor!' && sleep 1h\" ]","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_30","text":"\u5207\u6362 Context\uff0cssh \u5230 node \u8282\u70b9\u8fdb\u884c\u64cd\u4f5c \u52a0\u8f7d apparmor \u914d\u7f6e\u6587\u4ef6\uff1a apparmor_parser /etc/apparmor.d/nginx_apparmor \u67e5\u770b apparmor \u7684\u7b56\u7565\u540d\u79f0\uff1a apparmor_status | grep nginx-profile kubectl create -f nginx-deploy.yaml apiVersion: v1 kind: Pod metadata: name: nginx-deploy annotations: container.apparmor.security.beta.kubernetes.io/nginx-deploy: localhost/nginx-profile-1 # \u589e\u52a0\u4e00\u4e2a\u6ce8\u89e3 spec: containers: - name: nginx-deploy image: busybox:1.28 command: [ \"sh\", \"-c\", \"echo 'Hello AppArmor!' && sleep 1h\" ]","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#sysdig","text":"","title":"\u8003\u9898\u5341\u4e94\uff1asysdig"},{"location":"cks/cks/#_31","text":"","title":"\u8003\u9898"},{"location":"cks/cks/#_32","text":"\u5728\u5de5\u4f5c\u8282\u70b9\u5b89\u88c5 sysdig\uff1a curl -s https://s3.amazonaws.com/download.draios.com/stable/install-sysdig |bash kubectl run redis --image=redis","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_33","text":"\u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684\u5de5\u4f5c\u8282\u70b9 \u67e5\u770b\u5bb9\u5668\u7684\u540d\u5b57\u6216 ID: docker ps |grep redis \u6ca1\u6709 Docker \u547d\u4ee4: crictl ps | grep redis \u5982\u679c\u65e2\u6ca1\u6709 Docker \u547d\u4ee4\u4e5f\u6ca1\u6709 crictl \u547d\u4ee4\uff1a kubectl get po redis -oyaml | grep containerID \u4f7f\u7528 sysdig \u8fdb\u884c\u68c0\u6d4b\uff1a sudo sysdig -M 30 -p \"%evt.time,%user.uid,%proc.name\" container.id=46183d7281e15 > /opt/KSRS00101/events/details \u6ce8\u610f\uff1a\u5982\u679c\u6587\u4ef6\u4e3a\u7a7a\uff0c\u4f7f\u7528 container.name \u91cd\u65b0\u6267\u884c sudo sysdig -M 30 -p \"%evt.time,%user.uid,%proc.name\" container.name=redis > /opt/KSRS00101/events/details","title":"\u8003\u9898\u89e3\u7b54"},{"location":"cks/cks/#imagepolicywebhook","text":"","title":"\u8003\u9898\u5341\u516d\uff1aImagePolicyWebhook"},{"location":"cks/cks/#_34","text":"\u4e0a\u4f20 cfssl \u548c cfssljson \u5e76\u66f4\u6539\u6743\u9650\uff1a # mv cfssl_linux-amd64 /usr/local/bin/cfssl chmod +x /usr/local/bin/cfssl # mv cfssljson_linux-amd64 /usr/local/bin/cfssljson chmod +x /usr/local/bin/cfssljson \u751f\u6210 ImagePolicyWebhook \u6240\u7528\u7684\u8bc1\u4e66\uff1a cat <<EOF | cfssl genkey - | cfssljson -bare server { \"hosts\": [ \"wakanda.local\", \"wakanda.local.default.svc\", \"wakanda.local.default.svc.cluster.local\", \"wakanda.local.default.pod.cluster.local\" ], \"CN\": \"system:node:image-bouncer-webhook.default.pod.cluster.local\", \"key\": { \"algo\": \"ecdsa\", \"size\": 256 }, \"names\": [ { \"O\": \"system:nodes\" } ] } EOF \u521b\u5efa\u4e00\u4e2a CSR\uff1a cat <<EOF | kubectl apply -f - apiVersion: certificates.k8s.io/v1 kind: CertificateSigningRequest metadata: name: wakanda.local spec: request: $(cat server.csr | base64 | tr -d '\\n') signerName: kubernetes.io/kubelet-serving usages: - digital signature - key encipherment - server auth EOF kubectl get csr kubectl certificate approve wakanda.local kubectl get csr wakanda.local -o jsonpath='{.status.certificate}' | base64 --decode > server.crt cp server.crt /etc/kubernetes/pki/ echo \"127.0.0.1 wakanda.local\" >> /etc/hosts \u521b\u5efa\u51c6\u5165\u63a7\u5236\u5668\u7684\u914d\u7f6e\u6587\u4ef6\uff1a mkdir /etc/kubernetes/epconfig/ vim /etc/kubernetes/epconfig/admission_configuration.json { \"imagePolicy\": { \"kubeConfigFile\": \"/etc/kubernetes/epconfig/kubeconfig.yaml\", \"allowTTL\": 50, \"denyTTL\": 50, \"retryBackoff\": 500, \"defaultAllow\": true } } \u521b\u5efa kubeconfig\uff1a vim /etc/kubernetes/epconfig/kubeconfig.yaml apiVersion: v1 kind: Config clusters: - cluster: certificate-authority: /etc/kubernetes/pki/server.crt server: name: bouncer_webhook contexts: - context: cluster: bouncer_webhook user: api-server name: bouncer_validator current-context: bouncer_validator preferences: {} users: - name: api-server user: client-certificate: /etc/kubernetes/pki/apiserver.crt client-key: /etc/kubernetes/pki/apiserver.key \u5b89\u88c5 Docker\uff08https://docs.docker.com/engine/install/ubuntu/\uff09\uff1a apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null apt-get update -y apt-get install docker-ce docker-ce-cli \u542f\u52a8 ImagePolicyWebHook \u670d\u52a1\u5668\uff1a chmod 777 * docker run -tid --rm \\ -v `pwd`/server-key.pem:/certs/server-key.pem:ro \\ -v `pwd`/server.crt:/certs/server.crt:ro \\ -p 8082:1323 \\ registry.cn-beijing.aliyuncs.com/dotbalo/kube-image-bouncer \\ -k /certs/server-key.pem \\ -c /certs/server.crt mkdir /root/KSSC00202/ cat /root/KSSC00202/configuration-test.yml apiVersion: v1 kind: ReplicationController metadata: name: nginx-latest spec: replicas: 1 selector: app: nginx-latest template: metadata: name: nginx-latest labels: app: nginx-latest spec: containers: - name: nginx-latest image: nginx ports: - containerPort: 80","title":"\u6a21\u62df\u73af\u5883"},{"location":"cks/cks/#_35","text":"\u5207\u6362 Context \u540e\uff0cssh \u5230\u5bf9\u5e94\u7684 master \u8282\u70b9 \u5173\u95ed\u9ed8\u8ba4\u5141\u8bb8\uff1a vim /etc/kubernetes/epconfig/admission_configuration.json 'defaultAllow': false # \u5c06true \u6539\u6210 false \u914d\u7f6e Webhook \u5730\u5740\uff1a vim /etc/kubernetes/epconfig/kubeconfig.yaml apiVersion: v1 kind: Config clusters: - cluster: certificate-authority: /etc/kubernetes/pki/server.crt server: https://acme.local:8082/image_policy # \u589e\u52a0webhook server name: bouncer_webhook contexts: - context: cluster: bouncer_webhook user: api-server name: bouncer_validator current-context: bouncer_validator preferences: {} users: - name: api-server user: client-certificate: /etc/kubernetes/pki/apiserver.crt client-key: /etc/kubernetes/pki/apiserver.key - \u5f00\u542f ImagePolicyWebhook\uff1a vim /etc/kubernetes/manifests/kube-apiserver.yaml - --enable-admission-plugins=NodeRestriction,ImagePolicyWebhook - --admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json \u5728 volumeMounts \u589e\u52a0 volumeMounts: - mountPath: /etc/kubernetes/epconfig name: epconfig \u5728volumes \u589e\u52a0 volumes: - name: epconfig hostPath: path: /etc/kubernetes/epconfig \u91cd\u542fkubelet\u670d\u52a1 systemctl daemon-reload && systemctl restart kubelet","title":"\u8003\u9898\u89e3\u7b54"},{"location":"docker/docker-docs/","text":"Docker \u57fa\u672c\u7ba1\u7406 \u00b6 \u968f\u7740\u8ba1\u7b97\u673a\u8fd1\u51e0\u5341\u5e74\u7684\u84ec\u52c3\u53d1\u5c55\uff0c\u4ea7\u751f\u4e86\u5927\u91cf\u4f18\u79c0\u7cfb\u7edf\u548c\u8f6f\u4ef6\u3002\u8f6f\u4ef6\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u81ea\u7531\u9009\u62e9\u5404 \u79cd\u8f6f\u4ef6\u5e94\u7528\u3002\u4f46\u540c\u65f6\u5e26\u6765\u7684\u95ee\u9898\u5c31\u662f\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u975e\u5e38\u5e9e\u5927\u7684\u5f00\u53d1\u3001\u6d4b\u8bd5\u548c\u751f\u4ea7\u73af\u5883\u3002 \u9762\u5bf9\u8fd9\u79cd \u60c5\u51b5\uff0cDocker \u5bb9\u5668\u6280\u672f\u6a2a\u7a7a\u51fa\u4e16\uff0c\u63d0\u4f9b\u4e86\u7b80\u5355\u3001\u7075\u6d3b\u3001\u9ad8\u6548\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4e0d\u9700\u8981\u8fc7\u591a\u5730\u6539\u53d8\u73b0\u6709 \u7684\u4f7f\u7528\u4e60\u60ef\uff0c\u5c31\u53ef\u4ee5\u548c\u5df2\u6709\u7684\u5de5\u5177\uff0c\u5982 OpenStack \u7b49\u914d\u5408\u4f7f\u7528\u3002\u56e0\u6b64\uff0c\u638c\u63e1 Docker \u76f8\u5173\u6280\u672f\u4e5f\u662f \u9014\u7ecf\u4e91\u8ba1\u7b97\u7684\u5fc5\u7ecf\u4e4b\u8def\u3002 \u672c\u7ae0\u5c06\u4f9d\u6b21\u4ecb\u7ecd Docker \u7684\u4e09\u5927\u6838\u5fc3\u6982\u5ff5\u2014\u2014\u955c\u50cf\u3001\u5bb9\u5668\u3001\u4ed3\u5e93\uff0c\u4ee5\u53ca\u5b89\u88c5 Docker \u4e0e\u4ecb\u7ecd\u56f4 \u7ed5\u955c\u50cf\u548c\u5bb9\u5668\u7684\u5177\u4f53\u64cd\u4f5c\u3002 1.1 Docker \u6982\u8ff0 \u00b6 \u56e0\u4e3a Docker \u8f7b\u4fbf\u3001\u5feb\u901f\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u4f7f\u5e94\u7528\u8fbe\u5230\u5feb\u901f\u8fed\u4ee3\u7684\u76ee\u7684\u3002\u6bcf\u6b21\u5c0f\u7684\u53d8\u66f4\uff0c\u9a6c\u4e0a\u5c31\u53ef \u4ee5\u770b\u5230\u6548\u679c\uff0c\u800c\u4e0d\u7528\u5c06\u82e5\u5e72\u4e2a\u5c0f\u53d8\u66f4\u79ef\u6512\u5230\u4e00\u5b9a\u7a0b\u5ea6\u518d\u53d8\u66f4\u3002\u6bcf\u6b21\u53d8\u66f4\u4e00\u5c0f\u90e8\u5206\u5176\u5b9e\u662f\u4e00\u79cd\u975e\u5e38\u5b89 \u5168\u7684\u65b9\u5f0f\uff0c\u5728\u5f00\u53d1\u73af\u5883\u4e2d\u80fd\u591f\u5feb\u901f\u63d0\u9ad8\u5de5\u4f5c\u6548\u7387\u3002 Docker \u5bb9\u5668\u80fd\u591f\u5e2e\u52a9\u5f00\u53d1\u4eba\u5458\u3001\u7cfb\u7edf\u7ba1\u7406\u5458\u3001\u8d28\u91cf\u7ba1\u7406\u548c\u7248\u672c\u63a7\u5236\u5de5\u7a0b\u5e08\u5728\u4e00\u4e2a\u751f\u4ea7\u73af\u8282\u4e2d \u4e00\u8d77\u534f\u540c\u5de5\u4f5c\u3002\u5236\u5b9a\u4e00\u5957\u5bb9\u5668\u6807\u51c6\u80fd\u591f\u4f7f\u7cfb\u7edf\u7ba1\u7406\u5458\u66f4\u6539\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u7a0b\u5e8f\u5458\u4e0d\u9700\u8981\u5173\u5fc3\u5bb9\u5668\u7684\u53d8 \u5316\uff0c\u800c\u66f4\u4e13\u6ce8\u81ea\u5df1\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u4ece\u800c\u9694\u79bb\u5f00\u4e86\u5f00\u53d1\u548c\u7ba1\u7406\uff0c\u7b80\u5316\u4e86\u5f00\u53d1\u548c\u90e8\u7f72\u7684\u6210\u672c\u3002 1.1.1 \u4ec0\u4e48\u662f Docker \u00b6 \u5982\u679c\u8981\u65b9\u4fbf\u7684\u521b\u5efa\u8fd0\u884c\u5728\u4e91\u5e73\u53f0\u4e0a\u7684\u5e94\u7528\uff0c\u5fc5\u987b\u8981\u8131\u79bb\u5e95\u5c42\u7684\u786c\u4ef6\uff0c\u540c\u65f6\u8fd8\u9700\u8981\u4efb\u4f55\u65f6 \u95f4\u5730 \u70b9\u53ef\u83b7\u53d6\u8fd9\u4e9b\u8d44\u6e90\uff0c\u8fd9\u6b63\u662f Docker \u6240\u80fd\u63d0\u4f9b\u7684\u3002Docker \u7684\u5bb9\u5668\u6280\u672f\u53ef\u4ee5\u5728\u4e00\u53f0\u4e3b\u673a\u4e0a\u8f7b\u677e\u4e3a\u4efb\u4f55 \u5e94\u7528\u521b\u5efa\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u3001\u53ef\u79fb\u690d\u7684\u3001\u81ea\u7ed9\u81ea\u8db3\u7684\u5bb9\u5668\u3002\u901a\u8fc7\u8fd9\u79cd\u5bb9\u5668\u6253\u5305\u5e94\u7528\u7a0b\u5e8f\uff0c\u610f\u5473\u7740\u7b80\u5316\u4e86 \u91cd\u65b0\u90e8\u7f72\u3001\u8c03\u8bd5\u8fd9\u4e9b\u7410\u788e\u7684\u91cd\u590d\u5de5\u4f5c\uff0c\u6781\u5927\u7684\u63d0\u9ad8\u4e86\u5de5\u4f5c\u6548\u7387\u3002 1.1.2 Docker \u7684\u4f18\u52bf \u00b6 Docker \u5bb9\u5668\u8fd0\u884c\u901f\u5ea6\u5f88\u5feb\uff0c\u542f\u52a8\u548c\u505c\u6b62\u53ef\u4ee5\u5728\u79d2\u7ea7\u5b9e\u73b0\uff0c\u6bd4\u4f20\u7edf\u865a\u62df\u673a\u8981\u5feb\u5f88\u591a\uff1bDocker \u6838 \u5fc3\u89e3\u51b3\u7684\u95ee\u9898\u662f\u5229\u7528\u5bb9\u5668\u6765\u5b9e\u73b0\u7c7b\u4f3c\u865a\u62df\u673a\u7684\u529f\u80fd\uff0c\u4ece\u800c\u5229\u7528\u66f4\u52a0\u8282\u7701\u7684\u786c\u4ef6\u8d44\u6e90\u63d0\u4f9b\u7ed9\u7528\u6237\u66f4\u591a \u7684\u8ba1\u7b97\u8d44\u6e90\u3002\u56e0\u6b64\uff0cDocker \u5bb9\u5668\u9664\u4e86\u8fd0\u884c\u5176\u4e2d\u7684\u5e94\u7528\u4e4b\u5916\uff0c\u57fa\u672c\u4e0d\u6d88\u8017\u989d\u5916\u7684\u7cfb\u7edf\u8d44\u6e90\uff0c\u5728\u4fdd\u8bc1 \u5e94\u7528\u6027\u80fd\u7684\u540c\u65f6\uff0c\u53c8\u51cf\u5c0f\u4e86\u7cfb\u7edf\u5f00\u9500\uff0c\u4f7f\u5f97\u4e00\u53f0\u4e3b\u673a\u4e0a\u540c\u65f6\u8fd0\u884c\u6570\u5343\u4e2a Docker \u5bb9\u5668\u6210\u4e3a\u53ef\u80fd\u3002 Docker \u64cd\u4f5c\u65b9\u4fbf\uff0c\u53ef\u4ee5\u901a\u8fc7 Dockerfile \u914d\u7f6e\u6587\u4ef6\u652f\u6301\u7075\u6d3b\u7684\u81ea\u52a8\u5316\u521b\u5efa\u548c\u90e8\u7f72\u3002\u8868 1-1 \u5c06 Docker \u5bb9\u5668\u6280\u672f\u4e0e\u4f20\u7edf\u865a\u62df\u673a\u7684\u7279\u6027\u8fdb\u884c\u4e86\u6bd4\u8f83\u3002 \u4e2a\u4eba\u7406\u89e3: \u865a\u62df\u673a\u548c\u5bb9\u5668\u7684\u540c\u4e2a\u65f6\u4ee3\u7684\u4e0d\u540c\u4ea7\u7269 \u88681-1 Docker \u5bb9\u5668\u4e0e\u4f20\u7edf\u865a\u62df\u673a\u7684\u533a\u522b Docker \u4e4b\u6240\u4ee5\u62e5\u6709\u4f17\u591a\u4f18\u52bf\uff0c\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u865a\u62df\u5316\u81ea\u8eab\u7684\u7279\u70b9\u662f\u5206\u4e0d\u5f00\u7684\u3002\u4f20\u7edf\u865a\u62df\u673a\u9700\u8981\u6709 \u989d\u5916\u7684\u865a\u62df\u673a\u7ba1\u7406\u7a0b\u5e8f\u548c\u865a\u62df\u673a\u64cd\u4f5c\u7cfb\u7edf\u5c42\uff0c\u800c Docker \u5bb9\u5668\u5219\u662f\u76f4\u63a5\u5728\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u4e4b\u4e0a\u5b9e\u73b0\u7684 \u865a\u62df\u5316\u3002\u56fe 1.2 \u662f Docker \u4e0e\u4f20\u7edf\u865a\u62df\u673a\u67b6\u6784\u3002 1.1.3 \u955c\u50cf \u00b6 \u955c\u50cf\u3001\u5bb9\u5668\u3001\u4ed3\u5e93\u662f Docker \u7684\u4e09\u5927\u6838\u5fc3\u6982\u5ff5\u3002\u5176\u4e2d Docker \u7684\u955c\u50cf\u662f\u521b\u5efa\u5bb9\u5668\u7684\u57fa\u7840\uff0c\u7c7b\u4f3c\u865a\u62df\u673a\u7684\u5feb\u7167,\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u4e2a\u9762\u5411 Docker \u5bb9\u5668\u5f15\u64ce\u7684\u53ea\u8bfb\u6a21\u677f\u3002\u4f8b\u5982\uff1a\u4e00\u4e2a\u955c\u50cf\u53ef\u4ee5\u662f\u4e00\u4e2a\u5b8c\u6574 \u7684 Cent OS \u64cd\u4f5c\u7cfb\u7edf\u73af\u5883\uff0c\u79f0\u4e3a\u4e00\u4e2a CentOS \u955c\u50cf\uff1b\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a\u5b89\u88c5\u4e86 MySQL \u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u79f0\u4e4b\u4e3a\u4e00\u4e2a MySQL \u955c\u50cf\u7b49\u7b49\u3002 \u6240\u6709\u7684\u5bb9\u5668\u90fd\u662f\u57fa\u4e8e\u955c\u50cf\u6765\u5b9e\u73b0\u7684\uff5e\uff0c\u6240\u4ee5image \u5c31\u663e\u5f97\u5f88\u91cd\u8981\uff01\uff01\uff01 1.1.4 \u5bb9\u5668 \u00b6 Docker \u7684\u5bb9\u5668\u662f\u4ece\u955c\u50cf\u521b\u5efa\u7684\u8fd0\u884c\u5b9e\u4f8b\uff0c\u5b83\u53ef\u4ee5\u88ab\u542f\u52a8\u3001\u505c\u6b62\u548c\u5220\u9664\u3002\u6240\u521b\u5efa\u7684\u6bcf\u4e00\u4e2a\u5bb9\u5668 \u90fd\u662f\u76f8\u4e92\u9694\u79bb\u3001\u4e92\u4e0d\u53ef\u89c1\uff0c\u4ee5\u4fdd\u8bc1\u5b89\u5168\u6027\u7684\u5e73\u53f0\u3002\u53ef\u4ee5\u5c06\u5bb9\u5668\u770b\u4f5c\u662f\u4e00\u4e2a\u7b80\u6613\u7248\u7684 Linux \u73af\u5883\uff0c Docker \u5229\u7528\u5bb9\u5668\u6765\u8fd0\u884c\u548c\u9694\u79bb\u5e94\u7528\u3002 1.1.5 \u4ed3\u5e93 \u00b6 \u6709\u4e86\u955c\u50cf\uff0c\u5f53\u7136\u9700\u8981\u6709\u5b58\u653e\u4ed6\u7684\u5730\u65b9\uff0cDocker \u4ed3\u5e93\u5c31\u662f\u7528\u6765\u96c6\u4e2d\u4fdd\u5b58\u955c\u50cf\u7684\u5730\u65b9\uff0c\u5f53\u521b\u5efa\u4e86\u81ea\u5df1\u7684\u955c\u50cf\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 push \u547d\u4ee4\u5c06\u5b83 \u4e0a\u4f20\u5230\u516c\u6709\u4ed3\u5e93\uff08Public\uff09\u6216\u8005\u79c1\u6709\u4ed3\u5e93\uff08Private\uff09\u3002\u5f53\u4e0b\u6b21\u8981\u5728\u53e6\u5916\u4e00\u53f0\u673a\u5668\u4e0a\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf \u65f6\uff0c\u53ea\u9700\u4ece\u4ed3\u5e93\u83b7\u53d6\u3002 \u5e38\u89c1\u7684\u955c\u50cf\u4ed3\u5e93: \u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93 Ucloud \u955c\u50cf\u4ed3\u5e93 Harbor \u955c\u50cf\u4ed3\u5e93 docker hub (\u5b98\u65b9\u5e93) \u4ed3\u5e93\u6ce8\u518c\u670d\u52a1\u5668\uff08Registry\uff09\u662f\u5b58\u653e\u4ed3\u5e93\u7684\u5730\u65b9\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u591a\u4e2a\u4ed3\u5e93\u3002\u6bcf\u4e2a\u4ed3\u5e93\u96c6\u4e2d\u5b58\u653e\u67d0 \u4e00\u7c7b\u955c\u50cf\uff0c\u5e76\u4e14\u4f7f\u7528\u4e0d\u540c\u7684\u6807\u7b7e\uff08tag\uff09\u6765\u533a\u5206\u5b83\u4eec\u3002\u76ee\u524d\u6700\u5927\u7684\u516c\u5171\u4ed3\u5e93\u662f docker Hub\uff0c\u5b58\u653e\u4e86 \u6570\u91cf\u5e9e\u5927\u7684\u955c\u50cf\u4f9b\u7528\u6237\u4e0b\u8f7d\u4f7f\u7528\u3002 1.2 \u5b89\u88c5 Docker \u00b6 \u8fd9\u91cc\u4e3b\u8981\u4ecb\u7ecd\u5e38\u89c1\u7684\u51e0\u79cd\uff0cYUM\u9488\u5bf9\u4e8eCentos\u7cfb\u7edf\uff0cAPT\u9488\u5bf9\u4e8eubuntu\u7cfb\u7edf\uff0c\u811a\u672c\u5f0f\u5feb\u6377\u5b89\u88c5\u3002 \u652f\u6301\u7684\u5e73\u53f0: Docker Engine \u53ef\u901a\u8fc7 Docker Desktop \u5728\u5404\u79cdLinux \u5e73\u53f0\u3001 macOS\u548cWindows 10 \u4e0a\u4f7f\u7528\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f5c\u4e3a\u9759\u6001\u4e8c\u8fdb\u5236\u5b89\u88c5\u4f7f\u7528\u3002\u5728\u4e0b\u65b9\u627e\u5230\u60a8\u9996\u9009\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002 \u6e29\u99a8\u63d0\u793a \u8fd9\u91cc\u9762\u4e4b\u524d\u9047\u5230\u4e00\u4e2a\u5751\uff0c\u539f\u56e0\u5c31\u662f\u56e0\u4e3a\u6211\u4eec\u4f7f\u7528\u7684Mac\u529e\u516c\uff0cubuntu\u9700\u8981\u62c9\u4e0d\u6765\u955c\u50cf\uff0c\u9700\u8981Mac\u62c9\u597d\u4e0a\u4f20\u4e0a\u53bb\uff0c\u7ed3\u679cMac\u62c9\u7684\u7248\u672c\u662famd\u67b6\u6784\u7684\uff5e \u89e3\u51b3\u65b9\u6cd5: k8s.gcr.io/nfd/node-feature-discovery:v0.11.0 --platform linux/amd64 \u5b98\u7f51: https://docs.docker.com/engine/install/ 1.2.1 Apt \u65b9\u5f0f\u5b89\u88c5: \u00b6 \u79fb\u9664\u65e7docker\u5305 sudo apt-get remove docker docker-engine docker.io containerd runc \u8bbe\u7f6e\u5b58\u50a8\u5e93 \u66f4\u65b0apt\u5305\u7d22\u5f15\u5e76\u5b89\u88c5\u5305\u4ee5\u5141\u8bb8apt\u901a\u8fc7 HTTPS \u4f7f\u7528\u5b58\u50a8\u5e93\uff1a sudo apt-get update sudo apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release \u6dfb\u52a0 Docker \u7684\u5b98\u65b9 GPG \u5bc6\u94a5\uff1a sudo mkdir -p /etc/apt/keyrings curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8bbe\u7f6e\u5b58\u50a8\u5e93\uff1a echo \\ \"deb [arch= $( dpkg --print-architecture ) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\ $( lsb_release -cs ) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null \u5b89\u88c5docker sudo apt-get update sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin 1.2.2 YUM \u65b9\u5f0f\u5b89\u88c5: \u00b6 \u79fb\u9664\u65e7docker\u5305 sudo yum remove docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-engine \u914d\u7f6eYUM\u6e90 sudo yum install -y yum-utils sudo yum-config-manager \\ --add-repo \\ http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo \u5b89\u88c5docker-ce sudo yum install -y docker-ce docker-ce-cli containerd.io #\u4ee5\u4e0b\u662f\u5728\u5b89\u88c5k8s\u7684\u65f6\u5019\u4f7f\u7528 yum install -y docker-ce-20.10.7 docker-ce-cli-20.10.7 containerd.io-1.4.6 \u542f\u52a8 systemctl enable docker --now \u914d\u7f6e\u52a0\u901f sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json <<-'EOF' { \"registry-mirrors\": [\"https://82m9ar63.mirror.aliyuncs.com\"], \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"100m\" }, \"storage-driver\": \"overlay2\" } EOF sudo systemctl daemon-reload sudo systemctl restart docker 1.2.3 \u811a\u672c\u5f0f\u5b89\u88c5 \u00b6 \u5b98\u65b9\u63d0\u4f9b: curl -fsSL https://get.docker.com -o get-docker.sh sh get-docker.sh rancher\u63d0\u4f9b: curl https://releases.rancher.com/install-docker/19.03.sh | sh \u5b89\u88c5\u597d\u7684 Docker \u7cfb\u7edf\u6709\u4e24\u4e2a\u7a0b\u5e8f\uff0cDocker \u670d\u52a1\u7aef\u548c Docker \u5ba2\u6237\u7aef\u3002\u5176\u4e2d Docker \u670d\u52a1\u7aef\u662f \u4e00\u4e2a\u670d\u52a1\u8fdb\u7a0b\uff0c\u8d1f\u8d23\u7ba1\u7406\u6240\u6709\u5bb9\u5668\u3002Docker \u5ba2\u6237\u7aef\u5219\u626e\u6f14\u7740 Docker \u670d\u52a1\u7aef\u7684\u8fdc\u7a0b\u63a7\u5236\u5668\uff0c\u53ef\u4ee5\u7528 \u6765\u63a7\u5236 Docker \u7684\u670d\u52a1\u7aef\u8fdb\u7a0b\u3002\u5927\u90e8\u5206\u60c5\u51b5\u4e0b Docker \u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u8fd0\u884c\u5728\u4e00\u53f0\u673a\u5668\u4e0a\u3002 1.3 Docker \u955c\u50cf\u64cd\u4f5c \u00b6 \u8fd0\u884c Docker \u5bb9\u5668\u524d\u9700\u8981\u672c\u5730\u5b58\u5728\u5bf9\u5e94\u7684\u955c\u50cf\u3002\u5982\u679c\u4e0d\u5b58\u5728\u672c\u5730\u955c\u50cf\uff0cDocker \u5c31\u4f1a\u5c1d\u8bd5\u4ece\u9ed8\u8ba4 \u955c\u50cf\u4ed3\u5e93\u4e0b\u8f7d\u3002\u955c\u50cf\u4ed3\u5e93\u662f\u7531 Docker \u5b98\u65b9\u7ef4\u62a4\u7684\u4e00\u4e2a\u516c\u5171\u4ed3\u5e93\uff0c\u53ef\u4ee5\u6ee1\u8db3\u7528\u6237\u7684\u7edd\u5927\u90e8\u5206\u9700\u6c42\u3002 \u7528\u6237\u4e5f\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u6765\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u955c\u50cf\u4ed3\u5e93\u3002 \u5e2e\u52a9\u547d\u4ee4: [ ucloud ] root@master0:~# docker --help Usage: docker [ OPTIONS ] COMMAND A self-sufficient runtime for containers Options: --config string Location of client config files ( default \"/root/.docker\" ) -c, --context string Name of the context to use to connect to the daemon ( overrides DOCKER_HOST env var and default context set with \"docker context use\" ) -D, --debug Enable debug mode -H, --host list Daemon socket ( s ) to connect to -l, --log-level string Set the logging level ( \"debug\" | \"info\" | \"warn\" | \"error\" | \"fatal\" ) ( default \"info\" ) --tls Use TLS ; implied by --tlsverify --tlscacert string Trust certs signed only by this CA ( default \"/root/.docker/ca.pem\" ) --tlscert string Path to TLS certificate file ( default \"/root/.docker/cert.pem\" ) --tlskey string Path to TLS key file ( default \"/root/.docker/key.pem\" ) --tlsverify Use TLS and verify the remote -v, --version Print version information and quit \u7ba1\u7406CLI: [ ucloud ] root@master0:~# docker search nginx NAME DESCRIPTION STARS OFFICIAL AUTOMATED nginx Official build of Nginx. 17448 [ OK ] \u6267\u884c docker search lamp \u547d\u4ee4\u540e\uff0c\u8fd4\u56de\u5f88\u591a\u5305\u542b lamp \u5173\u952e\u5b57\u7684\u955c\u50cf\uff0c\u5176\u4e2d\u8fd4\u56de\u4fe1\u606f\u5305\u62ec\u955c\u50cf \u540d\u79f0\uff08NAME\uff09\u3001\u63cf\u8ff0\uff08DESCRIPTION\uff09\u3001\u661f\u7ea7\uff08STARS\uff09\u3001\u662f\u5426\u5b98\u65b9\u521b\u5efa\uff08OFFICIAL\uff09\u3001\u662f \u5426\u4e3b\u52a8\u521b\u5efa\uff08AUTOMATED\uff09\u3002\u9ed8\u8ba4\u7684\u8f93\u51fa\u7ed3\u679c\u4f1a\u6309\u7167\u661f\u7ea7\u8bc4\u4ef7\u8fdb\u884c\u6392\u5e8f\uff0c\u8868\u793a\u8be5\u955c\u50cf\u53d7\u6b22\u8fce\u7a0b \u5ea6\u3002\u5728\u4e0b\u8f7d\u955c\u50cf\u65f6\uff0c\u53ef\u4ee5\u53c2\u8003\u661f\u7ea7\u3002\u5728\u641c\u7d22\u65f6\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528-s \u6216\u8005--stars=x \u663e\u793a\u6307\u5b9a\u661f\u7ea7\u4ee5\u4e0a\u7684\u955c \u50cf\uff0c\u661f\u7ea7\u8d8a\u9ad8\u8868\u793a\u8d8a\u53d7\u6b22\u8fce\uff1b\u662f\u5426\u5b98\u65b9\u521b\u5efa\u662f\u6307\u662f\u5426\u662f\u7531\u5b98\u65b9\u9879\u76ee\u7ec4\u521b\u5efa\u548c\u7ef4\u62a4\u7684\u955c\u50cf\uff0c\u4e00\u822c\u5b98\u65b9\u9879\u76ee\u7ec4\u7ef4\u62a4\u7684\u955c\u50cf\u4f7f\u7528\u5355\u4e2a\u5355\u8bcd\u4f5c\u4e3a\u955c\u50cf\u540d\u79f0\uff0c\u79f0\u4e3a\u57fa\u7840\u955c\u50cf\u6216\u8005\u6839\u955c\u50cf\u3002\u50cf reinblau/lamp \u8fd9\u79cd \u547d\u540d\u65b9\u5f0f\u7684\u955c\u50cf\uff0c\u8868\u793a\u662f\u7531 docker Hub \u7684\u7528\u6237 reinblau \u521b\u5efa\u5e76\u7ef4\u62a4\u7684\u955c\u50cf\uff0c\u5e26\u6709\u7528\u6237\u540d\u4e3a\u524d\u7f00\uff1b \u662f\u5426\u4e3b\u52a8\u521b\u5efa\u662f\u6307\u662f\u5426\u5141\u8bb8\u7528\u6237\u9a8c\u8bc1\u955c\u50cf\u7684\u6765\u6e90\u548c\u5185\u5bb9\u3002 docker pull image-name //\u83b7\u53d6\u955c\u50cf docker push image-name //\u63a8\u9001\u955c\u50cf docker images //\u67e5\u770b\u955c\u50cf docker rm -f image-name //\u5f3a\u5236\u5220\u9664\u955c\u50cf docker images -aq //\u67e5\u770b\u6240\u6709\u955c\u50cfID docker save -o \u5b58\u50a8\u6587\u4ef6\u540d \u5b58\u50a8\u7684\u955c\u50cf\u540d //\u4fdd\u5b58\u955c\u50cf docker load < \u5b58\u50a8\u6587\u4ef6\u540d //\u5bfc\u5165\u955c\u50cf \u5bf9\u4e8e Docker \u955c\u50cf\u6765\u8bf4\uff0c\u5982\u679c\u4e0b\u8f7d\u955c\u50cf\u65f6\u4e0d\u6307\u5b9a\u6807\u7b7e\uff0c\u5219\u9ed8\u8ba4\u4f1a\u4e0b\u8f7d\u4ed3\u5e93\u4e2d\u6700\u65b0\u7248\u672c\u7684\u955c \u50cf\uff0c\u5373\u9009\u62e9\u6807\u7b7e\u4e3a latest \u6807\u7b7e\uff0c\u4e5f\u53ef\u901a\u8fc7\u6307\u5b9a\u7684\u6807\u7b7e\u6765\u4e0b\u8f7d\u7279\u5b9a\u7248\u672c\u7684\u67d0\u4e00\u955c\u50cf\u3002\u8fd9\u91cc\u6807\u7b7e \uff08tag\uff09\u5c31\u662f\u7528\u6765\u533a\u5206\u955c\u50cf\u7248\u672c\u7684\u3002 \u6e29\u99a8\u63d0\u793a \u5728\u767b\u9646ucloud\u7684\u955c\u50cf\u4ed3\u5e93\uff0c\u9700\u8981\u5c06\u5bc6\u7801\u7528''\u5f15\u8d77\u6765\uff0c\u4f8b\u5982: docker login -u user-name -p 'password' uhub.service.ucloud.cn 1.4 Docker \u5bb9\u5668\u64cd\u4f5c \u00b6 \u5bb9\u5668\u662f Docker \u7684\u53e6\u4e00\u4e2a\u6838\u5fc3\u6982\u5ff5\u3002\u7b80\u5355\u8bf4\uff0c\u5bb9\u5668\u662f\u955c\u50cf\u7684\u4e00\u4e2a\u8fd0\u884c\u5b9e\u4f8b\uff0c\u662f\u72ec\u7acb\u8fd0\u884c\u7684\u4e00\u4e2a \u6216\u4e00\u7ec4\u5e94\u7528\u4ee5\u53ca\u5b83\u4eec\u6240\u5fc5\u9700\u7684\u8fd0\u884c\u73af\u5883\uff0c\u5305\u62ec\u6587\u4ef6\u7cfb\u7edf\u3001\u7cfb\u7edf\u7c7b\u5e93\u3001shell \u73af\u5883\u7b49\u3002\u955c\u50cf\u662f\u53ea\u8bfb\u6a21 \u677f\uff0c\u800c\u5bb9\u5668\u4f1a\u7ed9\u8fd9\u4e2a\u53ea\u8bfb\u6a21\u677f\u6dfb\u52a0\u4e00\u4e2a\u989d\u5916\u7684\u53ef\u5199\u5c42\u3002 \u7ba1\u7406CLI: docker stop \u5bb9\u5668\u540d\u79f0/\u5bb9\u5668ID docker start \u5bb9\u5668\u540d\u79f0/\u5bb9\u5668ID docker restart \u5bb9\u5668\u540d\u79f0/\u5bb9\u5668ID docker ps -aq \u67e5\u770b\u6240\u6709\u5bb9\u5668ID docker export \u5bb9\u5668ID/\u540d\u79f0 > \u6587\u4ef6\u540d //\u5bb9\u5668\u5bfc\u51fa cat \u6587\u4ef6\u540d | docker import - \u751f\u6210\u7684\u955c\u50cf\u540d\u79f0:\u6807\u7b7e //\u5bb9\u5668\u5bfc\u5165 1.5 Docker \u955c\u50cf\u7ba1\u7406 \u00b6 Docker \u955c\u50cf\u9664\u4e86\u662f Docker \u7684\u6838\u5fc3\u6280\u672f\u4e4b\u5916\uff0c\u4e5f\u662f\u5e94\u7528\u53d1\u5e03\u7684\u6807\u51c6\u683c\u5f0f\u3002\u4e00\u4e2a\u5b8c\u6574\u7684 Docker \u955c\u50cf\u53ef\u4ee5\u652f\u6491\u4e00\u4e2a Docker \u5bb9\u5668\u7684\u8fd0\u884c\uff0c\u5728 Docker \u7684\u6574\u4e2a\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u5165\u4e00\u4e2a\u5df2\u7ecf\u5b9a\u578b\u7684\u5bb9\u5668\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u8fdb\u884c\u64cd\u4f5c\uff0c\u6700\u5e38\u89c1\u7684\u64cd\u4f5c\u5c31\u662f\u5728\u5bb9\u5668\u4e2d\u5b89\u88c5\u5e94\u7528\u670d\u52a1\u3002 \u5982\u679c\u8981\u628a\u5df2\u7ecf\u5b89\u88c5\u7684\u670d\u52a1\u8fdb\u884c\u8fc1\u79fb\uff0c\u5c31\u9700\u8981\u628a\u73af\u5883\u4ee5\u53ca\u642d\u5efa\u7684\u670d\u52a1\u751f\u6210\u65b0\u7684\u955c\u50cf\u3002\u672c\u6848\u4f8b\u5c06\u4ecb\u7ecd \u5982\u4f55\u521b\u5efa Docker \u955c\u50cf\u3002 1.5.1 Docker\u955c\u50cf\u7ed3\u6784 \u00b6 \u955c\u50cf\u4e0d\u662f\u4e00\u4e2a\u5355\u4e00\u7684\u6587\u4ef6\uff0c\u800c\u662f\u6709\u591a\u5c42\u6784\u6210\u3002\u53ef\u4ee5\u901a\u8fc7 docker history \u547d\u4ee4\u67e5\u770b\u955c\u50cf\u4e2d\u5404 \u5c42\u5185\u5bb9\u53ca\u5927\u5c0f\uff0c\u6bcf\u5c42\u5bf9\u5e94\u7740 Dockerfile \u4e2d\u7684\u4e00\u6761\u6307\u4ee4\u3002Docker \u955c\u50cf\u9ed8\u8ba4\u5b58\u50a8\u5728 /var/lib/docker/ \u76ee\u5f55\u4e2d\u3002\u5bb9\u5668\u5176\u5b9e\u662f\u5728\u955c\u50cf\u7684\u6700\u4e0a\u9762\u52a0\u4e86\u4e00\u5c42\u8bfb\u5199\u5c42\uff0c \u5728\u8fd0 \u884c\u5bb9\u5668\u91cc\u505a\u7684\u4efb\u4f55\u6587\u4ef6\u6539\u52a8\uff0c\u90fd\u4f1a\u5199\u5230\u8fd9\u4e2a\u8bfb\u5199\u5c42\u3002\u5982\u679c\u5220\u9664\u4e86\u5bb9\u5668\uff0c\u4e5f\u5c31\u5220\u9664\u4e86\u5176\u6700\u4e0a\u9762\u7684 \u8bfb\u5199\u5c42\uff0c\u6587\u4ef6\u6539\u52a8\u4e5f\u5c31\u4e22\u5931\u4e86\u3002Docker \u4f7f\u7528\u5b58\u50a8\u9a71\u52a8\u7ba1\u7406\u955c\u50cf\u6bcf\u5c42\u5185\u5bb9\u53ca\u53ef\u8bfb\u5199\u5c42\u7684\u5bb9\u5668 \u5c42\u3002Docker \u955c\u50cf\u662f\u5206\u5c42\u7684\uff0c\u4e0b\u9762\u8fd9\u4e9b\u77e5\u8bc6\u70b9\u975e\u5e38\u91cd\u8981\u3002 \uff081\uff09Dockerfile \u4e2d\u7684\u6bcf\u4e2a\u6307\u4ee4\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u5c42\uff1b \uff082\uff09\u955c\u50cf\u5c42\u5c06\u88ab\u7f13\u5b58\u548c\u590d\u7528\uff1b \uff083\uff09 \u5f53Dockerfile \u7684\u6307\u4ee4\u4fee\u6539\u4e86\uff0c\u590d\u5236\u7684\u6587\u4ef6\u53d8\u5316\u4e86\uff0c\u6216\u8005\u6784\u5efa\u955c\u50cf\u65f6\u6307\u5b9a\u7684\u53d8\u91cf\u4e0d\u540c \u4e86\uff0c\u5bf9\u5e94\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u5c31\u4f1a\u5931\u6548\uff1b \uff084\uff09\u67d0\u4e00\u5c42\u7684\u955c\u50cf\u7f13\u5b58\u5931\u6548\uff0c\u5b83\u4e4b\u540e\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u90fd\u4f1a\u5931\u6548\uff1b \uff085\uff09\u955c\u50cf\u5c42\u662f\u4e0d\u53ef\u53d8\u7684\uff0c\u5982\u679c\u5728\u67d0\u4e00\u5c42\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u5728\u4e0b\u4e00\u5c42\u4e2d\u5220\u9664\u5b83\uff0c\u5219\u955c \u50cf\u4e2d\u4f9d\u7136\u4f1a\u5305\u542b\u8be5\u6587\u4ef6\uff0c\u53ea\u662f\u8fd9\u4e2a\u6587\u4ef6\u5728 Docker \u5bb9\u5668\u4e2d\u4e0d\u53ef\u89c1\u4e86\u3002 1.5.2 Dockerfile\u4ecb\u7ecd \u00b6 Dockfile \u662f\u4e00\u79cd\u88ab Docker \u7a0b\u5e8f\u89e3\u91ca\u7684\u811a\u672c\uff0cDockerfile \u7531\u591a\u6761\u7684\u6307\u4ee4\u7ec4\u6210\uff0c\u6bcf\u6761\u6307\u4ee4\u5bf9 \u5e94Linux \u4e0b\u9762\u7684\u4e00\u6761\u547d\u4ee4\u3002Docker \u7a0b\u5e8f\u5c06\u8fd9\u4e9bDockerfile \u6307\u4ee4\u7ffb\u8bd1\u6210\u771f\u6b63\u7684Linux \u547d\u4ee4\u3002 Dockerfile \u6709\u81ea\u5df1\u4e66\u5199\u683c\u5f0f\u548c\u652f\u6301\u7684\u547d\u4ee4\uff0cDocker \u7a0b\u5e8f\u89e3\u51b3\u8fd9\u4e9b\u547d\u4ee4\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u7c7b\u4f3c\u4e8e Makefile\u3002Docker \u7a0b\u5e8f\u5c06\u8bfb\u53d6 Dockerfile\uff0c\u6839\u636e\u6307\u4ee4\u751f\u6210\u5b9a\u5236\u7684\u955c\u50cf\u3002\u76f8\u6bd4\u955c\u50cf\u8fd9\u79cd\u9ed1\u76d2\u5b50\uff0c Dockerfile \u8fd9\u79cd\u663e\u800c\u6613\u89c1\u7684\u811a\u672c\u66f4\u5bb9\u6613\u88ab\u4f7f\u7528\u8005\u63a5\u53d7\uff0c\u5b83\u660e\u786e\u7684\u8868\u660e\u955c\u50cf\u662f\u600e\u4e48\u4ea7\u751f\u7684\u3002\u6709\u4e86 Dockerfile\uff0c\u5f53\u6709\u5b9a\u5236\u989d\u5916\u7684\u9700\u6c42\u65f6\uff0c\u53ea\u9700\u5728 Dockerfile \u4e0a\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u6307\u4ee4\uff0c \u91cd\u65b0\u751f\u6210\u955c\u50cf\u3002 \u9644\u4ef6: \u00b6","title":"Docker \u57fa\u672c\u7ba1\u7406"},{"location":"docker/docker-docs/#docker","text":"\u968f\u7740\u8ba1\u7b97\u673a\u8fd1\u51e0\u5341\u5e74\u7684\u84ec\u52c3\u53d1\u5c55\uff0c\u4ea7\u751f\u4e86\u5927\u91cf\u4f18\u79c0\u7cfb\u7edf\u548c\u8f6f\u4ef6\u3002\u8f6f\u4ef6\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u81ea\u7531\u9009\u62e9\u5404 \u79cd\u8f6f\u4ef6\u5e94\u7528\u3002\u4f46\u540c\u65f6\u5e26\u6765\u7684\u95ee\u9898\u5c31\u662f\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u975e\u5e38\u5e9e\u5927\u7684\u5f00\u53d1\u3001\u6d4b\u8bd5\u548c\u751f\u4ea7\u73af\u5883\u3002 \u9762\u5bf9\u8fd9\u79cd \u60c5\u51b5\uff0cDocker \u5bb9\u5668\u6280\u672f\u6a2a\u7a7a\u51fa\u4e16\uff0c\u63d0\u4f9b\u4e86\u7b80\u5355\u3001\u7075\u6d3b\u3001\u9ad8\u6548\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4e0d\u9700\u8981\u8fc7\u591a\u5730\u6539\u53d8\u73b0\u6709 \u7684\u4f7f\u7528\u4e60\u60ef\uff0c\u5c31\u53ef\u4ee5\u548c\u5df2\u6709\u7684\u5de5\u5177\uff0c\u5982 OpenStack \u7b49\u914d\u5408\u4f7f\u7528\u3002\u56e0\u6b64\uff0c\u638c\u63e1 Docker \u76f8\u5173\u6280\u672f\u4e5f\u662f \u9014\u7ecf\u4e91\u8ba1\u7b97\u7684\u5fc5\u7ecf\u4e4b\u8def\u3002 \u672c\u7ae0\u5c06\u4f9d\u6b21\u4ecb\u7ecd Docker \u7684\u4e09\u5927\u6838\u5fc3\u6982\u5ff5\u2014\u2014\u955c\u50cf\u3001\u5bb9\u5668\u3001\u4ed3\u5e93\uff0c\u4ee5\u53ca\u5b89\u88c5 Docker \u4e0e\u4ecb\u7ecd\u56f4 \u7ed5\u955c\u50cf\u548c\u5bb9\u5668\u7684\u5177\u4f53\u64cd\u4f5c\u3002","title":"Docker \u57fa\u672c\u7ba1\u7406"},{"location":"docker/docker-docs/#11-docker","text":"\u56e0\u4e3a Docker \u8f7b\u4fbf\u3001\u5feb\u901f\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u4f7f\u5e94\u7528\u8fbe\u5230\u5feb\u901f\u8fed\u4ee3\u7684\u76ee\u7684\u3002\u6bcf\u6b21\u5c0f\u7684\u53d8\u66f4\uff0c\u9a6c\u4e0a\u5c31\u53ef \u4ee5\u770b\u5230\u6548\u679c\uff0c\u800c\u4e0d\u7528\u5c06\u82e5\u5e72\u4e2a\u5c0f\u53d8\u66f4\u79ef\u6512\u5230\u4e00\u5b9a\u7a0b\u5ea6\u518d\u53d8\u66f4\u3002\u6bcf\u6b21\u53d8\u66f4\u4e00\u5c0f\u90e8\u5206\u5176\u5b9e\u662f\u4e00\u79cd\u975e\u5e38\u5b89 \u5168\u7684\u65b9\u5f0f\uff0c\u5728\u5f00\u53d1\u73af\u5883\u4e2d\u80fd\u591f\u5feb\u901f\u63d0\u9ad8\u5de5\u4f5c\u6548\u7387\u3002 Docker \u5bb9\u5668\u80fd\u591f\u5e2e\u52a9\u5f00\u53d1\u4eba\u5458\u3001\u7cfb\u7edf\u7ba1\u7406\u5458\u3001\u8d28\u91cf\u7ba1\u7406\u548c\u7248\u672c\u63a7\u5236\u5de5\u7a0b\u5e08\u5728\u4e00\u4e2a\u751f\u4ea7\u73af\u8282\u4e2d \u4e00\u8d77\u534f\u540c\u5de5\u4f5c\u3002\u5236\u5b9a\u4e00\u5957\u5bb9\u5668\u6807\u51c6\u80fd\u591f\u4f7f\u7cfb\u7edf\u7ba1\u7406\u5458\u66f4\u6539\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u7a0b\u5e8f\u5458\u4e0d\u9700\u8981\u5173\u5fc3\u5bb9\u5668\u7684\u53d8 \u5316\uff0c\u800c\u66f4\u4e13\u6ce8\u81ea\u5df1\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u3002\u4ece\u800c\u9694\u79bb\u5f00\u4e86\u5f00\u53d1\u548c\u7ba1\u7406\uff0c\u7b80\u5316\u4e86\u5f00\u53d1\u548c\u90e8\u7f72\u7684\u6210\u672c\u3002","title":"1.1 Docker \u6982\u8ff0"},{"location":"docker/docker-docs/#111-docker","text":"\u5982\u679c\u8981\u65b9\u4fbf\u7684\u521b\u5efa\u8fd0\u884c\u5728\u4e91\u5e73\u53f0\u4e0a\u7684\u5e94\u7528\uff0c\u5fc5\u987b\u8981\u8131\u79bb\u5e95\u5c42\u7684\u786c\u4ef6\uff0c\u540c\u65f6\u8fd8\u9700\u8981\u4efb\u4f55\u65f6 \u95f4\u5730 \u70b9\u53ef\u83b7\u53d6\u8fd9\u4e9b\u8d44\u6e90\uff0c\u8fd9\u6b63\u662f Docker \u6240\u80fd\u63d0\u4f9b\u7684\u3002Docker \u7684\u5bb9\u5668\u6280\u672f\u53ef\u4ee5\u5728\u4e00\u53f0\u4e3b\u673a\u4e0a\u8f7b\u677e\u4e3a\u4efb\u4f55 \u5e94\u7528\u521b\u5efa\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u3001\u53ef\u79fb\u690d\u7684\u3001\u81ea\u7ed9\u81ea\u8db3\u7684\u5bb9\u5668\u3002\u901a\u8fc7\u8fd9\u79cd\u5bb9\u5668\u6253\u5305\u5e94\u7528\u7a0b\u5e8f\uff0c\u610f\u5473\u7740\u7b80\u5316\u4e86 \u91cd\u65b0\u90e8\u7f72\u3001\u8c03\u8bd5\u8fd9\u4e9b\u7410\u788e\u7684\u91cd\u590d\u5de5\u4f5c\uff0c\u6781\u5927\u7684\u63d0\u9ad8\u4e86\u5de5\u4f5c\u6548\u7387\u3002","title":"1.1.1 \u4ec0\u4e48\u662f Docker"},{"location":"docker/docker-docs/#112-docker","text":"Docker \u5bb9\u5668\u8fd0\u884c\u901f\u5ea6\u5f88\u5feb\uff0c\u542f\u52a8\u548c\u505c\u6b62\u53ef\u4ee5\u5728\u79d2\u7ea7\u5b9e\u73b0\uff0c\u6bd4\u4f20\u7edf\u865a\u62df\u673a\u8981\u5feb\u5f88\u591a\uff1bDocker \u6838 \u5fc3\u89e3\u51b3\u7684\u95ee\u9898\u662f\u5229\u7528\u5bb9\u5668\u6765\u5b9e\u73b0\u7c7b\u4f3c\u865a\u62df\u673a\u7684\u529f\u80fd\uff0c\u4ece\u800c\u5229\u7528\u66f4\u52a0\u8282\u7701\u7684\u786c\u4ef6\u8d44\u6e90\u63d0\u4f9b\u7ed9\u7528\u6237\u66f4\u591a \u7684\u8ba1\u7b97\u8d44\u6e90\u3002\u56e0\u6b64\uff0cDocker \u5bb9\u5668\u9664\u4e86\u8fd0\u884c\u5176\u4e2d\u7684\u5e94\u7528\u4e4b\u5916\uff0c\u57fa\u672c\u4e0d\u6d88\u8017\u989d\u5916\u7684\u7cfb\u7edf\u8d44\u6e90\uff0c\u5728\u4fdd\u8bc1 \u5e94\u7528\u6027\u80fd\u7684\u540c\u65f6\uff0c\u53c8\u51cf\u5c0f\u4e86\u7cfb\u7edf\u5f00\u9500\uff0c\u4f7f\u5f97\u4e00\u53f0\u4e3b\u673a\u4e0a\u540c\u65f6\u8fd0\u884c\u6570\u5343\u4e2a Docker \u5bb9\u5668\u6210\u4e3a\u53ef\u80fd\u3002 Docker \u64cd\u4f5c\u65b9\u4fbf\uff0c\u53ef\u4ee5\u901a\u8fc7 Dockerfile \u914d\u7f6e\u6587\u4ef6\u652f\u6301\u7075\u6d3b\u7684\u81ea\u52a8\u5316\u521b\u5efa\u548c\u90e8\u7f72\u3002\u8868 1-1 \u5c06 Docker \u5bb9\u5668\u6280\u672f\u4e0e\u4f20\u7edf\u865a\u62df\u673a\u7684\u7279\u6027\u8fdb\u884c\u4e86\u6bd4\u8f83\u3002 \u4e2a\u4eba\u7406\u89e3: \u865a\u62df\u673a\u548c\u5bb9\u5668\u7684\u540c\u4e2a\u65f6\u4ee3\u7684\u4e0d\u540c\u4ea7\u7269 \u88681-1 Docker \u5bb9\u5668\u4e0e\u4f20\u7edf\u865a\u62df\u673a\u7684\u533a\u522b Docker \u4e4b\u6240\u4ee5\u62e5\u6709\u4f17\u591a\u4f18\u52bf\uff0c\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u865a\u62df\u5316\u81ea\u8eab\u7684\u7279\u70b9\u662f\u5206\u4e0d\u5f00\u7684\u3002\u4f20\u7edf\u865a\u62df\u673a\u9700\u8981\u6709 \u989d\u5916\u7684\u865a\u62df\u673a\u7ba1\u7406\u7a0b\u5e8f\u548c\u865a\u62df\u673a\u64cd\u4f5c\u7cfb\u7edf\u5c42\uff0c\u800c Docker \u5bb9\u5668\u5219\u662f\u76f4\u63a5\u5728\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u4e4b\u4e0a\u5b9e\u73b0\u7684 \u865a\u62df\u5316\u3002\u56fe 1.2 \u662f Docker \u4e0e\u4f20\u7edf\u865a\u62df\u673a\u67b6\u6784\u3002","title":"1.1.2 Docker \u7684\u4f18\u52bf"},{"location":"docker/docker-docs/#113","text":"\u955c\u50cf\u3001\u5bb9\u5668\u3001\u4ed3\u5e93\u662f Docker \u7684\u4e09\u5927\u6838\u5fc3\u6982\u5ff5\u3002\u5176\u4e2d Docker \u7684\u955c\u50cf\u662f\u521b\u5efa\u5bb9\u5668\u7684\u57fa\u7840\uff0c\u7c7b\u4f3c\u865a\u62df\u673a\u7684\u5feb\u7167,\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u4e2a\u9762\u5411 Docker \u5bb9\u5668\u5f15\u64ce\u7684\u53ea\u8bfb\u6a21\u677f\u3002\u4f8b\u5982\uff1a\u4e00\u4e2a\u955c\u50cf\u53ef\u4ee5\u662f\u4e00\u4e2a\u5b8c\u6574 \u7684 Cent OS \u64cd\u4f5c\u7cfb\u7edf\u73af\u5883\uff0c\u79f0\u4e3a\u4e00\u4e2a CentOS \u955c\u50cf\uff1b\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a\u5b89\u88c5\u4e86 MySQL \u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u79f0\u4e4b\u4e3a\u4e00\u4e2a MySQL \u955c\u50cf\u7b49\u7b49\u3002 \u6240\u6709\u7684\u5bb9\u5668\u90fd\u662f\u57fa\u4e8e\u955c\u50cf\u6765\u5b9e\u73b0\u7684\uff5e\uff0c\u6240\u4ee5image \u5c31\u663e\u5f97\u5f88\u91cd\u8981\uff01\uff01\uff01","title":"1.1.3 \u955c\u50cf"},{"location":"docker/docker-docs/#114","text":"Docker \u7684\u5bb9\u5668\u662f\u4ece\u955c\u50cf\u521b\u5efa\u7684\u8fd0\u884c\u5b9e\u4f8b\uff0c\u5b83\u53ef\u4ee5\u88ab\u542f\u52a8\u3001\u505c\u6b62\u548c\u5220\u9664\u3002\u6240\u521b\u5efa\u7684\u6bcf\u4e00\u4e2a\u5bb9\u5668 \u90fd\u662f\u76f8\u4e92\u9694\u79bb\u3001\u4e92\u4e0d\u53ef\u89c1\uff0c\u4ee5\u4fdd\u8bc1\u5b89\u5168\u6027\u7684\u5e73\u53f0\u3002\u53ef\u4ee5\u5c06\u5bb9\u5668\u770b\u4f5c\u662f\u4e00\u4e2a\u7b80\u6613\u7248\u7684 Linux \u73af\u5883\uff0c Docker \u5229\u7528\u5bb9\u5668\u6765\u8fd0\u884c\u548c\u9694\u79bb\u5e94\u7528\u3002","title":"1.1.4 \u5bb9\u5668"},{"location":"docker/docker-docs/#115","text":"\u6709\u4e86\u955c\u50cf\uff0c\u5f53\u7136\u9700\u8981\u6709\u5b58\u653e\u4ed6\u7684\u5730\u65b9\uff0cDocker \u4ed3\u5e93\u5c31\u662f\u7528\u6765\u96c6\u4e2d\u4fdd\u5b58\u955c\u50cf\u7684\u5730\u65b9\uff0c\u5f53\u521b\u5efa\u4e86\u81ea\u5df1\u7684\u955c\u50cf\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 push \u547d\u4ee4\u5c06\u5b83 \u4e0a\u4f20\u5230\u516c\u6709\u4ed3\u5e93\uff08Public\uff09\u6216\u8005\u79c1\u6709\u4ed3\u5e93\uff08Private\uff09\u3002\u5f53\u4e0b\u6b21\u8981\u5728\u53e6\u5916\u4e00\u53f0\u673a\u5668\u4e0a\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf \u65f6\uff0c\u53ea\u9700\u4ece\u4ed3\u5e93\u83b7\u53d6\u3002 \u5e38\u89c1\u7684\u955c\u50cf\u4ed3\u5e93: \u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93 Ucloud \u955c\u50cf\u4ed3\u5e93 Harbor \u955c\u50cf\u4ed3\u5e93 docker hub (\u5b98\u65b9\u5e93) \u4ed3\u5e93\u6ce8\u518c\u670d\u52a1\u5668\uff08Registry\uff09\u662f\u5b58\u653e\u4ed3\u5e93\u7684\u5730\u65b9\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u591a\u4e2a\u4ed3\u5e93\u3002\u6bcf\u4e2a\u4ed3\u5e93\u96c6\u4e2d\u5b58\u653e\u67d0 \u4e00\u7c7b\u955c\u50cf\uff0c\u5e76\u4e14\u4f7f\u7528\u4e0d\u540c\u7684\u6807\u7b7e\uff08tag\uff09\u6765\u533a\u5206\u5b83\u4eec\u3002\u76ee\u524d\u6700\u5927\u7684\u516c\u5171\u4ed3\u5e93\u662f docker Hub\uff0c\u5b58\u653e\u4e86 \u6570\u91cf\u5e9e\u5927\u7684\u955c\u50cf\u4f9b\u7528\u6237\u4e0b\u8f7d\u4f7f\u7528\u3002","title":"1.1.5 \u4ed3\u5e93"},{"location":"docker/docker-docs/#12-docker","text":"\u8fd9\u91cc\u4e3b\u8981\u4ecb\u7ecd\u5e38\u89c1\u7684\u51e0\u79cd\uff0cYUM\u9488\u5bf9\u4e8eCentos\u7cfb\u7edf\uff0cAPT\u9488\u5bf9\u4e8eubuntu\u7cfb\u7edf\uff0c\u811a\u672c\u5f0f\u5feb\u6377\u5b89\u88c5\u3002 \u652f\u6301\u7684\u5e73\u53f0: Docker Engine \u53ef\u901a\u8fc7 Docker Desktop \u5728\u5404\u79cdLinux \u5e73\u53f0\u3001 macOS\u548cWindows 10 \u4e0a\u4f7f\u7528\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f5c\u4e3a\u9759\u6001\u4e8c\u8fdb\u5236\u5b89\u88c5\u4f7f\u7528\u3002\u5728\u4e0b\u65b9\u627e\u5230\u60a8\u9996\u9009\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002 \u6e29\u99a8\u63d0\u793a \u8fd9\u91cc\u9762\u4e4b\u524d\u9047\u5230\u4e00\u4e2a\u5751\uff0c\u539f\u56e0\u5c31\u662f\u56e0\u4e3a\u6211\u4eec\u4f7f\u7528\u7684Mac\u529e\u516c\uff0cubuntu\u9700\u8981\u62c9\u4e0d\u6765\u955c\u50cf\uff0c\u9700\u8981Mac\u62c9\u597d\u4e0a\u4f20\u4e0a\u53bb\uff0c\u7ed3\u679cMac\u62c9\u7684\u7248\u672c\u662famd\u67b6\u6784\u7684\uff5e \u89e3\u51b3\u65b9\u6cd5: k8s.gcr.io/nfd/node-feature-discovery:v0.11.0 --platform linux/amd64 \u5b98\u7f51: https://docs.docker.com/engine/install/","title":"1.2 \u5b89\u88c5 Docker"},{"location":"docker/docker-docs/#121-apt","text":"\u79fb\u9664\u65e7docker\u5305 sudo apt-get remove docker docker-engine docker.io containerd runc \u8bbe\u7f6e\u5b58\u50a8\u5e93 \u66f4\u65b0apt\u5305\u7d22\u5f15\u5e76\u5b89\u88c5\u5305\u4ee5\u5141\u8bb8apt\u901a\u8fc7 HTTPS \u4f7f\u7528\u5b58\u50a8\u5e93\uff1a sudo apt-get update sudo apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release \u6dfb\u52a0 Docker \u7684\u5b98\u65b9 GPG \u5bc6\u94a5\uff1a sudo mkdir -p /etc/apt/keyrings curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8bbe\u7f6e\u5b58\u50a8\u5e93\uff1a echo \\ \"deb [arch= $( dpkg --print-architecture ) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\ $( lsb_release -cs ) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null \u5b89\u88c5docker sudo apt-get update sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin","title":"1.2.1 Apt \u65b9\u5f0f\u5b89\u88c5:"},{"location":"docker/docker-docs/#122-yum","text":"\u79fb\u9664\u65e7docker\u5305 sudo yum remove docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-engine \u914d\u7f6eYUM\u6e90 sudo yum install -y yum-utils sudo yum-config-manager \\ --add-repo \\ http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo \u5b89\u88c5docker-ce sudo yum install -y docker-ce docker-ce-cli containerd.io #\u4ee5\u4e0b\u662f\u5728\u5b89\u88c5k8s\u7684\u65f6\u5019\u4f7f\u7528 yum install -y docker-ce-20.10.7 docker-ce-cli-20.10.7 containerd.io-1.4.6 \u542f\u52a8 systemctl enable docker --now \u914d\u7f6e\u52a0\u901f sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json <<-'EOF' { \"registry-mirrors\": [\"https://82m9ar63.mirror.aliyuncs.com\"], \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"100m\" }, \"storage-driver\": \"overlay2\" } EOF sudo systemctl daemon-reload sudo systemctl restart docker","title":"1.2.2 YUM \u65b9\u5f0f\u5b89\u88c5:"},{"location":"docker/docker-docs/#123","text":"\u5b98\u65b9\u63d0\u4f9b: curl -fsSL https://get.docker.com -o get-docker.sh sh get-docker.sh rancher\u63d0\u4f9b: curl https://releases.rancher.com/install-docker/19.03.sh | sh \u5b89\u88c5\u597d\u7684 Docker \u7cfb\u7edf\u6709\u4e24\u4e2a\u7a0b\u5e8f\uff0cDocker \u670d\u52a1\u7aef\u548c Docker \u5ba2\u6237\u7aef\u3002\u5176\u4e2d Docker \u670d\u52a1\u7aef\u662f \u4e00\u4e2a\u670d\u52a1\u8fdb\u7a0b\uff0c\u8d1f\u8d23\u7ba1\u7406\u6240\u6709\u5bb9\u5668\u3002Docker \u5ba2\u6237\u7aef\u5219\u626e\u6f14\u7740 Docker \u670d\u52a1\u7aef\u7684\u8fdc\u7a0b\u63a7\u5236\u5668\uff0c\u53ef\u4ee5\u7528 \u6765\u63a7\u5236 Docker \u7684\u670d\u52a1\u7aef\u8fdb\u7a0b\u3002\u5927\u90e8\u5206\u60c5\u51b5\u4e0b Docker \u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u8fd0\u884c\u5728\u4e00\u53f0\u673a\u5668\u4e0a\u3002","title":"1.2.3 \u811a\u672c\u5f0f\u5b89\u88c5"},{"location":"docker/docker-docs/#13-docker","text":"\u8fd0\u884c Docker \u5bb9\u5668\u524d\u9700\u8981\u672c\u5730\u5b58\u5728\u5bf9\u5e94\u7684\u955c\u50cf\u3002\u5982\u679c\u4e0d\u5b58\u5728\u672c\u5730\u955c\u50cf\uff0cDocker \u5c31\u4f1a\u5c1d\u8bd5\u4ece\u9ed8\u8ba4 \u955c\u50cf\u4ed3\u5e93\u4e0b\u8f7d\u3002\u955c\u50cf\u4ed3\u5e93\u662f\u7531 Docker \u5b98\u65b9\u7ef4\u62a4\u7684\u4e00\u4e2a\u516c\u5171\u4ed3\u5e93\uff0c\u53ef\u4ee5\u6ee1\u8db3\u7528\u6237\u7684\u7edd\u5927\u90e8\u5206\u9700\u6c42\u3002 \u7528\u6237\u4e5f\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u6765\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u955c\u50cf\u4ed3\u5e93\u3002 \u5e2e\u52a9\u547d\u4ee4: [ ucloud ] root@master0:~# docker --help Usage: docker [ OPTIONS ] COMMAND A self-sufficient runtime for containers Options: --config string Location of client config files ( default \"/root/.docker\" ) -c, --context string Name of the context to use to connect to the daemon ( overrides DOCKER_HOST env var and default context set with \"docker context use\" ) -D, --debug Enable debug mode -H, --host list Daemon socket ( s ) to connect to -l, --log-level string Set the logging level ( \"debug\" | \"info\" | \"warn\" | \"error\" | \"fatal\" ) ( default \"info\" ) --tls Use TLS ; implied by --tlsverify --tlscacert string Trust certs signed only by this CA ( default \"/root/.docker/ca.pem\" ) --tlscert string Path to TLS certificate file ( default \"/root/.docker/cert.pem\" ) --tlskey string Path to TLS key file ( default \"/root/.docker/key.pem\" ) --tlsverify Use TLS and verify the remote -v, --version Print version information and quit \u7ba1\u7406CLI: [ ucloud ] root@master0:~# docker search nginx NAME DESCRIPTION STARS OFFICIAL AUTOMATED nginx Official build of Nginx. 17448 [ OK ] \u6267\u884c docker search lamp \u547d\u4ee4\u540e\uff0c\u8fd4\u56de\u5f88\u591a\u5305\u542b lamp \u5173\u952e\u5b57\u7684\u955c\u50cf\uff0c\u5176\u4e2d\u8fd4\u56de\u4fe1\u606f\u5305\u62ec\u955c\u50cf \u540d\u79f0\uff08NAME\uff09\u3001\u63cf\u8ff0\uff08DESCRIPTION\uff09\u3001\u661f\u7ea7\uff08STARS\uff09\u3001\u662f\u5426\u5b98\u65b9\u521b\u5efa\uff08OFFICIAL\uff09\u3001\u662f \u5426\u4e3b\u52a8\u521b\u5efa\uff08AUTOMATED\uff09\u3002\u9ed8\u8ba4\u7684\u8f93\u51fa\u7ed3\u679c\u4f1a\u6309\u7167\u661f\u7ea7\u8bc4\u4ef7\u8fdb\u884c\u6392\u5e8f\uff0c\u8868\u793a\u8be5\u955c\u50cf\u53d7\u6b22\u8fce\u7a0b \u5ea6\u3002\u5728\u4e0b\u8f7d\u955c\u50cf\u65f6\uff0c\u53ef\u4ee5\u53c2\u8003\u661f\u7ea7\u3002\u5728\u641c\u7d22\u65f6\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528-s \u6216\u8005--stars=x \u663e\u793a\u6307\u5b9a\u661f\u7ea7\u4ee5\u4e0a\u7684\u955c \u50cf\uff0c\u661f\u7ea7\u8d8a\u9ad8\u8868\u793a\u8d8a\u53d7\u6b22\u8fce\uff1b\u662f\u5426\u5b98\u65b9\u521b\u5efa\u662f\u6307\u662f\u5426\u662f\u7531\u5b98\u65b9\u9879\u76ee\u7ec4\u521b\u5efa\u548c\u7ef4\u62a4\u7684\u955c\u50cf\uff0c\u4e00\u822c\u5b98\u65b9\u9879\u76ee\u7ec4\u7ef4\u62a4\u7684\u955c\u50cf\u4f7f\u7528\u5355\u4e2a\u5355\u8bcd\u4f5c\u4e3a\u955c\u50cf\u540d\u79f0\uff0c\u79f0\u4e3a\u57fa\u7840\u955c\u50cf\u6216\u8005\u6839\u955c\u50cf\u3002\u50cf reinblau/lamp \u8fd9\u79cd \u547d\u540d\u65b9\u5f0f\u7684\u955c\u50cf\uff0c\u8868\u793a\u662f\u7531 docker Hub \u7684\u7528\u6237 reinblau \u521b\u5efa\u5e76\u7ef4\u62a4\u7684\u955c\u50cf\uff0c\u5e26\u6709\u7528\u6237\u540d\u4e3a\u524d\u7f00\uff1b \u662f\u5426\u4e3b\u52a8\u521b\u5efa\u662f\u6307\u662f\u5426\u5141\u8bb8\u7528\u6237\u9a8c\u8bc1\u955c\u50cf\u7684\u6765\u6e90\u548c\u5185\u5bb9\u3002 docker pull image-name //\u83b7\u53d6\u955c\u50cf docker push image-name //\u63a8\u9001\u955c\u50cf docker images //\u67e5\u770b\u955c\u50cf docker rm -f image-name //\u5f3a\u5236\u5220\u9664\u955c\u50cf docker images -aq //\u67e5\u770b\u6240\u6709\u955c\u50cfID docker save -o \u5b58\u50a8\u6587\u4ef6\u540d \u5b58\u50a8\u7684\u955c\u50cf\u540d //\u4fdd\u5b58\u955c\u50cf docker load < \u5b58\u50a8\u6587\u4ef6\u540d //\u5bfc\u5165\u955c\u50cf \u5bf9\u4e8e Docker \u955c\u50cf\u6765\u8bf4\uff0c\u5982\u679c\u4e0b\u8f7d\u955c\u50cf\u65f6\u4e0d\u6307\u5b9a\u6807\u7b7e\uff0c\u5219\u9ed8\u8ba4\u4f1a\u4e0b\u8f7d\u4ed3\u5e93\u4e2d\u6700\u65b0\u7248\u672c\u7684\u955c \u50cf\uff0c\u5373\u9009\u62e9\u6807\u7b7e\u4e3a latest \u6807\u7b7e\uff0c\u4e5f\u53ef\u901a\u8fc7\u6307\u5b9a\u7684\u6807\u7b7e\u6765\u4e0b\u8f7d\u7279\u5b9a\u7248\u672c\u7684\u67d0\u4e00\u955c\u50cf\u3002\u8fd9\u91cc\u6807\u7b7e \uff08tag\uff09\u5c31\u662f\u7528\u6765\u533a\u5206\u955c\u50cf\u7248\u672c\u7684\u3002 \u6e29\u99a8\u63d0\u793a \u5728\u767b\u9646ucloud\u7684\u955c\u50cf\u4ed3\u5e93\uff0c\u9700\u8981\u5c06\u5bc6\u7801\u7528''\u5f15\u8d77\u6765\uff0c\u4f8b\u5982: docker login -u user-name -p 'password' uhub.service.ucloud.cn","title":"1.3 Docker \u955c\u50cf\u64cd\u4f5c"},{"location":"docker/docker-docs/#14-docker","text":"\u5bb9\u5668\u662f Docker \u7684\u53e6\u4e00\u4e2a\u6838\u5fc3\u6982\u5ff5\u3002\u7b80\u5355\u8bf4\uff0c\u5bb9\u5668\u662f\u955c\u50cf\u7684\u4e00\u4e2a\u8fd0\u884c\u5b9e\u4f8b\uff0c\u662f\u72ec\u7acb\u8fd0\u884c\u7684\u4e00\u4e2a \u6216\u4e00\u7ec4\u5e94\u7528\u4ee5\u53ca\u5b83\u4eec\u6240\u5fc5\u9700\u7684\u8fd0\u884c\u73af\u5883\uff0c\u5305\u62ec\u6587\u4ef6\u7cfb\u7edf\u3001\u7cfb\u7edf\u7c7b\u5e93\u3001shell \u73af\u5883\u7b49\u3002\u955c\u50cf\u662f\u53ea\u8bfb\u6a21 \u677f\uff0c\u800c\u5bb9\u5668\u4f1a\u7ed9\u8fd9\u4e2a\u53ea\u8bfb\u6a21\u677f\u6dfb\u52a0\u4e00\u4e2a\u989d\u5916\u7684\u53ef\u5199\u5c42\u3002 \u7ba1\u7406CLI: docker stop \u5bb9\u5668\u540d\u79f0/\u5bb9\u5668ID docker start \u5bb9\u5668\u540d\u79f0/\u5bb9\u5668ID docker restart \u5bb9\u5668\u540d\u79f0/\u5bb9\u5668ID docker ps -aq \u67e5\u770b\u6240\u6709\u5bb9\u5668ID docker export \u5bb9\u5668ID/\u540d\u79f0 > \u6587\u4ef6\u540d //\u5bb9\u5668\u5bfc\u51fa cat \u6587\u4ef6\u540d | docker import - \u751f\u6210\u7684\u955c\u50cf\u540d\u79f0:\u6807\u7b7e //\u5bb9\u5668\u5bfc\u5165","title":"1.4 Docker \u5bb9\u5668\u64cd\u4f5c"},{"location":"docker/docker-docs/#15-docker","text":"Docker \u955c\u50cf\u9664\u4e86\u662f Docker \u7684\u6838\u5fc3\u6280\u672f\u4e4b\u5916\uff0c\u4e5f\u662f\u5e94\u7528\u53d1\u5e03\u7684\u6807\u51c6\u683c\u5f0f\u3002\u4e00\u4e2a\u5b8c\u6574\u7684 Docker \u955c\u50cf\u53ef\u4ee5\u652f\u6491\u4e00\u4e2a Docker \u5bb9\u5668\u7684\u8fd0\u884c\uff0c\u5728 Docker \u7684\u6574\u4e2a\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u5165\u4e00\u4e2a\u5df2\u7ecf\u5b9a\u578b\u7684\u5bb9\u5668\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u8fdb\u884c\u64cd\u4f5c\uff0c\u6700\u5e38\u89c1\u7684\u64cd\u4f5c\u5c31\u662f\u5728\u5bb9\u5668\u4e2d\u5b89\u88c5\u5e94\u7528\u670d\u52a1\u3002 \u5982\u679c\u8981\u628a\u5df2\u7ecf\u5b89\u88c5\u7684\u670d\u52a1\u8fdb\u884c\u8fc1\u79fb\uff0c\u5c31\u9700\u8981\u628a\u73af\u5883\u4ee5\u53ca\u642d\u5efa\u7684\u670d\u52a1\u751f\u6210\u65b0\u7684\u955c\u50cf\u3002\u672c\u6848\u4f8b\u5c06\u4ecb\u7ecd \u5982\u4f55\u521b\u5efa Docker \u955c\u50cf\u3002","title":"1.5 Docker \u955c\u50cf\u7ba1\u7406"},{"location":"docker/docker-docs/#151-docker","text":"\u955c\u50cf\u4e0d\u662f\u4e00\u4e2a\u5355\u4e00\u7684\u6587\u4ef6\uff0c\u800c\u662f\u6709\u591a\u5c42\u6784\u6210\u3002\u53ef\u4ee5\u901a\u8fc7 docker history \u547d\u4ee4\u67e5\u770b\u955c\u50cf\u4e2d\u5404 \u5c42\u5185\u5bb9\u53ca\u5927\u5c0f\uff0c\u6bcf\u5c42\u5bf9\u5e94\u7740 Dockerfile \u4e2d\u7684\u4e00\u6761\u6307\u4ee4\u3002Docker \u955c\u50cf\u9ed8\u8ba4\u5b58\u50a8\u5728 /var/lib/docker/ \u76ee\u5f55\u4e2d\u3002\u5bb9\u5668\u5176\u5b9e\u662f\u5728\u955c\u50cf\u7684\u6700\u4e0a\u9762\u52a0\u4e86\u4e00\u5c42\u8bfb\u5199\u5c42\uff0c \u5728\u8fd0 \u884c\u5bb9\u5668\u91cc\u505a\u7684\u4efb\u4f55\u6587\u4ef6\u6539\u52a8\uff0c\u90fd\u4f1a\u5199\u5230\u8fd9\u4e2a\u8bfb\u5199\u5c42\u3002\u5982\u679c\u5220\u9664\u4e86\u5bb9\u5668\uff0c\u4e5f\u5c31\u5220\u9664\u4e86\u5176\u6700\u4e0a\u9762\u7684 \u8bfb\u5199\u5c42\uff0c\u6587\u4ef6\u6539\u52a8\u4e5f\u5c31\u4e22\u5931\u4e86\u3002Docker \u4f7f\u7528\u5b58\u50a8\u9a71\u52a8\u7ba1\u7406\u955c\u50cf\u6bcf\u5c42\u5185\u5bb9\u53ca\u53ef\u8bfb\u5199\u5c42\u7684\u5bb9\u5668 \u5c42\u3002Docker \u955c\u50cf\u662f\u5206\u5c42\u7684\uff0c\u4e0b\u9762\u8fd9\u4e9b\u77e5\u8bc6\u70b9\u975e\u5e38\u91cd\u8981\u3002 \uff081\uff09Dockerfile \u4e2d\u7684\u6bcf\u4e2a\u6307\u4ee4\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u5c42\uff1b \uff082\uff09\u955c\u50cf\u5c42\u5c06\u88ab\u7f13\u5b58\u548c\u590d\u7528\uff1b \uff083\uff09 \u5f53Dockerfile \u7684\u6307\u4ee4\u4fee\u6539\u4e86\uff0c\u590d\u5236\u7684\u6587\u4ef6\u53d8\u5316\u4e86\uff0c\u6216\u8005\u6784\u5efa\u955c\u50cf\u65f6\u6307\u5b9a\u7684\u53d8\u91cf\u4e0d\u540c \u4e86\uff0c\u5bf9\u5e94\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u5c31\u4f1a\u5931\u6548\uff1b \uff084\uff09\u67d0\u4e00\u5c42\u7684\u955c\u50cf\u7f13\u5b58\u5931\u6548\uff0c\u5b83\u4e4b\u540e\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u90fd\u4f1a\u5931\u6548\uff1b \uff085\uff09\u955c\u50cf\u5c42\u662f\u4e0d\u53ef\u53d8\u7684\uff0c\u5982\u679c\u5728\u67d0\u4e00\u5c42\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u5728\u4e0b\u4e00\u5c42\u4e2d\u5220\u9664\u5b83\uff0c\u5219\u955c \u50cf\u4e2d\u4f9d\u7136\u4f1a\u5305\u542b\u8be5\u6587\u4ef6\uff0c\u53ea\u662f\u8fd9\u4e2a\u6587\u4ef6\u5728 Docker \u5bb9\u5668\u4e2d\u4e0d\u53ef\u89c1\u4e86\u3002","title":"1.5.1 Docker\u955c\u50cf\u7ed3\u6784"},{"location":"docker/docker-docs/#152-dockerfile","text":"Dockfile \u662f\u4e00\u79cd\u88ab Docker \u7a0b\u5e8f\u89e3\u91ca\u7684\u811a\u672c\uff0cDockerfile \u7531\u591a\u6761\u7684\u6307\u4ee4\u7ec4\u6210\uff0c\u6bcf\u6761\u6307\u4ee4\u5bf9 \u5e94Linux \u4e0b\u9762\u7684\u4e00\u6761\u547d\u4ee4\u3002Docker \u7a0b\u5e8f\u5c06\u8fd9\u4e9bDockerfile \u6307\u4ee4\u7ffb\u8bd1\u6210\u771f\u6b63\u7684Linux \u547d\u4ee4\u3002 Dockerfile \u6709\u81ea\u5df1\u4e66\u5199\u683c\u5f0f\u548c\u652f\u6301\u7684\u547d\u4ee4\uff0cDocker \u7a0b\u5e8f\u89e3\u51b3\u8fd9\u4e9b\u547d\u4ee4\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u7c7b\u4f3c\u4e8e Makefile\u3002Docker \u7a0b\u5e8f\u5c06\u8bfb\u53d6 Dockerfile\uff0c\u6839\u636e\u6307\u4ee4\u751f\u6210\u5b9a\u5236\u7684\u955c\u50cf\u3002\u76f8\u6bd4\u955c\u50cf\u8fd9\u79cd\u9ed1\u76d2\u5b50\uff0c Dockerfile \u8fd9\u79cd\u663e\u800c\u6613\u89c1\u7684\u811a\u672c\u66f4\u5bb9\u6613\u88ab\u4f7f\u7528\u8005\u63a5\u53d7\uff0c\u5b83\u660e\u786e\u7684\u8868\u660e\u955c\u50cf\u662f\u600e\u4e48\u4ea7\u751f\u7684\u3002\u6709\u4e86 Dockerfile\uff0c\u5f53\u6709\u5b9a\u5236\u989d\u5916\u7684\u9700\u6c42\u65f6\uff0c\u53ea\u9700\u5728 Dockerfile \u4e0a\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u6307\u4ee4\uff0c \u91cd\u65b0\u751f\u6210\u955c\u50cf\u3002","title":"1.5.2 Dockerfile\u4ecb\u7ecd"},{"location":"docker/docker-docs/#_1","text":"","title":"\u9644\u4ef6:"},{"location":"docker/docker-image-clash-docs/","text":"Docker \u90e8\u7f72clash \u4ee3\u7406\u7ffb\u5899 \u00b6 \u51c6\u5907\u4e00\u4e2a docker-compose \u6587\u4ef6 $ cat docker-compose.yml version: '3' services: clash: container_name: clash_proxy image: centralx/clash:1.18.0 restart: always ports: - \"7890:7890\" - \"8090:80\" volumes: - ./config/clash/config.yaml:/home/runner/.config/clash/config.yaml \u83b7\u53d6clash config\u6587\u4ef6 Mac \u548c Windows \u83b7\u53d6\u65b9\u5f0f\u662f\u4e00\u81f4\u7684 Clash -- \u914d\u7f6e -- \u6587\u4ef6\uff08\u6bcf\u4e2a\u4eba\u7684\u914d\u7f6e\u6587\u4ef6\u90fd\u662f\u4e0d\u4e00\u6837\u7684\u3002\u6211\u7684\u6587\u4ef6\u662f\u4ee5\u4e0b\u622a\u56fe\u6240\u793a\uff09 \u5c06\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u4e00\u4e2a\u6587\u4ef6\u4e2d\uff0c\u5e76\u547d\u540d\u4e3aconfig.yaml cat config.yaml port: 7890 socks-port: 7891 allow-lan: true mode: rule log-level: info ipv6: true external-controller: :9090 secret: xxxxxxxxxxxxxxxxxx //\u9700\u8981\u6ce8\u610f\u8fd9\u4e00\u6bb5\u7684\u5185\u5bb9\u4e3a\u5bc6\u94a5\u3002\u5bb9\u5668\u8d77\u6765\u9700\u8981\u8f93\u5165 profile: store-selected: true ....... docker-compose \u542f\u52a8\u5bb9\u5668 [cpu] root@node5:/home/lixie/Docker-proxy-clash# tree . \u251c\u2500\u2500 config \u2502 \u2514\u2500\u2500 clash \u2502 \u2514\u2500\u2500 config.yaml \u251c\u2500\u2500 docker-compose.yml \u2514\u2500\u2500 run.sh 2 directories, 3 files $ docker-compose up -d \u6d4f\u89c8\u5668\u6d4b\u8bd5\u8bbf\u95ee\uff1a{IP-address:8090},\u8f93\u5165secret\u4e2d\u5bc6\u94a5\u3002 \u770b\u5230\u4ee5\u4e0a\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u7684\u5185\u5bb9\u4ee3\u7406\u8282\u70b9\u5c31\u641e\u5b9a\u4e86\u3002 \u6d4b\u8bd5 \u00b6 5.1 docker \u914d\u7f6e\u4ee3\u7406\u62c9\u955c\u50cf\u6d4b\u8bd5\u3002 [cpu] root@node5:/home/lixie/Docker-proxy-clash# cat /etc/docker/daemon.json { \"proxies\": { \"http-proxy\": \"http://10.0.10.158:7890\", \"https-proxy\": \"http://10.0.10.158:7890\", \"no-proxy\": \"*.test.example.com,.example.org,127.0.0.0/8\" }, \"default-ulimits\": { \"memlock\": { \"Hard\": 4294967296, \"Name\": \"memlock\", \"Soft\": 4294967296 }, \"nofile\": { \"Hard\": 1048576, \"Name\": \"nofile\", \"Soft\": 1048576 } }, \"exec-opts\": [ \"native.cgroupdriver=systemd\" ], \"insecure-registries\": [], \"log-driver\": \"json-file\", \"log-opts\": { \"max-file\": \"3\", \"max-size\": \"50m\" }, \"registry-mirrors\": [] } 5.2 linux \u914d\u7f6e\u4ee3\u7406 \u53ef\u4ee5\u5728 ~/.bash_profile \u5b9a\u4e49 proxy_on \u548c proxy_off \u51fd\u6570\uff0c\u7528\u4e8e\u5feb\u901f\u5f00\u542f\u548c\u5173\u95ed\u4ee3\u7406: function proxy_off() { unset no_proxy unset http_proxy unset https_proxy unset all_proxy echo -e \"Proxy Disabled\" } function proxy_on() { # CIDR \u7f51\u6bb5\u8868\u793a\u6cd5\u53ea\u5728\u90e8\u4efd\u53d7\u652f\u6301\u7684\u7a0b\u5e8f\u91cc\u8d77\u6548 # \u5982\u679c\u4e0d\u8d77\u6548\uff0c\u90a3\u4e48\u9700\u8981\u76f4\u63a5\u8bbe\u7f6e\u5177\u4f53\u7684 IP \u5730\u5740 export no_proxy=localhost,127.0.0.1,127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 export http_proxy=http://<host>:7890 export https_proxy=http://<host>:7890 export all_proxy=socks://<host>:7890 echo -e \"Proxy Enabled\" } \u6587\u732e\u53c2\u8003 \u00b6 https://hub.docker.com/r/centralx/clash","title":"docker Clash\u4ee3\u7406"},{"location":"docker/docker-image-clash-docs/#docker-clash","text":"\u51c6\u5907\u4e00\u4e2a docker-compose \u6587\u4ef6 $ cat docker-compose.yml version: '3' services: clash: container_name: clash_proxy image: centralx/clash:1.18.0 restart: always ports: - \"7890:7890\" - \"8090:80\" volumes: - ./config/clash/config.yaml:/home/runner/.config/clash/config.yaml \u83b7\u53d6clash config\u6587\u4ef6 Mac \u548c Windows \u83b7\u53d6\u65b9\u5f0f\u662f\u4e00\u81f4\u7684 Clash -- \u914d\u7f6e -- \u6587\u4ef6\uff08\u6bcf\u4e2a\u4eba\u7684\u914d\u7f6e\u6587\u4ef6\u90fd\u662f\u4e0d\u4e00\u6837\u7684\u3002\u6211\u7684\u6587\u4ef6\u662f\u4ee5\u4e0b\u622a\u56fe\u6240\u793a\uff09 \u5c06\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u4e00\u4e2a\u6587\u4ef6\u4e2d\uff0c\u5e76\u547d\u540d\u4e3aconfig.yaml cat config.yaml port: 7890 socks-port: 7891 allow-lan: true mode: rule log-level: info ipv6: true external-controller: :9090 secret: xxxxxxxxxxxxxxxxxx //\u9700\u8981\u6ce8\u610f\u8fd9\u4e00\u6bb5\u7684\u5185\u5bb9\u4e3a\u5bc6\u94a5\u3002\u5bb9\u5668\u8d77\u6765\u9700\u8981\u8f93\u5165 profile: store-selected: true ....... docker-compose \u542f\u52a8\u5bb9\u5668 [cpu] root@node5:/home/lixie/Docker-proxy-clash# tree . \u251c\u2500\u2500 config \u2502 \u2514\u2500\u2500 clash \u2502 \u2514\u2500\u2500 config.yaml \u251c\u2500\u2500 docker-compose.yml \u2514\u2500\u2500 run.sh 2 directories, 3 files $ docker-compose up -d \u6d4f\u89c8\u5668\u6d4b\u8bd5\u8bbf\u95ee\uff1a{IP-address:8090},\u8f93\u5165secret\u4e2d\u5bc6\u94a5\u3002 \u770b\u5230\u4ee5\u4e0a\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u7684\u5185\u5bb9\u4ee3\u7406\u8282\u70b9\u5c31\u641e\u5b9a\u4e86\u3002","title":"Docker \u90e8\u7f72clash \u4ee3\u7406\u7ffb\u5899"},{"location":"docker/docker-image-clash-docs/#_1","text":"5.1 docker \u914d\u7f6e\u4ee3\u7406\u62c9\u955c\u50cf\u6d4b\u8bd5\u3002 [cpu] root@node5:/home/lixie/Docker-proxy-clash# cat /etc/docker/daemon.json { \"proxies\": { \"http-proxy\": \"http://10.0.10.158:7890\", \"https-proxy\": \"http://10.0.10.158:7890\", \"no-proxy\": \"*.test.example.com,.example.org,127.0.0.0/8\" }, \"default-ulimits\": { \"memlock\": { \"Hard\": 4294967296, \"Name\": \"memlock\", \"Soft\": 4294967296 }, \"nofile\": { \"Hard\": 1048576, \"Name\": \"nofile\", \"Soft\": 1048576 } }, \"exec-opts\": [ \"native.cgroupdriver=systemd\" ], \"insecure-registries\": [], \"log-driver\": \"json-file\", \"log-opts\": { \"max-file\": \"3\", \"max-size\": \"50m\" }, \"registry-mirrors\": [] } 5.2 linux \u914d\u7f6e\u4ee3\u7406 \u53ef\u4ee5\u5728 ~/.bash_profile \u5b9a\u4e49 proxy_on \u548c proxy_off \u51fd\u6570\uff0c\u7528\u4e8e\u5feb\u901f\u5f00\u542f\u548c\u5173\u95ed\u4ee3\u7406: function proxy_off() { unset no_proxy unset http_proxy unset https_proxy unset all_proxy echo -e \"Proxy Disabled\" } function proxy_on() { # CIDR \u7f51\u6bb5\u8868\u793a\u6cd5\u53ea\u5728\u90e8\u4efd\u53d7\u652f\u6301\u7684\u7a0b\u5e8f\u91cc\u8d77\u6548 # \u5982\u679c\u4e0d\u8d77\u6548\uff0c\u90a3\u4e48\u9700\u8981\u76f4\u63a5\u8bbe\u7f6e\u5177\u4f53\u7684 IP \u5730\u5740 export no_proxy=localhost,127.0.0.1,127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 export http_proxy=http://<host>:7890 export https_proxy=http://<host>:7890 export all_proxy=socks://<host>:7890 echo -e \"Proxy Enabled\" }","title":"\u6d4b\u8bd5"},{"location":"docker/docker-image-clash-docs/#_2","text":"https://hub.docker.com/r/centralx/clash","title":"\u6587\u732e\u53c2\u8003"},{"location":"docker/docker-images-docs/","text":"\u955c\u50cf\u6982\u8ff0 \u00b6 Docker \u955c\u50cf\u662fDocker\u5bb9\u5668\u6280\u672f\u4e2d\u7684\u6838\u5fc3\uff0c\u4e5f\u662f\u5e94\u7528\u6253\u5305\u6784\u5efa\u53d1\u5e03\u7684\u6807\u51c6\u683c\u5f0f\u3002\u4e00\u4e2a\u5b8c\u6574\u7684\u955c\u50cf\u53ef\u4ee5\u652f\u6491\u591a\u4e2a\u5bb9\u5668\u7684\u8fd0\u884c\uff0c\u5728Docker\u7684\u6574\u4e2a\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u5165\u4e00\u4e2a\u5df2\u7ecf\u5b9a\u578b\u7684\u5bb9\u5668\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u8fdb\u884c\u64cd\u4f5c\uff0c\u6700\u5e38\u89c1\u7684\u64cd\u4f5c\u5c31\u662f\u5728\u5bb9\u5668\u4e2d\u5b89\u88c5\u5e94\u7528\u670d\u52a1\u3002 \u5982\u679c\u60f3\u8981\u628a\u5df2\u7ecf\u5b89\u88c5\u7684\u670d\u52a1\u5bb9\u5668\u8fdb\u884c\u8fc1\u79fb\uff0c\u5c31\u9700\u8981\u628a\u73af\u5883\u4ee5\u53ca\u90e8\u7f72\u7684\u670d\u52a1\u751f\u6210\u65b0\u7684\u955c\u50cf\u3002 \u955c\u50cf\u6784\u5efa\u65b9\u5f0f \u00b6 1\u3001\u57fa\u4e8e\u5df2\u6709\u7684\u5bb9\u5668\u521b\u5efa\u955c\u50cf 2\u3001\u57fa\u4e8e\u672c\u5730\u6a21\u677f\u521b\u5efa\u955c\u50cf 3\u3001\u57fa\u4e8eDockerfile\u521b\u5efa\u955c\u50cf \u955c\u50cf\u6784\u5efa\u6848\u4f8b \u00b6 3.1\u3001\u57fa\u4e8e\u5df2\u6709\u5bb9\u5668\u521b\u5efa\u955c\u50cf \u57fa\u4e8e\u73b0\u6709\u955c\u50cf\u521b\u5efa\u4e3b\u8981\u4f7f\u7528 docker commit \u547d\u4ee4\uff0c\u5373\u628a\u4e00\u4e2a\u5bb9\u5668\u91cc\u9762\u8fd0\u884c\u7684\u7a0b\u5e8f\u4ee5\u53ca\u8be5\u7a0b\u5e8f\u7684\u8fd0\u884c\u73af\u5883\u6253\u5305\u8d77\u6765\u751f\u6210\u65b0\u7684\u955c\u50cf\u3002 \u547d\u4ee4\u683c\u5f0f\uff1a docker commit [\u9009\u9879] \u5bb9\u5668ID/\u540d\u79f0 \u4ed3\u5e93\u540d\u79f0:[\u6807\u7b7e] \u5e38\u7528\u9009\u9879\uff1a(-m \u8bf4\u660e\u4fe1\u606f\uff1b-a \u4f5c\u8005\u4fe1\u606f\uff1b-p \u751f\u6210\u8fc7\u7a0b\u4e2d\u505c\u6b62\u5bb9\u5668\u7684\u8fd0\u884c\u3002) \u9996\u5148\u542f\u52a8\u4e00\u4e2a\u955c\u50cf\uff0c\u5728\u5bb9\u5668\u91cc\u505a\u76f8\u5e94\u7684\u4fee\u6539\uff0c\u7136\u540e\u5c06\u4fee\u6539\u540e\u7684\u5bb9\u5668\u63d0\u4ea4\u4e3a\u65b0\u7684\u955c\u50cf\u3002\u9700\u8981\u8bb0\u4f4f\u8be5\u5bb9\u5668\u7684ID\u53f7\u3002 \u57fa\u4e8eDockerfile\u6784\u5efa\u955c\u50cf \u00b6 3.3.1\u3001Docker \u955c\u50cf\u7ed3\u6784 \u955c\u50cf\u5e76\u4e0d\u662f\u4e00\u4e2a\u5355\u4e00\u7684\u6587\u4ef6\uff0c\u800c\u662f\u7531\u591a\u5c42\u5806\u53e0\u6784\u6210\u3002\u53ef\u4ee5\u901a\u8fc7docker history \u547d\u4ee4\u67e5\u770b\u955c\u50cf\u4e2d\u5404\u5c42\u7684\u5185\u5bb9\u548c\u5927\u5c0f\uff0c\u6bcf\u5c42\u5bf9\u5e94\u7740Dockerfile \u6784\u5efa\u65f6\u7684\u4e00\u6761\u6307\u4ee4\u3002Docker\u955c\u50cf\u9ed8\u8ba4\u5b58\u50a8\u5728/var/lib/docker/ \u76ee\u5f55\u4e2d\u3002\u5bb9\u5668\u5176\u5b9e\u662f\u5728\u955c\u50cf\u7684\u6700\u4e0a\u9762\u52a0\u4e86\u4e00\u5c42\u8bfb\u5199\u5c42\uff0c\u5728\u8fd0\u884c\u5bb9\u5668\u4e2d\u505a\u7684\u4efb\u4f55\u6587\u4ef6\u6539\u52a8\uff0c\u6700\u7ec8\u90fd\u4f1a\u5199\u5230\u8fd9\u4e2a\u8bfb\u5199\u5c42\u3002\u5982\u679c\u5220\u9664\u4e86\u5bb9\u5668\uff0c\u4e5f\u5c31\u662f\u5220\u9664\u4e86\u8fd9\u4e2a\u8bfb\u5199\u5c42\uff0c\u6587\u4ef6\u6539\u52a8\u4e5f\u5c31\u4f1a\u4e22\u5931\u4e86\u3002Docker\u4f7f\u7528\u5b58\u50a8\u9a71\u52a8\u7ba1\u7406\u955c\u50cf\u6bcf\u5c42\u5185\u5bb9\u53ca\u53ef\u8bfb\u5199\u5c42\u7684\u5bb9\u5668\u5c42\u3002 Docker\u955c\u50cf\u7279\u70b9\uff1a Dockerfile\u4e2d\u7684\u6bcf\u4e2a\u6307\u4ee4\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u5c42\uff1b \u955c\u50cf\u5c42\u53ef\u4ee5\u88ab\u7f13\u5b58\u548c\u590d\u7528\uff1b \u5f53Dockerfile\u4e2d\u7684\u6307\u4ee4\u88ab\u4fee\u6539\u3001\u590d\u5236\u7684\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u6216\u8005\u6784\u5efa\u955c\u50cf\u65f6\u6307\u5b9a\u7684\u53d8\u91cf\u503c\u66f4\u6362\u4e86\uff0c\u90a3\u4e48\u5bf9\u5e94\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u4e5f\u5c06\u4f1a\u5931\u6548\uff1b \u67d0\u4e00\u5c42\u7684\u955c\u50cf\u7f13\u5b58\u5931\u6548\uff0c\u5b83\u4e4b\u540e\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u90fd\u4f1a\u5931\u6548\uff1b \u955c\u50cf\u5c42\u662f\u4e0d\u53ef\u53d8\u7684\uff0c\u5982\u679c\u5728\u67d0\u4e00\u5c42\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u5728\u67d0\u4e00\u5c42\u4e2d\u5220\u9664\u5b83\uff0c\u5219\u955c\u50cf\u4e2d\u4f9d\u7136\u4f1a\u5305\u542b\u8be5\u6587\u4ef6\uff0c\u53ea\u662f\u8fd9\u4e2a\u6587\u4ef6\u5728Docker\u5bb9\u5668\u4e2d\u4e0d\u53ef\u89c1\u4e86\u3002","title":"docker \u955c\u50cf\u6784\u5efa"},{"location":"docker/docker-images-docs/#_1","text":"Docker \u955c\u50cf\u662fDocker\u5bb9\u5668\u6280\u672f\u4e2d\u7684\u6838\u5fc3\uff0c\u4e5f\u662f\u5e94\u7528\u6253\u5305\u6784\u5efa\u53d1\u5e03\u7684\u6807\u51c6\u683c\u5f0f\u3002\u4e00\u4e2a\u5b8c\u6574\u7684\u955c\u50cf\u53ef\u4ee5\u652f\u6491\u591a\u4e2a\u5bb9\u5668\u7684\u8fd0\u884c\uff0c\u5728Docker\u7684\u6574\u4e2a\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u5165\u4e00\u4e2a\u5df2\u7ecf\u5b9a\u578b\u7684\u5bb9\u5668\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u8fdb\u884c\u64cd\u4f5c\uff0c\u6700\u5e38\u89c1\u7684\u64cd\u4f5c\u5c31\u662f\u5728\u5bb9\u5668\u4e2d\u5b89\u88c5\u5e94\u7528\u670d\u52a1\u3002 \u5982\u679c\u60f3\u8981\u628a\u5df2\u7ecf\u5b89\u88c5\u7684\u670d\u52a1\u5bb9\u5668\u8fdb\u884c\u8fc1\u79fb\uff0c\u5c31\u9700\u8981\u628a\u73af\u5883\u4ee5\u53ca\u90e8\u7f72\u7684\u670d\u52a1\u751f\u6210\u65b0\u7684\u955c\u50cf\u3002","title":"\u955c\u50cf\u6982\u8ff0"},{"location":"docker/docker-images-docs/#_2","text":"1\u3001\u57fa\u4e8e\u5df2\u6709\u7684\u5bb9\u5668\u521b\u5efa\u955c\u50cf 2\u3001\u57fa\u4e8e\u672c\u5730\u6a21\u677f\u521b\u5efa\u955c\u50cf 3\u3001\u57fa\u4e8eDockerfile\u521b\u5efa\u955c\u50cf","title":"\u955c\u50cf\u6784\u5efa\u65b9\u5f0f"},{"location":"docker/docker-images-docs/#_3","text":"3.1\u3001\u57fa\u4e8e\u5df2\u6709\u5bb9\u5668\u521b\u5efa\u955c\u50cf \u57fa\u4e8e\u73b0\u6709\u955c\u50cf\u521b\u5efa\u4e3b\u8981\u4f7f\u7528 docker commit \u547d\u4ee4\uff0c\u5373\u628a\u4e00\u4e2a\u5bb9\u5668\u91cc\u9762\u8fd0\u884c\u7684\u7a0b\u5e8f\u4ee5\u53ca\u8be5\u7a0b\u5e8f\u7684\u8fd0\u884c\u73af\u5883\u6253\u5305\u8d77\u6765\u751f\u6210\u65b0\u7684\u955c\u50cf\u3002 \u547d\u4ee4\u683c\u5f0f\uff1a docker commit [\u9009\u9879] \u5bb9\u5668ID/\u540d\u79f0 \u4ed3\u5e93\u540d\u79f0:[\u6807\u7b7e] \u5e38\u7528\u9009\u9879\uff1a(-m \u8bf4\u660e\u4fe1\u606f\uff1b-a \u4f5c\u8005\u4fe1\u606f\uff1b-p \u751f\u6210\u8fc7\u7a0b\u4e2d\u505c\u6b62\u5bb9\u5668\u7684\u8fd0\u884c\u3002) \u9996\u5148\u542f\u52a8\u4e00\u4e2a\u955c\u50cf\uff0c\u5728\u5bb9\u5668\u91cc\u505a\u76f8\u5e94\u7684\u4fee\u6539\uff0c\u7136\u540e\u5c06\u4fee\u6539\u540e\u7684\u5bb9\u5668\u63d0\u4ea4\u4e3a\u65b0\u7684\u955c\u50cf\u3002\u9700\u8981\u8bb0\u4f4f\u8be5\u5bb9\u5668\u7684ID\u53f7\u3002","title":"\u955c\u50cf\u6784\u5efa\u6848\u4f8b"},{"location":"docker/docker-images-docs/#dockerfile","text":"3.3.1\u3001Docker \u955c\u50cf\u7ed3\u6784 \u955c\u50cf\u5e76\u4e0d\u662f\u4e00\u4e2a\u5355\u4e00\u7684\u6587\u4ef6\uff0c\u800c\u662f\u7531\u591a\u5c42\u5806\u53e0\u6784\u6210\u3002\u53ef\u4ee5\u901a\u8fc7docker history \u547d\u4ee4\u67e5\u770b\u955c\u50cf\u4e2d\u5404\u5c42\u7684\u5185\u5bb9\u548c\u5927\u5c0f\uff0c\u6bcf\u5c42\u5bf9\u5e94\u7740Dockerfile \u6784\u5efa\u65f6\u7684\u4e00\u6761\u6307\u4ee4\u3002Docker\u955c\u50cf\u9ed8\u8ba4\u5b58\u50a8\u5728/var/lib/docker/ \u76ee\u5f55\u4e2d\u3002\u5bb9\u5668\u5176\u5b9e\u662f\u5728\u955c\u50cf\u7684\u6700\u4e0a\u9762\u52a0\u4e86\u4e00\u5c42\u8bfb\u5199\u5c42\uff0c\u5728\u8fd0\u884c\u5bb9\u5668\u4e2d\u505a\u7684\u4efb\u4f55\u6587\u4ef6\u6539\u52a8\uff0c\u6700\u7ec8\u90fd\u4f1a\u5199\u5230\u8fd9\u4e2a\u8bfb\u5199\u5c42\u3002\u5982\u679c\u5220\u9664\u4e86\u5bb9\u5668\uff0c\u4e5f\u5c31\u662f\u5220\u9664\u4e86\u8fd9\u4e2a\u8bfb\u5199\u5c42\uff0c\u6587\u4ef6\u6539\u52a8\u4e5f\u5c31\u4f1a\u4e22\u5931\u4e86\u3002Docker\u4f7f\u7528\u5b58\u50a8\u9a71\u52a8\u7ba1\u7406\u955c\u50cf\u6bcf\u5c42\u5185\u5bb9\u53ca\u53ef\u8bfb\u5199\u5c42\u7684\u5bb9\u5668\u5c42\u3002 Docker\u955c\u50cf\u7279\u70b9\uff1a Dockerfile\u4e2d\u7684\u6bcf\u4e2a\u6307\u4ee4\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u5c42\uff1b \u955c\u50cf\u5c42\u53ef\u4ee5\u88ab\u7f13\u5b58\u548c\u590d\u7528\uff1b \u5f53Dockerfile\u4e2d\u7684\u6307\u4ee4\u88ab\u4fee\u6539\u3001\u590d\u5236\u7684\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u6216\u8005\u6784\u5efa\u955c\u50cf\u65f6\u6307\u5b9a\u7684\u53d8\u91cf\u503c\u66f4\u6362\u4e86\uff0c\u90a3\u4e48\u5bf9\u5e94\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u4e5f\u5c06\u4f1a\u5931\u6548\uff1b \u67d0\u4e00\u5c42\u7684\u955c\u50cf\u7f13\u5b58\u5931\u6548\uff0c\u5b83\u4e4b\u540e\u7684\u955c\u50cf\u5c42\u7f13\u5b58\u90fd\u4f1a\u5931\u6548\uff1b \u955c\u50cf\u5c42\u662f\u4e0d\u53ef\u53d8\u7684\uff0c\u5982\u679c\u5728\u67d0\u4e00\u5c42\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u6587\u4ef6\uff0c\u7136\u540e\u5728\u67d0\u4e00\u5c42\u4e2d\u5220\u9664\u5b83\uff0c\u5219\u955c\u50cf\u4e2d\u4f9d\u7136\u4f1a\u5305\u542b\u8be5\u6587\u4ef6\uff0c\u53ea\u662f\u8fd9\u4e2a\u6587\u4ef6\u5728Docker\u5bb9\u5668\u4e2d\u4e0d\u53ef\u89c1\u4e86\u3002","title":"\u57fa\u4e8eDockerfile\u6784\u5efa\u955c\u50cf"},{"location":"docker/docker-proxy-docs/","text":"Docker proxy \u4ee3\u7406 pull \u56fd\u5916\u955c\u50cf \u00b6 \u9996\u5148\u9700\u8981\u4e00\u53f0\u53ef\u4ee5\u7ffb\u5899\u7684\u673a\u5668,\u8fd9\u8fb9\u5c31\u7528\u6211\u7684 Mac. docker proxy \u914d\u7f6e \u00b6 docker \u672c\u8eab\u662f\u652f\u6301\u5728 docker pull \u4f7f\u7528\u4ee3\u7406\u7684\uff0c\u90a3\u4e48\u914d\u4e2a\u4ee3\u7406\u4e0d\u4e45\u89e3\u51b3\u95ee\u9898\u4e86\u5417\u3002 \u9996\u5148 mkdir /etc/systemd/system/docker.service.d\u3002 \u7136\u540e\u521b\u5efa /etc/systemd/system/docker.service.d/http-proxy.conf\uff0c\u6dfb\u52a0\u5185\u5bb9\u5982\u4e0b\uff1a [ Service ] Environment = \"HTTP_PROXY=http://localhost:7890/\" Environment = \"HTTPS_PROXY=https:/locahost:7890/\" #Environment=\"NO_PROXY=localhost,.docker.io,.docker.com,.daocloud.io\" \u5f53\u7136\u8981\u4f7f\u7528\u81ea\u5df1\u7684 HTTP_PROXY \u548c HTTPS_PROXY\uff0c\u7136\u540e\u628a\u4e0d\u60f3\u4f7f\u7528\u4ee3\u7406\u7684\u57df\u540d\u6dfb\u52a0\u5230 NO_PROXY\uff0c\u5c24\u5176\u662f\u4f7f\u7528\u7684\u955c\u50cf\u57df\u540d\u548c docker.io \u5e94\u8be5\u8003\u8651\u5728\u5185\u3002 \u6700\u540e\u66f4\u65b0 systemctl \u5e76\u91cd\u542f\u670d\u52a1 $ systemctl daemon-reload $ systemctl restart docker pull \u4e00\u4e2a\u955c\u50cf\u6d4b\u8bd5\u4e00\u4e0b\uff1a docker pull k8s.gcr.io/kube-scheduler-amd64:v1.10.2 \u4e34\u65f6\u6d4b\u8bd5: http_proxy=http://localhost:7890 https_proxy=http://localhost:7890 curl google.com export http_proxy=http://localhost:7890 export https_proxy=http://localhost:7890 \u672c\u5730\u7aef\u53e3\u8f6c\u53d1: ssh -R 7890 :localhost:7890 \u4e3b\u673a \u955c\u50cf\u52a0\u901f \u00b6 \u5f88\u591a\u955c\u50cf\u90fd\u5728\u56fd\u5916\uff0c\u6bd4\u5982 gcr\u3002\u56fd\u5185\u4e0b\u8f7d\u5f88\u6162\uff0c\u9700\u8981\u52a0\u901f\u3002 DaoCloud \u4e3a\u6b64\u63d0\u4f9b\u4e86\u56fd\u5185\u955c\u50cf\u52a0\u901f\uff0c\u4fbf\u4e8e\u4ece\u56fd\u5185\u62c9\u53d6\u8fd9\u4e9b\u955c\u50cf\u3002 \u589e\u52a0\u524d\u7f00\uff08\u63a8\u8350\uff09\uff1a k8s.gcr.io/coredns/coredns => m.daocloud.io/k8s.gcr.io/coredns/coredns \u4fee\u6539\u955c\u50cf\u4ed3\u5e93\u7684\u524d\u7f00 k8s.gcr.io/coredns/coredns => k8s-gcr.m.daocloud.io/coredns/coredns \u53c2\u8003\u6587\u7ae0 \u00b6 https://docs.daocloud.io/community/mirror/","title":"docker proxy\u4ee3\u7406"},{"location":"docker/docker-proxy-docs/#docker-proxy-pull","text":"\u9996\u5148\u9700\u8981\u4e00\u53f0\u53ef\u4ee5\u7ffb\u5899\u7684\u673a\u5668,\u8fd9\u8fb9\u5c31\u7528\u6211\u7684 Mac.","title":"Docker proxy \u4ee3\u7406 pull \u56fd\u5916\u955c\u50cf"},{"location":"docker/docker-proxy-docs/#docker-proxy","text":"docker \u672c\u8eab\u662f\u652f\u6301\u5728 docker pull \u4f7f\u7528\u4ee3\u7406\u7684\uff0c\u90a3\u4e48\u914d\u4e2a\u4ee3\u7406\u4e0d\u4e45\u89e3\u51b3\u95ee\u9898\u4e86\u5417\u3002 \u9996\u5148 mkdir /etc/systemd/system/docker.service.d\u3002 \u7136\u540e\u521b\u5efa /etc/systemd/system/docker.service.d/http-proxy.conf\uff0c\u6dfb\u52a0\u5185\u5bb9\u5982\u4e0b\uff1a [ Service ] Environment = \"HTTP_PROXY=http://localhost:7890/\" Environment = \"HTTPS_PROXY=https:/locahost:7890/\" #Environment=\"NO_PROXY=localhost,.docker.io,.docker.com,.daocloud.io\" \u5f53\u7136\u8981\u4f7f\u7528\u81ea\u5df1\u7684 HTTP_PROXY \u548c HTTPS_PROXY\uff0c\u7136\u540e\u628a\u4e0d\u60f3\u4f7f\u7528\u4ee3\u7406\u7684\u57df\u540d\u6dfb\u52a0\u5230 NO_PROXY\uff0c\u5c24\u5176\u662f\u4f7f\u7528\u7684\u955c\u50cf\u57df\u540d\u548c docker.io \u5e94\u8be5\u8003\u8651\u5728\u5185\u3002 \u6700\u540e\u66f4\u65b0 systemctl \u5e76\u91cd\u542f\u670d\u52a1 $ systemctl daemon-reload $ systemctl restart docker pull \u4e00\u4e2a\u955c\u50cf\u6d4b\u8bd5\u4e00\u4e0b\uff1a docker pull k8s.gcr.io/kube-scheduler-amd64:v1.10.2 \u4e34\u65f6\u6d4b\u8bd5: http_proxy=http://localhost:7890 https_proxy=http://localhost:7890 curl google.com export http_proxy=http://localhost:7890 export https_proxy=http://localhost:7890 \u672c\u5730\u7aef\u53e3\u8f6c\u53d1: ssh -R 7890 :localhost:7890 \u4e3b\u673a","title":"docker proxy \u914d\u7f6e"},{"location":"docker/docker-proxy-docs/#_1","text":"\u5f88\u591a\u955c\u50cf\u90fd\u5728\u56fd\u5916\uff0c\u6bd4\u5982 gcr\u3002\u56fd\u5185\u4e0b\u8f7d\u5f88\u6162\uff0c\u9700\u8981\u52a0\u901f\u3002 DaoCloud \u4e3a\u6b64\u63d0\u4f9b\u4e86\u56fd\u5185\u955c\u50cf\u52a0\u901f\uff0c\u4fbf\u4e8e\u4ece\u56fd\u5185\u62c9\u53d6\u8fd9\u4e9b\u955c\u50cf\u3002 \u589e\u52a0\u524d\u7f00\uff08\u63a8\u8350\uff09\uff1a k8s.gcr.io/coredns/coredns => m.daocloud.io/k8s.gcr.io/coredns/coredns \u4fee\u6539\u955c\u50cf\u4ed3\u5e93\u7684\u524d\u7f00 k8s.gcr.io/coredns/coredns => k8s-gcr.m.daocloud.io/coredns/coredns","title":"\u955c\u50cf\u52a0\u901f"},{"location":"docker/docker-proxy-docs/#_2","text":"https://docs.daocloud.io/community/mirror/","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"error/centos-dns-error-docs/","text":"\u5728\u4f7f\u7528Centos \u90e8\u7f72k8s\u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u53d1\u73b0\u4e86\u4ee5\u4e0b\u8fd9\u4e2a\u62a5\u9519\uff0c\u65e0\u6cd5\u4fee\u6539/etc/resolv.conf \u6587\u4ef6 \u5373\u4f7f\u6211\u4eec\u4f7f\u7528\u7684\u662froot\u6743\u9650\u4e5f\u662f\u65e0\u6cd5\u5220\u9664\u5f88\u4fee\u6539\u8fd9\u4e2a\u6587\u4ef6\uff0c\u8fd9\u5c31\u8ba9\u4eba\u6478\u4e0d\u7740\u5934\u8111\u3002\u90a3\u4e48\u4e0b\u9762\u4ecb\u7ecd\u4e00\u79cd\u65b9\u5f0f\u6765\u8c03\u6574 \u64cd\u4f5c\u6b65\u9aa4 \u00b6 1.\u68c0\u67e5\u6587\u4ef6\u5c5e\u6027 sudo lsattr /etc/resolv.conf 2.\u5229\u7528 chattr \u5220\u9664\u6587\u4ef6\u5c5e\u6027 sudo chattr -a /etc/resolv.conf sudo chattr -i /etc/resolv.conf 3.\u8fd9\u6837\u5c31\u53ef\u4ee5\u6b63\u5e38\u7f16\u8f91\u6587\u4ef6\u4e86","title":"Centos dns error docs"},{"location":"error/centos-dns-error-docs/#_1","text":"1.\u68c0\u67e5\u6587\u4ef6\u5c5e\u6027 sudo lsattr /etc/resolv.conf 2.\u5229\u7528 chattr \u5220\u9664\u6587\u4ef6\u5c5e\u6027 sudo chattr -a /etc/resolv.conf sudo chattr -i /etc/resolv.conf 3.\u8fd9\u6837\u5c31\u53ef\u4ee5\u6b63\u5e38\u7f16\u8f91\u6587\u4ef6\u4e86","title":"\u64cd\u4f5c\u6b65\u9aa4"},{"location":"error/ceph-osd-error-docs/","text":"\u62a5\u9519\u63d0\u793a: \u00b6 Startup probe failed: ceph daemon health check failed with the following output: admin_socket: exception getting command descriptions: [Errno 2] No such file or directory \u8fd9\u4e2a\u62a5\u9519\u662f\u5728 ceph \u6dfb\u52a0 osd \u7684\u65f6\u5019\u53d1\u73b0\u7684,osd \u6b63\u597d\u4f7f\u7528\u662f\u6ca1\u6709\u95ee\u9898\u7684,\u4f46\u662f\u63a2\u6d4b\u662f\u4e00\u76f4\u5931\u8d25,\u5728\u76f8\u540c /var/run/ceph \u8def\u5f84\u4e0b osd-1 \u6ca1\u6709\u4ee5 .asok \u4e3a\u540e\u7f00","title":"Ceph osd error docs"},{"location":"error/ceph-osd-error-docs/#_1","text":"Startup probe failed: ceph daemon health check failed with the following output: admin_socket: exception getting command descriptions: [Errno 2] No such file or directory \u8fd9\u4e2a\u62a5\u9519\u662f\u5728 ceph \u6dfb\u52a0 osd \u7684\u65f6\u5019\u53d1\u73b0\u7684,osd \u6b63\u597d\u4f7f\u7528\u662f\u6ca1\u6709\u95ee\u9898\u7684,\u4f46\u662f\u63a2\u6d4b\u662f\u4e00\u76f4\u5931\u8d25,\u5728\u76f8\u540c /var/run/ceph \u8def\u5f84\u4e0b osd-1 \u6ca1\u6709\u4ee5 .asok \u4e3a\u540e\u7f00","title":"\u62a5\u9519\u63d0\u793a:"},{"location":"error/delete-prometheus-db/","text":"\u8bef\u5220\u9664\u76d1\u63a7\u6570\u636e \u00b6 \u4e8b\u60c5\u7ecf\u8fc7\u662fprometheus \u76d1\u63a7\u6570\u636e\u76d8\u8d85\u8fc790%\uff0c\u672c\u60f3\u6269\u5bb9\u4e00\u4e0b\u3002\u4e8e\u662fkubectl edit pvc \uff0c\u90a3\u4e48prometheus \u7684pv\u6210\u529f\u6269\u5bb9\uff0c\u4f46\u662fpvc\u8fd8\u662f\u4e4b\u524d\u7684\u5bb9\u91cf\u3002\u8fd9\u4e2a\u662f\u56e0\u4e3arook\u7248\u672c\u592a\u4f4e\u5bfc\u81f4\u7684 \u3002\u672c\u60f3\u5220\u9664pvc\u91cd\u5efa\u4e00\u4e0b\uff0c\u6ca1\u60f3\u5230\u5220\u9664pvc\u4e4b\u540e\u53d1\u73b0pv\u4e5f\u6ca1\u6709\u4e86\u3002 \u5982\u679cpv\u6ca1\u6709\u4e86\uff0c\u6570\u636e\u662f\u6062\u590d\u4e0d\u4e86\u7684 \u6ca1\u6709\u6ce8\u610fpv\u7684\u7b56\u7565\u662f\u5426\u4fdd\u7559 \u5f53\u65f6\u7684sc\u7b56\u7565\u662fRetain\uff0c\u4f46\u662f\u8fd9\u4e2a\u7b56\u7565\u5e94\u8be5\u662f\u540e\u6539\u7684\u3002\u4e4b\u524d\u7684\u4e8bdelete \u5982\u4f55\u89c4\u907f\u8fd9\u4e2a\u95ee\u9898\uff1f \u00b6 \u5982\u679cpv\u7684\u7b56\u7565\u4ecd\u7136\u662fdelete\uff0c\u90a3\u4e48\u5220\u9664\u91cd\u5efapvc\u5c31\u6709\u8bef\u5220\u9664\u7684\u98ce\u9669\u3002\u90a3\u4e48\u7ed3\u5c40\u529e\u6cd5\u5c31\u662f\u627e\u5230pvc\u5bf9\u4e8e\u7684pv\uff0c\u4fee\u6539pv\u7684\u7b56\u7565\u4e3aRetain \u8fd9\u4ef6\u4e8b\u4e5f\u8ba9\u6211\u77e5\u9053\uff0c\u518d\u505a\u4efb\u4f55\u5220\u9664\u64cd\u4f5c\u4e4b\u524d\uff0c\u4e00\u5b9a\u8981\u8fdb\u884c\u6570\u636e\u5907\u4efd\uff01","title":"\u8bef\u5220\u9664\u76d1\u63a7\u6570\u636e"},{"location":"error/delete-prometheus-db/#_1","text":"\u4e8b\u60c5\u7ecf\u8fc7\u662fprometheus \u76d1\u63a7\u6570\u636e\u76d8\u8d85\u8fc790%\uff0c\u672c\u60f3\u6269\u5bb9\u4e00\u4e0b\u3002\u4e8e\u662fkubectl edit pvc \uff0c\u90a3\u4e48prometheus \u7684pv\u6210\u529f\u6269\u5bb9\uff0c\u4f46\u662fpvc\u8fd8\u662f\u4e4b\u524d\u7684\u5bb9\u91cf\u3002\u8fd9\u4e2a\u662f\u56e0\u4e3arook\u7248\u672c\u592a\u4f4e\u5bfc\u81f4\u7684 \u3002\u672c\u60f3\u5220\u9664pvc\u91cd\u5efa\u4e00\u4e0b\uff0c\u6ca1\u60f3\u5230\u5220\u9664pvc\u4e4b\u540e\u53d1\u73b0pv\u4e5f\u6ca1\u6709\u4e86\u3002 \u5982\u679cpv\u6ca1\u6709\u4e86\uff0c\u6570\u636e\u662f\u6062\u590d\u4e0d\u4e86\u7684 \u6ca1\u6709\u6ce8\u610fpv\u7684\u7b56\u7565\u662f\u5426\u4fdd\u7559 \u5f53\u65f6\u7684sc\u7b56\u7565\u662fRetain\uff0c\u4f46\u662f\u8fd9\u4e2a\u7b56\u7565\u5e94\u8be5\u662f\u540e\u6539\u7684\u3002\u4e4b\u524d\u7684\u4e8bdelete","title":"\u8bef\u5220\u9664\u76d1\u63a7\u6570\u636e"},{"location":"error/delete-prometheus-db/#_2","text":"\u5982\u679cpv\u7684\u7b56\u7565\u4ecd\u7136\u662fdelete\uff0c\u90a3\u4e48\u5220\u9664\u91cd\u5efapvc\u5c31\u6709\u8bef\u5220\u9664\u7684\u98ce\u9669\u3002\u90a3\u4e48\u7ed3\u5c40\u529e\u6cd5\u5c31\u662f\u627e\u5230pvc\u5bf9\u4e8e\u7684pv\uff0c\u4fee\u6539pv\u7684\u7b56\u7565\u4e3aRetain \u8fd9\u4ef6\u4e8b\u4e5f\u8ba9\u6211\u77e5\u9053\uff0c\u518d\u505a\u4efb\u4f55\u5220\u9664\u64cd\u4f5c\u4e4b\u524d\uff0c\u4e00\u5b9a\u8981\u8fdb\u884c\u6570\u636e\u5907\u4efd\uff01","title":"\u5982\u4f55\u89c4\u907f\u8fd9\u4e2a\u95ee\u9898\uff1f"},{"location":"error/dev/","text":"Dev\u96c6\u7fa4\u95ee\u9898 \u00b6 rook-ceph\u96c6\u7fa4\u5d29\u6e83 \u73b0\u8c61: rook-ceph\u96c6\u7fa4\u9664\u4e86mon\uff0c\u6240\u6709pod\u7684\u72b6\u6001\u5904\u4e8eCrashLoopBackOff mgr \u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c operator\u7684log\u4e2d\u65e0\u660e\u663e\u62a5\u9519\uff0cceph-cluster-controller: failed to get ceph daemons versions, this typically happens during the first cluster initialization. failed to run 'ceph versions' mon \u88aboperator\u4e00\u5171\u8d77\u67654\u4e2adeploy \u9519\u8bef\u76f8\u4f3c\u5ea6: https://github.com/rook/rook/issues/6530 \u521d\u6b65\u6000\u7591\u662frook-ceph\u7684osd\u548c\u7cfb\u7edf\u78c1\u76d8\u4f7f\u7528\u5feb\u6ee1\u800c\u5bfc\u81f4\u7684\u96c6\u7fa4\u5d29\u6e83\uff0c\u53ea\u6709mon\u6b63\u5e38\uff0cmgr\u548cosd\u90fd\u5f02\u5e38 \u65e0\u6cd5\u6b63\u5e38running $ kubectl -n rook-ceph get pod -w ... rook-ceph-mgr-a-7fd6649d8c-jqvmv 0 /1 CrashLoopBackOff 35 20h rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:CrashLoopBackOff 1 6s rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:2/4 2 18s rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:Error 2 19s rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:CrashLoopBackOff 2 31s \u9996\u5148\u9700\u8981\u5c06\u96c6\u7fa4\u6062\u590d\u5230\u6b63\u5e38\u7684\u4e00\u4e2a\u72b6\u6001\uff0c\u8fd9\u91cc\u6709\u4e2a\u95ee\u9898\u5c31\u662fmon\u4e00\u4e2a\u5904\u4e8e\u4e00\u4e2a4\u526f\u672c\u7684\u72b6\u6001,\u6709\u4e00\u4e2a\u526f\u672c\u72b6\u6001\u5f02\u5e38 \u67e5\u770b\u5f02\u5e38\u72b6\u6001\u4e0bmon\u7684configmap,\u8fd9\u9700\u8981\u5c06\u5f02\u5e38\u7684\u90a3\u4e2apod\u7684\u6240\u6709\u914d\u7f6e\u5220\u9664 $ kg configmap rook-ceph-mon-endpoints -o yaml apiVersion : v1 data : csi-cluster-config-json : '[{\"clusterID\":\"rook-ceph\",\"monitors\":[\"10.0.0.225:6789\",\"10.0.0.10:6789\",\"10.0.0.79:6789\",\"10.0.0.225:6789\"]}]' data : c=10.0.0.10:6789,a=10.0.0.79:6789,p=10.0.0.225:6789,q=10.0.0.225:6789 mapping : '{\"node\":{\"a\":{\"Name\":\"node1\",\"Hostname\":\"node1\",\"Address\":\"10.0.0.79\"},\"c\":{\"Name\":\"node0\",\"Hostname\":\"node0\",\"Address\":\"10.0.0.10\"},\"p\":{\"Name\":\"master0\",\"Hostname\":\"master0\",\"Address\":\"10.0.0.225\"},\"q\":{\"Name\":\"master0\",\"Hostname\":\"master0\",\"Address\":\"10.0.0.225\"}}}' maxMonId : \"16\" kind : ConfigMap metadata : creationTimestamp : \"2020-12-16T18:00:19Z\" name : rook-ceph-mon-endpoints namespace : rook-ceph ownerReferences : - apiVersion : ceph.rook.io/v1 blockOwnerDeletion : true controller : true kind : CephCluster name : rook-ceph uid : ee10d125-4428-4e88-983a-53190bc3411c resourceVersion : \"555335505\" uid : 1ee20194-f90e-4736-8d7f-89ac0314556c \u7559\u4e0b\u4e09\u4e2a\u6b63\u5e38\u7684mon $ k get configmap rook-ceph-mon-endpoints -o yaml apiVersion : v1 data : csi-cluster-config-json : '[{\"clusterID\":\"rook-ceph\",\"monitors\":[\"10.0.0.225:6789\",\"10.0.0.10:6789\",\"10.0.0.79:6789\"]}]' data : q=10.0.0.225:6789,c=10.0.0.10:6789,a=10.0.0.79:6789 mapping : '{\"node\":{\"a\":{\"Name\":\"node1\",\"Hostname\":\"node1\",\"Address\":\"10.0.0.79\"},\"c\":{\"Name\":\"node0\",\"Hostname\":\"node0\",\"Address\":\"10.0.0.10\"},\"q\":{\"Name\":\"master0\",\"Hostname\":\"master0\",\"Address\":\"10.0.0.225\"}}}' maxMonId : \"16\" kind : ConfigMap metadata : creationTimestamp : \"2020-12-16T18:00:19Z\" name : rook-ceph-mon-endpoints namespace : rook-ceph ownerReferences : - apiVersion : ceph.rook.io/v1 blockOwnerDeletion : true controller : true kind : CephCluster name : rook-ceph uid : ee10d125-4428-4e88-983a-53190bc3411c resourceVersion : \"555840878\" uid : 1ee20194-f90e-4736-8d7f-89ac0314556c \u4fee\u6539\u5b8c\u6210\u53d1\u73b0mgr\u6b63\u5728\u6062\u590d\uff0c\u96c6\u7fa4\u7684\u72b6\u6001\u6162\u6162\u6062\u590d\u6b63\u5e38,\u4e00\u76f4\u7b49\u5230\u96c6\u7fa4\u6062\u590d\u6b63\u5e38\u3002\u8fd9\u65f6\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001 \u8fd8\u662f\u6709\u4e00\u4e9b\u5f02\u5e38\uff0c\u5927\u6982\u7684\u610f\u601d\u5c31\u662fmon-a\u6240\u5728\u7684\u673a\u5668\u7684\u7cfb\u7edf\u76d8\u5feb\u6ee1\u4e86 \u9700\u8981\u8fdb\u884c\u4e0b\u4e00\u6b65\uff0c\u6269\u5bb9\u7cfb\u7edf\u76d8\uff0c\u673a\u5668\u5728ucloud\u4e91\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u5728ui\u754c\u9762\u8fdb\u884c\u6269\u5bb9\uff0c\u8fd9\u91cc\u53ef\u4ee5\u53c2\u8003 Ucloud\u6269\u5bb9 Ubuntu\uff1a sudo apt-get install cloud-initramfs-growroot LANG=en_US.UTF-8 growpart /dev/vda 1 \u8fd9\u65f6\uff0c\u6211\u4eec\u518d\u8fdb\u884c\u67e5\u770b\u6211\u4eec\u7684ceph\u96c6\u7fa4 [ root@rook-ceph-tools-84fc455b76-5dlwr / ] # ceph -s cluster: id: fc55d844-ed6b-4c0b-9f0f-a6b453ffb9b6 health: HEALTH_WARN 1 pool ( s ) do not have an application enabled 2 pool ( s ) have no replicas configured services: mon: 3 daemons, quorum a,c,q ( age 20h ) mgr: a ( active, since 18h ) mds: myfs:1 { 0 = myfs-b = up:active } 1 up:standby-replay osd: 7 osds: 7 up ( since 18h ) , 7 in ( since 18h ) task status: scrub status: mds.myfs-a: idle mds.myfs-b: idle data: pools: 6 pools, 241 pgs objects: 369 .17k objects, 92 GiB usage: 181 GiB used, 259 GiB / 440 GiB avail pgs: 241 active+clean io: client: 3 .3 KiB/s rd, 9 .3 KiB/s wr, 3 op/s rd, 1 op/s wr","title":"Dev\u73af\u5883\u96c6\u7fa4"},{"location":"error/dev/#dev","text":"rook-ceph\u96c6\u7fa4\u5d29\u6e83 \u73b0\u8c61: rook-ceph\u96c6\u7fa4\u9664\u4e86mon\uff0c\u6240\u6709pod\u7684\u72b6\u6001\u5904\u4e8eCrashLoopBackOff mgr \u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c operator\u7684log\u4e2d\u65e0\u660e\u663e\u62a5\u9519\uff0cceph-cluster-controller: failed to get ceph daemons versions, this typically happens during the first cluster initialization. failed to run 'ceph versions' mon \u88aboperator\u4e00\u5171\u8d77\u67654\u4e2adeploy \u9519\u8bef\u76f8\u4f3c\u5ea6: https://github.com/rook/rook/issues/6530 \u521d\u6b65\u6000\u7591\u662frook-ceph\u7684osd\u548c\u7cfb\u7edf\u78c1\u76d8\u4f7f\u7528\u5feb\u6ee1\u800c\u5bfc\u81f4\u7684\u96c6\u7fa4\u5d29\u6e83\uff0c\u53ea\u6709mon\u6b63\u5e38\uff0cmgr\u548cosd\u90fd\u5f02\u5e38 \u65e0\u6cd5\u6b63\u5e38running $ kubectl -n rook-ceph get pod -w ... rook-ceph-mgr-a-7fd6649d8c-jqvmv 0 /1 CrashLoopBackOff 35 20h rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:CrashLoopBackOff 1 6s rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:2/4 2 18s rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:Error 2 19s rook-ceph-osd-0-58c8d8ccf8-96wtd 0 /1 Init:CrashLoopBackOff 2 31s \u9996\u5148\u9700\u8981\u5c06\u96c6\u7fa4\u6062\u590d\u5230\u6b63\u5e38\u7684\u4e00\u4e2a\u72b6\u6001\uff0c\u8fd9\u91cc\u6709\u4e2a\u95ee\u9898\u5c31\u662fmon\u4e00\u4e2a\u5904\u4e8e\u4e00\u4e2a4\u526f\u672c\u7684\u72b6\u6001,\u6709\u4e00\u4e2a\u526f\u672c\u72b6\u6001\u5f02\u5e38 \u67e5\u770b\u5f02\u5e38\u72b6\u6001\u4e0bmon\u7684configmap,\u8fd9\u9700\u8981\u5c06\u5f02\u5e38\u7684\u90a3\u4e2apod\u7684\u6240\u6709\u914d\u7f6e\u5220\u9664 $ kg configmap rook-ceph-mon-endpoints -o yaml apiVersion : v1 data : csi-cluster-config-json : '[{\"clusterID\":\"rook-ceph\",\"monitors\":[\"10.0.0.225:6789\",\"10.0.0.10:6789\",\"10.0.0.79:6789\",\"10.0.0.225:6789\"]}]' data : c=10.0.0.10:6789,a=10.0.0.79:6789,p=10.0.0.225:6789,q=10.0.0.225:6789 mapping : '{\"node\":{\"a\":{\"Name\":\"node1\",\"Hostname\":\"node1\",\"Address\":\"10.0.0.79\"},\"c\":{\"Name\":\"node0\",\"Hostname\":\"node0\",\"Address\":\"10.0.0.10\"},\"p\":{\"Name\":\"master0\",\"Hostname\":\"master0\",\"Address\":\"10.0.0.225\"},\"q\":{\"Name\":\"master0\",\"Hostname\":\"master0\",\"Address\":\"10.0.0.225\"}}}' maxMonId : \"16\" kind : ConfigMap metadata : creationTimestamp : \"2020-12-16T18:00:19Z\" name : rook-ceph-mon-endpoints namespace : rook-ceph ownerReferences : - apiVersion : ceph.rook.io/v1 blockOwnerDeletion : true controller : true kind : CephCluster name : rook-ceph uid : ee10d125-4428-4e88-983a-53190bc3411c resourceVersion : \"555335505\" uid : 1ee20194-f90e-4736-8d7f-89ac0314556c \u7559\u4e0b\u4e09\u4e2a\u6b63\u5e38\u7684mon $ k get configmap rook-ceph-mon-endpoints -o yaml apiVersion : v1 data : csi-cluster-config-json : '[{\"clusterID\":\"rook-ceph\",\"monitors\":[\"10.0.0.225:6789\",\"10.0.0.10:6789\",\"10.0.0.79:6789\"]}]' data : q=10.0.0.225:6789,c=10.0.0.10:6789,a=10.0.0.79:6789 mapping : '{\"node\":{\"a\":{\"Name\":\"node1\",\"Hostname\":\"node1\",\"Address\":\"10.0.0.79\"},\"c\":{\"Name\":\"node0\",\"Hostname\":\"node0\",\"Address\":\"10.0.0.10\"},\"q\":{\"Name\":\"master0\",\"Hostname\":\"master0\",\"Address\":\"10.0.0.225\"}}}' maxMonId : \"16\" kind : ConfigMap metadata : creationTimestamp : \"2020-12-16T18:00:19Z\" name : rook-ceph-mon-endpoints namespace : rook-ceph ownerReferences : - apiVersion : ceph.rook.io/v1 blockOwnerDeletion : true controller : true kind : CephCluster name : rook-ceph uid : ee10d125-4428-4e88-983a-53190bc3411c resourceVersion : \"555840878\" uid : 1ee20194-f90e-4736-8d7f-89ac0314556c \u4fee\u6539\u5b8c\u6210\u53d1\u73b0mgr\u6b63\u5728\u6062\u590d\uff0c\u96c6\u7fa4\u7684\u72b6\u6001\u6162\u6162\u6062\u590d\u6b63\u5e38,\u4e00\u76f4\u7b49\u5230\u96c6\u7fa4\u6062\u590d\u6b63\u5e38\u3002\u8fd9\u65f6\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001 \u8fd8\u662f\u6709\u4e00\u4e9b\u5f02\u5e38\uff0c\u5927\u6982\u7684\u610f\u601d\u5c31\u662fmon-a\u6240\u5728\u7684\u673a\u5668\u7684\u7cfb\u7edf\u76d8\u5feb\u6ee1\u4e86 \u9700\u8981\u8fdb\u884c\u4e0b\u4e00\u6b65\uff0c\u6269\u5bb9\u7cfb\u7edf\u76d8\uff0c\u673a\u5668\u5728ucloud\u4e91\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u5728ui\u754c\u9762\u8fdb\u884c\u6269\u5bb9\uff0c\u8fd9\u91cc\u53ef\u4ee5\u53c2\u8003 Ucloud\u6269\u5bb9 Ubuntu\uff1a sudo apt-get install cloud-initramfs-growroot LANG=en_US.UTF-8 growpart /dev/vda 1 \u8fd9\u65f6\uff0c\u6211\u4eec\u518d\u8fdb\u884c\u67e5\u770b\u6211\u4eec\u7684ceph\u96c6\u7fa4 [ root@rook-ceph-tools-84fc455b76-5dlwr / ] # ceph -s cluster: id: fc55d844-ed6b-4c0b-9f0f-a6b453ffb9b6 health: HEALTH_WARN 1 pool ( s ) do not have an application enabled 2 pool ( s ) have no replicas configured services: mon: 3 daemons, quorum a,c,q ( age 20h ) mgr: a ( active, since 18h ) mds: myfs:1 { 0 = myfs-b = up:active } 1 up:standby-replay osd: 7 osds: 7 up ( since 18h ) , 7 in ( since 18h ) task status: scrub status: mds.myfs-a: idle mds.myfs-b: idle data: pools: 6 pools, 241 pgs objects: 369 .17k objects, 92 GiB usage: 181 GiB used, 259 GiB / 440 GiB avail pgs: 241 active+clean io: client: 3 .3 KiB/s rd, 9 .3 KiB/s wr, 3 op/s rd, 1 op/s wr","title":"Dev\u96c6\u7fa4\u95ee\u9898"},{"location":"error/kubernetes-pvc-ubound-doc/","text":"kubernetes \u5347\u7ea7\u5bfc\u81f4pvc\u65e0\u6cd5Bound \u00b6 k8s v1.19 \u5347\u7ea7 k8s v1.20 rook-ceph:v1.0.3 \u62a5\u9519\u5185\u5bb9 \u00b6 \u4ee5\u4e0b\u62a5\u9519\u6765\u6e90\u4e8eceph-operator controller.go:1213 ] provision \"default/rbd-pvc\" class \"ceph-ext4\" : unexpected error getting claim reference: selfLink was empty, can 't make reference E0720 10:01:18.054984 7 controller.go:1213] provision \"default/admin-9ktquk6q7gew-scratch\" class \"ceph-ext4\": unexpected error getting claim reference: selfLink was empty, can' t make reference \u4fee\u590d\u65b9\u6cd5 \u00b6 \u8fd9\u4e2a\u9519\u8bef\u662f\u7531\u4e8e Kubernetes 1.20 \u7248\u672c\u4e2d\u9ed8\u8ba4\u7981\u7528\u4e86 selfLink \u3002\u8fd9\u662f\u4e00\u4e2a\u5df2\u77e5\u95ee\u9898\uff0c\u5e76\u4e14\u5df2\u7ecf\u5728 Rook \u7684\u66f4\u65b0\u7248\u672c\u4e2d\u4fee\u590d\u3002 selfLink \u662f Kubernetes \u5bf9\u8c61\u7684\u4e00\u4e2a\u5b57\u6bb5\uff0c\u7528\u4e8e\u8868\u793a\u8be5\u5bf9\u8c61\u7684 RESTful API \u8def\u5f84\u3002\u4f46\u662f\u7531\u4e8e\u4e00\u4e9b\u539f\u56e0\uff0cKubernetes 1.20 \u7248\u672c\u5f00\u59cb\u9ed8\u8ba4\u7981\u7528\u4e86\u8fd9\u4e2a\u5b57\u6bb5\u3002 \u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u65b9\u6cd5\u6709\u4e24\u79cd\uff1a \u66f4\u65b0 Rook/Ceph \u7248\u672c\uff1aRook \u7684\u66f4\u65b0\u7248\u672c\u5df2\u7ecf\u4fee\u590d\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u518d\u4f9d\u8d56 selfLink \u5b57\u6bb5\u3002\u5982\u679c\u53ef\u80fd\u7684\u8bdd\uff0c\u5efa\u8bae\u60a8\u66f4\u65b0 Rook/Ceph \u5230\u6700\u65b0\u7248\u672c\u3002 \u4e34\u65f6\u542f\u7528 selfLink \uff1a\u5982\u679c\u60a8\u4e0d\u80fd\u7acb\u5373\u66f4\u65b0 Rook/Ceph\uff0c\u53ef\u4ee5\u4e34\u65f6\u542f\u7528 selfLink \u3002\u5728 Kubernetes API \u670d\u52a1\u5668\u7684\u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0 --feature-gates=RemoveSelfLink=false \u3002\u4e0d\u8fc7\u8bf7\u6ce8\u610f\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u4e34\u65f6\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u56e0\u4e3a\u672a\u6765\u7684 Kubernetes \u7248\u672c\u53ef\u80fd\u4f1a\u5b8c\u5168\u79fb\u9664 selfLink \u3002 \u5728\u5e94\u7528\u4e0a\u8ff0\u4fee\u6539\u540e\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u91cd\u542f Kubernetes API \u670d\u52a1\u5668\u548c Rook/Ceph \u670d\u52a1\u3002","title":"Kubernetes pvc ubound"},{"location":"error/kubernetes-pvc-ubound-doc/#kubernetes-pvcbound","text":"k8s v1.19 \u5347\u7ea7 k8s v1.20 rook-ceph:v1.0.3","title":"kubernetes \u5347\u7ea7\u5bfc\u81f4pvc\u65e0\u6cd5Bound"},{"location":"error/kubernetes-pvc-ubound-doc/#_1","text":"\u4ee5\u4e0b\u62a5\u9519\u6765\u6e90\u4e8eceph-operator controller.go:1213 ] provision \"default/rbd-pvc\" class \"ceph-ext4\" : unexpected error getting claim reference: selfLink was empty, can 't make reference E0720 10:01:18.054984 7 controller.go:1213] provision \"default/admin-9ktquk6q7gew-scratch\" class \"ceph-ext4\": unexpected error getting claim reference: selfLink was empty, can' t make reference","title":"\u62a5\u9519\u5185\u5bb9"},{"location":"error/kubernetes-pvc-ubound-doc/#_2","text":"\u8fd9\u4e2a\u9519\u8bef\u662f\u7531\u4e8e Kubernetes 1.20 \u7248\u672c\u4e2d\u9ed8\u8ba4\u7981\u7528\u4e86 selfLink \u3002\u8fd9\u662f\u4e00\u4e2a\u5df2\u77e5\u95ee\u9898\uff0c\u5e76\u4e14\u5df2\u7ecf\u5728 Rook \u7684\u66f4\u65b0\u7248\u672c\u4e2d\u4fee\u590d\u3002 selfLink \u662f Kubernetes \u5bf9\u8c61\u7684\u4e00\u4e2a\u5b57\u6bb5\uff0c\u7528\u4e8e\u8868\u793a\u8be5\u5bf9\u8c61\u7684 RESTful API \u8def\u5f84\u3002\u4f46\u662f\u7531\u4e8e\u4e00\u4e9b\u539f\u56e0\uff0cKubernetes 1.20 \u7248\u672c\u5f00\u59cb\u9ed8\u8ba4\u7981\u7528\u4e86\u8fd9\u4e2a\u5b57\u6bb5\u3002 \u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u65b9\u6cd5\u6709\u4e24\u79cd\uff1a \u66f4\u65b0 Rook/Ceph \u7248\u672c\uff1aRook \u7684\u66f4\u65b0\u7248\u672c\u5df2\u7ecf\u4fee\u590d\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e0d\u518d\u4f9d\u8d56 selfLink \u5b57\u6bb5\u3002\u5982\u679c\u53ef\u80fd\u7684\u8bdd\uff0c\u5efa\u8bae\u60a8\u66f4\u65b0 Rook/Ceph \u5230\u6700\u65b0\u7248\u672c\u3002 \u4e34\u65f6\u542f\u7528 selfLink \uff1a\u5982\u679c\u60a8\u4e0d\u80fd\u7acb\u5373\u66f4\u65b0 Rook/Ceph\uff0c\u53ef\u4ee5\u4e34\u65f6\u542f\u7528 selfLink \u3002\u5728 Kubernetes API \u670d\u52a1\u5668\u7684\u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0 --feature-gates=RemoveSelfLink=false \u3002\u4e0d\u8fc7\u8bf7\u6ce8\u610f\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u4e34\u65f6\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u56e0\u4e3a\u672a\u6765\u7684 Kubernetes \u7248\u672c\u53ef\u80fd\u4f1a\u5b8c\u5168\u79fb\u9664 selfLink \u3002 \u5728\u5e94\u7528\u4e0a\u8ff0\u4fee\u6539\u540e\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u91cd\u542f Kubernetes API \u670d\u52a1\u5668\u548c Rook/Ceph \u670d\u52a1\u3002","title":"\u4fee\u590d\u65b9\u6cd5"},{"location":"error/test/","text":"-ceph-20 nvme12n1 7T bluestore Pod: rook-ceph-osd-21-7b5d57bcbd-h7qgk Node: stor1 -ceph-21 nvme16n1 7T bluestore Pod: rook-ceph-osd-22-8657cdb6b6-c97sz Node: stor1 -ceph-22 nvme11n1 7T bluestore Pod: rook-ceph-osd-23-666b65f64c-48mmc Node: stor1 -ceph-23 nvme10n1 7T bluestore Pod: rook-ceph-osd-24-7c794c87cd-gt5xv Node: stor1 -ceph-24 nvme14n1 7T bluestore Pod: rook-ceph-osd-25-5b795c76cf-sq8xp Node: stor1 -ceph-25 nvme4n1 7T bluestore Pod: rook-ceph-osd-26-75b94595f4-9bpjh Node: stor1 -ceph-26 nvme3n1 7T bluestore Pod: rook-ceph-osd-27-8547985d45-8nblr Node: stor1 -ceph-27 nvme2n1 7T bluestore Pod: rook-ceph-osd-28-5d699844fb-gjwpl Node: stor1 -ceph-28 nvme7n1 7T bluestore Pod: rook-ceph-osd-29-844c855c5f-xsx9t Node: stor1 -ceph-29 nvme17n1 7T bluestore Pod: rook-ceph-osd-30-666c654b7f-j52mm Node: stor1 -ceph-30 nvme18n1 7T bluestore Pod: rook-ceph-osd-31-5c7b6b4cbb-x7q6w Node: stor1 -ceph-31 nvme5n1 7T bluestore Pod: rook-ceph-osd-32-599bd9b79f-lglvq Node: stor1 -ceph-32 nvme15n1 7T bluestore Pod: rook-ceph-osd-33-686d9895ff-9npb4 Node: stor1 -ceph-33 nvme8n1 7T bluestore Pod: rook-ceph-osd-34-6657644cbf-fz24n Node: stor1 -ceph-34 nvme13n1 7T bluestore Pod: rook-ceph-osd-35-686fd5866d-mbrkh Node: stor1 -ceph-35 nvme1n1 7T bluestore Pod: rook-ceph-osd-36-5db47d4f68-2hnfd Node: stor1 -ceph-36 nvme9n1 7T bluestore Pod: rook-ceph-osd-37-5bb9b8d86d-gxdcn Node: stor1 -ceph-37 nvme0n1 7T bluestore Pod: rook-ceph-osd-39-6968499df8-hhxtw Node: stor1 -ceph-39 nvme6n1 7T bluestore","title":"Test"},{"location":"error/tjtu/","text":"\u5929\u6d25\u5927\u5b66\u96c6\u7fa4\u95ee\u9898 \u00b6 \u95ee\u9898\u590d\u73b0 \u4ece\u4e0b\u56fe\u53ef\u4ee5\u770b\u51fa\u6709\u5f88\u591a\u7684\u4efb\u52a1\u5904\u4e8e\u6570\u636e\u540c\u6b65\u5173\u95ed\u7684\u4e00\u4e2a\u72b6\u6001 \u95ee\u9898\u6392\u67e5 \u67e5\u770bk8s\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u53d1\u73b0\u4e00\u4e0bpod\u5904\u4e8e\u5f02\u5e38\u72b6\u6001\uff0c\u8fd9\u4e9b\u5f02\u5e38\u7684pod\u53ea\u80fd\u5168\u90e8\u5220\u9664\u91cd\u5efa \u9700\u8981\u67e5\u770b\u4e00\u4e0b\u5f02\u5e38pod\u7684\u8be6\u7ec6\u4fe1\u606f \u95ee\u9898\u51fa\u73b0 \u4ee5\u4e0a\u53ef\u4ee5\u770b\u5230pod\u5728\u521b\u5efa\u7f16\u53f7\u4e3a9\u7684gpu\u51fa\u73b0\u62a5\u9519\uff0c\u5bfc\u81f4\u8fd9\u6837\u7684\u60c5\u51b5\u53ef\u80fd\u5c31\u662fgpu\u51fa\u95ee\u9898\u4e86 \u63a5\u4e0b\u6765\u53ef\u4ee5\u68c0\u67e5\u8fd9\u4e2apod\u6240\u5728\u7684\u673a\u5668\u4e0a\u7684gpu\uff0c\u770b\u662f\u5426\u51fa\u73b0\u95ee\u9898 \u53ef\u4ee5\u901a\u8fc7 nvidia-smi -L \u547d\u4ee4\u6765\u67e5\u770b \u68c0\u67e5gpu \u51fa\u73b0\u4ee5\u4e0b\u60c5\u51b5\uff0c\u5c1d\u8bd5\u91cd\u542f\u770b\u770b\u662f\u5426\u80fd\u4fee\u590d \u5929\u6d25\u5927\u5b66\u96c6\u7fa4gpu\u786c\u4ef6\u635f\u574f GPU\u635f\u574f \u53ef\u4ee5\u901a\u8fc7nvidia-smi -L \u67e5\u770bgpu\u60c5\u51b5 nvidia-smi Unable to determine the device handle for GPU 0000 :89:00.0: Unknown Error \u611f\u89c9\u662f\u8fd9\u5757\u5361 0000:89:00.0 \u51fa\u95ee\u9898\u4e86\u3002\u7136\u540e\u53bb\u6267\u884c\u4e0b dmesg \u770b\u770b\u60c5\u51b5\uff1a $ dmesg -T [ Mon May 9 20 :37:33 2022 ] xhci_hcd 0000 :89:00.2: PCI post-resume error -19! [ Mon May 9 20 :37:33 2022 ] xhci_hcd 0000 :89:00.2: HC died ; cleaning up [ Mon May 9 20 :37:34 2022 ] nvidia-gpu 0000 :89:00.3: i2c timeout error ffffffff [ Mon May 9 20 :37:34 2022 ] ucsi_ccg 6 -0008: i2c_transfer failed -110 $ nvidia-smi drain -p 0000 :89:00.0 -m 1 Successfully set GPU 00000000 :89:00.0 drain state to: drainin \u5c4f\u853d\u5b8c\u6210\u8fd9\u53f0\u673a\u5668\uff0c\u9700\u8981\u8fdb\u884c\u91cd\u65b0\u542f\u52a8","title":"\u5929\u6d25\u96c6\u7fa4"},{"location":"error/tjtu/#_1","text":"\u95ee\u9898\u590d\u73b0 \u4ece\u4e0b\u56fe\u53ef\u4ee5\u770b\u51fa\u6709\u5f88\u591a\u7684\u4efb\u52a1\u5904\u4e8e\u6570\u636e\u540c\u6b65\u5173\u95ed\u7684\u4e00\u4e2a\u72b6\u6001 \u95ee\u9898\u6392\u67e5 \u67e5\u770bk8s\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u53d1\u73b0\u4e00\u4e0bpod\u5904\u4e8e\u5f02\u5e38\u72b6\u6001\uff0c\u8fd9\u4e9b\u5f02\u5e38\u7684pod\u53ea\u80fd\u5168\u90e8\u5220\u9664\u91cd\u5efa \u9700\u8981\u67e5\u770b\u4e00\u4e0b\u5f02\u5e38pod\u7684\u8be6\u7ec6\u4fe1\u606f \u95ee\u9898\u51fa\u73b0 \u4ee5\u4e0a\u53ef\u4ee5\u770b\u5230pod\u5728\u521b\u5efa\u7f16\u53f7\u4e3a9\u7684gpu\u51fa\u73b0\u62a5\u9519\uff0c\u5bfc\u81f4\u8fd9\u6837\u7684\u60c5\u51b5\u53ef\u80fd\u5c31\u662fgpu\u51fa\u95ee\u9898\u4e86 \u63a5\u4e0b\u6765\u53ef\u4ee5\u68c0\u67e5\u8fd9\u4e2apod\u6240\u5728\u7684\u673a\u5668\u4e0a\u7684gpu\uff0c\u770b\u662f\u5426\u51fa\u73b0\u95ee\u9898 \u53ef\u4ee5\u901a\u8fc7 nvidia-smi -L \u547d\u4ee4\u6765\u67e5\u770b \u68c0\u67e5gpu \u51fa\u73b0\u4ee5\u4e0b\u60c5\u51b5\uff0c\u5c1d\u8bd5\u91cd\u542f\u770b\u770b\u662f\u5426\u80fd\u4fee\u590d \u5929\u6d25\u5927\u5b66\u96c6\u7fa4gpu\u786c\u4ef6\u635f\u574f GPU\u635f\u574f \u53ef\u4ee5\u901a\u8fc7nvidia-smi -L \u67e5\u770bgpu\u60c5\u51b5 nvidia-smi Unable to determine the device handle for GPU 0000 :89:00.0: Unknown Error \u611f\u89c9\u662f\u8fd9\u5757\u5361 0000:89:00.0 \u51fa\u95ee\u9898\u4e86\u3002\u7136\u540e\u53bb\u6267\u884c\u4e0b dmesg \u770b\u770b\u60c5\u51b5\uff1a $ dmesg -T [ Mon May 9 20 :37:33 2022 ] xhci_hcd 0000 :89:00.2: PCI post-resume error -19! [ Mon May 9 20 :37:33 2022 ] xhci_hcd 0000 :89:00.2: HC died ; cleaning up [ Mon May 9 20 :37:34 2022 ] nvidia-gpu 0000 :89:00.3: i2c timeout error ffffffff [ Mon May 9 20 :37:34 2022 ] ucsi_ccg 6 -0008: i2c_transfer failed -110 $ nvidia-smi drain -p 0000 :89:00.0 -m 1 Successfully set GPU 00000000 :89:00.0 drain state to: drainin \u5c4f\u853d\u5b8c\u6210\u8fd9\u53f0\u673a\u5668\uff0c\u9700\u8981\u8fdb\u884c\u91cd\u65b0\u542f\u52a8","title":"\u5929\u6d25\u5927\u5b66\u96c6\u7fa4\u95ee\u9898"},{"location":"go/2-go-docs/","text":"","title":"GO \u5f00\u53d1-\u64cd\u4f5c\u7b26\u548c\u8868\u8fbe\u5f0f"},{"location":"go/go-base-docs/","text":"Go \u8bed\u8a00\u5b66\u4e60\u4e4b\u8def \u00b6 \u5f00\u53d1\u73af\u5883\u642d\u5efa \u00b6 Go \u8bed\u8a00\u73af\u5883\u5b89\u88c5 \u00b6 \u5b89\u88c5\u5305\u4e0b\u8f7d\u5730\u5740\u4e3a\uff1ahttps://go.dev/dl/ \u5982\u679c\u6253\u4e0d\u5f00\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u5730\u5740\uff1ahttps://golang.google.cn/dl/\u3002 \u5404\u4e2a\u7cfb\u7edf\u5bf9\u5e94\u7684\u5305\u540d\uff1a Mac \u914d\u7f6e\u73af\u5883\u53d8\u91cf: \u96c6\u6210\u5f00\u53d1\u73af\u5883IDE \u00b6 \u53c2\u8003\u6587\u7ae0 \u00b6 go\u8bed\u8a00\u7cbe\u8fdb\u4e4b\u8def GO \u73af\u5883\u5b89\u88c5 https://github.com/unknwon/the-way-to-go_ZH_CN","title":"GO\u5f00\u53d1-\u73af\u5883\u5b89\u88c5"},{"location":"go/go-base-docs/#go","text":"","title":"Go \u8bed\u8a00\u5b66\u4e60\u4e4b\u8def"},{"location":"go/go-base-docs/#_1","text":"","title":"\u5f00\u53d1\u73af\u5883\u642d\u5efa"},{"location":"go/go-base-docs/#go_1","text":"\u5b89\u88c5\u5305\u4e0b\u8f7d\u5730\u5740\u4e3a\uff1ahttps://go.dev/dl/ \u5982\u679c\u6253\u4e0d\u5f00\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u5730\u5740\uff1ahttps://golang.google.cn/dl/\u3002 \u5404\u4e2a\u7cfb\u7edf\u5bf9\u5e94\u7684\u5305\u540d\uff1a Mac \u914d\u7f6e\u73af\u5883\u53d8\u91cf:","title":"Go \u8bed\u8a00\u73af\u5883\u5b89\u88c5"},{"location":"go/go-base-docs/#ide","text":"","title":"\u96c6\u6210\u5f00\u53d1\u73af\u5883IDE"},{"location":"go/go-base-docs/#_2","text":"go\u8bed\u8a00\u7cbe\u8fdb\u4e4b\u8def GO \u73af\u5883\u5b89\u88c5 https://github.com/unknwon/the-way-to-go_ZH_CN","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"k3s/k3s-docs/","text":"K3s \u662f\u7531 Rancher Labs \u5f00\u53d1\u7684\u4e00\u4e2a\u8f7b\u91cf\u7ea7 Kubernetes \u53d1\u884c\u7248\u3002\u5b83\u7684\u76ee\u6807\u662f\u4f7f\u5f97\u5728\u8d44\u6e90\u53d7\u9650\u7684\u73af\u5883\u4e2d\uff08\u4f8b\u5982\u5f00\u53d1\u3001\u6d4b\u8bd5\u3001\u8fb9\u7f18\u8ba1\u7b97\u7b49\uff09\u4e5f\u80fd\u65b9\u4fbf\u5730\u8fd0\u884c Kubernetes\u3002\u4ee5\u4e0b\u662f\u5173\u4e8e K3s \u7684\u4e00\u4e2a\u57fa\u7840\u5927\u7eb2\uff1a K3s \u7b80\u4ecb K3s \u7684\u5b9a\u4e49\u548c\u8bbe\u8ba1\u76ee\u6807 K3s \u4e0e\u6807\u51c6 Kubernetes \u7684\u533a\u522b K3s \u7684\u4e3b\u8981\u7528\u4f8b\u548c\u9002\u7528\u573a\u666f K3s \u7684\u5b89\u88c5\u548c\u914d\u7f6e \u7cfb\u7edf\u8981\u6c42 \u5b89\u88c5\u8fc7\u7a0b \u914d\u7f6e\u9009\u9879\u548c\u73af\u5883\u53d8\u91cf K3s \u7684\u67b6\u6784\u548c\u7ec4\u4ef6 K3s \u670d\u52a1\u5668\u548c\u4ee3\u7406\u7684\u6982\u5ff5 \u5185\u7f6e\u7684\u7f51\u7edc\u63d2\u4ef6\uff08\u4f8b\u5982 flannel\uff09 \u5185\u7f6e\u7684\u5b58\u50a8\u63d2\u4ef6\uff08\u4f8b\u5982 local-path\uff09 Helm Chart \u63a7\u5236\u5668 K3s \u7684\u4f7f\u7528\u548c\u7ba1\u7406 \u5982\u4f55\u90e8\u7f72\u5e94\u7528\uff08\u4f7f\u7528 kubectl \u548c Helm\uff09 \u5982\u4f55\u6dfb\u52a0\u548c\u7ba1\u7406\u8282\u70b9 \u5982\u4f55\u5347\u7ea7\u548c\u7ef4\u62a4 K3s \u96c6\u7fa4 \u5982\u4f55\u76d1\u63a7\u548c\u8c03\u8bd5 K3s \u7684\u5b89\u5168\u6027 RBAC \u548c Pod \u5b89\u5168\u7b56\u7565 \u7f51\u7edc\u7b56\u7565 \u8bc1\u4e66\u7ba1\u7406 K3s \u5728\u8fb9\u7f18\u8ba1\u7b97\u7684\u5e94\u7528 K3s \u5728\u8fb9\u7f18\u8ba1\u7b97\u573a\u666f\u7684\u4f18\u52bf K3s \u7684\u8fb9\u7f18\u90e8\u7f72\u6848\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5 K3s \u7684\u793e\u533a\u548c\u751f\u6001 K3s \u7684\u5f00\u53d1\u548c\u7ef4\u62a4\u60c5\u51b5 K3s \u7684\u793e\u533a\u8d44\u6e90\uff08\u4f8b\u5982\u6587\u6863\u3001\u6559\u7a0b\u3001\u95ee\u9898\u89e3\u7b54\u7b49\uff09 \u4e0e K3s \u76f8\u5173\u7684\u9879\u76ee\u548c\u5de5\u5177","title":"k3s \u5927\u7eb2\u4ecb\u7ecd"},{"location":"k3s/k3s-install/","text":"\u524d\u8a00 \u00b6 \u5728\u5de5\u4f5c\u4e2d,\u7ecf\u5e38\u9047\u5230\u5f88\u591a\u5c0f\u73af\u5883(\u5c0f\u4e8e\u7b49\u4e8e 5 \u53f0\u673a\u5668),\u5bf9\u4e8e\u8fd9\u79cd\u73af\u5883,\u5c31\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528k3s,\u539f\u56e0\u5c31\u662f\u56e0\u4e3a k3s \u8bbe\u8ba1\u5f88\u5c0f\u5de7.\u5b83\u76f8\u5bf9\u4e8e\u6807\u51c6\u7684 k8s \u6240\u7528\u7684\u5185\u5b58\u8d44\u6e90\u8981\u51cf\u534a\uff0c\u975e\u5e38\u9002\u5408\u6bd4\u8f83\u5c0f\u578b\u7684\u8bbe\u5907.\u5bf9\u4e8e\u6211\u4eec\u6d4b\u8bd5\u7684 demo \u73af\u5883,\u5927\u53ef\u4e0d\u5fc5\u8981\u5b89\u88c5\u6807\u51c6 k8s,\u5c31\u53ef\u4ee5\u7528\u5230\u51e0\u4e4e\u6240\u6709 k8s \u7684\u529f\u80fd\u548c\u7279\u6027.\u8fd9\u5c31\u8ba9\u4ed6\u9002\u7528\u4e8e\u5f88\u591a\u7684\u8fb9\u7f18\u8ba1\u7b97\u573a\u666f.Edge,IoT,Development....\u7b49\u7b49~ \u4ec0\u4e48\u662f K3S \u00b6 K3s \u662f\u4e00\u4e2a\u5b8c\u5168\u517c\u5bb9\u7684 Kubernetes \u53d1\u884c\u7248\uff0c\u5177\u6709\u4ee5\u4e0b\u589e\u5f3a\u529f\u80fd\uff1a \u6253\u5305\u4e3a\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002 \u4f7f\u7528\u57fa\u4e8e sqlite3 \u4f5c\u4e3a\u9ed8\u8ba4\u5b58\u50a8\u673a\u5236\u7684\u8f7b\u91cf\u7ea7\u5b58\u50a8\u540e\u7aef\u3002\u540c\u65f6\u652f\u6301\u4f7f\u7528 etcd3\u3001MySQL \u548c Postgres\u3002 \u5c01\u88c5\u5728\u7b80\u5355\u7684\u542f\u52a8\u7a0b\u5e8f\u4e2d\uff0c\u53ef\u4ee5\u5904\u7406\u5f88\u591a\u590d\u6742\u7684 TLS \u548c\u9009\u9879\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u5b89\u5168\u7684\uff0c\u5bf9\u8f7b\u91cf\u7ea7\u73af\u5883\u6709\u5408\u7406\u7684\u9ed8\u8ba4\u503c\u3002 \u6dfb\u52a0\u4e86\u7b80\u5355\u4f46\u5f3a\u5927\u7684 batteries-included \u529f\u80fd\uff0c\u4f8b\u5982 \u529f\u80fd\uff0c\u4f8b\u5982\uff1a \u672c\u5730\u5b58\u50a8\u63d0\u4f9b\u7a0b\u5e8f service load balancer Helm controller Traefik ingress controller ......\u7b49 \u57fa\u7840\u73af\u5883 \u00b6 Info \u5982\u679c\u8981\u4f7f\u7528 docker \u505a\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6,\u9700\u8981\u63d0\u524d\u9884\u5b89\u88c5docker\u73af\u5883.\u5bf9\u4e8e docker,\u5728 k3s \u5b98\u65b9\u4e0a\u6709\u4e00\u952e\u5b89\u88c5\u811a\u672c. \u4e00\u952e\u5b89\u88c5docker\u811a\u672c\uff1a curl https://releases.rancher.com/install-docker/20.10.sh | sh \u5355Master\u8282\u70b9\u96c6\u7fa4 \u00b6 \u5d4c\u5165\u5f0f\u6570\u636e\u5e93\u7684\u5355\u670d\u52a1\u5668 \u4e0b\u56fe\u663e\u793a\u4e86\u5177\u6709\u5d4c\u5165\u5f0f SQLite \u6570\u636e\u5e93\u7684\u5355\u8282\u70b9 K3s Server \u96c6\u7fa4\u793a\u4f8b\u3002 \u5728\u6b64\u914d\u7f6e\u4e2d\uff0c\u6bcf\u4e2a Agent \u8282\u70b9\u90fd\u6ce8\u518c\u5230\u540c\u4e00\u4e2a Server \u8282\u70b9\u3002K3s \u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528 Server \u8282\u70b9\u4e0a\u7684 K3s API \u6765\u64cd\u4f5c Kubernetes \u8d44\u6e90\u3002 \u5b89\u88c5\u811a\u672c: \u00b6 \u4e2d\u56fd\u7528\u6237\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u65b9\u6cd5\u52a0\u901f\u5b89\u88c5 Server\u7aef\uff1a curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn sh - \u5b89\u88c5\u5176\u4ed6 Agent \u8282\u70b9\u5e76\u5c06\u5b83\u4eec\u6dfb\u52a0\u5230\u96c6\u7fa4 curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken sh - K3S_URL \u53c2\u6570\u4f1a\u5bfc\u81f4\u5b89\u88c5\u7a0b\u5e8f\u5c06 K3s \u914d\u7f6e\u4e3a Agent \u800c\u4e0d\u662f Server\u3002K3s Agent \u5c06\u6ce8\u518c\u5230\u5728 URL \u4e0a\u76d1\u542c\u7684 K3s Server\u3002K3S_TOKEN \u4f7f\u7528\u7684\u503c\u5b58\u50a8\u5728 Server \u8282\u70b9\u4e0a\u7684 /var/lib/rancher/k3s/server/node-token \u4e2d \u9ad8\u53ef\u7528k3s\u96c6\u7fa4 \u00b6 \u5355\u670d\u52a1\u5668\u96c6\u7fa4\u53ef\u4ee5\u6ee1\u8db3\u5404\u79cd\u7528\u4f8b\uff0c\u4f46\u5982\u679c\u4f60\u7684\u73af\u5883\u5bf9 Kubernetes control plane \u7684\u6b63\u5e38\u8fd0\u884c\u65f6\u95f4\u6709\u8981\u6c42\uff0c\u4f60\u53ef\u4ee5\u5728 HA \u914d\u7f6e\u4e2d\u8fd0\u884c K3s\u3002\u4e00\u4e2a\u9ad8\u53ef\u7528 K3s \u96c6\u7fa4\u5305\u62ec\uff1a \u4e09\u4e2a\u6216\u591a\u4e2a Server \u8282\u70b9\u4e3a Kubernetes API \u63d0\u4f9b\u670d\u52a1\u5e76\u8fd0\u884c\u5176\u4ed6 control plane \u670d\u52a1 \u5d4c\u5165\u5f0f etcd \u6570\u636e\u5b58\u50a8\uff08\u4e0e\u5355\u8282\u70b9\u8bbe\u7f6e\u4e2d\u4f7f\u7528\u7684\u5d4c\u5165\u5f0f SQLite \u6570\u636e\u5b58\u50a8\u76f8\u53cd\uff09 \u5982\u4e0b\u56fe\u6240\u793a: (\u4f7f\u7528\u5185\u5d4c etcd \u4f5c\u4e3a\u5b58\u50a8) \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Ucloud \u6216\u8005\u5176\u4ed6\u4e91\u7684 ulb \u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861,\u5728\u521b\u5efa\u4e09\u53f0\u673a\u5668\u4f5c\u4e3a k3s-server,\u4e00\u53f0\u673a\u5668\u4f5c\u4e3a k3s-agent \u73af\u5883\u51c6\u5907: \u00b6 ucloud \u7684\u5185\u7f51 ulb \u662f\u9700\u8981\u5728\u6bcf\u53f0 master \u505a\u989d\u5916\u7684\u8bbe\u7f6e\u7684 \u6b65\u9aa4: - \u9700\u8981\u5728\u6bcf\u53f0\u673a\u5668\u4e0b\u589e\u52a0\u6587\u4ef6 /etc/netplan/lo-cloud-init.yaml\uff0c\u5176\u4e2d $VIP \u4e3a ulb \u7684\u5185\u7f51 IP network: ethernets: lo: addresses: - $VIP/32 \u6267\u884c\u547d\u4ee4 sudo netplan apply \u901a\u8fc7\u547d\u4ee4 ip a \u53ef\u4ee5\u770b\u5230 lo \u7684\u7f51\u5361\u5df2\u7ecf\u589e\u52a0\u4e86 $VIP\u3002\u5982\u679c\u6ca1\u6709\u751f\u6548\u53ef\u4ee5\u5c1d\u8bd5\u91cd\u542f\u8bd5\u8bd5. \u6e29\u99a8\u63d0\u793a k3s \u9ed8\u8ba4\u4f7f\u7528\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u662f containerd,\u6211\u4e0d\u592a\u4e60\u60ef,\u4ecd\u7136\u4f7f\u7528 docker \u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6. \u53ef\u4ee5\u4f7f\u7528: curl https://releases.rancher.com/install-docker/20.10.sh | sh \u9ad8\u53ef\u7528\u90e8\u7f72: \u00b6 \u521b\u5efa\u4e00\u4e2a master \u8282\u70b9 \u7136\u540e\u5c06\u540e\u7eed\u7684\u4e24\u4e2a master \u52a0\u5165\u5230\u96c6\u7fa4 \u6700\u540e\u52a0\u5165 work \u8282\u70b9,\u52a0\u5165\u8282\u70b9\u7684\u65f6\u5019\u5c31\u9700\u8981\u6307\u5b9a ulb \u7684ip \u4e86 \u7b2c\u4e00\u6b65: master0 \u9700\u8981\u6267\u884c: curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn sh -s - server -c /home/lixie/master0-config.yaml \u91c7\u7528\u4e86 k3s server \u4e0b\u4e00\u4e2a -c \u7684\u53c2\u6570\uff0c\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u5c06\u547d\u4ee4\u53c2\u6570\u4ee5 yaml \u7684\u5f62\u5f0f\u4f20\u8fdb\u6765 \u5176\u4e2d master0-config.yaml \u5982\u4e0b\u6240\u793a root@10-0-0-118:/home/lixie# cat master0-config.yaml write-kubeconfig-mode: \"0644\" tls-san: - 10.0.0.118 # m1.k3s.k3s.in.openbayes.com m1.k3s - 10.0.0.182 # m2.k3s.k3s.in.openbayes.com m2.k3s - 10.0.0.106 # m3.k3s.k3s.in.openbayes.com m3.k3s - 10.0.0.150 # node1.k3s.k3s.in.openbayes.com node1.k3s - 10.0.0.46 - 106.75.6.119 - 106.75.8.51 - 106.75.77.106 docker: true cluster-init: true token: VNVIyKGNPtSKTfhi disable: servicelb \u6587\u4ef6\u8bf4\u660e: \u628a\u6240\u6709 master \u7684\u5185\u7f51\u548c\u5916\u7f51 ip \u90fd\u653e\u8fdb\u4e86 tls-san \u540c\u65f6\u628a\u5185\u7f51\u8d1f\u8f7d\u5747\u8861\u8282\u70b9 ip \u4e5f\u653e\u4e86\u8fdb\u6765\u3002 k3s \u9ed8\u8ba4\u4f7f\u7528 containerd \u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\u73af\u5883\uff0c\u4e0d\u8fc7\u6211\u8fd8\u662f\u7528\u60ef\u4e86 docker \u6240\u4ee5\u6dfb\u52a0\u4e86\u53c2\u6570 docker: true\u3002 \u7b2c\u4e00\u53f0 master \u91c7\u7528 cluster-init \u7684\u65b9\u5f0f\u542f\u52a8\u3002 token \u5c31\u662f\u4e00\u4e2a\u968f\u673a\u5b57\u7b26\u4e32\uff0c\u540e\u9762\u6dfb\u52a0 master \u8282\u70b9\u548c worker \u8282\u70b9\u53ea\u8981\u4fdd\u6301\u4e00\u81f4\u5c31\u597d\u3002 disable \u53c2\u6570\u5173\u6389\u4e86 k3s \u9ed8\u8ba4\u6dfb\u52a0\u7684 servicelb \u5982\u679c\u60f3\u8981\u540c\u65f6\u5173\u6389 traefik \u5c31\u53ef\u4ee5\u5199\u6210 disable: servicelb,traefik\uff1b\u6ce8\u610f \u50cf\u914d\u7f6e tls-san \u90a3\u6837\u7528 yaml \u7684\u6570\u7ec4\u7684\u8bed\u6cd5\u662f\u4e0d\u884c\u7684\uff0c\u8fd9\u4e5f\u662f\u8ba9\u6211\u591a\u82b1\u4e86\u70b9\u65f6\u95f4\u7684\u5730\u65b9\u3002 \u7b49 master0 \u7684\u547d\u4ee4\u6267\u884c\u6210\u529f\u540e\u8f93\u5165\u547d\u4ee4 k3s kubectl get nodes -w \u7b49\u5f85\u7b2c\u4e00\u4e2a\u8282\u70b9\u51c6\u5907\u5b8c\u6bd5\u540e\u5728\u7b2c\u4e8c\u53f0 master \u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn sh -s - server -c /home/lixie/master-others.config.yaml \u5176\u4e2d master-others.config.yaml \u5185\u5bb9\u5982\u4e0b\uff1a root@10-0-0-182:/home/lixie# cat master-others.config.yaml write-kubeconfig-mode: \"0644\" tls-san: - 10.0.0.118 # m1.k3s.k3s.in.openbayes.com m1.k3s - 10.0.0.182 # m2.k3s.k3s.in.openbayes.com m2.k3s - 10.0.0.106 # m3.k3s.k3s.in.openbayes.com m3.k3s - 10.0.0.150 # node1.k3s.k3s.in.openbayes.com node1.k3s - 10.0.0.46 # ULB - 106.75.6.119 - 106.75.8.51 - 106.75.77.106 docker: true server: https://10.0.0.118:6443 token: VNVIyKGNPtSKTfhi disable: servicelb Node \u8282\u70b9\u52a0\u5165\u96c6\u7fa4: curl -sfL https://get.k3s.io \\ | K3S_TOKEN = VNVIyKGNPtSKTfhi sh -s - agent --server https://10.0.0.118:6443 \u5728 node \u8282\u70b9,\u62ff master \u7684 kubeconfig \u914d\u7f6e,\u5730\u5740\u6307\u5230 ULB \u6d4b\u8bd5 root@10-0-0-150:/home/lixie# kubectl get nodes NAME STATUS ROLES AGE VERSION 10-0-0-106 Ready control-plane,etcd,master 137m v1.27.6+k3s1 10-0-0-118 Ready control-plane,etcd,master 170m v1.27.6+k3s1 10-0-0-150 Ready <none> 12s v1.27.6+k3s1 10-0-0-182 Ready control-plane,etcd,master 138m v1.27.6+k3s1 \u5378\u8f7dk3s \u00b6 \u8fd9\u91cc\u53ef\u4ee5\u901a\u8fc7 k3s \u5b98\u65b9\u65b9\u5f0f\u5220\u9664 \u53c2\u8003\u6587\u7ae0 \u00b6 https://docs.rancher.cn/docs/k3s/quick-start/_index https://aisensiy.me/k3s-ha-in-cloud/","title":"k3s \u8fb9\u7f18\u8ba1\u7b97"},{"location":"k3s/k3s-install/#_1","text":"\u5728\u5de5\u4f5c\u4e2d,\u7ecf\u5e38\u9047\u5230\u5f88\u591a\u5c0f\u73af\u5883(\u5c0f\u4e8e\u7b49\u4e8e 5 \u53f0\u673a\u5668),\u5bf9\u4e8e\u8fd9\u79cd\u73af\u5883,\u5c31\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528k3s,\u539f\u56e0\u5c31\u662f\u56e0\u4e3a k3s \u8bbe\u8ba1\u5f88\u5c0f\u5de7.\u5b83\u76f8\u5bf9\u4e8e\u6807\u51c6\u7684 k8s \u6240\u7528\u7684\u5185\u5b58\u8d44\u6e90\u8981\u51cf\u534a\uff0c\u975e\u5e38\u9002\u5408\u6bd4\u8f83\u5c0f\u578b\u7684\u8bbe\u5907.\u5bf9\u4e8e\u6211\u4eec\u6d4b\u8bd5\u7684 demo \u73af\u5883,\u5927\u53ef\u4e0d\u5fc5\u8981\u5b89\u88c5\u6807\u51c6 k8s,\u5c31\u53ef\u4ee5\u7528\u5230\u51e0\u4e4e\u6240\u6709 k8s \u7684\u529f\u80fd\u548c\u7279\u6027.\u8fd9\u5c31\u8ba9\u4ed6\u9002\u7528\u4e8e\u5f88\u591a\u7684\u8fb9\u7f18\u8ba1\u7b97\u573a\u666f.Edge,IoT,Development....\u7b49\u7b49~","title":"\u524d\u8a00"},{"location":"k3s/k3s-install/#k3s","text":"K3s \u662f\u4e00\u4e2a\u5b8c\u5168\u517c\u5bb9\u7684 Kubernetes \u53d1\u884c\u7248\uff0c\u5177\u6709\u4ee5\u4e0b\u589e\u5f3a\u529f\u80fd\uff1a \u6253\u5305\u4e3a\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002 \u4f7f\u7528\u57fa\u4e8e sqlite3 \u4f5c\u4e3a\u9ed8\u8ba4\u5b58\u50a8\u673a\u5236\u7684\u8f7b\u91cf\u7ea7\u5b58\u50a8\u540e\u7aef\u3002\u540c\u65f6\u652f\u6301\u4f7f\u7528 etcd3\u3001MySQL \u548c Postgres\u3002 \u5c01\u88c5\u5728\u7b80\u5355\u7684\u542f\u52a8\u7a0b\u5e8f\u4e2d\uff0c\u53ef\u4ee5\u5904\u7406\u5f88\u591a\u590d\u6742\u7684 TLS \u548c\u9009\u9879\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u5b89\u5168\u7684\uff0c\u5bf9\u8f7b\u91cf\u7ea7\u73af\u5883\u6709\u5408\u7406\u7684\u9ed8\u8ba4\u503c\u3002 \u6dfb\u52a0\u4e86\u7b80\u5355\u4f46\u5f3a\u5927\u7684 batteries-included \u529f\u80fd\uff0c\u4f8b\u5982 \u529f\u80fd\uff0c\u4f8b\u5982\uff1a \u672c\u5730\u5b58\u50a8\u63d0\u4f9b\u7a0b\u5e8f service load balancer Helm controller Traefik ingress controller ......\u7b49","title":"\u4ec0\u4e48\u662f K3S"},{"location":"k3s/k3s-install/#_2","text":"Info \u5982\u679c\u8981\u4f7f\u7528 docker \u505a\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6,\u9700\u8981\u63d0\u524d\u9884\u5b89\u88c5docker\u73af\u5883.\u5bf9\u4e8e docker,\u5728 k3s \u5b98\u65b9\u4e0a\u6709\u4e00\u952e\u5b89\u88c5\u811a\u672c. \u4e00\u952e\u5b89\u88c5docker\u811a\u672c\uff1a curl https://releases.rancher.com/install-docker/20.10.sh | sh","title":"\u57fa\u7840\u73af\u5883"},{"location":"k3s/k3s-install/#master","text":"\u5d4c\u5165\u5f0f\u6570\u636e\u5e93\u7684\u5355\u670d\u52a1\u5668 \u4e0b\u56fe\u663e\u793a\u4e86\u5177\u6709\u5d4c\u5165\u5f0f SQLite \u6570\u636e\u5e93\u7684\u5355\u8282\u70b9 K3s Server \u96c6\u7fa4\u793a\u4f8b\u3002 \u5728\u6b64\u914d\u7f6e\u4e2d\uff0c\u6bcf\u4e2a Agent \u8282\u70b9\u90fd\u6ce8\u518c\u5230\u540c\u4e00\u4e2a Server \u8282\u70b9\u3002K3s \u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528 Server \u8282\u70b9\u4e0a\u7684 K3s API \u6765\u64cd\u4f5c Kubernetes \u8d44\u6e90\u3002","title":"\u5355Master\u8282\u70b9\u96c6\u7fa4"},{"location":"k3s/k3s-install/#_3","text":"\u4e2d\u56fd\u7528\u6237\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u65b9\u6cd5\u52a0\u901f\u5b89\u88c5 Server\u7aef\uff1a curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn sh - \u5b89\u88c5\u5176\u4ed6 Agent \u8282\u70b9\u5e76\u5c06\u5b83\u4eec\u6dfb\u52a0\u5230\u96c6\u7fa4 curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\ INSTALL_K3S_MIRROR=cn K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken sh - K3S_URL \u53c2\u6570\u4f1a\u5bfc\u81f4\u5b89\u88c5\u7a0b\u5e8f\u5c06 K3s \u914d\u7f6e\u4e3a Agent \u800c\u4e0d\u662f Server\u3002K3s Agent \u5c06\u6ce8\u518c\u5230\u5728 URL \u4e0a\u76d1\u542c\u7684 K3s Server\u3002K3S_TOKEN \u4f7f\u7528\u7684\u503c\u5b58\u50a8\u5728 Server \u8282\u70b9\u4e0a\u7684 /var/lib/rancher/k3s/server/node-token \u4e2d","title":"\u5b89\u88c5\u811a\u672c:"},{"location":"k3s/k3s-install/#k3s_1","text":"\u5355\u670d\u52a1\u5668\u96c6\u7fa4\u53ef\u4ee5\u6ee1\u8db3\u5404\u79cd\u7528\u4f8b\uff0c\u4f46\u5982\u679c\u4f60\u7684\u73af\u5883\u5bf9 Kubernetes control plane \u7684\u6b63\u5e38\u8fd0\u884c\u65f6\u95f4\u6709\u8981\u6c42\uff0c\u4f60\u53ef\u4ee5\u5728 HA \u914d\u7f6e\u4e2d\u8fd0\u884c K3s\u3002\u4e00\u4e2a\u9ad8\u53ef\u7528 K3s \u96c6\u7fa4\u5305\u62ec\uff1a \u4e09\u4e2a\u6216\u591a\u4e2a Server \u8282\u70b9\u4e3a Kubernetes API \u63d0\u4f9b\u670d\u52a1\u5e76\u8fd0\u884c\u5176\u4ed6 control plane \u670d\u52a1 \u5d4c\u5165\u5f0f etcd \u6570\u636e\u5b58\u50a8\uff08\u4e0e\u5355\u8282\u70b9\u8bbe\u7f6e\u4e2d\u4f7f\u7528\u7684\u5d4c\u5165\u5f0f SQLite \u6570\u636e\u5b58\u50a8\u76f8\u53cd\uff09 \u5982\u4e0b\u56fe\u6240\u793a: (\u4f7f\u7528\u5185\u5d4c etcd \u4f5c\u4e3a\u5b58\u50a8) \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Ucloud \u6216\u8005\u5176\u4ed6\u4e91\u7684 ulb \u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861,\u5728\u521b\u5efa\u4e09\u53f0\u673a\u5668\u4f5c\u4e3a k3s-server,\u4e00\u53f0\u673a\u5668\u4f5c\u4e3a k3s-agent","title":"\u9ad8\u53ef\u7528k3s\u96c6\u7fa4"},{"location":"k3s/k3s-install/#_4","text":"ucloud \u7684\u5185\u7f51 ulb \u662f\u9700\u8981\u5728\u6bcf\u53f0 master \u505a\u989d\u5916\u7684\u8bbe\u7f6e\u7684 \u6b65\u9aa4: - \u9700\u8981\u5728\u6bcf\u53f0\u673a\u5668\u4e0b\u589e\u52a0\u6587\u4ef6 /etc/netplan/lo-cloud-init.yaml\uff0c\u5176\u4e2d $VIP \u4e3a ulb \u7684\u5185\u7f51 IP network: ethernets: lo: addresses: - $VIP/32 \u6267\u884c\u547d\u4ee4 sudo netplan apply \u901a\u8fc7\u547d\u4ee4 ip a \u53ef\u4ee5\u770b\u5230 lo \u7684\u7f51\u5361\u5df2\u7ecf\u589e\u52a0\u4e86 $VIP\u3002\u5982\u679c\u6ca1\u6709\u751f\u6548\u53ef\u4ee5\u5c1d\u8bd5\u91cd\u542f\u8bd5\u8bd5. \u6e29\u99a8\u63d0\u793a k3s \u9ed8\u8ba4\u4f7f\u7528\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u662f containerd,\u6211\u4e0d\u592a\u4e60\u60ef,\u4ecd\u7136\u4f7f\u7528 docker \u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\u65f6. \u53ef\u4ee5\u4f7f\u7528: curl https://releases.rancher.com/install-docker/20.10.sh | sh","title":"\u73af\u5883\u51c6\u5907:"},{"location":"k3s/k3s-install/#_5","text":"\u521b\u5efa\u4e00\u4e2a master \u8282\u70b9 \u7136\u540e\u5c06\u540e\u7eed\u7684\u4e24\u4e2a master \u52a0\u5165\u5230\u96c6\u7fa4 \u6700\u540e\u52a0\u5165 work \u8282\u70b9,\u52a0\u5165\u8282\u70b9\u7684\u65f6\u5019\u5c31\u9700\u8981\u6307\u5b9a ulb \u7684ip \u4e86 \u7b2c\u4e00\u6b65: master0 \u9700\u8981\u6267\u884c: curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn sh -s - server -c /home/lixie/master0-config.yaml \u91c7\u7528\u4e86 k3s server \u4e0b\u4e00\u4e2a -c \u7684\u53c2\u6570\uff0c\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u5c06\u547d\u4ee4\u53c2\u6570\u4ee5 yaml \u7684\u5f62\u5f0f\u4f20\u8fdb\u6765 \u5176\u4e2d master0-config.yaml \u5982\u4e0b\u6240\u793a root@10-0-0-118:/home/lixie# cat master0-config.yaml write-kubeconfig-mode: \"0644\" tls-san: - 10.0.0.118 # m1.k3s.k3s.in.openbayes.com m1.k3s - 10.0.0.182 # m2.k3s.k3s.in.openbayes.com m2.k3s - 10.0.0.106 # m3.k3s.k3s.in.openbayes.com m3.k3s - 10.0.0.150 # node1.k3s.k3s.in.openbayes.com node1.k3s - 10.0.0.46 - 106.75.6.119 - 106.75.8.51 - 106.75.77.106 docker: true cluster-init: true token: VNVIyKGNPtSKTfhi disable: servicelb \u6587\u4ef6\u8bf4\u660e: \u628a\u6240\u6709 master \u7684\u5185\u7f51\u548c\u5916\u7f51 ip \u90fd\u653e\u8fdb\u4e86 tls-san \u540c\u65f6\u628a\u5185\u7f51\u8d1f\u8f7d\u5747\u8861\u8282\u70b9 ip \u4e5f\u653e\u4e86\u8fdb\u6765\u3002 k3s \u9ed8\u8ba4\u4f7f\u7528 containerd \u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\u73af\u5883\uff0c\u4e0d\u8fc7\u6211\u8fd8\u662f\u7528\u60ef\u4e86 docker \u6240\u4ee5\u6dfb\u52a0\u4e86\u53c2\u6570 docker: true\u3002 \u7b2c\u4e00\u53f0 master \u91c7\u7528 cluster-init \u7684\u65b9\u5f0f\u542f\u52a8\u3002 token \u5c31\u662f\u4e00\u4e2a\u968f\u673a\u5b57\u7b26\u4e32\uff0c\u540e\u9762\u6dfb\u52a0 master \u8282\u70b9\u548c worker \u8282\u70b9\u53ea\u8981\u4fdd\u6301\u4e00\u81f4\u5c31\u597d\u3002 disable \u53c2\u6570\u5173\u6389\u4e86 k3s \u9ed8\u8ba4\u6dfb\u52a0\u7684 servicelb \u5982\u679c\u60f3\u8981\u540c\u65f6\u5173\u6389 traefik \u5c31\u53ef\u4ee5\u5199\u6210 disable: servicelb,traefik\uff1b\u6ce8\u610f \u50cf\u914d\u7f6e tls-san \u90a3\u6837\u7528 yaml \u7684\u6570\u7ec4\u7684\u8bed\u6cd5\u662f\u4e0d\u884c\u7684\uff0c\u8fd9\u4e5f\u662f\u8ba9\u6211\u591a\u82b1\u4e86\u70b9\u65f6\u95f4\u7684\u5730\u65b9\u3002 \u7b49 master0 \u7684\u547d\u4ee4\u6267\u884c\u6210\u529f\u540e\u8f93\u5165\u547d\u4ee4 k3s kubectl get nodes -w \u7b49\u5f85\u7b2c\u4e00\u4e2a\u8282\u70b9\u51c6\u5907\u5b8c\u6bd5\u540e\u5728\u7b2c\u4e8c\u53f0 master \u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn sh -s - server -c /home/lixie/master-others.config.yaml \u5176\u4e2d master-others.config.yaml \u5185\u5bb9\u5982\u4e0b\uff1a root@10-0-0-182:/home/lixie# cat master-others.config.yaml write-kubeconfig-mode: \"0644\" tls-san: - 10.0.0.118 # m1.k3s.k3s.in.openbayes.com m1.k3s - 10.0.0.182 # m2.k3s.k3s.in.openbayes.com m2.k3s - 10.0.0.106 # m3.k3s.k3s.in.openbayes.com m3.k3s - 10.0.0.150 # node1.k3s.k3s.in.openbayes.com node1.k3s - 10.0.0.46 # ULB - 106.75.6.119 - 106.75.8.51 - 106.75.77.106 docker: true server: https://10.0.0.118:6443 token: VNVIyKGNPtSKTfhi disable: servicelb Node \u8282\u70b9\u52a0\u5165\u96c6\u7fa4: curl -sfL https://get.k3s.io \\ | K3S_TOKEN = VNVIyKGNPtSKTfhi sh -s - agent --server https://10.0.0.118:6443 \u5728 node \u8282\u70b9,\u62ff master \u7684 kubeconfig \u914d\u7f6e,\u5730\u5740\u6307\u5230 ULB \u6d4b\u8bd5 root@10-0-0-150:/home/lixie# kubectl get nodes NAME STATUS ROLES AGE VERSION 10-0-0-106 Ready control-plane,etcd,master 137m v1.27.6+k3s1 10-0-0-118 Ready control-plane,etcd,master 170m v1.27.6+k3s1 10-0-0-150 Ready <none> 12s v1.27.6+k3s1 10-0-0-182 Ready control-plane,etcd,master 138m v1.27.6+k3s1","title":"\u9ad8\u53ef\u7528\u90e8\u7f72:"},{"location":"k3s/k3s-install/#k3s_2","text":"\u8fd9\u91cc\u53ef\u4ee5\u901a\u8fc7 k3s \u5b98\u65b9\u65b9\u5f0f\u5220\u9664","title":"\u5378\u8f7dk3s"},{"location":"k3s/k3s-install/#_6","text":"https://docs.rancher.cn/docs/k3s/quick-start/_index https://aisensiy.me/k3s-ha-in-cloud/","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"other/discord-docs/","text":"\u9996\u5148\u6211\u4eec\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\uff0c\u8fd9\u6837\u6211\u4eec\u518d\u8bbf\u95ee\uff1ahttps://discord.com/ \u7f51\u7ad9\u3002\u4e0b\u8f7d\u8f6f\u4ef6\u5305\u3002 \u8fd9\u91cc\u6211\u7684\u7535\u8111\u662fMac\uff0c\u56e0\u6b64\u6211\u76f4\u63a5\u4e0b\u8f7d\u7684Mac \u5b89\u88c5\u597d\u4e4b\u540e\u6253\u5f00discord \u6ce8\u610f\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u6ce8\u518c\u4e00\u4e0bdiscord \u901a\u5e38\u6211\u4f1a\u4f7f\u7528\u56fd\u5916\u7684\u4e00\u4e2a\u90ae\u7bb1\u6765\u6ce8\u518c \u586b\u5199\u4fe1\u606f\uff0c\u6ce8\u610f\u5982\u679c\u6ca1\u6709\u56fd\u5916\u90ae\u7bb1\u6700\u597d\u53ef\u4ee5\u81ea\u5df1\u6ce8\u518c\u4e00\u4e0b \u70b9\u51fb\u6587\u7ae0\u53c2\u8003\u94fe\u63a5\uff0c\u52a0\u5165Midjourney\u548cChatGPT \u6211\u4eec\u9700\u8981\u914d\u7f6e\u4e00\u4e0b\uff0c\u70b9\u5b8c\u6210 \u6700\u4e0a\u65b9\u8fd8\u6709\u4e00\u4e2a\u90ae\u7bb1\u9a8c\u8bc1 \u6ed1\u5230\u6700\u4e0b\u65b9\u2611\ufe0f \u6587\u7ae0\u53c2\u8003 \u00b6 https://discord.com/ ChatGPT Discord \u670d\u52a1\u5668 \u25b6 https://discord.gg/openai Midjourney Discord \u670d\u52a1\u5668 \u25b6 https://discord.gg/midjourney Discord APP\u4e0b\u8f7d\uff08\u82f9\u679c\uff09 \u25b6 http://bit.ly/3Zl8weK Discord APP\u4e0b\u8f7d\uff08\u5b89\u5353\uff09 \u25b6 http://bit.ly/3FVIebU ChatPDF Discord \u670d\u52a1\u5668 \u25b6 https://discord.com/invite/hDZhHSFHQY DiscordTW \u25b6 http://bit.ly/3ZeDll3","title":"Discord \u65b0\u624b\u6559\u7a0b"},{"location":"other/discord-docs/#_1","text":"https://discord.com/ ChatGPT Discord \u670d\u52a1\u5668 \u25b6 https://discord.gg/openai Midjourney Discord \u670d\u52a1\u5668 \u25b6 https://discord.gg/midjourney Discord APP\u4e0b\u8f7d\uff08\u82f9\u679c\uff09 \u25b6 http://bit.ly/3Zl8weK Discord APP\u4e0b\u8f7d\uff08\u5b89\u5353\uff09 \u25b6 http://bit.ly/3FVIebU ChatPDF Discord \u670d\u52a1\u5668 \u25b6 https://discord.com/invite/hDZhHSFHQY DiscordTW \u25b6 http://bit.ly/3ZeDll3","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"other/google-docs/","text":"\u5229\u7528\u8c37\u6b4c\u9ad8\u6548\u641c\u7d22 \u00b6 chatgpt\u63d2\u4ef6\u4f7f\u7528 \u7f8e\u533a Apple ID \u6ce8\u518c\u7533\u8bf7\u6559\u7a0b \u6211\u5982\u4f55\u6212\u6389\u4e86\u5237\u624b\u673a\u7684\u574f\u4e60\u60ef\u300e\u798f\u683c\u884c\u4e3a\u6a21\u578b\u300f \u505aUP\u5206\u4eab \u7f51\u7ad9\u5206\u4eab \u00b6 https://demo.unlock-music.dev/ canva.com https://zhuanlan.zhihu.com/p/642450356 https://discord.com/","title":"\u9ad8\u6548\u5229\u7528\u8c37\u6b4c\u6765\u641c\u7d22"},{"location":"other/google-docs/#_1","text":"chatgpt\u63d2\u4ef6\u4f7f\u7528 \u7f8e\u533a Apple ID \u6ce8\u518c\u7533\u8bf7\u6559\u7a0b \u6211\u5982\u4f55\u6212\u6389\u4e86\u5237\u624b\u673a\u7684\u574f\u4e60\u60ef\u300e\u798f\u683c\u884c\u4e3a\u6a21\u578b\u300f \u505aUP\u5206\u4eab","title":"\u5229\u7528\u8c37\u6b4c\u9ad8\u6548\u641c\u7d22"},{"location":"other/google-docs/#_2","text":"https://demo.unlock-music.dev/ canva.com https://zhuanlan.zhihu.com/p/642450356 https://discord.com/","title":"\u7f51\u7ad9\u5206\u4eab"},{"location":"other/mac-docs/","text":"\u524d\u6cbf \u00b6 \u7531\u4e8e\u8fd0\u7ef4\u8fd9\u4e2a\u884c\u4e1a\u5bf9\u4e8e\u8bb0\u7b14\u8bb0\u6709\u4e00\u4e9b\u8981\u6c42\uff0c\u8fd9\u4e2a\u5e73\u65f6\u6211\u4f1a\u628a\u6211\u4f7f\u7528\u7684\u4e00\u4e9b\u5e38\u7528\u7684\u4e1c\u897f\u5199\u5728\u535a\u5ba2\u4e2d\uff0c\u6765\u603b\u7ed3\u4e0e\u5f52\u7eb3\u3002\u6211\u5229\u7528\u7684 mkdocs-material \u6765\u64b0\u5199\u6587\u7ae0\uff0c\u7528\u7684\u4ed6\u7684\u7406\u7531\u5c31\u662f\uff1a - \u5728Mac\u4e2d\u5f88\u597d\u7684\u517c\u5bb9\uff0c\u8c03\u8bd5\u8d77\u6765\u5f88\u65b9\u4fbf - \u5728\u7f16\u8bd1\u4e4b\u540e\u751f\u6210\u7684\u9759\u6001\u9875\u9762\u5f88\u597d\u770b - \u53ef\u4ee5\u548cgit\u7ed3\u5408\u4f7f\u7528 \u5b89\u88c5\u4e0e\u90e8\u7f72\uff08Mac \u7cfb\u7edf\uff09 \u00b6 Python \u73af\u5883\uff08python3.11\uff09 mkdocs-material==8.0.0 \u7531\u4e8epython\u73af\u5883\u6211\u5df2\u7ecf\u9884\u5236\u4e86\uff0c\u5982\u679c\u6ca1\u6709python\u73af\u5883\u53ef\u4ee5\u4f7f\u7528 brew install python@3.11 pip3 install mkdocs-material==8.0.0 \u62a5\u9519: mkdocs serve \u542f\u52a8mkdocs \u62a5\u9519 ERROR - Config value 'plugins': The \"minify\" plugin is not installed Aborted with 1 Configuration Errors! \u89e3\u51b3: \u8fd9\u662f\u56e0\u4e3a\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u5230\u4e86minify\u8fd9\u4e2a\u63d2\u4ef6\uff0c\u4f46\u662f\u8fd9\u91cc\u6ca1\u6709\u5b89\u88c5\uff0c\u9700\u8981\u901a\u8fc7 pip3 install mkdocs-minify-plugin \u8fdb\u884c\u5b89\u88c5\u3002 \u6587\u7ae0\u53c2\u8003 \u00b6 https://squidfunk.github.io/mkdocs-material/","title":"\u5982\u4f55\u5229\u7528Mac \u5199\u535a\u5ba2\u6587\u7ae0"},{"location":"other/mac-docs/#_1","text":"\u7531\u4e8e\u8fd0\u7ef4\u8fd9\u4e2a\u884c\u4e1a\u5bf9\u4e8e\u8bb0\u7b14\u8bb0\u6709\u4e00\u4e9b\u8981\u6c42\uff0c\u8fd9\u4e2a\u5e73\u65f6\u6211\u4f1a\u628a\u6211\u4f7f\u7528\u7684\u4e00\u4e9b\u5e38\u7528\u7684\u4e1c\u897f\u5199\u5728\u535a\u5ba2\u4e2d\uff0c\u6765\u603b\u7ed3\u4e0e\u5f52\u7eb3\u3002\u6211\u5229\u7528\u7684 mkdocs-material \u6765\u64b0\u5199\u6587\u7ae0\uff0c\u7528\u7684\u4ed6\u7684\u7406\u7531\u5c31\u662f\uff1a - \u5728Mac\u4e2d\u5f88\u597d\u7684\u517c\u5bb9\uff0c\u8c03\u8bd5\u8d77\u6765\u5f88\u65b9\u4fbf - \u5728\u7f16\u8bd1\u4e4b\u540e\u751f\u6210\u7684\u9759\u6001\u9875\u9762\u5f88\u597d\u770b - \u53ef\u4ee5\u548cgit\u7ed3\u5408\u4f7f\u7528","title":"\u524d\u6cbf"},{"location":"other/mac-docs/#mac","text":"Python \u73af\u5883\uff08python3.11\uff09 mkdocs-material==8.0.0 \u7531\u4e8epython\u73af\u5883\u6211\u5df2\u7ecf\u9884\u5236\u4e86\uff0c\u5982\u679c\u6ca1\u6709python\u73af\u5883\u53ef\u4ee5\u4f7f\u7528 brew install python@3.11 pip3 install mkdocs-material==8.0.0 \u62a5\u9519: mkdocs serve \u542f\u52a8mkdocs \u62a5\u9519 ERROR - Config value 'plugins': The \"minify\" plugin is not installed Aborted with 1 Configuration Errors! \u89e3\u51b3: \u8fd9\u662f\u56e0\u4e3a\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u5230\u4e86minify\u8fd9\u4e2a\u63d2\u4ef6\uff0c\u4f46\u662f\u8fd9\u91cc\u6ca1\u6709\u5b89\u88c5\uff0c\u9700\u8981\u901a\u8fc7 pip3 install mkdocs-minify-plugin \u8fdb\u884c\u5b89\u88c5\u3002","title":"\u5b89\u88c5\u4e0e\u90e8\u7f72\uff08Mac \u7cfb\u7edf\uff09"},{"location":"other/mac-docs/#_2","text":"https://squidfunk.github.io/mkdocs-material/","title":"\u6587\u7ae0\u53c2\u8003"},{"location":"prometheus/1.%20prometheus/","text":"curl -X POST -H \"Content-Type: application/json\" -d '{\"name\":\"apikeycurl\", \"role\": \"Admin\"}' http://admin:strongpassword@localhost:3000/api/auth/keys {\"id\":1,\"name\":\"apikeycurl\",\"key\":\"eyJrIjoiVHV2czQxNTdiQnFEWDJ6VjRXMjJpUTc1bGtkR2NmQUoiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoxfQ==\"}%","title":"1. prometheus"},{"location":"python/1-python-docs/","text":"Python \u5165\u95e8\u8bed\u6cd5 \u00b6 \u4ec0\u4e48\u662f\u53d8\u91cf? \u00b6 \u53d8\u91cf\u5c31\u662f\u53ef\u4ee5\u53d8\u5316\u7684\u91cf\uff0c\u91cf\u6307\u7684\u662f\u4e8b\u7269\u7684\u72b6\u6001\uff0c\u6bd4\u5982\u4eba\u7684\u5e74\u9f84\u3001\u6027\u522b\uff0c\u6e38\u620f\u89d2\u8272\u7684\u7b49\u7ea7\u3001\u91d1\u94b1\u7b49\u7b49 \u53d8\u91cf\u7684\u7ec4\u6210\u90e8\u5206: \u53d8\u91cf\u540d+\u8d4b\u503c\u7b26\u53f7+\u53d8\u91cf\u503c \u5982\u4f55\u4f7f\u7528\u53d8\u91cf? \u00b6 \u5148\u5b9a\u4e49,\u540e\u4f7f\u7528 name = 'Jason' # \u8bb0\u4e0b\u4eba\u7684\u540d\u5b57\u4e3a'Jason' sex = '\u7537' # \u8bb0\u4e0b\u4eba\u7684\u6027\u522b\u4e3a\u7537\u6027 age = 18 # \u8bb0\u4e0b\u4eba\u7684\u5e74\u9f84\u4e3a18\u5c81 salary = 30000.1 # \u8bb0\u4e0b\u4eba\u7684\u85aa\u8d44\u4e3a30000.1\u5143 \u53d8\u91cf\u7684\u547d\u540d\u89c4\u8303? \u00b6 \u53d8\u91cf\u540d\u53ea\u80fd\u662f\u5b57\u6bcd\u6570\u5b57\u6216\u8005\u4e0b\u5212\u7ebf\u7684\u4efb\u610f\u7ec4\u5408 \u53d8\u91cf\u540d\u7b2c\u4e00\u4e2a\u5b57\u7b26\u4e0d\u80fd\u662f\u6570\u5b57 \u5173\u952e\u5b57\u4e0d\u80fd\u58f0\u660e\u4e3a\u53d8\u91cf\u540d,\u4f8b\u5982: ['and', 'as', 'assert', 'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 'exec', 'finally', 'for', 'from','global', 'if', 'import', 'in', 'is', 'lambda', 'not', 'or', 'pass', 'print', 'raise', 'return', 'try', 'while', 'with', 'yield'] \u53d8\u91cf\u540d\u7684\u547d\u540d\u98ce\u683c? \u00b6 \u9a7c\u5cf0\u4f53: ToNy = 20 \u7eaf\u5c0f\u5199+\u4e0b\u5212\u7ebf dog_name = zhangsan \u53d8\u91cf\u503c\u7684\u4e09\u5927\u7279\u6027 \u00b6 id : \u53cd\u5e94\u7684\u662f\u53d8\u91cf\u5728\u5185\u5b58\u4e2d\u7684\u552f\u4e00\u7f16\u53f7,\u5185\u5b58\u5730\u5740\u4e0d\u540c id \u80af\u5b9a\u4e0d\u540c type : \u53d8\u91cf\u503c\u7684\u7c7b\u578b values : \u53d8\u91cf\u503c \u57fa\u672c\u6570\u636e\u7c7b\u578b \u00b6 \u5728 python \u4e2d\u5e38\u7528\u7684\u6570\u636e\u7c7b\u578b\u5305\u542b\u4ee5\u4e0b\u51e0\u79cd(int \u7c7b\u578b,float \u6d6e\u70b9\u578b,\u5b57\u7b26\u4e32\u7c7b\u578b,\u5217\u8868,\u5b57\u5178,\u5e03\u5c14\u503c) int \u7c7b\u578b: \u00b6 \u7528\u6765\u8bb0\u5f55\u5e74\u9f84,\u5e74\u4efd,\u5b66\u751f\u4eba\u6570\u7b49\u76f8\u5173\u72b6\u6001 age = 18 class_id = 176 float\u6d6e\u70b9\u578b: \u00b6 \u7528\u6765\u8bb0\u5f55\u8eab\u9ad8\u4f53\u91cd,\u85aa\u8d44\u8fd9\u4e9b\u5c0f\u6570\u7684\u72b6\u6001 weight = 11.5 height = 3434.4 \u5b57\u7b26\u4e32\u7c7b\u578b: \u00b6 \u7528\u6765\u8bb0\u5f55\u4eba\u7684\u540d\u5b57,\u4f4f\u5740,\u63cf\u8ff0\u6027\u8d28\u72b6\u6001 dog_name = 'tom' dog_address = '\u671d\u9633' dog_sex = '\u516c' \u7528\u5355\u5f15\u53f7,\u591a\u5f15\u53f7,\u90fd\u53ef\u4ee5\u5b9a\u4e49\u5b57\u7b26\u4e32,\u672c\u8d28\u4e0a\u662f\u6ca1\u6709\u533a\u522b\u7684 msg = 'my name is lili' \u4f7f\u7528: name='zhangsan' age='18' print(name + age) # \u76f8\u52a0\u5c31\u662f\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u62fc\u63a5 zhangsan18 print(name * 5) zhangsanzhangsanzhangsanzhangsanzhangsan # \u76f8\u4e58\u5c31\u76f8\u5f53\u4e8e\u5b57\u7b26\u4e32*5 \u5217\u8868: \u00b6 \u7528\u4e8e\u8bb0\u5f55\u540c\u4e00\u79cd\u5c5e\u6027\u7684\u591a\u4e2a\u503c,\u4f8b\u5982\u4e00\u4e2a\u73ed\u7ea7\u7684\u6240\u6709\u5b66\u751f\u540d\u5b57 \u5b9a\u4e49: class_name = [ 'zhangsan' , 'lisi' , 'wangwu' ] \u4f7f\u7528: $ python3 Python 3.11.5 ( main , Aug 24 2023 , 15 : 09 : 45 ) [ Clang 14.0.3 ( clang - 1403.0.22.14.1 )] on darwin Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> class_name = [ 'zhangsan' , 'lisi' , 'wangwu' ] # \u901a\u8fc7\u7d22\u5f15\u8fdb\u884c\u53d6\u503c >>> class_name [ 0 ] 'zhangsan' >>> class_name [ 1 ] 'lisi' >>> class_name [ 2 ] 'wangwu' >>> class_info = [[ 'zhangsan' , 12 ],[ 'lisi' ,],[ 'wangwu' , 23 ]] # \u5217\u8868\u5d4c\u5957 >>> class_info [ 1 ][ 0 ] 'lisi' >>> class_info [ 2 ][ 1 ] 23 \u5b57\u5178 dict \u00b6 \u4f5c\u7528: \u6211\u4eec\u6709\u4e00\u4e9b\u573a\u666f,\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u53d8\u91cf\u6765\u8bb0\u5f55\u591a\u4e2a\u503c,\u4f46\u662f\u591a\u4e2a\u503c\u7684\u5c5e\u6027\u662f\u4e0d\u540c\u7684 dic_info = {'name':'lixie','age':20,weight:3434.3} >>> dic_info['age'] 20 >>> dic_info['name'] 'lixie' \u5e03\u5c14\u503c bool \u00b6 True False","title":"Python \u5f00\u53d1-\u57fa\u7840\u8bed\u6cd5"},{"location":"python/1-python-docs/#python","text":"","title":"Python \u5165\u95e8\u8bed\u6cd5"},{"location":"python/1-python-docs/#_1","text":"\u53d8\u91cf\u5c31\u662f\u53ef\u4ee5\u53d8\u5316\u7684\u91cf\uff0c\u91cf\u6307\u7684\u662f\u4e8b\u7269\u7684\u72b6\u6001\uff0c\u6bd4\u5982\u4eba\u7684\u5e74\u9f84\u3001\u6027\u522b\uff0c\u6e38\u620f\u89d2\u8272\u7684\u7b49\u7ea7\u3001\u91d1\u94b1\u7b49\u7b49 \u53d8\u91cf\u7684\u7ec4\u6210\u90e8\u5206: \u53d8\u91cf\u540d+\u8d4b\u503c\u7b26\u53f7+\u53d8\u91cf\u503c","title":"\u4ec0\u4e48\u662f\u53d8\u91cf?"},{"location":"python/1-python-docs/#_2","text":"\u5148\u5b9a\u4e49,\u540e\u4f7f\u7528 name = 'Jason' # \u8bb0\u4e0b\u4eba\u7684\u540d\u5b57\u4e3a'Jason' sex = '\u7537' # \u8bb0\u4e0b\u4eba\u7684\u6027\u522b\u4e3a\u7537\u6027 age = 18 # \u8bb0\u4e0b\u4eba\u7684\u5e74\u9f84\u4e3a18\u5c81 salary = 30000.1 # \u8bb0\u4e0b\u4eba\u7684\u85aa\u8d44\u4e3a30000.1\u5143","title":"\u5982\u4f55\u4f7f\u7528\u53d8\u91cf?"},{"location":"python/1-python-docs/#_3","text":"\u53d8\u91cf\u540d\u53ea\u80fd\u662f\u5b57\u6bcd\u6570\u5b57\u6216\u8005\u4e0b\u5212\u7ebf\u7684\u4efb\u610f\u7ec4\u5408 \u53d8\u91cf\u540d\u7b2c\u4e00\u4e2a\u5b57\u7b26\u4e0d\u80fd\u662f\u6570\u5b57 \u5173\u952e\u5b57\u4e0d\u80fd\u58f0\u660e\u4e3a\u53d8\u91cf\u540d,\u4f8b\u5982: ['and', 'as', 'assert', 'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 'exec', 'finally', 'for', 'from','global', 'if', 'import', 'in', 'is', 'lambda', 'not', 'or', 'pass', 'print', 'raise', 'return', 'try', 'while', 'with', 'yield']","title":"\u53d8\u91cf\u7684\u547d\u540d\u89c4\u8303?"},{"location":"python/1-python-docs/#_4","text":"\u9a7c\u5cf0\u4f53: ToNy = 20 \u7eaf\u5c0f\u5199+\u4e0b\u5212\u7ebf dog_name = zhangsan","title":"\u53d8\u91cf\u540d\u7684\u547d\u540d\u98ce\u683c?"},{"location":"python/1-python-docs/#_5","text":"id : \u53cd\u5e94\u7684\u662f\u53d8\u91cf\u5728\u5185\u5b58\u4e2d\u7684\u552f\u4e00\u7f16\u53f7,\u5185\u5b58\u5730\u5740\u4e0d\u540c id \u80af\u5b9a\u4e0d\u540c type : \u53d8\u91cf\u503c\u7684\u7c7b\u578b values : \u53d8\u91cf\u503c","title":"\u53d8\u91cf\u503c\u7684\u4e09\u5927\u7279\u6027"},{"location":"python/1-python-docs/#_6","text":"\u5728 python \u4e2d\u5e38\u7528\u7684\u6570\u636e\u7c7b\u578b\u5305\u542b\u4ee5\u4e0b\u51e0\u79cd(int \u7c7b\u578b,float \u6d6e\u70b9\u578b,\u5b57\u7b26\u4e32\u7c7b\u578b,\u5217\u8868,\u5b57\u5178,\u5e03\u5c14\u503c)","title":"\u57fa\u672c\u6570\u636e\u7c7b\u578b"},{"location":"python/1-python-docs/#int","text":"\u7528\u6765\u8bb0\u5f55\u5e74\u9f84,\u5e74\u4efd,\u5b66\u751f\u4eba\u6570\u7b49\u76f8\u5173\u72b6\u6001 age = 18 class_id = 176","title":"int \u7c7b\u578b:"},{"location":"python/1-python-docs/#float","text":"\u7528\u6765\u8bb0\u5f55\u8eab\u9ad8\u4f53\u91cd,\u85aa\u8d44\u8fd9\u4e9b\u5c0f\u6570\u7684\u72b6\u6001 weight = 11.5 height = 3434.4","title":"float\u6d6e\u70b9\u578b:"},{"location":"python/1-python-docs/#_7","text":"\u7528\u6765\u8bb0\u5f55\u4eba\u7684\u540d\u5b57,\u4f4f\u5740,\u63cf\u8ff0\u6027\u8d28\u72b6\u6001 dog_name = 'tom' dog_address = '\u671d\u9633' dog_sex = '\u516c' \u7528\u5355\u5f15\u53f7,\u591a\u5f15\u53f7,\u90fd\u53ef\u4ee5\u5b9a\u4e49\u5b57\u7b26\u4e32,\u672c\u8d28\u4e0a\u662f\u6ca1\u6709\u533a\u522b\u7684 msg = 'my name is lili' \u4f7f\u7528: name='zhangsan' age='18' print(name + age) # \u76f8\u52a0\u5c31\u662f\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u62fc\u63a5 zhangsan18 print(name * 5) zhangsanzhangsanzhangsanzhangsanzhangsan # \u76f8\u4e58\u5c31\u76f8\u5f53\u4e8e\u5b57\u7b26\u4e32*5","title":"\u5b57\u7b26\u4e32\u7c7b\u578b:"},{"location":"python/1-python-docs/#_8","text":"\u7528\u4e8e\u8bb0\u5f55\u540c\u4e00\u79cd\u5c5e\u6027\u7684\u591a\u4e2a\u503c,\u4f8b\u5982\u4e00\u4e2a\u73ed\u7ea7\u7684\u6240\u6709\u5b66\u751f\u540d\u5b57 \u5b9a\u4e49: class_name = [ 'zhangsan' , 'lisi' , 'wangwu' ] \u4f7f\u7528: $ python3 Python 3.11.5 ( main , Aug 24 2023 , 15 : 09 : 45 ) [ Clang 14.0.3 ( clang - 1403.0.22.14.1 )] on darwin Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> class_name = [ 'zhangsan' , 'lisi' , 'wangwu' ] # \u901a\u8fc7\u7d22\u5f15\u8fdb\u884c\u53d6\u503c >>> class_name [ 0 ] 'zhangsan' >>> class_name [ 1 ] 'lisi' >>> class_name [ 2 ] 'wangwu' >>> class_info = [[ 'zhangsan' , 12 ],[ 'lisi' ,],[ 'wangwu' , 23 ]] # \u5217\u8868\u5d4c\u5957 >>> class_info [ 1 ][ 0 ] 'lisi' >>> class_info [ 2 ][ 1 ] 23","title":"\u5217\u8868:"},{"location":"python/1-python-docs/#dict","text":"\u4f5c\u7528: \u6211\u4eec\u6709\u4e00\u4e9b\u573a\u666f,\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u53d8\u91cf\u6765\u8bb0\u5f55\u591a\u4e2a\u503c,\u4f46\u662f\u591a\u4e2a\u503c\u7684\u5c5e\u6027\u662f\u4e0d\u540c\u7684 dic_info = {'name':'lixie','age':20,weight:3434.3} >>> dic_info['age'] 20 >>> dic_info['name'] 'lixie'","title":"\u5b57\u5178 dict"},{"location":"python/1-python-docs/#bool","text":"True False","title":"\u5e03\u5c14\u503c bool"},{"location":"python/2-python-docs/","text":"\u7a0b\u5e8f\u4e0e\u7528\u6237\u4ea4\u4e92 \u00b6 \u7528\u6237\u4ea4\u4e92: \u5c31\u662f\u4eba\u5f80\u8ba1\u7b97\u673a input \u5185\u5bb9,\u8ba1\u7b97\u673aprint \u7ed3\u679c input \u8f93\u5165 print \u8f93\u51fa \u4e3b\u673a\u540d ip \u5730\u5740 \u5185\u5b58/\u7cfb\u7edf\u78c1\u76d8 \u5bb9\u5668\u6570\u636e\u76d8 \u670d\u52a1 m1 192.168.1.x 8G \u7cfb\u7edf\u76d8 2T sata sda k8s-m1,keepalived,haproxy m2 192.168.1.x 8G \u7cfb\u7edf\u76d8 2T sata k8s-m2,keepalived,haproxy m3 192.168.1.x 8G \u7cfb\u7edf\u76d8 2T sata k8s-m3,keepalived,haproxy node1 192.168.1.x 2T \u7cfb\u7edf\u76d8 \u65e0 \u65e0","title":"Python \u5f00\u53d1-\u7528\u6237\u4ea4\u4e92"},{"location":"python/2-python-docs/#_1","text":"\u7528\u6237\u4ea4\u4e92: \u5c31\u662f\u4eba\u5f80\u8ba1\u7b97\u673a input \u5185\u5bb9,\u8ba1\u7b97\u673aprint \u7ed3\u679c input \u8f93\u5165 print \u8f93\u51fa \u4e3b\u673a\u540d ip \u5730\u5740 \u5185\u5b58/\u7cfb\u7edf\u78c1\u76d8 \u5bb9\u5668\u6570\u636e\u76d8 \u670d\u52a1 m1 192.168.1.x 8G \u7cfb\u7edf\u76d8 2T sata sda k8s-m1,keepalived,haproxy m2 192.168.1.x 8G \u7cfb\u7edf\u76d8 2T sata k8s-m2,keepalived,haproxy m3 192.168.1.x 8G \u7cfb\u7edf\u76d8 2T sata k8s-m3,keepalived,haproxy node1 192.168.1.x 2T \u7cfb\u7edf\u76d8 \u65e0 \u65e0","title":"\u7a0b\u5e8f\u4e0e\u7528\u6237\u4ea4\u4e92"},{"location":"python/module-docs/","text":"\u4e00. python\u6587\u4ef6\u7684\u4e24\u79cd\u7528\u9014\uff1f - \u5f53\u4f5c\u7a0b\u5e8f\u8fd0\u884c - \u5f53\u4f5c\u6a21\u5757\u5012\u5165 print ( __name__ ) # \u6ca1\u6709\u5bfc\u5165\u6a21\u5757__name__ == '__main__'. \u5bfc\u5165\u4e4b\u540e\u7b49\u4e8e\u6a21\u5757\u540d\u79f0 if __name__ == '__main__' : get () change () else : pass","title":"\u6a21\u5757"},{"location":"python/time-module-docs/","text":"\u5e38\u7528\u6a21\u5757\uff1atime\uff0crandom\uff0cos\u6a21\u5757 \u00b6 ''' import time \u65f6\u95f4\u5206\u4e3a\u4e09\u79cd\u683c\u5f0f \u00b6 1. \u65f6\u95f4\u6233\uff1a\u4ece1970\u5e74\u5230\u73b0\u5728\u7ecf\u5386\u8fc7\u7684\u79d2\u901f \u00b6 print(time.time()) # \u7528\u4e8e\u65f6\u95f4\u95f4\u9694\u7684\u8ba1\u7b97 2. \u6309\u7167\u67d0\u79cd\u683c\u5f0f\u663e\u793a\u65f6\u95f4\uff1a2020-03-30 11:11:11 \u00b6 print(time.strftime('%Y-%m-%d %H:%M:%S %p')) # \u7528\u4e8e\u5c55\u793a\u65f6\u95f4 print(time.strftime('%Y-%m-%d %X')) 3. \u7ed3\u6784\u5316\u65f6\u95f4 \u00b6 res=time.localtime() # \u7528\u4e8e\u5355\u72ec\u83b7\u53d6\u65f6\u95f4\u7684\u67d0\u4e00\u90e8\u5206 print(res) print(res.tm_year) print(res.tm_yday) ''' \u4e8c. datetime \u00b6 ''' import datetime print(datetime.datetime.now() + datetime.timedelta(days=1)) # \u4e00\u5929\u4e4b\u540e\u7684\u65f6\u95f4 print(datetime.datetime.now() + datetime.timedelta(weeks=1)) # \u4e00\u5468\u4e4b\u540e\u7684\u65f6\u95f4 '''","title":"\u5e38\u7528\u6a21\u5757\uff1atime\uff0crandom\uff0cos\u6a21\u5757"},{"location":"python/time-module-docs/#timerandomos","text":"''' import time","title":"\u5e38\u7528\u6a21\u5757\uff1atime\uff0crandom\uff0cos\u6a21\u5757"},{"location":"python/time-module-docs/#_1","text":"","title":"\u65f6\u95f4\u5206\u4e3a\u4e09\u79cd\u683c\u5f0f"},{"location":"python/time-module-docs/#1-1970","text":"print(time.time()) # \u7528\u4e8e\u65f6\u95f4\u95f4\u9694\u7684\u8ba1\u7b97","title":"1. \u65f6\u95f4\u6233\uff1a\u4ece1970\u5e74\u5230\u73b0\u5728\u7ecf\u5386\u8fc7\u7684\u79d2\u901f"},{"location":"python/time-module-docs/#2-2020-03-30-111111","text":"print(time.strftime('%Y-%m-%d %H:%M:%S %p')) # \u7528\u4e8e\u5c55\u793a\u65f6\u95f4 print(time.strftime('%Y-%m-%d %X'))","title":"2. \u6309\u7167\u67d0\u79cd\u683c\u5f0f\u663e\u793a\u65f6\u95f4\uff1a2020-03-30 11:11:11"},{"location":"python/time-module-docs/#3","text":"res=time.localtime() # \u7528\u4e8e\u5355\u72ec\u83b7\u53d6\u65f6\u95f4\u7684\u67d0\u4e00\u90e8\u5206 print(res) print(res.tm_year) print(res.tm_yday) '''","title":"3. \u7ed3\u6784\u5316\u65f6\u95f4"},{"location":"python/time-module-docs/#datetime","text":"''' import datetime print(datetime.datetime.now() + datetime.timedelta(days=1)) # \u4e00\u5929\u4e4b\u540e\u7684\u65f6\u95f4 print(datetime.datetime.now() + datetime.timedelta(weeks=1)) # \u4e00\u5468\u4e4b\u540e\u7684\u65f6\u95f4 '''","title":"\u4e8c. datetime"},{"location":"redis/redis-class-docs/","text":"\u5e8f\u53f7 \u4e3b\u9898 \u5b50\u4e3b\u9898 1 Redis \u7b80\u4ecb 1.1 Redis \u662f\u4ec0\u4e48\uff1f 1.2 Redis \u7684\u4e3b\u8981\u7279\u6027 1.3 Redis \u7684\u5e94\u7528\u573a\u666f 2 Redis \u5b89\u88c5\u4e0e\u914d\u7f6e 2.1 \u5b89\u88c5 Redis 2.2 \u914d\u7f6e Redis 2.3 \u542f\u52a8\u548c\u505c\u6b62 Redis\u670d\u52a1 3 Redis \u6570\u636e\u7c7b\u578b 3.1 \u5b57\u7b26\u4e32\uff08Strings\uff09 3.2 \u54c8\u5e0c\uff08Hashes\uff09 3.3 \u5217\u8868\uff08Lists\uff09 3.4 \u96c6\u5408\uff08Sets\uff09 3.5 \u6709\u5e8f\u96c6\u5408\uff08Sorted sets\uff09 3.6 Bitmaps 3.7 HyperLogLogs 3.8 \u6d41\uff08Streams\uff09 4 Redis \u547d\u4ee4 4.1 \u952e\u547d\u4ee4 4.2 \u5b57\u7b26\u4e32\u547d\u4ee4 4.3 \u54c8\u5e0c\u547d\u4ee4 4.4 \u5217\u8868\u547d\u4ee4 4.5 \u96c6\u5408\u547d\u4ee4 4.6 \u6709\u5e8f\u96c6\u5408\u547d\u4ee4 4.7 \u4e8b\u52a1\u547d\u4ee4 4.8 Pub/Sub \u547d\u4ee4 4.9 \u811a\u672c\u547d\u4ee4","title":"redis \u5927\u7eb2"},{"location":"redis/redis-save-docs/","text":"\u524d\u8a00 \u00b6 Redis\u662f\u4e00\u79cd\u9ad8\u7ea7 key-value \u578b\u7684NoSQL\u6570\u636e\u5e93\u3002\u5b83\u8ddf memcached\u7c7b\u4f3c\u662f\u5185\u5b58\u578b\u6570\u636e\u5e93\uff0c\u4e0d\u8fc7Redis\u6570\u636e\u53ef\u4ee5\u505a\u6301\u4e45\u5316\uff0c\u5373\u5185\u5b58\u4e2d\u7684\u6570\u636e\u53ef\u4ee5\u540c\u6b65\u5230\u78c1\u76d8\u8fdb\u884c\u5b58\u50a8\u3002\u800c\u4e14Redis\u6240\u652f\u6301\u7684\u6570\u636e\u7c7b\u578b\u5f88\u4e30\u5bcc\u3002\u6709\u5b57\u7b26\u4e32\uff0c\u94fe\u8868\uff0c\u96c6\u5408\u548c\u6709\u5e8f\u96c6\u5408\u7b49\u3002Redis\u652f\u6301\u5728\u670d\u52a1\u5668\u7aef\u8ba1\u7b97\u96c6\u5408\u7684\u5e76\u4ea4\u548c\u8865\u96c6(difference)\u7b49\uff0c\u8fd8\u652f\u6301\u591a\u79cd\u6392\u5e8f\u529f\u80fd\u3002\u6240\u4ee5Redis\u4e5f\u53ef\u4ee5\u88ab\u770b\u6210\u662f\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u578b\u670d\u52a1\u5668\u3002 Redis\u7684\u6240\u6709\u6570\u636e\u90fd\u662f\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u7136\u540e\u4e0d\u5b9a\u671f\u7684\u901a\u8fc7\u5f02\u6b65\u65b9\u5f0f\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a(\u8fd9\u79f0\u4e3a\u201c\u534a\u6301\u4e45\u5316\u6a21\u5f0f\u201d RDB)\uff1b\u4e5f\u53ef\u4ee5\u628a\u6bcf\u4e00\u6b21\u6570\u636e\u53d8\u5316\u90fd\u5199\u5165\u5230\u4e00\u4e2a append only file(AOF)\u91cc\u9762(\u8fd9\u79f0\u4e3a\u201c\u5168\u6301\u4e45\u5316\u6a21\u5f0f\u201d)\u3002 Redis\u7684\u6570\u636e\u90fd\u5b58\u653e\u5728\u5185\u5b58\u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u914d\u7f6e\u6301\u4e45\u5316\u529f\u80fd\uff0cRedis\u91cd\u542f\u540e\u6570\u636e\u5c31\u5168\u4e22\u5931\u4e86\uff0c\u4e8e\u662f\u9700\u8981\u5f00\u542fRedis\u7684\u6301\u4e45\u5316\u529f\u80fd\uff0c\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a\uff0c\u5f53Redis\u91cd\u542f\u540e\uff0c\u53ef\u4ee5\u4ece\u78c1\u76d8\u4e2d\u6062\u590d\u6570\u636e\u3002Redis\u63d0\u4f9b\u4e24\u79cd\u65b9\u5f0f\u8fdb\u884c\u6301\u4e45\u5316\uff0c\u4e00\u79cd\u662f RDB \u6301\u4e45\u5316\uff08\u539f\u7406\u662f\u5c06 Redis\u5728\u5185\u5b58\u4e2d\u7684\u6570\u636e\u5e93\u8bb0\u5f55\u5b9a\u65f6 dump \u5230\u78c1\u76d8\u4e0a\u7684 RDB \u6301\u4e45\u5316\uff09\uff0c\u53e6\u5916\u4e00\u79cd\u662f AOF\uff08append only file\uff09\u6301\u4e45\u5316\uff08\u539f\u7406\u662f\u5c06Redis\u7684\u64cd\u4f5c\u65e5\u5fd7\u4ee5\u8ffd\u52a0\u7684\u65b9\u5f0f\u5199\u5165\u6587\u4ef6\uff09\u3002\u90a3\u4e48\u8fd9\u4e24\u79cd\u6301\u4e45\u5316\u65b9\u5f0f\u6709\u4ec0\u4e48\u533a\u522b\u5462\uff0c\u6539\u5982\u4f55\u9009\u62e9\u5462\uff1f Redis \u6301\u4e45\u5316\u673a\u5236\u4f18\u7f3a\u70b9\u5bf9\u6bd4 \u00b6 RDB \u4f18\u52bf\uff1a \u5355\u4e00\u6587\u4ef6\uff0c\u9002\u5408\u5927\u89c4\u6a21\u6570\u636e\u5907\u4efd\u548c\u707e\u96be\u6062\u590d\u3002 \u6027\u80fd\u9ad8\uff0c\u56e0\u4e3a Redis \u4e3b\u8fdb\u7a0b\u5728\u6301\u4e45\u5316\u65f6\u53ea\u9700\u505a fork \u64cd\u4f5c\uff0c\u7531\u5b50\u8fdb\u7a0b\u5b8c\u6210\u5b9e\u9645\u7684\u6301\u4e45\u5316\u5de5\u4f5c\u3002 \u5bf9\u4e8e\u5927\u6570\u636e\u96c6\uff0cRDB \u542f\u52a8\u6548\u7387\u66f4\u9ad8\u3002 \u52a3\u52bf\uff1a \u65e0\u6cd5\u505a\u5230\u5b9e\u65f6\u6216\u51c6\u5b9e\u65f6\u6301\u4e45\u5316\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6700\u8fd1\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\u4e22\u5931\u3002 \u82e5\u6570\u636e\u96c6\u8f83\u5927\uff0cfork \u5b50\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u5bfc\u81f4\u670d\u52a1\u5668\u77ed\u6682\u505c\u6b62\u670d\u52a1\u3002 AOF \u4f18\u52bf\uff1a \u63d0\u4f9b\u66f4\u9ad8\u7684\u6570\u636e\u5b89\u5168\u6027\uff0c\u53ef\u901a\u8fc7\u914d\u7f6e\u5b9e\u73b0\u6bcf\u6b21\u4fee\u6539\u540e\u540c\u6b65\uff0c\u51cf\u5c11\u6570\u636e\u4e22\u5931\u7684\u53ef\u80fd\u3002 \u5373\u4f7f\u5728\u5199\u5165\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u6545\u969c\uff0c\u4e5f\u4e0d\u4f1a\u7834\u574f\u5df2\u6709\u7684 AOF \u6587\u4ef6\u3002 \u652f\u6301\u65e5\u5fd7\u91cd\u5199\uff0c\u5373\u5728\u4fdd\u8bc1\u6570\u636e\u5b89\u5168\u6027\u7684\u524d\u63d0\u4e0b\uff0c\u51cf\u5c11\u78c1\u76d8\u5360\u7528\u3002 \u65e5\u5fd7\u683c\u5f0f\u6e05\u6670\uff0c\u6613\u4e8e\u7406\u89e3\u548c\u4eba\u5de5\u5904\u7406\u3002 \u52a3\u52bf\uff1a \u5bf9\u4e8e\u76f8\u540c\u7684\u6570\u636e\u96c6\uff0cAOF \u6587\u4ef6\u901a\u5e38\u6bd4 RDB \u6587\u4ef6\u5927\u3002 \u6570\u636e\u6062\u590d\u901f\u5ea6\u901a\u5e38\u6bd4 RDB \u6162\u3002 \u6839\u636e\u540c\u6b65\u7b56\u7565\u7684\u4e0d\u540c\uff0c\u53ef\u80fd\u4f1a\u5bf9\u6027\u80fd\u4ea7\u751f\u5f71\u54cd\u3002 \u9009\u62e9\u6807\u51c6 \u5982\u679c\u9700\u8981\u6700\u5927\u7a0b\u5ea6\u7684\u6570\u636e\u6301\u4e45\u6027\uff0c\u5e76\u4e14\u53ef\u4ee5\u63a5\u53d7\u4e00\u4e9b\u6027\u80fd\u5f00\u9500\uff0c\u90a3\u4e48 AOF \u662f\u4e00\u4e2a\u597d\u7684\u9009\u62e9\u3002 \u5982\u679c\u5e94\u7528\u4e3b\u8981\u662f\u8bfb\u53d6\u64cd\u4f5c\uff0c\u6570\u636e\u66f4\u65b0\u4e0d\u9891\u7e41\uff0c\u6216\u8005\u66f4\u5173\u5fc3\u6027\u80fd\u800c\u4e0d\u662f\u6570\u636e\u6301\u4e45\u6027\uff0c\u90a3\u4e48 RDB \u53ef\u80fd\u66f4\u9002\u5408\u3002 \u4e5f\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528 RDB \u548c AOF\uff0c\u7ed3\u5408\u4e24\u8005\u7684\u4f18\u70b9\u3002\u4f8b\u5982\uff0c\u4f7f\u7528 RDB \u8fdb\u884c\u5b9a\u671f\u5907\u4efd\uff0c\u7528\u4e8e\u5feb\u901f\u6062\u590d\u5927\u6570\u636e\u96c6\uff0c\u540c\u65f6\u4f7f\u7528 AOF \u63d0\u4f9b\u66f4\u9ad8\u7684\u6570\u636e\u6301\u4e45\u6027\u3002 Redis \u6301\u4e45\u5316\u914d\u7f6e \u00b6 RDB\u6301\u4e45\u5316\u914d\u7f6e \u00b6 Redis\u4f1a\u5c06\u6570\u636e\u96c6\u7684\u5feb\u7167dump\u5230dump.rdb\u6587\u4ef6\u4e2d\u3002\u6b64\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u6765\u4fee\u6539Redis\u670d\u52a1\u5668dump\u5feb\u7167\u7684\u9891\u7387\uff0c\u5728\u6253\u5f00 6379.conf\u6587\u4ef6\u4e4b\u540e\uff0c\u6211\u4eec\u641c\u7d22save\u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u914d\u7f6e\u4fe1\u606f\uff1a save 900 1 #\u5728900\u79d2(15 \u5206\u949f)\u4e4b\u540e\uff0c\u5982\u679c\u81f3\u5c11\u67091\u4e2akey\u53d1\u751f\u53d8\u5316\uff0c\u5219dump\u5185\u5b58\u5feb\u7167\u3002 save 300 10 #\u5728300\u79d2(5 \u5206\u949f)\u4e4b\u540e\uff0c\u5982\u679c\u81f3\u5c11\u670910\u4e2akey\u53d1\u751f\u53d8\u5316\uff0c\u5219dump\u5185\u5b58\u5feb\u7167\u3002 save 60 10000 #\u572860\u79d2(1 \u5206\u949f)\u4e4b\u540e\uff0c\u5982\u679c\u81f3\u5c11\u670910000\u4e2akey\u53d1\u751f\u53d8\u5316\uff0c\u5219dump\u5185\u5b58\u5feb\u7167\u3002 [ root@redis ~ ] # vim /etc/redis/6379.conf 219 save 900 1 220 save 300 10 221 save 60 10000 242 rdbcompression yes 254 dbfilename dump.rdb 264 dir /var/lib/redis/6379 [ root@redis utils ] # redis-cli -h 127.0.0.1 -p 6379 127 .0.0.1:6379> set name crushlinux OK 127 .0.0.1:6379> set age 18 OK 127 .0.0.1:6379> set address beijing OK 127 .0.0.1:6379> 127 .0.0.1:6379> keys * 1 ) \"address\" 2 ) \"age\" 3 ) \"name\" 127 .0.0.1:6379> save OK 127 .0.0.1:6379> exit [ root@redis ~ ] # ls /var/lib/redis/6379 dump.rdb [ root@redis ~ ] # /etc/init.d/redis_6379 restart Stopping ... Redis stopped Starting Redis server... [ root@redis ~ ] # redis-cli -h 127.0.0.1 -p 6379 127 .0.0.1:6379> keys * 1 ) \"name\" 2 ) \"address\" 127 .0.0.1:6379> get name \"crushlinux\" 127 .0.0.1:6379> get address \"beijing\" [ root@redis ~ ] # /etc/init.d/redis_6379 stop Stopping ... Redis stopped [ root@redis ~ ] # rm -rf /var/lib/redis/6379/dump.rdb [ root@redis ~ ] # /etc/init.d/redis_6379 start Starting Redis server... [ root@redis ~ ] # ls /var/lib/redis/6379/ [ root@redis ~ ] # redis-cli -h 127.0.0.1 -p 6379 127 .0.0.1:6379> keys * ( empty list or set ) AOF\u6301\u4e45\u5316\u914d\u7f6e \u00b6 Redis\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b58\u5728\u4e09\u79cd\u540c\u6b65\u65b9\u5f0f\uff0c\u5b83\u4eec\u5206\u522b\u662f\uff1a appendfsync always #\u6bcf\u6b21\u6709\u6570\u636e\u4fee\u6539\u53d1\u751f\u65f6\u90fd\u4f1a\u5199\u5165AOF\u6587\u4ef6\u3002 appendfsync everysec #\u6bcf\u79d2\u949f\u540c\u6b65\u4e00\u6b21\uff0c\u8be5\u7b56\u7565\u4e3aAOF\u7684\u7f3a\u7701\u7b56\u7565\u3002 appendfsync no #\u4ece\u4e0d\u540c\u6b65\u3002\u9ad8\u6548\u4f46\u662f\u6570\u636e\u4e0d\u4f1a\u88ab\u6301\u4e45\u5316\u3002 [root@redis ~]# /etc/init.d/redis_6379 stop [root@redis ~]# rm -rf /var/lib/redis/6379/dump.rdb [root@redis ~]# /etc/init.d/redis_6379 start [root@redis ~]# vim /etc/redis/6379.conf 673 appendonly yes 703 appendfsync everysec 677 appendfilename \"appendonly.aof\" 744 auto-aof-rewrite-percentage 100 745 auto-aof-rewrite-min-size 64mb [root@redis ~]# service redis_6379 restart [root@redis ~]# redis-cli 127.0.0.1:6379> set name crushlinux OK 127.0.0.1:6379> set age 18 OK 127.0.0.1:6379> set address beijing OK 127.0.0.1:6379> exit [root@redis ~]# ls /var/lib/redis/6379/ appendonly.aof dump.rdb [root@redis ~]# rm -rf /var/lib/redis/6379/dump.rdb [root@redis ~]# cat /var/lib/redis/6379/appendonly.aof *2 $6 SELECT $1 0 *3 $3 set $4 name $10 crushlinux *3 $3 set $3 age $2 18 *3 $3 set $7 address $7 beijing [root@redis ~]# service redis_6379 restart Stopping ... Redis stopped Starting Redis server... [root@redis ~]# redis-cli 127.0.0.1:6379> keys * 1) \"age\" 2) \"address\" 3) \"name\" 127.0.0.1:6379> exit AOF \u91cd\u5199\u529f\u80fd \u00b6 AOF\u6301\u4e45\u5316\u5b58\u5728\u4ee5\u4e0b\u7f3a\u70b9\uff1a - Redis\u4f1a\u4e0d\u65ad\u5730\u5c06\u88ab\u6267\u884c\u7684\u547d\u4ee4\u8bb0\u5f55\u5230AOF\u6587\u4ef6\u91cc\u9762\uff0c\u6240\u4ee5\u968f\u7740Redis\u4e0d\u65ad\u8fd0\u884c\uff0cAOF\u6587\u4ef6\u7684\u4f53\u79ef\u4e5f\u4f1a\u4e0d\u65ad\u589e\u957f\u3002\u5728\u6781\u7aef\u60c5\u51b5\u4e0b\uff0c\u4f53\u79ef\u4e0d\u65ad\u589e\u5927\u7684AOF\u6587\u4ef6\u751a\u81f3\u53ef\u80fd\u4f1a\u7528\u5b8c\u786c\u76d8\u7684\u6240\u6709\u53ef\u7528\u7a7a\u95f4\u3002 - Redis\u5728\u91cd\u542f\u4e4b\u540e\u9700\u8981\u901a\u8fc7\u91cd\u65b0\u6267\u884c AOF \u6587\u4ef6\u8bb0\u5f55\u7684\u6240\u6709\u5199\u547d\u4ee4\u6765\u8fd8\u539f\u6570\u636e\u96c6\uff0c\u6240\u4ee5\u5982\u679cAOF\u6587\u4ef6\u7684\u4f53\u79ef\u975e\u5e38\u5927\uff0c\u90a3\u4e48\u8fd8\u539f\u64cd\u4f5c\u6267\u884c\u7684\u65f6\u95f4\u5c31\u53ef\u80fd\u4f1a\u975e\u5e38\u957f\u3002 \u4e3a\u4e86\u89e3\u51b3AOF\u6587\u4ef6\u4f53\u79ef\u4e0d\u65ad\u589e\u5927\u7684\u95ee\u9898\uff0c\u7528\u6237\u53ef\u4ee5\u5411Redis\u53d1\u9001BGREWRITEAOF\u547d\u4ee4\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u901a\u8fc7\u79fb\u9664AOF\u6587\u4ef6\u4e2d\u7684\u5197\u4f59\u547d\u4ee4\u6765\u91cd\u5199\uff08rewrite\uff09AOF\u6587\u4ef6\uff0c\u4f7fAOF\u6587\u4ef6\u7684\u4f53\u79ef\u53d8\u5f97\u5c3d\u53ef\u80fd\u5730\u5c0f\u3002BGREWRITEAOF\u7684\u5de5\u4f5c\u539f\u7406\u548cBGSAVE\u521b\u5efa\u5feb\u7167\u7684\u5de5\u4f5c\u539f\u7406\u975e\u5e38\u76f8\u4f3c\uff1a Redis\u4f1a\u521b\u5efa\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u7136\u540e\u7531\u5b50\u8fdb\u7a0b\u8d1f\u8d23\u5bf9AOF\u6587\u4ef6\u8fdb\u884c\u91cd\u5199\u3002\u56e0\u4e3aAOF\u6587\u4ef6\u91cd\u5199\u4e5f\u9700\u8981\u7528\u5230\u5b50\u8fdb\u7a0b\uff0c\u6240\u4ee5\u5feb\u7167\u6301\u4e45\u5316\u56e0\u4e3a\u521b\u5efa\u5b50\u8fdb\u7a0b\u800c\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u548c\u5185\u5b58\u5360\u7528\u95ee\u9898\uff0c\u5728AOF\u6301\u4e45\u5316\u4e2d\u4e5f\u540c\u6837\u5b58\u5728\u3002 \u8ddf\u5feb\u7167\u6301\u4e45\u5316\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6esave\u9009\u9879\u6765\u81ea\u52a8\u6267\u884cBGSAVE\u4e00\u6837\uff0cAOF\u6301\u4e45\u5316\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6eauto-aof-rewrite-percentage\u9009\u9879\u548c auto-aof-rewrite-min-size\u9009\u9879\u6765\u81ea\u52a8\u6267\u884cBGREWRITEAOF\u3002 \u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5047\u8bbe\u7528\u6237\u5bf9Redis\u8bbe\u7f6e\u4e86\u914d\u7f6e\u9009\u9879auto-aof-rewrite-percentage 100\u548c auto-aof-rewrite-min-size 64mb\uff0c\u5e76\u4e14\u542f\u52a8\u4e86AOF\u6301\u4e45\u5316\uff0c\u90a3\u4e48\u5f53AOF\u6587\u4ef6\u7684\u4f53\u79ef\u5927\u4e8e64MB\uff0c\u5e76\u4e14AOF\u6587\u4ef6\u7684\u4f53\u79ef\u6bd4\u4e0a\u4e00\u6b21\u91cd\u5199\u4e4b\u540e\u7684\u4f53\u79ef\u5927\u4e86\u81f3\u5c11\u4e00\u500d\uff08100%\uff09\u7684\u65f6\u5019\uff0cRedis\u5c06\u6267\u884c BGREWRITEAOF \u547d\u4ee4\u3002\u5982\u679cAOF\u91cd\u5199\u6267\u884c\u5f97\u8fc7\u4e8e\u9891\u7e41\u7684\u8bdd\uff0c\u7528\u6237\u53ef\u4ee5\u8003\u8651\u5c06 auto-aof-rewrite-percentage \u9009\u9879\u7684\u503c\u8bbe\u7f6e\u4e3a100\u4ee5\u4e0a\uff0c\u8fd9\u79cd\u505a\u6cd5\u53ef\u4ee5\u8ba9Redis\u5728AOF\u6587\u4ef6\u7684\u4f53\u79ef\u53d8\u5f97\u66f4\u5927\u4e4b\u540e\u624d\u6267\u884c\u91cd\u5199\u64cd\u4f5c\uff0c\u4e0d\u8fc7\u4e5f\u4f1a\u8ba9Redis\u5728\u542f\u52a8\u65f6\u8fd8\u539f\u6570\u636e\u96c6\u6240\u9700\u7684\u65f6\u95f4\u53d8\u5f97\u66f4\u957f\u3002 \u53c2\u8003\u6587\u7ae0 \u00b6 https://github.com/barry-boy/barry-boy.github.io/issues/74","title":"redis \u6301\u4e45\u5316"},{"location":"redis/redis-save-docs/#_1","text":"Redis\u662f\u4e00\u79cd\u9ad8\u7ea7 key-value \u578b\u7684NoSQL\u6570\u636e\u5e93\u3002\u5b83\u8ddf memcached\u7c7b\u4f3c\u662f\u5185\u5b58\u578b\u6570\u636e\u5e93\uff0c\u4e0d\u8fc7Redis\u6570\u636e\u53ef\u4ee5\u505a\u6301\u4e45\u5316\uff0c\u5373\u5185\u5b58\u4e2d\u7684\u6570\u636e\u53ef\u4ee5\u540c\u6b65\u5230\u78c1\u76d8\u8fdb\u884c\u5b58\u50a8\u3002\u800c\u4e14Redis\u6240\u652f\u6301\u7684\u6570\u636e\u7c7b\u578b\u5f88\u4e30\u5bcc\u3002\u6709\u5b57\u7b26\u4e32\uff0c\u94fe\u8868\uff0c\u96c6\u5408\u548c\u6709\u5e8f\u96c6\u5408\u7b49\u3002Redis\u652f\u6301\u5728\u670d\u52a1\u5668\u7aef\u8ba1\u7b97\u96c6\u5408\u7684\u5e76\u4ea4\u548c\u8865\u96c6(difference)\u7b49\uff0c\u8fd8\u652f\u6301\u591a\u79cd\u6392\u5e8f\u529f\u80fd\u3002\u6240\u4ee5Redis\u4e5f\u53ef\u4ee5\u88ab\u770b\u6210\u662f\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u578b\u670d\u52a1\u5668\u3002 Redis\u7684\u6240\u6709\u6570\u636e\u90fd\u662f\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u7136\u540e\u4e0d\u5b9a\u671f\u7684\u901a\u8fc7\u5f02\u6b65\u65b9\u5f0f\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a(\u8fd9\u79f0\u4e3a\u201c\u534a\u6301\u4e45\u5316\u6a21\u5f0f\u201d RDB)\uff1b\u4e5f\u53ef\u4ee5\u628a\u6bcf\u4e00\u6b21\u6570\u636e\u53d8\u5316\u90fd\u5199\u5165\u5230\u4e00\u4e2a append only file(AOF)\u91cc\u9762(\u8fd9\u79f0\u4e3a\u201c\u5168\u6301\u4e45\u5316\u6a21\u5f0f\u201d)\u3002 Redis\u7684\u6570\u636e\u90fd\u5b58\u653e\u5728\u5185\u5b58\u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u914d\u7f6e\u6301\u4e45\u5316\u529f\u80fd\uff0cRedis\u91cd\u542f\u540e\u6570\u636e\u5c31\u5168\u4e22\u5931\u4e86\uff0c\u4e8e\u662f\u9700\u8981\u5f00\u542fRedis\u7684\u6301\u4e45\u5316\u529f\u80fd\uff0c\u5c06\u6570\u636e\u4fdd\u5b58\u5230\u78c1\u76d8\u4e0a\uff0c\u5f53Redis\u91cd\u542f\u540e\uff0c\u53ef\u4ee5\u4ece\u78c1\u76d8\u4e2d\u6062\u590d\u6570\u636e\u3002Redis\u63d0\u4f9b\u4e24\u79cd\u65b9\u5f0f\u8fdb\u884c\u6301\u4e45\u5316\uff0c\u4e00\u79cd\u662f RDB \u6301\u4e45\u5316\uff08\u539f\u7406\u662f\u5c06 Redis\u5728\u5185\u5b58\u4e2d\u7684\u6570\u636e\u5e93\u8bb0\u5f55\u5b9a\u65f6 dump \u5230\u78c1\u76d8\u4e0a\u7684 RDB \u6301\u4e45\u5316\uff09\uff0c\u53e6\u5916\u4e00\u79cd\u662f AOF\uff08append only file\uff09\u6301\u4e45\u5316\uff08\u539f\u7406\u662f\u5c06Redis\u7684\u64cd\u4f5c\u65e5\u5fd7\u4ee5\u8ffd\u52a0\u7684\u65b9\u5f0f\u5199\u5165\u6587\u4ef6\uff09\u3002\u90a3\u4e48\u8fd9\u4e24\u79cd\u6301\u4e45\u5316\u65b9\u5f0f\u6709\u4ec0\u4e48\u533a\u522b\u5462\uff0c\u6539\u5982\u4f55\u9009\u62e9\u5462\uff1f","title":"\u524d\u8a00"},{"location":"redis/redis-save-docs/#redis","text":"RDB \u4f18\u52bf\uff1a \u5355\u4e00\u6587\u4ef6\uff0c\u9002\u5408\u5927\u89c4\u6a21\u6570\u636e\u5907\u4efd\u548c\u707e\u96be\u6062\u590d\u3002 \u6027\u80fd\u9ad8\uff0c\u56e0\u4e3a Redis \u4e3b\u8fdb\u7a0b\u5728\u6301\u4e45\u5316\u65f6\u53ea\u9700\u505a fork \u64cd\u4f5c\uff0c\u7531\u5b50\u8fdb\u7a0b\u5b8c\u6210\u5b9e\u9645\u7684\u6301\u4e45\u5316\u5de5\u4f5c\u3002 \u5bf9\u4e8e\u5927\u6570\u636e\u96c6\uff0cRDB \u542f\u52a8\u6548\u7387\u66f4\u9ad8\u3002 \u52a3\u52bf\uff1a \u65e0\u6cd5\u505a\u5230\u5b9e\u65f6\u6216\u51c6\u5b9e\u65f6\u6301\u4e45\u5316\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6700\u8fd1\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\u4e22\u5931\u3002 \u82e5\u6570\u636e\u96c6\u8f83\u5927\uff0cfork \u5b50\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u5bfc\u81f4\u670d\u52a1\u5668\u77ed\u6682\u505c\u6b62\u670d\u52a1\u3002 AOF \u4f18\u52bf\uff1a \u63d0\u4f9b\u66f4\u9ad8\u7684\u6570\u636e\u5b89\u5168\u6027\uff0c\u53ef\u901a\u8fc7\u914d\u7f6e\u5b9e\u73b0\u6bcf\u6b21\u4fee\u6539\u540e\u540c\u6b65\uff0c\u51cf\u5c11\u6570\u636e\u4e22\u5931\u7684\u53ef\u80fd\u3002 \u5373\u4f7f\u5728\u5199\u5165\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u6545\u969c\uff0c\u4e5f\u4e0d\u4f1a\u7834\u574f\u5df2\u6709\u7684 AOF \u6587\u4ef6\u3002 \u652f\u6301\u65e5\u5fd7\u91cd\u5199\uff0c\u5373\u5728\u4fdd\u8bc1\u6570\u636e\u5b89\u5168\u6027\u7684\u524d\u63d0\u4e0b\uff0c\u51cf\u5c11\u78c1\u76d8\u5360\u7528\u3002 \u65e5\u5fd7\u683c\u5f0f\u6e05\u6670\uff0c\u6613\u4e8e\u7406\u89e3\u548c\u4eba\u5de5\u5904\u7406\u3002 \u52a3\u52bf\uff1a \u5bf9\u4e8e\u76f8\u540c\u7684\u6570\u636e\u96c6\uff0cAOF \u6587\u4ef6\u901a\u5e38\u6bd4 RDB \u6587\u4ef6\u5927\u3002 \u6570\u636e\u6062\u590d\u901f\u5ea6\u901a\u5e38\u6bd4 RDB \u6162\u3002 \u6839\u636e\u540c\u6b65\u7b56\u7565\u7684\u4e0d\u540c\uff0c\u53ef\u80fd\u4f1a\u5bf9\u6027\u80fd\u4ea7\u751f\u5f71\u54cd\u3002 \u9009\u62e9\u6807\u51c6 \u5982\u679c\u9700\u8981\u6700\u5927\u7a0b\u5ea6\u7684\u6570\u636e\u6301\u4e45\u6027\uff0c\u5e76\u4e14\u53ef\u4ee5\u63a5\u53d7\u4e00\u4e9b\u6027\u80fd\u5f00\u9500\uff0c\u90a3\u4e48 AOF \u662f\u4e00\u4e2a\u597d\u7684\u9009\u62e9\u3002 \u5982\u679c\u5e94\u7528\u4e3b\u8981\u662f\u8bfb\u53d6\u64cd\u4f5c\uff0c\u6570\u636e\u66f4\u65b0\u4e0d\u9891\u7e41\uff0c\u6216\u8005\u66f4\u5173\u5fc3\u6027\u80fd\u800c\u4e0d\u662f\u6570\u636e\u6301\u4e45\u6027\uff0c\u90a3\u4e48 RDB \u53ef\u80fd\u66f4\u9002\u5408\u3002 \u4e5f\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528 RDB \u548c AOF\uff0c\u7ed3\u5408\u4e24\u8005\u7684\u4f18\u70b9\u3002\u4f8b\u5982\uff0c\u4f7f\u7528 RDB \u8fdb\u884c\u5b9a\u671f\u5907\u4efd\uff0c\u7528\u4e8e\u5feb\u901f\u6062\u590d\u5927\u6570\u636e\u96c6\uff0c\u540c\u65f6\u4f7f\u7528 AOF \u63d0\u4f9b\u66f4\u9ad8\u7684\u6570\u636e\u6301\u4e45\u6027\u3002","title":"Redis \u6301\u4e45\u5316\u673a\u5236\u4f18\u7f3a\u70b9\u5bf9\u6bd4"},{"location":"redis/redis-save-docs/#redis_1","text":"","title":"Redis \u6301\u4e45\u5316\u914d\u7f6e"},{"location":"redis/redis-save-docs/#rdb","text":"Redis\u4f1a\u5c06\u6570\u636e\u96c6\u7684\u5feb\u7167dump\u5230dump.rdb\u6587\u4ef6\u4e2d\u3002\u6b64\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u6765\u4fee\u6539Redis\u670d\u52a1\u5668dump\u5feb\u7167\u7684\u9891\u7387\uff0c\u5728\u6253\u5f00 6379.conf\u6587\u4ef6\u4e4b\u540e\uff0c\u6211\u4eec\u641c\u7d22save\u53ef\u4ee5\u770b\u5230\u4e0b\u9762\u7684\u914d\u7f6e\u4fe1\u606f\uff1a save 900 1 #\u5728900\u79d2(15 \u5206\u949f)\u4e4b\u540e\uff0c\u5982\u679c\u81f3\u5c11\u67091\u4e2akey\u53d1\u751f\u53d8\u5316\uff0c\u5219dump\u5185\u5b58\u5feb\u7167\u3002 save 300 10 #\u5728300\u79d2(5 \u5206\u949f)\u4e4b\u540e\uff0c\u5982\u679c\u81f3\u5c11\u670910\u4e2akey\u53d1\u751f\u53d8\u5316\uff0c\u5219dump\u5185\u5b58\u5feb\u7167\u3002 save 60 10000 #\u572860\u79d2(1 \u5206\u949f)\u4e4b\u540e\uff0c\u5982\u679c\u81f3\u5c11\u670910000\u4e2akey\u53d1\u751f\u53d8\u5316\uff0c\u5219dump\u5185\u5b58\u5feb\u7167\u3002 [ root@redis ~ ] # vim /etc/redis/6379.conf 219 save 900 1 220 save 300 10 221 save 60 10000 242 rdbcompression yes 254 dbfilename dump.rdb 264 dir /var/lib/redis/6379 [ root@redis utils ] # redis-cli -h 127.0.0.1 -p 6379 127 .0.0.1:6379> set name crushlinux OK 127 .0.0.1:6379> set age 18 OK 127 .0.0.1:6379> set address beijing OK 127 .0.0.1:6379> 127 .0.0.1:6379> keys * 1 ) \"address\" 2 ) \"age\" 3 ) \"name\" 127 .0.0.1:6379> save OK 127 .0.0.1:6379> exit [ root@redis ~ ] # ls /var/lib/redis/6379 dump.rdb [ root@redis ~ ] # /etc/init.d/redis_6379 restart Stopping ... Redis stopped Starting Redis server... [ root@redis ~ ] # redis-cli -h 127.0.0.1 -p 6379 127 .0.0.1:6379> keys * 1 ) \"name\" 2 ) \"address\" 127 .0.0.1:6379> get name \"crushlinux\" 127 .0.0.1:6379> get address \"beijing\" [ root@redis ~ ] # /etc/init.d/redis_6379 stop Stopping ... Redis stopped [ root@redis ~ ] # rm -rf /var/lib/redis/6379/dump.rdb [ root@redis ~ ] # /etc/init.d/redis_6379 start Starting Redis server... [ root@redis ~ ] # ls /var/lib/redis/6379/ [ root@redis ~ ] # redis-cli -h 127.0.0.1 -p 6379 127 .0.0.1:6379> keys * ( empty list or set )","title":"RDB\u6301\u4e45\u5316\u914d\u7f6e"},{"location":"redis/redis-save-docs/#aof","text":"Redis\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b58\u5728\u4e09\u79cd\u540c\u6b65\u65b9\u5f0f\uff0c\u5b83\u4eec\u5206\u522b\u662f\uff1a appendfsync always #\u6bcf\u6b21\u6709\u6570\u636e\u4fee\u6539\u53d1\u751f\u65f6\u90fd\u4f1a\u5199\u5165AOF\u6587\u4ef6\u3002 appendfsync everysec #\u6bcf\u79d2\u949f\u540c\u6b65\u4e00\u6b21\uff0c\u8be5\u7b56\u7565\u4e3aAOF\u7684\u7f3a\u7701\u7b56\u7565\u3002 appendfsync no #\u4ece\u4e0d\u540c\u6b65\u3002\u9ad8\u6548\u4f46\u662f\u6570\u636e\u4e0d\u4f1a\u88ab\u6301\u4e45\u5316\u3002 [root@redis ~]# /etc/init.d/redis_6379 stop [root@redis ~]# rm -rf /var/lib/redis/6379/dump.rdb [root@redis ~]# /etc/init.d/redis_6379 start [root@redis ~]# vim /etc/redis/6379.conf 673 appendonly yes 703 appendfsync everysec 677 appendfilename \"appendonly.aof\" 744 auto-aof-rewrite-percentage 100 745 auto-aof-rewrite-min-size 64mb [root@redis ~]# service redis_6379 restart [root@redis ~]# redis-cli 127.0.0.1:6379> set name crushlinux OK 127.0.0.1:6379> set age 18 OK 127.0.0.1:6379> set address beijing OK 127.0.0.1:6379> exit [root@redis ~]# ls /var/lib/redis/6379/ appendonly.aof dump.rdb [root@redis ~]# rm -rf /var/lib/redis/6379/dump.rdb [root@redis ~]# cat /var/lib/redis/6379/appendonly.aof *2 $6 SELECT $1 0 *3 $3 set $4 name $10 crushlinux *3 $3 set $3 age $2 18 *3 $3 set $7 address $7 beijing [root@redis ~]# service redis_6379 restart Stopping ... Redis stopped Starting Redis server... [root@redis ~]# redis-cli 127.0.0.1:6379> keys * 1) \"age\" 2) \"address\" 3) \"name\" 127.0.0.1:6379> exit","title":"AOF\u6301\u4e45\u5316\u914d\u7f6e"},{"location":"redis/redis-save-docs/#aof_1","text":"AOF\u6301\u4e45\u5316\u5b58\u5728\u4ee5\u4e0b\u7f3a\u70b9\uff1a - Redis\u4f1a\u4e0d\u65ad\u5730\u5c06\u88ab\u6267\u884c\u7684\u547d\u4ee4\u8bb0\u5f55\u5230AOF\u6587\u4ef6\u91cc\u9762\uff0c\u6240\u4ee5\u968f\u7740Redis\u4e0d\u65ad\u8fd0\u884c\uff0cAOF\u6587\u4ef6\u7684\u4f53\u79ef\u4e5f\u4f1a\u4e0d\u65ad\u589e\u957f\u3002\u5728\u6781\u7aef\u60c5\u51b5\u4e0b\uff0c\u4f53\u79ef\u4e0d\u65ad\u589e\u5927\u7684AOF\u6587\u4ef6\u751a\u81f3\u53ef\u80fd\u4f1a\u7528\u5b8c\u786c\u76d8\u7684\u6240\u6709\u53ef\u7528\u7a7a\u95f4\u3002 - Redis\u5728\u91cd\u542f\u4e4b\u540e\u9700\u8981\u901a\u8fc7\u91cd\u65b0\u6267\u884c AOF \u6587\u4ef6\u8bb0\u5f55\u7684\u6240\u6709\u5199\u547d\u4ee4\u6765\u8fd8\u539f\u6570\u636e\u96c6\uff0c\u6240\u4ee5\u5982\u679cAOF\u6587\u4ef6\u7684\u4f53\u79ef\u975e\u5e38\u5927\uff0c\u90a3\u4e48\u8fd8\u539f\u64cd\u4f5c\u6267\u884c\u7684\u65f6\u95f4\u5c31\u53ef\u80fd\u4f1a\u975e\u5e38\u957f\u3002 \u4e3a\u4e86\u89e3\u51b3AOF\u6587\u4ef6\u4f53\u79ef\u4e0d\u65ad\u589e\u5927\u7684\u95ee\u9898\uff0c\u7528\u6237\u53ef\u4ee5\u5411Redis\u53d1\u9001BGREWRITEAOF\u547d\u4ee4\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u901a\u8fc7\u79fb\u9664AOF\u6587\u4ef6\u4e2d\u7684\u5197\u4f59\u547d\u4ee4\u6765\u91cd\u5199\uff08rewrite\uff09AOF\u6587\u4ef6\uff0c\u4f7fAOF\u6587\u4ef6\u7684\u4f53\u79ef\u53d8\u5f97\u5c3d\u53ef\u80fd\u5730\u5c0f\u3002BGREWRITEAOF\u7684\u5de5\u4f5c\u539f\u7406\u548cBGSAVE\u521b\u5efa\u5feb\u7167\u7684\u5de5\u4f5c\u539f\u7406\u975e\u5e38\u76f8\u4f3c\uff1a Redis\u4f1a\u521b\u5efa\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u7136\u540e\u7531\u5b50\u8fdb\u7a0b\u8d1f\u8d23\u5bf9AOF\u6587\u4ef6\u8fdb\u884c\u91cd\u5199\u3002\u56e0\u4e3aAOF\u6587\u4ef6\u91cd\u5199\u4e5f\u9700\u8981\u7528\u5230\u5b50\u8fdb\u7a0b\uff0c\u6240\u4ee5\u5feb\u7167\u6301\u4e45\u5316\u56e0\u4e3a\u521b\u5efa\u5b50\u8fdb\u7a0b\u800c\u5bfc\u81f4\u7684\u6027\u80fd\u95ee\u9898\u548c\u5185\u5b58\u5360\u7528\u95ee\u9898\uff0c\u5728AOF\u6301\u4e45\u5316\u4e2d\u4e5f\u540c\u6837\u5b58\u5728\u3002 \u8ddf\u5feb\u7167\u6301\u4e45\u5316\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6esave\u9009\u9879\u6765\u81ea\u52a8\u6267\u884cBGSAVE\u4e00\u6837\uff0cAOF\u6301\u4e45\u5316\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6eauto-aof-rewrite-percentage\u9009\u9879\u548c auto-aof-rewrite-min-size\u9009\u9879\u6765\u81ea\u52a8\u6267\u884cBGREWRITEAOF\u3002 \u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5047\u8bbe\u7528\u6237\u5bf9Redis\u8bbe\u7f6e\u4e86\u914d\u7f6e\u9009\u9879auto-aof-rewrite-percentage 100\u548c auto-aof-rewrite-min-size 64mb\uff0c\u5e76\u4e14\u542f\u52a8\u4e86AOF\u6301\u4e45\u5316\uff0c\u90a3\u4e48\u5f53AOF\u6587\u4ef6\u7684\u4f53\u79ef\u5927\u4e8e64MB\uff0c\u5e76\u4e14AOF\u6587\u4ef6\u7684\u4f53\u79ef\u6bd4\u4e0a\u4e00\u6b21\u91cd\u5199\u4e4b\u540e\u7684\u4f53\u79ef\u5927\u4e86\u81f3\u5c11\u4e00\u500d\uff08100%\uff09\u7684\u65f6\u5019\uff0cRedis\u5c06\u6267\u884c BGREWRITEAOF \u547d\u4ee4\u3002\u5982\u679cAOF\u91cd\u5199\u6267\u884c\u5f97\u8fc7\u4e8e\u9891\u7e41\u7684\u8bdd\uff0c\u7528\u6237\u53ef\u4ee5\u8003\u8651\u5c06 auto-aof-rewrite-percentage \u9009\u9879\u7684\u503c\u8bbe\u7f6e\u4e3a100\u4ee5\u4e0a\uff0c\u8fd9\u79cd\u505a\u6cd5\u53ef\u4ee5\u8ba9Redis\u5728AOF\u6587\u4ef6\u7684\u4f53\u79ef\u53d8\u5f97\u66f4\u5927\u4e4b\u540e\u624d\u6267\u884c\u91cd\u5199\u64cd\u4f5c\uff0c\u4e0d\u8fc7\u4e5f\u4f1a\u8ba9Redis\u5728\u542f\u52a8\u65f6\u8fd8\u539f\u6570\u636e\u96c6\u6240\u9700\u7684\u65f6\u95f4\u53d8\u5f97\u66f4\u957f\u3002","title":"AOF \u91cd\u5199\u529f\u80fd"},{"location":"redis/redis-save-docs/#_2","text":"https://github.com/barry-boy/barry-boy.github.io/issues/74","title":"\u53c2\u8003\u6587\u7ae0"},{"location":"vm/promox/","text":"Proxmox \u00b6 Proxmox VE \u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u3001\u5f00\u6e90\u7684\u4f01\u4e1a\u865a\u62df\u5316\u670d\u52a1\u5668\u7ba1\u7406\u5e73\u53f0\u3002\u5b83\u5c06 KVM \u7ba1\u7406\u7a0b\u5e8f\u548c Linux \u5bb9\u5668 (LXC)\u3001\u8f6f\u4ef6\u5b9a\u4e49\u7684\u5b58\u50a8\u548c\u7f51\u7edc\u529f\u80fd\u7d27\u5bc6\u96c6\u6210\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u3002\u501f\u52a9\u57fa\u4e8e Web \u7684\u96c6\u6210\u7528\u6237\u754c\u9762\uff0c\u60a8\u53ef\u4ee5\u8f7b\u677e\u7ba1\u7406 VM \u548c\u5bb9\u5668\u3001\u96c6\u7fa4\u7684\u9ad8\u53ef\u7528\u6027\u6216\u96c6\u6210\u7684\u707e\u96be\u6062\u590d\u5de5\u5177\u3002 \u4f18\u52bf: \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528UI\u754c\u9762\u5bf9\u865a\u62df\u5316\u5df2\u7ecf\u64cd\u4f5c \u65e2\u53ef\u4ee5\u865a\u62dfwindows\u673a\u5668\uff0c\u4e5f\u53ef\u4ee5\u865a\u62dfLinux\u673a\u5668 \u4f7f\u7528\u7b80\u5355\uff0c\u4e0a\u624b\u8f83\u5feb \u90e8\u7f72Pve \u00b6 \u5236\u4f5c\u7cfb\u7edf\u76d8 \u00b6 \u5de5\u5177\u5206\u4eab: rufus\u5de5\u5177\u4e0b\u8f7d\u94fe\u63a5 \u5982\u679c\u7f51\u76d8\u5931\u6548\u53ef\u4ee5\u8bbf\u95ee\u5b98\u7f51: https://rufus.ie/zh/ \u8fdb\u884c\u4e0b\u8f7d image \u5206\u4eab: https://www.proxmox.com/en/downloads \u6e29\u99a8\u63d0\u793a \u8fd9\u4e2a\u5236\u4f5c\u7cfb\u7edf\u76d8\u4e00\u5b9a\u8981\u9009\u62e9dd\u7684\u65b9\u5f0f \u5230\u8fd9\u91cc\u7cfb\u7edf\u76d8\u5c31\u641e\u5b9a\u4e86\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u5b89\u88c5Pve\u8fd9\u4e2a\u7cfb\u7edf\u4e86\u3002 \u5176\u5b9e\u4ed6\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ece\u4e0b\u56fe\u5c31\u80fd\u770b\u51fa\u662f\u4e00\u4e2adebian root@node1:~# cat /etc/os-release PRETTY_NAME = \"Debian GNU/Linux 11 (bullseye)\" NAME = \"Debian GNU/Linux\" VERSION_ID = \"11\" VERSION = \"11 (bullseye)\" VERSION_CODENAME = bullseye ID = debian HOME_URL = \"https://www.debian.org/\" SUPPORT_URL = \"https://www.debian.org/support\" BUG_REPORT_URL = \"https://bugs.debian.org/\" \u90a3\u4e48\u63a5\u4e0b\u6765\u5c31\u662f\u5b89\u88c5\u7cfb\u7edf\uff0c\u5982\u679c\u9700\u8981\u914d\u7f6eraid\u5c31\u53ef\u4ee5\u5148\u914d\u7f6e\u4e00\u4e0b\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8fc7\u591a\u7684\u89e3\u91caraid\u7684\u6982\u5ff5\u4e86\u3002 \u5b89\u88c5\u7cfb\u7edf\u5176\u5b9e\u5c31\u662f\u666e\u901a\u7684\u64cd\u4f5c\u6d41\u7a0b\uff0c\u8fd9\u91cc\u5c31\u7565\u8fc7\uff5e \u5982\u679c\u5b9e\u5728\u4e0d\u61c2\u53ef\u4ee5\u53c2\u8003\uff1ahttps://www.jianshu.com/p/a2ad1aed6a92 \u7684\u5b89\u88c5\u6d41\u7a0b\uff0c\u57fa\u672c\u5c31\u662f\u8fd9\u6837 PVE \u7cfb\u7edf\u521d\u59cb\u5316 \u00b6 \u66f4\u6362\u56fd\u5185\u6e90: \u00b6 \u6e05\u534e\u6e90 # \u9ed8\u8ba4\u6ce8\u91ca\u4e86\u6e90\u7801\u955c\u50cf\u4ee5\u63d0\u9ad8 apt update \u901f\u5ea6\uff0c\u5982\u6709\u9700\u8981\u53ef\u81ea\u884c\u53d6\u6d88\u6ce8\u91ca deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free install package: (\u975e\u5fc5\u9700) \u00b6 ifupdown2,openvswitch-switch,vim apt update apt install ifupdown2 openvswitch-switch -y \u5b58\u50a8 \u00b6 \u5206\u533a\u683c\u5f0f\u5316\uff0c\u6302\u8f7d fdisk /dev/sdb mke2fs -t ext4 /dev/sdb1 mount /dev/sdb1 /mnt/pve/node5_sdb \u4ee5\u4e0a\u8fd9\u91cc\u662f\u4e34\u65f6\u6302\u8f7d\u7684\uff0c\u9700\u8981\u5c06\u5176\u5199\u5165/etc/fstab \u683c\u5f0f\u5316\u62a5\u9519 root@node18:~# mke2fs -t ext4 /dev/sdb1 mke2fs 1.44.5 (15-Dec-2018) /dev/sdb1 is apparently in use by the system; will not make a filesystem here! \u89e3\u51b3\u65b9\u6cd5 root@node18:~# dmsetup remove_all root@node18:~# mke2fs -t ext4 /dev/sdb1 mke2fs 1.44.5 (15-Dec-2018) Creating filesystem with 244055808 4k blocks and 61014016 inodes Filesystem UUID: dd408faf-92ff-467a-baf4-58d653ec3e40 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968, 102400000, 214990848 Allocating group tables: done Writing inode tables: done Creating journal (262144 blocks): done Writing superblocks and filesystem accounting information: done UI\u754c\u9762\u6dfb\u52a0\u78c1\u76d8 \u00b6 \u6839\u636e\u5b9e\u9645\u60c5\u51b5\u586b\u5199\uff0c\u8fd9\u91cc\u622a\u56fe\u4e0d\u51c6\u786e \u6dfb\u52a0\u4ee5\u4e0a\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u786c\u76d8\u5df2\u7ecf\u6302\u8f7d\u4e0a \u7f51\u7edc \u00b6 \u914d\u7f6e\u7f51\u7edc \u914d\u7f6e\u7ec4\u5efa\u6210\u96c6\u7fa4\u7684\u7f51\u5361 \u547d\u4ee4\u884c\u64cd\u4f5c\u6216\u8005\u5e94\u7528\u914d\u7f6e cd /etc/network/ mv interfaces.new interfaces reboot \u6fc0\u6d3b\u7f51\u7edc \u96c6\u7fa4\u7ba1\u7406: \u00b6 \u7ba1\u7406\u547d\u4ee4 # \u505c\u6b62\u865a\u62df\u673a qm stop <vmid> [ OPTIONS ] # \u5220\u9664 qm destroy <vmid> [ OPTIONS ] # \u89e3\u9501 qm unlink <vmid> --idlist <string> [ OPTIONS ] \u9a71\u9010\u6545\u969c\u673a\u5668 \uff1a cd /etc/pve/nodes # \u5220\u9664\u6545\u969c\u8282\u70b9node\u6587\u4ef6 rm -rf /etc/pve/nodes/pve2 # \u6539\u6210\u6545\u969c\u8282\u70b9\u5bf9\u5e94\u8def\u5f84 root@node17:/etc/pve/nodes# pvecm delnode node12 # \u767b\u5f55\u96c6\u7fa4\u4e2d\u4efb\u610f\u6b63\u5e38\u8282\u70b9\uff0c\u6267\u884c\u5982\u4e0b\u6307\u4ee4\u8fdb\u884c\u9a71\u9010\u64cd\u4f5c","title":"Promox"},{"location":"vm/promox/#proxmox","text":"Proxmox VE \u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u3001\u5f00\u6e90\u7684\u4f01\u4e1a\u865a\u62df\u5316\u670d\u52a1\u5668\u7ba1\u7406\u5e73\u53f0\u3002\u5b83\u5c06 KVM \u7ba1\u7406\u7a0b\u5e8f\u548c Linux \u5bb9\u5668 (LXC)\u3001\u8f6f\u4ef6\u5b9a\u4e49\u7684\u5b58\u50a8\u548c\u7f51\u7edc\u529f\u80fd\u7d27\u5bc6\u96c6\u6210\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u3002\u501f\u52a9\u57fa\u4e8e Web \u7684\u96c6\u6210\u7528\u6237\u754c\u9762\uff0c\u60a8\u53ef\u4ee5\u8f7b\u677e\u7ba1\u7406 VM \u548c\u5bb9\u5668\u3001\u96c6\u7fa4\u7684\u9ad8\u53ef\u7528\u6027\u6216\u96c6\u6210\u7684\u707e\u96be\u6062\u590d\u5de5\u5177\u3002 \u4f18\u52bf: \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528UI\u754c\u9762\u5bf9\u865a\u62df\u5316\u5df2\u7ecf\u64cd\u4f5c \u65e2\u53ef\u4ee5\u865a\u62dfwindows\u673a\u5668\uff0c\u4e5f\u53ef\u4ee5\u865a\u62dfLinux\u673a\u5668 \u4f7f\u7528\u7b80\u5355\uff0c\u4e0a\u624b\u8f83\u5feb","title":"Proxmox"},{"location":"vm/promox/#pve","text":"","title":"\u90e8\u7f72Pve"},{"location":"vm/promox/#_1","text":"\u5de5\u5177\u5206\u4eab: rufus\u5de5\u5177\u4e0b\u8f7d\u94fe\u63a5 \u5982\u679c\u7f51\u76d8\u5931\u6548\u53ef\u4ee5\u8bbf\u95ee\u5b98\u7f51: https://rufus.ie/zh/ \u8fdb\u884c\u4e0b\u8f7d image \u5206\u4eab: https://www.proxmox.com/en/downloads \u6e29\u99a8\u63d0\u793a \u8fd9\u4e2a\u5236\u4f5c\u7cfb\u7edf\u76d8\u4e00\u5b9a\u8981\u9009\u62e9dd\u7684\u65b9\u5f0f \u5230\u8fd9\u91cc\u7cfb\u7edf\u76d8\u5c31\u641e\u5b9a\u4e86\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u5b89\u88c5Pve\u8fd9\u4e2a\u7cfb\u7edf\u4e86\u3002 \u5176\u5b9e\u4ed6\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ece\u4e0b\u56fe\u5c31\u80fd\u770b\u51fa\u662f\u4e00\u4e2adebian root@node1:~# cat /etc/os-release PRETTY_NAME = \"Debian GNU/Linux 11 (bullseye)\" NAME = \"Debian GNU/Linux\" VERSION_ID = \"11\" VERSION = \"11 (bullseye)\" VERSION_CODENAME = bullseye ID = debian HOME_URL = \"https://www.debian.org/\" SUPPORT_URL = \"https://www.debian.org/support\" BUG_REPORT_URL = \"https://bugs.debian.org/\" \u90a3\u4e48\u63a5\u4e0b\u6765\u5c31\u662f\u5b89\u88c5\u7cfb\u7edf\uff0c\u5982\u679c\u9700\u8981\u914d\u7f6eraid\u5c31\u53ef\u4ee5\u5148\u914d\u7f6e\u4e00\u4e0b\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8fc7\u591a\u7684\u89e3\u91caraid\u7684\u6982\u5ff5\u4e86\u3002 \u5b89\u88c5\u7cfb\u7edf\u5176\u5b9e\u5c31\u662f\u666e\u901a\u7684\u64cd\u4f5c\u6d41\u7a0b\uff0c\u8fd9\u91cc\u5c31\u7565\u8fc7\uff5e \u5982\u679c\u5b9e\u5728\u4e0d\u61c2\u53ef\u4ee5\u53c2\u8003\uff1ahttps://www.jianshu.com/p/a2ad1aed6a92 \u7684\u5b89\u88c5\u6d41\u7a0b\uff0c\u57fa\u672c\u5c31\u662f\u8fd9\u6837","title":"\u5236\u4f5c\u7cfb\u7edf\u76d8"},{"location":"vm/promox/#pve_1","text":"","title":"PVE \u7cfb\u7edf\u521d\u59cb\u5316"},{"location":"vm/promox/#_2","text":"\u6e05\u534e\u6e90 # \u9ed8\u8ba4\u6ce8\u91ca\u4e86\u6e90\u7801\u955c\u50cf\u4ee5\u63d0\u9ad8 apt update \u901f\u5ea6\uff0c\u5982\u6709\u9700\u8981\u53ef\u81ea\u884c\u53d6\u6d88\u6ce8\u91ca deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free # deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free","title":"\u66f4\u6362\u56fd\u5185\u6e90:"},{"location":"vm/promox/#install-package","text":"ifupdown2,openvswitch-switch,vim apt update apt install ifupdown2 openvswitch-switch -y","title":"install package:(\u975e\u5fc5\u9700)"},{"location":"vm/promox/#_3","text":"\u5206\u533a\u683c\u5f0f\u5316\uff0c\u6302\u8f7d fdisk /dev/sdb mke2fs -t ext4 /dev/sdb1 mount /dev/sdb1 /mnt/pve/node5_sdb \u4ee5\u4e0a\u8fd9\u91cc\u662f\u4e34\u65f6\u6302\u8f7d\u7684\uff0c\u9700\u8981\u5c06\u5176\u5199\u5165/etc/fstab \u683c\u5f0f\u5316\u62a5\u9519 root@node18:~# mke2fs -t ext4 /dev/sdb1 mke2fs 1.44.5 (15-Dec-2018) /dev/sdb1 is apparently in use by the system; will not make a filesystem here! \u89e3\u51b3\u65b9\u6cd5 root@node18:~# dmsetup remove_all root@node18:~# mke2fs -t ext4 /dev/sdb1 mke2fs 1.44.5 (15-Dec-2018) Creating filesystem with 244055808 4k blocks and 61014016 inodes Filesystem UUID: dd408faf-92ff-467a-baf4-58d653ec3e40 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968, 102400000, 214990848 Allocating group tables: done Writing inode tables: done Creating journal (262144 blocks): done Writing superblocks and filesystem accounting information: done","title":"\u5b58\u50a8"},{"location":"vm/promox/#ui","text":"\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u586b\u5199\uff0c\u8fd9\u91cc\u622a\u56fe\u4e0d\u51c6\u786e \u6dfb\u52a0\u4ee5\u4e0a\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u786c\u76d8\u5df2\u7ecf\u6302\u8f7d\u4e0a","title":"UI\u754c\u9762\u6dfb\u52a0\u78c1\u76d8"},{"location":"vm/promox/#_4","text":"\u914d\u7f6e\u7f51\u7edc \u914d\u7f6e\u7ec4\u5efa\u6210\u96c6\u7fa4\u7684\u7f51\u5361 \u547d\u4ee4\u884c\u64cd\u4f5c\u6216\u8005\u5e94\u7528\u914d\u7f6e cd /etc/network/ mv interfaces.new interfaces reboot \u6fc0\u6d3b\u7f51\u7edc","title":"\u7f51\u7edc"},{"location":"vm/promox/#_5","text":"\u7ba1\u7406\u547d\u4ee4 # \u505c\u6b62\u865a\u62df\u673a qm stop <vmid> [ OPTIONS ] # \u5220\u9664 qm destroy <vmid> [ OPTIONS ] # \u89e3\u9501 qm unlink <vmid> --idlist <string> [ OPTIONS ] \u9a71\u9010\u6545\u969c\u673a\u5668 \uff1a cd /etc/pve/nodes # \u5220\u9664\u6545\u969c\u8282\u70b9node\u6587\u4ef6 rm -rf /etc/pve/nodes/pve2 # \u6539\u6210\u6545\u969c\u8282\u70b9\u5bf9\u5e94\u8def\u5f84 root@node17:/etc/pve/nodes# pvecm delnode node12 # \u767b\u5f55\u96c6\u7fa4\u4e2d\u4efb\u610f\u6b63\u5e38\u8282\u70b9\uff0c\u6267\u884c\u5982\u4e0b\u6307\u4ee4\u8fdb\u884c\u9a71\u9010\u64cd\u4f5c","title":"\u96c6\u7fa4\u7ba1\u7406:"},{"location":"web-server/web-01/","text":"\u4e00\u3001\u57df\u540d\u6982\u8ff0 \u00b6 1\u3001\u57df\u540d\u89e3\u6790\u7684\u4f5c\u7528 \u65b9\u4fbf\u8bb0\u5fc6\uff0cIP\u5730\u5740\u4e0d\u5bb9\u6613\u8bb0\u5fc6\uff0c\u4f46\u662f\u57df\u540d\u66f4\u52a0\u76f4\u89c2\u3002 2\u3001\u65e9\u8d77\u4f7f\u7528\u7684 hosts \u6587\u4ef6\u89e3\u6790\u57df\u540d \u65e9\u8d77\u4f7f\u7528 hosts \u6587\u4ef6\u8fdb\u884c\u57df\u540d\u7684\u89e3\u6790\uff0c Linux \u4e2d hosts \u6587\u4ef6\u5b58\u653e\u8def\u5f84\u4e3a/etc/hosts \uff0cWindows \u7cfb\u7edf\u4e2d\u5b58\u653e\u8def\u5f84\u4e3a C:\\Windows\\System32\\drivers\\etc\\hosts \u5185\u3002 \u4f46\u540e\u671f\uff0c\u968f\u7740 Internet \u7f51\u4e0a\u7684\u7f51\u7ad9\u53d1\u5c55\u8fc5\u901f\uff0c\u4e00\u4e2a\u5c0f\u5c0f\u7684 hosts \u6587\u4ef6\u4ee5\u4e0d\u8db3\u4ee5\u5b58\u653e\uff0c\u518d \u52a0\u4e0a\u4e3b\u673a\u540d\u79f0\u91cd\u590d\u3001\u4e3b\u673a\u7ef4\u62a4\u56f0\u96be\u7b49\u95ee\u9898\uff0c\u51fa\u73b0\u4e86 DNS \u57df\u540d\u89e3\u6790\u670d\u52a1 3\u3001DNS \uff08Domain Name System\uff09\u57df\u540d\u7cfb\u7edf \u4e24\u5927\u7279\u70b9\uff1a\u5206\u5e03\u5f0f\u3001\u5c42\u6b21\u6027 \u57df\u540d\u7a7a\u95f4\u7ed3\u6784\uff1a\u6839\u57df\u3001\u9876\u7ea7\u57df\uff08\u56fd\u5bb6/ \u5730\u533a\u57df\u540d\uff09\u3001\u4e8c\u7ea7\u57df \u5b8c\u6574\u57df\u540d\u683c\u5f0f\uff1aFQDN= \u4e3b\u673a\u540d.DNS \u540e\u7f00\uff0c\u4f8b\uff1awww.baidu.com. \u4e8c\u3001\u7f51\u9875\u6982\u8ff0 \u00b6 1\u3001\u7f51\u9875\uff1a\u7eaf\u6587\u672c\u683c\u5f0f\u6587\u4ef6\uff0c\u5176\u7f16\u5199\u8bed\u8a00\u4e3a HTML\uff0c\u5728\u7528\u6237\u7684\u6d4f\u89c8\u5668\u4e2d\u88ab\u201c\u7ffb\u8bd1\u201d\u6210\u7f51\u9875\u5f62 \u5f0f\u663e\u793a\u51fa\u6765 2\u3001\u7f51\u7ad9\uff1a\u7f51\u7ad9\u662f\u7531\u4e00\u4e2a\u4e00\u4e2a\u9875\u9762\u6784\u6210\u7684\uff0c\u662f\u591a\u4e2a\u7f51\u9875\u7684\u7ed3\u5408\u4f53 3\u3001\u4e3b\u9875\uff1a\u6253\u5f00\u7f51\u7ad9\u540e\u51fa\u73b0\u7684\u7b2c\u4e00\u4e2a\u7f51\u9875\u79f0\u4e3a\u7f51\u7ad9\u4e3b\u9875\uff08\u6216\u9996\u9875\uff09 4\u3001\u57df\u540d\uff1a\u6d4f\u89c8\u7f51\u9875\u65f6\u8f93\u5165\u7684\u7f51\u5740\uff08\u4f8b\u5982\uff1awww.benet.wang \uff09 5\u3001HTTP \uff1a\u7528\u6765\u4f20\u8f93\u7f51\u9875\u7684\u901a\u4fe1\u534f\u8bae 6\u3001URL \uff1a\u662f\u4e00\u79cd\u4e07\u7ef4\u7f51\u5bfb\u5740\u7cfb\u7edf 7\u3001HTML \uff1a\u7528\u6765\u7f16\u5199\u7f51\u9875\u7684\u8d85\u6587\u672c\u6807\u8bb0\u8bed\u8a00 8\u3001\u8d85\u94fe\u63a5\uff1a\u5c06\u7f51\u7ad9\u4e2d\u4e0d\u540c\u7f51\u9875\u94fe\u63a5\u8d77\u6765\u7684\u529f\u80fd 9\u3001\u53d1\u5e03\uff1a\u5c06\u5236\u4f5c\u597d\u7684\u7f51\u9875\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u4f9b\u7528\u6237\u8bbf\u95ee\u7684\u8fc7\u7a0b \u4e09\u3001HTML(\u8d85\u6587\u672c\u6807\u7b7e\u8bed\u8a00) \u00b6 1\u3001HTML \uff1aHyper Text Markup Language \uff0c\u7f51\u9875\u7684\u201c\u6e90\u7801\u201d 2\u3001\u6d4f\u89c8\u5668\uff1a\u201c\u89e3\u91ca\u548c\u6267\u884c\u201dHTML \u6e90\u7801\u7684\u5de5\u5177 3\u3001HTML \u6587\u6863\u7684\u7ed3\u6784 \u5934\u90e8\u90e8\u5206 \u6807\u9898\u90e8\u5206 \u4e3b\u4f53\u90e8\u5206 \u7f51\u9875\u5185\u5bb9\uff0c\u5305\u62ec\u6587\u672c\u3001\u56fe\u50cf\u7b49 \u56db\u3001Web\u6982\u8ff0 \u00b6 Web \u5185\u5bb9\u50a8\u5b58\u5728 Web \u670d\u52a1\u5668\u4e0a\uff0c\u6700\u7b80\u5355\u7684 Web \u8d44\u6e90\u5c31\u662f Web \u670d\u52a1\u5668\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u9759 \u6001\u6587\u4ef6\uff0c\u8fd9\u4e9b\u6587\u4ef6\u53ef\u4ee5\u5305\u542b\u4efb\u610f\u5185\u5bb9\uff1a\u6587\u672c\u6587\u4ef6\u3001HTML \u6587\u4ef6\u3001\u5fae\u8f6f\u7684 Word \u6587\u4ef6\u3001Adobe \u7684 Acrobat \u6587\u4ef6\u3001JPEG \u56fe\u7247\u6587\u4ef6\u3001AVI \u7535\u5f71\u6587\u4ef6\u3002 \u8d44\u6e90\u4e0d\u4e00\u5b9a\u662f\u9759\u6001\u6587\u4ef6\uff0c\u8d44\u6e90\u8fd8\u53ef\u4ee5\u662f\u6839\u636e\u9700\u8981\u751f\u6210\u5185\u5bb9\u7684\u8f6f\u4ef6\u7a0b\u5e8f\u3002\u8fd9\u4e9b\u52a8\u6001\u5185\u5bb9\u8d44 \u6e90\u53ef\u4ee5\u6839\u636e\u4f60\u7684\u8eab\u4efd\u3001\u6240\u8bf7\u6c42\u7684\u4fe1\u606f\u6216\u6bcf\u5929\u7684\u4e0d\u540c\u65f6\u6bb5\u6765\u4ea7\u751f\u5185\u5bb9\u3002 1\u3001Web1.0 \u4e0e Web2.0 Web1.0 \u662f\u4ee5\u7f16\u8f91\u4e3a\u7279\u5f81\uff0c\u7f51\u7ad9\u63d0\u4f9b\u7ed9\u7528\u6237\u7684\u5185\u5bb9\u662f\u7f16\u8f91\u5904\u7406\u540e\u63d0\u4f9b\u7684\uff0c\u7136\u540e\u7528\u6237\u9605\u8bfb \u7f51\u7ad9\u63d0\u4f9b\u7684\u5185\u5bb9\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u7f51\u7ad9\u5230\u7528\u6237\u7684\u5355\u5411\u884c\u4e3a\u3002 Web2.0 \u66f4\u6ce8\u91cd\u7528\u6237\u7684\u4ea4\u4e92\u4f5c\u7528\uff0c\u7528\u6237\u65e2\u662f\u7f51\u7ad9\u5185\u5bb9\u7684\u6d88\u8d39\u8005\uff08\u6d4f\u89c8\u8005\uff09\uff0c\u4e5f\u662f\u7f51\u7ad9\u5185\u5bb9 \u7684\u5236\u9020\u8005\u3002Web2.0 \u52a0\u5f3a\u4e86\u7f51\u7ad9\u4e0e\u7528\u6237\u4e4b\u95f4\u7684\u4e92\u52a8\uff0c\u7f51\u7ad9\u5185\u5bb9\u57fa\u4e8e\u7528\u6237\u63d0\u4f9b\uff0c\u7f51\u7ad9\u7684\u8bf8\u591a\u529f \u80fd\u4e5f\u7531\u7528\u6237\u53c2\u4e0e\u5efa\u8bbe\uff0c\u5b9e\u73b0\u4e86\u7f51\u7ad9\u4e0e\u7528\u6237\u53cc\u5411\u7684\u4ea4\u6d41\u4e0e\u53c2\u4e0e\u3002 2\u3001\u9759\u6001\u7f51\u9875\u4e0e\u52a8\u6001\u7f51\u9875 \uff081 \uff09\u9759\u6001\u7f51\u9875 \u5728\u7f51\u7ad9\u8bbe\u8ba1\u4e2d\uff0c\u7eaf\u7cb9 HTML \u683c\u5f0f\u7684\u7f51\u9875\u901a\u5e38\u88ab\u79f0\u4e3a\u201c\u9759\u6001\u7f51\u9875\u201d\uff0c\u9759\u6001\u7f51\u9875\u662f\u6807\u51c6\u7684 HTML \u6587\u4ef6\uff0c\u6269\u5c55\u540d\u662f.htm \u3001.html\uff0c\u53ef\u5305\u542b\u6587\u672c\u3001\u56fe\u50cf\u3001\u58f0\u97f3\u3001 FLASH \u52a8\u753b\u3001\u5ba2\u6237\u7aef\u811a\u672c\u548c ActiveX \u63a7\u4ef6\u53ca JAVA \u5c0f\u7a0b\u5e8f\u7b49\u3002\u9759\u6001\u7f51\u9875\u662f\u7f51\u7ad9\u5efa\u8bbe\u7684\u57fa\u7840\uff0c\u65e9\u671f\u7684\u7f51\u7ad9\u4e00\u822c\u90fd\u662f\u9759\u6001\u7f51\u9875\u5236\u4f5c\u7684\u3002 \u9759\u6001\u7f51\u9875\u76f8\u5bf9\u4e8e\u52a8\u6001\u7f51\u9875\u800c\u8a00\uff0c\u662f\u6ca1\u6709\u540e\u53f0\u6570\u636e\u5e93\u3001\u4e0d\u542b\u7a0b\u5e8f\u548c\u4e0d\u53ef\u4ea4\u4e92\u7684\u7f51\u9875\u3002\u9759\u6001 \u7f51\u9875\u76f8\u5bf9\u66f4\u65b0\u8d77\u6765\u6bd4\u8f83\u9ebb\u70e6\uff0c\u9002\u7528\u4e8e\u4e00\u822c\u66f4\u65b0\u53eb\u5c11\u7684\u5c55\u793a\u578b\u7f51\u7ad9\u3002 \u9759\u6001\u7f51\u9875\u7684\u5185\u5bb9\u76f8\u5bf9\u7a33\u5b9a\uff0c\u56e0\u6b64\u5bb9\u6613\u88ab\u641c\u7d22\u5f15\u64ce\u68c0\u7d22\u3002 \u9759\u6001\u7f51\u9875\u6ca1\u6709\u6570\u636e\u5e93\u7684\u652f\u6301\uff0c\u5728\u7f51\u7ad9\u5236\u4f5c\u548c\u7ef4\u62a4\u65b9\u9762\u5de5\u4f5c\u91cf\u8f83\u5927\uff0c\u56e0\u6b64\u5f53\u7f51\u7ad9\u4fe1\u606f\u91cf\u5f88 \u5927\u65f6\u5b8c\u5168\u4f9d\u9760\u9759\u6001\u7f51\u9875\u5236\u4f5c\u65b9\u5f0f\u6bd4\u8f83\u56f0\u96be\u3002\u9759\u6001\u7f51\u9875\u7684\u4ea4\u4e92\u6027\u8f83\u5dee\uff0c\u5728\u529f\u80fd\u65b9\u9762\u6709\u8f83\u5927\u7684\u9650 \u5236\u3002\u9875\u9762\u6d4f\u89c8\u901f\u5ea6\u8fc5\u901f\uff0c\u8fc7\u7a0b\u65e0\u9700\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u5f00\u542f\u9875\u9762\u901f\u5ea6\u5feb\u4e8e\u52a8\u6001\u9875\u9762\u3002 \uff082 \uff09\u52a8\u6001\u7f51\u9875 \u52a8\u6001\u7f51\u9875\u662f\u4e0e\u9759\u6001\u7f51\u9875\u76f8\u5bf9\u5e94\u7684\uff0c\u7f51\u9875 URL \u7684\u540e\u7f00\u4e0d\u662f.htm \u3001.html \u3001.shtml \u3001xml \u7b49\u9759 \u6001\u7f51\u9875\u7684\u5e38\u89c1\u5f62\u5f0f\uff0c\u800c\u662f\u4ee5.aspx \u3001.asp \u3001.jsp \u3001.php \u3001.perl \u3001.cgi \u7b49\u5f62\u5f0f\u4e3a\u540e\u7f00\uff0c\u5e76\u4e14\u5728\u52a8\u6001 \u7f51\u9875\u7f51\u5740\u4e2d\u6709\u4e00\u4e2a\u6807\u5fd7\u6027\u7684\u7b26\u53f7\u2014\u2014\u201c?\u201d \u52a8\u6001\u7f51\u9875\u663e\u793a\u7684\u5185\u5bb9\u53ef\u4ee5\u968f\u7740\u65f6\u95f4\u3001\u73af\u5883\u6216\u8005\u6570\u636e\u5e93\u64cd\u4f5c\u7684\u7ed3\u679c\u800c\u53d1\u751f\u6539\u53d8\u3002\u52a8\u6001\u7f51\u9875 \u4e0e\u7f51\u9875\u4e0a\u7684\u5404\u79cd\u52a8\u753b\u3001\u6eda\u52a8\u5b57\u5e55\u7b49\u89c6\u89c9\u4e0a\u7684\u52a8\u6001\u6548\u679c\u6ca1\u6709\u76f4\u63a5\u5173\u7cfb\uff0c\u53ea\u8981\u662f\u91c7\u7528\u4e86\u52a8\u6001\u7f51\u7ad9 \u6280\u672f\u751f\u4ea7\u7684\u7f51\u9875\u90fd\u53ef\u4ee5\u79f0\u4e3a\u201c\u52a8\u6001\u7f51\u9875\u201d\u3002 \u52a8\u6001\u7f51\u9875\u662f\u57fa\u672c\u7684 html \u8bed\u6cd5\u4e0e Java\u3001PHP \u7b49\u9ad8\u7ea7\u7a0b\u5e8f\u8bbe\u8ba1\u8bed\u8a00\u3001\u6570\u636e\u5e93\u7f16\u7a0b\u7b49\u591a\u79cd\u6280 \u672f\u7684\u878d\u5408\uff0c\u4ee5\u5b9e\u73b0\u5bf9\u7f51\u7ad9\u5185\u5bb9\u548c\u98ce\u683c\u7684\u9ad8\u6548\u3001\u52a8\u6001\u548c\u4ea4\u4e92\u5f0f\u7ba1\u7406\u3002 \u52a8\u6001\u7f51\u9875\u4e00\u822c\u4ee5\u6570\u636e\u5e93\u6280\u672f\u4e3a\u57fa\u7840\uff0c\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u7f51\u7ad9\u7ef4\u62a4\u7684\u5de5\u4f5c\u91cf\u3002\u91c7\u7528\u52a8\u6001\u7f51\u9875\u6280 \u672f\u7684\u7f51\u7ad9\u53ef\u4ee5\u5b9e\u73b0\u66f4\u591a\u7684\u529f\u80fd\uff0c\u5982\u7528\u6237\u6ce8\u518c\u3001\u7528\u6237\u767b\u5f55\u3001\u5728\u7ebf\u8c03\u67e5\u3001\u7528\u6237\u7ba1\u7406\u3001\u8ba2\u5355\u7ba1\u7406\u7b49 http\u534f\u8bae\u5206\u6790 \u00b6 \u4e00. HTTP \u534f\u8bae\u6982\u8ff0 \u6bcf\u5929\u90fd\u6709\u6570\u4ee5\u4ebf\u4e07\u8ba1\u7684 JPEG \u56fe\u7247\u3001 HTML \u9875\u9762\u3001\u6587\u672c\u6587\u4ef6\u3001 MPEG \u7535\u5f71\u3001 WAV \u97f3\u9891\u6587\u4ef6\u3001 JAVA \u5c0f\u7a0b\u5e8f\u548c\u5176\u4ed6\u8d44\u6e90\u5728\u56e0\u7279\u7f51\u4e0a\u6e38\u5f0b\u3002 HTTP \u53ef\u4ee5\u901a\u8fc7\u904d\u5e03\u5168\u4e16\u754c\u7684 Web \u670d\u52a1\u5668\u4e0a\u5c06\u8fd9\u4e9b \u4fe1\u606f\u5feb\u8fc5\u901f\u3001\u4fbf\u6377\u3001\u53ef\u9760\u5730\u642c\u79fb\u5230\u4eba\u4eec\u684c\u9762\u4e0a\u7684 Web \u6d4f\u89c8\u5668\u4e0a\u53bb\u3002 Web \u670d\u52a1\u5668\u6240\u4f7f\u7528\u7684\u662f HTTP \u534f\u8bae\uff0c\u56e0\u6b64\u7ecf\u5e38\u4f1a\u88ab\u79f0\u4e3a HTTP \u670d\u52a1\u5668\u3002 HTTP \u670d\u52a1\u5668\u5b58\u50a8 \u4e86\u56e0\u7279\u7f51\u4e2d\u7684\u6570\u636e\uff0c\u5982\u679c HTTP \u5ba2\u6237\u7aef\u53d1\u51fa\u8bf7\u6c42\u7684\u8bdd\uff0c\u5b83\u4eec\u4f1a\u63d0\u4f9b\u6570\u636e\uff0c\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u5668\u53d1\u9001 HTTP \u8bf7\u6c42\uff0c\u670d\u52a1\u5668\u4f1a\u5728 HTTP \u54cd\u5e94\u4e2d\u56de\u9001\u6240\u6709\u8bf7\u6c42\u7684\u6570\u636e\u3002 \u4e8c. HTTP \u534f\u8bae\u7248\u672c HTTP \u534f\u8bae\u662f\u4e92\u8054\u7f51\u4e0a\u5e94\u7528\u6700\u4e3a\u5e7f\u6cdb\u7684\u4e00\u79cd\u7f51\u7edc\u534f\u8bae\uff0c\u8bbe\u8ba1\u8fd9\u4e2a\u534f\u8bae\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u53d1\u5e03\u548c\u63a5\u6536 Web \u670d\u52a1\u5668\u4e0a\u7684 HTML \u9875\u9762\u3002 HTTP \u534f\u8bae\u7684\u7248\u672c\uff1a HTTP 0.9 \u5df2\u8fc7\u65f6\u3002\u53ea\u63a5\u53d7 GET \u4e00\u79cd\u8bf7\u6c42\u65b9\u6cd5\uff0c\u6ca1\u6709\u5728\u901a\u8baf\u4e2d\u6307\u5b9a\u7248\u672c\u53f7\uff0c\u4e14\u4e0d\u652f\u6301\u8bf7\u6c42\u5934\u3002\u7531 \u4e8e\u8be5\u7248\u672c\u4e0d\u652f\u6301 POST \u65b9\u6cd5\uff0c\u6240\u4ee5\u5ba2\u6237\u7aef\u65e0\u6cd5\u5411\u670d\u52a1\u5668\u4f20\u9012\u592a\u591a\u4fe1\u606f\u3002 HTTP 1.0 \u8fd9\u662f\u7b2c\u4e00\u4e2a\u5728\u901a\u8baf\u4e2d\u6307\u5b9a\u7248\u672c\u53f7\u7684 HTTP \u534f\u8bae\u7248\u672c\uff0c\u81f3\u4eca\u4ecd\u88ab\u5e7f\u6cdb\u91c7\u7528\uff0c\u7279\u522b\u662f\u5728\u4ee3\u7406 \u670d\u52a1\u5668\u4e2d\u3002 HTTP 1.1 \u5f53\u524d\u7248\u672c\u3002\u6301\u4e45\u8fde\u63a5\u88ab\u9ed8\u8ba4\u91c7\u7528\uff0c\u5e76\u80fd\u5f88\u597d\u5730\u914d\u5408\u4ee3\u7406\u670d\u52a1\u5668\u5de5\u4f5c\u3002\u8fd8\u652f\u6301\u4ee5\u7ba1\u9053\u65b9\u5f0f \u540c\u65f6\u53d1\u9001\u591a\u4e2a\u8bf7\u6c42\uff0c\u4ee5\u4fbf\u964d\u4f4e\u7ebf\u8def\u8d1f\u8f7d\uff0c\u63d0\u9ad8\u4f20\u8f93\u901f\u5ea6\u3002 HTTP/1.1 \u76f8\u8f83\u4e8e HTTP/1.0 \u534f\u8bae\u7684\u533a\u522b\u4e3b\u8981\u4f53\u73b0\u5728\uff1a 1 \u7f13\u5b58\u5904\u7406 2 \u5e26\u5bbd\u4f18\u5316\u53ca\u7f51\u7edc\u8fde\u63a5\u7684\u4f7f\u7528 3 \u9519\u8bef\u901a\u77e5\u7684\u7ba1\u7406 4 \u6d88\u606f\u5728\u7f51\u7edc\u4e2d\u7684\u53d1\u9001 5 \u4e92\u8054\u7f51\u5730\u5740\u7684\u7ef4\u62a4 6 \u5b89\u5168\u6027\u53ca\u5b8c\u6574\u6027 \u4e09. HTTP\u65b9\u6cd5 HTTP \u652f\u6301\u51e0\u79cd\u4e0d\u540c\u7684\u8bf7\u6c42\u547d\u4ee4\uff0c\u8fd9\u4e9b\u547d\u4ee4\u88ab\u79f0\u4e3a HTTP \u65b9\u6cd5\uff08 HTTP method\uff09\u6bcf\u6761 HTTP \u8bf7\u6c42\u62a5\u6587\u4f1a\u5305\u542b\u4e00\u4e2a\u65b9\u6cd5\uff0c\u544a\u8bc9\u670d\u52a1\u5668\u8981\u6267\u884c\u4ec0\u4e48\u52a8\u4f5c\uff1a \u83b7\u53d6\u4e00\u4e2a Web \u9875\u9762 \u8fd0\u884c\u4e00\u4e2a\u7f51\u5173\u7a0b\u5e8f \u5220\u9664\u4e00\u4e2a\u6587\u4ef6\u7b49 HTTP \u534f\u8bae\u6709\u591a\u79cd\u83b7\u5f97 Web \u8d44\u6e90\u7684\u65b9\u6cd5\uff0c\u5e38\u7528\u7684\u6709\u4e24\u79cd\uff1aGET \u548c POST GET \u548c POST \u4f8b\u5982\u8bbf\u95ee\uff1a http://www.test.com/a.php?Id=123 \u5c31\u662f\u4e00\u4e2a GET \u8bf7\u6c42\uff0c\u5982\u679c\u8bbf\u95ee\u6b63\u5e38\uff0c\u6211\u4eec \u4f1a\u4ece\u670d\u52a1\u5668\u7684\u65e5\u5fd7\u4e2d\u83b7\u53d6 200 \u72b6\u6001\u7801\u3002 \u5047\u5982\u6b64\u8bf7\u6c42\u4f7f\u7528 POST \u65b9\u6cd5\uff0c\u90a3\u4e48\u6211\u4eec\u4f1a\u4f20\u9012\u7ed9 a.php \u7684 Id \u53c2\u6570\u4f9d\u65e7\u662f 123\uff0c\u4f46\u662f\u6d4f\u89c8 \u5668\u7684 URL \u5c06\u4e0d\u4f1a\u663e\u793a\u540e\u9762\u7684 Id=123 \u5b57\u6837\uff0c\u56e0\u6b64\u8868\u5355\u7c7b\u6216\u8005\u6709\u7528\u6237\u540d\u3001\u5bc6\u7801\u7b49\u5185\u5bb9\u63d0\u4ea4\u65f6\u5efa\u8bae\u4f7f\u7528 POST \u65b9\u5f0f\u3002 \u4e0d\u7ba1\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\uff0c\u6700\u7ec8 a.php \u83b7\u53d6\u5230\u7684\u503c\u662f\u4e00\u6837\u7684\u3002","title":"Web 01"},{"location":"web-server/web-01/#_1","text":"1\u3001\u57df\u540d\u89e3\u6790\u7684\u4f5c\u7528 \u65b9\u4fbf\u8bb0\u5fc6\uff0cIP\u5730\u5740\u4e0d\u5bb9\u6613\u8bb0\u5fc6\uff0c\u4f46\u662f\u57df\u540d\u66f4\u52a0\u76f4\u89c2\u3002 2\u3001\u65e9\u8d77\u4f7f\u7528\u7684 hosts \u6587\u4ef6\u89e3\u6790\u57df\u540d \u65e9\u8d77\u4f7f\u7528 hosts \u6587\u4ef6\u8fdb\u884c\u57df\u540d\u7684\u89e3\u6790\uff0c Linux \u4e2d hosts \u6587\u4ef6\u5b58\u653e\u8def\u5f84\u4e3a/etc/hosts \uff0cWindows \u7cfb\u7edf\u4e2d\u5b58\u653e\u8def\u5f84\u4e3a C:\\Windows\\System32\\drivers\\etc\\hosts \u5185\u3002 \u4f46\u540e\u671f\uff0c\u968f\u7740 Internet \u7f51\u4e0a\u7684\u7f51\u7ad9\u53d1\u5c55\u8fc5\u901f\uff0c\u4e00\u4e2a\u5c0f\u5c0f\u7684 hosts \u6587\u4ef6\u4ee5\u4e0d\u8db3\u4ee5\u5b58\u653e\uff0c\u518d \u52a0\u4e0a\u4e3b\u673a\u540d\u79f0\u91cd\u590d\u3001\u4e3b\u673a\u7ef4\u62a4\u56f0\u96be\u7b49\u95ee\u9898\uff0c\u51fa\u73b0\u4e86 DNS \u57df\u540d\u89e3\u6790\u670d\u52a1 3\u3001DNS \uff08Domain Name System\uff09\u57df\u540d\u7cfb\u7edf \u4e24\u5927\u7279\u70b9\uff1a\u5206\u5e03\u5f0f\u3001\u5c42\u6b21\u6027 \u57df\u540d\u7a7a\u95f4\u7ed3\u6784\uff1a\u6839\u57df\u3001\u9876\u7ea7\u57df\uff08\u56fd\u5bb6/ \u5730\u533a\u57df\u540d\uff09\u3001\u4e8c\u7ea7\u57df \u5b8c\u6574\u57df\u540d\u683c\u5f0f\uff1aFQDN= \u4e3b\u673a\u540d.DNS \u540e\u7f00\uff0c\u4f8b\uff1awww.baidu.com.","title":"\u4e00\u3001\u57df\u540d\u6982\u8ff0"},{"location":"web-server/web-01/#_2","text":"1\u3001\u7f51\u9875\uff1a\u7eaf\u6587\u672c\u683c\u5f0f\u6587\u4ef6\uff0c\u5176\u7f16\u5199\u8bed\u8a00\u4e3a HTML\uff0c\u5728\u7528\u6237\u7684\u6d4f\u89c8\u5668\u4e2d\u88ab\u201c\u7ffb\u8bd1\u201d\u6210\u7f51\u9875\u5f62 \u5f0f\u663e\u793a\u51fa\u6765 2\u3001\u7f51\u7ad9\uff1a\u7f51\u7ad9\u662f\u7531\u4e00\u4e2a\u4e00\u4e2a\u9875\u9762\u6784\u6210\u7684\uff0c\u662f\u591a\u4e2a\u7f51\u9875\u7684\u7ed3\u5408\u4f53 3\u3001\u4e3b\u9875\uff1a\u6253\u5f00\u7f51\u7ad9\u540e\u51fa\u73b0\u7684\u7b2c\u4e00\u4e2a\u7f51\u9875\u79f0\u4e3a\u7f51\u7ad9\u4e3b\u9875\uff08\u6216\u9996\u9875\uff09 4\u3001\u57df\u540d\uff1a\u6d4f\u89c8\u7f51\u9875\u65f6\u8f93\u5165\u7684\u7f51\u5740\uff08\u4f8b\u5982\uff1awww.benet.wang \uff09 5\u3001HTTP \uff1a\u7528\u6765\u4f20\u8f93\u7f51\u9875\u7684\u901a\u4fe1\u534f\u8bae 6\u3001URL \uff1a\u662f\u4e00\u79cd\u4e07\u7ef4\u7f51\u5bfb\u5740\u7cfb\u7edf 7\u3001HTML \uff1a\u7528\u6765\u7f16\u5199\u7f51\u9875\u7684\u8d85\u6587\u672c\u6807\u8bb0\u8bed\u8a00 8\u3001\u8d85\u94fe\u63a5\uff1a\u5c06\u7f51\u7ad9\u4e2d\u4e0d\u540c\u7f51\u9875\u94fe\u63a5\u8d77\u6765\u7684\u529f\u80fd 9\u3001\u53d1\u5e03\uff1a\u5c06\u5236\u4f5c\u597d\u7684\u7f51\u9875\u4e0a\u4f20\u5230\u670d\u52a1\u5668\u4f9b\u7528\u6237\u8bbf\u95ee\u7684\u8fc7\u7a0b","title":"\u4e8c\u3001\u7f51\u9875\u6982\u8ff0"},{"location":"web-server/web-01/#html","text":"1\u3001HTML \uff1aHyper Text Markup Language \uff0c\u7f51\u9875\u7684\u201c\u6e90\u7801\u201d 2\u3001\u6d4f\u89c8\u5668\uff1a\u201c\u89e3\u91ca\u548c\u6267\u884c\u201dHTML \u6e90\u7801\u7684\u5de5\u5177 3\u3001HTML \u6587\u6863\u7684\u7ed3\u6784 \u5934\u90e8\u90e8\u5206 \u6807\u9898\u90e8\u5206 \u4e3b\u4f53\u90e8\u5206 \u7f51\u9875\u5185\u5bb9\uff0c\u5305\u62ec\u6587\u672c\u3001\u56fe\u50cf\u7b49","title":"\u4e09\u3001HTML(\u8d85\u6587\u672c\u6807\u7b7e\u8bed\u8a00)"},{"location":"web-server/web-01/#web","text":"Web \u5185\u5bb9\u50a8\u5b58\u5728 Web \u670d\u52a1\u5668\u4e0a\uff0c\u6700\u7b80\u5355\u7684 Web \u8d44\u6e90\u5c31\u662f Web \u670d\u52a1\u5668\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u9759 \u6001\u6587\u4ef6\uff0c\u8fd9\u4e9b\u6587\u4ef6\u53ef\u4ee5\u5305\u542b\u4efb\u610f\u5185\u5bb9\uff1a\u6587\u672c\u6587\u4ef6\u3001HTML \u6587\u4ef6\u3001\u5fae\u8f6f\u7684 Word \u6587\u4ef6\u3001Adobe \u7684 Acrobat \u6587\u4ef6\u3001JPEG \u56fe\u7247\u6587\u4ef6\u3001AVI \u7535\u5f71\u6587\u4ef6\u3002 \u8d44\u6e90\u4e0d\u4e00\u5b9a\u662f\u9759\u6001\u6587\u4ef6\uff0c\u8d44\u6e90\u8fd8\u53ef\u4ee5\u662f\u6839\u636e\u9700\u8981\u751f\u6210\u5185\u5bb9\u7684\u8f6f\u4ef6\u7a0b\u5e8f\u3002\u8fd9\u4e9b\u52a8\u6001\u5185\u5bb9\u8d44 \u6e90\u53ef\u4ee5\u6839\u636e\u4f60\u7684\u8eab\u4efd\u3001\u6240\u8bf7\u6c42\u7684\u4fe1\u606f\u6216\u6bcf\u5929\u7684\u4e0d\u540c\u65f6\u6bb5\u6765\u4ea7\u751f\u5185\u5bb9\u3002 1\u3001Web1.0 \u4e0e Web2.0 Web1.0 \u662f\u4ee5\u7f16\u8f91\u4e3a\u7279\u5f81\uff0c\u7f51\u7ad9\u63d0\u4f9b\u7ed9\u7528\u6237\u7684\u5185\u5bb9\u662f\u7f16\u8f91\u5904\u7406\u540e\u63d0\u4f9b\u7684\uff0c\u7136\u540e\u7528\u6237\u9605\u8bfb \u7f51\u7ad9\u63d0\u4f9b\u7684\u5185\u5bb9\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u7f51\u7ad9\u5230\u7528\u6237\u7684\u5355\u5411\u884c\u4e3a\u3002 Web2.0 \u66f4\u6ce8\u91cd\u7528\u6237\u7684\u4ea4\u4e92\u4f5c\u7528\uff0c\u7528\u6237\u65e2\u662f\u7f51\u7ad9\u5185\u5bb9\u7684\u6d88\u8d39\u8005\uff08\u6d4f\u89c8\u8005\uff09\uff0c\u4e5f\u662f\u7f51\u7ad9\u5185\u5bb9 \u7684\u5236\u9020\u8005\u3002Web2.0 \u52a0\u5f3a\u4e86\u7f51\u7ad9\u4e0e\u7528\u6237\u4e4b\u95f4\u7684\u4e92\u52a8\uff0c\u7f51\u7ad9\u5185\u5bb9\u57fa\u4e8e\u7528\u6237\u63d0\u4f9b\uff0c\u7f51\u7ad9\u7684\u8bf8\u591a\u529f \u80fd\u4e5f\u7531\u7528\u6237\u53c2\u4e0e\u5efa\u8bbe\uff0c\u5b9e\u73b0\u4e86\u7f51\u7ad9\u4e0e\u7528\u6237\u53cc\u5411\u7684\u4ea4\u6d41\u4e0e\u53c2\u4e0e\u3002 2\u3001\u9759\u6001\u7f51\u9875\u4e0e\u52a8\u6001\u7f51\u9875 \uff081 \uff09\u9759\u6001\u7f51\u9875 \u5728\u7f51\u7ad9\u8bbe\u8ba1\u4e2d\uff0c\u7eaf\u7cb9 HTML \u683c\u5f0f\u7684\u7f51\u9875\u901a\u5e38\u88ab\u79f0\u4e3a\u201c\u9759\u6001\u7f51\u9875\u201d\uff0c\u9759\u6001\u7f51\u9875\u662f\u6807\u51c6\u7684 HTML \u6587\u4ef6\uff0c\u6269\u5c55\u540d\u662f.htm \u3001.html\uff0c\u53ef\u5305\u542b\u6587\u672c\u3001\u56fe\u50cf\u3001\u58f0\u97f3\u3001 FLASH \u52a8\u753b\u3001\u5ba2\u6237\u7aef\u811a\u672c\u548c ActiveX \u63a7\u4ef6\u53ca JAVA \u5c0f\u7a0b\u5e8f\u7b49\u3002\u9759\u6001\u7f51\u9875\u662f\u7f51\u7ad9\u5efa\u8bbe\u7684\u57fa\u7840\uff0c\u65e9\u671f\u7684\u7f51\u7ad9\u4e00\u822c\u90fd\u662f\u9759\u6001\u7f51\u9875\u5236\u4f5c\u7684\u3002 \u9759\u6001\u7f51\u9875\u76f8\u5bf9\u4e8e\u52a8\u6001\u7f51\u9875\u800c\u8a00\uff0c\u662f\u6ca1\u6709\u540e\u53f0\u6570\u636e\u5e93\u3001\u4e0d\u542b\u7a0b\u5e8f\u548c\u4e0d\u53ef\u4ea4\u4e92\u7684\u7f51\u9875\u3002\u9759\u6001 \u7f51\u9875\u76f8\u5bf9\u66f4\u65b0\u8d77\u6765\u6bd4\u8f83\u9ebb\u70e6\uff0c\u9002\u7528\u4e8e\u4e00\u822c\u66f4\u65b0\u53eb\u5c11\u7684\u5c55\u793a\u578b\u7f51\u7ad9\u3002 \u9759\u6001\u7f51\u9875\u7684\u5185\u5bb9\u76f8\u5bf9\u7a33\u5b9a\uff0c\u56e0\u6b64\u5bb9\u6613\u88ab\u641c\u7d22\u5f15\u64ce\u68c0\u7d22\u3002 \u9759\u6001\u7f51\u9875\u6ca1\u6709\u6570\u636e\u5e93\u7684\u652f\u6301\uff0c\u5728\u7f51\u7ad9\u5236\u4f5c\u548c\u7ef4\u62a4\u65b9\u9762\u5de5\u4f5c\u91cf\u8f83\u5927\uff0c\u56e0\u6b64\u5f53\u7f51\u7ad9\u4fe1\u606f\u91cf\u5f88 \u5927\u65f6\u5b8c\u5168\u4f9d\u9760\u9759\u6001\u7f51\u9875\u5236\u4f5c\u65b9\u5f0f\u6bd4\u8f83\u56f0\u96be\u3002\u9759\u6001\u7f51\u9875\u7684\u4ea4\u4e92\u6027\u8f83\u5dee\uff0c\u5728\u529f\u80fd\u65b9\u9762\u6709\u8f83\u5927\u7684\u9650 \u5236\u3002\u9875\u9762\u6d4f\u89c8\u901f\u5ea6\u8fc5\u901f\uff0c\u8fc7\u7a0b\u65e0\u9700\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u5f00\u542f\u9875\u9762\u901f\u5ea6\u5feb\u4e8e\u52a8\u6001\u9875\u9762\u3002 \uff082 \uff09\u52a8\u6001\u7f51\u9875 \u52a8\u6001\u7f51\u9875\u662f\u4e0e\u9759\u6001\u7f51\u9875\u76f8\u5bf9\u5e94\u7684\uff0c\u7f51\u9875 URL \u7684\u540e\u7f00\u4e0d\u662f.htm \u3001.html \u3001.shtml \u3001xml \u7b49\u9759 \u6001\u7f51\u9875\u7684\u5e38\u89c1\u5f62\u5f0f\uff0c\u800c\u662f\u4ee5.aspx \u3001.asp \u3001.jsp \u3001.php \u3001.perl \u3001.cgi \u7b49\u5f62\u5f0f\u4e3a\u540e\u7f00\uff0c\u5e76\u4e14\u5728\u52a8\u6001 \u7f51\u9875\u7f51\u5740\u4e2d\u6709\u4e00\u4e2a\u6807\u5fd7\u6027\u7684\u7b26\u53f7\u2014\u2014\u201c?\u201d \u52a8\u6001\u7f51\u9875\u663e\u793a\u7684\u5185\u5bb9\u53ef\u4ee5\u968f\u7740\u65f6\u95f4\u3001\u73af\u5883\u6216\u8005\u6570\u636e\u5e93\u64cd\u4f5c\u7684\u7ed3\u679c\u800c\u53d1\u751f\u6539\u53d8\u3002\u52a8\u6001\u7f51\u9875 \u4e0e\u7f51\u9875\u4e0a\u7684\u5404\u79cd\u52a8\u753b\u3001\u6eda\u52a8\u5b57\u5e55\u7b49\u89c6\u89c9\u4e0a\u7684\u52a8\u6001\u6548\u679c\u6ca1\u6709\u76f4\u63a5\u5173\u7cfb\uff0c\u53ea\u8981\u662f\u91c7\u7528\u4e86\u52a8\u6001\u7f51\u7ad9 \u6280\u672f\u751f\u4ea7\u7684\u7f51\u9875\u90fd\u53ef\u4ee5\u79f0\u4e3a\u201c\u52a8\u6001\u7f51\u9875\u201d\u3002 \u52a8\u6001\u7f51\u9875\u662f\u57fa\u672c\u7684 html \u8bed\u6cd5\u4e0e Java\u3001PHP \u7b49\u9ad8\u7ea7\u7a0b\u5e8f\u8bbe\u8ba1\u8bed\u8a00\u3001\u6570\u636e\u5e93\u7f16\u7a0b\u7b49\u591a\u79cd\u6280 \u672f\u7684\u878d\u5408\uff0c\u4ee5\u5b9e\u73b0\u5bf9\u7f51\u7ad9\u5185\u5bb9\u548c\u98ce\u683c\u7684\u9ad8\u6548\u3001\u52a8\u6001\u548c\u4ea4\u4e92\u5f0f\u7ba1\u7406\u3002 \u52a8\u6001\u7f51\u9875\u4e00\u822c\u4ee5\u6570\u636e\u5e93\u6280\u672f\u4e3a\u57fa\u7840\uff0c\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u7f51\u7ad9\u7ef4\u62a4\u7684\u5de5\u4f5c\u91cf\u3002\u91c7\u7528\u52a8\u6001\u7f51\u9875\u6280 \u672f\u7684\u7f51\u7ad9\u53ef\u4ee5\u5b9e\u73b0\u66f4\u591a\u7684\u529f\u80fd\uff0c\u5982\u7528\u6237\u6ce8\u518c\u3001\u7528\u6237\u767b\u5f55\u3001\u5728\u7ebf\u8c03\u67e5\u3001\u7528\u6237\u7ba1\u7406\u3001\u8ba2\u5355\u7ba1\u7406\u7b49","title":"\u56db\u3001Web\u6982\u8ff0"},{"location":"web-server/web-01/#http","text":"\u4e00. HTTP \u534f\u8bae\u6982\u8ff0 \u6bcf\u5929\u90fd\u6709\u6570\u4ee5\u4ebf\u4e07\u8ba1\u7684 JPEG \u56fe\u7247\u3001 HTML \u9875\u9762\u3001\u6587\u672c\u6587\u4ef6\u3001 MPEG \u7535\u5f71\u3001 WAV \u97f3\u9891\u6587\u4ef6\u3001 JAVA \u5c0f\u7a0b\u5e8f\u548c\u5176\u4ed6\u8d44\u6e90\u5728\u56e0\u7279\u7f51\u4e0a\u6e38\u5f0b\u3002 HTTP \u53ef\u4ee5\u901a\u8fc7\u904d\u5e03\u5168\u4e16\u754c\u7684 Web \u670d\u52a1\u5668\u4e0a\u5c06\u8fd9\u4e9b \u4fe1\u606f\u5feb\u8fc5\u901f\u3001\u4fbf\u6377\u3001\u53ef\u9760\u5730\u642c\u79fb\u5230\u4eba\u4eec\u684c\u9762\u4e0a\u7684 Web \u6d4f\u89c8\u5668\u4e0a\u53bb\u3002 Web \u670d\u52a1\u5668\u6240\u4f7f\u7528\u7684\u662f HTTP \u534f\u8bae\uff0c\u56e0\u6b64\u7ecf\u5e38\u4f1a\u88ab\u79f0\u4e3a HTTP \u670d\u52a1\u5668\u3002 HTTP \u670d\u52a1\u5668\u5b58\u50a8 \u4e86\u56e0\u7279\u7f51\u4e2d\u7684\u6570\u636e\uff0c\u5982\u679c HTTP \u5ba2\u6237\u7aef\u53d1\u51fa\u8bf7\u6c42\u7684\u8bdd\uff0c\u5b83\u4eec\u4f1a\u63d0\u4f9b\u6570\u636e\uff0c\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u5668\u53d1\u9001 HTTP \u8bf7\u6c42\uff0c\u670d\u52a1\u5668\u4f1a\u5728 HTTP \u54cd\u5e94\u4e2d\u56de\u9001\u6240\u6709\u8bf7\u6c42\u7684\u6570\u636e\u3002 \u4e8c. HTTP \u534f\u8bae\u7248\u672c HTTP \u534f\u8bae\u662f\u4e92\u8054\u7f51\u4e0a\u5e94\u7528\u6700\u4e3a\u5e7f\u6cdb\u7684\u4e00\u79cd\u7f51\u7edc\u534f\u8bae\uff0c\u8bbe\u8ba1\u8fd9\u4e2a\u534f\u8bae\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u53d1\u5e03\u548c\u63a5\u6536 Web \u670d\u52a1\u5668\u4e0a\u7684 HTML \u9875\u9762\u3002 HTTP \u534f\u8bae\u7684\u7248\u672c\uff1a HTTP 0.9 \u5df2\u8fc7\u65f6\u3002\u53ea\u63a5\u53d7 GET \u4e00\u79cd\u8bf7\u6c42\u65b9\u6cd5\uff0c\u6ca1\u6709\u5728\u901a\u8baf\u4e2d\u6307\u5b9a\u7248\u672c\u53f7\uff0c\u4e14\u4e0d\u652f\u6301\u8bf7\u6c42\u5934\u3002\u7531 \u4e8e\u8be5\u7248\u672c\u4e0d\u652f\u6301 POST \u65b9\u6cd5\uff0c\u6240\u4ee5\u5ba2\u6237\u7aef\u65e0\u6cd5\u5411\u670d\u52a1\u5668\u4f20\u9012\u592a\u591a\u4fe1\u606f\u3002 HTTP 1.0 \u8fd9\u662f\u7b2c\u4e00\u4e2a\u5728\u901a\u8baf\u4e2d\u6307\u5b9a\u7248\u672c\u53f7\u7684 HTTP \u534f\u8bae\u7248\u672c\uff0c\u81f3\u4eca\u4ecd\u88ab\u5e7f\u6cdb\u91c7\u7528\uff0c\u7279\u522b\u662f\u5728\u4ee3\u7406 \u670d\u52a1\u5668\u4e2d\u3002 HTTP 1.1 \u5f53\u524d\u7248\u672c\u3002\u6301\u4e45\u8fde\u63a5\u88ab\u9ed8\u8ba4\u91c7\u7528\uff0c\u5e76\u80fd\u5f88\u597d\u5730\u914d\u5408\u4ee3\u7406\u670d\u52a1\u5668\u5de5\u4f5c\u3002\u8fd8\u652f\u6301\u4ee5\u7ba1\u9053\u65b9\u5f0f \u540c\u65f6\u53d1\u9001\u591a\u4e2a\u8bf7\u6c42\uff0c\u4ee5\u4fbf\u964d\u4f4e\u7ebf\u8def\u8d1f\u8f7d\uff0c\u63d0\u9ad8\u4f20\u8f93\u901f\u5ea6\u3002 HTTP/1.1 \u76f8\u8f83\u4e8e HTTP/1.0 \u534f\u8bae\u7684\u533a\u522b\u4e3b\u8981\u4f53\u73b0\u5728\uff1a 1 \u7f13\u5b58\u5904\u7406 2 \u5e26\u5bbd\u4f18\u5316\u53ca\u7f51\u7edc\u8fde\u63a5\u7684\u4f7f\u7528 3 \u9519\u8bef\u901a\u77e5\u7684\u7ba1\u7406 4 \u6d88\u606f\u5728\u7f51\u7edc\u4e2d\u7684\u53d1\u9001 5 \u4e92\u8054\u7f51\u5730\u5740\u7684\u7ef4\u62a4 6 \u5b89\u5168\u6027\u53ca\u5b8c\u6574\u6027 \u4e09. HTTP\u65b9\u6cd5 HTTP \u652f\u6301\u51e0\u79cd\u4e0d\u540c\u7684\u8bf7\u6c42\u547d\u4ee4\uff0c\u8fd9\u4e9b\u547d\u4ee4\u88ab\u79f0\u4e3a HTTP \u65b9\u6cd5\uff08 HTTP method\uff09\u6bcf\u6761 HTTP \u8bf7\u6c42\u62a5\u6587\u4f1a\u5305\u542b\u4e00\u4e2a\u65b9\u6cd5\uff0c\u544a\u8bc9\u670d\u52a1\u5668\u8981\u6267\u884c\u4ec0\u4e48\u52a8\u4f5c\uff1a \u83b7\u53d6\u4e00\u4e2a Web \u9875\u9762 \u8fd0\u884c\u4e00\u4e2a\u7f51\u5173\u7a0b\u5e8f \u5220\u9664\u4e00\u4e2a\u6587\u4ef6\u7b49 HTTP \u534f\u8bae\u6709\u591a\u79cd\u83b7\u5f97 Web \u8d44\u6e90\u7684\u65b9\u6cd5\uff0c\u5e38\u7528\u7684\u6709\u4e24\u79cd\uff1aGET \u548c POST GET \u548c POST \u4f8b\u5982\u8bbf\u95ee\uff1a http://www.test.com/a.php?Id=123 \u5c31\u662f\u4e00\u4e2a GET \u8bf7\u6c42\uff0c\u5982\u679c\u8bbf\u95ee\u6b63\u5e38\uff0c\u6211\u4eec \u4f1a\u4ece\u670d\u52a1\u5668\u7684\u65e5\u5fd7\u4e2d\u83b7\u53d6 200 \u72b6\u6001\u7801\u3002 \u5047\u5982\u6b64\u8bf7\u6c42\u4f7f\u7528 POST \u65b9\u6cd5\uff0c\u90a3\u4e48\u6211\u4eec\u4f1a\u4f20\u9012\u7ed9 a.php \u7684 Id \u53c2\u6570\u4f9d\u65e7\u662f 123\uff0c\u4f46\u662f\u6d4f\u89c8 \u5668\u7684 URL \u5c06\u4e0d\u4f1a\u663e\u793a\u540e\u9762\u7684 Id=123 \u5b57\u6837\uff0c\u56e0\u6b64\u8868\u5355\u7c7b\u6216\u8005\u6709\u7528\u6237\u540d\u3001\u5bc6\u7801\u7b49\u5185\u5bb9\u63d0\u4ea4\u65f6\u5efa\u8bae\u4f7f\u7528 POST \u65b9\u5f0f\u3002 \u4e0d\u7ba1\u4f7f\u7528\u54ea\u79cd\u65b9\u5f0f\uff0c\u6700\u7ec8 a.php \u83b7\u53d6\u5230\u7684\u503c\u662f\u4e00\u6837\u7684\u3002","title":"http\u534f\u8bae\u5206\u6790"}]}